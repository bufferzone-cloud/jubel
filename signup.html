<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFF5F0;
            --light-red: #FCE8E6;
            --white: #FFFFFF;
            --off-white: #F9F9F9;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --dark-gray: #333333;
            --text-gray: #666666;
            --text-light: #888888;
            --success-green: #2ECC71;
            --warning-yellow: #F39C12;
            --info-blue: #3498DB;
            --error-red: #E74C3C;
            --border-color: #EEEEEE;
            --shadow-light: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 2px 12px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 4px 20px rgba(0, 0, 0, 0.15);
            --app-padding: 12px;
            --element-radius: 12px;
            --button-radius: 20px;
            --card-radius: 16px;
            --transition-speed: 0.25s;
            --ambulance-blue: #2980B9;
            --fire-truck-red: #C0392B;
            --police-blue: #2C3E50;
            --premium-gold: #FFD700;
            --economy-green: #27AE60;
            --light-truck-brown: #8B4513;
            --delivery-purple: #8E44AD;
            --express-shop-green: #16A085;
            --broadcast-blue: #3498DB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--off-white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Map Container */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 55%;
            z-index: 1;
            background: #f8f9fa;
        }
        
        /* Top Bar Components */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px var(--app-padding);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            height: 56px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 14px;
            overflow: hidden;
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-text {
            font-size: 16px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .balance-badge {
            background: var(--white);
            padding: 6px 12px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .balance-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-weight: 700;
            font-size: 13px;
        }
        
        .notification-bell {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            transition: all var(--transition-speed) ease;
        }
        
        .notification-bell:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid var(--white);
        }
        
        /* Ride Status Bar */
        .ride-status-bar {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            display: none;
            background: var(--white);
            padding: 8px 16px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            align-items: center;
            gap: 10px;
            min-width: 280px;
            max-width: 90%;
        }
        
        .ride-status-bar.active {
            display: flex;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning-yellow);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .status-dot.searching { background: var(--warning-yellow); }
        .status-dot.arriving { background: var(--info-blue); }
        .status-dot.riding { background: var(--success-green); animation: none; }
        
        .status-text {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .status-eta {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-gray);
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Emergency Status */
        .emergency-status {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 150;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--button-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 12px;
            animation: emergencyPulse 1s infinite;
        }
        
        @keyframes emergencyPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* SOS Button */
        .sos-button {
            position: absolute;
            bottom: 160px;
            right: var(--app-padding);
            z-index: 150;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 14px;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            animation: sosPulse 2s infinite;
        }
        
        @keyframes sosPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .sos-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.4);
        }
        
        /* Main Panel */
        .main-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
            z-index: 100;
            padding: var(--app-padding);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 45vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) var(--light-gray);
        }
        
        .main-panel::-webkit-scrollbar {
            width: 4px;
        }
        
        .main-panel::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 2px;
        }
        
        .main-panel::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }
        
        .main-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }
        
        .panel-handle {
            width: 36px;
            height: 3px;
            background: var(--medium-gray);
            border-radius: 2px;
            margin: 0 auto 12px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .panel-handle:hover {
            background: var(--primary-orange);
            width: 48px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--light-gray);
            border-radius: var(--button-radius);
        }
        
        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: calc(var(--button-radius) - 4px);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            color: var(--text-gray);
            font-size: 11px;
            font-weight: 600;
        }
        
        .nav-tab i {
            font-size: 16px;
            transition: all var(--transition-speed) ease;
        }
        
        .nav-tab.active {
            background: var(--white);
            color: var(--primary-orange);
            box-shadow: var(--shadow-light);
        }
        
        .nav-tab.active i {
            color: var(--primary-orange);
            transform: translateY(-2px);
        }
        
        .nav-tab:hover:not(.active) {
            background: rgba(255, 107, 53, 0.1);
            color: var(--primary-orange);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: left;
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-orange);
        }
        
        .quick-action-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 16px;
        }
        
        .quick-action-text {
            flex: 1;
        }
        
        .quick-action-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .quick-action-desc {
            font-size: 11px;
            color: var(--text-light);
        }
        
        /* Ride Type Selection Tabs */
        .service-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .service-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            min-width: 100px;
            text-align: center;
        }
        
        .service-tab:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .service-tab.active {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .service-tab.car.active { border-color: var(--primary-orange); }
        .service-tab.delivery.active { border-color: var(--delivery-purple); background: #F4E6FA; }
        .service-tab.short-delivery.active { border-color: var(--express-shop-green); background: #E1F5FE; }
        
        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .service-tab.active .service-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .service-tab.delivery.active .service-icon {
            background: var(--delivery-purple);
        }
        
        .service-tab.short-delivery.active .service-icon {
            background: var(--express-shop-green);
        }
        
        .service-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .service-desc {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Enhanced Location Search Input */
        .location-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--off-white);
            border: 2px solid transparent;
            border-radius: var(--element-radius);
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .location-input.active {
            border-color: var(--primary-orange);
            background: var(--white);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .location-input i {
            color: var(--primary-orange);
            font-size: 14px;
            width: 18px;
            text-align: center;
        }
        
        .location-input input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-size: 13px;
            color: var(--dark-gray);
            font-weight: 500;
        }
        
        .location-input input::placeholder {
            color: var(--text-light);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }
        
        .suggestion-list.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            color: var(--primary-orange);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .suggestion-address {
            font-size: 11px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .suggestion-distance {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Ride Type Selection - Only shown for Car service */
        .ride-type-selection {
            margin: 16px 0;
            display: none;
        }
        
        .ride-type-selection.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        .ride-type-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .ride-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .ride-type-card {
            background: var(--white);
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 14px 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .ride-type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-card.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .ride-type-card.economy.selected {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-card.premium.selected {
            border-color: var(--premium-gold);
            background: #FFF9E6;
        }
        
        .ride-type-icon {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 18px;
            color: var(--text-gray);
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-card.selected .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-card.economy.selected .ride-type-icon {
            background: var(--economy-green);
        }
        
        .ride-type-card.premium.selected .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .ride-type-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .ride-type-card.economy .ride-type-price {
            color: var(--economy-green);
        }
        
        .ride-type-card.premium .ride-type-price {
            color: #B8860B;
        }
        
        .ride-type-eta {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Fare Display */
        .fare-display {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 16px;
            border-radius: var(--element-radius);
            margin: 16px 0;
            text-align: center;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fare-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
        }
        
        .fare-amount {
            font-size: 26px;
            font-weight: 800;
            margin: 6px 0;
        }
        
        .fare-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Enhanced Ride Request Form */
        .ride-request-form {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: var(--button-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            box-shadow: 0 3px 12px rgba(255, 107, 53, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(255, 107, 53, 0.4);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        .btn-secondary:hover {
            background: var(--light-orange);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--error-red), #C0392B);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 16px rgba(231, 76, 60, 0.4);
        }
        
        /* Enhanced Ride Info Panel */
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .ride-info-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .driver-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--white);
            font-weight: 700;
            overflow: hidden;
            position: relative;
        }
        
        .driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .vehicle-image {
            position: absolute;
            bottom: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--white);
            border: 2px solid var(--white);
            overflow: hidden;
        }
        
        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .driver-details {
            flex: 1;
        }
        
        .driver-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .driver-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
        }
        
        .driver-vehicle {
            font-size: 12px;
            color: var(--text-gray);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Enhanced Chat System */
        .chat-container {
            position: absolute;
            bottom: 200px;
            right: var(--app-padding);
            z-index: 300;
            width: 320px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-container.active {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }
        
        @keyframes chatSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-driver-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            overflow: hidden;
        }
        
        .chat-driver-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .chat-messages {
            flex: 1;
            padding: 14px;
            max-height: 250px;
            overflow-y: auto;
            background: var(--off-white);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 13px;
            line-height: 1.3;
            position: relative;
        }
        
        .message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border-bottom-right-radius: 4px;
        }
        
        .message.received {
            align-self: flex-start;
            background: var(--white);
            color: var(--dark-gray);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 4px;
            text-align: right;
        }
        
        .message.received .message-time {
            color: var(--text-gray);
        }
        
        .message-status {
            position: absolute;
            bottom: 2px;
            right: 8px;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .chat-input-container {
            padding: 14px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 13px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-input:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 107, 53, 0.3);
        }
        
        .chat-notification {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: var(--error-red);
            color: var(--white);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Enhanced Modal System */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            max-width: 450px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .modal-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .modal-content {
            padding: 20px;
        }
        
        /* Enhanced History Screen */
        .history-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .history-screen.active {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .screen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 14px var(--app-padding);
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .back-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .back-btn:hover {
            background: var(--medium-gray);
            transform: translateX(-2px);
        }
        
        .screen-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        /* Enhanced Emergency Screen */
        .emergency-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 200;
            display: none;
            flex-direction: column;
            padding-top: 56px;
        }
        
        .emergency-screen.active {
            display: flex;
        }
        
        /* More Options Dropdown */
        .more-options-dropdown {
            position: absolute;
            top: 100%;
            right: var(--app-padding);
            margin-top: 8px;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            min-width: 200px;
            z-index: 250;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .more-options-dropdown.active {
            display: block;
            animation: fadeInDown 0.2s ease;
        }
        
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dropdown-item {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: var(--light-orange);
        }
        
        .dropdown-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-size: 14px;
        }
        
        .dropdown-text {
            flex: 1;
        }
        
        .dropdown-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .dropdown-desc {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 2px;
        }
        
        /* Loading States */
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        /* Enhanced Toast Notifications */
        .toast-container {
            position: fixed;
            top: 90px;
            right: var(--app-padding);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
        }
        
        .toast {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 14px;
            box-shadow: var(--shadow-heavy);
            border-left: 3px solid var(--primary-orange);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideInRight 0.3s ease;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }
        
        .toast.hiding {
            transform: translateX(100%);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--light-orange);
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .toast-close:hover {
            color: var(--error-red);
            background: var(--light-red);
        }
        
        .toast.success {
            border-left-color: var(--success-green);
        }
        
        .toast.success .toast-icon {
            background: #E8F6EF;
            color: var(--success-green);
        }
        
        .toast.error {
            border-left-color: var(--error-red);
        }
        
        .toast.error .toast-icon {
            background: var(--light-red);
            color: var(--error-red);
        }
        
        .toast.warning {
            border-left-color: var(--warning-yellow);
        }
        
        .toast.warning .toast-icon {
            background: #FFF3E0;
            color: var(--warning-yellow);
        }
        
        /* Custom Markers */
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        
        .driver-marker {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: pulse 2s infinite;
        }
        
        .emergency-vehicle-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.3);
            border: 2px solid white;
            animation: emergencyPulse 1s infinite;
        }
        
        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 14px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 13px;
            color: var(--dark-gray);
            background: var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Search Loading Indicator */
        .search-loading {
            display: none;
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid var(--light-gray);
            border-radius: 50%;
            border-top-color: var(--primary-orange);
            animation: spin 0.6s linear infinite;
        }
        
        .location-input.searching .search-loading {
            display: block;
        }
        
        /* No Results Message */
        .no-results {
            padding: 30px 16px;
            text-align: center;
            color: var(--text-light);
            font-size: 13px;
        }
        
        .no-results i {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Cancel Reasons Modal */
        .cancel-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .cancel-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cancel-reason:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .cancel-reason.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .cancel-reason.selected .reason-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .reason-text {
            flex: 1;
            font-weight: 500;
            color: var(--dark-gray);
        }
        
        /* Emergency Reasons Modal */
        .emergency-reasons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .emergency-reason {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--white);
        }
        
        .emergency-reason:hover {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .emergency-reason-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .emergency-reason.selected .emergency-reason-icon {
            background: var(--error-red);
            color: var(--white);
        }
        
        /* Emergency Services List */
        .emergency-services-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 16px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .emergency-service-item {
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            background: var(--white);
        }
        
        .emergency-service-item:hover {
            border-color: var(--error-red);
            background: var(--light-red);
            transform: translateY(-2px);
        }
        
        .emergency-service-item.selected {
            border-color: var(--error-red);
            background: var(--light-red);
        }
        
        .service-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .service-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--error-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .service-item-details {
            flex: 1;
        }
        
        .service-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--dark-gray);
        }
        
        .service-item-distance {
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .service-item-address {
            font-size: 11px;
            color: var(--text-light);
            line-height: 1.3;
        }
        
        /* Broadcast Ride Modal */
        .broadcast-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .broadcast-recipients {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            padding: 10px;
        }
        
        .broadcast-recipient {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .broadcast-recipient:last-child {
            border-bottom: none;
        }
        
        .recipient-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
        }
        
        .recipient-details {
            flex: 1;
        }
        
        .recipient-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .recipient-phone {
            font-size: 11px;
            color: var(--text-gray);
        }
        
        /* Notifications Panel */
        .notifications-panel {
            position: absolute;
            top: 60px;
            right: var(--app-padding);
            z-index: 300;
            width: 350px;
            max-width: calc(100vw - 40px);
            background: var(--white);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
            max-height: 400px;
        }
        
        .notifications-panel.active {
            display: flex;
            animation: fadeInDown 0.3s ease;
        }
        
        .notifications-header {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-red));
            color: var(--white);
            padding: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .notifications-title {
            font-weight: 600;
            font-size: 13px;
        }
        
        .mark-all-read {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background var(--transition-speed) ease;
        }
        
        .mark-all-read:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .notifications-list {
            flex: 1;
            overflow-y: auto;
            background: var(--off-white);
        }
        
        .notification-item {
            padding: 14px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            gap: 12px;
            background: var(--white);
        }
        
        .notification-item:hover {
            background: var(--light-orange);
        }
        
        .notification-item.unread {
            background: var(--light-orange);
        }
        
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .notification-icon.ride {
            background: var(--primary-orange);
        }
        
        .notification-icon.wallet {
            background: var(--success-green);
        }
        
        .notification-icon.promotion {
            background: var(--warning-yellow);
        }
        
        .notification-icon.emergency {
            background: var(--error-red);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .notification-message {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.3;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 10px;
            color: var(--text-light);
        }
        
        .notification-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--error-red);
            border-radius: 50%;
            margin-left: 4px;
        }
        
        .empty-notifications {
            padding: 50px 20px;
            text-align: center;
            color: var(--text-light);
        }
        
        /* Service Forms */
        .service-form {
            display: none;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .service-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* Enhanced Payment Selection Styles */
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 16px 0;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method:hover {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
        }
        
        .payment-method.selected .payment-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
        }
        
        .payment-info {
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 2px;
        }
        
        /* Timeline */
        .timeline {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            padding: 0 20px;
            position: relative;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 10px;
            border: 2px solid var(--white);
            transition: all var(--transition-speed) ease;
        }
        
        .step-dot.active {
            background: var(--primary-orange);
            color: var(--white);
            transform: scale(1.1);
        }
        
        .step-dot.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step-label {
            font-size: 11px;
            color: var(--text-light);
            text-align: center;
        }
        
        .step-label.active {
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        /* Enhanced Fare Breakdown */
        .fare-breakdown {
            background: var(--off-white);
            border-radius: var(--element-radius);
            padding: 14px;
            margin-bottom: 16px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fare-row:last-child {
            border-bottom: none;
        }
        
        .fare-label {
            font-size: 13px;
            color: var(--text-gray);
        }
        
        .fare-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .fare-row.total {
            margin-top: 6px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .fare-row.total .fare-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .fare-row.total .fare-value {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-orange);
        }
        
        /* Broadcast Button */
        .broadcast-btn {
            background: linear-gradient(135deg, var(--broadcast-blue), #2980B9);
            color: var(--white);
            border: none;
            padding: 10px 16px;
            border-radius: var(--button-radius);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .broadcast-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --app-padding: 10px;
                --element-radius: 10px;
                --button-radius: 16px;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .ride-type-grid {
                grid-template-columns: 1fr;
            }
            
            .emergency-services-list {
                grid-template-columns: 1fr;
            }
            
            .chat-container,
            .notifications-panel {
                width: calc(100vw - 20px);
                right: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                gap: 4px;
            }
            
            .nav-tab {
                padding: 8px 4px;
                font-size: 10px;
            }
            
            .nav-tab i {
                font-size: 14px;
            }
            
            .balance-badge {
                padding: 5px 8px;
                font-size: 12px;
            }
            
            .service-tab {
                min-width: 85px;
                padding: 10px 12px;
            }
            
            .user-info {
                max-width: 100px;
                font-size: 12px;
            }
        }
        
        /* Advanced Search Results */
        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-top: 4px;
        }
        
        .search-results-container.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .search-result-item:hover {
            background: var(--light-orange);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-icon {
            color: var(--primary-orange);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .search-result-details {
            flex: 1;
        }
        
        .search-result-name {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            margin-bottom: 2px;
        }
        
        .search-result-address {
            font-size: 11px;
            color: var(--text-gray);
            line-height: 1.3;
        }
        
        .search-result-distance {
            font-size: 10px;
            color: var(--text-light);
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .search-result-category {
            display: inline-block;
            padding: 2px 6px;
            background: var(--light-orange);
            color: var(--primary-orange);
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        /* Search Filters */
        .search-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .search-filter {
            padding: 6px 12px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--button-radius);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .search-filter.active {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        .search-filter:hover:not(.active) {
            border-color: var(--primary-orange);
            color: var(--primary-orange);
        }
        
        /* Recent Searches */
        .recent-searches {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .recent-searches-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .clear-recent {
            font-size: 11px;
            color: var(--primary-orange);
            cursor: pointer;
            font-weight: 600;
        }
        
        .recent-search-item {
            padding: 8px;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recent-search-item:hover {
            background: var(--light-orange);
        }
        
        .recent-search-icon {
            color: var(--text-light);
            font-size: 12px;
        }
        
        .recent-search-text {
            flex: 1;
            font-size: 12px;
            color: var(--text-gray);
        }
        
        .recent-search-time {
            font-size: 10px;
            color: var(--text-light);
        }
        
        /* Search Loading Animation */
        .search-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: var(--element-radius);
            z-index: 100;
        }
        
        .search-loading-overlay.active {
            display: flex;
        }
        
        .search-loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--light-gray);
            border-top: 2px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        /* Voice Search */
        .voice-search-btn {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-orange);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-speed) ease;
        }
        
        .voice-search-btn:hover {
            background: var(--light-orange);
        }
        
        .voice-search-btn.listening {
            color: var(--error-red);
            animation: pulse 1s infinite;
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Focus Styles */
        *:focus {
            outline: 2px solid var(--primary-orange);
            outline-offset: 2px;
        }
        
        *:focus:not(.focus-visible) {
            outline: none;
        }
        
        /* Print Styles */
        @media print {
            .main-panel,
            .top-bar,
            .chat-container,
            .modal-overlay,
            .sos-button,
            .ride-status-bar,
            .emergency-status,
            .notifications-panel {
                display: none !important;
            }
            
            #map {
                position: relative;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Top Navigation Bar -->
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo-icon">
                <img src="jubel.png" alt="Jubel Logo" id="jubelLogo">
            </div>
            <div class="user-info" id="userName">
                <!-- User name will be inserted here -->
            </div>
        </div>
        
        <div class="user-actions">
            <div class="balance-badge" id="balanceBadge">
                <i class="fas fa-wallet"></i>
                <span>Balance: <span class="balance-amount" id="walletBalance">ZMW 0.00</span></span>
            </div>
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationCount">0</span>
            </div>
        </div>
    </div>
    
    <!-- More Options Dropdown -->
    <div class="more-options-dropdown" id="moreOptionsDropdown">
        <div class="dropdown-item" data-option="schedule">
            <div class="dropdown-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="dropdown-text">
                <div class="dropdown-title">Schedule Ride</div>
                <div class="dropdown-desc">Plan your ride in advance</div>
            </div>
        </div>
        <div class="dropdown-item" data-option="order-for-someone">
            <div class="dropdown-icon">
                <i class="fas fa-user-friends"></i>
            </div>
            <div class="dropdown-text">
                <div class="dropdown-title">Order for Someone</div>
                <div class="dropdown-desc">Book a ride for others</div>
            </div>
        </div>
        <div class="dropdown-item" data-option="share-ride">
            <div class="dropdown-icon">
                <i class="fas fa-share-alt"></i>
            </div>
            <div class="dropdown-text">
                <div class="dropdown-title">Share Ride</div>
                <div class="dropdown-desc">Split fare with friends</div>
            </div>
        </div>
        <div class="dropdown-item" data-option="broadcast">
            <div class="dropdown-icon">
                <i class="fas fa-broadcast-tower"></i>
            </div>
            <div class="dropdown-text">
                <div class="dropdown-title">Broadcast Ride</div>
                <div class="dropdown-desc">Share ride with friends</div>
            </div>
        </div>
    </div>
    
    <!-- Ride Status Bar -->
    <div class="ride-status-bar" id="rideStatusBar">
        <div class="status-indicator">
            <div class="status-dot searching" id="statusDot"></div>
            <span class="status-text" id="statusText">Searching for driver</span>
        </div>
        <div class="status-eta">
            <i class="fas fa-clock"></i>
            <span id="etaText">5 min</span>
        </div>
    </div>
    
    <!-- Emergency Status -->
    <div class="emergency-status" id="emergencyStatus">
        <i class="fas fa-exclamation-triangle"></i>
        <span>EMERGENCY RIDE IN PROGRESS</span>
    </div>
    
    <!-- SOS Button -->
    <div class="sos-button" id="sosButton">
        SOS
    </div>
    
    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <div class="chat-title">
                <div class="chat-driver-avatar" id="chatDriverAvatar">
                    <i class="fas fa-user"></i>
                </div>
                Chat with Driver
            </div>
            <button class="chat-close" id="chatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="chat-send-btn" id="chatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <div class="notifications-title">Notifications</div>
            <button class="mark-all-read" id="markAllReadBtn">Mark all as read</button>
        </div>
        <div class="notifications-list" id="notificationsList">
            <!-- Notifications will be inserted here -->
            <div class="empty-notifications">
                <i class="fas fa-bell-slash" style="font-size: 32px; opacity: 0.3;"></i>
                <div style="margin-top: 10px; font-size: 13px;">No notifications yet</div>
            </div>
        </div>
    </div>
    
    <!-- Main Panel -->
    <div class="main-panel" id="mainPanel">
        <div class="panel-handle" id="panelHandle"></div>
        
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-tab" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-tab" data-screen="emergency">
                <i class="fas fa-ambulance"></i>
                <span>Emergency</span>
            </button>
        </div>
        
        <!-- Home Screen Content -->
        <div id="homeContent">
            <!-- Service Tabs -->
            <div class="service-tabs" id="serviceTabs">
                <div class="service-tab car active" data-service="car">
                    <div class="service-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="service-name">Car</div>
                    <div class="service-desc">Ride anywhere</div>
                </div>
                
                <div class="service-tab delivery" data-service="delivery">
                    <div class="service-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="service-name">Delivery</div>
                    <div class="service-desc">Send packages</div>
                </div>
                
                <div class="service-tab short-delivery" data-service="short-delivery">
                    <div class="service-icon">
                        <i class="fas fa-bicycle"></i>
                    </div>
                    <div class="service-name">Short Delivery</div>
                    <div class="service-desc">Quick deliveries</div>
                </div>
                
                <div class="service-tab" data-service="express">
                    <div class="service-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="service-name">Express Shopping</div>
                    <div class="service-desc">Shop for you</div>
                </div>
                
                <div class="service-tab" data-service="truck">
                    <div class="service-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="service-name">Truck</div>
                    <div class="service-desc">Move items</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" id="moreOptionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-ellipsis-h"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">More Options</div>
                        <div class="quick-action-desc">Schedule, Share, Broadcast</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="sosSetupBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">SOS Setup</div>
                        <div class="quick-action-desc">Configure emergency contacts</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="promotionsBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Promotions</div>
                        <div class="quick-action-desc">View active offers</div>
                    </div>
                </button>
                <button class="quick-action-btn" id="helpCenterBtn">
                    <div class="quick-action-icon">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="quick-action-text">
                        <div class="quick-action-title">Help Center</div>
                        <div class="quick-action-desc">Get support</div>
                    </div>
                </button>
            </div>
            
            <!-- Car Service Form (Default) -->
            <div class="ride-request-form active" id="carForm">
                <div class="form-title">
                    <i class="fas fa-car"></i>
                    Book a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input" id="pickupInput">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                        <button class="voice-search-btn" id="pickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="pickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input" id="destinationInput">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <button class="voice-search-btn" id="destinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="destinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Recent Searches -->
                <div class="recent-searches" id="recentSearches" style="display: none;">
                    <div class="recent-searches-title">
                        <span>Recent Searches</span>
                        <span class="clear-recent" id="clearRecentSearches">Clear</span>
                    </div>
                    <div id="recentSearchesList"></div>
                </div>
                
                <!-- Ride Type Selection -->
                <div class="ride-type-selection" id="rideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                        <span id="rideTypeInfo" style="font-size: 11px; color: var(--text-light); cursor: pointer;">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="economyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="standardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="premiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- Fare Display -->
                <div class="fare-display" id="fareDisplay">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="estimatedFare">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="distanceDetail">0 km</span>
                        <span id="timeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestRideBtn">
                        <i class="fas fa-search"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Delivery Service Form -->
            <div class="service-form delivery-form" id="deliveryForm">
                <div class="form-title">
                    <i class="fas fa-shipping-fast"></i>
                    Package Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="deliveryPickup" placeholder="Pickup location" readonly>
                        <button class="voice-search-btn" id="deliveryPickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="deliveryPickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery address">
                        <button class="voice-search-btn" id="deliveryDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="deliveryDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">Parcel Description</label>
                    <input type="text" class="form-control" id="parcelDescription" placeholder="What are you sending?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="receiverName" placeholder="Receiver name">
                        <input type="tel" class="form-control" id="receiverPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Parcel Value (ZMW)</label>
                    <input type="number" class="form-control" id="parcelValue" placeholder="Value of parcel" min="0" step="0.01">
                </div>
                
                <!-- Delivery Options -->
                <div class="form-group">
                    <label class="form-label">Delivery Type</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="filter-btn active" id="standardDelivery">Standard</button>
                        <button class="filter-btn" id="expressDelivery">Express</button>
                        <button class="filter-btn" id="sameDayDelivery">Same Day</button>
                    </div>
                </div>
                
                <!-- Fare Display for Delivery -->
                <div class="fare-display" id="deliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Delivery Fare</div>
                    <div class="fare-amount" id="deliveryFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="deliveryDistanceDetail">0 km</span>
                        <span id="deliveryTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestDeliveryBtn">
                        <i class="fas fa-shipping-fast"></i>
                        Request Delivery
                    </button>
                </div>
            </div>
            
            <!-- Short Delivery Form -->
            <div class="service-form delivery-form" id="shortDeliveryForm">
                <div class="form-title">
                    <i class="fas fa-bicycle"></i>
                    Short Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shortDeliveryPickup" placeholder="Pickup location" readonly>
                        <button class="voice-search-btn" id="shortDeliveryPickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="shortDeliveryPickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shortDeliveryDestination" placeholder="Delivery address">
                        <button class="voice-search-btn" id="shortDeliveryDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="shortDeliveryDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Delivery Details -->
                <div class="form-group">
                    <label class="form-label">What are you sending?</label>
                    <input type="text" class="form-control" id="shortParcelDescription" placeholder="Food, documents, small items...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Receiver's Phone</label>
                    <input type="tel" class="form-control" id="shortReceiverPhone" placeholder="Receiver phone number">
                </div>
                
                <!-- Quick Options -->
                <div class="form-group">
                    <label class="form-label">Quick Options</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <span class="filter-btn">Food</span>
                        <span class="filter-btn">Documents</span>
                        <span class="filter-btn">Medication</span>
                        <span class="filter-btn">Small Package</span>
                    </div>
                </div>
                
                <!-- Fare Display for Short Delivery -->
                <div class="fare-display" id="shortDeliveryFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Delivery Fare</div>
                    <div class="fare-amount" id="shortDeliveryFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shortDeliveryDistanceDetail">0 km</span>
                        <span id="shortDeliveryTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShortDeliveryBtn">
                        <i class="fas fa-bolt"></i>
                        Quick Delivery
                    </button>
                </div>
            </div>
            
            <!-- Express Shopping Form -->
            <div class="service-form express-form" id="expressForm">
                <div class="form-title">
                    <i class="fas fa-shopping-bag"></i>
                    Express Shopping
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-store"></i>
                        <input type="text" id="shopName" placeholder="Shop/Restaurant name">
                        <button class="voice-search-btn" id="shopNameVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="shopNameSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location" readonly>
                    </div>
                </div>
                
                <!-- Items List -->
                <div class="form-group">
                    <label class="form-label">Shopping List</label>
                    <div class="item-list" id="shoppingItems">
                        <div class="item-entry">
                            <input type="text" class="item-input" placeholder="Item name">
                            <button class="remove-item" type="button">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button class="add-item" type="button" id="addItemBtn">
                        <i class="fas fa-plus"></i>
                        Add Item
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions</label>
                    <textarea class="form-control form-textarea" id="shoppingInstructions" placeholder="Any specific requests or instructions..."></textarea>
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shoppingDestination" placeholder="Delivery address">
                        <button class="voice-search-btn" id="shoppingDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="shoppingDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Budget -->
                <div class="form-group">
                    <label class="form-label">Estimated Budget (ZMW)</label>
                    <input type="number" class="form-control" id="shoppingBudget" placeholder="Estimated cost of items">
                </div>
                
                <!-- Fare Display for Shopping -->
                <div class="fare-display" id="shoppingFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Shopping Fare</div>
                    <div class="fare-amount" id="shoppingFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="shoppingDistanceDetail">0 km</span>
                        <span id="shoppingTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShoppingBtn">
                        <i class="fas fa-shopping-cart"></i>
                        Request Shopping
                    </button>
                </div>
            </div>
            
            <!-- Truck Delivery Form -->
            <div class="service-form truck-form" id="truckForm">
                <div class="form-title">
                    <i class="fas fa-truck"></i>
                    Truck Delivery
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="truckPickup" placeholder="Pickup location (Current location)" readonly>
                        <button class="voice-search-btn" id="truckPickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="truckPickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="truckDestination" placeholder="Destination">
                        <button class="voice-search-btn" id="truckDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="truckDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Truck Type Selection -->
                <div class="form-group">
                    <label class="form-label">Select Truck Type</label>
                    <div class="truck-types">
                        <div class="truck-type" data-type="pickup">
                            <div class="truck-icon">
                                <i class="fas fa-truck-pickup"></i>
                            </div>
                            <div class="truck-name">Pickup Truck</div>
                            <div class="truck-capacity">Up to 1.5 tons</div>
                        </div>
                        
                        <div class="truck-type selected" data-type="light">
                            <div class="truck-icon">
                                <i class="fas fa-truck-moving"></i>
                            </div>
                            <div class="truck-name">Light Truck</div>
                            <div class="truck-capacity">Up to 3 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="medium">
                            <div class="truck-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="truck-name">Medium Truck</div>
                            <div class="truck-capacity">Up to 7 tons</div>
                        </div>
                        
                        <div class="truck-type" data-type="heavy">
                            <div class="truck-icon">
                                <i class="fas fa-truck-loading"></i>
                            </div>
                            <div class="truck-name">Heavy Truck</div>
                            <div class="truck-capacity">Up to 15 tons</div>
                        </div>
                    </div>
                </div>
                
                <!-- Item Details -->
                <div class="form-group">
                    <label class="form-label">What are you moving?</label>
                    <input type="text" class="form-control" id="truckItemDescription" placeholder="Furniture, boxes, equipment...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Weight (kg)</label>
                    <input type="number" class="form-control" id="estimatedWeight" placeholder="Approximate weight">
                </div>
                
                <!-- Additional Help -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="needHelpers">
                        <span style="margin-left: 8px;">Need loading/unloading helpers (+ZMW 50)</span>
                    </label>
                </div>
                
                <!-- Fare Display for Truck -->
                <div class="fare-display" id="truckFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Truck Fare</div>
                    <div class="fare-amount" id="truckFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="truckDistanceDetail">0 km</span>
                        <span id="truckTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestTruckBtn">
                        <i class="fas fa-truck"></i>
                        Request Truck
                    </button>
                </div>
            </div>
            
            <!-- Schedule Ride Form -->
            <div class="service-form" id="scheduleForm">
                <div class="form-title">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule a Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickup" placeholder="Pickup location">
                        <button class="voice-search-btn" id="schedulePickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="schedulePickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestination" placeholder="Destination">
                        <button class="voice-search-btn" id="scheduleDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="scheduleDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Ride Type Selection for Schedule -->
                <div class="ride-type-selection" id="scheduleRideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="scheduleEconomyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="scheduleStandardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="schedulePremiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <!-- For Someone Else -->
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="scheduleForSomeone">
                        <span style="margin-left: 8px;">Booking for someone else</span>
                    </label>
                </div>
                
                <div class="form-group" id="someoneElseDetails" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="recipientName" placeholder="Recipient name">
                        <input type="tel" class="form-control" id="recipientPhone" placeholder="Recipient phone">
                    </div>
                </div>
                
                <div class="schedule-grid">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-control" id="scheduleDate" min="">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-control" id="scheduleTime">
                    </div>
                </div>
                
                <!-- Fare Display for Schedule -->
                <div class="fare-display" id="scheduleFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="scheduleFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="scheduleDistanceDetail">0 km</span>
                        <span id="scheduleTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmScheduleBtn">
                        <i class="fas fa-calendar-check"></i>
                        Schedule Ride
                    </button>
                    <button class="btn btn-secondary" id="cancelScheduleBtn">
                        Cancel
                    </button>
                </div>
            </div>
            
            <!-- Order for Someone Else Form -->
            <div class="service-form someone-else-form" id="someoneElseForm">
                <div class="form-title">
                    <i class="fas fa-user-friends"></i>
                    Order for Someone Else
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="someonePickup" placeholder="Pickup location">
                        <button class="voice-search-btn" id="someonePickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="someonePickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="someoneDestination" placeholder="Destination">
                        <button class="voice-search-btn" id="someoneDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="someoneDestinationSearchResults"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="someoneName" placeholder="Full name">
                        <input type="tel" class="form-control" id="someonePhone" placeholder="Phone number">
                    </div>
                </div>
                
                <!-- Ride Type Selection for Someone Else -->
                <div class="ride-type-selection" id="someoneRideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="someoneEconomyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="someoneStandardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="someonePremiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Instructions (Optional)</label>
                    <textarea class="form-control form-textarea" id="someoneInstructions" placeholder="Any instructions for the driver..."></textarea>
                </div>
                
                <!-- Fare Display for Someone Else -->
                <div class="fare-display" id="someoneFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="someoneFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="someoneDistanceDetail">0 km</span>
                        <span id="someoneTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestSomeoneRideBtn">
                        <i class="fas fa-car"></i>
                        Request Ride
                    </button>
                </div>
            </div>
            
            <!-- Share Ride Form -->
            <div class="service-form share-ride-form" id="shareRideForm">
                <div class="form-title">
                    <i class="fas fa-share-alt"></i>
                    Share Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="sharePickup" placeholder="Pickup location">
                        <button class="voice-search-btn" id="sharePickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="sharePickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="shareDestination" placeholder="Destination">
                        <button class="voice-search-btn" id="shareDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="shareDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Ride Type Selection for Share Ride -->
                <div class="ride-type-selection" id="shareRideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="shareEconomyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="shareStandardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="sharePremiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Friend's Referral Code</label>
                    <input type="text" class="form-control" id="friendReferralCode" placeholder="Enter friend's Jubel referral code">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Split Fare</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="form-control" id="splitPercentage" style="flex: 1;">
                            <option value="50">50/50 Split</option>
                            <option value="60">You pay 60%</option>
                            <option value="70">You pay 70%</option>
                            <option value="80">You pay 80%</option>
                            <option value="100">You pay full</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Estimated Fare: <span id="shareFareEstimate">ZMW 0.00</span></label>
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Your Share:</span>
                            <span id="yourShare">ZMW 0.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Friend's Share:</span>
                            <span id="friendShare">ZMW 0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="requestShareRideBtn">
                        <i class="fas fa-user-friends"></i>
                        Share Ride
                    </button>
                </div>
            </div>
            
            <!-- Broadcast Ride Form -->
            <div class="service-form" id="broadcastForm">
                <div class="form-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride
                </div>
                
                <div class="location-inputs">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="broadcastPickup" placeholder="Pickup location">
                        <button class="voice-search-btn" id="broadcastPickupVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="broadcastPickupSearchResults"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="broadcastDestination" placeholder="Destination">
                        <button class="voice-search-btn" id="broadcastDestinationVoiceBtn" title="Voice search">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <div class="search-loading"></div>
                        <div class="search-results-container" id="broadcastDestinationSearchResults"></div>
                    </div>
                </div>
                
                <!-- Ride Type Selection for Broadcast -->
                <div class="ride-type-selection" id="broadcastRideTypeSelection">
                    <div class="ride-type-title">
                        <span>Select Ride Type</span>
                    </div>
                    
                    <div class="ride-type-grid">
                        <div class="ride-type-card economy" data-type="economy">
                            <div class="ride-type-icon">
                                <i class="fas fa-car-side"></i>
                            </div>
                            <div class="ride-type-name">Economy</div>
                            <div class="ride-type-price" id="broadcastEconomyPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 5-10 min</div>
                        </div>
                        
                        <div class="ride-type-card selected" data-type="standard">
                            <div class="ride-type-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="ride-type-name">Standard</div>
                            <div class="ride-type-price" id="broadcastStandardPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 3-7 min</div>
                        </div>
                        
                        <div class="ride-type-card premium" data-type="premium">
                            <div class="ride-type-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <div class="ride-type-name">Premium</div>
                            <div class="ride-type-price" id="broadcastPremiumPrice">ZMW 0.00</div>
                            <div class="ride-type-eta">ETA: 2-5 min</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Phone Number</label>
                    <input type="tel" class="form-control" id="broadcastPhone" placeholder="Enter recipient's phone number">
                    <div style="margin-top: 8px;">
                        <button type="button" class="btn btn-secondary" id="addRecipientBtn" style="font-size: 12px; padding: 8px 12px;">
                            <i class="fas fa-plus"></i> Add Another Recipient
                        </button>
                    </div>
                </div>
                
                <div id="broadcastRecipients" style="margin-top: 12px;">
                    <!-- Additional recipients will be added here -->
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <textarea class="form-control form-textarea" id="broadcastMessage" placeholder="Add a message for the recipient..." rows="2"></textarea>
                </div>
                
                <!-- Fare Display for Broadcast -->
                <div class="fare-display" id="broadcastFareDisplay" style="display: none;">
                    <div class="fare-label">Estimated Fare</div>
                    <div class="fare-amount" id="broadcastFareAmount">ZMW 0.00</div>
                    <div class="fare-details">
                        <span id="broadcastDistanceDetail">0 km</span>
                        <span id="broadcastTimeDetail">ETA: 0 min</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" id="sendBroadcastBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Broadcast
                    </button>
                </div>
            </div>
            
            <!-- Ride Info Panel -->
            <div class="ride-info-panel" id="rideInfoPanel">
                <div class="driver-info">
                    <div class="driver-avatar" id="driverAvatar">
                        <i class="fas fa-user"></i>
                        <div class="vehicle-image" id="vehicleImage">
                            <i class="fas fa-car"></i>
                        </div>
                    </div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">Driver Name</div>
                        <div class="driver-rating">
                            <i class="fas fa-star"></i>
                            <span id="driverRating">4.8</span>
                        </div>
                        <div class="driver-vehicle">
                            <i class="fas fa-car"></i>
                            <span id="vehicleDetails">Toyota Corolla - ABC 123</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline -->
                <div class="timeline" id="rideTimeline">
                    <div class="timeline-step">
                        <div class="step-dot active" id="stepRequested">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="step-label active">Requested</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepAccepted">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="step-label">Accepted</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepArrived">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="step-label">Arrived</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepStarted">
                            <i class="fas fa-play"></i>
                        </div>
                        <div class="step-label">Started</div>
                    </div>
                    <div class="timeline-step">
                        <div class="step-dot" id="stepCompleted">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                        <div class="step-label">Completed</div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="trip-locations">
                        <div class="location-point">
                            <div class="location-marker pickup">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Pickup</div>
                                <div class="location-address" id="currentPickup">Loading...</div>
                            </div>
                        </div>
                        
                        <div class="location-point">
                            <div class="location-marker destination">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <div class="location-label">Destination</div>
                                <div class="location-address" id="currentDestination">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="fare-breakdown">
                    <div class="fare-row">
                        <span class="fare-label">Base Fare</span>
                        <span class="fare-value" id="baseFareValue">ZMW 15.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Distance</span>
                        <span class="fare-value" id="distanceFareValue">ZMW 5.00</span>
                    </div>
                    <div class="fare-row">
                        <span class="fare-label">Ride Type</span>
                        <span class="fare-value" id="rideTypeValue">Standard</span>
                    </div>
                    <div class="fare-row total">
                        <span class="fare-label">Total Fare</span>
                        <span class="fare-value" id="totalFareValue">ZMW 20.00</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" id="contactDriverBtn">
                        <i class="fas fa-phone"></i>
                        Call Driver
                    </button>
                    <button class="btn btn-secondary" id="openChatBtn">
                        <i class="fas fa-comment"></i>
                        Chat
                    </button>
                    <button class="btn broadcast-btn" id="broadcastRideBtn">
                        <i class="fas fa-broadcast-tower"></i>
                        Broadcast
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Screen -->
    <div class="history-screen" id="historyScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Ride History</div>
        </div>
        
        <div class="history-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="cancelled">Cancelled</button>
            <button class="filter-btn" data-filter="scheduled">Scheduled</button>
            <button class="filter-btn" data-filter="emergency">Emergency</button>
            <button class="filter-btn" data-filter="delivery">Delivery</button>
            <button class="filter-btn" data-filter="truck">Truck</button>
            <button class="filter-btn" data-filter="shared">Shared</button>
        </div>
        
        <div class="history-list" id="historyList">
            <!-- History items will be inserted here -->
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="empty-title">No ride history yet</div>
                <div class="empty-message">Your completed and scheduled rides will appear here</div>
            </div>
        </div>
    </div>
    
    <!-- Account Screen -->
    <div class="account-screen" id="accountScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">My Account</div>
        </div>
        
        <div class="account-header">
            <div class="account-avatar" id="accountAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="account-name" id="accountName">Loading...</div>
            <div class="account-phone" id="accountPhone">Loading...</div>
        </div>
        
        <div class="account-stats">
            <div class="stat-card">
                <div class="stat-value" id="completedRides">0</div>
                <div class="stat-label">Completed Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cancelledRides">0</div>
                <div class="stat-label">Cancelled Rides</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSpent">ZMW 0</div>
                <div class="stat-label">Total Spent</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet Balance
            </div>
            
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">ZMW 0.00</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn-wallet" id="depositBtn">
                    <i class="fas fa-plus"></i>
                    Deposit
                </button>
                <button class="btn-wallet" id="withdrawBtn">
                    <i class="fas fa-minus"></i>
                    Withdraw
                </button>
                <button class="btn-wallet" id="transferBtn">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer
                </button>
                <button class="btn-wallet" id="transactionsBtn">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-gift"></i>
                Referral Program
            </div>
            
            <div class="referral-card">
                <div>Share your referral code and earn ZMW 25 for each friend's first ride</div>
                <div class="referral-code" id="referralCode">JUBEL-XXXX</div>
                <button class="btn btn-primary" id="shareReferralBtn">
                    <i class="fas fa-share"></i>
                    Share Code
                </button>
                <div class="referral-note">Your friend gets 50% off their first ride</div>
            </div>
        </div>
        
        <div class="account-section">
            <div class="section-title">
                <i class="fas fa-cog"></i>
                Settings
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>
    
    <!-- Emergency Screen -->
    <div class="emergency-screen" id="emergencyScreen">
        <div class="screen-header">
            <button class="back-btn" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="screen-title">Emergency Services</div>
        </div>
        
        <div class="emergency-services">
            <div class="emergency-service police" data-type="police">
                <div class="emergency-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="emergency-name">Police Ride</div>
                <div class="emergency-description">Emergency transport with police escort</div>
            </div>
            
            <div class="emergency-service fire" data-type="fire">
                <div class="emergency-icon">
                    <i class="fas fa-fire-extinguisher"></i>
                </div>
                <div class="emergency-name">Fire Brigade</div>
                <div class="emergency-description">Fire emergency response team</div>
            </div>
            
            <div class="emergency-service medical" data-type="medical">
                <div class="emergency-icon">
                    <i class="fas fa-ambulance"></i>
                </div>
                <div class="emergency-name">Hospital Ride</div>
                <div class="emergency-description">Medical emergency transport</div>
            </div>
            
            <div class="emergency-service" data-type="sos">
                <div class="emergency-icon" style="background: var(--error-red);">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="emergency-name">SOS Emergency</div>
                <div class="emergency-description">Immediate emergency assistance</div>
            </div>
        </div>
        
        <div class="emergency-note">
            <p><strong>Important:</strong> Only use emergency services for genuine emergencies. Misuse may result in penalties. In case of immediate danger, call 911 first.</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Payment Modal -->
    <div class="modal-overlay" id="paymentModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </div>
                <button class="modal-close" data-modal="payment">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="paymentBalance">ZMW 0.00</span></div>
                    <div class="form-label">Total Amount: <span id="paymentAmount">ZMW 0.00</span></div>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method" data-payment="wallet">
                        <div class="payment-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Jubel Wallet</div>
                            <div class="payment-info">Pay with your wallet balance</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="mobile">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Mobile Money</div>
                            <div class="payment-info">Pay via MTN/Zamtel/Airtel</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-payment="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay driver directly</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmPaymentBtn">
                        <i class="fas fa-check"></i>
                        Confirm Payment
                    </button>
                    <button class="btn btn-secondary" data-modal="payment">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancel Ride Modal -->
    <div class="modal-overlay" id="cancelModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-times-circle"></i>
                    Cancel Ride
                </div>
                <button class="modal-close" data-modal="cancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Please select a reason for cancellation:</div>
                </div>
                
                <div class="cancel-reasons">
                    <div class="cancel-reason" data-reason="driver_late">
                        <div class="reason-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="reason-text">Driver is taking too long</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="change_plans">
                        <div class="reason-icon">
                            <i class="fas fa-calendar-times"></i>
                        </div>
                        <div class="reason-text">Change of plans</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="found_alternative">
                        <div class="reason-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="reason-text">Found alternative transport</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="emergency">
                        <div class="reason-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="reason-text">Emergency situation</div>
                    </div>
                    
                    <div class="cancel-reason" data-reason="other">
                        <div class="reason-icon">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="reason-text">Other reason</div>
                    </div>
                </div>
                
                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label class="form-label">Please specify:</label>
                    <textarea class="form-control form-textarea" id="otherReason" placeholder="Enter your reason here..."></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-times"></i>
                        Cancel Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="cancel">
                        Go Back
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Emergency Ride Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Ride Details
                </div>
                <button class="modal-close" data-modal="emergency">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label" id="emergencyServiceType">Police Ride</div>
                </div>
                
                <!-- Emergency Reasons -->
                <div class="form-group">
                    <label class="form-label">Select Emergency Reason</label>
                    <div class="emergency-reasons">
                        <div class="emergency-reason" data-reason="accident">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-car-crash"></i>
                            </div>
                            <div class="reason-text">Accident/Injury</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="crime">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div class="reason-text">Crime/Assault</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="fire">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="reason-text">Fire Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="medical">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                            <div class="reason-text">Medical Emergency</div>
                        </div>
                        
                        <div class="emergency-reason" data-reason="other">
                            <div class="emergency-reason-icon">
                                <i class="fas fa-ellipsis-h"></i>
                            </div>
                            <div class="reason-text">Other Emergency</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="otherEmergencyReasonGroup" style="display: none;">
                    <label class="form-label">Please describe the emergency:</label>
                    <textarea class="form-control form-textarea" id="otherEmergencyReason" placeholder="Describe the emergency situation..."></textarea>
                </div>
                
                <!-- Emergency Services List -->
                <div class="form-group">
                    <label class="form-label">Select Nearest Emergency Service</label>
                    <div class="emergency-services-list" id="emergencyServicesList">
                        <!-- Emergency services will be inserted here -->
                        <div class="empty-state" style="padding: 20px 0;">
                            <div class="empty-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="empty-title">Finding emergency services...</div>
                        </div>
                    </div>
                </div>
                
                <!-- User Location Details -->
                <div class="form-group">
                    <label class="form-label">Your Current Location</label>
                    <div class="form-control" id="emergencyUserLocation" style="background: var(--light-red); border-color: var(--error-red);">
                        <div style="font-size: 12px; color: var(--dark-gray);" id="emergencyLocationDetails">
                            Loading your location...
                        </div>
                    </div>
                </div>
                
                <!-- Fare Calculation -->
                <div class="form-group">
                    <div class="price-calculation">
                        <div class="calculation-row">
                            <span>Base Emergency Fare:</span>
                            <span id="emergencyBaseFare">ZMW 100.00</span>
                        </div>
                        <div class="calculation-row">
                            <span>Distance to Service:</span>
                            <span id="emergencyDistance">0 km</span>
                        </div>
                        <div class="calculation-row">
                            <span>Estimated Time:</span>
                            <span id="emergencyTime">5 min</span>
                        </div>
                        <div class="calculation-row">
                            <span>Total Fare:</span>
                            <span id="emergencyTotalFare">ZMW 100.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Description -->
                <div class="form-group">
                    <label class="form-label">Additional Details (Optional)</label>
                    <textarea class="form-control form-textarea" id="emergencyDescription" placeholder="Provide any additional information that might help emergency services..."></textarea>
                </div>
                
                <!-- Warning -->
                <div class="emergency-note" style="margin: 16px 0; padding: 12px;">
                    <p style="font-size: 11px; color: var(--error-red);">
                        <strong><i class="fas fa-exclamation-triangle"></i> WARNING:</strong> 
                        This is an emergency service. Only use for genuine emergencies. False reports may result in legal action and suspension of your account.
                    </p>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-danger" id="confirmEmergencyBtn">
                        <i class="fas fa-exclamation-triangle"></i>
                        Request Emergency Ride
                    </button>
                    <button class="btn btn-secondary" data-modal="emergency">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced SOS Setup Modal -->
    <div class="modal-overlay" id="sosModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Setup
                </div>
                <button class="modal-close" data-modal="sos">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Primary Emergency Contact</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact1Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact1Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Secondary Emergency Contact (Optional)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control" id="sosContact2Name" placeholder="Contact name">
                        <input type="tel" class="form-control" id="sosContact2Phone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Emergency Message</label>
                    <textarea class="form-control form-textarea" id="sosMessage">
 EMERGENCY ALERT 

I need immediate assistance! My current location and ride details have been shared with you through Jubel.

Current Time: [TIME]
Ride Status: [STATUS]
Driver: [DRIVER_NAME]
Vehicle: [VEHICLE_DETAILS]

Please check on me immediately!
                    </textarea>
                </div>
                
                <!-- Test SOS Button -->
                <div class="form-group">
                    <label class="form-label">Test SOS Alert</label>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="testSOSBtn" style="flex: 1;">
                            <i class="fas fa-bell"></i>
                            Test Alert (Silent)
                        </button>
                    </div>
                    <div style="font-size: 11px; color: var(--text-light); margin-top: 4px;">
                        This will send a test alert to your emergency contacts without triggering emergency services.
                    </div>
                </div>
                
                <!-- SOS Settings -->
                <div class="form-group">
                    <label class="form-label">SOS Settings</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="form-label">
                            <input type="checkbox" id="autoSOS" checked>
                            <span style="margin-left: 8px;">Auto-trigger SOS if ride exceeds 30 minutes after scheduled time</span>
                        </label>
                        <label class="form-label">
                            <input type="checkbox" id="shareLocation" checked>
                            <span style="margin-left: 8px;">Share real-time location during SOS</span>
                        </label>
                        <label class="form-label">
                            <input type="checkbox" id="shareDriverInfo" checked>
                            <span style="margin-left: 8px;">Share driver information during SOS</span>
                        </label>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="saveSOSBtn">
                        <i class="fas fa-save"></i>
                        Save SOS Setup
                    </button>
                    <button class="btn btn-secondary" data-modal="sos">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transfer Money Modal -->
    <div class="modal-overlay" id="transferModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-exchange-alt"></i>
                    Transfer Money
                </div>
                <button class="modal-close" data-modal="transfer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <div class="form-label">Available Balance: <span id="transferBalance">ZMW 0.00</span></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient's Referral Code or Phone Number</label>
                    <input type="text" class="form-control" id="recipientCode" placeholder="Enter referral code or phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (ZMW)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="Enter amount" min="1" step="0.01">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message (Optional)</label>
                    <input type="text" class="form-control" id="transferMessage" placeholder="Add a message">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="confirmTransferBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Money
                    </button>
                    <button class="btn btn-secondary" data-modal="transfer">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wallet Transactions Modal -->
    <div class="modal-overlay" id="transactionsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-history"></i>
                    Wallet Transactions
                </div>
                <button class="modal-close" data-modal="transactions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="transactionsList">
                    <!-- Transactions will be inserted here -->
                    <div class="empty-state" style="padding: 30px 0;">
                        <div class="empty-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="empty-title">No transactions yet</div>
                        <div class="empty-message">Your wallet transactions will appear here</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Broadcast Ride Modal -->
    <div class="modal-overlay" id="broadcastModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Broadcast Ride Details
                </div>
                <button class="modal-close" data-modal="broadcast">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Recipient's Phone Number</label>
                    <input type="tel" class="form-control" id="broadcastRecipientPhone" placeholder="Enter recipient's phone number">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-control form-textarea" id="broadcastRideMessage" rows="3">
 Ride Share Invitation

I'm sharing my ride details with you through Jubel. You can track the ride in real-time.

Pickup: [PICKUP_LOCATION]
Destination: [DESTINATION]
Driver: [DRIVER_NAME]
Vehicle: [VEHICLE]
Estimated Arrival: [ETA]

You'll receive live updates about the ride progress.
                    </textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="form-label">
                            <input type="checkbox" id="allowTracking" checked>
                            <span style="margin-left: 8px;">Allow recipient to track ride in real-time</span>
                        </label>
                        <label class="form-label">
                            <input type="checkbox" id="shareDriverInfoBroadcast" checked>
                            <span style="margin-left: 8px;">Share driver and vehicle information</span>
                        </label>
                        <label class="form-label">
                            <input type="checkbox" id="shareETABroadcast" checked>
                            <span style="margin-left: 8px;">Share estimated arrival time</span>
                        </label>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn broadcast-btn" id="sendBroadcastInviteBtn">
                        <i class="fas fa-paper-plane"></i>
                        Send Invitation
                    </button>
                    <button class="btn btn-secondary" data-modal="broadcast">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Promotions Modal -->
    <div class="modal-overlay" id="promotionsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-gift"></i>
                    Active Promotions
                </div>
                <button class="modal-close" data-modal="promotions">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div id="promotionsList">
                    <!-- Promotions will be inserted here -->
                    <div class="empty-state" style="padding: 30px 0;">
                        <div class="empty-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="empty-title">No active promotions</div>
                        <div class="empty-message">Check back later for exciting offers!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const messaging = firebase.messaging();

        // ============================================
        // ENHANCED APP STATE MANAGEMENT
        // ============================================
        const AppState = {
            currentUser: null,
            userData: null,
            currentRide: null,
            activeScreen: 'home',
            activeService: 'car',
            walletBalance: 0,
            userLocation: null,
            currentCity: 'Lusaka',
            detectedCity: null,
            selectedRideType: 'standard',
            selectedVehicle: null,
            destination: null,
            pickup: null,
            rideFare: 0,
            driverLocation: null,
            chatMessages: [],
            scheduledRides: [],
            emergencyMode: false,
            sosConfig: null,
            searchCache: new Map(),
            recentSearches: [],
            notifications: [],
            promotions: [],
            broadcastRecipients: [],
            activeFilters: {
                history: 'all',
                search: 'all'
            },
            voiceSearchActive: false,
            searchEngine: null,
            socket: null,
            
            // Enhanced ride types with more details
            rideTypes: {
                economy: { 
                    base: 15, 
                    perKm: 2.5, 
                    multiplier: 0.8, 
                    min: 10, 
                    icon: 'fa-car-side',
                    description: 'Affordable rides',
                    features: ['Basic comfort', 'Standard vehicle', 'Reliable service']
                },
                standard: { 
                    base: 20, 
                    perKm: 3.0, 
                    multiplier: 1.0, 
                    min: 15, 
                    icon: 'fa-car',
                    description: 'Comfortable rides',
                    features: ['Air conditioning', 'Comfortable seating', 'Professional driver']
                },
                premium: { 
                    base: 30, 
                    perKm: 4.0, 
                    multiplier: 1.5, 
                    min: 25, 
                    icon: 'fa-crown',
                    description: 'Luxury experience',
                    features: ['Premium vehicle', 'Priority service', 'Executive driver', 'Complimentary water']
                }
            },
            
            // Enhanced emergency services
            emergencyServices: {
                police: { 
                    base: 150, 
                    perKm: 5.0, 
                    multiplier: 2.0, 
                    min: 100,
                    icon: 'fa-shield-alt',
                    responseTime: '3-5 minutes',
                    priority: 'highest'
                },
                fire: { 
                    base: 200, 
                    perKm: 6.0, 
                    multiplier: 2.5, 
                    min: 150,
                    icon: 'fa-fire-extinguisher',
                    responseTime: '5-7 minutes',
                    priority: 'highest'
                },
                medical: { 
                    base: 180, 
                    perKm: 5.5, 
                    multiplier: 2.2, 
                    min: 120,
                    icon: 'fa-ambulance',
                    responseTime: '4-6 minutes',
                    priority: 'highest'
                }
            },
            
            // Enhanced delivery types
            deliveryTypes: {
                standard: { 
                    base: 25, 
                    perKm: 2.0, 
                    multiplier: 1.0,
                    deliveryTime: '1-2 hours',
                    insurance: 'Basic'
                },
                express: { 
                    base: 40, 
                    perKm: 3.0, 
                    multiplier: 1.5,
                    deliveryTime: '30-45 minutes',
                    insurance: 'Standard'
                },
                sameDay: { 
                    base: 60, 
                    perKm: 4.0, 
                    multiplier: 2.0,
                    deliveryTime: '15-30 minutes',
                    insurance: 'Premium'
                }
            },
            
            // Enhanced truck types
            truckTypes: {
                pickup: { 
                    base: 80, 
                    perKm: 5.0, 
                    multiplier: 1.0, 
                    capacity: '1.5 tons',
                    dimensions: '2.5m x 1.5m x 1.5m'
                },
                light: { 
                    base: 120, 
                    perKm: 6.0, 
                    multiplier: 1.2, 
                    capacity: '3 tons',
                    dimensions: '3.5m x 1.8m x 1.8m'
                },
                medium: { 
                    base: 200, 
                    perKm: 8.0, 
                    multiplier: 1.5, 
                    capacity: '7 tons',
                    dimensions: '5.0m x 2.0m x 2.0m'
                },
                heavy: { 
                    base: 350, 
                    perKm: 12.0, 
                    multiplier: 2.0, 
                    capacity: '15 tons',
                    dimensions: '7.0m x 2.5m x 2.5m'
                }
            },
            
            // Emergency reasons
            emergencyReasons: {
                accident: 'Accident/Injury',
                crime: 'Crime/Assault',
                fire: 'Fire Emergency',
                medical: 'Medical Emergency',
                other: 'Other Emergency'
            },
            
            // Search categories
            searchCategories: {
                all: 'All Places',
                restaurant: 'Restaurants',
                hotel: 'Hotels',
                hospital: 'Hospitals',
                shopping: 'Shopping',
                landmark: 'Landmarks',
                government: 'Government',
                education: 'Education',
                entertainment: 'Entertainment'
            },
            
            // Initialize methods
            init: function() {
                this.loadRecentSearches();
                this.setupSearchEngine();
            },
            
            loadRecentSearches: function() {
                const saved = localStorage.getItem('jubel_recent_searches');
                if (saved) {
                    this.recentSearches = JSON.parse(saved);
                }
            },
            
            saveRecentSearches: function() {
                localStorage.setItem('jubel_recent_searches', JSON.stringify(this.recentSearches));
            },
            
            addRecentSearch: function(search) {
                // Remove if already exists
                this.recentSearches = this.recentSearches.filter(s => s.text !== search.text);
                
                // Add to beginning
                this.recentSearches.unshift(search);
                
                // Keep only last 10 searches
                if (this.recentSearches.length > 10) {
                    this.recentSearches = this.recentSearches.slice(0, 10);
                }
                
                this.saveRecentSearches();
            },
            
            clearRecentSearches: function() {
                this.recentSearches = [];
                this.saveRecentSearches();
            },
            
            setupSearchEngine: function() {
                this.searchEngine = new EnhancedSearchEngine();
            }
        };

        // ============================================
        // ENHANCED SEARCH ENGINE
        // ============================================
        class EnhancedSearchEngine {
            constructor() {
                this.cache = new Map();
                this.debounceTimers = new Map();
                this.searchHistory = new Map();
                this.geocoder = null;
                this.lastCity = null;
                this.searchBoundaries = null;
            }
            
            async search(query, type = 'destination', location = null, category = 'all') {
                const cacheKey = `${query}-${type}-${category}-${location ? `${location.lat},${location.lng}` : 'none'}`;
                
                // Return cached results if available and recent (3 minutes)
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (Date.now() - cached.timestamp < 180000) {
                        return cached.results;
                    }
                }
                
                try {
                    // Show loading state
                    UIUpdater.showSearchLoading(true);
                    
                    let results = [];
                    
                    // Use different APIs based on query type
                    if (query.length > 0) {
                        if (this.isCoordinates(query)) {
                            results = await this.reverseGeocode(query);
                        } else {
                            results = await this.forwardGeocode(query, location, category);
                        }
                    }
                    
                    // Process and sort results
                    const processedResults = this.processResults(results, location);
                    
                    // Cache the results
                    this.cache.set(cacheKey, {
                        results: processedResults,
                        timestamp: Date.now()
                    });
                    
                    // Add to search history
                    this.addToHistory(query, processedResults);
                    
                    return processedResults;
                } catch (error) {
                    console.error('Search error:', error);
                    return this.getFallbackResults(query, location);
                } finally {
                    UIUpdater.showSearchLoading(false);
                }
            }
            
            async forwardGeocode(query, location, category) {
                const url = this.buildSearchUrl(query, location, category);
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'JubelRideApp/1.0'
                    }
                });
                
                if (!response.ok) throw new Error(`Search failed: ${response.status}`);
                
                const data = await response.json();
                return data;
            }
            
            async reverseGeocode(coordinates) {
                const [lat, lng] = coordinates.split(',').map(coord => parseFloat(coord.trim()));
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Reverse geocode failed');
                
                const data = await response.json();
                return [data];
            }
            
            buildSearchUrl(query, location, category) {
                const params = new URLSearchParams({
                    q: query,
                    format: 'json',
                    limit: 15,
                    countrycodes: 'zm',
                    'accept-language': 'en',
                    addressdetails: 1,
                    namedetails: 1,
                    extratags: 1
                });
                
                // Add category filter if not 'all'
                if (category !== 'all') {
                    params.append('category', category);
                }
                
                // Add location-based bounds if available
                if (location) {
                    const bounds = this.getSearchBounds(location, 20); // 20km radius
                    params.append('viewbox', bounds.join(','));
                    params.append('bounded', 1);
                }
                
                // Add city restriction if detected
                if (AppState.detectedCity) {
                    params.append('city', AppState.detectedCity);
                }
                
                return `https://nominatim.openstreetmap.org/search?${params}`;
            }
            
            getSearchBounds(location, radiusKm = 20) {
                const radius = radiusKm / 111; // Approximate conversion from km to degrees
                return [
                    location.lng - radius,
                    location.lat - radius,
                    location.lng + radius,
                    location.lat + radius
                ];
            }
            
            processResults(data, location) {
                if (!data || !Array.isArray(data)) return [];
                
                return data.map(place => ({
                    id: place.place_id,
                    name: place.display_name.split(',')[0],
                    address: this.formatAddress(place),
                    fullAddress: place.display_name,
                    lat: parseFloat(place.lat),
                    lng: parseFloat(place.lon),
                    type: place.type || place.class,
                    category: this.getCategory(place),
                    importance: place.importance || 0,
                    distance: location ? this.calculateDistance(
                        location.lat, location.lng,
                        parseFloat(place.lat), parseFloat(place.lon)
                    ) : 0,
                    icon: this.getIconForType(place.type || place.class),
                    details: this.getDetails(place)
                })).sort((a, b) => {
                    // Sort by distance if location is available
                    if (location && a.distance && b.distance) {
                        return a.distance - b.distance;
                    }
                    // Otherwise sort by importance
                    return b.importance - a.importance;
                });
            }
            
            formatAddress(place) {
                const address = place.address || {};
                const parts = [];
                
                // Start with the most specific details
                if (address.house_number || address.housenumber) {
                    parts.push(address.house_number || address.housenumber);
                }
                
                if (address.road) {
                    parts.push(address.road);
                }
                
                if (address.suburb || address.neighbourhood) {
                    parts.push(address.suburb || address.neighbourhood);
                }
                
                if (address.city_district) {
                    parts.push(address.city_district);
                }
                
                if (address.city || address.town || address.village) {
                    parts.push(address.city || address.town || address.village);
                }
                
                return parts.join(', ');
            }
            
            getCategory(place) {
                const type = place.type || place.class;
                const tags = place.extratags || {};
                
                if (type === 'restaurant' || type === 'cafe' || type === 'fast_food') return 'restaurant';
                if (type === 'hotel' || type === 'guest_house') return 'hotel';
                if (type === 'hospital' || type === 'clinic') return 'hospital';
                if (type === 'mall' || type === 'supermarket') return 'shopping';
                if (type === 'attraction' || type === 'monument') return 'landmark';
                if (type === 'government' || tags.government) return 'government';
                if (type === 'school' || type === 'university') return 'education';
                if (type === 'cinema' || type === 'theatre') return 'entertainment';
                
                return 'other';
            }
            
            getIconForType(type) {
                const icons = {
                    restaurant: 'fas fa-utensils',
                    cafe: 'fas fa-coffee',
                    fast_food: 'fas fa-hamburger',
                    hotel: 'fas fa-hotel',
                    guest_house: 'fas fa-bed',
                    hospital: 'fas fa-hospital',
                    clinic: 'fas fa-clinic-medical',
                    pharmacy: 'fas fa-prescription-bottle',
                    mall: 'fas fa-shopping-cart',
                    supermarket: 'fas fa-store',
                    attraction: 'fas fa-landmark',
                    monument: 'fas fa-monument',
                    government: 'fas fa-landmark',
                    school: 'fas fa-school',
                    university: 'fas fa-university',
                    cinema: 'fas fa-film',
                    theatre: 'fas fa-theater-masks',
                    park: 'fas fa-tree',
                    museum: 'fas fa-landmark',
                    bank: 'fas fa-university',
                    atm: 'fas fa-money-bill-wave',
                    default: 'fas fa-map-marker-alt'
                };
                
                return icons[type] || icons.default;
            }
            
            getDetails(place) {
                const details = [];
                const address = place.address || {};
                
                if (address.postcode) details.push(`Postal: ${address.postcode}`);
                if (place.extratags) {
                    if (place.extratags.phone) details.push(`Phone: ${place.extratags.phone}`);
                    if (place.extratags.website) details.push(`Website: ${place.extratags.website}`);
                }
                
                return details;
            }
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
            toRad(value) {
                return value * Math.PI / 180;
            }
            
            isCoordinates(query) {
                const coordRegex = /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/;
                return coordRegex.test(query);
            }
            
            getFallbackResults(query, location) {
                // Provide fallback results when API fails
                return [{
                    id: 'fallback-1',
                    name: query,
                    address: 'Location not found in database',
                    fullAddress: query,
                    lat: location?.lat || -15.4167,
                    lng: location?.lng || 28.2833,
                    type: 'place',
                    category: 'other',
                    importance: 0.1,
                    distance: 0,
                    icon: 'fas fa-map-marker-alt',
                    details: []
                }];
            }
            
            addToHistory(query, results) {
                const timestamp = Date.now();
                const historyKey = query.toLowerCase();
                
                if (!this.searchHistory.has(historyKey)) {
                    this.searchHistory.set(historyKey, {
                        query,
                        results,
                        timestamp,
                        count: 1
                    });
                } else {
                    const existing = this.searchHistory.get(historyKey);
                    existing.timestamp = timestamp;
                    existing.count++;
                }
                
                // Keep history size manageable
                if (this.searchHistory.size > 50) {
                    const oldestKey = Array.from(this.searchHistory.entries())
                        .sort((a, b) => a[1].timestamp - b[1].timestamp)[0][0];
                    this.searchHistory.delete(oldestKey);
                }
            }
            
            clearCache() {
                this.cache.clear();
            }
            
            getPopularSearches() {
                return Array.from(this.searchHistory.values())
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
            }
        }

        // ============================================
        // ENHANCED PRICE CALCULATOR
        // ============================================
        const PriceCalculator = {
            calculateRideFare: function(distanceKm, rideType = 'standard', surge = 1.0, timeOfDay = null) {
                const config = AppState.rideTypes[rideType] || AppState.rideTypes.standard;
                
                // Base fare + distance fare
                let fare = config.base + (distanceKm * config.perKm);
                
                // Apply ride type multiplier
                fare *= config.multiplier;
                
                // Apply surge pricing based on time and demand
                const surgeMultiplier = this.getSurgeMultiplier(timeOfDay);
                fare *= surgeMultiplier;
                
                // Apply additional surge if provided
                fare *= surge;
                
                // Ensure minimum fare
                fare = Math.max(fare, config.min);
                
                // Round to 2 decimal places
                return Math.round(fare * 100) / 100;
            },
            
            calculateEmergencyFare: function(distanceKm, serviceType, priority = 'high') {
                const config = AppState.emergencyServices[serviceType] || AppState.emergencyServices.police;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Apply priority multiplier
                if (priority === 'highest') fare *= 1.5;
                if (priority === 'high') fare *= 1.2;
                
                fare = Math.max(fare, config.min);
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateDeliveryFare: function(distanceKm, deliveryType = 'standard', parcelValue = 0, weight = 0) {
                const config = AppState.deliveryTypes[deliveryType] || AppState.deliveryTypes.standard;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add weight-based charges
                if (weight > 5) fare += (weight - 5) * 2;
                
                // Add insurance for valuable parcels (1% of parcel value)
                if (parcelValue > 500) {
                    fare += parcelValue * 0.01;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateTruckFare: function(distanceKm, truckType = 'light', helpers = false, weight = 0) {
                const config = AppState.truckTypes[truckType] || AppState.truckTypes.light;
                
                let fare = config.base + (distanceKm * config.perKm);
                fare *= config.multiplier;
                
                // Add weight-based charges
                if (weight > parseFloat(config.capacity)) {
                    const extraWeight = weight - parseFloat(config.capacity);
                    fare += extraWeight * 5;
                }
                
                // Add helper cost if needed
                if (helpers) {
                    fare += 50;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateShoppingFare: function(distanceKm, itemsCount = 1, budget = 0, shopType = 'general') {
                // Base fare + distance + item count
                let fare = 30 + (distanceKm * 2.5) + (itemsCount * 5);
                
                // Add shop type multiplier
                if (shopType === 'restaurant') fare *= 1.2;
                if (shopType === 'supermarket') fare *= 1.1;
                
                // Add 5% of budget for shopping service
                if (budget > 0) {
                    fare += budget * 0.05;
                }
                
                return Math.round(fare * 100) / 100;
            },
            
            calculateDistance: function(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in km
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * 
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },
            
            toRad: function(value) {
                return value * Math.PI / 180;
            },
            
            estimateTime: function(distanceKm, rideType = 'standard', traffic = 'normal') {
                // Base time + traffic factor
                const baseSpeed = rideType === 'premium' ? 45 : rideType === 'standard' ? 35 : 25; // km/h
                let baseTime = (distanceKm / baseSpeed) * 60; // minutes
                
                // Apply traffic factor
                const trafficFactors = {
                    light: 1.1,
                    normal: 1.3,
                    heavy: 1.7,
                    severe: 2.2
                };
                
                baseTime *= trafficFactors[traffic] || 1.3;
                
                // Add pickup and dropoff time
                baseTime += 3; // 3 minutes for pickup/dropoff
                
                return Math.ceil(baseTime);
            },
            
            getSurgeMultiplier: function(timeOfDay = null) {
                const now = timeOfDay ? new Date(timeOfDay) : new Date();
                const hour = now.getHours();
                const day = now.getDay(); // 0 = Sunday, 6 = Saturday
                
                // Weekend surge
                if (day === 0 || day === 6) {
                    if (hour >= 18 && hour <= 23) return 1.8; // Weekend evening
                    if (hour >= 0 && hour <= 3) return 2.0; // Weekend late night
                }
                
                // Weekday surge
                if (hour >= 7 && hour <= 9) return 1.4; // Morning rush
                if (hour >= 16 && hour <= 19) return 1.6; // Evening rush
                if (hour >= 22 || hour <= 5) return 1.8; // Late night
                
                return 1.0; // Normal hours
            },
            
            getTrafficLevel: function() {
                const now = new Date();
                const hour = now.getHours();
                const day = now.getDay();
                
                if (day >= 1 && day <= 5) { // Weekdays
                    if ((hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19)) {
                        return 'heavy';
                    }
                    if (hour >= 10 && hour <= 15) {
                        return 'normal';
                    }
                } else { // Weekends
                    if (hour >= 12 && hour <= 18) {
                        return 'normal';
                    }
                }
                
                return 'light';
            },
            
            calculateShareFare: function(totalFare, splitPercentage, participants = 2) {
                const yourShare = (totalFare * splitPercentage) / 100;
                const othersShare = (totalFare - yourShare) / (participants - 1);
                
                return {
                    yourShare: Math.round(yourShare * 100) / 100,
                    othersShare: Math.round(othersShare * 100) / 100,
                    total: totalFare
                };
            },
            
            formatCurrency: function(amount) {
                return `ZMW ${amount.toFixed(2)}`;
            }
        };

        // ============================================
        // ENHANCED UI UPDATER
        // ============================================
        const UIUpdater = {
            updateWalletBalance: function(balance) {
                const formatted = `ZMW ${balance.toFixed(2)}`;
                document.getElementById('walletBalance').textContent = formatted;
                document.getElementById('accountBalance').textContent = formatted;
                document.getElementById('paymentBalance').textContent = formatted;
                document.getElementById('transferBalance').textContent = formatted;
                AppState.walletBalance = balance;
            },
            
            updateUserName: function(name) {
                document.getElementById('userName').textContent = name;
            },
            
            showToast: function(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.id = toastId;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="UIUpdater.removeToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Auto-remove after duration
                setTimeout(() => {
                    this.removeToast(toastId);
                }, duration);
                
                return toastId;
            },
            
            removeToast: function(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            },
            
            showLoading: function(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                text.textContent = message;
                overlay.classList.add('active');
            },
            
            hideLoading: function() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            },
            
            showSearchLoading: function(show) {
                const loadingOverlays = document.querySelectorAll('.search-loading-overlay');
                loadingOverlays.forEach(overlay => {
                    overlay.classList.toggle('active', show);
                });
            },
            
            updateRidePrices: function(distanceKm) {
                const types = ['economy', 'standard', 'premium'];
                const surge = PriceCalculator.getSurgeMultiplier();
                
                types.forEach(type => {
                    const price = PriceCalculator.calculateRideFare(distanceKm, type, surge);
                    const element = document.getElementById(`${type}Price`);
                    if (element) {
                        element.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                    
                    // Update other forms if they exist
                    const scheduleElement = document.getElementById(`schedule${type.charAt(0).toUpperCase() + type.slice(1)}Price`);
                    if (scheduleElement) {
                        scheduleElement.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                    
                    const someoneElement = document.getElementById(`someone${type.charAt(0).toUpperCase() + type.slice(1)}Price`);
                    if (someoneElement) {
                        someoneElement.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                    
                    const shareElement = document.getElementById(`share${type.charAt(0).toUpperCase() + type.slice(1)}Price`);
                    if (shareElement) {
                        shareElement.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                    
                    const broadcastElement = document.getElementById(`broadcast${type.charAt(0).toUpperCase() + type.slice(1)}Price`);
                    if (broadcastElement) {
                        broadcastElement.textContent = `ZMW ${price.toFixed(2)}`;
                    }
                });
                
                // Update estimated fare display
                const selectedPrice = PriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                document.getElementById('estimatedFare').textContent = `ZMW ${selectedPrice.toFixed(2)}`;
                
                // Update distance and time
                const traffic = PriceCalculator.getTrafficLevel();
                const time = PriceCalculator.estimateTime(distanceKm, AppState.selectedRideType, traffic);
                document.getElementById('distanceDetail').textContent = `${distanceKm.toFixed(1)} km`;
                document.getElementById('timeDetail').textContent = `ETA: ${time} min (${traffic} traffic)`;
                
                AppState.rideFare = selectedPrice;
            },
            
            updateDeliveryPrices: function(distanceKm, deliveryType = 'standard', parcelValue = 0, weight = 0) {
                const fare = PriceCalculator.calculateDeliveryFare(distanceKm, deliveryType, parcelValue, weight);
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                // Update UI elements
                const fareElement = document.getElementById('deliveryFareAmount');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                }
                
                const distanceElement = document.getElementById('deliveryDistanceDetail');
                if (distanceElement) {
                    distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                }
                
                const timeElement = document.getElementById('deliveryTimeDetail');
                if (timeElement) {
                    timeElement.textContent = `ETA: ${time} min`;
                }
                
                return { fare, time };
            },
            
            updateTruckPrices: function(distanceKm, truckType = 'light', helpers = false, weight = 0) {
                const fare = PriceCalculator.calculateTruckFare(distanceKm, truckType, helpers, weight);
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                // Update UI elements
                const fareElement = document.getElementById('truckFareAmount');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                }
                
                const distanceElement = document.getElementById('truckDistanceDetail');
                if (distanceElement) {
                    distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                }
                
                const timeElement = document.getElementById('truckTimeDetail');
                if (timeElement) {
                    timeElement.textContent = `ETA: ${time} min`;
                }
                
                return { fare, time };
            },
            
            updateShoppingPrices: function(distanceKm, itemsCount = 1, budget = 0, shopType = 'general') {
                const fare = PriceCalculator.calculateShoppingFare(distanceKm, itemsCount, budget, shopType);
                const time = PriceCalculator.estimateTime(distanceKm, 'standard') + 30; // Add shopping time
                
                // Update UI elements
                const fareElement = document.getElementById('shoppingFareAmount');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                }
                
                const distanceElement = document.getElementById('shoppingDistanceDetail');
                if (distanceElement) {
                    distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                }
                
                const timeElement = document.getElementById('shoppingTimeDetail');
                if (timeElement) {
                    timeElement.textContent = `ETA: ${time} min`;
                }
                
                return { fare, time };
            },
            
            updateShortDeliveryPrices: function(distanceKm) {
                const fare = Math.max(15, distanceKm * 2.5);
                const time = PriceCalculator.estimateTime(distanceKm, 'standard');
                
                // Update UI elements
                const fareElement = document.getElementById('shortDeliveryFareAmount');
                if (fareElement) {
                    fareElement.textContent = `ZMW ${fare.toFixed(2)}`;
                }
                
                const distanceElement = document.getElementById('shortDeliveryDistanceDetail');
                if (distanceElement) {
                    distanceElement.textContent = `${distanceKm.toFixed(1)} km`;
                }
                
                const timeElement = document.getElementById('shortDeliveryTimeDetail');
                if (timeElement) {
                    timeElement.textContent = `ETA: ${time} min`;
                }
                
                return { fare, time };
            },
            
            showRideInfo: function(ride) {
                // Hide all forms
                document.querySelectorAll('.ride-request-form, .service-form').forEach(form => {
                    form.style.display = 'none';
                });
                
                document.getElementById('rideInfoPanel').classList.add('active');
                
                // Update ride details
                document.getElementById('currentPickup').textContent = ride.pickupDisplay || ride.pickup;
                document.getElementById('currentDestination').textContent = ride.destinationDisplay || ride.destination;
                
                // Calculate and display fare breakdown
                const distance = ride.distance || 0;
                let baseFare, distanceFare, total;
                
                if (ride.serviceType === 'truck') {
                    const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                } else if (ride.serviceType === 'delivery') {
                    const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                    baseFare = config.base;
                    distanceFare = distance * config.perKm;
                    total = ride.fare || baseFare + distanceFare;
                } else if (ride.serviceType === 'shopping') {
                    baseFare = 30;
                    distanceFare = distance * 2.5;
                    total = ride.fare || baseFare + distanceFare;
                } else {
                    baseFare = AppState.rideTypes[ride.rideType]?.base || 20;
                    distanceFare = distance * (AppState.rideTypes[ride.rideType]?.perKm || 3);
                    total = ride.fare || baseFare + distanceFare;
                }
                
                document.getElementById('baseFareValue').textContent = `ZMW ${baseFare.toFixed(2)}`;
                document.getElementById('distanceFareValue').textContent = `ZMW ${distanceFare.toFixed(2)}`;
                
                if (ride.serviceType) {
                    document.getElementById('rideTypeValue').textContent = 
                        ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1);
                } else {
                    document.getElementById('rideTypeValue').textContent = 
                        ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1);
                }
                
                document.getElementById('totalFareValue').textContent = `ZMW ${total.toFixed(2)}`;
                
                // Show ride status bar
                this.updateRideStatus(ride.status);
            },
            
            updateRideStatus: function(status) {
                const statusBar = document.getElementById('rideStatusBar');
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                const etaText = document.getElementById('etaText');
                
                statusBar.classList.add('active');
                
                switch(status) {
                    case 'requested':
                        statusDot.className = 'status-dot searching';
                        statusText.textContent = 'Searching for driver';
                        etaText.textContent = '5-10 min';
                        break;
                    case 'accepted':
                        statusDot.className = 'status-dot arriving';
                        statusText.textContent = 'Driver on the way';
                        etaText.textContent = '5 min';
                        break;
                    case 'arrived':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Driver arrived';
                        etaText.textContent = '0 min';
                        break;
                    case 'started':
                        statusDot.className = 'status-dot riding';
                        statusText.textContent = 'Trip in progress';
                        etaText.textContent = 'En route';
                        break;
                    case 'completed':
                        statusBar.classList.remove('active');
                        break;
                }
            },
            
            updateTimeline: function(status) {
                const steps = ['stepRequested', 'stepAccepted', 'stepArrived', 'stepStarted', 'stepCompleted'];
                const stepLabels = ['Requested', 'Accepted', 'Arrived', 'Started', 'Completed'];
                const currentIndex = stepLabels.indexOf(status);
                
                steps.forEach((stepId, index) => {
                    const step = document.getElementById(stepId);
                    const label = step.parentNode.querySelector('.step-label');
                    
                    if (index < currentIndex) {
                        step.className = 'step-dot completed';
                        label.className = 'step-label';
                    } else if (index === currentIndex) {
                        step.className = 'step-dot active';
                        label.className = 'step-label active';
                    } else {
                        step.className = 'step-dot';
                        label.className = 'step-label';
                    }
                });
            },
            
            showSearchResults: function(inputId, results, isRecent = false) {
                const container = document.getElementById(`${inputId}SearchResults`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <div>No results found</div>
                            <div style="font-size: 11px; margin-top: 5px; color: var(--text-light);">
                                Try a different search term
                            </div>
                        </div>
                    `;
                } else {
                    results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.dataset.resultId = result.id;
                        item.dataset.lat = result.lat;
                        item.dataset.lng = result.lng;
                        item.dataset.address = result.address;
                        item.dataset.name = result.name;
                        
                        const distanceText = result.distance ? 
                            `${result.distance.toFixed(1)} km away` : 
                            'Location';
                        
                        const categoryText = result.category && result.category !== 'other' ? 
                            `<span class="search-result-category">${AppState.searchCategories[result.category] || result.category}</span>` : '';
                        
                        item.innerHTML = `
                            <div class="search-result-icon">
                                <i class="${result.icon || 'fas fa-map-marker-alt'}"></i>
                            </div>
                            <div class="search-result-details">
                                <div class="search-result-name">${result.name}</div>
                                <div class="search-result-address">${result.address}</div>
                                <div class="search-result-distance">
                                    <i class="fas fa-road"></i>
                                    ${distanceText}
                                    ${categoryText}
                                </div>
                                ${result.details && result.details.length > 0 ? `
                                <div style="font-size: 10px; color: var(--text-light); margin-top: 4px;">
                                    ${result.details.join('  ')}
                                </div>
                                ` : ''}
                            </div>
                        `;
                        
                        item.addEventListener('click', () => {
                            this.selectSearchResult(inputId, result, isRecent);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.classList.add('active');
            },
            
            selectSearchResult: function(inputId, result, isRecent = false) {
                const input = document.getElementById(inputId);
                const container = document.getElementById(`${inputId}SearchResults`);
                
                if (input && result) {
                    input.value = result.address;
                    
                    // Add to recent searches if not already recent
                    if (!isRecent) {
                        AppState.addRecentSearch({
                            text: result.name,
                            address: result.address,
                            lat: result.lat,
                            lng: result.lng,
                            type: inputId.includes('pickup') ? 'pickup' : 'destination',
                            timestamp: Date.now()
                        });
                        this.updateRecentSearches();
                    }
                    
                    // Update AppState based on input type
                    if (inputId.includes('destination') || inputId.includes('Destination')) {
                        AppState.destination = {
                            lat: result.lat,
                            lng: result.lng,
                            address: result.address,
                            name: result.name,
                            fullAddress: result.fullAddress
                        };
                        this.updateDestinationMarker(result);
                        this.calculateAndUpdatePrices();
                    } else if (inputId.includes('pickup') || inputId.includes('Pickup')) {
                        AppState.pickup = {
                            lat: result.lat,
                            lng: result.lng,
                            address: result.address,
                            name: result.name,
                            fullAddress: result.fullAddress
                        };
                        this.updatePickupMarker(result);
                    }
                    
                    if (container) {
                        container.classList.remove('active');
                    }
                }
            },
            
            updateRecentSearches: function() {
                const recentSearchesContainer = document.getElementById('recentSearches');
                const recentSearchesList = document.getElementById('recentSearchesList');
                
                if (AppState.recentSearches.length === 0) {
                    recentSearchesContainer.style.display = 'none';
                    return;
                }
                
                recentSearchesContainer.style.display = 'block';
                recentSearchesList.innerHTML = '';
                
                AppState.recentSearches.forEach(search => {
                    const item = document.createElement('div');
                    item.className = 'recent-search-item';
                    item.innerHTML = `
                        <div class="recent-search-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <div class="recent-search-text">${search.text}</div>
                        <div class="recent-search-time">${this.formatTimeAgo(search.timestamp)}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        const result = {
                            id: 'recent-' + search.timestamp,
                            name: search.text,
                            address: search.address,
                            lat: search.lat,
                            lng: search.lng,
                            icon: 'fas fa-history'
                        };
                        
                        this.selectSearchResult(
                            search.type === 'pickup' ? 'pickupLocation' : 'destinationLocation',
                            result,
                            true
                        );
                    });
                    
                    recentSearchesList.appendChild(item);
                });
            },
            
            formatTimeAgo: function(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return 'Over a week ago';
            },
            
            updatePickupMarker: function(location) {
                if (pickupMarker) {
                    pickupMarker.setLatLng([location.lat, location.lng]);
                } else {
                    pickupMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'pickup-marker',
                            html: '<i class="fas fa-map-marker-alt"></i>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map).bindPopup('Pickup Location');
                }
                
                if (AppState.destination) {
                    this.drawRoute(location, AppState.destination);
                }
            },
            
            updateDestinationMarker: function(location) {
                if (destinationMarker) {
                    destinationMarker.setLatLng([location.lat, location.lng]);
                } else {
                    destinationMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'destination-marker',
                            html: '<i class="fas fa-flag"></i>',
                            iconSize: [20, 20]
                        })
                    }).addTo(map).bindPopup('Destination');
                }
                
                if (AppState.pickup) {
                    this.drawRoute(AppState.pickup, location);
                }
            },
            
            drawRoute: function(start, end) {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                
                routeLayer = L.Routing.control({
                    waypoints: [
                        L.latLng(start.lat, start.lng),
                        L.latLng(end.lat, end.lng)
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    lineOptions: {
                        styles: [{color: '#FF6B35', weight: 3, opacity: 0.7}]
                    },
                    createMarker: function() { return null; }
                }).addTo(map);
                
                // Fit bounds to show entire route
                const bounds = L.latLngBounds(
                    [start.lat, start.lng],
                    [end.lat, end.lng]
                );
                map.fitBounds(bounds, { padding: [30, 30] });
            },
            
            calculateAndUpdatePrices: function() {
                if (AppState.pickup && AppState.destination) {
                    const distance = PriceCalculator.calculateDistance(
                        AppState.pickup.lat, AppState.pickup.lng,
                        AppState.destination.lat, AppState.destination.lng
                    );
                    
                    // Update prices based on active service
                    switch(AppState.activeService) {
                        case 'car':
                            this.updateRidePrices(distance);
                            document.getElementById('fareDisplay').classList.add('active');
                            break;
                        case 'delivery':
                            const deliveryFare = this.updateDeliveryPrices(distance);
                            document.getElementById('deliveryFareDisplay').classList.add('active');
                            break;
                        case 'short-delivery':
                            const shortDeliveryFare = this.updateShortDeliveryPrices(distance);
                            document.getElementById('shortDeliveryFareDisplay').classList.add('active');
                            break;
                        case 'truck':
                            const truckFare = this.updateTruckPrices(distance);
                            document.getElementById('truckFareDisplay').classList.add('active');
                            break;
                        case 'express':
                            const shoppingFare = this.updateShoppingPrices(distance);
                            document.getElementById('shoppingFareDisplay').classList.add('active');
                            break;
                    }
                }
            },
            
            showDriverInfo: function(driver) {
                const avatar = document.getElementById('driverAvatar');
                const name = document.getElementById('driverName');
                const rating = document.getElementById('driverRating');
                const vehicle = document.getElementById('vehicleDetails');
                const vehicleImage = document.getElementById('vehicleImage');
                const chatAvatar = document.getElementById('chatDriverAvatar');
                
                // Update driver avatar
                if (driver.photoUrl) {
                    avatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}">`;
                    if (chatAvatar) {
                        chatAvatar.innerHTML = `<img src="${driver.photoUrl}" alt="${driver.name}">`;
                    }
                } else {
                    avatar.innerHTML = `<i class="fas fa-user"></i>`;
                    if (chatAvatar) {
                        chatAvatar.innerHTML = `<i class="fas fa-user"></i>`;
                    }
                }
                
                // Update vehicle image
                if (driver.vehicle?.photoUrl) {
                    vehicleImage.innerHTML = `<img src="${driver.vehicle.photoUrl}" alt="${driver.vehicle.model}">`;
                } else {
                    vehicleImage.innerHTML = `<i class="fas fa-car"></i>`;
                }
                
                name.textContent = driver.name || 'Driver';
                rating.textContent = driver.rating?.toFixed(1) || '4.8';
                vehicle.textContent = `${driver.vehicle?.model || 'Car'} - ${driver.vehicle?.plate || 'ABC 123'}`;
                
                // Add driver marker to map
                if (driver.location) {
                    this.updateDriverMarker(driver.location);
                }
            },
            
            updateDriverMarker: function(location) {
                if (driverMarker) {
                    driverMarker.setLatLng([location.lat, location.lng]);
                } else {
                    driverMarker = L.marker([location.lat, location.lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<i class="fas fa-car"></i>',
                            iconSize: [32, 32]
                        })
                    }).addTo(map).bindPopup('Your Driver');
                }
            },
            
            showChatMessage: function(message, isSender = false) {
                const container = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                
                messageDiv.className = `message ${isSender ? 'sent' : 'received'}`;
                
                let statusIcon = '';
                if (isSender) {
                    if (message.status === 'delivered') {
                        statusIcon = '<i class="fas fa-check-double" style="font-size: 9px;"></i>';
                    } else if (message.status === 'read') {
                        statusIcon = '<i class="fas fa-check-double" style="font-size: 9px; color: #4CAF50;"></i>';
                    } else {
                        statusIcon = '<i class="fas fa-check" style="font-size: 9px;"></i>';
                    }
                }
                
                messageDiv.innerHTML = `
                    <div>${message.text}</div>
                    <div class="message-time">
                        ${new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        ${isSender ? `<span class="message-status">${statusIcon}</span>` : ''}
                    </div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                
                // Show chat notification if not open
                if (!isSender && !document.getElementById('chatContainer').classList.contains('active')) {
                    this.showChatNotification();
                }
            },
            
            showChatNotification: function() {
                const chatBtn = document.getElementById('openChatBtn');
                if (chatBtn) {
                    let badge = chatBtn.querySelector('.chat-notification');
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'chat-notification';
                        chatBtn.appendChild(badge);
                    }
                    const currentCount = parseInt(badge.textContent) || 0;
                    badge.textContent = currentCount + 1;
                }
            },
            
            clearChatNotification: function() {
                const chatBtn = document.getElementById('openChatBtn');
                if (chatBtn) {
                    const badge = chatBtn.querySelector('.chat-notification');
                    if (badge) {
                        badge.remove();
                    }
                }
            },
            
            updateHistoryList: function(rides) {
                const container = document.getElementById('historyList');
                container.innerHTML = '';
                
                if (rides.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-title">No rides found</div>
                            <div class="empty-message">${AppState.activeFilters.history === 'all' ? 'You haven\'t taken any rides yet' : 'No rides match your filter'}</div>
                        </div>
                    `;
                    return;
                }
                
                rides.forEach(ride => {
                    const item = this.createHistoryItem(ride);
                    container.appendChild(item);
                });
            },
            
            createHistoryItem: function(ride) {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.dataset.rideId = ride.id;
                
                const date = new Date(ride.timestamp);
                let typeIcon, typeColor, typeName;
                
                if (ride.emergency) {
                    typeIcon = 'fa-ambulance';
                    typeColor = 'var(--error-red)';
                    typeName = 'Emergency Ride';
                } else if (ride.scheduled) {
                    typeIcon = 'fa-calendar-alt';
                    typeColor = 'var(--info-blue)';
                    typeName = 'Scheduled Ride';
                } else if (ride.serviceType === 'delivery') {
                    typeIcon = 'fa-shipping-fast';
                    typeColor = 'var(--delivery-purple)';
                    typeName = 'Delivery';
                } else if (ride.serviceType === 'truck') {
                    typeIcon = 'fa-truck';
                    typeColor = 'var(--light-truck-brown)';
                    typeName = 'Truck Delivery';
                } else if (ride.serviceType === 'shopping') {
                    typeIcon = 'fa-shopping-bag';
                    typeColor = 'var(--express-shop-green)';
                    typeName = 'Express Shopping';
                } else if (ride.sharedRide) {
                    typeIcon = 'fa-share-alt';
                    typeColor = 'var(--broadcast-blue)';
                    typeName = 'Shared Ride';
                } else if (ride.broadcast) {
                    typeIcon = 'fa-broadcast-tower';
                    typeColor = 'var(--broadcast-blue)';
                    typeName = 'Broadcast Ride';
                } else {
                    typeIcon = 'fa-car';
                    typeColor = 'var(--primary-orange)';
                    typeName = 'Standard Ride';
                }
                
                const statusClass = ride.status === 'completed' ? 'status-completed' :
                                 ride.status === 'cancelled' ? 'status-cancelled' :
                                 'status-ongoing';
                
                item.innerHTML = `
                    <div class="history-header">
                        <div class="history-type">
                            <div class="history-icon" style="background: ${typeColor}">
                                <i class="fas ${typeIcon}"></i>
                            </div>
                            <div class="history-type-name">
                                ${typeName}
                            </div>
                        </div>
                        <div class="history-date">
                            ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    </div>
                    
                    <div class="history-locations">
                        <div class="history-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <div class="history-location-text">${ride.pickupDisplay || ride.pickup}</div>
                        </div>
                        <div class="history-location">
                            <i class="fas fa-flag"></i>
                            <div class="history-location-text">${ride.destinationDisplay || ride.destination}</div>
                        </div>
                    </div>
                    
                    <div class="history-footer">
                        <div class="history-price">ZMW ${ride.fare?.toFixed(2) || '0.00'}</div>
                        <div class="history-status ${statusClass}">
                            ${ride.status.charAt(0).toUpperCase() + ride.status.slice(1)}
                        </div>
                    </div>
                    
                    <div class="history-details">
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-info-circle"></i>
                                Ride Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Distance</div>
                                    <div class="detail-value">${ride.distance?.toFixed(1) || '0'} km</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Ride Type</div>
                                    <div class="detail-value">${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1) || 'Standard'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Payment</div>
                                    <div class="detail-value">${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1) || 'Wallet'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Driver</div>
                                    <div class="detail-value">${ride.driverName || 'Not assigned'}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${ride.emergency ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Emergency Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Service Type</div>
                                    <div class="detail-value">${ride.emergencyType?.charAt(0).toUpperCase() + ride.emergencyType?.slice(1)}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Priority</div>
                                    <div class="detail-value">${ride.priority || 'High'}</div>
                                </div>
                                ${ride.emergencyDescription ? `
                                <div class="detail-item" style="grid-column: span 2;">
                                    <div class="detail-label">Description</div>
                                    <div class="detail-value">${ride.emergencyDescription}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ride.serviceType === 'delivery' ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-box"></i>
                                Delivery Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Parcel</div>
                                    <div class="detail-value">${ride.parcelDescription || 'Not specified'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Receiver</div>
                                    <div class="detail-value">${ride.receiverName || 'Not specified'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Parcel Value</div>
                                    <div class="detail-value">ZMW ${ride.parcelValue?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Delivery Type</div>
                                    <div class="detail-value">${ride.deliveryType?.charAt(0).toUpperCase() + ride.deliveryType?.slice(1) || 'Standard'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ride.sharedRide ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-share-alt"></i>
                                Sharing Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Shared With</div>
                                    <div class="detail-value">${ride.friendName || ride.friendReferralCode || 'Friend'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Your Share</div>
                                    <div class="detail-value">ZMW ${ride.yourShare?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Friend's Share</div>
                                    <div class="detail-value">ZMW ${ride.friendShare?.toFixed(2) || '0.00'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${ride.broadcast ? `
                        <div class="detail-section">
                            <div class="detail-title">
                                <i class="fas fa-broadcast-tower"></i>
                                Broadcast Details
                            </div>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Recipients</div>
                                    <div class="detail-value">${ride.recipients?.length || 1} person(s)</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Tracking Enabled</div>
                                    <div class="detail-value">${ride.allowTracking ? 'Yes' : 'No'}</div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Add click event to expand/collapse details
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.history-details')) {
                        item.classList.toggle('expanded');
                    }
                });
                
                return item;
            },
            
            updateShareRideCalculations: function(distanceKm, splitPercentage = 50, participants = 2) {
                const surge = PriceCalculator.getSurgeMultiplier();
                const totalFare = PriceCalculator.calculateRideFare(distanceKm, AppState.selectedRideType, surge);
                const share = PriceCalculator.calculateShareFare(totalFare, splitPercentage, participants);
                
                document.getElementById('shareFareEstimate').textContent = `ZMW ${totalFare.toFixed(2)}`;
                document.getElementById('yourShare').textContent = `ZMW ${share.yourShare.toFixed(2)}`;
                document.getElementById('friendShare').textContent = `ZMW ${share.othersShare.toFixed(2)}`;
                
                return share;
            },
            
            updateEmergencyServicesList: function(services) {
                const container = document.getElementById('emergencyServicesList');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (services.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px 0;">
                            <div class="empty-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="empty-title">No emergency services found nearby</div>
                            <div class="empty-message">Please try again or contact emergency services directly</div>
                        </div>
                    `;
                    return;
                }
                
                services.forEach((service, index) => {
                    const item = document.createElement('div');
                    item.className = 'emergency-service-item';
                    item.dataset.serviceIndex = index;
                    item.dataset.lat = service.lat;
                    item.dataset.lng = service.lng;
                    
                    let icon = 'fa-shield-alt';
                    if (service.type === 'fire') icon = 'fa-fire-extinguisher';
                    if (service.type === 'medical') icon = 'fa-ambulance';
                    
                    item.innerHTML = `
                        <div class="service-item-header">
                            <div class="service-item-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="service-item-details">
                                <div class="service-item-name">${service.name}</div>
                                <div class="service-item-distance">${service.distance?.toFixed(1) || '0'} km away  ${service.responseTime || '5-10 min'} response</div>
                            </div>
                        </div>
                        <div class="service-item-address">${service.address}</div>
                        ${service.phone ? `<div style="font-size: 11px; color: var(--info-blue); margin-top: 4px;"><i class="fas fa-phone"></i> ${service.phone}</div>` : ''}
                    `;
                    
                    item.addEventListener('click', () => {
                        // Remove selected class from all items
                        container.querySelectorAll('.emergency-service-item').forEach(i => {
                            i.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked item
                        item.classList.add('selected');
                        
                        // Update fare calculation
                        const fare = PriceCalculator.calculateEmergencyFare(
                            service.distance,
                            service.serviceType,
                            service.priority
                        );
                        
                        document.getElementById('emergencyDistance').textContent = `${service.distance?.toFixed(1) || '0'} km`;
                        document.getElementById('emergencyTotalFare').textContent = `ZMW ${fare.toFixed(2)}`;
                    });
                    
                    container.appendChild(item);
                });
            },
            
            updateEmergencyLocationDetails: function(location) {
                const container = document.getElementById('emergencyLocationDetails');
                if (!container) return;
                
                // Show detailed location information
                container.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                        <i class="fas fa-map-marker-alt" style="color: var(--error-red); margin-top: 2px;"></i>
                        <div>
                            <div style="font-weight: 600; color: var(--dark-gray);">Your Current Location</div>
                            <div style="font-size: 11px; color: var(--text-gray); margin-top: 2px;">
                                ${location.address || 'Location details loading...'}
                            </div>
                            <div style="font-size: 10px; color: var(--text-light); margin-top: 4px;">
                                <i class="fas fa-satellite"></i> GPS Coordinates: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}
                            </div>
                        </div>
                    </div>
                `;
            },
            
            updateNotifications: function(notifications) {
                const container = document.getElementById('notificationsList');
                if (!container) return;
                
                if (notifications.length === 0) {
                    container.innerHTML = `
                        <div class="empty-notifications">
                            <i class="fas fa-bell-slash" style="font-size: 32px; opacity: 0.3;"></i>
                            <div style="margin-top: 10px; font-size: 13px;">No notifications yet</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                notifications.forEach(notification => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    item.dataset.notificationId = notification.id;
                    
                    let iconClass = 'ride';
                    let icon = 'fa-car';
                    
                    if (notification.type === 'wallet') {
                        iconClass = 'wallet';
                        icon = 'fa-wallet';
                    } else if (notification.type === 'promotion') {
                        iconClass = 'promotion';
                        icon = 'fa-gift';
                    } else if (notification.type === 'emergency') {
                        iconClass = 'emergency';
                        icon = 'fa-exclamation-triangle';
                    } else if (notification.type === 'broadcast') {
                        iconClass = 'ride';
                        icon = 'fa-broadcast-tower';
                    }
                    
                    item.innerHTML = `
                        <div class="notification-icon ${iconClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">
                                ${notification.title}
                                ${!notification.read ? '<span class="notification-badge"></span>' : ''}
                            </div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${this.formatTimeAgo(notification.timestamp)}</div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.handleNotificationClick(notification);
                    });
                    
                    container.appendChild(item);
                });
            },
            
            handleNotificationClick: function(notification) {
                // Mark as read
                if (!notification.read) {
                    FirebaseManager.markNotificationAsRead(notification.id);
                }
                
                // Handle different notification types
                switch(notification.type) {
                    case 'ride':
                        if (notification.rideId) {
                            // Show ride details
                            FirebaseManager.loadRideDetails(notification.rideId);
                        }
                        break;
                    case 'wallet':
                        // Switch to account screen
                        switchScreen('account');
                        break;
                    case 'promotion':
                        // Show promotions modal
                        showModal('promotions');
                        break;
                    case 'broadcast':
                        if (notification.rideId) {
                            // Show broadcast ride details
                            FirebaseManager.loadRideDetails(notification.rideId);
                        }
                        break;
                }
                
                // Close notifications panel
                document.getElementById('notificationsPanel').classList.remove('active');
            },
            
            updatePromotions: function(promotions) {
                const container = document.getElementById('promotionsList');
                if (!container) return;
                
                if (promotions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 30px 0;">
                            <div class="empty-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <div class="empty-title">No active promotions</div>
                            <div class="empty-message">Check back later for exciting offers!</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                promotions.forEach(promotion => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.style.borderLeft = `4px solid ${promotion.color || 'var(--primary-orange)'}`;
                    
                    item.innerHTML = `
                        <div class="history-header">
                            <div class="history-type">
                                <div class="history-icon" style="background: ${promotion.color || 'var(--primary-orange)'}">
                                    <i class="fas fa-gift"></i>
                                </div>
                                <div class="history-type-name">
                                    ${promotion.title}
                                </div>
                            </div>
                            <div class="history-date">
                                ${new Date(promotion.expiry).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div style="padding: 10px 0;">
                            <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">
                                ${promotion.description}
                            </div>
                            
                            ${promotion.code ? `
                            <div style="background: var(--light-orange); padding: 8px; border-radius: var(--element-radius); margin: 8px 0;">
                                <div style="font-size: 11px; color: var(--text-light);">Promo Code:</div>
                                <div style="font-family: monospace; font-size: 14px; font-weight: 700; color: var(--primary-orange);">
                                    ${promotion.code}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${promotion.terms ? `
                            <div style="font-size: 10px; color: var(--text-light); margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> ${promotion.terms}
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="history-footer">
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 11px;" onclick="applyPromotion('${promotion.code || ''}')">
                                <i class="fas fa-check"></i> Apply Offer
                            </button>
                            <div style="font-size: 10px; color: var(--text-light);">
                                Expires: ${new Date(promotion.expiry).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(item);
                });
            }
        };

        // ============================================
        // ENHANCED FIREBASE MANAGER
        // ============================================
        const FirebaseManager = {
            async loadUserData(uid) {
                try {
                    const snapshot = await database.ref(`users/${uid}`).once('value');
                    AppState.userData = snapshot.val();
                    
                    if (AppState.userData) {
                        AppState.walletBalance = AppState.userData.walletBalance || 0;
                        UIUpdater.updateWalletBalance(AppState.walletBalance);
                        UIUpdater.updateUserName(AppState.userData.name || 'User');
                        
                        // Update account info
                        document.getElementById('accountName').textContent = AppState.userData.name || 'User';
                        document.getElementById('accountPhone').textContent = AppState.userData.phone || 'Not set';
                        document.getElementById('referralCode').textContent = AppState.userData.referralCode || 'JUBEL-XXXX';
                        
                        // Load SOS config
                        await this.loadSOSConfig(uid);
                        
                        // Load scheduled rides
                        await this.loadScheduledRides(uid);
                        
                        // Check for active ride
                        await this.checkActiveRide(uid);
                        
                        // Load ride history
                        await this.loadRideHistory(uid);
                        
                        // Load notifications
                        await this.loadNotifications(uid);
                        
                        // Load promotions
                        await this.loadPromotions();
                        
                        // Set up real-time listeners
                        this.setupRealtimeListeners(uid);
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error loading user data:', error);
                    UIUpdater.showToast('Error loading user data', 'error');
                    return false;
                }
            },
            
            setupRealtimeListeners: function(uid) {
                // Listen for wallet balance changes
                database.ref(`users/${uid}/walletBalance`).on('value', (snapshot) => {
                    const balance = snapshot.val() || 0;
                    AppState.walletBalance = balance;
                    UIUpdater.updateWalletBalance(balance);
                });
                
                // Listen for ride updates
                database.ref('rides').orderByChild('passengerId').equalTo(uid).on('child_changed', (snapshot) => {
                    const ride = snapshot.val();
                    const rideId = snapshot.key;
                    
                    if (ride && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started')) {
                        AppState.currentRide = { id: rideId, ...ride };
                        UIUpdater.showRideInfo(ride);
                        UIUpdater.updateTimeline(ride.status);
                        
                        // Show SOS button when driver accepted
                        if (ride.status === 'accepted' && AppState.sosConfig) {
                            document.getElementById('sosButton').style.display = 'flex';
                        }
                        
                        // Load driver info if assigned
                        if (ride.driverId && !AppState.selectedVehicle) {
                            this.loadDriverInfo(ride.driverId);
                        }
                    }
                });
                
                // Listen for new notifications
                database.ref(`notifications/${uid}`).orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
                    this.loadNotifications(uid);
                });
                
                // Listen for chat messages
                if (AppState.currentRide?.id) {
                    this.listenToChatMessages(AppState.currentRide.id);
                }
            },
            
            async loadSOSConfig(uid) {
                try {
                    const snapshot = await database.ref(`sosConfig/${uid}`).once('value');
                    AppState.sosConfig = snapshot.val();
                    
                    if (AppState.sosConfig) {
                        document.getElementById('sosButton').style.display = 'flex';
                        
                        // Populate SOS modal fields
                        document.getElementById('sosContact1Name').value = AppState.sosConfig.contact1Name || '';
                        document.getElementById('sosContact1Phone').value = AppState.sosConfig.contact1Phone || '';
                        document.getElementById('sosContact2Name').value = AppState.sosConfig.contact2Name || '';
                        document.getElementById('sosContact2Phone').value = AppState.sosConfig.contact2Phone || '';
                        document.getElementById('sosMessage').value = AppState.sosConfig.message || '';
                        document.getElementById('autoSOS').checked = AppState.sosConfig.autoSOS || true;
                        document.getElementById('shareLocation').checked = AppState.sosConfig.shareLocation || true;
                        document.getElementById('shareDriverInfo').checked = AppState.sosConfig.shareDriverInfo || true;
                    }
                } catch (error) {
                    console.error('Error loading SOS config:', error);
                }
            },
            
            async loadScheduledRides(uid) {
                try {
                    const snapshot = await database.ref('scheduledRides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        AppState.scheduledRides = Object.values(rides).filter(ride => 
                            ride.status === 'scheduled' || ride.status === 'upcoming'
                        );
                    }
                } catch (error) {
                    console.error('Error loading scheduled rides:', error);
                }
            },
            
            async checkActiveRide(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .orderByChild('status')
                        .startAt('requested')
                        .endAt('started')
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const rideId = Object.keys(rides)[0];
                        AppState.currentRide = { id: rideId, ...rides[rideId] };
                        UIUpdater.showRideInfo(AppState.currentRide);
                        UIUpdater.updateTimeline(AppState.currentRide.status);
                        
                        // Listen for ride updates
                        this.listenToRideUpdates(rideId);
                        
                        // If driver assigned, listen to driver location
                        if (AppState.currentRide.driverId) {
                            this.listenToDriverLocation(AppState.currentRide.driverId);
                        }
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error checking active ride:', error);
                    return false;
                }
            },
            
            async loadRideHistory(uid) {
                try {
                    const snapshot = await database.ref('rides')
                        .orderByChild('passengerId')
                        .equalTo(uid)
                        .once('value');
                    
                    const rides = snapshot.val();
                    if (rides) {
                        const ridesArray = Object.keys(rides).map(id => ({
                            id,
                            ...rides[id]
                        }));
                        
                        // Filter based on active filter
                        const filtered = this.filterRides(ridesArray, AppState.activeFilters.history);
                        
                        // Update UI
                        UIUpdater.updateHistoryList(filtered);
                        
                        // Update stats
                        this.updateUserStats(ridesArray);
                    }
                } catch (error) {
                    console.error('Error loading ride history:', error);
                }
            },
            
            async loadNotifications(uid) {
                try {
                    const snapshot = await database.ref(`notifications/${uid}`)
                        .orderByChild('timestamp')
                        .limitToLast(20)
                        .once('value');
                    
                    const notifications = snapshot.val();
                    if (notifications) {
                        AppState.notifications = Object.values(notifications).reverse();
                        UIUpdater.updateNotifications(AppState.notifications);
                        this.updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            },
            
            async loadPromotions() {
                try {
                    const snapshot = await database.ref('promotions')
                        .orderByChild('active')
                        .equalTo(true)
                        .once('value');
                    
                    const promotions = snapshot.val();
                    if (promotions) {
                        AppState.promotions = Object.values(promotions).filter(p => 
                            new Date(p.expiry) > new Date()
                        );
                    }
                } catch (error) {
                    console.error('Error loading promotions:', error);
                }
            },
            
            updateNotificationBadge() {
                const unreadCount = AppState.notifications.filter(n => !n.read).length;
                document.getElementById('notificationCount').textContent = unreadCount;
            },
            
            async markNotificationAsRead(notificationId) {
                try {
                    await database.ref(`notifications/${AppState.currentUser.uid}/${notificationId}/read`).set(true);
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            },
            
            async markAllNotificationsAsRead() {
                try {
                    const updates = {};
                    AppState.notifications.forEach(notification => {
                        updates[`notifications/${AppState.currentUser.uid}/${notification.id}/read`] = true;
                    });
                    
                    await database.ref().update(updates);
                    UIUpdater.showToast('All notifications marked as read', 'success');
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    UIUpdater.showToast('Error marking notifications as read', 'error');
                }
            },
            
            filterRides(rides, filter) {
                switch(filter) {
                    case 'completed':
                        return rides.filter(ride => ride.status === 'completed');
                    case 'cancelled':
                        return rides.filter(ride => ride.status === 'cancelled');
                    case 'scheduled':
                        return rides.filter(ride => ride.scheduled);
                    case 'emergency':
                        return rides.filter(ride => ride.emergency);
                    case 'delivery':
                        return rides.filter(ride => ride.serviceType === 'delivery');
                    case 'truck':
                        return rides.filter(ride => ride.serviceType === 'truck');
                    case 'shared':
                        return rides.filter(ride => ride.sharedRide || ride.broadcast);
                    default:
                        return rides;
                }
            },
            
            updateUserStats(rides) {
                const completed = rides.filter(ride => ride.status === 'completed').length;
                const cancelled = rides.filter(ride => ride.status === 'cancelled').length;
                const totalSpent = rides
                    .filter(ride => ride.status === 'completed')
                    .reduce((sum, ride) => sum + (ride.fare || 0), 0);
                
                document.getElementById('completedRides').textContent = completed;
                document.getElementById('cancelledRides').textContent = cancelled;
                document.getElementById('totalSpent').textContent = `ZMW ${totalSpent.toFixed(2)}`;
            },
            
            listenToRideUpdates(rideId) {
                database.ref(`rides/${rideId}`).on('value', (snapshot) => {
                    const ride = snapshot.val();
                    if (ride) {
                        AppState.currentRide = { id: rideId, ...ride };
                        UIUpdater.updateRideStatus(ride.status);
                        UIUpdater.updateTimeline(ride.status);
                        
                        // Update driver info if assigned
                        if (ride.driverId && !AppState.selectedVehicle) {
                            this.loadDriverInfo(ride.driverId);
                        }
                        
                        // Show SOS button when driver accepted
                        if (ride.status === 'accepted' && AppState.sosConfig) {
                            document.getElementById('sosButton').style.display = 'flex';
                        }
                        
                        // Handle ride completion
                        if (ride.status === 'completed') {
                            this.handleRideCompletion(ride);
                        }
                    }
                });
            },
            
            async loadDriverInfo(driverId) {
                try {
                    const snapshot = await database.ref(`users/${driverId}`).once('value');
                    const driver = snapshot.val();
                    if (driver) {
                        AppState.selectedVehicle = driver;
                        UIUpdater.showDriverInfo(driver);
                    }
                } catch (error) {
                    console.error('Error loading driver info:', error);
                }
            },
            
            listenToDriverLocation(driverId) {
                database.ref(`driverLocations/${driverId}`).on('value', (snapshot) => {
                    const location = snapshot.val();
                    if (location) {
                        AppState.driverLocation = location;
                        UIUpdater.updateDriverMarker({
                            lat: location.latitude,
                            lng: location.longitude
                        });
                    }
                });
            },
            
            async requestRide(rideData) {
                try {
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    UIUpdater.showRideInfo(ride);
                    UIUpdater.updateTimeline('requested');
                    
                    // Send notification to user
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Ride Requested',
                        'Your ride has been requested. Searching for drivers...',
                        'ride',
                        { rideId }
                    );
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    UIUpdater.showToast('Ride requested successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting ride:', error);
                    UIUpdater.showToast('Error requesting ride', 'error');
                    throw error;
                }
            },
            
            async requestDelivery(deliveryData) {
                try {
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...deliveryData,
                        serviceType: 'delivery',
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    UIUpdater.showRideInfo(ride);
                    UIUpdater.updateTimeline('requested');
                    
                    // Send notification
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Delivery Requested',
                        'Your delivery has been requested. Searching for couriers...',
                        'ride',
                        { rideId }
                    );
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    UIUpdater.showToast('Delivery requested successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting delivery:', error);
                    UIUpdater.showToast('Error requesting delivery', 'error');
                    throw error;
                }
            },
            
            async requestTruck(truckData) {
                try {
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...truckData,
                        serviceType: 'truck',
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    UIUpdater.showRideInfo(ride);
                    UIUpdater.updateTimeline('requested');
                    
                    // Send notification
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Truck Requested',
                        'Your truck has been requested. Searching for available trucks...',
                        'ride',
                        { rideId }
                    );
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    UIUpdater.showToast('Truck requested successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting truck:', error);
                    UIUpdater.showToast('Error requesting truck', 'error');
                    throw error;
                }
            },
            
            async requestShopping(shoppingData) {
                try {
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...shoppingData,
                        serviceType: 'shopping',
                        status: 'requested',
                        timestamp: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    UIUpdater.showRideInfo(ride);
                    UIUpdater.updateTimeline('requested');
                    
                    // Send notification
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Shopping Requested',
                        'Your shopping request has been submitted. Searching for shoppers...',
                        'ride',
                        { rideId }
                    );
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    UIUpdater.showToast('Shopping request submitted', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting shopping:', error);
                    UIUpdater.showToast('Error requesting shopping', 'error');
                    throw error;
                }
            },
            
            async cancelRide(rideId, reason) {
                try {
                    await database.ref(`rides/${rideId}`).update({
                        status: 'cancelled',
                        cancelReason: reason,
                        cancelledAt: Date.now(),
                        updatedAt: Date.now()
                    });
                    
                    // Send notification
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Ride Cancelled',
                        `Your ride has been cancelled. Reason: ${reason}`,
                        'ride',
                        { rideId }
                    );
                    
                    UIUpdater.showToast('Ride cancelled', 'success');
                    return true;
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    UIUpdater.showToast('Error cancelling ride', 'error');
                    return false;
                }
            },
            
            async scheduleRide(rideData) {
                try {
                    const rideId = database.ref().child('scheduledRides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'scheduled',
                        timestamp: Date.now()
                    };
                    
                    await database.ref(`scheduledRides/${rideId}`).set(ride);
                    
                    AppState.scheduledRides.push(ride);
                    
                    // Send notification
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Ride Scheduled',
                        `Your ride is scheduled for ${new Date(ride.scheduledTime).toLocaleString()}`,
                        'ride',
                        { rideId }
                    );
                    
                    UIUpdater.showToast('Ride scheduled successfully', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error scheduling ride:', error);
                    UIUpdater.showToast('Error scheduling ride', 'error');
                    throw error;
                }
            },
            
            async requestEmergencyRide(rideData) {
                try {
                    const rideId = database.ref().child('rides').push().key;
                    const ride = {
                        id: rideId,
                        ...rideData,
                        status: 'requested',
                        emergency: true,
                        priority: 'high',
                        timestamp: Date.now(),
                        updatedAt: Date.now()
                    };
                    
                    await database.ref(`rides/${rideId}`).set(ride);
                    
                    AppState.currentRide = ride;
                    AppState.emergencyMode = true;
                    UIUpdater.showRideInfo(ride);
                    UIUpdater.updateTimeline('requested');
                    
                    // Show emergency status
                    document.getElementById('emergencyStatus').style.display = 'flex';
                    
                    // Send emergency notification to authorities
                    await this.sendEmergencyAlert(ride);
                    
                    // Send notification to user
                    await this.sendNotification(
                        AppState.currentUser.uid,
                        'Emergency Ride Requested',
                        'Emergency services have been alerted. Help is on the way!',
                        'emergency',
                        { rideId }
                    );
                    
                    // Listen for updates
                    this.listenToRideUpdates(rideId);
                    
                    UIUpdater.showToast('Emergency ride requested! Help is on the way.', 'success');
                    return rideId;
                } catch (error) {
                    console.error('Error requesting emergency ride:', error);
                    UIUpdater.showToast('Error requesting emergency ride', 'error');
                    throw error;
                }
            },
            
            async sendEmergencyAlert(ride) {
                try {
                    const alertId = database.ref().child('emergencyAlerts').push().key;
                    await database.ref(`emergencyAlerts/${alertId}`).set({
                        ...ride,
                        alertId,
                        timestamp: Date.now(),
                        status: 'active'
                    });
                } catch (error) {
                    console.error('Error sending emergency alert:', error);
                }
            },
            
            async sendChatMessage(rideId, message, isDriver = false) {
                try {
                    const messageId = database.ref().child(`chats/${rideId}/messages`).push().key;
                    const chatMessage = {
                        id: messageId,
                        text: message,
                        senderId: isDriver ? AppState.currentRide?.driverId : AppState.currentUser.uid,
                        senderName: isDriver ? AppState.selectedVehicle?.name : AppState.userData?.name,
                        timestamp: Date.now(),
                        isDriver: isDriver,
                        status: 'sent'
                    };
                    
                    await database.ref(`chats/${rideId}/messages/${messageId}`).set(chatMessage);
                    
                    // Update message status to delivered after a delay
                    setTimeout(async () => {
                        await database.ref(`chats/${rideId}/messages/${messageId}/status`).set('delivered');
                    }, 1000);
                    
                    return messageId;
                } catch (error) {
                    console.error('Error sending chat message:', error);
                    throw error;
                }
            },
            
            listenToChatMessages(rideId) {
                database.ref(`chats/${rideId}/messages`).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    if (message) {
                        const isSender = message.senderId === AppState.currentUser.uid;
                        UIUpdater.showChatMessage(message, isSender);
                        
                        // Mark as read if received
                        if (!isSender) {
                            setTimeout(() => {
                                database.ref(`chats/${rideId}/messages/${message.id}/status`).set('read');
                            }, 500);
                        }
                    }
                });
            },
            
            async saveSOSConfig(config) {
                try {
                    await database.ref(`sosConfig/${AppState.currentUser.uid}`).set(config);
                    AppState.sosConfig = config;
                    document.getElementById('sosButton').style.display = 'flex';
                    UIUpdater.showToast('SOS configuration saved', 'success');
                    return true;
                } catch (error) {
                    console.error('Error saving SOS config:', error);
                    UIUpdater.showToast('Error saving SOS config', 'error');
                    return false;
                }
            },
            
            async sendSOSAlert(rideId, sosData) {
                try {
                    const alertId = database.ref().child('sosAlerts').push().key;
                    const alertData = {
                        ...sosData,
                        alertId,
                        rideId,
                        timestamp: Date.now(),
                        status: 'active'
                    };
                    
                    await database.ref(`sosAlerts/${alertId}`).set(alertData);
                    
                    // Also send as notification to emergency contacts
                    if (sosData.emergencyContact1) {
                        await this.sendSOSNotification(sosData.emergencyContact1, sosData.emergencyContact1Name, sosData.message, alertData);
                    }
                    if (sosData.emergencyContact2) {
                        await this.sendSOSNotification(sosData.emergencyContact2, sosData.emergencyContact2Name, sosData.message, alertData);
                    }
                    
                    // Send notification to authorities
                    await this.sendEmergencyAlert({
                        ...sosData,
                        type: 'sos',
                        priority: 'highest'
                    });
                    
                    UIUpdater.showToast('SOS alert sent to emergency contacts and authorities', 'success');
                    return true;
                } catch (error) {
                    console.error('Error sending SOS alert:', error);
                    UIUpdater.showToast('Error sending SOS alert', 'error');
                    return false;
                }
            },
            
            async sendSOSNotification(phone, name, message, alertData) {
                try {
                    // Find user by phone number
                    const usersSnapshot = await database.ref('users').orderByChild('phone').equalTo(phone).once('value');
                    const users = usersSnapshot.val();
                    
                    if (users) {
                        const userId = Object.keys(users)[0];
                        await this.sendNotification(
                            userId,
                            ' SOS ALERT ',
                            `${name} needs help! ${message}`,
                            'emergency',
                            { alertId: alertData.alertId, rideId: alertData.rideId }
                        );
                    }
                } catch (error) {
                    console.error('Error sending SOS notification:', error);
                }
            },
            
            async sendNotification(userId, title, message, type = 'info', data = {}) {
                try {
                    const notificationId = database.ref().child(`notifications/${userId}`).push().key;
                    const notification = {
                        id: notificationId,
                        title,
                        message,
                        type,
                        data,
                        read: false,
                        timestamp: Date.now()
                    };
                    
                    await database.ref(`notifications/${userId}/${notificationId}`).set(notification);
                    return true;
                } catch (error) {
                    console.error('Error sending notification:', error);
                    return false;
                }
            },
            
            async transferMoney(recipientCode, amount, message = '') {
                try {
                    // Find recipient by referral code or phone
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let recipientId = null;
                    let recipientName = '';
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === recipientCode || userData.phone === recipientCode) {
                            recipientId = userId;
                            recipientName = userData.name;
                            break;
                        }
                    }
                    
                    if (!recipientId) {
                        throw new Error('Recipient not found');
                    }
                    // Continuing from where you left off...

                    if (AppState.walletBalance < amount) {
                        throw new Error('Insufficient balance');
                    }
                    
                    // Perform transfer
                    const senderNewBalance = AppState.walletBalance - amount;
                    const recipientSnapshot = await database.ref(`users/${recipientId}/walletBalance`).once('value');
                    const recipientBalance = recipientSnapshot.val() || 0;
                    const recipientNewBalance = recipientBalance + amount;
                    
                    // Update balances
                    await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(senderNewBalance);
                    await database.ref(`users/${recipientId}/walletBalance`).set(recipientNewBalance);
                    
                    // Record transactions
                    const transactionId = database.ref().child('transactions').push().key;
                    const transaction = {
                        id: transactionId,
                        senderId: AppState.currentUser.uid,
                        senderName: AppState.userData.name,
                        recipientId,
                        recipientName,
                        amount,
                        message,
                        timestamp: Date.now(),
                        type: 'transfer'
                    };
                    
                    await database.ref(`transactions/${transactionId}`).set(transaction);
                    
                    // Update local balance
                    UIUpdater.updateWalletBalance(senderNewBalance);
                    
                    // Send notification to recipient
                    await this.sendNotification(
                        recipientId,
                        'Money Received',
                        `You received ZMW ${amount.toFixed(2)} from ${AppState.userData.name}`,
                        'success'
                    );
                    
                    UIUpdater.showToast(`ZMW ${amount.toFixed(2)} sent to ${recipientName}`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error transferring money:', error);
                    UIUpdater.showToast(error.message, 'error');
                    return false;
                }
            },
            
            async loadTransactions(userId) {
                try {
                    const snapshot = await database.ref('transactions')
                        .orderByChild('senderId')
                        .equalTo(userId)
                        .once('value');
                    
                    const sentTransactions = snapshot.val() || {};
                    
                    const receivedSnapshot = await database.ref('transactions')
                        .orderByChild('recipientId')
                        .equalTo(userId)
                        .once('value');
                    
                    const receivedTransactions = receivedSnapshot.val() || {};
                    
                    // Combine and sort transactions
                    const allTransactions = [
                        ...Object.values(sentTransactions),
                        ...Object.values(receivedTransactions)
                    ].sort((a, b) => b.timestamp - a.timestamp);
                    
                    return allTransactions;
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    return [];
                }
            },
            
            handleRideCompletion(ride) {
                // Hide ride status bar
                document.getElementById('rideStatusBar').classList.remove('active');
                
                // Hide SOS button
                document.getElementById('sosButton').style.display = 'none';
                
                // Hide emergency status
                document.getElementById('emergencyStatus').style.display = 'none';
                
                // Update timeline to completed
                UIUpdater.updateTimeline('completed');
                
                // Add receipt button
                const actionButtons = document.querySelector('#rideInfoPanel .action-buttons');
                const existingReceiptBtn = document.querySelector('#receiptBtn');
                
                if (!existingReceiptBtn) {
                    const receiptBtn = document.createElement('button');
                    receiptBtn.id = 'receiptBtn';
                    receiptBtn.className = 'btn btn-primary';
                    receiptBtn.innerHTML = '<i class="fas fa-receipt"></i> View Receipt';
                    receiptBtn.addEventListener('click', () => {
                        this.generateReceipt(ride);
                    });
                    
                    actionButtons.appendChild(receiptBtn);
                }
                
                // Update wallet balance if paid with wallet
                if (ride.paymentMethod === 'wallet') {
                    const newBalance = AppState.walletBalance - ride.fare;
                    UIUpdater.updateWalletBalance(newBalance);
                    
                    // Update in database
                    database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                }
                
                // Handle referral reward if applicable
                if (ride.referredBy) {
                    this.handleReferralReward(ride);
                }
                
                // Send completion notification
                this.sendNotification(
                    AppState.currentUser.uid,
                    'Ride Completed',
                    `Your ride has been completed. Fare: ZMW ${ride.fare?.toFixed(2)}`,
                    'ride',
                    { rideId: ride.id }
                );
            },
            
            async handleReferralReward(ride) {
                try {
                    // Find referrer by referral code
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val();
                    let referrerId = null;
                    
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.referralCode === ride.referredBy) {
                            referrerId = userId;
                            break;
                        }
                    }
                    
                    if (referrerId) {
                        // Add ZMW 25 reward to referrer
                        const referrerSnapshot = await database.ref(`users/${referrerId}/walletBalance`).once('value');
                        const referrerBalance = referrerSnapshot.val() || 0;
                        const newReferrerBalance = referrerBalance + 25;
                        
                        await database.ref(`users/${referrerId}/walletBalance`).set(newReferrerBalance);
                        
                        // Record transaction
                        const transactionId = database.ref().child('transactions').push().key;
                        const transaction = {
                            id: transactionId,
                            senderId: 'system',
                            senderName: 'Jubel System',
                            recipientId: referrerId,
                            recipientName: users[referrerId].name,
                            amount: 25,
                            message: `Referral reward from ${AppState.userData.name}`,
                            timestamp: Date.now(),
                            type: 'referral'
                        };
                        
                        await database.ref(`transactions/${transactionId}`).set(transaction);
                        
                        // Send notification to referrer
                        await this.sendNotification(
                            referrerId,
                            'Referral Reward',
                            `You earned ZMW 25.00 because ${AppState.userData.name} used your referral code`,
                            'wallet'
                        );
                    }
                } catch (error) {
                    console.error('Error handling referral reward:', error);
                }
            },
            
            generateReceipt(ride) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add receipt content
                doc.setFontSize(18);
                doc.setTextColor(255, 107, 53);
                doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Receipt No: ${ride.id.substring(0, 8)}`, 20, 40);
                doc.text(`Date: ${new Date(ride.timestamp).toLocaleString()}`, 20, 45);
                
                // Add ride details
                doc.text(`Passenger: ${AppState.userData.name}`, 20, 55);
                doc.text(`Driver: ${ride.driverName || 'Not assigned'}`, 20, 60);
                doc.text(`Pickup: ${ride.pickupDisplay || ride.pickup}`, 20, 65);
                doc.text(`Destination: ${ride.destinationDisplay || ride.destination}`, 20, 70);
                doc.text(`Distance: ${ride.distance?.toFixed(1) || '0'} km`, 20, 75);
                
                if (ride.serviceType) {
                    doc.text(`Service Type: ${ride.serviceType.charAt(0).toUpperCase() + ride.serviceType.slice(1)}`, 20, 80);
                } else {
                    doc.text(`Ride Type: ${ride.rideType?.charAt(0).toUpperCase() + ride.rideType?.slice(1)}`, 20, 80);
                }
                
                // Add fare breakdown
                doc.text('Fare Breakdown:', 20, 90);
                
                let yPos = 95;
                if (ride.serviceType === 'truck') {
                    const config = AppState.truckTypes[ride.truckType] || AppState.truckTypes.light;
                    doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
                } else if (ride.serviceType === 'delivery') {
                    const config = AppState.deliveryTypes[ride.deliveryType] || AppState.deliveryTypes.standard;
                    doc.text(`Base Fare: ZMW ${config.base.toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * config.perKm).toFixed(2)}`, 30, yPos);
                } else {
                    doc.text(`Base Fare: ZMW ${(AppState.rideTypes[ride.rideType]?.base || 20).toFixed(2)}`, 30, yPos);
                    yPos += 5;
                    doc.text(`Distance Fare: ZMW ${((ride.distance || 0) * (AppState.rideTypes[ride.rideType]?.perKm || 3)).toFixed(2)}`, 30, yPos);
                }
                
                yPos += 5;
                doc.text(`Total: ZMW ${ride.fare?.toFixed(2) || '0.00'}`, 30, yPos);
                
                // Add payment method
                yPos += 10;
                doc.text(`Payment Method: ${ride.paymentMethod?.charAt(0).toUpperCase() + ride.paymentMethod?.slice(1)}`, 20, yPos);
                
                // Save PDF
                doc.save(`Jubel_Receipt_${ride.id.substring(0, 8)}.pdf`);
                UIUpdater.showToast('Receipt downloaded', 'success');
            },
            
            async broadcastRide(rideData, recipientPhone, message = '', allowTracking = true) {
                try {
                    // Find recipient by phone
                    const usersSnapshot = await database.ref('users').orderByChild('phone').equalTo(recipientPhone).once('value');
                    const users = usersSnapshot.val();
                    
                    if (!users) {
                        throw new Error('Recipient not found. They need to be a registered Jubel user.');
                    }
                    
                    const recipientId = Object.keys(users)[0];
                    const recipientName = users[recipientId].name;
                    
                    // Create broadcast record
                    const broadcastId = database.ref().child('broadcasts').push().key;
                    const broadcast = {
                        id: broadcastId,
                        rideId: rideData.id,
                        senderId: AppState.currentUser.uid,
                        senderName: AppState.userData.name,
                        recipientId,
                        recipientName,
                        recipientPhone,
                        message,
                        allowTracking,
                        timestamp: Date.now(),
                        status: 'pending'
                    };
                    
                    await database.ref(`broadcasts/${broadcastId}`).set(broadcast);
                    
                    // Send notification to recipient
                    await this.sendNotification(
                        recipientId,
                        'Ride Broadcast',
                        `${AppState.userData.name} has shared a ride with you`,
                        'broadcast',
                        { broadcastId, rideId: rideData.id }
                    );
                    
                    // Update ride to mark as broadcasted
                    await database.ref(`rides/${rideData.id}/broadcasted`).set(true);
                    
                    UIUpdater.showToast(`Ride broadcasted to ${recipientName}`, 'success');
                    return true;
                } catch (error) {
                    console.error('Error broadcasting ride:', error);
                    UIUpdater.showToast(error.message, 'error');
                    return false;
                }
            }
        };

        // ============================================
        // ENHANCED EMERGENCY SERVICE LOCATOR
        // ============================================
        const EmergencyLocator = {
            services: {
                police: [
                    { name: 'Lusaka Central Police', lat: -15.4167, lng: 28.2833, address: 'Cairo Road, Lusaka', phone: '991' },
                    { name: 'Kabulonga Police Station', lat: -15.4000, lng: 28.3000, address: 'Kabulonga, Lusaka', phone: '991' },
                    { name: 'Woodlands Police Station', lat: -15.3900, lng: 28.3200, address: 'Woodlands, Lusaka', phone: '991' }
                ],
                fire: [
                    { name: 'Lusaka Fire Brigade', lat: -15.4100, lng: 28.2900, address: 'Katondo Street, Lusaka', phone: '993' },
                    { name: 'Industrial Fire Station', lat: -15.4200, lng: 28.2700, address: 'Industrial Area, Lusaka', phone: '993' }
                ],
                medical: [
                    { name: 'University Teaching Hospital', lat: -15.4050, lng: 28.2950, address: 'Nationalist Road, Lusaka', phone: '992' },
                    { name: 'Levy Mwanawasa Hospital', lat: -15.3950, lng: 28.3050, address: 'Makeni, Lusaka', phone: '992' },
                    { name: 'Matero Hospital', lat: -15.4150, lng: 28.2750, address: 'Matero, Lusaka', phone: '992' }
                ]
            },
            
            findNearestServices: function(type, userLocation, limit = 3) {
                const services = this.services[type];
                if (!services || !userLocation) return [];
                
                // Calculate distances for all services
                const servicesWithDistance = services.map(service => {
                    const distance = PriceCalculator.calculateDistance(
                        userLocation.lat, userLocation.lng,
                        service.lat, service.lng
                    );
                    
                    return {
                        ...service,
                        distance,
                        serviceType: type,
                        responseTime: this.calculateResponseTime(distance, type)
                    };
                });
                
                // Sort by distance and return top N
                return servicesWithDistance
                    .sort((a, b) => a.distance - b.distance)
                    .slice(0, limit);
            },
            
            calculateResponseTime: function(distanceKm, serviceType) {
                // Base response time + travel time
                const baseTime = serviceType === 'police' ? 3 : serviceType === 'fire' ? 5 : 4;
                const travelTime = (distanceKm / 60) * 60; // Assuming 60km/h average speed
                return Math.ceil(baseTime + travelTime);
            },
            
            showEmergencyMarkers: function(type) {
                // Clear existing emergency markers
                emergencyMarkers.forEach(marker => map.removeLayer(marker));
                emergencyMarkers = [];
                
                // Add markers for all services of this type
                const services = this.services[type];
                if (services) {
                    services.forEach(service => {
                        const marker = L.marker([service.lat, service.lng], {
                            icon: L.divIcon({
                                className: 'emergency-vehicle-marker',
                                html: `<i class="fas fa-${type === 'police' ? 'shield-alt' : type === 'fire' ? 'fire-extinguisher' : 'ambulance'}"></i>`,
                                iconSize: [36, 36]
                            })
                        }).addTo(map).bindPopup(`
                            <strong>${service.name}</strong><br>
                            ${service.address}<br>
                            Phone: ${service.phone}
                        `);
                        
                        emergencyMarkers.push(marker);
                    });
                }
            },
            
            getServiceDetails: function(type) {
                const details = {
                    police: {
                        name: 'Police Service',
                        description: 'Emergency police response and escort',
                        emergencyNumber: '991',
                        responseTime: '3-5 minutes'
                    },
                    fire: {
                        name: 'Fire Brigade',
                        description: 'Fire emergency response team',
                        emergencyNumber: '993',
                        responseTime: '5-7 minutes'
                    },
                    medical: {
                        name: 'Medical Emergency',
                        description: 'Ambulance and medical response',
                        emergencyNumber: '992',
                        responseTime: '4-6 minutes'
                    }
                };
                
                return details[type] || details.police;
            }
        };

        // ============================================
        // ENHANCED VOICE SEARCH
        // ============================================
        const VoiceSearch = {
            recognition: null,
            isListening: false,
            activeInput: null,
            
            init: function() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        if (this.activeInput) {
                            this.activeInput.value = transcript;
                            
                            // Trigger search
                            const event = new Event('input', { bubbles: true });
                            this.activeInput.dispatchEvent(event);
                        }
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Voice recognition error:', event.error);
                        UIUpdater.showToast('Voice recognition error. Please try again.', 'error');
                        this.stopListening();
                    };
                    
                    this.recognition.onend = () => {
                        this.stopListening();
                    };
                }
            },
            
            startListening: function(inputElement) {
                if (!this.recognition) {
                    UIUpdater.showToast('Voice search not supported in this browser', 'warning');
                    return;
                }
                
                try {
                    this.activeInput = inputElement;
                    this.isListening = true;
                    this.recognition.start();
                    
                    // Update UI
                    inputElement.parentElement.classList.add('listening');
                    UIUpdater.showToast('Listening... Speak now', 'info');
                } catch (error) {
                    console.error('Error starting voice recognition:', error);
                    UIUpdater.showToast('Error starting voice search', 'error');
                }
            },
            
            stopListening: function() {
                if (this.recognition && this.isListening) {
                    try {
                        this.recognition.stop();
                    } catch (error) {
                        console.error('Error stopping voice recognition:', error);
                    }
                }
                
                this.isListening = false;
                if (this.activeInput) {
                    this.activeInput.parentElement.classList.remove('listening');
                }
                this.activeInput = null;
            },
            
            toggleListening: function(inputElement) {
                if (this.isListening) {
                    this.stopListening();
                } else {
                    this.startListening(inputElement);
                }
            }
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        async function initializeApp() {
            try {
                // Check authentication
                const urlParams = new URLSearchParams(window.location.search);
                const email = urlParams.get('email');
                const uid = urlParams.get('uid');
                
                if (email && uid) {
                    AppState.currentUser = { uid, email };
                    await FirebaseManager.loadUserData(uid);
                } else {
                    // Listen for auth state changes
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            AppState.currentUser = user;
                            await FirebaseManager.loadUserData(user.uid);
                        } else {
                            window.location.href = 'signup.html';
                        }
                    });
                }
                
                // Initialize map
                initializeMap();
                
                // Initialize voice search
                VoiceSearch.init();
                
                // Set up event listeners
                setupEventListeners();
                
                // Get current location
                getCurrentLocation();
                
                // Set minimum date for schedule form
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('scheduleDate').min = today;
                
                // Initialize shopping items
                initializeShoppingItems();
                
                // Initialize AppState
                AppState.init();
                
                // Update recent searches
                UIUpdater.updateRecentSearches();
                
                UIUpdater.showToast('Jubel Passenger App Ready', 'success');
                
            } catch (error) {
                console.error('Error initializing app:', error);
                UIUpdater.showToast('Error initializing app', 'error');
            }
        }
        
        function initializeMap() {
            map = L.map('map').setView([-15.4167, 28.2833], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }
        
        function initializeShoppingItems() {
            const itemsContainer = document.getElementById('shoppingItems');
            const addItemBtn = document.getElementById('addItemBtn');
            
            // Add first item removal button
            const firstItem = itemsContainer.querySelector('.item-entry');
            if (firstItem) {
                const removeBtn = firstItem.querySelector('.remove-item');
                removeBtn.addEventListener('click', function() {
                    if (itemsContainer.children.length > 1) {
                        firstItem.remove();
                    }
                });
            }
            
            // Add new item
            addItemBtn.addEventListener('click', function() {
                const itemEntry = document.createElement('div');
                itemEntry.className = 'item-entry';
                itemEntry.innerHTML = `
                    <input type="text" class="item-input" placeholder="Item name">
                    <button class="remove-item" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                itemsContainer.appendChild(itemEntry);
                
                // Add event to remove button
                const removeBtn = itemEntry.querySelector('.remove-item');
                removeBtn.addEventListener('click', function() {
                    itemEntry.remove();
                });
            });
        }
        
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        AppState.userLocation = { lat: latitude, lng: longitude };
                        
                        // Center map on user location
                        map.setView([latitude, longitude], 15);
                        
                        // Add current location marker
                        currentLocationMarker = L.marker([latitude, longitude], {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<i class="fas fa-user"></i>',
                                iconSize: [18, 18]
                            })
                        }).addTo(map).bindPopup('Your Location');
                        
                        // Get detailed address
                        getDetailedAddress(latitude, longitude).then(address => {
                            // Update pickup location input
                            document.getElementById('pickupLocation').value = address;
                            document.getElementById('deliveryPickup').value = address;
                            document.getElementById('shortDeliveryPickup').value = address;
                            document.getElementById('truckPickup').value = address;
                            
                            AppState.pickup = {
                                lat: latitude,
                                lng: longitude,
                                address: address,
                                name: 'Current Location',
                                detailed: address
                            };
                            
                            // Update emergency location display if modal is open
                            if (document.getElementById('emergencyModal').classList.contains('active')) {
                                UIUpdater.updateEmergencyLocationDetails(AppState.pickup);
                            }
                        });
                        
                        // Detect city based on location
                        detectCity(latitude, longitude);
                        
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        UIUpdater.showToast('Unable to get your location. Using default location.', 'warning');
                        
                        // Use default location
                        AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
                        AppState.currentCity = 'Lusaka';
                        
                        const defaultAddress = 'Lusaka, Zambia';
                        document.getElementById('pickupLocation').value = defaultAddress;
                        
                        AppState.pickup = {
                            lat: -15.4167,
                            lng: 28.2833,
                            address: defaultAddress,
                            name: 'Lusaka City'
                        };
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                UIUpdater.showToast('Geolocation not supported', 'warning');
                
                // Use default location
                AppState.userLocation = { lat: -15.4167, lng: 28.2833 };
                AppState.currentCity = 'Lusaka';
                
                const defaultAddress = 'Lusaka, Zambia';
                document.getElementById('pickupLocation').value = defaultAddress;
                
                AppState.pickup = {
                    lat: -15.4167,
                    lng: 28.2833,
                    address: defaultAddress,
                    name: 'Lusaka City'
                };
            }
        }
        
        async function getDetailedAddress(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                const data = await response.json();
                
                if (data && data.address) {
                    const address = data.address;
                    const parts = [];
                    
                    // Build detailed address
                    if (address.house_number || address.housenumber) {
                        parts.push(`House No: ${address.house_number || address.housenumber}`);
                    }
                    
                    if (address.road) {
                        parts.push(address.road);
                    }
                    
                    if (address.suburb || address.neighbourhood) {
                        parts.push(address.suburb || address.neighbourhood);
                    }
                    
                    if (address.city_district) {
                        parts.push(address.city_district);
                    }
                    
                    if (address.city || address.town || address.village) {
                        parts.push(address.city || address.town || address.village);
                    }
                    
                    return parts.join(', ') || data.display_name;
                }
                
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                console.error('Reverse geocode error:', error);
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }
        
        async function detectCity(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`
                );
                const data = await response.json();
                
                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village;
                    if (city) {
                        AppState.currentCity = city;
                        AppState.detectedCity = city;
                        AppState.searchEngine.clearCache();
                        
                        // Update UI with city name
                        UIUpdater.showToast(`Location set to ${city}`, 'info');
                    }
                }
            } catch (error) {
                console.error('City detection error:', error);
            }
        }

        // ============================================
        // ENHANCED EVENT HANDLERS
        // ============================================
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const screen = tab.dataset.screen;
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchScreen('home');
                });
            });
            
            // Panel handle
            document.getElementById('panelHandle').addEventListener('click', togglePanel);
            
            // Service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const service = tab.dataset.service;
                    switchService(service);
                });
            });
            
            // Ride type selection (only for car service)
            document.querySelectorAll('.ride-type-card').forEach(card => {
                card.addEventListener('click', () => {
                    // Only update if car service is active
                    if (AppState.activeService === 'car' || 
                        AppState.activeService === 'schedule' ||
                        AppState.activeService === 'someone' ||
                        AppState.activeService === 'share' ||
                        AppState.activeService === 'broadcast') {
                        
                        // Remove selected class from all cards
                        document.querySelectorAll('.ride-type-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked card
                        card.classList.add('selected');
                        
                        // Update selected ride type
                        AppState.selectedRideType = card.dataset.type;
                        
                        // Update prices
                        if (AppState.pickup && AppState.destination) {
                            UIUpdater.calculateAndUpdatePrices();
                        }
                    }
                });
            });
            
            // Truck type selection
            document.querySelectorAll('.truck-type').forEach(truck => {
                truck.addEventListener('click', () => {
                    document.querySelectorAll('.truck-type').forEach(t => {
                        t.classList.remove('selected');
                    });
                    truck.classList.add('selected');
                });
            });
            
            // Delivery type selection
            document.getElementById('standardDelivery').addEventListener('click', () => {
                document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('standardDelivery').classList.add('active');
            });
            
            document.getElementById('expressDelivery').addEventListener('click', () => {
                document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('expressDelivery').classList.add('active');
            });
            
            document.getElementById('sameDayDelivery').addEventListener('click', () => {
                document.querySelectorAll('#deliveryForm .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('sameDayDelivery').classList.add('active');
            });
            
            // Location input focus
            document.querySelectorAll('input[type="text"]').forEach(input => {
                if (input.id.includes('destination') || input.id.includes('Location') || 
                    input.id.includes('Pickup') || input.id.includes('pickup')) {
                    
                    input.addEventListener('focus', function() {
                        const parent = this.closest('.location-input');
                        if (parent) parent.classList.add('active');
                        
                        // Show recent searches for destination inputs
                        if (this.id.includes('destination') || this.id.includes('Destination')) {
                            UIUpdater.updateRecentSearches();
                        }
                    });
                    
                    input.addEventListener('blur', function() {
                        setTimeout(() => {
                            const parent = this.closest('.location-input');
                            if (parent) parent.classList.remove('active');
                        }, 200);
                    });
                }
            });
            
            // Enhanced search input with debounce and smart suggestions
            document.querySelectorAll('.search-input').forEach(input => {
                input.addEventListener('input', function(e) {
                    handleSearchInput(this, e.target.value);
                });
            });
            
            // Voice search buttons
            document.querySelectorAll('.voice-search-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const input = this.parentElement.querySelector('input');
                    if (input) {
                        VoiceSearch.toggleListening(input);
                    }
                });
            });
            
            // Clear recent searches
            document.getElementById('clearRecentSearches').addEventListener('click', () => {
                AppState.clearRecentSearches();
                UIUpdater.updateRecentSearches();
                UIUpdater.showToast('Recent searches cleared', 'success');
            });
            
            // More options button
            document.getElementById('moreOptionsBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('moreOptionsDropdown');
                dropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.more-options-dropdown') && !e.target.closest('#moreOptionsBtn')) {
                    document.getElementById('moreOptionsDropdown').classList.remove('active');
                }
            });
            
            // More options dropdown items
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    const option = item.dataset.option;
                    handleMoreOptionSelection(option);
                    document.getElementById('moreOptionsDropdown').classList.remove('active');
                });
            });
            
            // SOS setup button
            document.getElementById('sosSetupBtn').addEventListener('click', () => {
                showModal('sos');
            });
            
            // Promotions button
            document.getElementById('promotionsBtn').addEventListener('click', () => {
                showModal('promotions');
                loadPromotions();
            });
            
            // Help center button
            document.getElementById('helpCenterBtn').addEventListener('click', () => {
                UIUpdater.showToast('Help center coming soon', 'info');
            });
            
            // Request ride button
            document.getElementById('requestRideBtn').addEventListener('click', async () => {
                if (!AppState.pickup || !AppState.destination) {
                    UIUpdater.showToast('Please select pickup and destination locations', 'warning');
                    return;
                }
                
                // Calculate distance
                const distance = PriceCalculator.calculateDistance(
                    AppState.pickup.lat, AppState.pickup.lng,
                    AppState.destination.lat, AppState.destination.lng
                );
                
                if (distance < 0.5) {
                    UIUpdater.showToast('Minimum ride distance is 0.5 km', 'warning');
                    return;
                }
                
                // Show ride type selection for car service
                document.getElementById('rideTypeSelection').classList.add('active');
                
                // Show payment modal with ride details
                document.getElementById('paymentAmount').textContent = `ZMW ${AppState.rideFare.toFixed(2)}`;
                showModal('payment');
            });
            
            // Enhanced search functionality for all forms
            setupSearchFunctionality();
            
            // Add more event listeners for the remaining buttons and forms...
            setupAdditionalEventListeners();
            
            // Click outside suggestion lists to close them
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.location-input') && !e.target.closest('.search-results-container')) {
                    document.querySelectorAll('.search-results-container').forEach(list => {
                        list.classList.remove('active');
                    });
                }
            });
            
            // Escape key to close modals and dropdowns
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideAllModals();
                    document.getElementById('moreOptionsDropdown').classList.remove('active');
                    document.getElementById('notificationsPanel').classList.remove('active');
                }
            });
        }
        
        function setupSearchFunctionality() {
            // Set up search for all location inputs
            const searchInputs = [
                'destinationLocation', 'pickupLocation',
                'deliveryPickup', 'deliveryDestination',
                'shortDeliveryPickup', 'shortDeliveryDestination',
                'shopName', 'shoppingDestination',
                'truckPickup', 'truckDestination',
                'schedulePickup', 'scheduleDestination',
                'someonePickup', 'someoneDestination',
                'sharePickup', 'shareDestination',
                'broadcastPickup', 'broadcastDestination'
            ];
            
            searchInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', debounce(async (e) => {
                        const query = e.target.value.trim();
                        if (query.length < 2) {
                            const container = document.getElementById(`${inputId}SearchResults`);
                            if (container) container.classList.remove('active');
                            return;
                        }
                        
                        // Show loading
                        const parent = input.closest('.location-input');
                        if (parent) parent.classList.add('searching');
                        
                        try {
                            const results = await AppState.searchEngine.search(query, 'destination', AppState.userLocation);
                            UIUpdater.showSearchResults(inputId, results);
                        } catch (error) {
                            console.error('Search error:', error);
                            UIUpdater.showToast('Search error. Please try again.', 'error');
                        } finally {
                            if (parent) parent.classList.remove('searching');
                        }
                    }, 300));
                }
            });
        }
        
        function setupAdditionalEventListeners() {
            // Notification bell
            document.getElementById('notificationBell').addEventListener('click', () => {
                document.getElementById('notificationsPanel').classList.toggle('active');
            });
            
            // Mark all notifications as read
            document.getElementById('markAllReadBtn').addEventListener('click', () => {
                FirebaseManager.markAllNotificationsAsRead();
            });
            
            // Emergency service selection
            document.querySelectorAll('.emergency-service').forEach(service => {
                service.addEventListener('click', () => {
                    const type = service.dataset.type;
                    handleEmergencyService(type);
                });
            });
            
            // Emergency reason selection
            document.querySelectorAll('.emergency-reason').forEach(reason => {
                reason.addEventListener('click', () => {
                    document.querySelectorAll('.emergency-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    reason.classList.add('selected');
                    
                    // Show other reason input if selected
                    if (reason.dataset.reason === 'other') {
                        document.getElementById('otherEmergencyReasonGroup').style.display = 'block';
                    } else {
                        document.getElementById('otherEmergencyReasonGroup').style.display = 'none';
                    }
                });
            });
            
            // SOS button
            document.getElementById('sosButton').addEventListener('click', () => {
                triggerSOS();
            });
            
            // Test SOS button
            document.getElementById('testSOSBtn').addEventListener('click', async () => {
                if (!AppState.sosConfig) {
                    UIUpdater.showToast('Please setup SOS contacts first', 'warning');
                    return;
                }
                
                const testData = {
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    message: 'TEST: This is a test SOS alert. No emergency exists.',
                    timestamp: Date.now(),
                    isTest: true
                };
                
                await FirebaseManager.sendSOSAlert('test', testData);
            });
            
            // Broadcast ride button
            document.getElementById('broadcastRideBtn').addEventListener('click', () => {
                if (!AppState.currentRide) {
                    UIUpdater.showToast('No active ride to broadcast', 'warning');
                    return;
                }
                
                showModal('broadcast');
            });
            
            // Send broadcast invite
            document.getElementById('sendBroadcastInviteBtn').addEventListener('click', async () => {
                const phone = document.getElementById('broadcastRecipientPhone').value.trim();
                const message = document.getElementById('broadcastRideMessage').value.trim();
                const allowTracking = document.getElementById('allowTracking').checked;
                
                if (!phone) {
                    UIUpdater.showToast('Please enter recipient phone number', 'warning');
                    return;
                }
                
                await FirebaseManager.broadcastRide(AppState.currentRide, phone, message, allowTracking);
                hideModal('broadcast');
            });
            
            // Add recipient button for broadcast
            document.getElementById('addRecipientBtn').addEventListener('click', () => {
                const container = document.getElementById('broadcastRecipients');
                const recipientDiv = document.createElement('div');
                recipientDiv.className = 'broadcast-recipient';
                recipientDiv.innerHTML = `
                    <div class="recipient-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="recipient-details">
                        <input type="tel" class="form-control" placeholder="Additional phone number" style="font-size: 12px; padding: 6px;">
                    </div>
                    <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(recipientDiv);
                
                // Add remove functionality
                const removeBtn = recipientDiv.querySelector('.btn-danger');
                removeBtn.addEventListener('click', () => {
                    recipientDiv.remove();
                });
            });
            
            // Add all other remaining event listeners...
            setupRemainingEventListeners();
        }
        
        function setupRemainingEventListeners() {
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const modal = btn.dataset.modal;
                    hideModal(modal);
                });
            });
            
            // Cancel reason selection
            document.querySelectorAll('.cancel-reason').forEach(reason => {
                reason.addEventListener('click', () => {
                    document.querySelectorAll('.cancel-reason').forEach(r => {
                        r.classList.remove('selected');
                    });
                    reason.classList.add('selected');
                    
                    if (reason.dataset.reason === 'other') {
                        document.getElementById('otherReasonGroup').style.display = 'block';
                    } else {
                        document.getElementById('otherReasonGroup').style.display = 'none';
                    }
                });
            });
            
            // Confirm cancel button
            document.getElementById('confirmCancelBtn').addEventListener('click', async () => {
                const selectedReason = document.querySelector('.cancel-reason.selected');
                if (!selectedReason) {
                    UIUpdater.showToast('Please select a cancellation reason', 'warning');
                    return;
                }
                
                let reason = selectedReason.dataset.reason;
                if (reason === 'other') {
                    const otherReason = document.getElementById('otherReason').value.trim();
                    if (!otherReason) {
                        UIUpdater.showToast('Please specify your reason', 'warning');
                        return;
                    }
                    reason = `other: ${otherReason}`;
                }
                
                if (AppState.currentRide) {
                    try {
                        await FirebaseManager.cancelRide(AppState.currentRide.id, reason);
                        hideModal('cancel');
                        resetUIAfterRide();
                    } catch (error) {
                        UIUpdater.showToast('Error cancelling ride', 'error');
                    }
                }
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', () => {
                    document.querySelectorAll('.payment-method').forEach(m => {
                        m.classList.remove('selected');
                    });
                    method.classList.add('selected');
                });
            });
            
            // Confirm payment button
            document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
                const selectedMethod = document.querySelector('.payment-method.selected');
                if (!selectedMethod) {
                    UIUpdater.showToast('Please select a payment method', 'warning');
                    return;
                }
                
                const paymentMethod = selectedMethod.dataset.payment;
                const amount = parseFloat(document.getElementById('paymentAmount').textContent.replace('ZMW ', ''));
                
                // Check wallet balance if paying with wallet
                if (paymentMethod === 'wallet' && AppState.walletBalance < amount) {
                    UIUpdater.showToast('Insufficient wallet balance', 'error');
                    return;
                }
                
                // Prepare ride data based on active service
                let rideData = await prepareRideData();
                
                if (!rideData) return;
                
                try {
                    // If paying with wallet, deduct from balance
                    if (paymentMethod === 'wallet') {
                        const newBalance = AppState.walletBalance - amount;
                        await database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance);
                        UIUpdater.updateWalletBalance(newBalance);
                    }
                    
                    // Request the service
                    let rideId;
                    switch (AppState.activeService) {
                        case 'delivery':
                            rideId = await FirebaseManager.requestDelivery(rideData);
                            break;
                        case 'short-delivery':
                            rideId = await FirebaseManager.requestDelivery(rideData);
                            break;
                        case 'truck':
                            rideId = await FirebaseManager.requestTruck(rideData);
                            break;
                        case 'express':
                            rideId = await FirebaseManager.requestShopping(rideData);
                            break;
                        case 'someone':
                        case 'share':
                        case 'broadcast':
                        case 'car':
                        default:
                            rideId = await FirebaseManager.requestRide(rideData);
                            break;
                    }
                    
                    hideModal('payment');
                    
                    // Clear pending data
                    window.pendingRideData = null;
                    
                } catch (error) {
                    console.error('Error processing payment:', error);
                    UIUpdater.showToast('Error processing payment', 'error');
                }
            });
            
            // Confirm emergency button
            document.getElementById('confirmEmergencyBtn').addEventListener('click', async () => {
                const selectedService = document.querySelector('.emergency-service-item.selected');
                const selectedReason = document.querySelector('.emergency-reason.selected');
                
                if (!selectedService) {
                    UIUpdater.showToast('Please select an emergency service', 'warning');
                    return;
                }
                
                if (!selectedReason) {
                    UIUpdater.showToast('Please select an emergency reason', 'warning');
                    return;
                }
                
                let reason = selectedReason.dataset.reason;
                if (reason === 'other') {
                    const otherReason = document.getElementById('otherEmergencyReason').value.trim();
                    if (!otherReason) {
                        UIUpdater.showToast('Please describe the emergency', 'warning');
                        return;
                    }
                    reason = otherReason;
                }
                
                const serviceType = selectedService.dataset.serviceType;
                const description = document.getElementById('emergencyDescription').value.trim();
                
                const rideData = {
                    passengerId: AppState.currentUser.uid,
                    passengerName: AppState.userData.name,
                    passengerPhone: AppState.userData.phone,
                    pickup: AppState.pickup?.address || 'Current Location',
                    pickupDisplay: AppState.pickup?.name || 'Current Location',
                    destination: selectedService.dataset.name,
                    destinationDisplay: selectedService.dataset.name,
                    pickupLat: AppState.pickup?.lat,
                    pickupLng: AppState.pickup?.lng,
                    destLat: parseFloat(selectedService.dataset.lat),
                    destLng: parseFloat(selectedService.dataset.lng),
                    rideType: 'emergency',
                    emergencyType: serviceType,
                    emergencyReason: reason,
                    fare: parseFloat(document.getElementById('emergencyTotalFare').textContent.replace('ZMW ', '')),
                    distance: parseFloat(document.getElementById('emergencyDistance').textContent.replace(' km', '')),
                    paymentMethod: 'emergency',
                    emergencyDescription: description,
                    priority: 'highest'
                };
                
                try {
                    await FirebaseManager.requestEmergencyRide(rideData);
                    hideModal('emergency');
                } catch (error) {
                    UIUpdater.showToast('Error requesting emergency ride', 'error');
                }
            });
            
            // Save SOS button
            document.getElementById('saveSOSBtn').addEventListener('click', async () => {
                const contact1Name = document.getElementById('sosContact1Name').value.trim();
                const contact1Phone = document.getElementById('sosContact1Phone').value.trim();
                const contact2Name = document.getElementById('sosContact2Name').value.trim();
                const contact2Phone = document.getElementById('sosContact2Phone').value.trim();
                const message = document.getElementById('sosMessage').value.trim();
                const autoSOS = document.getElementById('autoSOS').checked;
                const shareLocation = document.getElementById('shareLocation').checked;
                const shareDriverInfo = document.getElementById('shareDriverInfo').checked;
                
                if (!contact1Name || !contact1Phone) {
                    UIUpdater.showToast('Please provide primary emergency contact details', 'warning');
                    return;
                }
                
                const config = {
                    contact1Name,
                    contact1Phone,
                    contact2Name: contact2Name || '',
                    contact2Phone: contact2Phone || '',
                    message,
                    autoSOS,
                    shareLocation,
                    shareDriverInfo
                };
                
                await FirebaseManager.saveSOSConfig(config);
                hideModal('sos');
            });
            
            // Transfer money button
            document.getElementById('transferBtn').addEventListener('click', () => {
                showModal('transfer');
            });
            
            // Confirm transfer button
            document.getElementById('confirmTransferBtn').addEventListener('click', async () => {
                const recipientCode = document.getElementById('recipientCode').value.trim();
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const message = document.getElementById('transferMessage').value.trim();
                
                if (!recipientCode || !amount || amount <= 0) {
                    UIUpdater.showToast('Please enter valid transfer details', 'warning');
                    return;
                }
                
                if (amount > AppState.walletBalance) {
                    UIUpdater.showToast('Insufficient balance', 'error');
                    return;
                }
                
                await FirebaseManager.transferMoney(recipientCode, amount, message);
                hideModal('transfer');
            });
            
            // Transactions button
            document.getElementById('transactionsBtn').addEventListener('click', async () => {
                showModal('transactions');
                await loadTransactions();
            });
            
            // History filter buttons
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');
                    
                    AppState.activeFilters.history = btn.dataset.filter;
                    FirebaseManager.loadRideHistory(AppState.currentUser.uid);
                });
            });
            
            // Account actions
            document.getElementById('depositBtn').addEventListener('click', () => {
                const amount = prompt('Enter deposit amount (ZMW):');
                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                    const depositAmount = parseFloat(amount);
                    const newBalance = AppState.walletBalance + depositAmount;
                    
                    database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance)
                        .then(() => {
                            UIUpdater.updateWalletBalance(newBalance);
                            UIUpdater.showToast(`Deposited ZMW ${depositAmount.toFixed(2)}`, 'success');
                            
                            // Record transaction
                            const transactionId = database.ref().child('transactions').push().key;
                            const transaction = {
                                id: transactionId,
                                senderId: 'self',
                                senderName: 'Self',
                                recipientId: AppState.currentUser.uid,
                                recipientName: AppState.userData.name,
                                amount: depositAmount,
                                message: 'Wallet deposit',
                                timestamp: Date.now(),
                                type: 'deposit'
                            };
                            
                            database.ref(`transactions/${transactionId}`).set(transaction);
                        })
                        .catch(error => {
                            console.error('Deposit error:', error);
                            UIUpdater.showToast('Error processing deposit', 'error');
                        });
                }
            });
            
            document.getElementById('withdrawBtn').addEventListener('click', () => {
                if (AppState.walletBalance <= 0) {
                    UIUpdater.showToast('No balance to withdraw', 'warning');
                    return;
                }
                
                const amount = prompt(`Enter withdrawal amount (ZMW). Available: ZMW ${AppState.walletBalance.toFixed(2)}:`);
                if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                    const withdrawalAmount = parseFloat(amount);
                    
                    if (withdrawalAmount > AppState.walletBalance) {
                        UIUpdater.showToast('Insufficient balance', 'error');
                        return;
                    }
                    
                    const newBalance = AppState.walletBalance - withdrawalAmount;
                    
                    database.ref(`users/${AppState.currentUser.uid}/walletBalance`).set(newBalance)
                        .then(() => {
                            UIUpdater.updateWalletBalance(newBalance);
                            UIUpdater.showToast(`Withdrew ZMW ${withdrawalAmount.toFixed(2)}`, 'success');
                            
                            // Record transaction
                            const transactionId = database.ref().child('transactions').push().key;
                            const transaction = {
                                id: transactionId,
                                senderId: AppState.currentUser.uid,
                                senderName: AppState.userData.name,
                                recipientId: 'self',
                                recipientName: 'Self',
                                amount: withdrawalAmount,
                                message: 'Wallet withdrawal',
                                timestamp: Date.now(),
                                type: 'withdrawal'
                            };
                            
                            database.ref(`transactions/${transactionId}`).set(transaction);
                        })
                        .catch(error => {
                            console.error('Withdrawal error:', error);
                            UIUpdater.showToast('Error processing withdrawal', 'error');
                        });
                }
            });
            
            document.getElementById('shareReferralBtn').addEventListener('click', () => {
                const code = document.getElementById('referralCode').textContent;
                const text = `Join me on Jubel! Use my referral code ${code} for 50% off your first ride. Download the app now!`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Jubel Referral',
                        text: text,
                        url: window.location.href
                    });
                } else {
                    navigator.clipboard.writeText(text)
                        .then(() => UIUpdater.showToast('Referral code copied', 'success'))
                        .catch(() => UIUpdater.showToast('Error copying code', 'error'));
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    auth.signOut().then(() => {
                        window.location.href = 'signup.html';
                    });
                }
            });
        }
        
        async function prepareRideData() {
            let rideData = {};
            
            switch (AppState.activeService) {
                case 'delivery':
                    const parcelDesc = document.getElementById('parcelDescription').value.trim();
                    const receiverName = document.getElementById('receiverName').value.trim();
                    const receiverPhone = document.getElementById('receiverPhone').value.trim();
                    const parcelValue = parseFloat(document.getElementById('parcelValue').value) || 0;
                    
                    if (!parcelDesc || !receiverName || !receiverPhone) {
                        UIUpdater.showToast('Please fill all delivery details', 'warning');
                        return null;
                    }
                    
                    rideData = {
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone,
                        pickup: AppState.pickup?.address || 'Current Location',
                        pickupDisplay: AppState.pickup?.name || 'Current Location',
                        destination: AppState.destination?.address || 'Destination',
                        destinationDisplay: AppState.destination?.name || 'Destination',
                        pickupLat: AppState.pickup?.lat,
                        pickupLng: AppState.pickup?.lng,
                        destLat: AppState.destination?.lat,
                        destLng: AppState.destination?.lng,
                        serviceType: 'delivery',
                        parcelDescription: parcelDesc,
                        receiverName,
                        receiverPhone,
                        parcelValue,
                        deliveryType: document.querySelector('#deliveryForm .filter-btn.active')?.id?.replace('Delivery', '').toLowerCase() || 'standard',
                        fare: AppState.rideFare,
                        distance: PriceCalculator.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        ),
                        paymentMethod: document.querySelector('.payment-method.selected')?.dataset.payment || 'wallet'
                    };
                    break;
                    
                case 'truck':
                    const itemDesc = document.getElementById('truckItemDescription').value.trim();
                    const estimatedWeight = parseFloat(document.getElementById('estimatedWeight').value) || 0;
                    const needHelpers = document.getElementById('needHelpers').checked;
                    
                    if (!itemDesc || !estimatedWeight) {
                        UIUpdater.showToast('Please fill all truck details', 'warning');
                        return null;
                    }
                    
                    rideData = {
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone,
                        pickup: AppState.pickup?.address || 'Current Location',
                        pickupDisplay: AppState.pickup?.name || 'Current Location',
                        destination: AppState.destination?.address || 'Destination',
                        destinationDisplay: AppState.destination?.name || 'Destination',
                        pickupLat: AppState.pickup?.lat,
                        pickupLng: AppState.pickup?.lng,
                        destLat: AppState.destination?.lat,
                        destLng: AppState.destination?.lng,
                        serviceType: 'truck',
                        truckType: document.querySelector('.truck-type.selected')?.dataset.type || 'light',
                        itemDescription: itemDesc,
                        estimatedWeight,
                        needHelpers,
                        fare: AppState.rideFare,
                        distance: PriceCalculator.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        ),
                        paymentMethod: document.querySelector('.payment-method.selected')?.dataset.payment || 'wallet'
                    };
                    break;
                    
                default: // car, schedule, someone, share, broadcast
                    rideData = {
                        passengerId: AppState.currentUser.uid,
                        passengerName: AppState.userData.name,
                        passengerPhone: AppState.userData.phone,
                        pickup: AppState.pickup?.address || 'Current Location',
                        pickupDisplay: AppState.pickup?.name || 'Current Location',
                        destination: AppState.destination?.address || 'Destination',
                        destinationDisplay: AppState.destination?.name || 'Destination',
                        pickupLat: AppState.pickup?.lat,
                        pickupLng: AppState.pickup?.lng,
                        destLat: AppState.destination?.lat,
                        destLng: AppState.destination?.lng,
                        rideType: AppState.selectedRideType,
                        fare: AppState.rideFare,
                        distance: PriceCalculator.calculateDistance(
                            AppState.pickup.lat, AppState.pickup.lng,
                            AppState.destination.lat, AppState.destination.lng
                        ),
                        paymentMethod: document.querySelector('.payment-method.selected')?.dataset.payment || 'wallet'
                    };
                    
                    // Add additional data for specific services
                    if (AppState.activeService === 'schedule') {
                        const scheduleDate = document.getElementById('scheduleDate').value;
                        const scheduleTime = document.getElementById('scheduleTime').value;
                        const forSomeone = document.getElementById('scheduleForSomeone').checked;
                        
                        if (!scheduleDate || !scheduleTime) {
                            UIUpdater.showToast('Please select date and time', 'warning');
                            return null;
                        }
                        
                        rideData.scheduled = true;
                        rideData.scheduledTime = new Date(`${scheduleDate}T${scheduleTime}`).getTime();
                        rideData.status = 'scheduled';
                        
                        if (forSomeone) {
                            rideData.recipientName = document.getElementById('recipientName').value;
                            rideData.recipientPhone = document.getElementById('recipientPhone').value;
                            rideData.forSomeoneElse = true;
                        }
                    }
                    
                    if (AppState.activeService === 'someone') {
                        const someoneName = document.getElementById('someoneName').value.trim();
                        const someonePhone = document.getElementById('someonePhone').value.trim();
                        
                        if (!someoneName || !someonePhone) {
                            UIUpdater.showToast('Please fill recipient details', 'warning');
                            return null;
                        }
                        
                        rideData.recipientName = someoneName;
                        rideData.recipientPhone = someonePhone;
                        rideData.forSomeoneElse = true;
                    }
                    
                    if (AppState.activeService === 'share') {
                        const friendCode = document.getElementById('friendReferralCode').value.trim();
                        const splitPercentage = document.getElementById('splitPercentage').value;
                        
                        if (!friendCode) {
                            UIUpdater.showToast('Please enter friend\'s referral code', 'warning');
                            return null;
                        }
                        
                        rideData.sharedRide = true;
                        rideData.friendReferralCode = friendCode;
                        rideData.splitPercentage = splitPercentage;
                    }
                    
                    if (AppState.activeService === 'broadcast') {
                        rideData.broadcast = true;
                    }
                    break;
            }
            
            return rideData;
        }
        
        async function loadTransactions() {
            const transactions = await FirebaseManager.loadTransactions(AppState.currentUser.uid);
            const container = document.getElementById('transactionsList');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 30px 0;">
                        <div class="empty-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <div class="empty-title">No transactions yet</div>
                        <div class="empty-message">Your wallet transactions will appear here</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transactions.forEach(transaction => {
                const isSent = transaction.senderId === AppState.currentUser.uid;
                const date = new Date(transaction.timestamp);
                
                html += `
                    <div class="history-item" style="margin-bottom: 10px;">
                        <div class="history-header">
                            <div class="history-type">
                                <div class="history-icon" style="background: ${isSent ? 'var(--error-red)' : 'var(--success-green)'}">
                                    <i class="fas fa-${isSent ? 'arrow-up' : 'arrow-down'}"></i>
                                </div>
                                <div class="history-type-name">
                                    ${transaction.type === 'referral' ? 'Referral Reward' : isSent ? 'Money Sent' : 'Money Received'}
                                </div>
                            </div>
                            <div class="history-date">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                            </div>
                        </div>
                        
                        <div style="padding: 10px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: var(--text-gray);">${isSent ? 'To' : 'From'}:</span>
                                <span style="font-weight: 600;">${isSent ? transaction.recipientName : transaction.senderName}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: var(--text-gray);">Amount:</span>
                                <span style="font-weight: 700; color: ${isSent ? 'var(--error-red)' : 'var(--success-green)'}">
                                    ${isSent ? '-' : '+'}ZMW ${transaction.amount.toFixed(2)}
                                </span>
                            </div>
                            ${transaction.message ? `
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-gray);">Message:</span>
                                <span style="font-size: 12px;">${transaction.message}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function loadPromotions() {
            const container = document.getElementById('promotionsList');
            
            if (AppState.promotions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 30px 0;">
                        <div class="empty-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="empty-title">No active promotions</div>
                        <div class="empty-message">Check back later for exciting offers!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            AppState.promotions.forEach(promotion => {
                html += `
                    <div class="history-item" style="margin-bottom: 10px;">
                        <div class="history-header">
                            <div class="history-type">
                                <div class="history-icon" style="background: ${promotion.color || 'var(--primary-orange)'}">
                                    <i class="fas fa-gift"></i>
                                </div>
                                <div class="history-type-name">
                                    ${promotion.title}
                                </div>
                            </div>
                            <div class="history-date">
                                ${new Date(promotion.expiry).toLocaleDateString()}
                            </div>
                        </div>
                        
                        <div style="padding: 10px 0;">
                            <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">
                                ${promotion.description}
                            </div>
                            
                            ${promotion.code ? `
                            <div style="background: var(--light-orange); padding: 8px; border-radius: var(--element-radius); margin: 8px 0;">
                                <div style="font-size: 11px; color: var(--text-light);">Promo Code:</div>
                                <div style="font-family: monospace; font-size: 14px; font-weight: 700; color: var(--primary-orange);">
                                    ${promotion.code}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${promotion.terms ? `
                            <div style="font-size: 10px; color: var(--text-light); margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> ${promotion.terms}
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="history-footer">
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 11px;" onclick="applyPromotion('${promotion.code || ''}')">
                                <i class="fas fa-check"></i> Apply Offer
                            </button>
                            <div style="font-size: 10px; color: var(--text-light);">
                                Expires: ${new Date(promotion.expiry).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function applyPromotion(code) {
            UIUpdater.showToast(`Promotion ${code} applied to your next ride`, 'success');
            hideModal('promotions');
        }
        
        function switchScreen(screen) {
            // Hide all screens
            document.querySelectorAll('.history-screen, .account-screen, .emergency-screen').forEach(s => {
                s.classList.remove('active');
            });
            
            // Update navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected screen
            if (screen === 'home') {
                AppState.activeScreen = 'home';
                document.querySelector(`.nav-tab[data-screen="home"]`).classList.add('active');
            } else {
                document.getElementById(`${screen}Screen`).classList.add('active');
                document.querySelector(`.nav-tab[data-screen="${screen}"]`).classList.add('active');
                AppState.activeScreen = screen;
                
                // Load data for specific screens
                if (screen === 'history') {
                    FirebaseManager.loadRideHistory(AppState.currentUser.uid);
                }
            }
        }
        
        function switchService(service) {
            // Hide all forms
            document.querySelectorAll('.ride-request-form, .service-form, .schedule-form, .more-options').forEach(form => {
                form.style.display = 'none';
                form.classList.remove('active');
            });
            
            // Update service tabs
            document.querySelectorAll('.service-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected service form
            AppState.activeService = service;
            
            // Show ride type selection only for car and related services
            const showRideType = ['car', 'schedule', 'someone', 'share', 'broadcast'].includes(service);
            
            switch(service) {
                case 'car':
                    document.querySelector('.service-tab.car').classList.add('active');
                    document.getElementById('carForm').style.display = 'block';
                    if (showRideType) {
                        document.getElementById('rideTypeSelection').classList.add('active');
                    }
                    break;
                case 'delivery':
                    document.querySelector('.service-tab.delivery').classList.add('active');
                    document.getElementById('deliveryForm').style.display = 'block';
                    document.getElementById('deliveryForm').classList.add('active');
                    break;
                case 'short-delivery':
                    document.querySelector('.service-tab.short-delivery').classList.add('active');
                    document.getElementById('shortDeliveryForm').style.display = 'block';
                    document.getElementById('shortDeliveryForm').classList.add('active');
                    break;
                case 'express':
                    document.querySelector('.service-tab[data-service="express"]').classList.add('active');
                    document.getElementById('expressForm').style.display = 'block';
                    document.getElementById('expressForm').classList.add('active');
                    break;
                case 'truck':
                    document.querySelector('.service-tab[data-service="truck"]').classList.add('active');
                    document.getElementById('truckForm').style.display = 'block';
                    document.getElementById('truckForm').classList.add('active');
                    break;
                case 'schedule':
                    document.getElementById('scheduleForm').style.display = 'block';
                    document.getElementById('scheduleForm').classList.add('active');
                    if (showRideType) {
                        document.getElementById('scheduleRideTypeSelection').classList.add('active');
                    }
                    break;
                case 'someone':
                    document.getElementById('someoneElseForm').style.display = 'block';
                    document.getElementById('someoneElseForm').classList.add('active');
                    if (showRideType) {
                        document.getElementById('someoneRideTypeSelection').classList.add('active');
                    }
                    break;
                case 'share':
                    document.getElementById('shareRideForm').style.display = 'block';
                    document.getElementById('shareRideForm').classList.add('active');
                    if (showRideType) {
                        document.getElementById('shareRideTypeSelection').classList.add('active');
                    }
                    break;
                case 'broadcast':
                    document.getElementById('broadcastForm').style.display = 'block';
                    document.getElementById('broadcastForm').classList.add('active');
                    if (showRideType) {
                        document.getElementById('broadcastRideTypeSelection').classList.add('active');
                    }
                    break;
            }
        }
        
        function handleMoreOptionSelection(option) {
            switch(option) {
                case 'schedule':
                    switchService('schedule');
                    break;
                case 'order-for-someone':
                    switchService('someone');
                    break;
                case 'share-ride':
                    switchService('share');
                    break;
                case 'broadcast':
                    switchService('broadcast');
                    break;
            }
        }
        
        function togglePanel() {
            const panel = document.getElementById('mainPanel');
            panel.classList.toggle('collapsed');
        }
        
        function showModal(modalId) {
            document.getElementById(`${modalId}Modal`).classList.add('active');
            
            // Handle specific modal setups
            if (modalId === 'emergency' && AppState.userLocation) {
                // Update emergency location details
                UIUpdater.updateEmergencyLocationDetails(AppState.pickup);
                
                // Load emergency services
                loadEmergencyServices();
            }
        }
        
        function hideModal(modalId) {
            document.getElementById(`${modalId}Modal`).classList.remove('active');
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });
        }
        
        async function loadEmergencyServices() {
            const serviceType = document.getElementById('emergencyServiceType').textContent.toLowerCase().includes('police') ? 'police' :
                               document.getElementById('emergencyServiceType').textContent.toLowerCase().includes('fire') ? 'fire' : 'medical';
            
            const services = EmergencyLocator.findNearestServices(serviceType, AppState.userLocation);
            UIUpdater.updateEmergencyServicesList(services);
            
            // Show markers on map
            EmergencyLocator.showEmergencyMarkers(serviceType);
        }
        
        function handleEmergencyService(type) {
            if (!AppState.userLocation) {
                UIUpdater.showToast('Please allow location access for emergency services', 'warning');
                return;
            }
            
            // Update modal title
            document.getElementById('emergencyServiceType').textContent = 
                type.charAt(0).toUpperCase() + type.slice(1) + ' Emergency';
            
            // Show modal
            showModal('emergency');
        }
        
        function triggerSOS() {
            if (!AppState.sosConfig) {
                UIUpdater.showToast('Please setup SOS contacts first', 'warning');
                showModal('sos');
                return;
            }
            
            if (!AppState.currentRide) {
                UIUpdater.showToast('No active ride to report SOS for', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to send an SOS alert to your emergency contacts and authorities?')) {
                return;
            }
            
            const sosData = {
                passengerId: AppState.currentUser.uid,
                passengerName: AppState.userData.name,
                passengerPhone: AppState.userData.phone,
                emergencyContact1: AppState.sosConfig.contact1Phone,
                emergencyContact1Name: AppState.sosConfig.contact1Name,
                emergencyContact2: AppState.sosConfig.contact2Phone,
                emergencyContact2Name: AppState.sosConfig.contact2Name,
                message: AppState.sosConfig.message,
                rideId: AppState.currentRide.id,
                location: AppState.userLocation,
                timestamp: Date.now()
            };
            
            FirebaseManager.sendSOSAlert(AppState.currentRide.id, sosData)
                .then(() => {
                    UIUpdater.showToast('SOS alert sent to emergency contacts and authorities', 'success');
                })
                .catch(error => {
                    console.error('SOS error:', error);
                                        UIUpdater.showToast('Error sending SOS alert', 'error');
                });
        }
        
        function resetUIAfterRide() {
            // Hide ride info panel
            document.getElementById('rideInfoPanel').classList.remove('active');
            
            // Show active service form
            switchService(AppState.activeService);
            
            // Hide fare display
            document.getElementById('fareDisplay').classList.remove('active');
            
            // Hide emergency status
            document.getElementById('emergencyStatus').style.display = 'none';
            
            // Hide SOS button
            document.getElementById('sosButton').style.display = 'none';
            
            // Hide ride status bar
            document.getElementById('rideStatusBar').classList.remove('active');
            
            // Clear current ride
            AppState.currentRide = null;
            AppState.emergencyMode = false;
            AppState.selectedVehicle = null;
            
            // Remove driver marker
            if (driverMarker) {
                map.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove route
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // Clear destination
            document.getElementById('destinationLocation').value = '';
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            // Clear chat
            document.getElementById('chatMessages').innerHTML = '';
            document.getElementById('chatContainer').classList.remove('active');
            UIUpdater.clearChatNotification();
        }
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function handleSearchInput(inputElement, value) {
            clearTimeout(inputElement.searchTimer);
            
            if (value.length < 2) {
                const container = document.getElementById(`${inputElement.id}SearchResults`);
                if (container) container.classList.remove('active');
                return;
            }
            
            // Show loading
            const parent = inputElement.closest('.location-input');
            if (parent) parent.classList.add('searching');
            
            inputElement.searchTimer = setTimeout(async () => {
                try {
                    const results = await AppState.searchEngine.search(value, 'destination', AppState.userLocation);
                    UIUpdater.showSearchResults(inputElement.id, results);
                } catch (error) {
                    console.error('Search error:', error);
                    UIUpdater.showToast('Search error. Please try again.', 'error');
                } finally {
                    if (parent) parent.classList.remove('searching');
                }
            }, 300);
        }
        
        // ============================================
        // REAL-TIME UPDATES
        // ============================================
        
        function setupRealTimeUpdates() {
            // Set up WebSocket connection for real-time updates
            try {
                AppState.socket = io('https://jubel-socket-server.onrender.com', {
                    transports: ['websocket', 'polling'],
                    query: {
                        userId: AppState.currentUser?.uid,
                        userType: 'passenger'
                    }
                });
                
                AppState.socket.on('connect', () => {
                    console.log('Connected to real-time server');
                });
                
                AppState.socket.on('disconnect', () => {
                    console.log('Disconnected from real-time server');
                });
                
                AppState.socket.on('driver_location_update', (data) => {
                    if (AppState.currentRide && data.driverId === AppState.currentRide.driverId) {
                        AppState.driverLocation = data.location;
                        UIUpdater.updateDriverMarker({
                            lat: data.location.latitude,
                            lng: data.location.longitude
                        });
                    }
                });
                
                AppState.socket.on('ride_status_update', (data) => {
                    if (AppState.currentRide && data.rideId === AppState.currentRide.id) {
                        UIUpdater.updateRideStatus(data.status);
                        UIUpdater.updateTimeline(data.status);
                        
                        if (data.status === 'accepted' && data.driverId) {
                            FirebaseManager.loadDriverInfo(data.driverId);
                        }
                    }
                });
                
                AppState.socket.on('chat_message', (data) => {
                    if (AppState.currentRide && data.rideId === AppState.currentRide.id) {
                        const isSender = data.senderId === AppState.currentUser.uid;
                        UIUpdater.showChatMessage(data, isSender);
                    }
                });
                
                AppState.socket.on('broadcast_invitation', (data) => {
                    if (data.recipientId === AppState.currentUser.uid) {
                        UIUpdater.showToast(`You have been invited to track a ride by ${data.senderName}`, 'info');
                        
                        // Add notification
                        FirebaseManager.sendNotification(
                            AppState.currentUser.uid,
                            'Ride Broadcast',
                            `${data.senderName} has shared a ride with you`,
                            'broadcast',
                            { broadcastId: data.broadcastId, rideId: data.rideId }
                        );
                    }
                });
                
            } catch (error) {
                console.error('Error setting up real-time updates:', error);
                // Fallback to Firebase for real-time updates
            }
        }
        
        // ============================================
        // PUSH NOTIFICATIONS
        // ============================================
        
        async function setupPushNotifications() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await messaging.getToken({
                        vapidKey: 'YOUR_VAPID_KEY_HERE'
                    });
                    
                    if (token) {
                        // Save token to Firebase
                        await database.ref(`users/${AppState.currentUser.uid}/fcmToken`).set(token);
                        
                        // Listen for messages
                        messaging.onMessage((payload) => {
                            console.log('Message received:', payload);
                            
                            // Show notification
                            if (payload.notification) {
                                UIUpdater.showToast(payload.notification.body, 'info');
                            }
                            
                            // Handle data payload
                            if (payload.data) {
                                handlePushNotificationData(payload.data);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('Error setting up push notifications:', error);
            }
        }
        
        function handlePushNotificationData(data) {
            switch(data.type) {
                case 'ride_update':
                    if (data.rideId === AppState.currentRide?.id) {
                        UIUpdater.updateRideStatus(data.status);
                        UIUpdater.updateTimeline(data.status);
                    }
                    break;
                case 'chat_message':
                    if (data.rideId === AppState.currentRide?.id && !document.getElementById('chatContainer').classList.contains('active')) {
                        UIUpdater.showChatNotification();
                    }
                    break;
                case 'emergency':
                    UIUpdater.showToast('Emergency alert! Check your SOS notifications.', 'error');
                    break;
            }
        }
        
        // ============================================
        // OFFLINE SUPPORT
        // ============================================
        
        function setupOfflineSupport() {
            // Check online status
            window.addEventListener('online', () => {
                UIUpdater.showToast('Back online. Syncing data...', 'success');
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                UIUpdater.showToast('You are offline. Some features may be limited.', 'warning');
            });
            
            // Service worker registration for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
            
            // Cache search results for offline use
            const searchCache = {
                set: (key, data) => {
                    localStorage.setItem(`search_${key}`, JSON.stringify({
                        data: data,
                        timestamp: Date.now()
                    }));
                },
                get: (key) => {
                    const cached = localStorage.getItem(`search_${key}`);
                    if (cached) {
                        const parsed = JSON.parse(cached);
                        // Cache valid for 24 hours
                        if (Date.now() - parsed.timestamp < 24 * 60 * 60 * 1000) {
                            return parsed.data;
                        }
                    }
                    return null;
                }
            };
            
            // Extend search engine to use cache
            const originalSearch = AppState.searchEngine.search.bind(AppState.searchEngine);
            AppState.searchEngine.search = async function(query, type, location, category) {
                const cacheKey = `${query}-${type}-${category}`;
                const cached = searchCache.get(cacheKey);
                
                if (cached && navigator.onLine === false) {
                    return cached;
                }
                
                const results = await originalSearch(query, type, location, category);
                
                if (navigator.onLine) {
                    searchCache.set(cacheKey, results);
                }
                
                return results;
            };
        }
        
        async function syncOfflineData() {
            // Sync offline ride requests
            const offlineRequests = JSON.parse(localStorage.getItem('offline_requests') || '[]');
            
            if (offlineRequests.length > 0) {
                UIUpdater.showLoading('Syncing offline data...');
                
                for (const request of offlineRequests) {
                    try {
                        await FirebaseManager.requestRide(request);
                    } catch (error) {
                        console.error('Error syncing offline request:', error);
                    }
                }
                
                localStorage.removeItem('offline_requests');
                UIUpdater.hideLoading();
                UIUpdater.showToast('Offline data synced successfully', 'success');
            }
        }
        
        // ============================================
        // ANALYTICS AND TRACKING
        // ============================================
        
        const Analytics = {
            trackEvent: function(eventName, properties = {}) {
                if (!AppState.currentUser) return;
                
                const eventData = {
                    userId: AppState.currentUser.uid,
                    event: eventName,
                    timestamp: Date.now(),
                    properties: properties,
                    userAgent: navigator.userAgent,
                    platform: 'web'
                };
                
                // Send to Firebase
                database.ref(`analytics/events/${Date.now()}`).set(eventData)
                    .catch(error => console.error('Error tracking event:', error));
                
                // Log to console in development
                if (window.location.hostname === 'localhost') {
                    console.log(`[Analytics] ${eventName}:`, properties);
                }
            },
            
            trackRideRequest: function(serviceType, rideType, distance, fare) {
                this.trackEvent('ride_requested', {
                    service_type: serviceType,
                    ride_type: rideType,
                    distance_km: distance,
                    fare: fare,
                    city: AppState.currentCity
                });
            },
            
            trackPayment: function(paymentMethod, amount, rideId) {
                this.trackEvent('payment_completed', {
                    payment_method: paymentMethod,
                    amount: amount,
                    ride_id: rideId
                });
            },
            
            trackSearch: function(query, resultCount, selectedResult) {
                this.trackEvent('location_searched', {
                    query: query,
                    result_count: resultCount,
                    selected: selectedResult !== null,
                    city: AppState.currentCity
                });
            },
            
            trackEmergencyRequest: function(serviceType, reason, distance, fare) {
                this.trackEvent('emergency_requested', {
                    service_type: serviceType,                    emergency_reason: reason,
                    distance_km: distance,
                    fare: fare,
                    location: AppState.userLocation
                });
            }
        };

        // ============================================
        // ENHANCED ERROR HANDLING
        // ============================================

        const ErrorHandler = {
            handleError: function(error, context = '') {
                console.error(`Error in ${context}:`, error);
                
                // Log error to Firebase for monitoring
                const errorId = database.ref().child('errors').push().key;
                database.ref(`errors/${errorId}`).set({
                    userId: AppState.currentUser?.uid,
                    context: context,
                    error: error.toString(),
                    stack: error.stack,
                    timestamp: Date.now(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                }).catch(err => console.error('Error logging error:', err));
                
                // Show user-friendly message
                let userMessage = 'An unexpected error occurred. Please try again.';
                
                if (error.message.includes('network') || error.message.includes('offline')) {
                    userMessage = 'Network error. Please check your internet connection.';
                } else if (error.message.includes('permission')) {
                    userMessage = 'Permission denied. Please check your browser settings.';
                } else if (error.message.includes('location')) {
                    userMessage = 'Location access denied. Please enable location services.';
                } else if (error.message.includes('payment')) {
                    userMessage = 'Payment processing failed. Please try another method.';
                }
                
                UIUpdater.showToast(`${context}: ${userMessage}`, 'error');
                
                // If offline, store for later sync
                if (!navigator.onLine) {
                    this.storeOfflineError(error, context);
                }
            },
            
            storeOfflineError: function(error, context) {
                const offlineErrors = JSON.parse(localStorage.getItem('offline_errors') || '[]');
                offlineErrors.push({
                    error: error.toString(),
                    context: context,
                    timestamp: Date.now()
                });
                
                // Keep only last 20 errors
                if (offlineErrors.length > 20) {
                    offlineErrors.shift();
                }
                
                localStorage.setItem('offline_errors', JSON.stringify(offlineErrors));
            },
            
            syncOfflineErrors: function() {
                if (!navigator.onLine) return;
                
                const offlineErrors = JSON.parse(localStorage.getItem('offline_errors') || '[]');
                if (offlineErrors.length === 0) return;
                
                offlineErrors.forEach(error => {
                    const errorId = database.ref().child('errors').push().key;
                    database.ref(`errors/${errorId}`).set({
                        ...error,
                        synced: true
                    }).catch(err => console.error('Error syncing offline error:', err));
                });
                
                localStorage.removeItem('offline_errors');
            }
        };

        // ============================================
        // ENHANCED PERFORMANCE OPTIMIZATION
        // ============================================

        const PerformanceOptimizer = {
            imageCache: new Map(),
            
            optimizeImageLoading: function() {
                // Lazy load images
                const images = document.querySelectorAll('img[data-src]');
                
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            
                            if (src && !this.imageCache.has(src)) {
                                this.loadImageWithCache(src).then(blobUrl => {
                                    img.src = blobUrl;
                                    img.removeAttribute('data-src');
                                });
                            }
                            
                            observer.unobserve(img);
                        }
                    });
                });
                
                images.forEach(img => imageObserver.observe(img));
            },
            
            loadImageWithCache: async function(src) {
                // Check cache first
                if (this.imageCache.has(src)) {
                    return this.imageCache.get(src);
                }
                
                try {
                    const response = await fetch(src);
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // Cache for 5 minutes
                    this.imageCache.set(src, blobUrl);
                    setTimeout(() => {
                        URL.revokeObjectURL(blobUrl);
                        this.imageCache.delete(src);
                    }, 5 * 60 * 1000);
                    
                    return blobUrl;
                } catch (error) {
                    console.error('Error loading image:', error);
                    return src; // Fallback to original src
                }
            },
            
            debounceMapUpdates: function() {
                // Debounce map movements to improve performance
                let mapUpdateTimeout;
                
                map.on('moveend', () => {
                    clearTimeout(mapUpdateTimeout);
                    mapUpdateTimeout = setTimeout(() => {
                        this.updateMapMarkers();
                    }, 300);
                });
            },
            
            updateMapMarkers: function() {
                // Implement marker clustering or visibility optimization
                const bounds = map.getBounds();
                
                // Only update markers in viewport
                // This is a simplified version - in production you'd want a more sophisticated solution
                if (pickupMarker && bounds.contains(pickupMarker.getLatLng())) {
                    pickupMarker.addTo(map);
                }
                
                if (destinationMarker && bounds.contains(destinationMarker.getLatLng())) {
                    destinationMarker.addTo(map);
                }
                
                if (driverMarker && bounds.contains(driverMarker.getLatLng())) {
                    driverMarker.addTo(map);
                }
            },
            
            throttleEvent: function(element, event, handler, interval = 100) {
                let canRun = true;
                
                const throttledHandler = (...args) => {
                    if (canRun) {
                        handler(...args);
                        canRun = false;
                        setTimeout(() => {
                            canRun = true;
                        }, interval);
                    }
                };
                
                element.addEventListener(event, throttledHandler);
                return () => element.removeEventListener(event, throttledHandler);
            }
        };

        // ============================================
        // ENHANCED ACCESSIBILITY FEATURES
        // ============================================

        const Accessibility = {
            init: function() {
                this.addKeyboardNavigation();
                this.enhanceFormAccessibility();
                this.setupScreenReaderAnnouncements();
                this.addHighContrastSupport();
            },
            
            addKeyboardNavigation: function() {
                // Make all buttons and interactive elements keyboard accessible
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        this.handleTabNavigation(e);
                    }
                    
                    if (e.key === 'Enter' || e.key === ' ') {
                        this.handleEnterSpace(e);
                    }
                });
                
                // Add focus rings for keyboard navigation
                document.addEventListener('mousedown', () => {
                    document.body.classList.add('using-mouse');
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        document.body.classList.remove('using-mouse');
                    }
                });
            },
            
            handleTabNavigation: function(e) {
                const focusableElements = this.getFocusableElements();
                const currentIndex = focusableElements.indexOf(document.activeElement);
                
                if (e.shiftKey) {
                    // Shift + Tab
                    if (currentIndex <= 0) {
                        e.preventDefault();
                        focusableElements[focusableElements.length - 1].focus();
                    }
                } else {
                    // Tab
                    if (currentIndex >= focusableElements.length - 1) {
                        e.preventDefault();
                        focusableElements[0].focus();
                    }
                }
            },
            
            getFocusableElements: function() {
                return Array.from(document.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                )).filter(el => {
                    return !el.disabled && el.offsetParent !== null;
                });
            },
            
            handleEnterSpace: function(e) {
                const target = e.target;
                
                if (target.tagName === 'DIV' && target.getAttribute('role') === 'button') {
                    e.preventDefault();
                    target.click();
                }
            },
            
            enhanceFormAccessibility: function() {
                // Add aria labels to form elements
                document.querySelectorAll('input, button, select, textarea').forEach(el => {
                    if (!el.id && !el.getAttribute('aria-label')) {
                        const label = el.previousElementSibling?.textContent || 
                                    el.parentElement?.querySelector('label')?.textContent;
                        if (label) {
                            el.setAttribute('aria-label', label);
                        }
                    }
                });
                
                // Add live regions for dynamic content
                const liveRegion = document.createElement('div');
                liveRegion.setAttribute('aria-live', 'polite');
                liveRegion.setAttribute('aria-atomic', 'true');
                liveRegion.style.position = 'absolute';
                liveRegion.style.width = '1px';
                liveRegion.style.height = '1px';
                liveRegion.style.margin = '-1px';
                liveRegion.style.overflow = 'hidden';
                liveRegion.style.clip = 'rect(0, 0, 0, 0)';
                document.body.appendChild(liveRegion);
                
                // Update live region when important events happen
                AppState.liveRegion = liveRegion;
            },
            
            setupScreenReaderAnnouncements: function() {
                // Announce important events
                const originalShowToast = UIUpdater.showToast;
                UIUpdater.showToast = function(message, type = 'info') {
                    originalShowToast.call(this, message, type);
                    
                    if (AppState.liveRegion) {
                        AppState.liveRegion.textContent = message;
                        
                        // Clear after announcement
                        setTimeout(() => {
                            AppState.liveRegion.textContent = '';
                        }, 1000);
                    }
                };
                
                // Announce ride status changes
                const originalUpdateRideStatus = UIUpdater.updateRideStatus;
                UIUpdater.updateRideStatus = function(status) {
                    originalUpdateRideStatus.call(this, status);
                    
                    if (AppState.liveRegion) {
                        const statusMessages = {
                            requested: 'Ride requested. Searching for driver.',
                            accepted: 'Driver accepted. Driver is on the way.',
                            arrived: 'Driver has arrived at your location.',
                            started: 'Ride has started. Trip in progress.',
                            completed: 'Ride completed successfully.'
                        };
                        
                        if (statusMessages[status]) {
                            AppState.liveRegion.textContent = statusMessages[status];
                            
                            setTimeout(() => {
                                AppState.liveRegion.textContent = '';
                            }, 2000);
                        }
                    }
                };
            },
            
            addHighContrastSupport: function() {
                // Check for prefers-contrast media query
                const highContrastMedia = window.matchMedia('(prefers-contrast: more)');
                
                const updateContrast = () => {
                    if (highContrastMedia.matches) {
                        document.body.classList.add('high-contrast');
                    } else {
                        document.body.classList.remove('high-contrast');
                    }
                };
                
                updateContrast();
                highContrastMedia.addListener(updateContrast);
                
                // Add high contrast styles
                const style = document.createElement('style');
                style.textContent = `
                    .high-contrast {
                        --primary-orange: #FF4500;
                        --primary-red: #DC143C;
                        --text-gray: #000000;
                        --text-light: #333333;
                    }
                    
                    .high-contrast button {
                        border: 2px solid currentColor !important;
                    }
                    
                    .high-contrast input {
                        border: 2px solid currentColor !important;
                    }
                `;
                document.head.appendChild(style);
            },
            
            announceToScreenReader: function(message) {
                if (AppState.liveRegion) {
                    AppState.liveRegion.textContent = message;
                    
                    setTimeout(() => {
                        AppState.liveRegion.textContent = '';
                    }, 2000);
                }
            }
        };

        // ============================================
        // ENHANCED SECURITY FEATURES
        // ============================================

        const Security = {
            sanitizeInput: function(input) {
                if (typeof input !== 'string') return input;
                
                // Remove potentially dangerous characters
                return input
                    .replace(/[<>]/g, '') // Remove < and >
                    .replace(/javascript:/gi, '') // Remove javascript: protocol
                    .replace(/on\w+=/gi, '') // Remove event handlers
                    .trim();
            },
            
            validatePhoneNumber: function(phone) {
                // Basic Zambian phone number validation
                const phoneRegex = /^(\+260|0)?(96|97|76|77|79)\d{7}$/;
                return phoneRegex.test(phone.replace(/\s+/g, ''));
            },
            
            validateEmail: function(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },
            
            encryptSensitiveData: function(data) {
                // In a production app, use proper encryption
                // This is a simplified version for demonstration
                try {
                    return btoa(JSON.stringify(data));
                } catch (error) {
                    console.error('Encryption error:', error);
                    return data;
                }
            },
            
            decryptSensitiveData: function(encryptedData) {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (error) {
                    console.error('Decryption error:', error);
                    return encryptedData;
                }
            },
            
            checkRateLimit: function(action, userId) {
                const now = Date.now();
                const key = `rate_limit_${action}_${userId}`;
                
                // Get existing rate limit data
                const rateData = JSON.parse(localStorage.getItem(key) || '{"count": 0, "timestamp": 0}');
                
                // Reset if more than 1 minute has passed
                if (now - rateData.timestamp > 60000) {
                    rateData.count = 0;
                    rateData.timestamp = now;
                }
                
                // Check if rate limit exceeded
                const limits = {
                    ride_request: 10, // 10 rides per minute
                    search: 30, // 30 searches per minute
                    chat: 20 // 20 messages per minute
                };
                
                if (rateData.count >= (limits[action] || 10)) {
                    return false;
                }
                
                // Update rate limit
                rateData.count++;
                localStorage.setItem(key, JSON.stringify(rateData));
                
                return true;
            },
            
            preventSensitiveDataLogging: function() {
                // Override console.log to prevent logging sensitive data
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                console.log = function(...args) {
                    const sanitized = args.map(arg => {
                        if (typeof arg === 'string') {
                            // Remove sensitive patterns
                            return arg
                                .replace(/(phone|password|credit.?card|wallet)=["']?([^"'\s]+)["']?/gi, '$1=***')
                                .replace(/(\+260|0)?(96|97|76|77|79)\d{7}/g, 'PHONE_REDACTED')
                                .replace(/[0-9]{16}/g, 'CARD_REDACTED');
                        }
                        return arg;
                    });
                    originalLog.apply(console, sanitized);
                };
                
                console.error = function(...args) {
                    const sanitized = args.map(arg => {
                        if (typeof arg === 'string') {
                            return arg
                                .replace(/(phone|password|credit.?card|wallet)=["']?([^"'\s]+)["']?/gi, '$1=***')
                                .replace(/(\+260|0)?(96|97|76|77|79)\d{7}/g, 'PHONE_REDACTED');
                        }
                        return arg;
                    });
                    originalError.apply(console, sanitized);
                };
                
                console.warn = originalWarn;
            }
        };

        // ============================================
        // ENHANCED CACHE MANAGEMENT
        // ============================================

        const CacheManager = {
            clearOldCache: function() {
                // Clear cache entries older than 7 days
                const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                
                // Clear search cache
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key.startsWith('search_')) {
                        try {
                            const cached = JSON.parse(localStorage.getItem(key));
                            if (cached && cached.timestamp && cached.timestamp < oneWeekAgo) {
                                localStorage.removeItem(key);
                            }
                        } catch (error) {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    if (key.startsWith('rate_limit_')) {
                        try {
                            const rateData = JSON.parse(localStorage.getItem(key));
                            if (rateData && rateData.timestamp && rateData.timestamp < oneWeekAgo) {
                                localStorage.removeItem(key);
                            }
                        } catch (error) {
                            localStorage.removeItem(key);
                        }
                    }
                }
            },
            
            optimizeLocalStorage: function() {
                // Prevent localStorage from exceeding quota
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                const calculateSize = () => {
                    let total = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        total += key.length + value.length;
                    }
                    return total;
                };
                
                const currentSize = calculateSize();
                
                if (currentSize > maxSize) {
                    // Remove oldest entries first
                    const entries = [];
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        
                        try {
                            const parsed = JSON.parse(value);
                            entries.push({
                                key,
                                timestamp: parsed.timestamp || 0,
                                size: key.length + value.length
                            });
                        } catch (error) {
                            entries.push({
                                key,
                                timestamp: 0,
                                size: key.length + value.length
                            });
                        }
                    }
                    
                    // Sort by timestamp (oldest first)
                    entries.sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Remove entries until under limit
                    let removedSize = 0;
                    for (const entry of entries) {
                        if (currentSize - removedSize <= maxSize * 0.8) break; // Leave 20% buffer
                        
                        localStorage.removeItem(entry.key);
                        removedSize += entry.size;
                    }
                }
            },
            
            init: function() {
                // Run cleanup once per day
                const lastCleanup = localStorage.getItem('last_cache_cleanup');
                const now = Date.now();
                
                if (!lastCleanup || now - parseInt(lastCleanup) > 24 * 60 * 60 * 1000) {
                    this.clearOldCache();
                    this.optimizeLocalStorage();
                    localStorage.setItem('last_cache_cleanup', now.toString());
                }
                
                // Run optimization on page load
                setTimeout(() => this.optimizeLocalStorage(), 5000);
            }
        };

        // ============================================
        // ENHANCED THEME SUPPORT
        // ============================================

        const ThemeManager = {
            currentTheme: 'light',
            
            init: function() {
                // Check for saved theme preference
                const savedTheme = localStorage.getItem('jubel_theme') || 'light';
                this.setTheme(savedTheme);
                
                // Watch for system theme changes
                const darkModeMedia = window.matchMedia('(prefers-color-scheme: dark)');
                darkModeMedia.addListener((e) => {
                    if (!localStorage.getItem('jubel_theme')) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
                
                // Add theme toggle button (optional - you can add this to your UI)
                this.addThemeToggle();
            },
            
            setTheme: function(theme) {
                this.currentTheme = theme;
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('jubel_theme', theme);
                
                // Update CSS variables based on theme
                this.updateThemeVariables(theme);
            },
            
            updateThemeVariables: function(theme) {
                const root = document.documentElement;
                
                if (theme === 'dark') {
                    root.style.setProperty('--white', '#1a1a1a');
                    root.style.setProperty('--off-white', '#2d2d2d');
                    root.style.setProperty('--light-gray', '#3d3d3d');
                    root.style.setProperty('--medium-gray', '#4d4d4d');
                    root.style.setProperty('--dark-gray', '#ffffff');
                    root.style.setProperty('--text-gray', '#cccccc');
                    root.style.setProperty('--text-light', '#aaaaaa');
                    root.style.setProperty('--border-color', '#4d4d4d');
                    root.style.setProperty('--light-orange', '#3d2719');
                    root.style.setProperty('--light-red', '#3d1a1a');
                } else {
                    // Reset to light theme defaults
                    root.style.setProperty('--white', '#FFFFFF');
                    root.style.setProperty('--off-white', '#F9F9F9');
                    root.style.setProperty('--light-gray', '#F5F5F5');
                    root.style.setProperty('--medium-gray', '#E0E0E0');
                    root.style.setProperty('--dark-gray', '#333333');
                    root.style.setProperty('--text-gray', '#666666');
                    root.style.setProperty('--text-light', '#888888');
                    root.style.setProperty('--border-color', '#EEEEEE');
                    root.style.setProperty('--light-orange', '#FFF5F0');
                    root.style.setProperty('--light-red', '#FCE8E6');
                }
            },
            
            addThemeToggle: function() {
                // Create theme toggle button
                const toggleBtn = document.createElement('button');
                toggleBtn.id = 'themeToggle';
                toggleBtn.className = 'theme-toggle';
                toggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
                toggleBtn.title = 'Toggle theme';
                toggleBtn.style.position = 'fixed';
                toggleBtn.style.bottom = '80px';
                toggleBtn.style.right = '20px';
                toggleBtn.style.zIndex = '1000';
                toggleBtn.style.width = '48px';
                toggleBtn.style.height = '48px';
                toggleBtn.style.borderRadius = '50%';
                toggleBtn.style.background = 'var(--primary-orange)';
                toggleBtn.style.color = 'white';
                toggleBtn.style.border = 'none';
                toggleBtn.style.boxShadow = 'var(--shadow-heavy)';
                toggleBtn.style.cursor = 'pointer';
                toggleBtn.style.display = 'flex';
                toggleBtn.style.alignItems = 'center';
                toggleBtn.style.justifyContent = 'center';
                toggleBtn.style.fontSize = '18px';
                
                toggleBtn.addEventListener('click', () => {
                    const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                    toggleBtn.innerHTML = newTheme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
                });
                
                document.body.appendChild(toggleBtn);
            }
        };

        // ============================================
        // ENHANCED PROGRESSIVE WEB APP FEATURES
        // ============================================

        const PWA = {
            init: function() {
                this.checkInstallPrompt();
                this.setupBeforeInstallPrompt();
                this.setupAppInstalledHandler();
                this.addToHomeScreenPrompt();
            },
            
            checkInstallPrompt: function() {
                // Check if app is running in standalone mode
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    console.log('Running in standalone mode');
                    AppState.isStandalone = true;
                    
                    // Add standalone-specific styles
                    this.addStandaloneStyles();
                }
            },
            
            setupBeforeInstallPrompt: function() {
                let deferredPrompt;
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    // Prevent Chrome 67 and earlier from automatically showing the prompt
                    e.preventDefault();
                    deferredPrompt = e;
                    
                    // Show install button
                    this.showInstallButton(deferredPrompt);
                });
            },
            
            showInstallButton: function(deferredPrompt) {
                // Create install button
                const installBtn = document.createElement('button');
                installBtn.id = 'installBtn';
                installBtn.className = 'install-button';
                installBtn.innerHTML = '<i class="fas fa-download"></i> Install App';
                installBtn.style.position = 'fixed';
                installBtn.style.bottom = '140px';
                installBtn.style.right = '20px';
                installBtn.style.zIndex = '1000';
                installBtn.style.padding = '12px 16px';
                installBtn.style.borderRadius = 'var(--button-radius)';
                installBtn.style.background = 'var(--primary-gradient)';
                installBtn.style.color = 'white';
                installBtn.style.border = 'none';
                installBtn.style.boxShadow = 'var(--shadow-heavy)';
                installBtn.style.cursor = 'pointer';
                installBtn.style.fontSize = '14px';
                installBtn.style.fontWeight = '600';
                installBtn.style.display = 'flex';
                installBtn.style.alignItems = 'center';
                installBtn.style.gap = '8px';
                
                installBtn.addEventListener('click', async () => {
                    // Hide the install button
                    installBtn.style.display = 'none';
                    
                    // Show the install prompt
                    deferredPrompt.prompt();
                    
                    // Wait for the user to respond to the prompt
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    // We've used the prompt, and can't use it again, discard it
                    deferredPrompt = null;
                    
                    if (outcome === 'accepted') {
                        UIUpdater.showToast('App installed successfully!', 'success');
                    }
                });
                
                document.body.appendChild(installBtn);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    if (installBtn.parentNode) {
                        installBtn.style.display = 'none';
                    }
                }, 10000);
            },
            
            setupAppInstalledHandler: function() {
                window.addEventListener('appinstalled', () => {
                    console.log('App was installed');
                    AppState.isStandalone = true;
                    this.addStandaloneStyles();
                    
                    // Remove install button if it exists
                    const installBtn = document.getElementById('installBtn');
                    if (installBtn && installBtn.parentNode) {
                        installBtn.parentNode.removeChild(installBtn);
                    }
                });
            },
            
            addToHomeScreenPrompt: function() {
                // Check if we should show "Add to Home Screen" prompt
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isSafari = navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome');
                
                if (isIOS && isSafari) {
                    // Show iOS install instructions
                    this.showIOSInstallInstructions();
                }
            },
            
            showIOSInstallInstructions: function() {
                // Check if we've shown this recently
                const lastShown = localStorage.getItem('ios_install_shown');
                const now = Date.now();
                
                if (lastShown && now - parseInt(lastShown) < 7 * 24 * 60 * 60 * 1000) {
                    return; // Shown within last week
                }
                
                // Create iOS install modal
                const modal = document.createElement('div');
                modal.className = 'ios-install-modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                modal.style.background = 'rgba(0,0,0,0.8)';
                modal.style.zIndex = '2000';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.padding = '20px';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: var(--card-radius); padding: 24px; max-width: 400px; text-align: center;">
                        <h3 style="margin-bottom: 16px; color: var(--dark-gray);">Install Jubel App</h3>
                        <p style="margin-bottom: 20px; color: var(--text-gray);">For the best experience, add Jubel to your home screen:</p>
                        <ol style="text-align: left; margin-bottom: 24px; color: var(--text-gray); padding-left: 20px;">
                            <li style="margin-bottom: 8px;">Tap the Share button <i class="fas fa-share-alt"></i></li>
                            <li style="margin-bottom: 8px;">Scroll down and tap "Add to Home Screen"</li>
                            <li style="margin-bottom: 8px;">Tap "Add" in the top right corner</li>
                        </ol>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button id="iosInstallLater" style="padding: 10px 20px; border: 2px solid var(--primary-orange); border-radius: var(--button-radius); background: white; color: var(--primary-orange); font-weight: 600; cursor: pointer;">Later</button>
                            <button id="iosInstallGotIt" style="padding: 10px 20px; border: none; border-radius: var(--button-radius); background: var(--primary-orange); color: white; font-weight: 600; cursor: pointer;">Got it!</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners
                document.getElementById('iosInstallLater').addEventListener('click', () => {
                    modal.remove();
                    localStorage.setItem('ios_install_shown', now.toString());
                });
                
                document.getElementById('iosInstallGotIt').addEventListener('click', () => {
                    modal.remove();
                    localStorage.setItem('ios_install_shown', now.toString());
                });
                
                // Auto-close after 15 seconds
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                        localStorage.setItem('ios_install_shown', now.toString());
                    }
                }, 15000);
            },
            
            addStandaloneStyles: function() {
                // Add styles specific to standalone mode
                const style = document.createElement('style');
                style.textContent = `
                    @media (display-mode: standalone) {
                        .top-bar {
                            padding-top: env(safe-area-inset-top);
                        }
                        
                        .main-panel {
                            padding-bottom: env(safe-area-inset-bottom);
                        }
                        
                        .sos-button {
                            bottom: calc(160px + env(safe-area-inset-bottom));
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        };

        // ============================================
        // ENHANCED MULTI-LANGUAGE SUPPORT
        // ============================================

        const LanguageManager = {
            currentLanguage: 'en',
            translations: {
                en: {
                    // Navigation
                    home: 'Home',
                    history: 'History',
                    account: 'Account',
                    emergency: 'Emergency',
                    
                    // Common
                    loading: 'Loading...',
                    error: 'Error',
                    success: 'Success',
                    warning: 'Warning',
                    cancel: 'Cancel',
                    confirm: 'Confirm',
                    save: 'Save',
                    close: 'Close',
                    
                    // Services
                    car: 'Car',
                    delivery: 'Delivery',
                    shortDelivery: 'Short Delivery',
                    express: 'Express Shopping',
                    truck: 'Truck',
                    
                    // Ride types
                    economy: 'Economy',
                    standard: 'Standard',
                    premium: 'Premium',
                    
                    // Status
                    requested: 'Requested',
                    accepted: 'Accepted',
                    arrived: 'Arrived',
                    started: 'Started',
                    completed: 'Completed',
                    cancelled: 'Cancelled',
                    
                    // Emergency
                    police: 'Police',
                    fire: 'Fire Brigade',
                    medical: 'Medical',
                    sos: 'SOS Emergency',
                    
                    // Wallet
                    balance: 'Balance',
                    deposit: 'Deposit',
                    withdraw: 'Withdraw',
                    transfer: 'Transfer',
                    
                    // Notifications
                    notifications: 'Notifications',
                    markAllRead: 'Mark all as read',
                    
                    // Search
                    search: 'Search',
                    recentSearches: 'Recent Searches',
                    clearRecent: 'Clear',
                    
                    // Fare
                    estimatedFare: 'Estimated Fare',
                    baseFare: 'Base Fare',
                    distance: 'Distance',
                    total: 'Total'
                },
                // Additional languages can be added here
                // fr: { ... },
                // es: { ... }
            },
            
            init: function() {
                // Detect browser language
                const browserLang = navigator.language.split('-')[0];
                this.currentLanguage = localStorage.getItem('jubel_language') || 
                                     (this.translations[browserLang] ? browserLang : 'en');
                
                this.applyLanguage();
                
                // Add language selector (optional)
                this.addLanguageSelector();
            },
            
            applyLanguage: function() {
                const lang = this.translations[this.currentLanguage];
                if (!lang) return;
                
                // Update all elements with data-i18n attribute
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (lang[key]) {
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            element.placeholder = lang[key];
                        } else {
                            element.textContent = lang[key];
                        }
                    }
                });
                
                // Update document title
                if (lang.appTitle) {
                    document.title = lang.appTitle;
                }
                
                // Update direction for RTL languages
                if (this.currentLanguage === 'ar' || this.currentLanguage === 'he') {
                    document.body.dir = 'rtl';
                } else {
                    document.body.dir = 'ltr';
                }
                
                // Save preference
                localStorage.setItem('jubel_language', this.currentLanguage);
            },
            
            setLanguage: function(langCode) {
                if (this.translations[langCode]) {
                    this.currentLanguage = langCode;
                    this.applyLanguage();
                    
                    // Announce language change to screen reader
                    Accessibility.announceToScreenReader(`Language changed to ${langCode}`);
                }
            },
            
            addLanguageSelector: function() {
                // Create language selector in more options dropdown
                const languageItem = document.createElement('div');
                languageItem.className = 'dropdown-item';
                languageItem.innerHTML = `
                    <div class="dropdown-icon">
                        <i class="fas fa-language"></i>
                    </div>
                    <div class="dropdown-text">
                        <div class="dropdown-title">Language</div>
                        <div class="dropdown-desc">Select language</div>
                    </div>
                `;
                
                languageItem.addEventListener('click', () => {
                    this.showLanguageSelector();
                });
                
                // Add to more options dropdown
                const dropdown = document.getElementById('moreOptionsDropdown');
                dropdown.appendChild(languageItem);
            },
            
            showLanguageSelector: function() {
                // Create language selection modal
                const modal = document.createElement('div');
                modal.className = 'language-modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                modal.style.background = 'rgba(0,0,0,0.5)';
                modal.style.zIndex = '2000';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.padding = '20px';
                
                const languages = [
                    { code: 'en', name: 'English', flag: '' },
                    { code: 'fr', name: 'Franais', flag: '' },
                    { code: 'es', name: 'Espaol', flag: '' },
                    { code: 'sw', name: 'Swahili', flag: '' },
                    { code: 'ny', name: 'Chichewa', flag: '' }
                ];
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: var(--card-radius); padding: 24px; max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="margin-bottom: 20px; color: var(--dark-gray);">Select Language</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${languages.map(lang => `
                                <button class="language-option ${lang.code === this.currentLanguage ? 'selected' : ''}" 
                                        data-lang="${lang.code}"
                                        style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid ${lang.code === this.currentLanguage ? 'var(--primary-orange)' : 'var(--border-color)'}; border-radius: var(--element-radius); background: ${lang.code === this.currentLanguage ? 'var(--light-orange)' : 'white'}; cursor: pointer; width: 100%;">
                                    <span style="font-size: 20px;">${lang.flag}</span>
                                    <span style="flex: 1; text-align: left; font-weight: ${lang.code === this.currentLanguage ? '600' : '400'}; color: var(--dark-gray);">
                                        ${lang.name}
                                    </span>
                                    ${lang.code === this.currentLanguage ? '<i class="fas fa-check" style="color: var(--primary-orange);"></i>' : ''}
                                </button>
                            `).join('')}
                        </div>
                        <button id="closeLanguageModal" style="margin-top: 20px; padding: 10px 20px; border: none; border-radius: var(--button-radius); background: var(--primary-orange); color: white; font-weight: 600; cursor: pointer; width: 100%;">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listeners
                modal.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const langCode = option.dataset.lang;
                        this.setLanguage(langCode);
                        modal.remove();
                    });
                });
                
                document.getElementById('closeLanguageModal').addEventListener('click', () => {
                    modal.remove();
                });
                
                // Close on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            },
            
            t: function(key) {
                return this.translations[this.currentLanguage]?.[key] || key;
            }
        };

        // ============================================
        // ENHANCED ANIMATION AND UX EFFECTS
        // ============================================

        const AnimationManager = {
            init: function() {
                this.setupPageTransitions();
                this.addLoadingAnimations();
                this.setupScrollAnimations();
                this.addHoverEffects();
            },
            
            setupPageTransitions: function() {
                // Smooth transitions between screens
                const originalSwitchScreen = window.switchScreen;
                window.switchScreen = function(screen) {
                    // Add fade out animation
                    const currentContent = document.getElementById(`${AppState.activeScreen}Content`) || 
                                         document.getElementById(`${AppState.activeScreen}Screen`);
                    
                    if (currentContent) {
                        currentContent.style.opacity = '0';
                        currentContent.style.transition = 'opacity 0.2s ease';
                        
                        setTimeout(() => {
                            originalSwitchScreen(screen);
                            
                            // Add fade in animation
                            const newContent = document.getElementById(`${screen}Content`) || 
                                             document.getElementById(`${screen}Screen`);
                            
                            if (newContent) {
                                newContent.style.opacity = '0';
                                newContent.style.transition = 'opacity 0.3s ease';
                                
                                // Trigger reflow
                                newContent.offsetHeight;
                                
                                newContent.style.opacity = '1';
                            }
                        }, 200);
                    } else {
                        originalSwitchScreen(screen);
                    }
                };
            },
            
            addLoadingAnimations: function() {
                // Add skeleton loading for content
                this.createSkeletonLoader();
                
                // Add loading animations for buttons
                document.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button && (button.classList.contains('btn-primary') || 
                                   button.classList.contains('btn-secondary') ||
                                   button.classList.contains('btn-danger'))) {
                        this.addButtonLoading(button);
                    }
                });
            },
            
            createSkeletonLoader: function() {
                // Create skeleton loader CSS
                const style = document.createElement('style');
                style.textContent = `
                    .skeleton {
                        background: linear-gradient(90deg, var(--light-gray) 25%, var(--medium-gray) 50%, var(--light-gray) 75%);
                        background-size: 200% 100%;
                        animation: loading 1.5s infinite;
                        border-radius: var(--element-radius);
                    }
                    
                    @keyframes loading {
                        0% { background-position: 200% 0; }
                        100% { background-position: -200% 0; }
                    }
                    
                    .skeleton-text {
                        height: 1em;
                        margin-bottom: 0.5em;
                    }
                    
                    .skeleton-button {
                        height: 44px;
                        width: 100%;
                    }
                    
                    .skeleton-card {
                        height: 100px;
                        margin-bottom: 10px;
                    }
                `;
                document.head.appendChild(style);
            },
            
            addButtonLoading: function(button) {
                const originalText = button.innerHTML;
                const originalWidth = button.offsetWidth;
                
                button.innerHTML = '<span class="loading"></span>';
                button.style.width = `${originalWidth}px`;
                button.disabled = true;
                
                // Store original content for restoration
                button.dataset.originalContent = originalText;
                
                // Auto-restore after 10 seconds (safety measure)
                setTimeout(() => {
                    if (button.disabled) {
                        this.removeButtonLoading(button);
                    }
                }, 10000);
            },
            
            removeButtonLoading: function(button) {
                if (button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                    button.style.width = '';
                    button.disabled = false;
                    delete button.dataset.originalContent;
                }
            },
            
            setupScrollAnimations: function() {
                // Add scroll animations for lists
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('animate-in');
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });
                
                // Observe history items, notification items, etc.
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(() => {
                        document.querySelectorAll('.history-item, .notification-item, .ride-type-card').forEach(el => {
                            observer.observe(el);
                        });
                    }, 1000);
                });
                
                // Add animation CSS
                const style = document.createElement('style');
                style.textContent = `
                    .history-item, .notification-item, .ride-type-card {
                        opacity: 0;
                        transform: translateY(20px);
                        transition: opacity 0.3s ease, transform 0.3s ease;
                    }
                    
                    .history-item.animate-in, 
                    .notification-item.animate-in, 
                    .ride-type-card.animate-in {
                        opacity: 1;
                        transform: translateY(0);
                    }
                    
                    .history-item:nth-child(n) {
                        transition-delay: calc(var(--item-index, 0) * 0.1s);
                    }
                `;
                document.head.appendChild(style);
            },
            
            addHoverEffects: function() {
                // Add ripple effect to buttons
                document.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button) {
                        this.createRippleEffect(button, e);
                    }
                });
            },
            
            createRippleEffect: function(button, event) {
                const ripple = document.createElement('span');
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                ripple.style.position = 'absolute';
                ripple.style.borderRadius = '50%';
                ripple.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                ripple.style.transform = 'scale(0)';
                ripple.style.animation = 'ripple 0.6s linear';
                ripple.style.pointerEvents = 'none';
                
                button.style.position = 'relative';
                button.style.overflow = 'hidden';
                button.appendChild(ripple);
                
                // Remove ripple after animation
                setTimeout(() => {
                    if (ripple.parentNode === button) {
                        button.removeChild(ripple);
                    }
                }, 600);
            }
        };

        // ============================================
        // FINAL INITIALIZATION
        // ============================================

        // Global variables
        let map, currentLocationMarker, pickupMarker, destinationMarker, driverMarker, routeLayer, emergencyMarkers = [];

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize core systems
                await initializeApp();
                
                // Initialize enhanced features
                Accessibility.init();
                PerformanceOptimizer.optimizeImageLoading();
                PerformanceOptimizer.debounceMapUpdates();
                Security.preventSensitiveDataLogging();
                CacheManager.init();
                ThemeManager.init();
                PWA.init();
                LanguageManager.init();
                AnimationManager.init();
                
                // Set up offline support
                setupOfflineSupport();
                
                // Set up real-time updates
                setupRealTimeUpdates();
                
                // Set up push notifications
                setupPushNotifications();
                
                // Set up analytics
                Analytics.trackEvent('app_launched', {
                    platform: navigator.platform,
                    userAgent: navigator.userAgent,
                    screenSize: `${window.innerWidth}x${window.innerHeight}`,
                    online: navigator.onLine
                });
                
                // Set up error boundary
                window.addEventListener('error', (event) => {
                    ErrorHandler.handleError(event.error, 'window_error');
                });
                
                window.addEventListener('unhandledrejection', (event) => {
                    ErrorHandler.handleError(event.reason, 'unhandled_promise_rejection');
                });
                
                // Set up periodic sync
                setInterval(() => {
                    CacheManager.optimizeLocalStorage();
                    ErrorHandler.syncOfflineErrors();
                }, 5 * 60 * 1000); // Every 5 minutes
                
                // Show welcome message
                setTimeout(() => {
                    UIUpdater.showToast('Welcome to Jubel! Ready to ride.', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                UIUpdater.showToast('Failed to initialize app. Please refresh.', 'error');
                
                // Try to recover
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            }
        });

        // Export useful functions to window for debugging
        window.AppState = AppState;
        window.UIUpdater = UIUpdater;
        window.FirebaseManager = FirebaseManager;
        window.PriceCalculator = PriceCalculator;
        window.EmergencyLocator = EmergencyLocator;
        
        // Helper functions for testing
        window.testRideRequest = async function() {
            if (!AppState.pickup || !AppState.destination) {
                UIUpdater.showToast('Please set pickup and destination first', 'warning');
                return;
            }
            
            const rideData = {
                passengerId: AppState.currentUser.uid,
                passengerName: 'Test User',
                pickup: 'Test Pickup',
                destination: 'Test Destination',
                rideType: 'standard',
                fare: 25.00,
                distance: 5.0,
                paymentMethod: 'cash'
            };
            
            try {
                await FirebaseManager.requestRide(rideData);
                UIUpdater.showToast('Test ride requested', 'success');
            } catch (error) {
                UIUpdater.showToast('Test failed: ' + error.message, 'error');
            }
        };
        
        window.testEmergency = function() {
            EmergencyLocator.showEmergencyMarkers('police');
            UIUpdater.showToast('Emergency markers shown', 'info');
        };
        
        window.testNotification = function() {
            FirebaseManager.sendNotification(
                AppState.currentUser.uid,
                'Test Notification',
                'This is a test notification',
                'info'
            );
        };
        
        window.clearAllData = function() {
            if (confirm('Are you sure you want to clear all local data?')) {
                localStorage.clear();
                sessionStorage.clear();
                UIUpdater.showToast('All local data cleared', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        };

        // ============================================
        // SERVICE WORKER REGISTRATION
        // ============================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js').then(
                    function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('ServiceWorker update found!');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New update available
                                    UIUpdater.showToast('New version available. Refresh to update.', 'info');
                                }
                            });
                        });
                    },
                    function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    }
                );
            });
        }

        // ============================================
        // NETWORK STATUS MONITORING
        // ============================================

        let isOnline = navigator.onLine;
        
        window.addEventListener('online', () => {
            isOnline = true;
            UIUpdater.showToast('Back online. Syncing...', 'success');
            
            // Sync any pending data
            syncOfflineData();
            ErrorHandler.syncOfflineErrors();
            
            // Update UI
            document.body.classList.remove('offline');
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            UIUpdater.showToast('You are offline. Some features may be limited.', 'warning');
            
            // Update UI
            document.body.classList.add('offline');
        });
        
        // Add offline indicator CSS
        const offlineStyle = document.createElement('style');
        offlineStyle.textContent = `
            .offline .online-only {
                opacity: 0.5;
                pointer-events: none;
            }
            
            .offline-indicator {
                position: fixed;
                top: 60px;
                left: 0;
                right: 0;
                background: var(--warning-yellow);
                color: var(--dark-gray);
                text-align: center;
                padding: 8px;
                font-size: 12px;
                font-weight: 600;
                z-index: 1000;
                animation: slideDown 0.3s ease;
            }
        `;
        document.head.appendChild(offlineStyle);

        // ============================================
        // PERFORMANCE MONITORING
        // ============================================

        const PerformanceMonitor = {
            metrics: {
                pageLoadTime: 0,
                firstContentfulPaint: 0,
                largestContentfulPaint: 0,
                cumulativeLayoutShift: 0
            },
            
            init: function() {
                this.measurePageLoad();
                this.setupPerformanceObserver();
                this.monitorMemoryUsage();
            },
            
            measurePageLoad: function() {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const timing = performance.timing;
                        this.metrics.pageLoadTime = timing.loadEventEnd - timing.navigationStart;
                        
                        // Log to Firebase
                        database.ref(`performance/${AppState.currentUser?.uid}/${Date.now()}`).set({
                            pageLoadTime: this.metrics.pageLoadTime,
                            userAgent: navigator.userAgent,
                            connection: navigator.connection?.effectiveType || 'unknown'
                        }).catch(console.error);
                    }, 0);
                });
            },
            
            setupPerformanceObserver: function() {
                // Observe Largest Contentful Paint
                if ('PerformanceObserver' in window) {
                    try {
                        const paintObserver = new PerformanceObserver((entryList) => {
                            const entries = entryList.getEntries();
                            const lastEntry = entries[entries.length - 1];
                            this.metrics.largestContentfulPaint = lastEntry.renderTime || lastEntry.loadTime;
                        });
                        
                        paintObserver.observe({ entryTypes: ['largest-contentful-paint'] });
                        
                        // Observe Cumulative Layout Shift
                        const layoutShiftObserver = new PerformanceObserver((entryList) => {
                            for (const entry of entryList.getEntries()) {
                                if (!entry.hadRecentInput) {
                                    this.metrics.cumulativeLayoutShift += entry.value;
                                }
                            }
                        });
                        
                        layoutShiftObserver.observe({ entryTypes: ['layout-shift'] });
                        
                    } catch (error) {
                        console.error('PerformanceObserver error:', error);
                    }
                }
            },
            
            monitorMemoryUsage: function() {
                if ('memory' in performance) {
                    setInterval(() => {
                        const memory = performance.memory;
                        if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.8) {
                            console.warn('High memory usage detected:', memory);
                            // Trigger garbage collection if possible
                            if (window.gc) {
                                window.gc();
                            }
                        }
                    }, 30000); // Check every 30 seconds
                }
            },
            
            reportMetrics: function() {
                return {
                    ...this.metrics,
                    timestamp: Date.now(),
                    userId: AppState.currentUser?.uid
                };
            }
        };

        // Initialize performance monitoring
        PerformanceMonitor.init();

        // ============================================
        // FINAL EXPORTS AND CLEANUP
        // ============================================

        // Make sure all intervals and timeouts are cleaned up on page unload
        window.addEventListener('beforeunload', () => {
            // Clean up map layers
            if (map) {
                map.remove();
            }
            
            // Revoke object URLs
            PerformanceOptimizer.imageCache.forEach(url => {
                URL.revokeObjectURL(url);
            });
            
            // Disconnect Firebase listeners
            if (AppState.currentUser) {
                database.ref(`users/${AppState.currentUser.uid}/walletBalance`).off();
                database.ref('rides').off();
                database.ref(`notifications/${AppState.currentUser.uid}`).off();
                
                if (AppState.currentRide?.id) {
                    database.ref(`rides/${AppState.currentRide.id}`).off();
                    database.ref(`chats/${AppState.currentRide.id}/messages`).off();
                }
                
                if (AppState.currentRide?.driverId) {
                    database.ref(`driverLocations/${AppState.currentRide.driverId}`).off();
                }
            }
            
            // Disconnect socket
            if (AppState.socket) {
                AppState.socket.disconnect();
            }
            
            // Log app session end
            Analytics.trackEvent('app_session_end', {
                session_duration: Date.now() - (AppState.sessionStart || Date.now()),
                screens_visited: AppState.screensVisited || [],
                rides_requested: AppState.ridesRequested || 0
            });
        });

        // Track session start
        AppState.sessionStart = Date.now();
        AppState.screensVisited = ['home'];
        AppState.ridesRequested = 0;

        // Track screen visits
        const originalSwitchScreen = window.switchScreen;
        window.switchScreen = function(screen) {
            originalSwitchScreen(screen);
            
            if (!AppState.screensVisited.includes(screen)) {
                AppState.screensVisited.push(screen);
            }
            
            Analytics.trackEvent('screen_view', {
                screen_name: screen,
                previous_screen: AppState.activeScreen
            });
        };

        // Track ride requests
        const originalRequestRide = FirebaseManager.requestRide;
        FirebaseManager.requestRide = async function(rideData) {
            AppState.ridesRequested = (AppState.ridesRequested || 0) + 1;
            
            Analytics.trackEvent('ride_request_attempt', {
                service_type: rideData.serviceType || 'car',
                ride_type: rideData.rideType,
                estimated_fare: rideData.fare,
                distance: rideData.distance
            });
            
            return originalRequestRide.call(this, rideData);
        };

        // ============================================
        // APP IS NOW FULLY INITIALIZED
        // ============================================

        console.log(' Jubel Passenger App initialized successfully!');
        console.log('App State:', AppState);
        console.log('User:', AppState.currentUser);
        console.log('Location:', AppState.userLocation);
        console.log('Balance:', AppState.walletBalance);

        // Final readiness check
        setTimeout(() => {
            if (AppState.currentUser && AppState.userLocation) {
                console.log(' App is ready for use');
                
                // Hide any remaining loading indicators
                UIUpdater.hideLoading();
                
                // Check for updates
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'CHECK_FOR_UPDATES'
                    });
                }
            }
        }, 3000);

    </script>
</body>
</html>
