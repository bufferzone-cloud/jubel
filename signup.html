<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All existing CSS styles remain unchanged */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 10px;
            --element-radius: 6px;
            --transition-speed: 0.3s;
            --ambulance-blue: #0066cc;
            --fire-truck-red: #cc0000;
            --premium-gold: #FFD700;
            --economy-green: #27ae60;
            --light-truck-brown: #8B4513;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 13px;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.75rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 15px 15px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        
        .panel-collapse-handle {
            width: 35px;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 8px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 3px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.6rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.8rem;
        }
        
        /* NEW: More Options Button */
        .more-options-btn {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--primary-orange);
            color: var(--white);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .more-options-dropdown {
            display: none;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-top: 5px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }
        
        .more-options-dropdown.active {
            display: block;
        }
        
        .more-option-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-speed) ease;
        }
        
        .more-option-item:hover {
            background: var(--light-orange);
        }
        
        .more-option-item:last-child {
            border-bottom: none;
        }
        
        .more-option-icon {
            width: 20px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .more-option-text {
            flex: 1;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* NEW: Order for Someone Else Form */
        .order-for-someone-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .order-for-someone-form.active {
            display: flex;
        }
        
        /* NEW: Express Delivery Form */
        .express-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .express-delivery-form.active {
            display: flex;
        }
        
        /* NEW: SOS Setup Form */
        .sos-setup-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .sos-setup-form.active {
            display: flex;
        }
        
        /* NEW: Schedule Ride Form */
        .schedule-ride-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .schedule-ride-form.active {
            display: flex;
        }
        
        /* NEW: Schedule Delivery Form */
        .schedule-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .schedule-delivery-form.active {
            display: flex;
        }
        
        /* NEW: Emergency Services Form */
        .emergency-services-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .emergency-services-form.active {
            display: flex;
        }
        
        /* NEW: Emergency Questionnaire */
        .emergency-questionnaire {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-red);
        }
        
        .emergency-questionnaire.active {
            display: flex;
        }
        
        /* NEW: Ride Type Selection Modal */
        .ride-type-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            padding: 15px;
        }
        
        .ride-type-modal.active {
            display: block;
        }
        
        .ride-type-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .ride-type-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .ride-type-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .ride-type-option.premium {
            border-color: var(--premium-gold);
            background: linear-gradient(135deg, #FFF9E6, #FFE680);
        }
        
        .ride-type-option.standard {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .ride-type-option.economy {
            border-color: var(--economy-green);
            background: #E8F6EF;
        }
        
        .ride-type-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .ride-type-option.premium .ride-type-icon {
            background: var(--premium-gold);
            color: var(--dark-gray);
        }
        
        .ride-type-option.standard .ride-type-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .ride-type-option.economy .ride-type-icon {
            background: var(--economy-green);
            color: var(--white);
        }
        
        .ride-type-details {
            flex: 1;
        }
        
        .ride-type-name {
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .ride-type-description {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-top: 2px;
        }
        
        .ride-type-price {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* NEW: Emergency Vehicle Options */
        .emergency-vehicle-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .emergency-vehicle-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            text-align: center;
        }
        
        .emergency-vehicle-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-vehicle-option.ambulance {
            border-color: var(--ambulance-blue);
            background: #E6F2FF;
        }
        
        .emergency-vehicle-option.fire-truck {
            border-color: var(--fire-truck-red);
            background: #FFE6E6;
        }
        
        .emergency-vehicle-option.emergency-ride {
            border-color: var(--warning-yellow);
            background: #FFF3E0;
        }
        
        .emergency-vehicle-option.emergency-delivery {
            border-color: var(--light-truck-brown);
            background: #F5E6D3;
        }
        
        .emergency-vehicle-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .emergency-vehicle-option.ambulance .emergency-vehicle-icon {
            background: var(--ambulance-blue);
            color: white;
        }
        
        .emergency-vehicle-option.fire-truck .emergency-vehicle-icon {
            background: var(--fire-truck-red);
            color: white;
        }
        
        .emergency-vehicle-option.emergency-ride .emergency-vehicle-icon {
            background: var(--warning-yellow);
            color: var(--dark-gray);
        }
        
        .emergency-vehicle-option.emergedy-delivery .emergency-vehicle-icon {
            background: var(--light-truck-brown);
            color: white;
        }
        
        .emergency-vehicle-name {
            font-weight: 700;
            font-size: 0.85rem;
        }
        
        .emergency-vehicle-description {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        /* NEW: Countdown Timer */
        .countdown-timer {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 15px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            display: none;
            font-weight: 700;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .countdown-timer.active {
            display: block;
        }
        
        .countdown-text {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .countdown-time {
            font-size: 1rem;
            font-weight: 800;
            margin: 2px 0;
        }
        
        /* NEW: Receipt Modal */
        .receipt-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            padding: 15px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .receipt-modal.active {
            display: block;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .receipt-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .receipt-details {
            margin-bottom: 15px;
        }
        
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .receipt-row:last-child {
            border-bottom: none;
        }
        
        .receipt-label {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .receipt-value {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .receipt-total {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin: 15px 0;
        }
        
        .receipt-total .receipt-row {
            border-bottom: none;
        }
        
        .receipt-total .receipt-label {
            font-size: 0.9rem;
        }
        
        .receipt-total .receipt-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .receipt-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* NEW: Light Truck Delivery Form */
        .light-truck-delivery-form {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .light-truck-delivery-form.active {
            display: flex;
        }
        
        /* NEW: Delivery Mode Selection */
        .delivery-mode-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin: 8px 0;
        }
        
        .delivery-mode-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .delivery-mode-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .delivery-mode-option.light-truck {
            border-color: var(--light-truck-brown);
            background: #F5E6D3;
        }
        
        .delivery-mode-option.light-truck.selected {
            border-color: var(--light-truck-brown);
            background: #E8D0B3;
        }
        
        .delivery-mode-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .delivery-mode-option.selected .delivery-mode-icon {
            color: var(--primary-orange);
        }
        
        .delivery-mode-option.light-truck.selected .delivery-mode-icon {
            color: var(--light-truck-brown);
        }
        
        .delivery-mode-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .delivery-mode-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* NEW: SOS Button */
        .sos-button {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--error-red);
            color: var(--white);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: var(--shadow-heavy);
            z-index: 150;
            cursor: pointer;
            animation: sos-pulse 2s infinite;
            display: none;
        }
        
        @keyframes sos-pulse {
            0% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
            100% {
                transform: translateX(-50%) scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }
        
        /* NEW: Delivery Fee Display - Hidden by default */
        .delivery-fee-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            display: none;
        }
        
        .delivery-fee-display.active {
            display: block;
        }
        
        .delivery-fee-amount {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .delivery-eta-display {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        /* All other existing CSS styles remain unchanged */
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.8rem;
        }
        
        /* Updated: Vehicle Selection - Hidden by default */
        .vehicle-selection {
            display: none;
            gap: 6px;
            margin: 8px 0;
        }
        
        .vehicle-selection.active {
            display: flex;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 4px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* Updated: Fare Display - Hidden by default */
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .fare-display.active {
            display: block;
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 4px 0;
        }
        
        .eta-display {
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .promo-section {
            margin-top: 8px;
            padding: 8px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 6px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 6px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 8px;
            box-shadow: var(--shadow-medium);
            display: none;
        }
        
        .request-ride-btn.active {
            display: block;
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .driver-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.85rem;
            margin-bottom: 2px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.7rem;
        }
        
        .trip-details {
            margin-bottom: 10px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 5px;
            margin-bottom: 8px;
        }
        
        .location-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.8rem;
            border-top: 1px solid var(--border-color);
            padding-top: 5px;
            margin-top: 5px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .btn {
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .back-button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        
        .screen-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .payments-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .input-group {
            margin-bottom: 8px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .input-field {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 10px;
        }
        
        .balance-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .balance-amount-large {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 6px;
            font-size: 0.7rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* UPDATED: Replaced Payment Methods with Emergency Services */
        .emergency-services-section {
            margin-top: 10px;
        }
        
        .emergency-service {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .emergency-service:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .emergency-service.ambulance {
            border-color: var(--ambulance-blue);
            background: #E6F2FF;
        }
        
        .emergency-service.fire-truck {
            border-color: var(--fire-truck-red);
            background: #FFE6E6;
        }
        
        .emergency-service.emergency-ride {
            border-color: var(--warning-yellow);
            background: #FFF3E0;
        }
        
        .emergency-service.emergency-delivery {
            border-color: var(--light-truck-brown);
            background: #F5E6D3;
        }
        
        .emergency-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .emergency-service.ambulance .emergency-icon {
            background: var(--ambulance-blue);
            color: white;
        }
        
        .emergency-service.fire-truck .emergency-icon {
            background: var(--fire-truck-red);
            color: white;
        }
        
        .emergency-service.emergency-ride .emergency-icon {
            background: var(--warning-yellow);
            color: var(--dark-gray);
        }
        
        .emergency-service.emergency-delivery .emergency-icon {
            background: var(--light-truck-brown);
            color: white;
        }
        
        .emergency-details {
            flex: 1;
        }
        
        .emergency-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .emergency-info {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 5px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 8px 14px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.75rem;
            max-width: 80%;
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 4px;
            border-radius: 6px;
            margin-top: 3px;
            font-size: 8px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* NEW: Emergency Vehicle Markers */
        .ambulance-marker {
            background: var(--ambulance-blue);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .fire-truck-marker {
            background: var(--fire-truck-red);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 50px;
            right: 10px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.75rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 6px;
            margin: 8px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.65rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 180px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.65rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.55rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 15px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 8px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 8px 0;
        }
        
        .code {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.65rem;
            color: var(--medium-gray);
            margin-top: 4px;
        }
        
        .contact-section {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        .star {
            font-size: 1.3rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 700px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 12px;
        }
        
        .popup-map-container {
            height: 180px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .detail-value {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        
        /* Payment Selection Popup Styles */
        .payment-selection-popup {
            max-width: 350px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .payment-option-balance {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 12px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }
        
        /* Package Delivery Form Styles */
        .package-form {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            display: none;
        }
        
        .package-form.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 0.7rem;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.7rem;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 50px;
        }
        
        .package-toggle {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .driver-details-header h3 {
            font-size: 0.85rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            font-size: 0.65rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        /* Enhanced History Item Styles */
        .history-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 8px;
            margin-bottom: 4px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-item-type.emergency {
            background: #FFE6E6;
            color: #c62828;
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 6px;
            border-radius: var(--element-radius);
            margin: 6px 0;
            font-size: 0.65rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.55rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        /* Driver Search Animation */
        .searching-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .searching-pulse {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
            position: relative;
        }
        
        .searching-pulse-inner {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .searching-text {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            font-weight: 600;
            color: var(--primary-orange);
            box-shadow: var(--shadow-medium);
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            80%, 100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        /* NEW: Receipt Download Button */
        .download-receipt-btn {
            background: var(--success-green);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all var(--transition-speed) ease;
        }
        
        .download-receipt-btn:hover {
            background: #27ae60;
        }
        
        /* NEW: Emergency Ride Status */
        .emergency-ride-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--error-red);
            color: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: none;
            font-weight: 700;
            font-size: 0.8rem;
            animation: emergency-pulse 1s infinite;
        }
        
        @keyframes emergency-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* NEW: Light Truck Icon */
        .fa-truck-pickup:before {
            content: "\f63b";
        }
        
        .fa-ambulance:before {
            content: "\f0f9";
        }
        
        .fa-fire-truck:before {
            content: "\f692";
        }
        
        .fa-truck-medical:before {
            content: "\f0f9";
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 5px 7px;
                font-size: 0.65rem;
            }
            
            .passenger-panel {
                padding: 8px;
            }
            
            .nav-buttons {
                gap: 3px;
            }
            
            .nav-btn {
                padding: 5px 2px;
                font-size: 0.55rem;
            }
            
            .emergency-vehicle-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance (Only on Home Screen) -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status (Only on Home Screen) -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Emergency Ride Status -->
        <div class="emergency-ride-status" id="emergencyRideStatus">
            <i class="fas fa-exclamation-triangle"></i>
            <span>EMERGENCY RIDE IN PROGRESS</span>
        </div>
        
        <!-- Estimated Time (Only on Home Screen) -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- NEW: Countdown Timer -->
        <div class="countdown-timer" id="countdownTimer">
            <div class="countdown-text">Scheduled Ride In:</div>
            <div class="countdown-time" id="countdownTime">00:00:00</div>
        </div>
        
        <!-- NEW: SOS Button -->
        <div class="sos-button" id="sosButton">
            SOS
        </div>
        
        <!-- NEW: Ride Type Selection Modal -->
        <div class="ride-type-modal" id="rideTypeModal">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-car"></i>
                    Select Ride Type
                </h2>
                <button class="close-popup" id="closeRideTypeModal">&times;</button>
            </div>
            <div class="popup-content">
                <div class="ride-type-options">
                    <div class="ride-type-option premium" data-type="premium">
                        <div class="ride-type-icon">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Premium Ride</div>
                            <div class="ride-type-description">Luxury vehicles with premium service</div>
                        </div>
                        <div class="ride-type-price">+50%</div>
                    </div>
                    
                    <div class="ride-type-option standard" data-type="standard">
                        <div class="ride-type-icon">
                            <i class="fas fa-car"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Standard Ride</div>
                            <div class="ride-type-description">Comfortable and reliable service</div>
                        </div>
                        <div class="ride-type-price">Base Price</div>
                    </div>
                    
                    <div class="ride-type-option economy" data-type="economy">
                        <div class="ride-type-icon">
                            <i class="fas fa-car-side"></i>
                        </div>
                        <div class="ride-type-details">
                            <div class="ride-type-name">Economy Ride</div>
                            <div class="ride-type-description">Budget-friendly option</div>
                        </div>
                        <div class="ride-type-price">-30%</div>
                    </div>
                </div>
                <button class="confirm-payment-btn" id="selectRideTypeBtn">
                    Select Ride Type
                </button>
            </div>
        </div>
        
        <!-- NEW: Receipt Modal -->
        <div class="receipt-modal" id="receiptModal">
            <div class="receipt-header">
                <h2 class="receipt-title">JUBEL RIDE RECEIPT</h2>
                <div style="font-size: 0.7rem; color: var(--medium-gray);" id="receiptDate"></div>
            </div>
            <div class="receipt-details">
                <div class="receipt-row">
                    <span class="receipt-label">Receipt No:</span>
                    <span class="receipt-value" id="receiptNumber"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Passenger:</span>
                    <span class="receipt-value" id="receiptPassenger"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Driver:</span>
                    <span class="receipt-value" id="receiptDriver"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Vehicle:</span>
                    <span class="receipt-value" id="receiptVehicle"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Pickup:</span>
                    <span class="receipt-value" id="receiptPickup"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Destination:</span>
                    <span class="receipt-value" id="receiptDestination"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Distance:</span>
                    <span class="receipt-value" id="receiptDistance"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Ride Type:</span>
                    <span class="receipt-value" id="receiptRideType"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Ride Time:</span>
                    <span class="receipt-value" id="receiptRideTime"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Payment Method:</span>
                    <span class="receipt-value" id="receiptPaymentMethod"></span>
                </div>
            </div>
            <div class="receipt-total">
                <div class="receipt-row">
                    <span class="receipt-label">Base Fare:</span>
                    <span class="receipt-value" id="receiptBaseFare"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Distance Fare:</span>
                    <span class="receipt-value" id="receiptDistanceFare"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Discount:</span>
                    <span class="receipt-value" id="receiptDiscount"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">TOTAL:</span>
                    <span class="receipt-value" id="receiptTotal"></span>
                </div>
            </div>
            <div class="receipt-actions">
                <button class="download-receipt-btn" id="downloadReceiptBtn">
                    <i class="fas fa-download"></i>
                    Download Receipt
                </button>
                <button class="btn btn-primary" id="closeReceiptBtn">
                    <i class="fas fa-times"></i>
                    Close
                </button>
            </div>
        </div>
        
        <!-- Driver Search Animation -->
        <div class="searching-animation" id="searchingAnimation">
            <div class="searching-pulse">
                <div class="searching-pulse-inner">
                    <i class="fas fa-car"></i>
                </div>
            </div>
            <div class="searching-text">Searching for driver</div>
        </div>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="emergency">
                    <i class="fas fa-ambulance"></i>
                    <span>Emergency</span>
                </button>
            </div>
            
            <!-- NEW: More Options Button -->
            <button class="more-options-btn" id="moreOptionsBtn">
                <i class="fas fa-ellipsis-h"></i>
                More Options
            </button>
            
            <!-- NEW: More Options Dropdown -->
            <div class="more-options-dropdown" id="moreOptionsDropdown">
                <div class="more-option-item" data-option="order-for-someone">
                    <div class="more-option-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="more-option-text">Order for Someone Else</div>
                </div>
                <div class="more-option-item" data-option="express-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="more-option-text">Express Delivery</div>
                </div>
                <div class="more-option-item" data-option="light-truck-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-truck-pickup"></i>
                    </div>
                    <div class="more-option-text">Light Truck Delivery</div>
                </div>
                <div class="more-option-item" data-option="schedule-ride">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="more-option-text">Schedule Ride</div>
                </div>
                <div class="more-option-item" data-option="schedule-delivery">
                    <div class="more-option-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="more-option-text">Schedule Delivery</div>
                </div>
                <div class="more-option-item" data-option="sos-setup">
                    <div class="more-option-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="more-option-text">SOS Setup</div>
                </div>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- NEW: Order for Someone Else Form -->
                <div class="order-for-someone-form" id="orderForSomeoneForm">
                    <h4 class="section-title">Order for Someone Else</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="recipientPickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="recipientPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="recipientDestinationLocation" placeholder="Drop-off location">
                        <div class="suggestion-list" id="recipientDestinationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientName">Recipient's Full Name</label>
                        <input type="text" id="recipientName" class="input-field" placeholder="Full name">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientEmail">Recipient's Email</label>
                        <input type="email" id="recipientEmail" class="input-field" placeholder="Email address">
                    </div>
                    
                    <div class="input-group">
                        <label for="recipientPhone">Recipient's Phone Number</label>
                        <input type="tel" id="recipientPhone" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="delivery-fee-display" id="recipientDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="recipientDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="recipientEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="orderForSomeoneBtn">Book Ride</button>
                    <button class="btn btn-cancel" id="cancelOrderForSomeoneBtn">Cancel</button>
                </div>
                
                <!-- NEW: Express Delivery Form -->
                <div class="express-delivery-form" id="expressDeliveryForm">
                    <h4 class="section-title">Express Delivery</h4>
                    
                    <div class="input-group">
                        <label for="shopName">Shop or Restaurant Name</label>
                        <input type="text" id="shopName" class="input-field" placeholder="Name of shop or restaurant">
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="shopLocation" placeholder="Shop location">
                        <div class="suggestion-list" id="shopLocationSuggestions"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryItems">Items to Purchase</label>
                        <textarea id="deliveryItems" class="input-field" placeholder="List of items to be purchased"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryAmount">Total Amount to Spend (K)</label>
                        <input type="number" id="deliveryAmount" class="input-field" placeholder="Total amount">
                    </div>
                    
                    <div class="input-group">
                        <label for="deliveryInstructions">Special Instructions</label>
                        <textarea id="deliveryInstructions" class="input-field" placeholder="Any special instructions"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="deliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="deliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="delivery-mode-selection">
                        <div class="delivery-mode-option" data-type="car">
                            <i class="fas fa-car delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Car</span>
                            <span class="delivery-mode-price">Fast & Secure</span>
                        </div>
                        <div class="delivery-mode-option selected" data-type="bike">
                            <i class="fas fa-motorcycle delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Bike</span>
                            <span class="delivery-mode-price">Quick Delivery</span>
                        </div>
                        <div class="delivery-mode-option" data-type="bicycle">
                            <i class="fas fa-bicycle delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Bicycle</span>
                            <span class="delivery-mode-price">Eco Friendly</span>
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display" id="expressDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="expressDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="expressDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="expressDeliveryBtn">Request Delivery</button>
                    <button class="btn btn-cancel" id="cancelExpressDeliveryBtn">Cancel</button>
                </div>
                
                <!-- NEW: Light Truck Delivery Form -->
                <div class="light-truck-delivery-form" id="lightTruckDeliveryForm">
                    <h4 class="section-title">Light Truck Delivery</h4>
                    
                    <div class="input-group">
                        <label for="truckPickupLocation">Pickup Location</label>
                        <input type="text" id="truckPickupLocation" class="input-field" placeholder="Where to pick up items">
                    </div>
                    
                    <div class="input-group">
                        <label for="truckDestination">Delivery Destination</label>
                        <input type="text" id="truckDestination" class="input-field" placeholder="Where to deliver items">
                    </div>
                    
                    <div class="input-group">
                        <label for="truckItemDescription">Items Description</label>
                        <textarea id="truckItemDescription" class="input-field" placeholder="Describe items to be transported"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="truckItemWeight">Approx. Weight (kg)</label>
                            <input type="number" id="truckItemWeight" class="input-field" placeholder="Weight">
                        </div>
                        <div class="form-group">
                            <label for="truckItemDimensions">Dimensions (LxWxH)</label>
                            <input type="text" id="truckItemDimensions" class="input-field" placeholder="e.g., 2x1x1">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="truckSpecialRequirements">Special Requirements</label>
                        <textarea id="truckSpecialRequirements" class="input-field" placeholder="Any special handling requirements"></textarea>
                    </div>
                    
                    <div class="delivery-fee-display" id="lightTruckDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="lightTruckDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="lightTruckEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="lightTruckDeliveryBtn">Request Light Truck</button>
                    <button class="btn btn-cancel" id="cancelLightTruckDeliveryBtn">Cancel</button>
                </div>
                
                <!-- NEW: SOS Setup Form -->
                <div class="sos-setup-form" id="sosSetupForm">
                    <h4 class="section-title">SOS Setup</h4>
                    
                    <div class="input-group">
                        <label for="emergencyContact1">Emergency Contact 1</label>
                        <input type="tel" id="emergencyContact1" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyContact2">Emergency Contact 2</label>
                        <input type="tel" id="emergencyContact2" class="input-field" placeholder="Phone number">
                    </div>
                    
                    <div class="input-group">
                        <label for="sosMessage">Emergency Message</label>
                        <textarea id="sosMessage" class="input-field" placeholder="Pre-typed emergency message">I need help! My current location and ride details will be shared with you.</textarea>
                    </div>
                    
                    <button class="request-ride-btn" id="saveSosBtn">Save SOS Configuration</button>
                    <button class="btn btn-cancel" id="cancelSosSetupBtn">Cancel</button>
                </div>
                
                <!-- NEW: Schedule Ride Form -->
                <div class="schedule-ride-form" id="scheduleRideForm">
                    <h4 class="section-title">Schedule a Ride</h4>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="schedulePickupLocation" placeholder="Pickup location">
                        <div class="suggestion-list" id="schedulePickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDestinationLocation" placeholder="Destination">
                        <div class="suggestion-list" id="scheduleDestinationSuggestions"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDate">Date</label>
                            <input type="date" id="scheduleDate" class="input-field" min="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <div class="form-group">
                            <label for="scheduleTime">Time</label>
                            <input type="time" id="scheduleTime" class="input-field">
                        </div>
                    </div>
                    
                    <div class="fare-display" id="scheduleRideFareDisplay">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="scheduleRideFare">K0.00</div>
                        <p class="eta-display" id="scheduleRideEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleRideBtn">Schedule Ride</button>
                    <button class="btn btn-cancel" id="cancelScheduleRideBtn">Cancel</button>
                </div>
                
                <!-- NEW: Schedule Delivery Form -->
                <div class="schedule-delivery-form" id="scheduleDeliveryForm">
                    <h4 class="section-title">Schedule a Delivery</h4>
                    
                    <div class="input-group">
                        <label for="scheduleDeliveryItems">Items to Deliver</label>
                        <textarea id="scheduleDeliveryItems" class="input-field" placeholder="Describe items to be delivered"></textarea>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="scheduleDeliveryPickup" placeholder="Pickup location">
                        <div class="suggestion-list" id="scheduleDeliveryPickupSuggestions"></div>
                    </div>
                    
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="scheduleDeliveryDestination" placeholder="Delivery destination">
                        <div class="suggestion-list" id="scheduleDeliveryDestinationSuggestions"></div>
                    </div>
                    
                    <div class="delivery-mode-selection">
                        <div class="delivery-mode-option" data-type="car">
                            <i class="fas fa-car delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Car</span>
                            <span class="delivery-mode-price">Standard</span>
                        </div>
                        <div class="delivery-mode-option selected" data-type="bike">
                            <i class="fas fa-motorcycle delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Bike</span>
                            <span class="delivery-mode-price">Fast</span>
                        </div>
                        <div class="delivery-mode-option" data-type="light-truck">
                            <i class="fas fa-truck-pickup delivery-mode-icon"></i>
                            <span class="delivery-mode-name">Light Truck</span>
                            <span class="delivery-mode-price">Large Items</span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduleDeliveryDate">Date</label>
                            <input type="date" id="scheduleDeliveryDate" class="input-field" min="<?php echo date('Y-m-d'); ?>">
                        </div>
                        <div class="form-group">
                            <label for="scheduleDeliveryTime">Time</label>
                            <input type="time" id="scheduleDeliveryTime" class="input-field">
                        </div>
                    </div>
                    
                    <div class="delivery-fee-display" id="scheduleDeliveryFeeDisplay">
                        <p>Delivery Fee</p>
                        <div class="delivery-fee-amount" id="scheduleDeliveryFee">K0.00</div>
                        <p class="delivery-eta-display" id="scheduleDeliveryEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="scheduleDeliveryBtn">Schedule Delivery</button>
                    <button class="btn btn-cancel" id="cancelScheduleDeliveryBtn">Cancel</button>
                </div>
                
                <!-- NEW: Emergency Services Form -->
                <div class="emergency-services-form" id="emergencyServicesForm">
                    <h4 class="section-title">Emergency Services</h4>
                    
                    <div class="emergency-vehicle-options">
                        <div class="emergency-vehicle-option ambulance" data-type="ambulance">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-ambulance"></i>
                            </div>
                            <div class="emergency-vehicle-name">Ambulance</div>
                            <div class="emergency-vehicle-description">Medical emergency transport</div>
                        </div>
                        
                        <div class="emergency-vehicle-option fire-truck" data-type="fire-truck">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-fire-truck"></i>
                            </div>
                            <div class="emergency-vehicle-name">Fire Truck</div>
                            <div class="emergency-vehicle-description">Fire emergency response</div>
                        </div>
                        
                        <div class="emergency-vehicle-option emergency-ride" data-type="emergency-ride">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="emergency-vehicle-name">Emergency Ride</div>
                            <div class="emergency-vehicle-description">Urgent transportation</div>
                        </div>
                        
                        <div class="emergency-vehicle-option emergency-delivery" data-type="emergency-delivery">
                            <div class="emergency-vehicle-icon">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            <div class="emergency-vehicle-name">Emergency Delivery</div>
                            <div class="emergency-vehicle-description">Urgent item delivery</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-cancel" id="cancelEmergencyServicesBtn">Cancel</button>
                </div>
                
                <!-- NEW: Emergency Questionnaire -->
                <div class="emergency-questionnaire" id="emergencyQuestionnaire">
                    <h4 class="section-title">Emergency Details</h4>
                    
                    <div class="input-group">
                        <label for="emergencyType">Type of Emergency *</label>
                        <select id="emergencyType" class="input-field" required>
                            <option value="">Select emergency type</option>
                            <option value="medical">Medical Emergency</option>
                            <option value="fire">Fire Emergency</option>
                            <option value="accident">Accident</option>
                            <option value="security">Security Threat</option>
                            <option value="other">Other Emergency</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencySeverity">Severity Level *</label>
                        <select id="emergencySeverity" class="input-field" required>
                            <option value="">Select severity</option>
                            <option value="low">Low - Urgent but not life-threatening</option>
                            <option value="medium">Medium - Serious but stable</option>
                            <option value="high">High - Life-threatening</option>
                            <option value="critical">Critical - Immediate danger</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyDescription">Description of Emergency *</label>
                        <textarea id="emergencyDescription" class="input-field" placeholder="Describe the emergency situation" required></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyInjuries">Injuries (if any)</label>
                        <textarea id="emergencyInjuries" class="input-field" placeholder="Describe any injuries"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="emergencyPeople">Number of People Involved</label>
                        <input type="number" id="emergencyPeople" class="input-field" placeholder="Number of people" min="1">
                    </div>
                    
                    <div class="delivery-fee-display" id="emergencyFeeDisplay">
                        <p>Emergency Service Fee</p>
                        <div class="delivery-fee-amount" id="emergencyFee">K0.00</div>
                        <p class="delivery-eta-display" id="emergencyEtaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="submitEmergencyBtn">Request Emergency Service</button>
                    <button class="btn btn-cancel" id="cancelEmergencyQuestionnaireBtn">Cancel</button>
                </div>
                
                <!-- Original Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <!-- Vehicle Selection (Hidden by default) -->
                    <div class="vehicle-selection" id="vehicleSelection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">Clean Cars</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">on time</span>
                        </div>
                    </div>
                    
                    <!-- Package Delivery Form -->
                    <button class="package-toggle" id="packageToggle" style="display: none;">
                        <i class="fas fa-box"></i>
                        Add Package Details
                    </button>
                    
                    <div class="package-form" id="packageForm">
                        <h4 class="section-title">Package Delivery Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="receiverName">Receiver Name</label>
                                <input type="text" id="receiverName" placeholder="Full name of receiver">
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone">Receiver Phone</label>
                                <input type="tel" id="receiverPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="packageDescription">Package Description</label>
                            <input type="text" id="packageDescription" placeholder="What is being delivered?">
                        </div>
                        <div class="form-group">
                            <label for="specialInstructions">Special Instructions</label>
                            <textarea id="specialInstructions" placeholder="Any special handling instructions?"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="packageValue">Package Value (K)</label>
                            <input type="number" id="packageValue" placeholder="Estimated value for insurance">
                        </div>
                    </div>
                    
                    <!-- Fare Display (Hidden by default) -->
                    <div class="fare-display" id="fareDisplay">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <!-- Request Ride Button (Hidden by default) -->
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <!-- Driver Details Card -->
                    <div class="driver-details-card" id="driverDetailsCard" style="display: none;">
                        <div class="driver-details-header">
                            <i class="fas fa-id-card"></i>
                            <h3>Driver Details</h3>
                        </div>
                        <div class="driver-details-grid">
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Driver Name</span>
                                <span class="driver-detail-value" id="driverFullName">John Doe</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Phone</span>
                                <span class="driver-detail-value" id="driverContactPhone">+260 123 456 789</span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Rating</span>
                                <span class="driver-detail-value" id="driverRatingValue">4.8 </span>
                            </div>
                            <div class="driver-detail-item">
                                <span class="driver-detail-label">Experience</span>
                                <span class="driver-detail-value" id="driverExperience">2 years</span>
                            </div>
                        </div>
                        <div class="driver-vehicle-details">
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Type</span>
                                <span class="vehicle-detail-value" id="vehicleType">Car</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Vehicle Model</span>
                                <span class="vehicle-detail-value" id="vehicleModel">Toyota Corolla</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">License Plate</span>
                                <span class="vehicle-detail-value" id="vehicleLicense">ABC 123</span>
                            </div>
                            <div class="vehicle-detail-row">
                                <span class="vehicle-detail-label">Color</span>
                                <span class="vehicle-detail-value" id="vehicleColor">Blue</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 </span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                        <button class="btn btn-primary" id="viewReceiptBtn" style="display: none;">
                            <i class="fas fa-receipt"></i>
                            View Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K25 when friends complete their first ride</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">50% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="ride">Rides Only</option>
                    <option value="delivery">Deliveries Only</option>
                    <option value="emergency">Emergency Services</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- UPDATED: Emergency Services Screen (Replaced Payments) -->
        <div class="screen-content" id="emergencyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Emergency Services</h2>
            </div>
            
            <div class="emergency-services-section">
                <h3 class="section-title">
                    <i class="fas fa-ambulance"></i>
                    Emergency Vehicles
                </h3>
                
                <div class="emergency-service ambulance" data-type="ambulance">
                    <div class="emergency-icon">
                        <i class="fas fa-ambulance"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Ambulance Service</div>
                        <div class="emergency-info">Medical emergency transport with trained personnel</div>
                    </div>
                </div>
                
                <div class="emergency-service fire-truck" data-type="fire-truck">
                    <div class="emergency-icon">
                        <i class="fas fa-fire-truck"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Fire Truck</div>
                        <div class="emergency-info">Fire emergency response with firefighters</div>
                    </div>
                </div>
                
                <div class="emergency-service emergency-ride" data-type="emergency-ride">
                    <div class="emergency-icon">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Emergency Ride</div>
                        <div class="emergency-info">Urgent transportation for emergencies</div>
                    </div>
                </div>
                
                <div class="emergency-service emergency-delivery" data-type="emergency-delivery">
                    <div class="emergency-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">Emergency Delivery</div>
                        <div class="emergency-info">Urgent delivery of essential items</div>
                    </div>
                </div>
                
                <div class="emergency-service" data-type="sos">
                    <div class="emergency-icon" style="background: var(--error-red);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="emergency-details">
                        <div class="emergency-name">SOS Emergency</div>
                        <div class="emergency-info">Immediate assistance for critical situations</div>
                    </div>
                </div>
            </div>
            
            <div class="emergency-instructions" style="margin-top: 20px; padding: 15px; background: var(--light-red); border-radius: var(--element-radius);">
                <h3 class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Emergency Instructions
                </h3>
                <p style="font-size: 0.75rem; color: var(--dark-gray); margin-top: 5px;">
                    <strong>Important:</strong> Only use emergency services for genuine emergencies. 
                    Misuse may result in penalties. In case of immediate danger, call 911 first.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button class="btn btn-primary" id="viewRideReceiptBtn" style="margin-right: 8px;">
                            <i class="fas fa-receipt"></i>
                            View Receipt
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // App state
        let currentUser = null;
        let currentRide = null;
        let passengerMap;
        let popupRideMap;
        let locationWatchId = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let emergencyVehicleMarker = null;
        let routePolyline = null;
        let selectedVehicleType = 'car';
        let selectedRideType = 'standard'; // 'premium', 'standard', 'economy'
        let walletBalance = 0;
        let userFullName = "Passenger";
        let driverAssignmentListener = null;
        let rideHistoryListener = null;
        let activeRideListener = null;
        let appliedPromoCode = null;
        let userStats = {
            completed: 0,
            cancelled: 0,
            pending: 0
        };
        let paymentMethod = 'airtel';
        let userRating = 0;
        let userLocation = null;
        let destinationSearchResults = [];
        let selectedDestination = null;
        let driverLocationListener = null;
        let userData = null;
        let selectedPaymentType = 'wallet';
        let rideFare = 0;
        let currentCity = null;
        let packageDetails = null;
        let walletBalanceListener = null;
        let currentScreen = 'home';
        let homeScreenRefreshRequired = false;

        // NEW: State variables for new features
        let sosConfig = null;
        let activeMoreOption = null;
        let recipientPickupMarker = null;
        let recipientDestinationMarker = null;
        let shopLocationMarker = null;
        let deliveryDestinationMarker = null;
        let truckPickupMarker = null;
        let truckDestinationMarker = null;

        // NEW: Enhanced Chat state management
        let chatListener = null;
        let currentChatRideId = null;
        let unreadMessages = {};
        let chatPopupClosedByUser = false;
        let driverMessageListener = null;

        // NEW: Search state management
        let pickupSearchResults = [];
        let recipientPickupSearchResults = [];
        let shopLocationSearchResults = [];
        let deliveryDestinationSearchResults = [];
        let activeSearchField = null;

        // NEW: Ride request type tracking
        let currentRideRequestType = 'standard'; // 'standard', 'order-for-someone', 'express-delivery', 'light-truck-delivery', 'emergency', 'scheduled'
        let currentRideRequestData = null;

        // NEW: Driver images state
        let driverProfileImage = null;
        let driverVehicleImage = null;

        // NEW: Ride persistence state
        let activeRideRestored = false;

        // NEW: Schedule state
        let scheduledRides = [];
        let countdownInterval = null;
        let currentScheduledRide = null;

        // NEW: Emergency state
        let emergencyMode = false;
        let emergencyVehicleType = null;
        let emergencyDetails = null;

        // Zambian cities for search with common misspellings and variations
        const zambianCities = [
            'Lusaka', 'Kitwe', 'Ndola', 'Kabwe', 'Chipata', 'Chingola', 
            'Mufulira', 'Luanshya', 'Livingstone', 'Kasama', 'Solwezi', 
            'Kapiri Mposhi', 'Chililabombwe'
        ];

        // City aliases for handling spelling mistakes and variations
        const cityAliases = {
            'lusaka': 'Lusaka',
            'lsk': 'Lusaka',
            'lsk city': 'Lusaka',
            'kitwe': 'Kitwe',
            'ndola': 'Ndola',
            'kabwe': 'Kabwe',
            'chipata': 'Chipata',
            'chingola': 'Chingola',
            'mufulira': 'Mufulira',
            'luanshya': 'Luanshya',
            'livingstone': 'Livingstone',
            'kasama': 'Kasama',
            'solwezi': 'Solwezi',
            'kapiri': 'Kapiri Mposhi',
            'kapiri mposhi': 'Kapiri Mposhi',
            'chililabombwe': 'Chililabombwe',
            'chili': 'Chililabombwe'
        };

        // Enhanced city boundaries for more accurate detection
        const cityBoundaries = {
            'Lusaka': { lat: -15.4167, lng: 28.2833, radius: 25000 },
            'Kitwe': { lat: -12.8139, lng: 28.2136, radius: 20000 },
            'Ndola': { lat: -12.9667, lng: 28.6333, radius: 20000 },
            'Kabwe': { lat: -14.4333, lng: 28.4500, radius: 15000 },
            'Chipata': { lat: -13.6333, lng: 32.6500, radius: 15000 },
            'Chingola': { lat: -12.5333, lng: 27.8500, radius: 15000 },
            'Mufulira': { lat: -12.5500, lng: 28.2333, radius: 15000 },
            'Luanshya': { lat: -13.1333, lng: 28.4000, radius: 15000 },
            'Livingstone': { lat: -17.8500, lng: 25.8667, radius: 15000 },
            'Kasama': { lat: -10.2000, lng: 31.2000, radius: 15000 },
            'Solwezi': { lat: -12.1833, lng: 26.4000, radius: 15000 },
            'Kapiri Mposhi': { lat: -13.9667, lng: 28.6833, radius: 10000 },
            'Chililabombwe': { lat: -12.3667, lng: 27.8333, radius: 10000 }
        };

        // NEW: Ride type multipliers
        const rideTypeMultipliers = {
            'premium': 1.5,    // 50% more expensive
            'standard': 1.0,   // Base price
            'economy': 0.7     // 30% cheaper
        };

        // NEW: Emergency service base fares
        const emergencyBaseFares = {
            'ambulance': 500,
            'fire-truck': 1000,
            'emergency-ride': 200,
            'emergency-delivery': 300,
            'sos': 1000
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
        });

        // Authentication functions
        function initializeAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const uid = urlParams.get('uid');
            
            if (email && uid) {
                loadUserData(uid);
            } else {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        loadUserData(user.uid);
                    } else {
                        window.location.href = 'signup.html';
                    }
                });
            }
        }

        // Load user data from Firebase
        function loadUserData(uid) {
            database.ref('users/' + uid).once('value')
                .then(snapshot => {
                    userData = snapshot.val();
                    if (userData) {
                        currentUser = {
                            uid: uid,
                            email: userData.email,
                            displayName: userData.name
                        };
                        
                        initializeMap();
                        setupEventListeners();
                        loadPassengerData();
                        
                        document.getElementById('accountName').textContent = userData.name || 'Passenger';
                        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                        
                        walletBalance = userData.walletBalance || 0;
                        updateWalletBalanceUI();
                        
                        setupWalletBalanceListener(uid);
                        
                        loadSOSConfig(uid);
                        
                        checkActiveRide(uid);
                        
                        // NEW: Load scheduled rides
                        loadScheduledRides(uid);
                        
                        showNotification('Welcome back to Jubel!');
                    } else {
                        showNotification('User data not found. Please sign up again.');
                        setTimeout(() => {
                            window.location.href = 'signup.html';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    showNotification('Error loading user data. Please try again.');
                });
        }

        // NEW: Load scheduled rides for user
        function loadScheduledRides(uid) {
            database.ref('scheduledRides').orderByChild('passengerId').equalTo(uid).once('value')
                .then(snapshot => {
                    const scheduledRidesData = snapshot.val();
                    if (scheduledRidesData) {
                        scheduledRides = Object.values(scheduledRidesData);
                        checkAndStartCountdowns();
                    }
                })
                .catch(error => {
                    console.error('Error loading scheduled rides:', error);
                });
        }

        // NEW: Check and start countdowns for scheduled rides
        function checkAndStartCountdowns() {
            const now = new Date();
            
            scheduledRides.forEach(ride => {
                const scheduledTime = new Date(ride.scheduledTime);
                
                if (scheduledTime > now && ride.status === 'scheduled') {
                    const timeDiff = scheduledTime - now;
                    
                    if (timeDiff <= 3600000) { // If less than 1 hour away
                        startCountdown(ride);
                    }
                }
            });
        }

        // NEW: Start countdown for scheduled ride
        function startCountdown(ride) {
            currentScheduledRide = ride;
            
            const updateCountdown = () => {
                const now = new Date();
                const scheduledTime = new Date(ride.scheduledTime);
                const timeDiff = scheduledTime - now;
                
                if (timeDiff <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownTimer').classList.remove('active');
                    
                    // Automatically request the ride
                    requestScheduledRide(ride);
                } else {
                    const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                    
                    document.getElementById('countdownTime').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('countdownTimer').classList.add('active');
                }
            };
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // NEW: Request scheduled ride when countdown completes
        function requestScheduledRide(ride) {
            showNotification('Scheduled ride time reached! Requesting ride...');
            
            // Prepare ride request data
            currentRideRequestData = {
                ...ride,
                status: 'requested',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            currentRideRequestType = ride.rideType.includes('delivery') ? 'delivery' : 'ride';
            
            // Update scheduled ride status
            database.ref('scheduledRides/' + ride.id).update({
                status: 'processing'
            });
            
            // Show payment selection
            showPaymentSelection(ride.fare);
        }

        // Check for active ride when app loads
        function checkActiveRide(uid) {
            database.ref('rides').orderByChild('passengerId').equalTo(uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    if (rides) {
                        for (const rideId in rides) {
                            const ride = rides[rideId];
                            if (ride.status !== 'completed' && ride.status !== 'cancelled' && ride.status !== 'requested') {
                                restoreActiveRide(rideId, ride);
                                break;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking active ride:', error);
                });
        }

        // Restore active ride after app refresh
        function restoreActiveRide(rideId, ride) {
            currentRide = {
                id: rideId,
                ...ride
            };
            
            updateUIForActiveRide();
            
            if (ride.status === 'requested') {
                document.getElementById('searchingAnimation').style.display = 'flex';
                document.getElementById('rideStatus').style.display = 'flex';
                document.getElementById('statusDot').className = 'status-dot searching';
                document.getElementById('statusText').textContent = 'Searching for driver';
                
                listenForDriverAssignment(rideId);
            } 
            else if (ride.driverId && (ride.status === 'accepted' || ride.status === 'arrived' || ride.status === 'started' || ride.status === 'picked_up')) {
                handleDriverAssignment(ride);
                
                updateRideStatusDisplay(ride.status);
                
                if (ride.driverId) {
                    trackDriverLocation(ride.driverId);
                }
                
                // NEW: Show emergency status if emergency ride
                if (ride.emergencyType) {
                    document.getElementById('emergencyRideStatus').style.display = 'flex';
                    emergencyMode = true;
                }
                
                if (sosConfig && sosConfig.contact1) {
                    document.getElementById('sosButton').style.display = 'flex';
                }
            }
            
            activeRideRestored = true;
            showNotification('Active ride restored');
        }

        // Load SOS configuration
        function loadSOSConfig(uid) {
            database.ref('sosConfig/' + uid).once('value')
                .then(snapshot => {
                    sosConfig = snapshot.val();
                    if (sosConfig) {
                        document.getElementById('emergencyContact1').value = sosConfig.contact1 || '';
                        document.getElementById('emergencyContact2').value = sosConfig.contact2 || '';
                        document.getElementById('sosMessage').value = sosConfig.message || 'I need help! My current location and ride details will be shared with you.';
                    }
                })
                .catch(error => {
                    console.error('Error loading SOS config:', error);
                });
        }

        // Set up real-time wallet balance listener
        function setupWalletBalanceListener(uid) {
            if (walletBalanceListener) {
                walletBalanceListener();
            }
            
            walletBalanceListener = database.ref('users/' + uid + '/walletBalance').on('value', snapshot => {
                const newBalance = snapshot.val() || 0;
                if (newBalance !== walletBalance) {
                    walletBalance = newBalance;
                    updateWalletBalanceUI();
                    showNotification(`Wallet balance updated: K${walletBalance.toFixed(2)}`);
                }
            }, error => {
                console.error('Error listening to wallet balance:', error);
            });
        }

        // Update wallet balance across all UI elements
        function updateWalletBalanceUI() {
            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
            document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
            document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
        }

        // Map initialization
        function initializeMap() {
            passengerMap = L.map('map').setView([-15.4167, 28.2833], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(passengerMap);
            
            popupRideMap = L.map('popupRideMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(popupRideMap);
            
            refreshPassengerPosition();
        }

        // ENHANCED: Advanced city detection with multiple fallback methods
        function determineCurrentCity(lat, lng) {
            return new Promise((resolve, reject) => {
                console.log(`Starting city detection for coordinates: ${lat}, ${lng}`);
                
                const boundaryCity = checkCityBoundaries(lat, lng);
                if (boundaryCity) {
                    console.log(`City detected via boundaries: ${boundaryCity}`);
                    currentCity = boundaryCity;
                    resolve(currentCity);
                    return;
                }
                
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.address) {
                            const detectedCity = extractCityFromAddress(data.address);
                            
                            if (detectedCity && detectedCity !== "Unknown Location") {
                                currentCity = detectedCity;
                                console.log(`City detected via Nominatim: ${currentCity}`);
                                resolve(currentCity);
                            } else {
                                const fallbackCity = extractCityFromDisplayName(data.display_name);
                                currentCity = fallbackCity;
                                console.log(`City detected via fallback: ${currentCity}`);
                                resolve(currentCity);
                            }
                        } else {
                            currentCity = "Lusaka";
                            console.log(`Using default city: ${currentCity}`);
                            resolve(currentCity);
                        }
                    })
                    .catch(error => {
                        console.error('Error in city detection:', error);
                        currentCity = determineCityByProximity(lat, lng) || "Lusaka";
                        console.log(`City detected via proximity fallback: ${currentCity}`);
                        resolve(currentCity);
                    });
            });
        }

        // Check if coordinates fall within known city boundaries
        function checkCityBoundaries(lat, lng) {
            for (const [city, boundary] of Object.entries(cityBoundaries)) {
                const distance = calculateDistance(lat, lng, boundary.lat, boundary.lng);
                if (distance <= boundary.radius) {
                    return city;
                }
            }
            return null;
        }

        // Extract city from address object with priority handling
        function extractCityFromAddress(address) {
            const priorityFields = [
                'city', 'town', 'village', 'municipality', 
                'suburb', 'county', 'state_district', 'state'
            ];
            
            for (const field of priorityFields) {
                if (address[field]) {
                    const detectedName = address[field].toString().trim();
                    const normalized = normalizeCityName(detectedName);
                    if (zambianCities.includes(normalized)) {
                        return normalized;
                    }
                }
            }
            
            return null;
        }

        // Extract city from display name with pattern matching
        function extractCityFromDisplayName(displayName) {
            if (!displayName) return "Unknown Location";
            
            const nameLower = displayName.toLowerCase();
            
            for (const city of zambianCities) {
                if (nameLower.includes(city.toLowerCase())) {
                    return city;
                }
            }
            
            for (const [alias, actualCity] of Object.entries(cityAliases)) {
                if (nameLower.includes(alias)) {
                    return actualCity;
                }
            }
            
            return "Unknown Location";
        }

        // Normalize city names for consistent matching
        function normalizeCityName(cityName) {
            if (!cityName) return "";
            
            const normalized = cityName.toString().trim();
            
            const variations = {
                'lusaka city': 'Lusaka',
                'lska': 'Lusaka',
                'kitwe town': 'Kitwe',
                'ndola city': 'Ndola',
                'kabwe town': 'Kabwe',
                'chipata town': 'Chipata',
                'chingola town': 'Chingola',
                'mufulira town': 'Mufulira',
                'luanshya town': 'Luanshya',
                'livingstone town': 'Livingstone',
                'kasama town': 'Kasama',
                'solwezi town': 'Solwezi',
                'kapiri mposhi town': 'Kapiri Mposhi',
                'chililabombwe town': 'Chililabombwe'
            };
            
            return variations[normalized.toLowerCase()] || 
                   zambianCities.find(city => city.toLowerCase() === normalized.toLowerCase()) || 
                   normalized;
        }

        // Determine city by proximity to known city centers
        function determineCityByProximity(lat, lng) {
            let closestCity = null;
            let shortestDistance = Infinity;
            
            for (const [city, center] of Object.entries(cityBoundaries)) {
                const distance = calculateDistance(lat, lng, center.lat, center.lng);
                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    closestCity = city;
                }
            }
            
            return shortestDistance <= 100000 ? closestCity : "Unknown Location";
        }

        // ENHANCED: Update pickup location with precise address details only
        function updatePickupLocation(lat, lng) {
            if (pickupMarker) {
                passengerMap.removeLayer(pickupMarker);
            }
            
            pickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup('Pickup Location');
                
            getPreciseAddress(lat, lng, 'pickupLocation');
        }

        // ENHANCED: Get precise address without city, province, or country
        function getPreciseAddress(lat, lng, elementId) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Geocoding error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.address) {
                        const preciseAddress = buildPreciseAddress(data.address);
                        document.getElementById(elementId).value = preciseAddress || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    } else {
                        document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                })
                .catch(error => {
                    console.error('Reverse geocoding error:', error);
                    document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                });
        }

        // NEW: Build precise address without city, province, or country
        function buildPreciseAddress(address) {
            const addressParts = [];
            
            if (address.house_number || address.housenumber) {
                addressParts.push(address.house_number || address.housenumber);
            }
            
            if (address.building) {
                addressParts.push(address.building);
            } else if (address.amenity) {
                addressParts.push(address.amenity);
            }
            
            if (address.road) {
                addressParts.push(address.road);
            }
            
            if (address.suburb) {
                addressParts.push(address.suburb);
            } else if (address.neighbourhood) {
                addressParts.push(address.neighbourhood);
            }
            
            if (address.residential) {
                addressParts.push(address.residential);
            }
            
            if (address.quarter) {
                addressParts.push(address.quarter);
            }
            
            const filteredParts = addressParts.filter(part => part && part.trim().length > 0);
            
            if (filteredParts.length > 0) {
                return filteredParts.join(', ');
            }
            
            return null;
        }

        // ENHANCED: Get full address for ride submission (includes city, province, country)
        function getFullAddress(lat, lng) {
            return new Promise((resolve, reject) => {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1&accept-language=en`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Full address geocoding error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.display_name) {
                            resolve(data.display_name);
                        } else {
                            resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                        }
                    })
                    .catch(error => {
                        console.error('Full address geocoding error:', error);
                        resolve(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                    });
            });
        }

        // IMPROVED: Stable search function without flickering
        function searchPlacesEnhanced(query, searchType = 'destination') {
            if (!query || query.length < 2) {
                hideSearchSuggestions(searchType);
                return;
            }
            
            const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
            
            if (window.searchTimeout) {
                clearTimeout(window.searchTimeout);
            }
            
            suggestionsContainer.innerHTML = '<div class="loading-text">Searching...</div>';
            suggestionsContainer.style.display = 'block';
            
            window.searchTimeout = setTimeout(() => {
                const processedQuery = preprocessSearchQuery(query);
                
                let hasResults = false;
                
                performUnifiedSearch(processedQuery)
                    .then(results => {
                        if (results.length > 0) {
                            hasResults = true;
                            displaySearchResults(results, searchType);
                        } else {
                            showNoResultsMessage(processedQuery, searchType);
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        const cachedResults = getCachedSearchResults(searchType);
                        if (cachedResults.length > 0) {
                            displaySearchResults(cachedResults, searchType);
                        } else {
                            showNoResultsMessage(processedQuery, searchType);
                        }
                    });
                    
                setTimeout(() => {
                    if (!hasResults) {
                        const cachedResults = getCachedSearchResults(searchType);
                        if (cachedResults.length === 0) {
                            showNoResultsMessage(processedQuery, searchType);
                        }
                    }
                }, 2000);
                
            }, 300);
        }

        // Get cached search results based on search type
        function getCachedSearchResults(searchType) {
            switch(searchType) {
                case 'destination': return destinationSearchResults;
                case 'pickup': return pickupSearchResults;
                case 'recipientPickup': return recipientPickupSearchResults;
                case 'recipientDestination': return destinationSearchResults;
                case 'shopLocation': return shopLocationSearchResults;
                case 'deliveryDestination': return deliveryDestinationSearchResults;
                case 'schedulePickup': return pickupSearchResults;
                case 'scheduleDestination': return destinationSearchResults;
                case 'scheduleDeliveryPickup': return pickupSearchResults;
                case 'scheduleDeliveryDestination': return destinationSearchResults;
                case 'truckPickup': return pickupSearchResults;
                case 'truckDestination': return destinationSearchResults;
                default: return [];
            }
        }

        // Unified search function to replace multiple promise approach
        function performUnifiedSearch(query) {
            return new Promise((resolve, reject) => {
                let searchQuery = query;
                if (currentCity && currentCity !== "Unknown Location") {
                    searchQuery = `${query}, ${currentCity}, Zambia`;
                } else {
                    searchQuery = `${query}, Zambia`;
                }
                
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=10&dedupe=1&countrycodes=zm`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Search API error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data && data.length > 0) {
                            const enhancedResults = data
                                .filter(place => place.display_name && place.lat && place.lon)
                                .map(place => {
                                    const distance = userLocation ? calculateDistance(
                                        userLocation.lat, userLocation.lng,
                                        parseFloat(place.lat), parseFloat(place.lon)
                                    ) : 0;
                                    
                                    const placeCity = extractCityFromPlace(place) || currentCity || "Unknown";
                                    
                                    return {
                                        ...place,
                                        displayLat: parseFloat(place.lat),
                                        displayLon: parseFloat(place.lon),
                                        distance,
                                        city: placeCity,
                                        isCurrentCity: placeCity === currentCity,
                                        priority: placeCity === currentCity ? 1 : 2,
                                        relevanceScore: calculateRelevanceScore(place, query, placeCity),
                                        displayName: formatDisplayName(place.display_name, placeCity)
                                    };
                                })
                                .sort((a, b) => {
                                    if (b.relevanceScore !== a.relevanceScore) {
                                        return b.relevanceScore - a.relevanceScore;
                                    }
                                    return a.distance - b.distance;
                                });
                            
                            resolve(enhancedResults);
                        } else {
                            resolve([]);
                        }
                    })
                    .catch(error => {
                        console.error('Unified search error:', error);
                        reject(error);
                    });
            });
        }

        // ENHANCED: Display search results with stable UI
        function displaySearchResults(results, searchType) {
            const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
            
            suggestionsContainer.innerHTML = '';
            
            updateSearchResultsCache(results, searchType);
            
            if (results.length === 0) {
                showNoResultsMessage('', searchType);
                return;
            }
            
            const uniqueResults = removeDuplicatePlaces(results).slice(0, 8);
            
            uniqueResults.forEach((result, index) => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                if (index === 0) suggestionItem.classList.add('first-result');
                
                const placeType = getPlaceType(result);
                const placeIcon = getPlaceIcon(placeType);
                
                const cityBadge = result.isCurrentCity ? '' : 
                    `<span class="city-badge">${result.city}</span>`;
                
                const distanceText = userLocation && result.distance > 0 ? 
                    `${(result.distance / 1000).toFixed(1)} km away` : '';
                
                const displayName = result.displayName || result.display_name;
                
                suggestionItem.innerHTML = `
                    <div class="suggestion-icon">${placeIcon}</div>
                    <div class="suggestion-details">
                        <div class="suggestion-name">
                            ${displayName}
                            ${cityBadge}
                        </div>
                        <div class="suggestion-address">${getShortAddress(result.display_name)}</div>
                        <div class="suggestion-distance">${distanceText}</div>
                    </div>
                    ${result.isCurrentCity ? '<div class="current-city-indicator"> Current City</div>' : ''}
                `;
                
                suggestionItem.addEventListener('click', function() {
                    handleSearchResultSelection(result, searchType);
                });
                
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            suggestionsContainer.style.display = 'block';
        }

        // Handle search result selection based on search type
        function handleSearchResultSelection(result, searchType) {
            let inputFieldId;
            
            switch(searchType) {
                case 'destination':
                    inputFieldId = 'destinationLocation';
                    break;
                case 'pickup':
                    inputFieldId = 'pickupLocation';
                    break;
                case 'recipientPickup':
                    inputFieldId = 'recipientPickupLocation';
                    break;
                case 'recipientDestination':
                    inputFieldId = 'recipientDestinationLocation';
                    break;
                case 'shopLocation':
                    inputFieldId = 'shopLocation';
                    break;
                case 'deliveryDestination':
                    inputFieldId = 'deliveryDestination';
                    break;
                case 'schedulePickup':
                    inputFieldId = 'schedulePickupLocation';
                    break;
                case 'scheduleDestination':
                    inputFieldId = 'scheduleDestinationLocation';
                    break;
                case 'scheduleDeliveryPickup':
                    inputFieldId = 'scheduleDeliveryPickup';
                    break;
                case 'scheduleDeliveryDestination':
                    inputFieldId = 'scheduleDeliveryDestination';
                    break;
                case 'truckPickup':
                    inputFieldId = 'truckPickupLocation';
                    break;
                case 'truckDestination':
                    inputFieldId = 'truckDestination';
                    break;
                default:
                    return;
            }
            
            const inputField = document.getElementById(inputFieldId);
            if (inputField) {
                inputField.value = result.display_name;
            }
            
            hideSearchSuggestions(searchType);
            
            switch(searchType) {
                case 'destination':
                    updateFareEstimate();
                    updateDestinationMarker(
                        result.displayLat, 
                        result.displayLon, 
                        result.display_name
                    );
                    
                    if (userLocation) {
                        drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
                    }
                    
                    selectedDestination = result;
                    
                    // Show ride type selection modal instead of directly enabling ride button
                    showRideTypeSelection();
                    
                    showNotification(`Destination set to ${result.displayName}`);
                    break;
                    
                case 'pickup':
                    updateManualPickupLocation(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Pickup location set to ${result.displayName}`);
                    break;
                    
                case 'recipientPickup':
                    calculateRecipientDeliveryFee();
                    updateRecipientPickupMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Recipient pickup set to ${result.displayName}`);
                    break;
                    
                case 'recipientDestination':
                    calculateRecipientDeliveryFee();
                    updateRecipientDestinationMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Recipient destination set to ${result.displayName}`);
                    break;
                    
                case 'shopLocation':
                    calculateExpressDeliveryFee();
                    updateShopLocationMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Shop location set to ${result.displayName}`);
                    break;
                    
                case 'deliveryDestination':
                    calculateExpressDeliveryFee();
                    updateDeliveryDestinationMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Delivery destination set to ${result.displayName}`);
                    break;
                    
                case 'schedulePickup':
                    calculateScheduleRideFee();
                    updateSchedulePickupMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Pickup location set to ${result.displayName}`);
                    break;
                    
                case 'scheduleDestination':
                    calculateScheduleRideFee();
                    updateScheduleDestinationMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Destination set to ${result.displayName}`);
                    break;
                    
                case 'truckPickup':
                    calculateLightTruckDeliveryFee();
                    updateTruckPickupMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Pickup location set to ${result.displayName}`);
                    break;
                    
                case 'truckDestination':
                    calculateLightTruckDeliveryFee();
                    updateTruckDestinationMarker(result.displayLat, result.displayLon, result.display_name);
                    showNotification(`Destination set to ${result.displayName}`);
                    break;
            }
        }

        // NEW: Show ride type selection modal
        function showRideTypeSelection() {
            document.getElementById('rideTypeModal').classList.add('active');
        }

        // NEW: Hide ride type selection modal
        function hideRideTypeSelection() {
            document.getElementById('rideTypeModal').classList.remove('active');
        }

        // NEW: Handle ride type selection
        function handleRideTypeSelection(rideType) {
            selectedRideType = rideType;
            
            // Update fare estimate with new ride type
            updateFareEstimate();
            
            // Hide modal and show vehicle selection
            hideRideTypeSelection();
            
            // Show vehicle selection and fare display
            document.getElementById('vehicleSelection').classList.add('active');
            document.getElementById('fareDisplay').classList.add('active');
            document.getElementById('requestRideBtn').classList.add('active');
            
            showNotification(`${rideType.charAt(0).toUpperCase() + rideType.slice(1)} ride selected`);
        }

        // Update manual pickup location (when user searches for pickup)
        function updateManualPickupLocation(lat, lng, name) {
            if (currentLocationMarker) {
                passengerMap.removeLayer(currentLocationMarker);
                currentLocationMarker = null;
            }
            
            if (pickupMarker) {
                passengerMap.removeLayer(pickupMarker);
            }
            
            pickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Pickup Location`)
                .openPopup();
            
            userLocation = { lat, lng };
            
            const destination = document.getElementById('destinationLocation').value;
            if (destination) {
                updateFareEstimate();
                
                forwardGeocode(destination).then(results => {
                    if (results.length > 0) {
                        const destLat = parseFloat(results[0].lat);
                        const destLng = parseFloat(results[0].lon);
                        drawRoute(lat, lng, destLat, destLng);
                    }
                });
            }
            
            passengerMap.setView([lat, lng], 16);
        }

        // Update search results cache based on search type
        function updateSearchResultsCache(results, searchType) {
            switch(searchType) {
                case 'destination': 
                    destinationSearchResults = results;
                    break;
                case 'pickup':
                    pickupSearchResults = results;
                    break;
                case 'recipientPickup':
                    recipientPickupSearchResults = results;
                    break;
                case 'recipientDestination':
                    destinationSearchResults = results;
                    break;
                case 'shopLocation':
                    shopLocationSearchResults = results;
                    break;
                case 'deliveryDestination':
                    deliveryDestinationSearchResults = results;
                    break;
                case 'truckPickup':
                    pickupSearchResults = results;
                    break;
                case 'truckDestination':
                    destinationSearchResults = results;
                    break;
            }
        }

        // ENHANCED: Setup search input listeners for all location fields
        function setupSearchInputListeners() {
            const searchFields = [
                { type: 'destination', inputId: 'destinationLocation', suggestionsId: 'destinationSuggestions' },
                { type: 'pickup', inputId: 'pickupLocation', suggestionsId: 'pickupSuggestions' },
                { type: 'recipientPickup', inputId: 'recipientPickupLocation', suggestionsId: 'recipientPickupSuggestions' },
                { type: 'recipientDestination', inputId: 'recipientDestinationLocation', suggestionsId: 'recipientDestinationSuggestions' },
                { type: 'shopLocation', inputId: 'shopLocation', suggestionsId: 'shopLocationSuggestions' },
                { type: 'deliveryDestination', inputId: 'deliveryDestination', suggestionsId: 'deliveryDestinationSuggestions' },
                { type: 'schedulePickup', inputId: 'schedulePickupLocation', suggestionsId: 'schedulePickupSuggestions' },
                { type: 'scheduleDestination', inputId: 'scheduleDestinationLocation', suggestionsId: 'scheduleDestinationSuggestions' },
                { type: 'scheduleDeliveryPickup', inputId: 'scheduleDeliveryPickup', suggestionsId: 'scheduleDeliveryPickupSuggestions' },
                { type: 'scheduleDeliveryDestination', inputId: 'scheduleDeliveryDestination', suggestionsId: 'scheduleDeliveryDestinationSuggestions' },
                { type: 'truckPickup', inputId: 'truckPickupLocation', suggestionsId: 'truckPickupSuggestions' },
                { type: 'truckDestination', inputId: 'truckDestination', suggestionsId: 'truckDestinationSuggestions' }
            ];
            
            searchFields.forEach(field => {
                setupSearchInputListener(field.type, field.inputId, field.suggestionsId);
            });
        }

        // ENHANCED: Generic search input listener setup
        function setupSearchInputListener(searchType, inputId, suggestionsId) {
            let lastQuery = '';
            const inputField = document.getElementById(inputId);
            
            inputField.addEventListener('input', function() {
                const query = this.value.trim();
                
                if (window.searchTimeout) {
                    clearTimeout(window.searchTimeout);
                }
                
                if (query.length >= 2 && query !== lastQuery) {
                    window.searchTimeout = setTimeout(() => {
                        lastQuery = query;
                        searchPlacesEnhanced(query, searchType);
                    }, 300);
                } else if (query.length < 2) {
                    hideSearchSuggestions(searchType);
                    lastQuery = '';
                }
            });
            
            inputField.addEventListener('focus', function() {
                const query = this.value.trim();
                const cachedResults = getCachedSearchResults(searchType);
                
                if (query.length >= 2 && cachedResults.length > 0) {
                    displaySearchResults(cachedResults, searchType);
                } else if (query.length >= 2) {
                    searchPlacesEnhanced(query, searchType);
                }
            });
            
            inputField.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideSearchSuggestions(searchType);
                } else if (e.key === 'Enter') {
                    hideSearchSuggestions(searchType);
                    const cachedResults = getCachedSearchResults(searchType);
                    if (cachedResults.length > 0) {
                        handleSearchResultSelection(cachedResults[0], searchType);
                    }
                }
            });
        }

        // IMPROVED: Hide suggestions function for all search types
        function hideSearchSuggestions(searchType) {
            const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
            if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
            }
            
            if (window.searchTimeout) {
                clearTimeout(window.searchTimeout);
                window.searchTimeout = null;
            }
        }

        // ENHANCED: Show no results message
        function showNoResultsMessage(query = '', searchType = 'destination') {
            const suggestionsContainer = document.getElementById(`${searchType}Suggestions`);
            
            if (suggestionsContainer) {
                suggestionsContainer.innerHTML = '<div class="no-places">No places found</div>';
            }
        }

        // NEW: Preprocess search query for better matching
        function preprocessSearchQuery(query) {
            let processed = query.trim().toLowerCase();
            
            const stopWords = ['the', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of', 'and', 'or', 'but'];
            stopWords.forEach(word => {
                processed = processed.replace(new RegExp(`\\b${word}\\b`, 'gi'), '');
            });
            
            processed = processed.replace(/\s+/g, ' ').trim();
            
            const abbreviations = {
                'st': 'street',
                'ave': 'avenue',
                'rd': 'road',
                'blvd': 'boulevard',
                'hwy': 'highway',
                'ln': 'lane',
                'dr': 'drive'
            };
            
            Object.keys(abbreviations).forEach(abbr => {
                processed = processed.replace(new RegExp(`\\b${abbr}\\b`, 'gi'), abbreviations[abbr]);
            });
            
            return processed;
        }

        // NEW: Calculate relevance score for search results
        function calculateRelevanceScore(place, query, city) {
            let score = 0;
            const placeName = place.display_name.toLowerCase();
            const queryLower = query.toLowerCase();
            const cityLower = city.toLowerCase();
            
            if (placeName.includes(queryLower)) {
                score += 10;
            }
            
            const queryWords = queryLower.split(' ');
            queryWords.forEach(word => {
                if (word.length > 2 && placeName.includes(word)) {
                    score += 5;
                }
            });
            
            if (city === currentCity) {
                score += 8;
            }
            
            if (place.type === 'administrative' || place.class === 'boundary') {
                score -= 2;
            }
            
            if (place.importance) {
                score += place.importance * 5;
            }
            
            if (userLocation) {
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    parseFloat(place.lat), parseFloat(place.lon)
                );
                if (distance > 50000) {
                    score -= 3;
                }
            }
            
            return Math.max(0, score);
        }

        // NEW: Extract city from place data
        function extractCityFromPlace(place) {
            if (place.address) {
                return extractCityFromAddress(place.address);
            }
            
            return extractCityFromDisplayName(place.display_name);
        }

        // NEW: Format display name for better UX
        function formatDisplayName(fullName, city) {
            if (!fullName) return 'Unknown Location';
            
            const parts = fullName.split(',');
            const relevantParts = [];
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i].trim();
                const partLower = part.toLowerCase();
                
                if (zambianCities.some(c => c.toLowerCase() === partLower) ||
                    partLower === 'zambia' ||
                    partLower.includes('province')) {
                    break;
                }
                
                relevantParts.push(part);
            }
            
            return relevantParts.join(', ') || fullName;
        }

        // NEW: Get short address for display
        function getShortAddress(fullAddress) {
            if (!fullAddress) return '';
            
            const parts = fullAddress.split(',');
            return parts.slice(0, Math.min(3, parts.length)).join(', ');
        }

        // ENHANCED: Remove duplicate places with improved logic
        function removeDuplicatePlaces(places) {
            const seen = new Set();
            return places.filter(place => {
                const coordKey = `${place.lat}-${place.lon}`;
                const nameKey = place.display_name.substring(0, 50).toLowerCase();
                const uniqueKey = `${coordKey}-${nameKey}`;
                
                if (seen.has(uniqueKey)) {
                    return false;
                }
                seen.add(uniqueKey);
                return true;
            });
        }

        // ENHANCED: Refresh passenger position with improved city detection
        function refreshPassengerPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    passengerMap.setView([lat, lng], 16);
                    
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    } else {
                        currentLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                                iconSize: [18, 18]
                            })
                        }).addTo(passengerMap)
                            .bindPopup('Your location');
                    }
                    
                    updatePickupLocation(lat, lng);
                    
                    showNotification('Detecting your location...');
                    determineCurrentCity(lat, lng).then(city => {
                        console.log("Final detected city:", city);
                        if (currentScreen === 'home') {
                            showNotification(`Location detected in ${city}`);
                            updateCitySpecificUI(city);
                        }
                    }).catch(error => {
                        console.error('City detection failed:', error);
                        currentCity = "Lusaka";
                        if (currentScreen === 'home') {
                            showNotification('Using default location: Lusaka');
                        }
                    });
                    
                    if (!locationWatchId) {
                        startLocationTracking();
                    }
                    
                    if (currentScreen === 'home') {
                        showNotification('Location refreshed');
                    }
                }, error => {
                    console.error('Geolocation error:', error);
                    handleGeolocationError(error);
                }, {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                });
            } else {
                showNotification('Geolocation is not supported by this browser.');
                currentCity = "Lusaka";
            }
        }

        // NEW: Handle geolocation errors gracefully
        function handleGeolocationError(error) {
            let errorMessage = 'Unable to refresh location. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Please enable location services in your browser settings.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out. Please try again.';
                    break;
                default:
                    errorMessage += 'Please enable location services.';
            }
            
            if (currentScreen === 'home') {
                showNotification(errorMessage);
            }
            
            currentCity = currentCity || "Lusaka";
        }

        // NEW: Update city-specific UI elements
        function updateCitySpecificUI(city) {
            const cityElement = document.getElementById('currentCity');
            if (cityElement) {
                cityElement.textContent = city;
            }
            
            console.log(`UI updated for city: ${city}`);
        }

        // Calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(/2) * Math.sin(/2) +
                      Math.cos(1) * Math.cos(2) *
                      Math.sin(/2) * Math.sin(/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Forward geocoding
        function forwardGeocode(query) {
            return new Promise(resolve => {
                if (!userLocation) {
                    resolve([]);
                    return;
                }
                
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&countrycodes=zm`)
                    .then(response => response.json())
                    .then(data => {
                        const filteredResults = data.filter(result => {
                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(result.lat), parseFloat(result.lon)
                            );
                            return distance <= 50000;
                        });
                        
                        resolve(filteredResults);
                    })
                    .catch(error => {
                        console.error('Forward geocoding error:', error);
                        resolve([]);
                    });
            });
        }

        // UPDATED: Enhanced fare estimate calculation with ride types
        function updateFareEstimate() {
            const destination = document.getElementById('destinationLocation').value;
            
            if (destination.length > 3 && userLocation) {
                forwardGeocode(destination).then(results => {
                    if (results.length > 0) {
                        const destLat = parseFloat(results[0].lat);
                        const destLng = parseFloat(results[0].lon);
                        
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            destLat, destLng
                        );
                        
                        // K23 base fare for all rides
                        let baseFare = 23;
                        
                        // Add distance-based fare (K1 per 90 meters after base fare)
                        if (distance > 0) {
                            baseFare += Math.ceil(distance / 90);
                        }
                        
                        // Apply ride type multiplier
                        baseFare *= rideTypeMultipliers[selectedRideType] || 1;
                        
                        // Apply promo code discount if applicable
                        if (appliedPromoCode) {
                            baseFare = baseFare * 0.8;
                        }
                        
                        document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                        
                        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                        document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        rideFare = baseFare;
                    }
                });
            } else {
                document.getElementById('estimatedFare').textContent = 'K0.00';
                document.getElementById('etaDisplay').textContent = 'ETA: -- min';
            }
        }

        // NEW: Calculate recipient delivery fee
        function calculateRecipientDeliveryFee() {
            const pickupLocation = document.getElementById('recipientPickupLocation').value;
            const destinationLocation = document.getElementById('recipientDestinationLocation').value;
            
            if (pickupLocation.length > 3 && destinationLocation.length > 3) {
                Promise.all([
                    forwardGeocode(pickupLocation),
                    forwardGeocode(destinationLocation)
                ]).then(([pickupResults, destinationResults]) => {
                    if (pickupResults.length > 0 && destinationResults.length > 0) {
                        const pickupLat = parseFloat(pickupResults[0].lat);
                        const pickupLng = parseFloat(pickupResults[0].lon);
                        const destLat = parseFloat(destinationResults[0].lat);
                        const destLng = parseFloat(destinationResults[0].lon);
                        
                        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                        
                        let baseFare = 23;
                        
                        if (distance > 0) {
                            baseFare += Math.ceil(distance / 90);
                        }
                        
                        // Apply standard ride type
                        baseFare *= rideTypeMultipliers['standard'];
                        
                        document.getElementById('recipientDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                        document.getElementById('recipientDeliveryFeeDisplay').classList.add('active');
                        
                        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                        document.getElementById('recipientEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        document.getElementById('orderForSomeoneBtn').disabled = false;
                        
                        updateRecipientPickupMarker(pickupLat, pickupLng, pickupResults[0].display_name);
                        updateRecipientDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                        
                        drawRoute(pickupLat, pickupLng, destLat, destLng);
                    }
                });
            } else {
                document.getElementById('recipientDeliveryFee').textContent = 'K0.00';
                document.getElementById('recipientEtaDisplay').textContent = 'ETA: -- min';
                document.getElementById('orderForSomeoneBtn').disabled = true;
            }
        }

        // NEW: Calculate express delivery fee
        function calculateExpressDeliveryFee() {
            const shopLocation = document.getElementById('shopLocation').value;
            const deliveryDestination = document.getElementById('deliveryDestination').value;
            
            if (shopLocation.length > 3 && deliveryDestination.length > 3) {
                Promise.all([
                    forwardGeocode(shopLocation),
                    forwardGeocode(deliveryDestination)
                ]).then(([shopResults, destinationResults]) => {
                    if (shopResults.length > 0 && destinationResults.length > 0) {
                        const shopLat = parseFloat(shopResults[0].lat);
                        const shopLng = parseFloat(shopResults[0].lon);
                        const destLat = parseFloat(destinationResults[0].lat);
                        const destLng = parseFloat(destinationResults[0].lon);
                        
                        const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
                        
                        let baseFare = 23;
                        
                        if (distance > 0) {
                            baseFare += Math.ceil(distance / 90);
                        }
                        
                        const vehicleType = document.querySelector('.express-delivery-form .delivery-mode-option.selected').getAttribute('data-type');
                        switch(vehicleType) {
                            case 'car':
                                baseFare = baseFare;
                                break;
                            case 'bike':
                                baseFare = baseFare * 0.7;
                                break;
                            case 'bicycle':
                                baseFare = baseFare * 0.5;
                                break;
                        }
                        
                        document.getElementById('expressDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                        document.getElementById('expressDeliveryFeeDisplay').classList.add('active');
                        
                        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                        document.getElementById('expressDeliveryEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        document.getElementById('expressDeliveryBtn').disabled = false;
                        
                        updateShopLocationMarker(shopLat, shopLng, shopResults[0].display_name);
                        updateDeliveryDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                        
                        drawRoute(shopLat, shopLng, destLat, destLng);
                    }
                });
            } else {
                document.getElementById('expressDeliveryFee').textContent = 'K0.00';
                document.getElementById('expressDeliveryEtaDisplay').textContent = 'ETA: -- min';
                document.getElementById('expressDeliveryBtn').disabled = true;
            }
        }

        // NEW: Calculate light truck delivery fee
        function calculateLightTruckDeliveryFee() {
            const pickupLocation = document.getElementById('truckPickupLocation').value;
            const destination = document.getElementById('truckDestination').value;
            
            if (pickupLocation.length > 3 && destination.length > 3) {
                Promise.all([
                    forwardGeocode(pickupLocation),
                    forwardGeocode(destination)
                ]).then(([pickupResults, destinationResults]) => {
                    if (pickupResults.length > 0 && destinationResults.length > 0) {
                        const pickupLat = parseFloat(pickupResults[0].lat);
                        const pickupLng = parseFloat(pickupResults[0].lon);
                        const destLat = parseFloat(destinationResults[0].lat);
                        const destLng = parseFloat(destinationResults[0].lon);
                        
                        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                        
                        // Higher base fare for light truck
                        let baseFare = 50;
                        
                        if (distance > 0) {
                            baseFare += Math.ceil(distance / 50); // Higher per distance rate
                        }
                        
                        // Add weight and dimension surcharges
                        const weight = parseFloat(document.getElementById('truckItemWeight').value) || 0;
                        if (weight > 50) baseFare += Math.floor(weight / 10) * 10;
                        
                        document.getElementById('lightTruckDeliveryFee').textContent = `K${baseFare.toFixed(2)}`;
                        document.getElementById('lightTruckDeliveryFeeDisplay').classList.add('active');
                        
                        const etaMinutes = Math.ceil((distance / 1000) / 20 * 60); // Slower for trucks
                        document.getElementById('lightTruckEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        document.getElementById('lightTruckDeliveryBtn').disabled = false;
                        
                        updateTruckPickupMarker(pickupLat, pickupLng, pickupResults[0].display_name);
                        updateTruckDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                        
                        drawRoute(pickupLat, pickupLng, destLat, destLng);
                    }
                });
            } else {
                document.getElementById('lightTruckDeliveryFee').textContent = 'K0.00';
                document.getElementById('lightTruckEtaDisplay').textContent = 'ETA: -- min';
                document.getElementById('lightTruckDeliveryBtn').disabled = true;
            }
        }

        // NEW: Calculate schedule ride fee
        function calculateScheduleRideFee() {
            const pickupLocation = document.getElementById('schedulePickupLocation').value;
            const destinationLocation = document.getElementById('scheduleDestinationLocation').value;
            
            if (pickupLocation.length > 3 && destinationLocation.length > 3) {
                Promise.all([
                    forwardGeocode(pickupLocation),
                    forwardGeocode(destinationLocation)
                ]).then(([pickupResults, destinationResults]) => {
                    if (pickupResults.length > 0 && destinationResults.length > 0) {
                        const pickupLat = parseFloat(pickupResults[0].lat);
                        const pickupLng = parseFloat(pickupResults[0].lon);
                        const destLat = parseFloat(destinationResults[0].lat);
                        const destLng = parseFloat(destinationResults[0].lon);
                        
                        const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                        
                        let baseFare = 23;
                        
                        if (distance > 0) {
                            baseFare += Math.ceil(distance / 90);
                        }
                        
                        // Apply standard ride type for scheduled rides
                        baseFare *= rideTypeMultipliers['standard'];
                        
                        // Add 10% premium for scheduled rides
                        baseFare *= 1.1;
                        
                        document.getElementById('scheduleRideFare').textContent = `K${baseFare.toFixed(2)}`;
                        document.getElementById('scheduleRideFareDisplay').classList.add('active');
                        
                        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                        document.getElementById('scheduleRideEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        document.getElementById('scheduleRideBtn').disabled = false;
                        
                        updateSchedulePickupMarker(pickupLat, pickupLng, pickupResults[0].display_name);
                        updateScheduleDestinationMarker(destLat, destLng, destinationResults[0].display_name);
                        
                        drawRoute(pickupLat, pickupLng, destLat, destLng);
                    }
                });
            } else {
                document.getElementById('scheduleRideFare').textContent = 'K0.00';
                document.getElementById('scheduleRideEtaDisplay').textContent = 'ETA: -- min';
                document.getElementById('scheduleRideBtn').disabled = true;
            }
        }

        // NEW: Calculate emergency service fee
        function calculateEmergencyFee(vehicleType, distance = 0) {
            let baseFare = emergencyBaseFares[vehicleType] || 200;
            
            if (distance > 0) {
                baseFare += Math.ceil(distance / 50) * 10; // Higher per distance rate for emergencies
            }
            
            document.getElementById('emergencyFee').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('emergencyFeeDisplay').classList.add('active');
            
            const etaMinutes = Math.max(5, Math.ceil((distance / 1000) / 40 * 60)); // Minimum 5 minutes for emergencies
            document.getElementById('emergencyEtaDisplay').textContent = `ETA: ${etaMinutes} min`;
            
            return baseFare;
        }

        // Update destination marker
        function updateDestinationMarker(lat, lng, name) {
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
            }
            
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Your destination`)
                .openPopup();
            
            if (userLocation) {
                const bounds = L.latLngBounds(
                    [userLocation.lat, userLocation.lng],
                    [lat, lng]
                );
                passengerMap.fitBounds(bounds, { padding: [12, 12] });
            }
        }

        // NEW: Update recipient pickup marker
        function updateRecipientPickupMarker(lat, lng, name) {
            if (recipientPickupMarker) {
                passengerMap.removeLayer(recipientPickupMarker);
            }
            
            recipientPickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Recipient Pickup Location`)
                .openPopup();
        }

        // NEW: Update recipient destination marker
        function updateRecipientDestinationMarker(lat, lng, name) {
            if (recipientDestinationMarker) {
                passengerMap.removeLayer(recipientDestinationMarker);
            }
            
            recipientDestinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Recipient Destination`)
                .openPopup();
        }

        // NEW: Update shop location marker
        function updateShopLocationMarker(lat, lng, name) {
            if (shopLocationMarker) {
                passengerMap.removeLayer(shopLocationMarker);
            }
            
            shopLocationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-shopping-bag"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Shop Location`)
                .openPopup();
        }

        // NEW: Update delivery destination marker
        function updateDeliveryDestinationMarker(lat, lng, name) {
            if (deliveryDestinationMarker) {
                passengerMap.removeLayer(deliveryDestinationMarker);
            }
            
            deliveryDestinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Delivery Destination`)
                .openPopup();
        }

        // NEW: Update truck pickup marker
        function updateTruckPickupMarker(lat, lng, name) {
            if (truckPickupMarker) {
                passengerMap.removeLayer(truckPickupMarker);
            }
            
            truckPickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-truck-pickup"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Truck Pickup Location`)
                .openPopup();
        }

        // NEW: Update truck destination marker
        function updateTruckDestinationMarker(lat, lng, name) {
            if (truckDestinationMarker) {
                passengerMap.removeLayer(truckDestinationMarker);
            }
            
            truckDestinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Truck Destination`)
                .openPopup();
        }

        // NEW: Update schedule pickup marker
        function updateSchedulePickupMarker(lat, lng, name) {
            // Reuse pickup marker for schedule
            if (pickupMarker) {
                passengerMap.removeLayer(pickupMarker);
            }
            
            pickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Scheduled Pickup`)
                .openPopup();
        }

        // NEW: Update schedule destination marker
        function updateScheduleDestinationMarker(lat, lng, name) {
            // Reuse destination marker for schedule
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
            }
            
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [22, 22]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Scheduled Destination`)
                .openPopup();
        }

        // Draw route on map
        function drawRoute(startLat, startLng, endLat, endLng) {
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
            }
            
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7,
                            dashArray: '8, 8'
                        }).addTo(passengerMap);
                        
                        passengerMap.fitBounds(routePolyline.getBounds(), { padding: [12, 12] });
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    }).addTo(passengerMap);
                });
        }

        // ENHANCED: Ride request function with ride type support
        function requestRide() {
            const pickupLocation = document.getElementById('pickupLocation').value;
            const destinationLocation = document.getElementById('destinationLocation').value;
            
            if (!destinationLocation) {
                showNotification('Please enter a destination');
                return;
            }
            
            if (!currentLocationMarker && !pickupMarker) {
                showNotification('Unable to determine your location. Please try again.');
                return;
            }
            
            const pickupLatLng = pickupMarker ? pickupMarker.getLatLng() : currentLocationMarker.getLatLng();
            
            if (document.getElementById('packageForm').classList.contains('active')) {
                packageDetails = {
                    receiverName: document.getElementById('receiverName').value,
                    receiverPhone: document.getElementById('receiverPhone').value,
                    packageDescription: document.getElementById('packageDescription').value,
                    specialInstructions: document.getElementById('specialInstructions').value,
                    packageValue: document.getElementById('packageValue').value
                };
            } else {
                packageDetails = null;
            }
            
            Promise.all([
                getFullAddress(pickupLatLng.lat, pickupLatLng.lng),
                forwardGeocode(destinationLocation)
            ]).then(([fullPickupAddress, destinationResults]) => {
                if (destinationResults.length === 0) {
                    showNotification('Invalid destination address. Please select a valid destination.');
                    return;
                }
                
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(
                    pickupLatLng.lat, pickupLatLng.lng,
                    destLat, destLng
                );
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                // Apply ride type multiplier
                baseFare *= rideTypeMultipliers[selectedRideType] || 1;
                
                // Apply promo code discount if applicable
                if (appliedPromoCode) {
                    baseFare = baseFare * 0.8;
                }
                
                const rideId = database.ref().child('rides').push().key;
                
                const rideRequest = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: fullPickupAddress,
                    pickupDisplayLocation: pickupLocation,
                    destination: destinationLocation,
                    pickupLat: pickupLatLng.lat,
                    pickupLng: pickupLatLng.lng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: selectedVehicleType,
                    rideClass: selectedRideType, // NEW: Store ride class
                    fare: baseFare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'requested',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    promoCode: appliedPromoCode,
                    paymentMethod: selectedPaymentType,
                    packageDetails: packageDetails,
                    currentCity: currentCity
                };
                
                currentRideRequestData = rideRequest;
                currentRideRequestType = 'standard';
                
                showPaymentSelection(baseFare);
            }).catch(error => {
                console.error('Error in ride request process:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }

        // NEW: Submit order for someone else
        function submitOrderForSomeone() {
            const pickupLocation = document.getElementById('recipientPickupLocation').value;
            const destinationLocation = document.getElementById('recipientDestinationLocation').value;
            const recipientName = document.getElementById('recipientName').value;
            const recipientEmail = document.getElementById('recipientEmail').value;
            const recipientPhone = document.getElementById('recipientPhone').value;
            
            if (!pickupLocation || !destinationLocation || !recipientName) {
                showNotification('Please fill in all required fields.');
                return;
            }
            
            Promise.all([
                forwardGeocode(pickupLocation),
                forwardGeocode(destinationLocation)
            ]).then(([pickupResults, destinationResults]) => {
                if (pickupResults.length === 0 || destinationResults.length === 0) {
                    showNotification('Invalid pickup or destination address. Please select valid locations.');
                    return;
                }
                
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                // Apply standard ride type for someone else orders
                baseFare *= rideTypeMultipliers['standard'];
                
                const rideId = database.ref().child('rides').push().key;
                
                const rideRequest = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: pickupResults[0].display_name,
                    destination: destinationResults[0].display_name,
                    pickupLat: pickupLat,
                    pickupLng: pickupLng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: 'car',
                    rideClass: 'standard',
                    fare: baseFare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'requested',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: selectedPaymentType,
                    orderForSomeone: {
                        recipientName: recipientName,
                        recipientEmail: recipientEmail,
                        recipientPhone: recipientPhone,
                        orderedBy: userData.name || 'Passenger'
                    },
                    currentCity: currentCity
                };
                
                currentRideRequestData = rideRequest;
                currentRideRequestType = 'order-for-someone';
                
                showPaymentSelection(baseFare);
            }).catch(error => {
                console.error('Error in order for someone process:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }

        // NEW: Submit express delivery
        function submitExpressDelivery() {
            const shopName = document.getElementById('shopName').value;
            const shopLocation = document.getElementById('shopLocation').value;
            const deliveryItems = document.getElementById('deliveryItems').value;
            const deliveryAmount = document.getElementById('deliveryAmount').value;
            const deliveryInstructions = document.getElementById('deliveryInstructions').value;
            const deliveryDestination = document.getElementById('deliveryDestination').value;
            const vehicleType = document.querySelector('.express-delivery-form .delivery-mode-option.selected').getAttribute('data-type');
            
            if (!shopName || !shopLocation || !deliveryDestination) {
                showNotification('Please fill in all required fields.');
                return;
            }
            
            Promise.all([
                forwardGeocode(shopLocation),
                forwardGeocode(deliveryDestination)
            ]).then(([shopResults, destinationResults]) => {
                if (shopResults.length === 0 || destinationResults.length === 0) {
                    showNotification('Invalid shop or destination address. Please select valid locations.');
                    return;
                }
                
                const shopLat = parseFloat(shopResults[0].lat);
                const shopLng = parseFloat(shopResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(shopLat, shopLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                switch(vehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'bicycle':
                        baseFare = baseFare * 0.5;
                        break;
                }
                
                const rideId = database.ref().child('rides').push().key;
                
                const rideRequest = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: shopResults[0].display_name,
                    destination: destinationResults[0].display_name,
                    pickupLat: shopLat,
                    pickupLng: shopLng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: vehicleType,
                    rideClass: 'delivery',
                    fare: baseFare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'requested',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: selectedPaymentType,
                    expressDelivery: {
                        shopName: shopName,
                        items: deliveryItems,
                        amount: deliveryAmount,
                        instructions: deliveryInstructions
                    },
                    currentCity: currentCity
                };
                
                currentRideRequestData = rideRequest;
                currentRideRequestType = 'express-delivery';
                
                showPaymentSelection(baseFare);
            }).catch(error => {
                console.error('Error in express delivery process:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }

        // NEW: Submit light truck delivery
        function submitLightTruckDelivery() {
            const pickupLocation = document.getElementById('truckPickupLocation').value;
            const destination = document.getElementById('truckDestination').value;
            const itemDescription = document.getElementById('truckItemDescription').value;
            const itemWeight = document.getElementById('truckItemWeight').value;
            const itemDimensions = document.getElementById('truckItemDimensions').value;
            const specialRequirements = document.getElementById('truckSpecialRequirements').value;
            
            if (!pickupLocation || !destination || !itemDescription) {
                showNotification('Please fill in all required fields.');
                return;
            }
            
            Promise.all([
                forwardGeocode(pickupLocation),
                forwardGeocode(destination)
            ]).then(([pickupResults, destinationResults]) => {
                if (pickupResults.length === 0 || destinationResults.length === 0) {
                    showNotification('Invalid pickup or destination address. Please select valid locations.');
                    return;
                }
                
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 50;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 50);
                }
                
                const weight = parseFloat(itemWeight) || 0;
                if (weight > 50) baseFare += Math.floor(weight / 10) * 10;
                
                const rideId = database.ref().child('rides').push().key;
                
                const rideRequest = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: pickupResults[0].display_name,
                    destination: destinationResults[0].display_name,
                    pickupLat: pickupLat,
                    pickupLng: pickupLng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: 'light-truck',
                    rideClass: 'delivery',
                    fare: baseFare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'requested',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: selectedPaymentType,
                    truckDelivery: {
                        itemDescription: itemDescription,
                        weight: itemWeight,
                        dimensions: itemDimensions,
                        specialRequirements: specialRequirements
                    },
                    currentCity: currentCity
                };
                
                currentRideRequestData = rideRequest;
                currentRideRequestType = 'light-truck-delivery';
                
                showPaymentSelection(baseFare);
            }).catch(error => {
                console.error('Error in light truck delivery process:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }

        // NEW: Submit schedule ride
        function submitScheduleRide() {
            const pickupLocation = document.getElementById('schedulePickupLocation').value;
            const destinationLocation = document.getElementById('scheduleDestinationLocation').value;
            const scheduleDate = document.getElementById('scheduleDate').value;
            const scheduleTime = document.getElementById('scheduleTime').value;
            
            if (!pickupLocation || !destinationLocation || !scheduleDate || !scheduleTime) {
                showNotification('Please fill in all required fields.');
                return;
            }
            
            const scheduledDateTime = new Date(`${scheduleDate}T${scheduleTime}`);
            const now = new Date();
            
            if (scheduledDateTime <= now) {
                showNotification('Please select a future date and time.');
                return;
            }
            
            Promise.all([
                forwardGeocode(pickupLocation),
                forwardGeocode(destinationLocation)
            ]).then(([pickupResults, destinationResults]) => {
                if (pickupResults.length === 0 || destinationResults.length === 0) {
                    showNotification('Invalid pickup or destination address. Please select valid locations.');
                    return;
                }
                
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                baseFare *= rideTypeMultipliers['standard'];
                baseFare *= 1.1; // 10% premium for scheduled rides
                
                const rideId = database.ref().child('scheduledRides').push().key;
                
                const scheduledRide = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: pickupResults[0].display_name,
                    destination: destinationResults[0].display_name,
                    pickupLat: pickupLat,
                    pickupLng: pickupLng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: 'car',
                    rideClass: 'scheduled',
                    fare: baseFare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'scheduled',
                    scheduledTime: scheduledDateTime.getTime(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: selectedPaymentType,
                    currentCity: currentCity
                };
                
                database.ref('scheduledRides/' + rideId).set(scheduledRide)
                    .then(() => {
                        showNotification('Ride scheduled successfully!');
                        
                        // Hide form and show countdown if within 1 hour
                        cancelMoreOptionForm();
                        
                        const timeDiff = scheduledDateTime - now;
                        if (timeDiff <= 3600000) {
                            startCountdown(scheduledRide);
                        }
                    })
                    .catch(error => {
                        console.error('Error scheduling ride:', error);
                        showNotification('Error scheduling ride. Please try again.');
                    });
            }).catch(error => {
                console.error('Error in schedule ride process:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }

        // NEW: Submit schedule delivery
        function submitScheduleDelivery() {
            const deliveryItems = document.getElementById('scheduleDeliveryItems').value;
            const pickupLocation = document.getElementById('scheduleDeliveryPickup').value;
            const destination = document.getElementById('scheduleDeliveryDestination').value;
            const deliveryDate = document.getElementById('scheduleDeliveryDate').value;
            const deliveryTime = document.getElementById('scheduleDeliveryTime').value;
            const vehicleType = document.querySelector('.schedule-delivery-form .delivery-mode-option.selected').getAttribute('data-type');
            
            if (!deliveryItems || !pickupLocation || !destination || !deliveryDate || !deliveryTime) {
                showNotification('Please fill in all required fields.');
                return;
            }
            
            const scheduledDateTime = new Date(`${deliveryDate}T${deliveryTime}`);
            const now = new Date();
            
            if (scheduledDateTime <= now) {
                showNotification('Please select a future date and time.');
                return;
            }
            
            Promise.all([
                forwardGeocode(pickupLocation),
                forwardGeocode(destination)
            ]).then(([pickupResults, destinationResults]) => {
                if (pickupResults.length === 0 || destinationResults.length === 0) {
                    showNotification('Invalid pickup or destination address. Please select valid locations.');
                    return;
                }
                
                const pickupLat = parseFloat(pickupResults[0].lat);
                const pickupLng = parseFloat(pickupResults[0].lon);
                const destLat = parseFloat(destinationResults[0].lat);
                const destLng = parseFloat(destinationResults[0].lon);
                
                const distance = calculateDistance(pickupLat, pickupLng, destLat, destLng);
                
                let baseFare = 23;
                
                if (distance > 0) {
                    baseFare += Math.ceil(distance / 90);
                }
                
                switch(vehicleType) {
                    case 'car':
                        baseFare = baseFare;
                        break;
                    case 'bike':
                        baseFare = baseFare * 0.7;
                        break;
                    case 'light-truck':
                        baseFare = baseFare * 2; // Double for light truck
                        break;
                }
                
                baseFare *= 1.1; // 10% premium for scheduled deliveries
                
                const rideId = database.ref().child('scheduledRides').push().key;
                
                const scheduledDelivery = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: pickupResults[0].display_name,
                    destination: destinationResults[0].display_name,
                    pickupLat: pickupLat,
                    pickupLng: pickupLng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: vehicleType,
                    rideClass: 'scheduled-delivery',
                    fare: baseFare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'scheduled',
                    scheduledTime: scheduledDateTime.getTime(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    paymentMethod: selectedPaymentType,
                    deliveryItems: deliveryItems,
                    currentCity: currentCity
                };
                
                database.ref('scheduledRides/' + rideId).set(scheduledDelivery)
                    .then(() => {
                        showNotification('Delivery scheduled successfully!');
                        
                        cancelMoreOptionForm();
                        
                        const timeDiff = scheduledDateTime - now;
                        if (timeDiff <= 3600000) {
                            startCountdown(scheduledDelivery);
                        }
                    })
                    .catch(error => {
                        console.error('Error scheduling delivery:', error);
                        showNotification('Error scheduling delivery. Please try again.');
                    });
            }).catch(error => {
                console.error('Error in schedule delivery process:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }

        // NEW: Handle emergency service selection
        function handleEmergencyServiceSelection(vehicleType) {
            emergencyVehicleType = vehicleType;
            
            // Hide emergency services form
            document.getElementById('emergencyServicesForm').classList.remove('active');
            
            // Show emergency questionnaire
            document.getElementById('emergencyQuestionnaire').classList.add('active');
            
            // Pre-fill emergency type based on vehicle
            let emergencyType = 'other';
            switch(vehicleType) {
                case 'ambulance':
                    emergencyType = 'medical';
                    break;
                case 'fire-truck':
                    emergencyType = 'fire';
                    break;
                case 'emergency-ride':
                case 'emergency-delivery':
                    emergencyType = 'accident';
                    break;
                case 'sos':
                    emergencyType = 'security';
                    break;
            }
            
            document.getElementById('emergencyType').value = emergencyType;
            
            // Calculate emergency fee
            const distance = userLocation ? calculateDistance(
                userLocation.lat, userLocation.lng,
                userLocation.lat, userLocation.lng
            ) : 0;
            
            calculateEmergencyFee(vehicleType, distance);
        }

        // NEW: Submit emergency service request
        function submitEmergencyRequest() {
            const emergencyType = document.getElementById('emergencyType').value;
            const emergencySeverity = document.getElementById('emergencySeverity').value;
            const emergencyDescription = document.getElementById('emergencyDescription').value;
            const emergencyInjuries = document.getElementById('emergencyInjuries').value;
            const emergencyPeople = document.getElementById('emergencyPeople').value;
            
            if (!emergencyType || !emergencySeverity || !emergencyDescription) {
                showNotification('Please fill in all required emergency details.');
                return;
            }
            
            // Store emergency details
            emergencyDetails = {
                type: emergencyType,
                severity: emergencySeverity,
                description: emergencyDescription,
                injuries: emergencyInjuries,
                peopleInvolved: emergencyPeople,
                timestamp: new Date().toISOString()
            };
            
            // Calculate fare
            const distance = userLocation ? 0 : 0; // Emergency vehicles come to current location
            const baseFare = calculateEmergencyFee(emergencyVehicleType, distance);
            
            const rideId = database.ref().child('rides').push().key;
            
            const emergencyRequest = {
                id: rideId,
                passengerId: currentUser.uid,
                passengerName: userData.name || 'Passenger',
                passengerPhone: userData.phone || 'Not provided',
                pickupLocation: 'Current Location',
                destination: 'Emergency Location',
                pickupLat: userLocation ? userLocation.lat : -15.4167,
                pickupLng: userLocation ? userLocation.lng : 28.2833,
                destLat: userLocation ? userLocation.lat : -15.4167,
                destLng: userLocation ? userLocation.lng : 28.2833,
                rideType: emergencyVehicleType,
                rideClass: 'emergency',
                fare: baseFare,
                distance: '0 km',
                status: 'requested',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                paymentMethod: 'emergency',
                emergencyDetails: emergencyDetails,
                currentCity: currentCity,
                priority: 'high'
            };
            
            currentRideRequestData = emergencyRequest;
            currentRideRequestType = 'emergency';
            
            // For emergencies, skip payment and request immediately
            submitEmergencyRideRequest(emergencyRequest);
        }

        // NEW: Submit emergency ride request (skips payment)
        function submitEmergencyRideRequest(rideRequest) {
            database.ref('rides/' + rideRequest.id).set(rideRequest)
                .then(() => {
                    currentRide = rideRequest;
                    
                    // Hide emergency forms
                    document.getElementById('emergencyQuestionnaire').classList.remove('active');
                    document.getElementById('rideRequestForm').style.display = 'flex';
                    
                    updateUIForActiveRide();
                    
                    // Show emergency ride status
                    document.getElementById('emergencyRideStatus').style.display = 'flex';
                    emergencyMode = true;
                    
                    // Show searching animation
                    document.getElementById('searchingAnimation').style.display = 'flex';
                    
                    document.getElementById('rideStatus').style.display = 'flex';
                    document.getElementById('statusDot').className = 'status-dot searching';
                    document.getElementById('statusText').textContent = 'Searching for emergency vehicle';
                    
                    // Show SOS button
                    if (sosConfig && sosConfig.contact1) {
                        document.getElementById('sosButton').style.display = 'flex';
                    }
                    
                    showNotification('Emergency service requested! Searching for vehicle...');
                    
                    listenForDriverAssignment(rideRequest.id);
                })
                .catch(error => {
                    console.error('Error requesting emergency service:', error);
                    showNotification('Error requesting emergency service. Please try again or call 911.');
                });
        }

        // Show payment selection
        function showPaymentSelection(fare = null) {
            const calculatedFare = fare || rideFare;
            
            document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
            
            if (walletBalance < calculatedFare) {
                document.getElementById('insufficientBalance').style.display = 'block';
                document.getElementById('confirmPaymentBtn').disabled = true;
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
            
            document.getElementById('paymentSelectionPopup').classList.remove('hidden');
        }

        // Close payment selection
        function closePaymentSelection() {
            document.getElementById('paymentSelectionPopup').classList.add('hidden');
        }

        // ENHANCED: Fast ride submission after payment confirmation with referral tracking
        function submitRideRequest() {
            if (!currentRideRequestData) {
                showNotification('No ride request data found. Please try again.');
                return;
            }
            
            const rideRequest = currentRideRequestData;
            
            // If payment is via wallet, deduct fare from wallet
            if (selectedPaymentType === 'wallet') {
                const newBalance = walletBalance - rideRequest.fare;
                
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    updateWalletBalanceUI();
                    
                    return database.ref('rides/' + rideRequest.id).set(rideRequest);
                })
                .then(() => {
                    currentRide = rideRequest;
                    
                    closePaymentSelection();
                    
                    updateUIForActiveRide();
                    
                    // Show searching animation immediately
                    document.getElementById('searchingAnimation').style.display = 'flex';
                    
                    document.getElementById('rideStatus').style.display = 'flex';
                    document.getElementById('statusDot').className = 'status-dot searching';
                    document.getElementById('statusText').textContent = 'Searching for driver';
                    
                    // Show SOS button if configured
                    if (sosConfig && sosConfig.contact1) {
                        document.getElementById('sosButton').style.display = 'flex';
                    }
                    
                    showNotification('Ride requested. Searching for a driver...');
                    
                    // NEW: Track referral if promo code was used
                    if (appliedPromoCode && appliedPromoCode.startsWith('JUBEL')) {
                        trackReferralUsage(rideRequest);
                    }
                    
                    listenForDriverAssignment(rideRequest.id);
                })
                .catch(error => {
                    console.error('Error requesting ride:', error);
                    showNotification('Error requesting ride. Please try again.');
                });
            } else {
                database.ref('rides/' + rideRequest.id).set(rideRequest)
                    .then(() => {
                        currentRide = rideRequest;
                        
                        closePaymentSelection();
                        
                        updateUIForActiveRide();
                        
                        document.getElementById('searchingAnimation').style.display = 'flex';
                        
                        document.getElementById('rideStatus').style.display = 'flex';
                        document.getElementById('statusDot').className = 'status-dot searching';
                        document.getElementById('statusText').textContent = 'Searching for driver';
                        
                        if (sosConfig && sosConfig.contact1) {
                            document.getElementById('sosButton').style.display = 'flex';
                        }
                        
                        showNotification('Ride requested. Searching for a driver...');
                        
                        // NEW: Track referral if promo code was used
                        if (appliedPromoCode && appliedPromoCode.startsWith('JUBEL')) {
                            trackReferralUsage(rideRequest);
                        }
                        
                        listenForDriverAssignment(rideRequest.id);
                    })
                    .catch(error => {
                        console.error('Error requesting ride:', error);
                        showNotification('Error requesting ride. Please try again.');
                    });
            }
            
            currentRideRequestData = null;
        }

        // NEW: Track referral usage and schedule reward payment
        function trackReferralUsage(rideRequest) {
            // Find the referrer by promo code
            database.ref('users').orderByChild('referralCode').equalTo(appliedPromoCode).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const referrerData = snapshot.val();
                        const referrerId = Object.keys(referrerData)[0];
                        const referrer = referrerData[referrerId];
                        
                        // Create referral tracking record
                        const referralTracking = {
                            referrerId: referrerId,
                            referredUserId: currentUser.uid,
                            referralCode: appliedPromoCode,
                            rideId: rideRequest.id,
                            rideFare: rideRequest.fare,
                            discountApplied: rideRequest.fare * 0.2, // 20% discount
                            status: 'pending', // Will change to 'completed' when ride completes
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            rewardAmount: 25, // K25 reward for referrer
                            rewardStatus: 'pending' // Will change to 'paid' when ride completes
                        };
                        
                        database.ref('referrals').push().set(referralTracking)
                            .then(() => {
                                console.log(`Referral tracked for ${referrer.name}`);
                            })
                            .catch(error => {
                                console.error('Error tracking referral:', error);
                            });
                    }
                })
                .catch(error => {
                    console.error('Error finding referrer:', error);
                });
        }

        // NEW: Complete referral reward when ride completes
        function completeReferralReward(rideId) {
            database.ref('referrals').orderByChild('rideId').equalTo(rideId).once('value')
                .then(snapshot => {
                    const referrals = snapshot.val();
                    if (referrals) {
                        for (const referralId in referrals) {
                            const referral = referrals[referralId];
                            if (referral.status === 'pending') {
                                // Update referral status
                                database.ref('referrals/' + referralId).update({
                                    status: 'completed',
                                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                                    rewardStatus: 'processing'
                                });
                                
                                // Pay reward to referrer after a short delay
                                setTimeout(() => {
                                    database.ref('users/' + referral.referrerId).once('value')
                                        .then(userSnapshot => {
                                            const referrer = userSnapshot.val();
                                            const newBalance = (referrer.walletBalance || 0) + referral.rewardAmount;
                                            
                                            return database.ref('users/' + referral.referrerId).update({
                                                walletBalance: newBalance
                                            });
                                        })
                                        .then(() => {
                                            database.ref('referrals/' + referralId).update({
                                                rewardStatus: 'paid',
                                                paidAt: firebase.database.ServerValue.TIMESTAMP
                                            });
                                            
                                            console.log(`Paid K${referral.rewardAmount} reward to referrer`);
                                        })
                                        .catch(error => {
                                            console.error('Error paying referral reward:', error);
                                        });
                                }, 5000); // 5 second delay
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error completing referral reward:', error);
                });
        }

        // Update UI for active ride
        function updateUIForActiveRide() {
            document.getElementById('rideRequestForm').style.display = 'none';
            
            document.getElementById('rideInfoPanel').style.display = 'block';
            
            document.getElementById('currentPickupLocation').textContent = currentRide.pickupDisplayLocation || currentRide.pickupLocation;
            document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
            
            const baseFare = currentRide.fare;
            const discount = appliedPromoCode ? baseFare * 0.2 : 0;
            const totalFare = baseFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
            
            // Show view receipt button for completed rides
            if (currentRide.status === 'completed') {
                document.getElementById('viewReceiptBtn').style.display = 'block';
            }
        }

        // Driver assignment handler
        function listenForDriverAssignment(rideId) {
            if (driverAssignmentListener) {
                driverAssignmentListener();
            }
            
            driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
                const ride = snapshot.val();
                if (!ride) {
                    showNotification('Ride not found. Please try again.');
                    return;
                }
                
                console.log('Ride status update:', ride.status, ride.driverId);
                
                if (ride.driverId && ride.status === 'accepted') {
                    handleDriverAssignment(ride);
                } else if (ride.status === 'completed') {
                    showRideCompletion(ride);
                } else if (ride.status === 'cancelled') {
                    handleRideCancellation(ride);
                } else if (ride.status === 'arrived') {
                    showNotification('Your driver has arrived at the pickup location.');
                } else if (ride.status === 'picked_up') {
                    showNotification('You have been picked up. Enjoy your ride!');
                } else if (ride.status === 'started') {
                    showNotification('Your trip has started.');
                }
            }, error => {
                console.error('Error listening for driver assignment:', error);
                showNotification('Connection error. Please check your internet connection.');
            });
        }

        // Handle driver assignment
        function handleDriverAssignment(ride) {
            document.getElementById('searchingAnimation').style.display = 'none';
            
            document.getElementById('statusDot').className = 'status-dot arriving';
            document.getElementById('statusText').textContent = 'Driver arriving';
            
            document.getElementById('estimatedTime').style.display = 'flex';
            document.getElementById('timeText').textContent = '5 min';
            
            database.ref('users/' + ride.driverId).once('value')
                .then(driverSnapshot => {
                    const driver = driverSnapshot.val();
                    if (driver) {
                        document.getElementById('driverName').textContent = driver.name || 'Driver';
                        document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                        document.getElementById('driverRating').textContent = driver.rating || '4.5';
                        
                        if (driver.vehicle) {
                            document.getElementById('vehicleDetails').textContent = 
                                `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                        }
                        
                        updateDriverAvatarWithImage(driver, ride);
                        updateDriverVehicleDisplay(driver, ride);
                        updateDriverDetailsCard(driver);
                        
                        // Add emergency vehicle marker if emergency ride
                        if (ride.rideType === 'ambulance' || ride.rideType === 'fire-truck') {
                            addEmergencyVehicleMarker(ride.driverLat, ride.driverLng, ride.rideType);
                        } else {
                            addDriverMarker(ride.driverLat, ride.driverLng);
                        }
                        
                        drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                        
                        trackDriverLocation(ride.driverId);
                        
                        showNotification(`Driver ${driver.name} is on the way!`);
                    }
                });
            
            listenForRideStatusUpdates(ride.id);
        }

        // NEW: Add emergency vehicle marker
        function addEmergencyVehicleMarker(lat, lng, vehicleType) {
            if (emergencyVehicleMarker) {
                passengerMap.removeLayer(emergencyVehicleMarker);
            }
            
            let iconClass, iconHtml;
            
            switch(vehicleType) {
                case 'ambulance':
                    iconClass = 'ambulance-marker';
                    iconHtml = '<div class="ambulance-marker"><i class="fas fa-ambulance"></i></div>';
                    break;
                case 'fire-truck':
                    iconClass = 'fire-truck-marker';
                    iconHtml = '<div class="fire-truck-marker"><i class="fas fa-fire-truck"></i></div>';
                    break;
                default:
                    iconClass = 'driver-marker';
                    iconHtml = '<div class="driver-marker"></div><div class="driver-marker-label">Emergency</div>';
            }
            
            emergencyVehicleMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: iconClass,
                    html: iconHtml,
                    iconSize: vehicleType === 'ambulance' || vehicleType === 'fire-truck' ? [40, 40] : [32, 45]
                })
            }).addTo(passengerMap)
                .bindPopup('Emergency Vehicle');
        }

        // Update driver avatar with profile image
        function updateDriverAvatarWithImage(driver, ride) {
            const driverAvatar = document.getElementById('driverAvatar');
            
            if (ride.driverProfileImage) {
                driverProfileImage = ride.driverProfileImage;
                driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else if (driver.images && driver.images.profilePhoto) {
                driverProfileImage = driver.images.profilePhoto;
                driverAvatar.innerHTML = `<img src="${driverProfileImage}" class="driver-profile-image" alt="Driver" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else if (driver.name) {
                driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
            } else {
                driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }

        // Update driver vehicle display with vehicle image and details
        function updateDriverVehicleDisplay(driver, ride) {
            const vehicleImageSection = document.getElementById('vehicleImageSection');
            
            if (!vehicleImageSection) {
                const driverDetailsCard = document.getElementById('driverDetailsCard');
                const vehicleSection = document.createElement('div');
                vehicleSection.id = 'vehicleImageSection';
                vehicleSection.className = 'vehicle-image-section';
                vehicleSection.style.cssText = `
                    margin-top: 10px;
                    padding: 10px;
                    background: var(--light-gray);
                    border-radius: var(--element-radius);
                    border: 1px solid var(--border-color);
                `;
                vehicleSection.innerHTML = `
                    <h4 class="section-title" style="font-size: 0.8rem; margin-bottom: 8px;">
                        <i class="fas fa-car"></i> Driver's Vehicle
                    </h4>
                    <div id="vehicleImageContainer"></div>
                `;
                driverDetailsCard.appendChild(vehicleSection);
            }
            
            const vehicleImageContainer = document.getElementById('vehicleImageContainer');
            
            if (ride.vehicleImage) {
                driverVehicleImage = ride.vehicleImage;
                vehicleImageContainer.innerHTML = `
                    <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                    <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                        <div class="vehicle-detail">
                            <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                        </div>
                    </div>
                `;
            } else if (driver.images && driver.images.vehicleFront) {
                driverVehicleImage = driver.images.vehicleFront;
                vehicleImageContainer.innerHTML = `
                    <img id="vehicleFrontImage" class="vehicle-image" src="${driverVehicleImage}" alt="Vehicle" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                    <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem;">
                        <div class="vehicle-detail">
                            <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                        </div>
                    </div>
                `;
            } else {
                vehicleImageContainer.innerHTML = `
                    <div class="no-vehicle-image" style="text-align: center; padding: 20px; color: var(--medium-gray); font-size: 0.8rem;">
                        <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 8px; display: block;"></i>
                        Vehicle image not available
                    </div>
                    <div class="vehicle-details-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.7rem; margin-top: 8px;">
                        <div class="vehicle-detail">
                            <strong>Type:</strong> ${driver.vehicle?.type || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Model:</strong> ${driver.vehicle?.model || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Color:</strong> ${driver.vehicle?.color || 'N/A'}
                        </div>
                        <div class="vehicle-detail">
                            <strong>Plate:</strong> ${driver.vehicle?.licensePlate || 'N/A'}
                        </div>
                    </div>
                `;
            }
        }

        // Update driver details card
        function updateDriverDetailsCard(driver) {
            const driverDetailsCard = document.getElementById('driverDetailsCard');
            driverDetailsCard.style.display = 'block';
            
            document.getElementById('driverFullName').textContent = driver.name || 'Driver';
            document.getElementById('driverContactPhone').textContent = driver.phone || 'Not available';
            document.getElementById('driverRatingValue').textContent = driver.rating ? `${driver.rating} ` : '4.5 ';
            document.getElementById('driverExperience').textContent = driver.experience || '2 years';
            
            if (driver.vehicle) {
                document.getElementById('vehicleType').textContent = driver.vehicle.type || 'Car';
                document.getElementById('vehicleModel').textContent = driver.vehicle.model || 'Not specified';
                document.getElementById('vehicleLicense').textContent = driver.vehicle.licensePlate || 'Not available';
                document.getElementById('vehicleColor').textContent = driver.vehicle.color || 'Not specified';
            }
        }

        // Track driver location
        function trackDriverLocation(driverId) {
            if (driverLocationListener) {
                driverLocationListener();
            }
            
            driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
                const location = snapshot.val();
                if (location && driverMarker) {
                    driverMarker.setLatLng([location.latitude, location.longitude]);
                    
                    updateDriverETA(location.latitude, location.longitude);
                }
            });
        }

        // Update driver ETA
        function updateDriverETA(driverLat, driverLng) {
            if (userLocation) {
                const distance = calculateDistance(
                    driverLat, driverLng,
                    userLocation.lat, userLocation.lng
                );
                
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('timeText').textContent = `${etaMinutes} min`;
            }
        }

        // Add driver marker
        function addDriverMarker(lat, lng) {
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
            }
            
            driverMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'driver-marker',
                    html: '<div class="driver-marker"></div><div class="driver-marker-label">Driver</div>',
                    iconSize: [32, 45]
                })
            }).addTo(passengerMap)
                .bindPopup('Your driver');
        }

        // Listen for ride status updates
        function listenForRideStatusUpdates(rideId) {
            database.ref('rides/' + rideId).on('value', snapshot => {
                const ride = snapshot.val();
                if (ride) {
                    currentRide = ride;
                    
                    switch(ride.status) {
                        case 'accepted':
                            document.getElementById('statusText').textContent = 'Driver on the way';
                            break;
                        case 'arrived':
                            document.getElementById('statusText').textContent = 'Driver arrived';
                            document.getElementById('statusDot').className = 'status-dot riding';
                            showNotification('Your driver has arrived!');
                            break;
                        case 'started':
                            document.getElementById('statusText').textContent = 'Trip in progress';
                            addDestinationMarker(ride.destLat, ride.destLng);
                            drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                            break;
                        case 'completed':
                            document.getElementById('statusText').textContent = 'Trip completed';
                            document.getElementById('rideStatus').style.display = 'none';
                            document.getElementById('estimatedTime').style.display = 'none';
                            document.getElementById('emergencyRideStatus').style.display = 'none';
                            document.getElementById('sosButton').style.display = 'none';
                            
                            // NEW: Complete referral reward
                            completeReferralReward(rideId);
                            
                            resetUIAfterRide();
                            
                            // Show receipt button
                            document.getElementById('viewReceiptBtn').style.display = 'block';
                            
                            showNotification('Trip completed. Thank you for using Jubel!');
                            break;
                        case 'cancelled':
                            document.getElementById('rideStatus').style.display = 'none';
                            document.getElementById('estimatedTime').style.display = 'none';
                            document.getElementById('emergencyRideStatus').style.display = 'none';
                            document.getElementById('sosButton').style.display = 'none';
                            resetUIAfterRide();
                            showNotification('Ride cancelled');
                            break;
                    }
                }
            });
        }

        // Show ride completion
        function showRideCompletion(ride) {
            document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
            
            showNotification('Ride completed. Please complete payment and rating.');
            
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            if (emergencyVehicleMarker) {
                passengerMap.removeLayer(emergencyVehicleMarker);
                emergencyVehicleMarker = null;
            }
            
            if (driverAssignmentListener) {
                driverAssignmentListener();
                driverAssignmentListener = null;
            }
            
            if (driverLocationListener) {
                driverLocationListener();
                driverLocationListener = null;
            }
        }

        // Handle ride cancellation
        function handleRideCancellation(ride) {
            document.getElementById('searchingAnimation').style.display = 'none';
            
            showNotification('Ride has been cancelled.');
            resetUIAfterRide();
            currentRide = null;
            
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            if (emergencyVehicleMarker) {
                passengerMap.removeLayer(emergencyVehicleMarker);
                emergencyVehicleMarker = null;
            }
            
            if (driverAssignmentListener) {
                driverAssignmentListener();
                driverAssignmentListener = null;
            }
            
            if (driverLocationListener) {
                driverLocationListener();
                driverLocationListener = null;
            }
        }

        // Cancel ride
        function cancelRide() {
            if (currentRide) {
                if (confirm('Are you sure you want to cancel this ride?')) {
                    database.ref('rides/' + currentRide.id).update({
                        status: 'cancelled',
                        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        resetUIAfterRide();
                        showNotification('Ride cancelled');
                    })
                    .catch(error => {
                        console.error('Error cancelling ride:', error);
                        showNotification('Error cancelling ride. Please try again.');
                    });
                }
            }
        }

        // Contact driver
        function contactDriver() {
            if (currentRide && currentRide.driverId) {
                database.ref('users/' + currentRide.driverId).once('value')
                    .then(snapshot => {
                        const driver = snapshot.val();
                        if (driver && driver.phone) {
                            showNotification(`Calling driver: ${driver.phone}`);
                            window.open(`tel:${driver.phone}`, '_self');
                        } else {
                            showNotification('Driver phone number not available.');
                        }
                    });
            }
        }

        // Apply promo code
        function applyPromoCode() {
            const promoCode = document.getElementById('promoCode').value.trim();
            
            if (!promoCode) {
                showNotification('Please enter a promo code.');
                return;
            }
            
            if (promoCode.startsWith('JUBEL')) {
                applyReferralCode(promoCode);
            } else {
                if (promoCode.startsWith('JUBEL-')) {
                    appliedPromoCode = promoCode;
                    showNotification('Promo code applied! 20% discount will be applied to your ride.');
                    updateFareEstimate();
                    
                    document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                    document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                    document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                    document.getElementById('applyPromoBtn').classList.add('btn-success');
                } else {
                    showNotification('Invalid promo code. Please check and try again.');
                    document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
                }
            }
        }

        // Apply referral code
        function applyReferralCode(referralCode) {
            database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const referrerData = snapshot.val();
                        const referrerId = Object.keys(referrerData)[0];
                        const referrer = referrerData[referrerId];
                        
                        appliedPromoCode = referralCode;
                        showNotification('Referral code applied! 50% discount will be applied to your ride.');
                        updateFareEstimate();
                        
                        document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                        document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                        document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                        document.getElementById('applyPromoBtn').classList.add('btn-success');
                        
                        // Note: Reward will be paid when ride is completed (tracked in completeReferralReward)
                        console.log(`Referral from ${referrer.name} applied. Reward will be paid after ride completion.`);
                    } else {
                        showNotification('Invalid referral code. Please check and try again.');
                        document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
                    }
                })
                .catch(error => {
                    console.error('Error applying referral code:', error);
                    showNotification('Error applying referral code. Please try again.');
                });
        }

        // Reset UI after ride
        function resetUIAfterRide() {
            document.getElementById('rideRequestForm').style.display = 'flex';
            
            document.getElementById('rideInfoPanel').style.display = 'none';
            
            document.getElementById('driverDetailsCard').style.display = 'none';
            
            document.getElementById('destinationLocation').value = '';
            
            // Hide vehicle selection and fare display
            document.getElementById('vehicleSelection').classList.remove('active');
            document.getElementById('fareDisplay').classList.remove('active');
            document.getElementById('requestRideBtn').classList.remove('active');
            
            document.getElementById('packageForm').classList.remove('active');
            document.getElementById('receiverName').value = '';
            document.getElementById('receiverPhone').value = '';
            document.getElementById('packageDescription').value = '';
            document.getElementById('specialInstructions').value = '';
            document.getElementById('packageValue').value = '';
            
            document.getElementById('promoCode').value = '';
            appliedPromoCode = null;
            document.getElementById('promoCode').style.borderColor = '';
            document.getElementById('applyPromoBtn').innerHTML = 'Apply';
            document.getElementById('applyPromoBtn').classList.remove('btn-success');
            document.getElementById('applyPromoBtn').classList.add('btn-promo');
            document.getElementById('promoSection').classList.remove('active');
            
            // Remove vehicle image section
            const vehicleImageSection = document.getElementById('vehicleImageSection');
            if (vehicleImageSection) {
                vehicleImageSection.remove();
            }
            
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            if (emergencyVehicleMarker) {
                passengerMap.removeLayer(emergencyVehicleMarker);
                emergencyVehicleMarker = null;
            }
            
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            if (driverLocationListener) {
                driverLocationListener();
                driverLocationListener = null;
            }
            
            currentRide = null;
            emergencyMode = false;
        }

        // Load passenger data
        function loadPassengerData() {
            if (currentUser) {
                updateUserStats();
            }
        }

        // Load account data
        function loadAccountData() {
            if (currentUser && userData) {
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                walletBalance = userData.walletBalance || 0;
                document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                
                const accountAvatar = document.getElementById('accountAvatar');
                if (userData.name) {
                    accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
                } else {
                    accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
                }
                
                updateUserStats();
            }
        }

        // Update user stats
        function updateUserStats() {
            if (!currentUser) return;
            
            database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    if (rides) {
                        const ridesArray = Object.values(rides);
                        
                        userStats = {
                            completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                            cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                            pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                        };
                        
                        document.getElementById('ridesCompleted').textContent = userStats.completed;
                        document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                        document.getElementById('ridesPending').textContent = userStats.pending;
                    }
                });
        }

        // Share referral code
        function shareReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 50% off your first ride. Download the app now!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Jubel Referral',
                    text: shareText,
                    url: window.location.href
                })
                .then(() => showNotification('Referral code shared successfully!'))
                .catch(error => console.error('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareText)
                    .then(() => showNotification('Referral code copied to clipboard!'));
            }
        }

        // Deposit to wallet
        function depositToWallet() {
            const amount = prompt('Enter deposit amount (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const depositAmount = parseFloat(amount);
                const newBalance = walletBalance + depositAmount;
                
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    updateWalletBalanceUI();
                    showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
                })
                .catch(error => {
                    console.error('Error depositing to wallet:', error);
                    showNotification('Error processing deposit. Please try again.');
                });
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }

        // Withdraw from wallet
        function withdrawFromWallet() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawalAmount = parseFloat(amount);
                
                if (withdrawalAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawalAmount;
                
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    updateWalletBalanceUI();
                    showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
                })
                .catch(error => {
                    console.error('Error withdrawing from wallet:', error);
                    showNotification('Error processing withdrawal. Please try again.');
                });
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }

        // Contact WhatsApp
        function contactWhatsApp() {
            const phoneNumber = '0768658484';
            const message = 'Hello, I need assistance with Jubel rides.';
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // Contact phone
        function contactPhone() {
            const phoneNumber = '0768658484';
            window.open(`tel:${phoneNumber}`, '_self');
        }

        // Load ride history
        function loadRideHistory() {
            if (currentUser) {
                const filter = document.getElementById('historyFilter').value;
                const dateFilter = document.getElementById('historyDate').value;
                
                if (rideHistoryListener) {
                    rideHistoryListener();
                }
                
                rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    
                    const rides = snapshot.val();
                    if (rides) {
                        let ridesArray = Object.keys(rides).map(rideId => ({
                            id: rideId,
                            ...rides[rideId]
                        }));
                        
                        // Apply filters
                        if (filter !== 'all') {
                            if (filter === 'ride') {
                                ridesArray = ridesArray.filter(ride => 
                                    ride.rideType === 'car' && !ride.emergencyDetails && !ride.expressDelivery && !ride.truckDelivery);
                            } else if (filter === 'delivery') {
                                ridesArray = ridesArray.filter(ride => 
                                    ride.expressDelivery || ride.truckDelivery || ride.rideType === 'bike' || ride.rideType === 'bicycle');
                            } else if (filter === 'emergency') {
                                ridesArray = ridesArray.filter(ride => ride.emergencyDetails);
                            } else {
                                ridesArray = ridesArray.filter(ride => ride.status === filter);
                            }
                        }
                        
                        if (dateFilter) {
                            const filterDate = new Date(dateFilter);
                            ridesArray = ridesArray.filter(ride => {
                                const rideDate = new Date(ride.timestamp);
                                return rideDate.toDateString() === filterDate.toDateString();
                            });
                        }
                        
                        ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                        
                        if (ridesArray.length === 0) {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                            return;
                        }
                        
                        ridesArray.forEach(ride => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.setAttribute('data-ride-id', ride.id);
                            
                            const date = new Date(ride.timestamp);
                            const formattedDate = date.toLocaleDateString();
                            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            // Determine ride type
                            let typeClass, typeText;
                            if (ride.emergencyDetails) {
                                typeClass = 'emergency';
                                typeText = 'Emergency';
                            } else if (ride.expressDelivery || ride.truckDelivery || ride.rideType === 'bike' || ride.rideType === 'bicycle') {
                                typeClass = 'delivery';
                                typeText = 'Delivery';
                            } else {
                                typeClass = 'ride';
                                typeText = 'Ride';
                            }
                            
                            let statusClass = 'status-requested';
                            let statusText = getStatusText(ride.status);
                            
                            if (ride.status === 'accepted') {
                                statusClass = 'status-accepted';
                            } else if (ride.status === 'completed' || ride.status === 'paid') {
                                statusClass = 'status-completed';
                            } else if (ride.status === 'cancelled') {
                                statusClass = 'status-cancelled';
                            } else if (ride.status === 'requested') {
                                statusClass = 'status-pending';
                                statusText = 'Pending';
                            }
                            
                            let historyContent = '';
                            
                            historyContent = `
                                <div class="history-item-type ${typeClass}">${typeText}</div>
                                <div class="history-locations">
                                    <div>
                                        <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                    </div>
                                    <div>
                                        <strong>To:</strong> ${ride.destination}
                                    </div>
                                </div>
                                <div class="history-info">
                                    <div class="history-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                    <div>${formattedDate} ${formattedTime}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                            
                            historyItem.innerHTML = historyContent;
                            historyList.appendChild(historyItem);
                        });
                    } else {
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                    }
                }, error => {
                    console.error('Error loading ride history:', error);
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                });
            }
        }

        // Get status text
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Awaiting Driver',
                'accepted': 'In Progress',
                'completed': 'Completed',
                'paid': 'Completed',
                'cancelled': 'Cancelled',
                'arrived': 'Driver Arrived',
                'picked_up': 'Picked Up',
                'started': 'Trip Started'
            };
            
            return statusMap[status] || status;
        }

        // Show ride details popup
        function showRideDetailsPopup(rideId) {
            database.ref('rides/' + rideId).once('value')
                .then(snapshot => {
                    const ride = snapshot.val();
                    if (ride) {
                        document.getElementById('popupRidePickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
                        document.getElementById('popupRideDestination').textContent = ride.destination;
                        document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                        document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                        document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                        document.getElementById('popupRideType').textContent = ride.rideClass ? ride.rideClass.charAt(0).toUpperCase() + ride.rideClass.slice(1) : 'Standard';
                        
                        const date = new Date(ride.timestamp);
                        document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        updatePopupRideMap(ride);
                        
                        // Store ride ID for receipt view
                        document.getElementById('viewRideReceiptBtn').setAttribute('data-ride-id', rideId);
                        document.getElementById('viewRideReceiptBtn').style.display = 'inline-block';
                        
                        if (ride.driverId) {
                            database.ref('users/' + ride.driverId).once('value')
                                .then(driverSnapshot => {
                                    const driver = driverSnapshot.val();
                                    if (driver) {
                                        document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                        document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                        document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                        document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                        
                                        updateDriverProgress(ride.status);
                                        
                                        document.getElementById('popupDriverDetails').classList.remove('hidden');
                                    }
                                });
                        } else {
                            document.getElementById('popupDriverDetails').classList.add('hidden');
                        }
                        
                        document.getElementById('rideDetailsPopup').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading ride details:', error);
                    showNotification('Error loading ride details.');
                });
        }

        // Update driver progress
        function updateDriverProgress(status) {
            const progressElement = document.getElementById('popupDriverProgress');
            
            switch(status) {
                case 'requested':
                    progressElement.textContent = 'Waiting for driver to accept';
                    break;
                case 'accepted':
                    progressElement.textContent = 'Driver on the way to pickup';
                    break;
                case 'arrived':
                    progressElement.textContent = 'Driver arrived at pickup location';
                    break;
                case 'picked_up':
                    progressElement.textContent = 'Passenger picked up';
                    break;
                case 'started':
                    progressElement.textContent = 'Trip in progress';
                    break;
                case 'completed':
                    progressElement.textContent = 'Trip completed';
                    break;
                case 'paid':
                    progressElement.textContent = 'Payment completed';
                    break;
                default:
                    progressElement.textContent = 'Status: ' + status;
            }
        }

        // Close ride details popup
        function closeRideDetailsPopup() {
            document.getElementById('rideDetailsPopup').classList.add('hidden');
        }

        // NEW: Show receipt for completed ride
        function showReceipt(ride) {
            if (!ride) {
                showNotification('No ride data available for receipt.');
                return;
            }
            
            const date = new Date(ride.timestamp);
            
            document.getElementById('receiptNumber').textContent = ride.id.substring(0, 8).toUpperCase();
            document.getElementById('receiptDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            document.getElementById('receiptPassenger').textContent = ride.passengerName || 'Passenger';
            document.getElementById('receiptDriver').textContent = ride.driverName || 'Driver';
            document.getElementById('receiptVehicle').textContent = ride.driverVehicle || 'Vehicle';
            document.getElementById('receiptPickup').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
            document.getElementById('receiptDestination').textContent = ride.destination;
            document.getElementById('receiptDistance').textContent = ride.distance || '0 km';
            document.getElementById('receiptRideType').textContent = ride.rideClass ? ride.rideClass.charAt(0).toUpperCase() + ride.rideClass.slice(1) : 'Standard';
            document.getElementById('receiptRideTime').textContent = ride.rideDuration || 'N/A';
            document.getElementById('receiptPaymentMethod').textContent = ride.paymentMethod ? ride.paymentMethod.charAt(0).toUpperCase() + ride.paymentMethod.slice(1) : 'Wallet';
            
            const baseFare = ride.fare || 0;
            const discount = ride.promoCode ? baseFare * 0.2 : 0;
            const distanceFare = baseFare - 23 > 0 ? baseFare - 23 : 0;
            
            document.getElementById('receiptBaseFare').textContent = `K23.00`;
            document.getElementById('receiptDistanceFare').textContent = `K${distanceFare.toFixed(2)}`;
            document.getElementById('receiptDiscount').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('receiptTotal').textContent = `K${(baseFare - discount).toFixed(2)}`;
            
            document.getElementById('receiptModal').classList.add('active');
        }

        // NEW: Download receipt as PDF
        function downloadReceipt() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const receiptNumber = document.getElementById('receiptNumber').textContent;
            const receiptDate = document.getElementById('receiptDate').textContent;
            const passenger = document.getElementById('receiptPassenger').textContent;
            const driver = document.getElementById('receiptDriver').textContent;
            const vehicle = document.getElementById('receiptVehicle').textContent;
            const pickup = document.getElementById('receiptPickup').textContent;
            const destination = document.getElementById('receiptDestination').textContent;
            const distance = document.getElementById('receiptDistance').textContent;
            const rideType = document.getElementById('receiptRideType').textContent;
            const rideTime = document.getElementById('receiptRideTime').textContent;
            const paymentMethod = document.getElementById('receiptPaymentMethod').textContent;
            const total = document.getElementById('receiptTotal').textContent;
            
            // Add header
            doc.setFontSize(20);
            doc.setTextColor(255, 107, 53);
            doc.text('JUBEL RIDE RECEIPT', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Receipt No: ${receiptNumber}`, 20, 35);
            doc.text(`Date: ${receiptDate}`, 20, 40);
            
            // Add passenger and driver info
            doc.text(`Passenger: ${passenger}`, 20, 50);
            doc.text(`Driver: ${driver}`, 20, 55);
            doc.text(`Vehicle: ${vehicle}`, 20, 60);
            
            // Add ride details
            doc.text(`Pickup: ${pickup}`, 20, 70);
            doc.text(`Destination: ${destination}`, 20, 75);
            doc.text(`Distance: ${distance}`, 20, 80);
            doc.text(`Ride Type: ${rideType}`, 20, 85);
            doc.text(`Ride Time: ${rideTime}`, 20, 90);
            doc.text(`Payment Method: ${paymentMethod}`, 20, 95);
            
            // Add fare breakdown
            doc.text('Fare Breakdown:', 20, 105);
            doc.text(`Base Fare: K23.00`, 30, 110);
            doc.text(`Distance Fare: ${document.getElementById('receiptDistanceFare').textContent}`, 30, 115);
            doc.text(`Discount: ${document.getElementById('receiptDiscount').textContent}`, 30, 120);
            
            // Add total
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`TOTAL: ${total}`, 20, 130);
            
            // Add footer
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text('Thank you for choosing Jubel!', 105, 150, { align: 'center' });
            doc.text('For any queries, contact: support@jubel.com', 105, 155, { align: 'center' });
            
            // Save PDF
            doc.save(`Jubel_Receipt_${receiptNumber}.pdf`);
            showNotification('Receipt downloaded successfully!');
        }

        // Save SOS configuration
        function saveSOSConfig() {
            const contact1 = document.getElementById('emergencyContact1').value;
            const contact2 = document.getElementById('emergencyContact2').value;
            const message = document.getElementById('sosMessage').value;
            
            if (!contact1) {
                showNotification('Please provide at least one emergency contact.');
                return;
            }
            
            sosConfig = {
                contact1: contact1,
                contact2: contact2,
                message: message
            };
            
            database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
                .then(() => {
                    showNotification('SOS configuration saved successfully.');
                    
                    document.getElementById('sosSetupForm').classList.remove('active');
                    document.getElementById('rideRequestForm').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error saving SOS config:', error);
                    showNotification('Error saving SOS configuration. Please try again.');
                });
        }

        // Trigger SOS alert
        function triggerSOS() {
            if (!sosConfig || !sosConfig.contact1) {
                showNotification('SOS not configured. Please set up emergency contacts first.');
                return;
            }
            
            if (!currentRide) {
                showNotification('No active ride to report SOS for.');
                return;
            }
            
            const sosAlert = {
                passengerId: currentUser.uid,
                passengerName: userData.name || 'Passenger',
                passengerPhone: userData.phone || 'Not provided',
                emergencyContact1: sosConfig.contact1,
                emergencyContact2: sosConfig.contact2,
                message: sosConfig.message,
                rideDetails: currentRide,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                location: userLocation
            };
            
            if (currentRide.driverId) {
                database.ref('users/' + currentRide.driverId).once('value')
                    .then(driverSnapshot => {
                        const driver = driverSnapshot.val();
                        if (driver) {
                            sosAlert.driverDetails = {
                                name: driver.name,
                                phone: driver.phone,
                                vehicle: driver.vehicle
                            };
                        }
                        
                        return database.ref('sosAlerts').push().set(sosAlert);
                    })
                    .then(() => {
                        showNotification('SOS alert sent to emergency contacts!');
                        console.log('SOS Alert:', sosAlert);
                    })
                    .catch(error => {
                        console.error('Error sending SOS alert:', error);
                        showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
                    });
            } else {
                database.ref('sosAlerts').push().set(sosAlert)
                    .then(() => {
                        showNotification('SOS alert sent to emergency contacts!');
                        console.log('SOS Alert:', sosAlert);
                    })
                    .catch(error => {
                        console.error('Error sending SOS alert:', error);
                        showNotification('Error sending SOS alert. Please try again or call emergency services directly.');
                    });
            }
        }

        // Toggle More Options dropdown
        function toggleMoreOptions() {
            const dropdown = document.getElementById('moreOptionsDropdown');
            dropdown.classList.toggle('active');
        }

        // Handle More Option selection
        function handleMoreOptionSelection(option) {
            document.getElementById('orderForSomeoneForm').classList.remove('active');
            document.getElementById('expressDeliveryForm').classList.remove('active');
            document.getElementById('lightTruckDeliveryForm').classList.remove('active');
            document.getElementById('sosSetupForm').classList.remove('active');
            document.getElementById('scheduleRideForm').classList.remove('active');
            document.getElementById('scheduleDeliveryForm').classList.remove('active');
            document.getElementById('emergencyServicesForm').classList.remove('active');
            document.getElementById('emergencyQuestionnaire').classList.remove('active');
            document.getElementById('rideRequestForm').style.display = 'none';
            
            switch(option) {
                case 'order-for-someone':
                    document.getElementById('orderForSomeoneForm').classList.add('active');
                    activeMoreOption = 'order-for-someone';
                    break;
                case 'express-delivery':
                    document.getElementById('expressDeliveryForm').classList.add('active');
                    activeMoreOption = 'express-delivery';
                    break;
                case 'light-truck-delivery':
                    document.getElementById('lightTruckDeliveryForm').classList.add('active');
                    activeMoreOption = 'light-truck-delivery';
                    break;
                case 'sos-setup':
                    document.getElementById('sosSetupForm').classList.add('active');
                    activeMoreOption = 'sos-setup';
                    break;
                case 'schedule-ride':
                    document.getElementById('scheduleRideForm').classList.add('active');
                    activeMoreOption = 'schedule-ride';
                    break;
                case 'schedule-delivery':
                    document.getElementById('scheduleDeliveryForm').classList.add('active');
                    activeMoreOption = 'schedule-delivery';
                    break;
            }
            
            document.getElementById('moreOptionsDropdown').classList.remove('active');
        }

        // Cancel More Option form
        function cancelMoreOptionForm() {
            document.getElementById('orderForSomeoneForm').classList.remove('active');
            document.getElementById('expressDeliveryForm').classList.remove('active');
            document.getElementById('lightTruckDeliveryForm').classList.remove('active');
            document.getElementById('sosSetupForm').classList.remove('active');
            document.getElementById('scheduleRideForm').classList.remove('active');
            document.getElementById('scheduleDeliveryForm').classList.remove('active');
            document.getElementById('emergencyServicesForm').classList.remove('active');
            document.getElementById('emergencyQuestionnaire').classList.remove('active');
            
            document.getElementById('rideRequestForm').style.display = 'flex';
            
            if (recipientPickupMarker) {
                passengerMap.removeLayer(recipientPickupMarker);
                recipientPickupMarker = null;
            }
            if (recipientDestinationMarker) {
                passengerMap.removeLayer(recipientDestinationMarker);
                recipientDestinationMarker = null;
            }
            if (shopLocationMarker) {
                passengerMap.removeLayer(shopLocationMarker);
                shopLocationMarker = null;
            }
            if (deliveryDestinationMarker) {
                passengerMap.removeLayer(deliveryDestinationMarker);
                deliveryDestinationMarker = null;
            }
            if (truckPickupMarker) {
                passengerMap.removeLayer(truckPickupMarker);
                truckPickupMarker = null;
            }
            if (truckDestinationMarker) {
                passengerMap.removeLayer(truckDestinationMarker);
                truckDestinationMarker = null;
            }
            
            activeMoreOption = null;
        }

        // Hide all search suggestions
        function hideAllSearchSuggestions() {
            const searchTypes = [
                'destination', 'pickup', 'recipientPickup', 
                'recipientDestination', 'shopLocation', 'deliveryDestination',
                'schedulePickup', 'scheduleDestination', 'scheduleDeliveryPickup',
                'scheduleDeliveryDestination', 'truckPickup', 'truckDestination'
            ];
            
            searchTypes.forEach(type => {
                hideSearchSuggestions(type);
            });
        }

        // Get place type for icon
        function getPlaceType(place) {
            if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
                return 'restaurant';
            } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
                return 'cafe';
            } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
                return 'bank';
            } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
                return 'hospital';
            } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
                return 'pharmacy';
            } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
                return 'school';
            } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
                return 'supermarket';
            } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
                return 'mall';
            } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
                return 'hotel';
            } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
                return 'police';
            } else {
                return 'place';
            }
        }

        // Get place icon
        function getPlaceIcon(placeType) {
            const icons = {
                'restaurant': '',
                'cafe': '',
                'bank': '',
                'hospital': '',
                'pharmacy': '',
                'school': '',
                'supermarket': '',
                'mall': '',
                'hotel': '',
                'police': ''
            };
            
            return icons[placeType] || '';
        }

        // Start location tracking
        function startLocationTracking() {
            if (navigator.geolocation && currentUser) {
                navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    database.ref('passengerLocations/' + currentUser.uid).set({
                        latitude: lat,
                        longitude: lng,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    }
                    
                    if (destinationMarker) {
                        const destination = document.getElementById('destinationLocation').value;
                        if (destination) {
                            updateFareEstimate();
                        }
                    }
                }, error => {
                    console.error('Location tracking error:', error);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 30000
                });
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Enhanced switch screen function
        function switchScreen(screenId) {
            const previousScreen = currentScreen;
            currentScreen = screenId;
            
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            if (screenId === 'home') {
                document.querySelectorAll('.home-only').forEach(el => {
                    el.style.display = 'flex';
                });
                
                if (previousScreen !== 'home' && homeScreenRefreshRequired) {
                    refreshHomeScreen();
                }
            } else {
                document.querySelectorAll('.home-only').forEach(el => {
                    el.style.display = 'none';
                });
                
                homeScreenRefreshRequired = true;
            }
            
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'account') {
                loadAccountData();
            }
        }

        // Enhanced home screen refresh function
        function refreshHomeScreen() {
            console.log("Refreshing home screen...");
            
            refreshPassengerPosition();
            
            document.getElementById('destinationLocation').value = '';
            
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            document.getElementById('estimatedFare').textContent = 'K0.00';
            document.getElementById('etaDisplay').textContent = 'ETA: -- min';
            document.getElementById('requestRideBtn').disabled = true;
            
            document.getElementById('vehicleSelection').classList.remove('active');
            document.getElementById('fareDisplay').classList.remove('active');
            document.getElementById('requestRideBtn').classList.remove('active');
            
            document.getElementById('promoSection').classList.remove('active');
            document.getElementById('promoCode').value = '';
            appliedPromoCode = null;
            
            document.getElementById('packageForm').classList.remove('active');
            document.getElementById('packageToggle').style.display = 'none';
            
            document.getElementById('rideRequestForm').style.display = 'flex';
            document.getElementById('rideInfoPanel').style.display = 'none';
            
            homeScreenRefreshRequired = false;
            
            showNotification('Home screen refreshed');
        }

        // Event listeners setup
        function setupEventListeners() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.vehicle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    
                    selectedVehicleType = this.getAttribute('data-type');
                    
                    if (selectedVehicleType === 'bike' || selectedVehicleType === 'bicycle') {
                        document.getElementById('packageToggle').style.display = 'flex';
                    } else {
                        document.getElementById('packageToggle').style.display = 'none';
                        document.getElementById('packageForm').classList.remove('active');
                    }
                    
                    updateFareEstimate();
                });
            });
            
            document.getElementById('packageToggle').addEventListener('click', function() {
                document.getElementById('packageForm').classList.toggle('active');
            });
            
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedPaymentType = this.getAttribute('data-payment-type');
                    
                    if (selectedPaymentType === 'wallet') {
                        if (walletBalance < rideFare) {
                            document.getElementById('insufficientBalance').style.display = 'block';
                            document.getElementById('confirmPaymentBtn').disabled = true;
                        } else {
                            document.getElementById('insufficientBalance').style.display = 'none';
                            document.getElementById('confirmPaymentBtn').disabled = false;
                        }
                    } else {
                        document.getElementById('insufficientBalance').style.display = 'none';
                        document.getElementById('confirmPaymentBtn').disabled = false;
                    }
                });
            });
            
            document.getElementById('requestRideBtn').addEventListener('click', requestRide);
            
            document.getElementById('confirmPaymentBtn').addEventListener('click', submitRideRequest);
            
            document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
            
            document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
            
            document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
            
            document.getElementById('viewReceiptBtn').addEventListener('click', function() {
                if (currentRide) {
                    showReceipt(currentRide);
                }
            });
            
            document.getElementById('promoToggle').addEventListener('click', function() {
                document.getElementById('promoSection').classList.toggle('active');
            });
            
            document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
            
            document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
            document.getElementById('depositBtn').addEventListener('click', depositToWallet);
            document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
            document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
            document.getElementById('callBtn').addEventListener('click', contactPhone);
            
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            setupSearchInputListeners();
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.location-input') && 
                    !e.target.closest('.suggestion-list')) {
                    hideAllSearchSuggestions();
                }
            });
            
            document.querySelectorAll('.saved-location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressType = this.getAttribute('data-address');
                    useSavedLocation(addressType);
                });
            });
            
            document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
            document.getElementById('historyDate').addEventListener('change', loadRideHistory);
            
            document.addEventListener('click', function(e) {
                if (e.target.closest('.history-item')) {
                    const historyItem = e.target.closest('.history-item');
                    const rideId = historyItem.getAttribute('data-ride-id');
                    if (rideId) {
                        showRideDetailsPopup(rideId);
                    }
                }
                
                if (e.target.closest('.emergency-service')) {
                    const emergencyService = e.target.closest('.emergency-service');
                    const vehicleType = emergencyService.getAttribute('data-type');
                    handleEmergencyServiceSelection(vehicleType);
                }
            });
            
            document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
            document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
            
            document.getElementById('viewRideReceiptBtn').addEventListener('click', function() {
                const rideId = this.getAttribute('data-ride-id');
                if (rideId) {
                    database.ref('rides/' + rideId).once('value')
                        .then(snapshot => {
                            const ride = snapshot.val();
                            if (ride) {
                                closeRideDetailsPopup();
                                showReceipt(ride);
                            }
                        });
                }
            });
            
            document.getElementById('closeReceiptBtn').addEventListener('click', function() {
                document.getElementById('receiptModal').classList.remove('active');
            });
            
            document.getElementById('downloadReceiptBtn').addEventListener('click', downloadReceipt);
            
            document.getElementById('moreOptionsBtn').addEventListener('click', toggleMoreOptions);
            
            document.querySelectorAll('.more-option-item').forEach(item => {
                item.addEventListener('click', function() {
                    const option = this.getAttribute('data-option');
                    handleMoreOptionSelection(option);
                });
            });
            
            document.getElementById('orderForSomeoneBtn').addEventListener('click', submitOrderForSomeone);
            document.getElementById('cancelOrderForSomeoneBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.querySelectorAll('.express-delivery-form .delivery-mode-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.express-delivery-form .delivery-mode-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    calculateExpressDeliveryFee();
                });
            });
            
            document.getElementById('expressDeliveryBtn').addEventListener('click', submitExpressDelivery);
            document.getElementById('cancelExpressDeliveryBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.getElementById('lightTruckDeliveryBtn').addEventListener('click', submitLightTruckDelivery);
            document.getElementById('cancelLightTruckDeliveryBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.getElementById('saveSosBtn').addEventListener('click', saveSOSConfig);
            document.getElementById('cancelSosSetupBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.getElementById('sosButton').addEventListener('click', triggerSOS);
            
            document.querySelectorAll('.schedule-delivery-form .delivery-mode-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.schedule-delivery-form .delivery-mode-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
            
            document.getElementById('scheduleRideBtn').addEventListener('click', submitScheduleRide);
            document.getElementById('cancelScheduleRideBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.getElementById('scheduleDeliveryBtn').addEventListener('click', submitScheduleDelivery);
            document.getElementById('cancelScheduleDeliveryBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.getElementById('submitEmergencyBtn').addEventListener('click', submitEmergencyRequest);
            document.getElementById('cancelEmergencyQuestionnaireBtn').addEventListener('click', cancelMoreOptionForm);
            document.getElementById('cancelEmergencyServicesBtn').addEventListener('click', cancelMoreOptionForm);
            
            document.querySelectorAll('.ride-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.ride-type-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
            });
            
            document.getElementById('selectRideTypeBtn').addEventListener('click', function() {
                const selectedOption = document.querySelector('.ride-type-option.selected');
                if (selectedOption) {
                    const rideType = selectedOption.getAttribute('data-type');
                    handleRideTypeSelection(rideType);
                }
            });
            
            document.getElementById('closeRideTypeModal').addEventListener('click', hideRideTypeSelection);
        }

        // Initialize enhanced app features
        function initializeApp() {
            console.log("Jubel Passenger App Initialized with Enhanced Features");
            
            setInterval(() => {
                if (userLocation && currentScreen === 'home') {
                    determineCurrentCity(userLocation.lat, userLocation.lng)
                        .then(city => {
                            console.log("Periodic city update:", city);
                        })
                        .catch(error => {
                            console.error("Periodic city detection failed:", error);
                        });
                }
            }, 60000);
            
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentScreen === 'home') {
                    setTimeout(refreshHomeScreen, 1000);
                }
            });
            
            window.addEventListener('load', function() {
                console.log("Jubel Passenger App fully loaded with enhanced city detection and search");
                showNotification('Jubel Passenger App Ready');
            });
        }

        // Handle offline/online status
        window.addEventListener('online', function() {
            showNotification('Connection restored.');
            if (currentScreen === 'home') {
                setTimeout(refreshPassengerPosition, 1000);
            }
        });

        window.addEventListener('offline', function() {
            showNotification('You are currently offline. Some features may not work.');
        });

        // Initialize enhanced app features
        initializeApp();
    </script>
</body>
</html>
