<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Admin Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Header */
        .header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px var(--app-padding);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-medium);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 700;
        }
        
        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 700;
        }
        
        /* Main Content */
        .main-content {
            padding: var(--app-padding);
            padding-bottom: 70px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }
        
        /* Dashboard */
        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .stat-card.primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 8px 12px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .tab.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* List Items */
        .list-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:hover {
            background: var(--light-orange);
        }
        
        .item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        
        .item-details {
            font-size: 0.75rem;
            color: var(--medium-gray);
            display: flex;
            justify-content: space-between;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .status-online {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .status-started {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Map */
        #map {
            height: 200px;
            width: 100%;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
            cursor: pointer;
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--app-padding);
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .modal-content {
            padding: 12px;
        }
        
        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 8px var(--app-padding);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 0;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .nav-item.active {
            color: var(--primary-orange);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            font-weight: 700;
            background: var(--light-gray);
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            margin-bottom: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius) 0 0 var(--element-radius);
            font-size: 0.8rem;
        }
        
        .search-btn {
            padding: 10px 12px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: 0 var(--element-radius) var(--element-radius) 0;
            cursor: pointer;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        /* Filter */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .filter-select {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
        }
        
        /* Charts */
        .chart-container {
            height: 150px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        /* Detail View */
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Map Container */
        .map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        /* Full Screen Map */
        .full-screen-map {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 200;
            display: none;
        }
        
        .full-screen-map.active {
            display: block;
        }
        
        /* Ride Tracking */
        .ride-tracking {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            max-width: 300px;
        }
        
        /* Driver Marker */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Passenger Marker */
        .passenger-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .passenger-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Active Ride Marker */
        .active-ride-marker {
            background: var(--success-green);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .active-ride-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Referral Code */
        .referral-code {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            font-family: monospace;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
        }
        
        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .modal {
                max-width: 100%;
            }
            
            .ride-tracking {
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">J</div>
                <div class="logo-text">Jubel Admin</div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <div class="dashboard-stats">
                <div class="stat-card primary">
                    <div class="stat-value" id="totalRides">0</div>
                    <div class="stat-label">Total Rides</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeRides">0</div>
                    <div class="stat-label">Active Rides</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalDrivers">0</div>
                    <div class="stat-label">Total Drivers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="onlineDrivers">0</div>
                    <div class="stat-label">Online Drivers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPassengers">0</div>
                    <div class="stat-label">Total Passengers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayEarnings">K0</div>
                    <div class="stat-label">Today's Earnings</div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Live Tracking Map
                </h3>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="map-control-btn" id="centerMapBtn" title="Center Map">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-control-btn" id="toggleFullScreenBtn" title="Full Screen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Analytics
                </h3>
                <div class="card">
                    <div class="chart-container">
                        Revenue Chart (Would display here)
                    </div>
                    <div class="chart-container">
                        Ride Activity Chart (Would display here)
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-list"></i>
                    Recent Activity
                </h3>
                <div id="recentActivityList">
                    <!-- Recent activity will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Drivers Tab -->
        <div id="driversTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="driverSearch" placeholder="Search drivers...">
                <button class="search-btn" id="driverSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="driverStatusFilter">
                    <option value="all">All Drivers</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="suspended">Suspended</option>
                </select>
                <select class="filter-select" id="driverVehicleFilter">
                    <option value="all">All Vehicles</option>
                    <option value="car">Car</option>
                    <option value="bike">Bike</option>
                    <option value="bicycle">Bicycle</option>
                </select>
            </div>
            
            <div id="driversList">
                <!-- Drivers will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Passengers Tab -->
        <div id="passengersTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="passengerSearch" placeholder="Search passengers...">
                <button class="search-btn" id="passengerSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="passengerStatusFilter">
                    <option value="all">All Passengers</option>
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>
            
            <div id="passengersList">
                <!-- Passengers will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Rides Tab -->
        <div id="ridesTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="rideSearch" placeholder="Search rides...">
                <button class="search-btn" id="rideSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="rideStatusFilter">
                    <option value="all">All Rides</option>
                    <option value="requested">Requested</option>
                    <option value="accepted">Accepted</option>
                    <option value="started">Started</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" class="filter-select" id="rideDateFilter">
            </div>
            
            <div id="ridesList">
                <!-- Rides will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="tabs">
                <div class="tab active" data-report="revenue">Revenue</div>
                <div class="tab" data-report="rides">Rides</div>
                <div class="tab" data-report="drivers">Drivers</div>
                <div class="tab" data-report="passengers">Passengers</div>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="reportPeriod">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
            
            <div id="revenueReport" class="report-content active">
                <div class="card">
                    <div class="chart-container">
                        Revenue Report Chart
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Rides</th>
                                    <th>Revenue</th>
                                    <th>Commission</th>
                                </tr>
                            </thead>
                            <tbody id="revenueTable">
                                <!-- Revenue data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="ridesReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        Rides Report Chart
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total Rides</th>
                                    <th>Completed</th>
                                    <th>Cancelled</th>
                                </tr>
                            </thead>
                            <tbody id="ridesReportTable">
                                <!-- Rides report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="driversReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        Drivers Report Chart
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Rides</th>
                                    <th>Earnings</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="driversReportTable">
                                <!-- Drivers report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="passengersReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        Passengers Report Chart
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Passenger</th>
                                    <th>Rides</th>
                                    <th>Spent</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="passengersReportTable">
                                <!-- Passengers report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="dashboardTab">
            <i class="fas fa-home nav-icon"></i>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" data-tab="driversTab">
            <i class="fas fa-car nav-icon"></i>
            <span>Drivers</span>
        </div>
        <div class="nav-item" data-tab="passengersTab">
            <i class="fas fa-users nav-icon"></i>
            <span>Passengers</span>
        </div>
        <div class="nav-item" data-tab="ridesTab">
            <i class="fas fa-road nav-icon"></i>
            <span>Rides</span>
        </div>
        <div class="nav-item" data-tab="reportsTab">
            <i class="fas fa-chart-bar nav-icon"></i>
            <span>Reports</span>
        </div>
    </div>
    
    <!-- Full Screen Map -->
    <div class="full-screen-map" id="fullScreenMap">
        <div id="fullScreenMapContainer" style="height: 100%; width: 100%;"></div>
        <div class="map-controls">
            <button class="map-control-btn" id="fullScreenZoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="fullScreenZoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="fullScreenCenterBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="exitFullScreenBtn" title="Exit Full Screen">
                <i class="fas fa-compress"></i>
            </button>
        </div>
        <div class="ride-tracking" id="fullScreenRideTracking">
            <!-- Ride tracking info will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Driver Detail Modal -->
    <div class="modal-overlay" id="driverDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Driver Details</h3>
                <button class="close-modal" id="closeDriverModal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="driverDetailContent">
                    <!-- Driver details will be populated by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-secondary" id="editDriverBtn">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn btn-danger" id="suspendDriverBtn">
                        <i class="fas fa-ban"></i>
                        Suspend
                    </button>
                    <button class="action-btn btn-primary" id="trackDriverBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Passenger Detail Modal -->
    <div class="modal-overlay" id="passengerDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Passenger Details</h3>
                <button class="close-modal" id="closePassengerModal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="passengerDetailContent">
                    <!-- Passenger details will be populated by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-secondary" id="editPassengerBtn">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn btn-danger" id="suspendPassengerBtn">
                        <i class="fas fa-ban"></i>
                        Suspend
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ride Detail Modal -->
    <div class="modal-overlay" id="rideDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ride Details</h3>
                <button class="close-modal" id="closeRideModal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="rideDetailContent">
                    <!-- Ride details will be populated by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="action-btn btn-primary" id="reassignRideBtn">
                        <i class="fas fa-sync-alt"></i>
                        Reassign
                    </button>
                    <button class="action-btn btn-success" id="trackRideBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">System Settings</h3>
                <button class="close-modal" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Fare Rate (K per 90 meters)</label>
                    <input type="number" id="fareRate" class="form-input" value="1" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" id="commissionRate" class="form-input" value="8" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Minimum Float (K)</label>
                    <input type="number" id="minFloat" class="form-input" value="10" step="1">
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
                    <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let managerMap, fullScreenMap;
        let driverMarkers = {};
        let passengerMarkers = {};
        let activeRideMarkers = {};
        let activeRidePolylines = {};
        let selectedDriver = null;
        let selectedPassenger = null;
        let selectedRide = null;
        let driversData = {};
        let passengersData = {};
        let ridesData = {};
        let activeRides = {};
        let trackedRide = null;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            setupEventListeners();
            initializeMap();
            initializeFullScreenMap();
        });
        
        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('userAvatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'A';
                    loadDashboardData();
                    loadDriversData();
                    loadPassengersData();
                    loadRidesData();
                    loadSettings();
                } else {
                    // Redirect to login if not authenticated
                    showLoginScreen();
                }
            });
        }
        
        function showLoginScreen() {
            // In a real app, this would show a login form
            // For demo purposes, we'll auto-login with a dummy user
            auth.signInAnonymously()
                .then(() => {
                    console.log('Manager signed in anonymously');
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                });
        }
        
        // Initialize map
        function initializeMap() {
            // Manager map
            managerMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            
            // Use a clean map style
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(managerMap);
            
            // Listen for driver location updates
            database.ref('driverLocations').on('value', snapshot => {
                const locations = snapshot.val();
                updateDriverMarkers(locations);
            });
            
            // Listen for active rides
            database.ref('rides').orderByChild('status').equalTo('accepted').on('value', snapshot => {
                const rides = snapshot.val();
                updateActiveRideMarkers(rides);
            });
            
            database.ref('rides').orderByChild('status').equalTo('started').on('value', snapshot => {
                const rides = snapshot.val();
                updateActiveRideMarkers(rides);
            });
        }
        
        // Initialize full screen map
        function initializeFullScreenMap() {
            fullScreenMap = L.map('fullScreenMapContainer').setView([-15.4167, 28.2833], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(fullScreenMap);
            
            // Copy markers from main map to full screen map
            database.ref('driverLocations').once('value').then(snapshot => {
                const locations = snapshot.val();
                updateFullScreenDriverMarkers(locations);
            });
            
            database.ref('rides').orderByChild('status').equalTo('accepted').once('value').then(snapshot => {
                const rides = snapshot.val();
                updateFullScreenActiveRideMarkers(rides);
            });
            
            database.ref('rides').orderByChild('status').equalTo('started').once('value').then(snapshot => {
                const rides = snapshot.val();
                updateFullScreenActiveRideMarkers(rides);
            });
        }
        
        // Update driver markers on map
        function updateDriverMarkers(locations) {
            if (locations) {
                Object.keys(locations).forEach(driverId => {
                    const location = locations[driverId];
                    const driver = driversData[driverId];
                    
                    if (driver && location.latitude && location.longitude) {
                        // Remove existing marker if present
                        if (driverMarkers[driverId]) {
                            managerMap.removeLayer(driverMarkers[driverId]);
                        }
                        
                        // Create marker for driver
                        const marker = L.marker([location.latitude, location.longitude], {
                            icon: L.divIcon({
                                className: 'driver-marker',
                                html: `<div class="driver-marker">${getVehicleIcon(driver.vehicleType)}</div><div class="driver-marker-label">${driver.name || 'Driver'}</div>`,
                                iconSize: [35, 50]
                            })
                        }).addTo(managerMap)
                            .bindPopup(createDriverPopup(driver, location));
                        
                        driverMarkers[driverId] = marker;
                    }
                });
                
                // Fit map to show all drivers if there are any
                if (Object.keys(driverMarkers).length > 0) {
                    const group = new L.featureGroup(Object.values(driverMarkers));
                    managerMap.fitBounds(group.getBounds(), { padding: [20, 20] });
                }
            }
        }
        
        // Update driver markers on full screen map
        function updateFullScreenDriverMarkers(locations) {
            if (locations) {
                Object.keys(locations).forEach(driverId => {
                    const location = locations[driverId];
                    const driver = driversData[driverId];
                    
                    if (driver && location.latitude && location.longitude) {
                        // Create marker for driver
                        const marker = L.marker([location.latitude, location.longitude], {
                            icon: L.divIcon({
                                className: 'driver-marker',
                                html: `<div class="driver-marker">${getVehicleIcon(driver.vehicleType)}</div><div class="driver-marker-label">${driver.name || 'Driver'}</div>`,
                                iconSize: [35, 50]
                            })
                        }).addTo(fullScreenMap)
                            .bindPopup(createDriverPopup(driver, location));
                    }
                });
            }
        }
        
        // Update active ride markers
        function updateActiveRideMarkers(rides) {
            if (rides) {
                Object.keys(rides).forEach(rideId => {
                    const ride = rides[rideId];
                    
                    // Remove existing markers and polylines if present
                    if (activeRideMarkers[rideId]) {
                        managerMap.removeLayer(activeRideMarkers[rideId]);
                        delete activeRideMarkers[rideId];
                    }
                    
                    if (activeRidePolylines[rideId]) {
                        managerMap.removeLayer(activeRidePolylines[rideId]);
                        delete activeRidePolylines[rideId];
                    }
                    
                    // Create marker for active ride
                    if (ride.pickupLat && ride.pickupLng) {
                        const marker = L.marker([ride.pickupLat, ride.pickupLng], {
                            icon: L.divIcon({
                                className: 'active-ride-marker',
                                html: `<div class="active-ride-marker">ðŸš—</div><div class="active-ride-marker-label">Active Ride</div>`,
                                iconSize: [40, 55]
                            })
                        }).addTo(managerMap)
                            .bindPopup(createActiveRidePopup(ride));
                        
                        activeRideMarkers[rideId] = marker;
                        
                        // Draw route if destination coordinates are available
                        if (ride.destLat && ride.destLng) {
                            drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng, rideId);
                        }
                    }
                });
            }
        }
        
        // Update active ride markers on full screen map
        function updateFullScreenActiveRideMarkers(rides) {
            if (rides) {
                Object.keys(rides).forEach(rideId => {
                    const ride = rides[rideId];
                    
                    // Create marker for active ride
                    if (ride.pickupLat && ride.pickupLng) {
                        const marker = L.marker([ride.pickupLat, ride.pickupLng], {
                            icon: L.divIcon({
                                className: 'active-ride-marker',
                                html: `<div class="active-ride-marker">ðŸš—</div><div class="active-ride-marker-label">Active Ride</div>`,
                                iconSize: [40, 55]
                            })
                        }).addTo(fullScreenMap)
                            .bindPopup(createActiveRidePopup(ride));
                        
                        // Draw route if destination coordinates are available
                        if (ride.destLat && ride.destLng) {
                            drawFullScreenRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng, rideId);
                        }
                    }
                });
            }
        }
        
        // Draw route on map
        function drawRoute(startLat, startLng, endLat, endLng, rideId) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        activeRidePolylines[rideId] = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(managerMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    activeRidePolylines[rideId] = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(managerMap);
                });
        }
        
        // Draw route on full screen map
        function drawFullScreenRoute(startLat, startLng, endLat, endLng, rideId) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(fullScreenMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(fullScreenMap);
                });
        }
        
        // Get vehicle icon based on type
        function getVehicleIcon(vehicleType) {
            switch(vehicleType) {
                case 'car': return 'ðŸš—';
                case 'bike': return 'ðŸï¸';
                case 'bicycle': return 'ðŸš²';
                default: return 'ðŸš—';
            }
        }
        
        // Create driver popup content
        function createDriverPopup(driver, location) {
            return `
                <div>
                    <strong>${driver.name || 'Driver'}</strong><br>
                    ${driver.vehicleType || 'Vehicle'} - ${driver.licensePlate || 'N/A'}<br>
                    Status: ${driver.isOnline ? 'Online' : 'Offline'}<br>
                    Rating: ${driver.rating || 'N/A'}<br>
                    <button onclick="showDriverDetails('${driver.uid}')" style="margin-top: 5px; padding: 5px 10px; background: #FF6B35; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
                </div>
            `;
        }
        
        // Create active ride popup content
        function createActiveRidePopup(ride) {
            return `
                <div>
                    <strong>Active Ride</strong><br>
                    Passenger: ${ride.passengerName || 'N/A'}<br>
                    Driver: ${ride.driverId ? 'Assigned' : 'Not assigned'}<br>
                    From: ${ride.pickupLocation || 'N/A'}<br>
                    To: ${ride.destination || 'N/A'}<br>
                    Fare: K${ride.fare ? ride.fare.toFixed(2) : '0.00'}<br>
                    <button onclick="showRideDetails('${ride.id}')" style="margin-top: 5px; padding: 5px 10px; background: #FF6B35; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
                </div>
            `;
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Bottom navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Report tabs
            document.querySelectorAll('.tab[data-report]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const reportId = this.getAttribute('data-report');
                    switchReport(reportId);
                });
            });
            
            // Search buttons
            document.getElementById('driverSearchBtn').addEventListener('click', searchDrivers);
            document.getElementById('passengerSearchBtn').addEventListener('click', searchPassengers);
            document.getElementById('rideSearchBtn').addEventListener('click', searchRides);
            
            // Filter changes
            document.getElementById('driverStatusFilter').addEventListener('change', filterDrivers);
            document.getElementById('driverVehicleFilter').addEventListener('change', filterDrivers);
            document.getElementById('passengerStatusFilter').addEventListener('change', filterPassengers);
            document.getElementById('rideStatusFilter').addEventListener('change', filterRides);
            document.getElementById('rideDateFilter').addEventListener('change', filterRides);
            document.getElementById('reportPeriod').addEventListener('change', loadReports);
            
            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => managerMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => managerMap.zoomOut());
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('toggleFullScreenBtn').addEventListener('click', toggleFullScreenMap);
            
            // Full screen map controls
            document.getElementById('fullScreenZoomInBtn').addEventListener('click', () => fullScreenMap.zoomIn());
            document.getElementById('fullScreenZoomOutBtn').addEventListener('click', () => fullScreenMap.zoomOut());
            document.getElementById('fullScreenCenterBtn').addEventListener('click', centerFullScreenMap);
            document.getElementById('exitFullScreenBtn').addEventListener('click', exitFullScreenMap);
            
            // Modal close buttons
            document.getElementById('closeDriverModal').addEventListener('click', closeDriverModal);
            document.getElementById('closePassengerModal').addEventListener('click', closePassengerModal);
            document.getElementById('closeRideModal').addEventListener('click', closeRideModal);
            document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
            document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettingsModal);
            
            // Action buttons
            document.getElementById('editDriverBtn').addEventListener('click', editDriver);
            document.getElementById('suspendDriverBtn').addEventListener('click', suspendDriver);
            document.getElementById('trackDriverBtn').addEventListener('click', trackDriver);
            document.getElementById('editPassengerBtn').addEventListener('click', editPassenger);
            document.getElementById('suspendPassengerBtn').addEventListener('click', suspendPassenger);
            document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
            document.getElementById('reassignRideBtn').addEventListener('click', reassignRide);
            document.getElementById('trackRideBtn').addEventListener('click', trackRide);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // Settings button in header
            document.getElementById('userAvatar').addEventListener('click', openSettings);
        }
        
        // Tab switching
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
            
            // Load data for specific tabs
            if (tabId === 'driversTab') {
                loadDriversData();
            } else if (tabId === 'passengersTab') {
                loadPassengersData();
            } else if (tabId === 'ridesTab') {
                loadRidesData();
            } else if (tabId === 'reportsTab') {
                loadReports();
            } else if (tabId === 'dashboardTab') {
                loadDashboardData();
            }
        }
        
        // Report switching
        function switchReport(reportId) {
            // Hide all report contents
            document.querySelectorAll('.report-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected report content
            document.getElementById(reportId + 'Report').classList.add('active');
            
            // Update active tab
            document.querySelectorAll('.tab[data-report]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-report="${reportId}"]`).classList.add('active');
        }
        
        // Center map on all markers
        function centerMap() {
            if (Object.keys(driverMarkers).length > 0) {
                const group = new L.featureGroup(Object.values(driverMarkers));
                managerMap.fitBounds(group.getBounds(), { padding: [20, 20] });
            } else {
                // Default to Lusaka if no drivers
                managerMap.setView([-15.4167, 28.2833], 13);
            }
        }
        
        // Center full screen map
        function centerFullScreenMap() {
            if (Object.keys(driverMarkers).length > 0) {
                const group = new L.featureGroup(Object.values(driverMarkers));
                fullScreenMap.fitBounds(group.getBounds(), { padding: [20, 20] });
            } else {
                // Default to Lusaka if no drivers
                fullScreenMap.setView([-15.4167, 28.2833], 13);
            }
        }
        
        // Toggle full screen map
        function toggleFullScreenMap() {
            document.getElementById('fullScreenMap').classList.add('active');
            // Refresh the full screen map to ensure it displays correctly
            setTimeout(() => {
                fullScreenMap.invalidateSize();
            }, 100);
        }
        
        // Exit full screen map
        function exitFullScreenMap() {
            document.getElementById('fullScreenMap').classList.remove('active');
        }
        
        // Load dashboard data
        function loadDashboardData() {
            // Load total rides
            database.ref('rides').once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    const totalRides = rides ? Object.keys(rides).length : 0;
                    document.getElementById('totalRides').textContent = totalRides;
                    
                    // Calculate active rides
                    let activeRides = 0;
                    let totalEarnings = 0;
                    let todayEarnings = 0;
                    const today = new Date();
                    
                    if (rides) {
                        Object.keys(rides).forEach(rideId => {
                            const ride = rides[rideId];
                            
                            if (ride.status === 'accepted' || ride.status === 'started') {
                                activeRides++;
                            }
                            
                            if (ride.status === 'completed' && ride.fare) {
                                totalEarnings += ride.fare;
                                
                                // Check if completed today
                                if (ride.completedAt) {
                                    const completedDate = new Date(ride.completedAt);
                                    if (completedDate.toDateString() === today.toDateString()) {
                                        todayEarnings += ride.fare;
                                    }
                                }
                            }
                        });
                    }
                    
                    document.getElementById('activeRides').textContent = activeRides;
                    document.getElementById('todayEarnings').textContent = `K${todayEarnings.toFixed(2)}`;
                    
                    // Load recent activity
                    loadRecentActivity(rides);
                })
                .catch(error => {
                    console.error('Error loading rides:', error);
                });
            
            // Load drivers data
            database.ref('users').orderByChild('userType').equalTo('driver').once('value')
                .then(snapshot => {
                    const drivers = snapshot.val();
                    const totalDrivers = drivers ? Object.keys(drivers).length : 0;
                    document.getElementById('totalDrivers').textContent = totalDrivers;
                    
                    // Calculate online drivers
                    let onlineDrivers = 0;
                    if (drivers) {
                        Object.keys(drivers).forEach(driverId => {
                            const driver = drivers[driverId];
                            if (driver.isOnline) {
                                onlineDrivers++;
                            }
                        });
                    }
                    
                    document.getElementById('onlineDrivers').textContent = onlineDrivers;
                })
                .catch(error => {
                    console.error('Error loading drivers:', error);
                });
            
            // Load passengers data
            database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
                .then(snapshot => {
                    const passengers = snapshot.val();
                    const totalPassengers = passengers ? Object.keys(passengers).length : 0;
                    document.getElementById('totalPassengers').textContent = totalPassengers;
                })
                .catch(error => {
                    console.error('Error loading passengers:', error);
                });
        }
        
        // Load recent activity for dashboard
        function loadRecentActivity(rides) {
            const recentActivityList = document.getElementById('recentActivityList');
            recentActivityList.innerHTML = '';
            
            if (rides) {
                // Sort rides by timestamp (newest first) and take the first 5
                const sortedRides = Object.keys(rides)
                    .map(rideId => ({ id: rideId, ...rides[rideId] }))
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                    .slice(0, 5);
                
                sortedRides.forEach(ride => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'list-item';
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    activityItem.innerHTML = `
                        <div class="item-title">${ride.passengerName || 'Passenger'} â†’ ${ride.destination || 'Destination'}</div>
                        <div class="item-details">
                            <span>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span> â€¢ 
                            <span>${formattedDate} ${formattedTime}</span> â€¢ 
                            <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                        </div>
                    `;
                    
                    activityItem.addEventListener('click', function() {
                        showRideDetails(ride.id);
                    });
                    
                    recentActivityList.appendChild(activityItem);
                });
            } else {
                recentActivityList.innerHTML = '<div class="card"><p>No recent activity found.</p></div>';
            }
        }
        
        // Load drivers data
        function loadDriversData() {
            database.ref('users').orderByChild('userType').equalTo('driver').once('value')
                .then(snapshot => {
                    driversData = snapshot.val() || {};
                    displayDrivers(driversData);
                })
                .catch(error => {
                    console.error('Error loading drivers:', error);
                    showNotification('Error loading drivers data.', 'error');
                });
        }
        
        // Display drivers in the list
        function displayDrivers(drivers) {
            const driversList = document.getElementById('driversList');
            driversList.innerHTML = '';
            
            if (drivers && Object.keys(drivers).length > 0) {
                Object.keys(drivers).forEach(driverId => {
                    const driver = drivers[driverId];
                    const driverItem = document.createElement('div');
                    driverItem.className = 'list-item';
                    
                    const status = driver.isOnline ? 'online' : 'offline';
                    const statusClass = driver.isOnline ? 'status-online' : 'status-offline';
                    
                    driverItem.innerHTML = `
                        <div class="item-title">${driver.name || 'Unknown Driver'}</div>
                        <div class="item-details">
                            <span>${driver.vehicleType || 'Vehicle'} â€¢ ${driver.phone || 'N/A'}</span>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                    `;
                    
                    driverItem.addEventListener('click', function() {
                        showDriverDetails(driverId);
                    });
                    
                    driversList.appendChild(driverItem);
                });
            } else {
                driversList.innerHTML = '<div class="card"><p>No drivers found.</p></div>';
            }
        }
        
        // Load passengers data
        function loadPassengersData() {
            database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
                .then(snapshot => {
                    passengersData = snapshot.val() || {};
                    displayPassengers(passengersData);
                })
                .catch(error => {
                    console.error('Error loading passengers:', error);
                    showNotification('Error loading passengers data.', 'error');
                });
        }
        
        // Display passengers in the list
        function displayPassengers(passengers) {
            const passengersList = document.getElementById('passengersList');
            passengersList.innerHTML = '';
            
            if (passengers && Object.keys(passengers).length > 0) {
                Object.keys(passengers).forEach(passengerId => {
                    const passenger = passengers[passengerId];
                    const passengerItem = document.createElement('div');
                    passengerItem.className = 'list-item';
                    
                    passengerItem.innerHTML = `
                        <div class="item-title">${passenger.name || 'Unknown Passenger'}</div>
                        <div class="item-details">
                            <span>${passenger.phone || 'N/A'} â€¢ ${passenger.email || 'N/A'}</span>
                            <span>Rides: ${passenger.totalRides || 0}</span>
                        </div>
                    `;
                    
                    passengerItem.addEventListener('click', function() {
                        showPassengerDetails(passengerId);
                    });
                    
                    passengersList.appendChild(passengerItem);
                });
            } else {
                passengersList.innerHTML = '<div class="card"><p>No passengers found.</p></div>';
            }
        }
        
        // Load rides data
        function loadRidesData() {
            database.ref('rides').once('value')
                .then(snapshot => {
                    ridesData = snapshot.val() || {};
                    displayRides(ridesData);
                })
                .catch(error => {
                    console.error('Error loading rides:', error);
                    showNotification('Error loading rides data.', 'error');
                });
        }
        
        // Display rides in the list
        function displayRides(rides) {
            const ridesList = document.getElementById('ridesList');
            ridesList.innerHTML = '';
            
            if (rides && Object.keys(rides).length > 0) {
                // Sort rides by timestamp (newest first)
                const sortedRides = Object.keys(rides)
                    .map(rideId => ({ id: rideId, ...rides[rideId] }))
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                sortedRides.forEach(ride => {
                    const rideItem = document.createElement('div');
                    rideItem.className = 'list-item';
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    rideItem.innerHTML = `
                        <div class="item-title">${ride.passengerName || 'Passenger'} â†’ ${ride.destination || 'Destination'}</div>
                        <div class="item-details">
                            <span>K${ride.fare ? ride.fare.toFixed(2) : '0.00'} â€¢ ${formattedDate} ${formattedTime}</span>
                            <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                        </div>
                    `;
                    
                    rideItem.addEventListener('click', function() {
                        showRideDetails(ride.id);
                    });
                    
                    ridesList.appendChild(rideItem);
                });
            } else {
                ridesList.innerHTML = '<div class="card"><p>No rides found.</p></div>';
            }
        }
        
        // Show driver details in modal
        function showDriverDetails(driverId) {
            const driver = driversData[driverId];
            if (!driver) return;
            
            selectedDriver = driverId;
            
            const driverDetailContent = document.getElementById('driverDetailContent');
            driverDetailContent.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${driver.name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${driver.phone || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${driver.email || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Vehicle Type:</span>
                    <span class="detail-value">${driver.vehicleType || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">License Plate:</span>
                    <span class="detail-value">${driver.licensePlate || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge ${driver.isOnline ? 'status-online' : 'status-offline'}">
                            ${driver.isOnline ? 'Online' : 'Offline'}
                        </span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Rating:</span>
                    <span class="detail-value">${driver.rating || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Rides:</span>
                    <span class="detail-value">${driver.totalRides || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Earnings:</span>
                    <span class="detail-value">K${driver.totalEarnings || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Float Balance:</span>
                    <span class="detail-value">K${driver.floatBalance || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Wallet Balance:</span>
                    <span class="detail-value">K${driver.walletBalance || 0}</span>
                </div>
            `;
            
            // Update suspend button text based on current status
            const suspendBtn = document.getElementById('suspendDriverBtn');
            if (driver.isSuspended) {
                suspendBtn.innerHTML = '<i class="fas fa-check"></i> Activate';
                suspendBtn.classList.remove('btn-danger');
                suspendBtn.classList.add('btn-success');
            } else {
                suspendBtn.innerHTML = '<i class="fas fa-ban"></i> Suspend';
                suspendBtn.classList.remove('btn-success');
                suspendBtn.classList.add('btn-danger');
            }
            
            document.getElementById('driverDetailModal').classList.add('active');
        }
        
        // Show passenger details in modal
        function showPassengerDetails(passengerId) {
            const passenger = passengersData[passengerId];
            if (!passenger) return;
            
            selectedPassenger = passengerId;
            
            const passengerDetailContent = document.getElementById('passengerDetailContent');
            passengerDetailContent.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${passenger.name || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${passenger.phone || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value">${passenger.email || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge ${passenger.isSuspended ? 'status-cancelled' : 'status-completed'}">
                            ${passenger.isSuspended ? 'Suspended' : 'Active'}
                        </span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Rating:</span>
                    <span class="detail-value">${passenger.rating || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Rides:</span>
                    <span class="detail-value">${passenger.totalRides || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Spent:</span>
                    <span class="detail-value">K${passenger.totalSpent || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Wallet Balance:</span>
                    <span class="detail-value">K${passenger.walletBalance || 0}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Referral Code:</span>
                    <span class="detail-value">${passenger.referralCode || 'N/A'}</span>
                </div>
                <div class="referral-code">
                    ${passenger.referralCode || 'No referral code'}
                </div>
            `;
            
            // Update suspend button text based on current status
            const suspendBtn = document.getElementById('suspendPassengerBtn');
            if (passenger.isSuspended) {
                suspendBtn.innerHTML = '<i class="fas fa-check"></i> Activate';
                suspendBtn.classList.remove('btn-danger');
                suspendBtn.classList.add('btn-success');
            } else {
                suspendBtn.innerHTML = '<i class="fas fa-ban"></i> Suspend';
                suspendBtn.classList.remove('btn-success');
                suspendBtn.classList.add('btn-danger');
            }
            
            document.getElementById('passengerDetailModal').classList.add('active');
        }
        
        // Show ride details in modal
        function showRideDetails(rideId) {
            const ride = ridesData[rideId];
            if (!ride) return;
            
            selectedRide = rideId;
            
            const rideDetailContent = document.getElementById('rideDetailContent');
            
            const date = new Date(ride.timestamp);
            const formattedDate = date.toLocaleDateString();
            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            rideDetailContent.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Ride ID:</span>
                    <span class="detail-value">${rideId.substring(0, 8)}...</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Passenger:</span>
                    <span class="detail-value">${ride.passengerName || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Driver:</span>
                    <span class="detail-value">${ride.driverId ? 'Assigned' : 'Not assigned'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Pickup:</span>
                    <span class="detail-value">${ride.pickupLocation || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destination:</span>
                    <span class="detail-value">${ride.destination || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Fare:</span>
                    <span class="detail-value">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date & Time:</span>
                    <span class="detail-value">${formattedDate} ${formattedTime}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Distance:</span>
                    <span class="detail-value">${ride.distance || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Ride Type:</span>
                    <span class="detail-value">${ride.rideType || 'Standard'}</span>
                </div>
            `;
            
            document.getElementById('rideDetailModal').classList.add('active');
        }
        
        // Close modals
        function closeDriverModal() {
            document.getElementById('driverDetailModal').classList.remove('active');
            selectedDriver = null;
        }
        
        function closePassengerModal() {
            document.getElementById('passengerDetailModal').classList.remove('active');
            selectedPassenger = null;
        }
        
        function closeRideModal() {
            document.getElementById('rideDetailModal').classList.remove('active');
            selectedRide = null;
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        // Open settings modal
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }
        
        // Driver actions
        function editDriver() {
            if (!selectedDriver) return;
            showNotification('Edit driver functionality would open here.');
            // In a real app, this would open an edit form
        }
        
        function suspendDriver() {
            if (!selectedDriver) return;
            
            const driver = driversData[selectedDriver];
            const newStatus = !driver.isSuspended;
            
            database.ref('users/' + selectedDriver).update({
                isSuspended: newStatus
            })
            .then(() => {
                showNotification(`Driver ${newStatus ? 'suspended' : 'activated'} successfully.`);
                closeDriverModal();
                loadDriversData();
            })
            .catch(error => {
                console.error('Error updating driver status:', error);
                showNotification('Error updating driver status.', 'error');
            });
        }
        
        function trackDriver() {
            if (!selectedDriver) return;
            
            const driver = driversData[selectedDriver];
            if (driverMarkers[selectedDriver]) {
                managerMap.setView(driverMarkers[selectedDriver].getLatLng(), 15);
                driverMarkers[selectedDriver].openPopup();
            }
            
            closeDriverModal();
            switchTab('dashboardTab');
        }
        
        // Passenger actions
        function editPassenger() {
            if (!selectedPassenger) return;
            showNotification('Edit passenger functionality would open here.');
            // In a real app, this would open an edit form
        }
        
        function suspendPassenger() {
            if (!selectedPassenger) return;
            
            const passenger = passengersData[selectedPassenger];
            const newStatus = !passenger.isSuspended;
            
            database.ref('users/' + selectedPassenger).update({
                isSuspended: newStatus
            })
            .then(() => {
                showNotification(`Passenger ${newStatus ? 'suspended' : 'activated'} successfully.`);
                closePassengerModal();
                loadPassengersData();
            })
            .catch(error => {
                console.error('Error updating passenger status:', error);
                showNotification('Error updating passenger status.', 'error');
            });
        }
        
        // Ride actions
        function cancelRide() {
            if (!selectedRide) return;
            
            if (confirm('Are you sure you want to cancel this ride?')) {
                database.ref('rides/' + selectedRide).update({
                    status: 'cancelled',
                    cancelledBy: 'admin',
                    cancelledAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Ride cancelled successfully.');
                    closeRideModal();
                    loadRidesData();
                    loadDashboardData();
                })
                .catch(error => {
                    console.error('Error cancelling ride:', error);
                    showNotification('Error cancelling ride.', 'error');
                });
            }
        }
        
        function reassignRide() {
            if (!selectedRide) return;
            showNotification('Reassign ride functionality would open here.');
            // In a real app, this would open a driver selection interface
        }
        
        function trackRide() {
            if (!selectedRide) return;
            
            const ride = ridesData[selectedRide];
            if (activeRideMarkers[selectedRide]) {
                toggleFullScreenMap();
                fullScreenMap.setView(activeRideMarkers[selectedRide].getLatLng(), 15);
                activeRideMarkers[selectedRide].openPopup();
                
                // Update ride tracking info
                const trackingInfo = document.getElementById('fullScreenRideTracking');
                trackingInfo.innerHTML = `
                    <h4>Tracking Ride</h4>
                    <div class="detail-row">
                        <span class="detail-label">Passenger:</span>
                        <span class="detail-value">${ride.passengerName || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value">${ride.destination || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                        </span>
                    </div>
                `;
            }
            
            closeRideModal();
        }
        
        // Search functions
        function searchDrivers() {
            const query = document.getElementById('driverSearch').value.toLowerCase();
            const filteredDrivers = {};
            
            Object.keys(driversData).forEach(driverId => {
                const driver = driversData[driverId];
                if (
                    (driver.name && driver.name.toLowerCase().includes(query)) ||
                    (driver.phone && driver.phone.includes(query)) ||
                    (driver.email && driver.email.toLowerCase().includes(query)) ||
                    (driver.licensePlate && driver.licensePlate.toLowerCase().includes(query))
                ) {
                    filteredDrivers[driverId] = driver;
                }
            });
            
            displayDrivers(filteredDrivers);
        }
        
        function searchPassengers() {
            const query = document.getElementById('passengerSearch').value.toLowerCase();
            const filteredPassengers = {};
            
            Object.keys(passengersData).forEach(passengerId => {
                const passenger = passengersData[passengerId];
                if (
                    (passenger.name && passenger.name.toLowerCase().includes(query)) ||
                    (passenger.phone && passenger.phone.includes(query)) ||
                    (passenger.email && passenger.email.toLowerCase().includes(query))
                ) {
                    filteredPassengers[passengerId] = passenger;
                }
            });
            
            displayPassengers(filteredPassengers);
        }
        
        function searchRides() {
            const query = document.getElementById('rideSearch').value.toLowerCase();
            const filteredRides = {};
            
            Object.keys(ridesData).forEach(rideId => {
                const ride = ridesData[rideId];
                if (
                    (ride.passengerName && ride.passengerName.toLowerCase().includes(query)) ||
                    (ride.pickupLocation && ride.pickupLocation.toLowerCase().includes(query)) ||
                    (ride.destination && ride.destination.toLowerCase().includes(query))
                ) {
                    filteredRides[rideId] = ride;
                }
            });
            
            displayRides(filteredRides);
        }
        
        // Filter functions
        function filterDrivers() {
            const statusFilter = document.getElementById('driverStatusFilter').value;
            const vehicleFilter = document.getElementById('driverVehicleFilter').value;
            const filteredDrivers = {};
            
            Object.keys(driversData).forEach(driverId => {
                const driver = driversData[driverId];
                let statusMatch = true;
                let vehicleMatch = true;
                
                if (statusFilter === 'online') {
                    statusMatch = driver.isOnline === true;
                } else if (statusFilter === 'offline') {
                    statusMatch = driver.isOnline === false;
                } else if (statusFilter === 'suspended') {
                    statusMatch = driver.isSuspended === true;
                }
                
                if (vehicleFilter !== 'all') {
                    vehicleMatch = driver.vehicleType === vehicleFilter;
                }
                
                if (statusMatch && vehicleMatch) {
                    filteredDrivers[driverId] = driver;
                }
            });
            
            displayDrivers(filteredDrivers);
        }
        
        function filterPassengers() {
            const statusFilter = document.getElementById('passengerStatusFilter').value;
            const filteredPassengers = {};
            
            Object.keys(passengersData).forEach(passengerId => {
                const passenger = passengersData[passengerId];
                let statusMatch = true;
                
                if (statusFilter === 'active') {
                    statusMatch = passenger.isSuspended !== true;
                } else if (statusFilter === 'suspended') {
                    statusMatch = passenger.isSuspended === true;
                }
                
                if (statusMatch) {
                    filteredPassengers[passengerId] = passenger;
                }
            });
            
            displayPassengers(filteredPassengers);
        }
        
        function filterRides() {
            const statusFilter = document.getElementById('rideStatusFilter').value;
            const dateFilter = document.getElementById('rideDateFilter').value;
            const filteredRides = {};
            
            Object.keys(ridesData).forEach(rideId => {
                const ride = ridesData[rideId];
                let statusMatch = true;
                let dateMatch = true;
                
                if (statusFilter !== 'all') {
                    statusMatch = ride.status === statusFilter;
                }
                
                if (dateFilter) {
                    const rideDate = new Date(ride.timestamp);
                    const filterDate = new Date(dateFilter);
                    dateMatch = rideDate.toDateString() === filterDate.toDateString();
                }
                
                if (statusMatch && dateMatch) {
                    filteredRides[rideId] = ride;
                }
            });
            
            displayRides(filteredRides);
        }
        
        // Load reports
        function loadReports() {
            const period = document.getElementById('reportPeriod').value;
            // In a real app, this would fetch and display report data based on the selected period
            showNotification(`Loading ${period} reports...`);
        }
        
        // Load settings
        function loadSettings() {
            database.ref('settings').once('value')
                .then(snapshot => {
                    const settings = snapshot.val();
                    if (settings) {
                        if (settings.fareRate) {
                            document.getElementById('fareRate').value = settings.fareRate;
                        }
                        if (settings.commissionRate) {
                            document.getElementById('commissionRate').value = settings.commissionRate;
                        }
                        if (settings.minFloat) {
                            document.getElementById('minFloat').value = settings.minFloat;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                });
        }
        
        // Save settings
        function saveSettings() {
            const fareRate = parseFloat(document.getElementById('fareRate').value);
            const commissionRate = parseFloat(document.getElementById('commissionRate').value);
            const minFloat = parseFloat(document.getElementById('minFloat').value);
            
            database.ref('settings').set({
                fareRate: fareRate,
                commissionRate: commissionRate,
                minFloat: minFloat
            })
            .then(() => {
                showNotification('Settings saved successfully.');
                closeSettingsModal();
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings.', 'error');
            });
        }
        
        // Show notification
        function showNotification(message, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.style.background = 'var(--error-red)';
            } else {
                notification.style.background = 'var(--primary-gradient)';
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Global function to show driver details from map popup
        window.showDriverDetails = function(driverId) {
            showDriverDetails(driverId);
        };
        
        // Global function to show ride details from map popup
        window.showRideDetails = function(rideId) {
            showRideDetails(rideId);
        };
    </script>
</body>
</html>) improve the map should be full screen and remove the graph and analytics the buttons above the map
admin needs to see loaction of online drivers and passengers on the map 
when admin click on ride full details of that ride should expand 
analyze carefully the driver.html (<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 12px rgba(255, 107, 53, 0.1);
            --shadow-medium: 0 4px 20px rgba(255, 107, 53, 0.15);
            --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s ease;
        }
        
        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .jubel-logo {
            width: 200px;
            height: 200px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
        }
        
        .jubel-logo-text {
            color: var(--white);
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .welcome-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        .welcome-subtitle {
            font-size: 1rem;
            color: var(--medium-gray);
            margin-bottom: 40px;
            text-align: center;
            max-width: 300px;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .auth-btn {
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-login {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-signup {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        /* Auth Screens */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 900;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        
        .auth-screen.active {
            display: block;
        }
        
        .auth-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .back-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            color: var(--dark-gray);
        }
        
        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            background-color: var(--white);
            cursor: pointer;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1.5rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .vehicle-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .vehicle-details.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .submit-btn {
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 10px;
        }
        
        .submit-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }
        
        .auth-link {
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-float {
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .float-amount {
            color: var(--primary-orange);
            font-size: 0.9rem;
        }
        
        .online-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: 2px solid var(--border-color);
            font-size: 0.7rem;
            height: 32px;
        }
        
        .online-toggle.active {
            border-color: var(--success-green);
            background: var(--success-green);
            color: var(--white);
        }
        
        .online-toggle.offline {
            border-color: var(--medium-gray);
            background: var(--medium-gray);
            color: var(--white);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success-green);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .driver-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .driver-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 10px;
            cursor: pointer;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.9rem;
        }
        
        .ride-action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .ride-action-btn.hold-to-start {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-arrive {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-pickup {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-complete {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-active {
            background: var(--primary-gradient);
            color: var(--white);
            border-color: transparent;
        }
        
        .ride-action-btn:active {
            transform: scale(0.98);
        }
        
        .hold-progress {
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .hold-progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.1s linear;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .ride-request-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--app-padding);
        }
        
        .ride-request-content {
            background: var(--white);
            border-radius: 15px;
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform var(--transition-speed) ease;
            animation: popup-appear 0.3s ease forwards;
        }
        
        @keyframes popup-appear {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .ride-request-map {
            height: 180px;
            width: 100%;
        }
        
        .ride-request-details {
            padding: 12px;
            overflow-y: auto;
        }
        
        .customer-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .customer-details h3 {
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .customer-details p {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .trip-details {
            margin-bottom: 12px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            padding-top: 6px;
            margin-top: 6px;
        }
        
        .ride-request-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-accept {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-reject {
            background: var(--error-red);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .back-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        
        .screen-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .earnings-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
            background-color: var(--light-gray);
            color: var(--medium-gray);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .balance-label {
            font-size: 0.75rem;
            margin-bottom: 3px;
        }
        
        .balance-amount-large {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 8px;
            font-size: 0.75rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            font-weight: 600;
        }
        
        .vehicle-details {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .earnings-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .earnings-period {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .period-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .period-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
            border-color: transparent;
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .stat-item {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .earnings-chart {
            height: 120px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        .waypoints-container {
            margin-top: 8px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .waypoint-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }
        
        .waypoint-item:last-child {
            border-bottom: none;
        }
        
        .waypoint-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--info-blue);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .waypoint-text {
            flex: 1;
        }
        
        .navigation-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .nav-control-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--info-blue);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .nav-control-btn.secondary {
            background: var(--medium-gray);
        }
        
        .trip-info-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .trip-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.75rem;
        }
        
        .trip-info-row:last-child {
            margin-bottom: 0;
        }
        
        .trip-info-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .trip-info-value {
            font-weight: 700;
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
        }
        
        .commission-display {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.75rem;
        }
        
        .commission-label {
            color: var(--medium-gray);
        }
        
        .commission-value {
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .commission-deduction {
            color: var(--error-red);
        }
        
        .balance-update {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        
        .balance-label-update {
            color: var(--medium-gray);
        }
        
        .balance-value-update {
            font-weight: 600;
            color: var(--success-green);
        }
        
        .no-float-warning {
            background-color: var(--light-orange);
            border: 1px solid var(--primary-orange);
            border-radius: var(--element-radius);
            padding: 10px;
            margin-bottom: 12px;
            text-align: center;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        .no-float-warning i {
            margin-right: 6px;
        }
        
        .float-section {
            margin-bottom: 20px;
        }
        
        .float-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        
        .btn-float {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 10px;
            font-size: 0.8rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
        }
        
        .btn-float:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .float-history {
            margin-top: 12px;
        }
        
        .float-history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
        }
        
        .float-history-item:last-child {
            border-bottom: none;
        }
        
        .float-amount {
            font-weight: 600;
        }
        
        .float-amount.positive {
            color: var(--success-green);
        }
        
        .float-amount.negative {
            color: var(--error-red);
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .hold-button-container {
            position: relative;
            width: 100%;
            height: 50px;
            border-radius: var(--element-radius);
            overflow: hidden;
            background: var(--white);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-medium);
        }
        
        .hold-button-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: var(--primary-gradient);
            transition: width 0.1s linear;
            z-index: 1;
        }
        
        .hold-button-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            z-index: 2;
            color: var(--dark-gray);
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .hold-button-content.active {
            color: var(--white);
        }
        
        .advanced-features {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .feature-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .feature-btn:hover {
            background: var(--light-orange);
        }
        
        .feature-btn i {
            font-size: 1rem;
            color: var(--primary-orange);
        }
        
        .driver-status-indicator {
            position: fixed;
            top: 60px;
            right: 15px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.online {
            background: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .quick-actions {
            position: fixed;
            bottom: 70px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .collapsible-section {
            margin-bottom: 12px;
        }
        
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-speed) ease;
        }
        
        .collapsible-content.expanded {
            max-height: 500px;
        }
        
        .collapsible-icon {
            transition: transform var(--transition-speed) ease;
        }
        
        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }
        
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            gap: 8px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .performance-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .performance-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .performance-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .ride-queue {
            margin-top: 12px;
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .queue-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .queue-location {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .queue-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .queue-action {
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--element-radius);
            padding: 5px 10px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .dark-mode-toggle {
            position: fixed;
            bottom: 70px;
            left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            z-index: 100;
        }
        
        .map-controls {
            position: fixed;
            top: 60px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .logout-btn {
            background: var(--error-red);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
            width: 100%;
        }
        
        /* New styles for the modifications */
        .hold-button-content span {
            color: #000000 !important; /* Black text for hold buttons */
        }
        
        .wallet-section {
            margin-bottom: 20px;
        }
        
        .wallet-balance-card {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .float-balance-card {
            background: var(--light-orange);
            color: var(--dark-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
            border: 2px solid var(--primary-orange);
        }
        
        .balance-amount-medium {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .history-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.7rem;
        }
        
        .history-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .history-detail-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .history-detail-value {
            font-weight: 600;
        }
        
        .sound-control {
            position: fixed;
            bottom: 130px;
            left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            z-index: 100;
        }
        
        @media (max-width: 480px) {
            .floating-float, .online-toggle {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .driver-panel {
                padding: 10px;
            }
            
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 6px 3px;
                font-size: 0.6rem;
            }
            
            .ride-request-content {
                max-height: 95vh;
            }
            
            .quick-actions {
                bottom: 65px;
                right: 10px;
            }
            
            .quick-action-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .dark-mode-toggle {
                bottom: 65px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
            
            .sound-control {
                bottom: 120px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="jubel-logo">
            <div class="jubel-logo-text">J</div>
        </div>
        <h1 class="welcome-title">Welcome to Jubel Driver</h1>
        <p class="welcome-subtitle">Join our network of professional drivers and start earning today</p>
        <div class="auth-buttons">
            <button class="auth-btn btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i>
                Log In
            </button>
            <button class="auth-btn btn-signup" id="signupBtn">
                <i class="fas fa-user-plus"></i>
                Sign Up
            </button>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div class="auth-screen" id="loginScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromLogin">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Log In</h2>
        </div>
        
        <form class="auth-form" id="loginForm">
            <div class="form-group">
                <label for="loginEmail" class="form-label">Email Address</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
            </div>
            
            <button type="submit" class="submit-btn">Log In</button>
        </form>
        
        <div class="auth-footer">
            <p>Don't have an account? <span class="auth-link" id="goToSignupFromLogin">Sign Up</span></p>
        </div>
    </div>
    
    <!-- Signup Screen -->
    <div class="auth-screen" id="signupScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromSignup">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Sign Up</h2>
        </div>
        
        <form class="auth-form" id="signupForm">
            <div class="form-group">
                <label for="signupName" class="form-label">Full Name</label>
                <input type="text" id="signupName" class="form-input" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
                <label for="signupEmail" class="form-label">Email Address</label>
                <input type="email" id="signupEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="signupPhone" class="form-label">Phone Number</label>
                <input type="tel" id="signupPhone" class="form-input" placeholder="Your phone number" required>
            </div>
            
            <div class="form-group">
                <label for="signupNRC" class="form-label">NRC Number</label>
                <input type="text" id="signupNRC" class="form-input" placeholder="Your NRC number" required>
            </div>
            
            <div class="form-group">
                <label for="signupPassword" class="form-label">Password</label>
                <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
            </div>
            
            <div class="form-group">
                <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
            </div>
            
            <h3 class="section-title">Vehicle Information</h3>
            
            <div class="vehicle-selection">
                <div class="vehicle-option" data-type="car">
                    <i class="fas fa-car vehicle-icon"></i>
                    <span class="vehicle-name">Car</span>
                </div>
                <div class="vehicle-option" data-type="bike">
                    <i class="fas fa-motorcycle vehicle-icon"></i>
                    <span class="vehicle-name">Bike</span>
                </div>
                <div class="vehicle-option" data-type="bicycle">
                    <i class="fas fa-bicycle vehicle-icon"></i>
                    <span class="vehicle-name">Bicycle</span>
                </div>
            </div>
            
            <!-- Car Details -->
            <div class="vehicle-details" id="carDetails">
                <div class="form-group">
                    <label for="carMake" class="form-label">Car Make</label>
                    <input type="text" id="carMake" class="form-input" placeholder="Toyota, Honda, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carModel" class="form-label">Car Model</label>
                    <input type="text" id="carModel" class="form-input" placeholder="Corolla, Civic, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carYear" class="form-label">Year</label>
                    <input type="number" id="carYear" class="form-input" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="carColor" class="form-label">Color</label>
                    <input type="text" id="carColor" class="form-input" placeholder="Red, Blue, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carLicensePlate" class="form-label">License Plate</label>
                    <input type="text" id="carLicensePlate" class="form-input" placeholder="ABC 123">
                </div>
                
                <div class="form-group">
                    <label for="carLicenseNumber" class="form-label">Driver's License Number</label>
                    <input type="text" id="carLicenseNumber" class="form-input" placeholder="Your driver's license number">
                </div>
            </div>
            
            <!-- Bike Details -->
            <div class="vehicle-details" id="bikeDetails">
                <div class="form-group">
                    <label for="bikeMake" class="form-label">Bike Make</label>
                    <input type="text" id="bikeMake" class="form-input" placeholder="Honda, Yamaha, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bikeModel" class="form-label">Bike Model</label>
                    <input type="text" id="bikeModel" class="form-input" placeholder="CBR, R15, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bikeYear" class="form-label">Year</label>
                    <input type="number" id="bikeYear" class="form-input" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="bikeLicenseNumber" class="form-label">Driver's License Number</label>
                    <input type="text" id="bikeLicenseNumber" class="form-input" placeholder="Your driver's license number">
                </div>
            </div>
            
            <!-- Bicycle Details -->
            <div class="vehicle-details" id="bicycleDetails">
                <div class="form-group">
                    <label for="bicycleMake" class="form-label">Bicycle Make</label>
                    <input type="text" id="bicycleMake" class="form-input" placeholder="Giant, Trek, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bicycleColor" class="form-label">Color</label>
                    <input type="text" id="bicycleColor" class="form-input" placeholder="Red, Blue, etc.">
                </div>
            </div>
            
            <h3 class="section-title">Payment Information</h3>
            
            <div class="form-group">
                <label for="paymentMethod" class="form-label">Payment Method</label>
                <select id="paymentMethod" class="form-select">
                    <option value="">Select payment method</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="mobile">Mobile Money</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="paymentDetails" class="form-label">Payment Details</label>
                <input type="text" id="paymentDetails" class="form-input" placeholder="Account number or mobile money number">
            </div>
            
            <button type="submit" class="submit-btn" id="signupSubmitBtn">Create Account</button>
        </form>
        
        <div class="auth-footer">
            <p>Already have an account? <span class="auth-link" id="goToLoginFromSignup">Log In</span></p>
        </div>
    </div>
    
    <!-- Main App (Hidden until authentication) -->
    <div id="mainApp" style="display: none;">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Float (Only on Home Screen) -->
        <div class="floating-float" id="floatingFloat">
            <i class="fas fa-wallet"></i>
            <span>Float: <span class="float-amount" id="floatBalanceDisplay">K0.00</span></span>
        </div>
        
        <!-- Online Toggle (Only on Home Screen) -->
        <div class="online-toggle offline" id="onlineToggle">
            <label class="toggle-switch">
                <input type="checkbox" id="onlineToggleCheckbox">
                <span class="toggle-slider"></span>
            </label>
            <span id="onlineStatusText">Offline</span>
        </div>
        
        <!-- Driver Status Indicator (Only on Home Screen) -->
        <div class="driver-status-indicator" id="driverStatusIndicator" style="display: none;">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Offline</span>
        </div>
        
        <!-- Map Controls (Only on Home Screen) -->
        <div class="map-controls" id="mapControls">
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="mapTypeBtn" title="Change Map Type">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- Quick Actions (Only on Home Screen) -->
        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" id="centerMapBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="quick-action-btn" id="refreshLocationBtn" title="Refresh Location">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn" id="toggleTrafficBtn" title="Toggle Traffic">
                <i class="fas fa-traffic-light"></i>
            </button>
        </div>
        
        <!-- Dark Mode Toggle (Only on Home Screen) -->
        <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Sound Control (Only on Home Screen) -->
        <button class="sound-control" id="soundControl" title="Toggle Sound">
            <i class="fas fa-volume-up"></i>
        </button>
        
        <!-- Driver Panel -->
        <div class="driver-panel" id="driverPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="driver-info">
                <div class="driver-avatar" id="driverAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="driver-details">
                    <h2 id="driverName">Driver Name</h2>
                    <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                    <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="earnings">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Earnings</span>
                </button>
            </div>
            
            <!-- Collapsible Driver Details -->
            <div class="collapsible-section">
                <div class="collapsible-header" id="driverDetailsHeader">
                    <h3>Driver Details</h3>
                    <i class="fas fa-chevron-down collapsible-icon" id="driverDetailsIcon"></i>
                </div>
                <div class="collapsible-content" id="driverDetailsContent">
                    <div class="performance-stats">
                        <div class="performance-card">
                            <div class="performance-value" id="totalTrips">0</div>
                            <div class="performance-label">Total Trips</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="ratingScore">4.5</div>
                            <div class="performance-label">Rating</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="onlineTime">0h</div>
                            <div class="performance-label">Online Time</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="acceptanceRate">0%</div>
                            <div class="performance-label">Acceptance</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ride Action Button (Hidden until ride request) -->
            <div class="hold-button-container" id="rideActionBtn" style="display: none;">
                <div class="hold-button-fill" id="holdButtonFill"></div>
                <div class="hold-button-content" id="holdButtonContent">
                    <i class="fas fa-play-circle"></i>
                    <span>Hold to Start Ride</span>
                </div>
            </div>
            
            <!-- Advanced Features Section -->
            <div class="advanced-features" id="advancedFeatures" style="display: none;">
                <button class="feature-btn" id="navigateToPickupBtn">
                    <i class="fas fa-directions"></i>
                    <span>Navigate to Pickup</span>
                </button>
                <button class="feature-btn" id="contactCustomerBtn">
                    <i class="fas fa-phone"></i>
                    <span>Contact Customer</span>
                </button>
                <button class="feature-btn" id="viewRouteDetailsBtn">
                    <i class="fas fa-route"></i>
                    <span>View Route Details</span>
                </button>
            </div>
            
            <!-- Ride Queue (Advanced Feature) -->
            <div class="ride-queue" id="rideQueue" style="display: none;">
                <h3 class="section-title">Ride Queue</h3>
                <div id="queueList">
                    <!-- Queue items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Ride Request Popup -->
        <div class="ride-request-popup" id="rideRequestPopup">
            <div class="ride-request-content">
                <div class="ride-request-map" id="rideRequestMap"></div>
                <div class="ride-request-details">
                    <div class="customer-info">
                        <div class="customer-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="customer-details">
                            <h3 id="customerName">Customer Name</h3>
                            <p><i class="fas fa-phone"></i> <span id="customerPhone">000-000-0000</span></p>
                            <div class="rating-display">
                                <i class="fas fa-star"></i>
                                <span id="customerRating">4.8</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="pickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="destinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="trip-info-card">
                        <div class="trip-info-row">
                            <span class="trip-info-label">Distance</span>
                            <span class="trip-info-value" id="tripDistance">5.2 km</span>
                        </div>
                        <div class="trip-info-row">
                            <span class="trip-info-label">Estimated Time</span>
                            <span class="trip-info-value" id="tripTime">15 min</span>
                        </div>
                        <div class="trip-info-row">
                            <span class="trip-info-label">Surge Pricing</span>
                            <span class="trip-info-value" id="surgeMultiplier">1.2x</span>
                        </div>
                    </div>
                    
                    <h4 class="section-title">Route Waypoints</h4>
                    <div class="waypoints-container" id="waypointsContainer">
                        <!-- Waypoints will be populated here -->
                    </div>
                    
                    <div class="ride-request-actions">
                        <button class="btn btn-accept" id="acceptRideBtn">
                            <i class="fas fa-check-circle"></i>
                            Accept
                        </button>
                        <button class="btn btn-reject" id="rejectRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Reject
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    Driver Details
                </h3>
                <div class="input-group">
                    <label for="driverNameInput">Full Name</label>
                    <input type="text" id="driverNameInput" class="input-field" placeholder="Your full name" readonly>
                </div>
                <div class="input-group">
                    <label for="driverPhoneInput">Phone Number</label>
                    <input type="tel" id="driverPhoneInput" class="input-field" placeholder="Your phone number" readonly>
                </div>
                <div class="input-group">
                    <label for="driverEmailInput">Email Address</label>
                    <input type="email" id="driverEmailInput" class="input-field" placeholder="Your email address" readonly>
                </div>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-car"></i>
                    Vehicle Details
                </h3>
                <div class="input-group">
                    <label for="vehicleTypeInput">Vehicle Type</label>
                    <input type="text" id="vehicleTypeInput" class="input-field" placeholder="Car, Bike, etc." readonly>
                </div>
                <div class="input-group">
                    <label for="vehicleModelInput">Vehicle Model</label>
                    <input type="text" id="vehicleModelInput" class="input-field" placeholder="Toyota Corolla, etc." readonly>
                </div>
                <div class="input-group">
                    <label for="licensePlateInput">License Plate</label>
                    <input type="text" id="licensePlateInput" class="input-field" placeholder="ABC 123" readonly>
                </div>
                <div class="input-group">
                    <label for="vehicleColorInput">Vehicle Color</label>
                    <input type="text" id="vehicleColorInput" class="input-field" placeholder="Red, Blue, etc." readonly>
                </div>
            </div>
            
            <!-- Wallet Section (Separate from Float) -->
            <div class="wallet-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    Wallet & Earnings
                </h3>
                <div class="wallet-balance-card">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount-large" id="walletBalance">K0.00</div>
                    <div>Money earned from completed trips</div>
                </div>
                
                <div class="wallet-actions">
                    <button class="btn btn-wallet" id="addFundsBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Funds
                    </button>
                    <button class="btn btn-wallet" id="withdrawFundsBtn">
                        <i class="fas fa-minus-circle"></i>
                        Withdraw
                    </button>
                </div>
                
                <div class="vehicle-details">
                    <div class="detail-row">
                        <span class="detail-label">Total Earnings</span>
                        <span class="detail-value" id="totalEarnings">K0.00</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Completed Rides</span>
                        <span class="detail-value" id="completedRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cancelled Rides</span>
                        <span class="detail-value" id="cancelledRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Rating</span>
                        <span class="detail-value" id="driverRating">4.5 â˜…</span>
                    </div>
                </div>
            </div>
            
            <!-- Float Management Section (Separate from Wallet) -->
            <div class="float-section">
                <h3 class="section-title">
                    <i class="fas fa-money-bill-alt"></i>
                    Float Management
                </h3>
                <div class="float-balance-card">
                    <div class="balance-label">Current Float Balance</div>
                    <div class="balance-amount-medium" id="floatBalance">K0.00</div>
                    <div>Minimum K10.00 required to go online</div>
                </div>
                
                <div class="float-actions">
                    <button class="btn-float" id="addFloatBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Float
                    </button>
                    <button class="btn-float" id="adjustFloatBtn">
                        <i class="fas fa-exchange-alt"></i>
                        Adjust Float
                    </button>
                </div>
                
                <div class="float-history">
                    <h4 class="section-title">Float History</h4>
                    <div id="floatHistoryList">
                        <!-- Float history items will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Logout Button -->
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Log Out
            </button>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="earningsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Earnings</h2>
            </div>
            
            <div class="earnings-section">
                <div class="earnings-period">
                    <button class="period-btn active" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn" data-period="month">This Month</button>
                </div>
                
                <div class="earnings-card">
                    <div class="earnings-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="earningsTotal">K0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ridesCompleted">0</div>
                            <div class="stat-label">Rides Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgEarning">K0.00</div>
                            <div class="stat-label">Avg per Ride</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="onlineHours">0h</div>
                            <div class="stat-label">Online Time</div>
                        </div>
                    </div>
                    
                    <div class="earnings-chart">
                        Earnings chart would appear here
                    </div>
                    
                    <button class="btn btn-accept" id="withdrawEarningsBtn">
                        <i class="fas fa-download"></i>
                        Withdraw Earnings
                    </button>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-receipt"></i>
                    Recent Earnings
                </h3>
                <div id="earningsList">
                    <!-- Earnings items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let isOnline = false;
        let driverMap, rideRequestMap;
        let locationWatchId = null;
        let driverMarker = null;
        let customerMarker = null;
        let destinationMarker = null;
        let routePolyline = null;
        let holdTimer = null;
        let holdProgress = 0;
        let currentRideRequest = null;
        let earningsPeriod = 'today';
        let waypoints = [];
        let floatBalance = 0;
        let walletBalance = 0;
        let commissionRate = 0.08; // 8% commission
        let trafficLayer = null;
        let trafficEnabled = false;
        let mapType = 'standard';
        let isDarkMode = false;
        let rideQueue = [];
        let floatHistory = [];
        let selectedVehicleType = '';
        let soundEnabled = true;
        let rideRequestSound = null;
        let rideRequestSoundInterval = null;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            setupAuthEventListeners();
            initializeSound();
        });
        
        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    initializeMap();
                    setupEventListeners();
                    loadDriverData();
                    initializeAdvancedFeatures();
                } else {
                    // Show welcome screen
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                }
            });
        }
        
        // Show main app after authentication
        function showMainApp() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('signupScreen').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
        }
        
        // Setup authentication event listeners
        function setupAuthEventListeners() {
            // Welcome screen buttons
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            document.getElementById('signupBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('signupScreen').classList.add('active');
            });
            
            // Back buttons
            document.getElementById('backFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            document.getElementById('backFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            // Navigation between auth screens
            document.getElementById('goToSignupFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('signupScreen').classList.add('active');
            });
            
            document.getElementById('goToLoginFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            // Vehicle selection
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.vehicle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Hide all vehicle details
                    document.querySelectorAll('.vehicle-details').forEach(details => {
                        details.classList.remove('active');
                    });
                    
                    // Show selected vehicle details
                    selectedVehicleType = this.getAttribute('data-type');
                    document.getElementById(selectedVehicleType + 'Details').classList.add('active');
                });
            });
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in successfully
                        showNotification('Login successful!');
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        showNotification('Login failed: ' + error.message);
                    });
            });
            
            // Signup form submission
            document.getElementById('signupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate passwords match
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match');
                    return;
                }
                
                // Validate vehicle type is selected
                if (!selectedVehicleType) {
                    showNotification('Please select a vehicle type');
                    return;
                }
                
                const email = document.getElementById('signupEmail').value;
                const name = document.getElementById('signupName').value;
                const phone = document.getElementById('signupPhone').value;
                const nrc = document.getElementById('signupNRC').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentDetails = document.getElementById('paymentDetails').value;
                
                // Create user with email and password
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        
                        // Prepare vehicle data based on selected type
                        let vehicleData = {};
                        if (selectedVehicleType === 'car') {
                            vehicleData = {
                                type: 'car',
                                make: document.getElementById('carMake').value,
                                model: document.getElementById('carModel').value,
                                year: document.getElementById('carYear').value,
                                color: document.getElementById('carColor').value,
                                licensePlate: document.getElementById('carLicensePlate').value,
                                licenseNumber: document.getElementById('carLicenseNumber').value
                            };
                        } else if (selectedVehicleType === 'bike') {
                            vehicleData = {
                                type: 'bike',
                                make: document.getElementById('bikeMake').value,
                                model: document.getElementById('bikeModel').value,
                                year: document.getElementById('bikeYear').value,
                                licenseNumber: document.getElementById('bikeLicenseNumber').value
                            };
                        } else if (selectedVehicleType === 'bicycle') {
                            vehicleData = {
                                type: 'bicycle',
                                make: document.getElementById('bicycleMake').value,
                                color: document.getElementById('bicycleColor').value
                            };
                        }
                        
                        // Save user data to Firebase
                        return database.ref('users/' + user.uid).set({
                            name: name,
                            email: email,
                            phone: phone,
                            nrc: nrc,
                            vehicle: vehicleData,
                            payment: {
                                method: paymentMethod,
                                details: paymentDetails
                            },
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            isOnline: false,
                            walletBalance: 0,
                            floatBalance: 0
                        });
                    })
                    .then(() => {
                        showNotification('Account created successfully!');
                    })
                    .catch((error) => {
                        console.error('Signup error:', error);
                        showNotification('Signup failed: ' + error.message);
                    });
            });
        }
        
        // Map initialization
        function initializeMap() {
            // Main driver map
            driverMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            
            // Use a clean map style without colors around the car
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(driverMap);
            
            // Ride request map
            rideRequestMap = L.map('rideRequestMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(rideRequestMap);
            
            // Get driver's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 15);
                    
                    // Add marker for driver location (without orange border)
                    driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<div class="driver-marker">ðŸš—</div><div class="driver-marker-label">You</div>',
                            iconSize: [35, 50]
                        })
                    }).addTo(driverMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Update driver location in Firebase
        function updateDriverLocation(lat, lng) {
            if (currentUser && isOnline) {
                database.ref('driverLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    vehicleType: selectedVehicleType
                });
                
                // Update marker position
                if (driverMarker) {
                    driverMarker.setLatLng([lat, lng]);
                }
            }
        }
        
        // Start tracking driver location
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateDriverLocation(lat, lng);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking driver location
        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }
        
        // Initialize sound
        function initializeSound() {
            // Create audio element for ride request sound
            rideRequestSound = new Audio();
            rideRequestSound.src = 'order.mp3';
            rideRequestSound.loop = false;
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Online toggle
            document.getElementById('onlineToggleCheckbox').addEventListener('change', toggleOnlineStatus);
            
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                    // Refresh driver position when returning to home
                    if (screen === 'home') {
                        refreshDriverPosition();
                    }
                });
            });
            
            // Ride request actions
            document.getElementById('acceptRideBtn').addEventListener('click', acceptRide);
            document.getElementById('rejectRideBtn').addEventListener('click', rejectRide);
            
            // Ride action button (hold functionality)
            const rideActionBtn = document.getElementById('rideActionBtn');
            
            rideActionBtn.addEventListener('mousedown', startHoldTimer);
            rideActionBtn.addEventListener('touchstart', startHoldTimer);
            
            rideActionBtn.addEventListener('mouseup', cancelHoldTimer);
            rideActionBtn.addEventListener('touchend', cancelHoldTimer);
            rideActionBtn.addEventListener('mouseleave', cancelHoldTimer);
            
            // Account actions
            document.getElementById('addFundsBtn').addEventListener('click', addFunds);
            document.getElementById('withdrawFundsBtn').addEventListener('click', withdrawFunds);
            
            // Float actions
            document.getElementById('addFloatBtn').addEventListener('click', addFloat);
            document.getElementById('adjustFloatBtn').addEventListener('click', adjustFloat);
            
            // Earnings period selection
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    earningsPeriod = this.getAttribute('data-period');
                    loadEarnings();
                });
            });
            
            // Withdraw earnings
            document.getElementById('withdrawEarningsBtn').addEventListener('click', withdrawEarnings);
            
            // Advanced features
            document.getElementById('navigateToPickupBtn').addEventListener('click', navigateToPickup);
            document.getElementById('contactCustomerBtn').addEventListener('click', contactCustomer);
            document.getElementById('viewRouteDetailsBtn').addEventListener('click', viewRouteDetails);
            
            // Quick actions
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshDriverPosition);
            document.getElementById('toggleTrafficBtn').addEventListener('click', toggleTraffic);
            
            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => driverMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => driverMap.zoomOut());
            document.getElementById('mapTypeBtn').addEventListener('click', toggleMapType);
            
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Sound control
            document.getElementById('soundControl').addEventListener('click', toggleSound);
            
            // Panel collapse
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            // Collapsible sections
            document.getElementById('driverDetailsHeader').addEventListener('click', toggleDriverDetails);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }
        
        // Initialize advanced features
        function initializeAdvancedFeatures() {
            // Initialize performance stats
            updatePerformanceStats();
            
            // Initialize ride queue
            initializeRideQueue();
            
            // Set up periodic updates
            setInterval(updatePerformanceStats, 30000); // Update every 30 seconds
            setInterval(checkForRideQueue, 15000); // Check for queue every 15 seconds
        }
        
        // Update performance statistics
        function updatePerformanceStats() {
            if (currentUser) {
                // In a real app, this would fetch actual data from Firebase
                // For demo purposes, we'll use simulated data
                document.getElementById('totalTrips').textContent = Math.floor(Math.random() * 100) + 50;
                document.getElementById('ratingScore').textContent = (4 + Math.random()).toFixed(1);
                document.getElementById('onlineTime').textContent = Math.floor(Math.random() * 10) + 1 + 'h';
                document.getElementById('acceptanceRate').textContent = Math.floor(Math.random() * 30) + 70 + '%';
            }
        }
        
        // Initialize ride queue
        function initializeRideQueue() {
            // In a real app, this would fetch actual queue data from Firebase
            // For demo purposes, we'll simulate a queue
            rideQueue = [
                {
                    id: 'queue1',
                    pickup: '123 Main Street',
                    time: '5 min away',
                    fare: 'K15.00'
                },
                {
                    id: 'queue2',
                    pickup: '456 Oak Avenue',
                    time: '8 min away',
                    fare: 'K18.50'
                }
            ];
            
            updateRideQueueDisplay();
        }
        
        // Update ride queue display
        function updateRideQueueDisplay() {
            const queueList = document.getElementById('queueList');
            queueList.innerHTML = '';
            
            if (rideQueue.length > 0) {
                rideQueue.forEach(ride => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';
                    queueItem.innerHTML = `
                        <div class="queue-info">
                            <div class="queue-location">${ride.pickup}</div>
                            <div class="queue-time">${ride.time} â€¢ ${ride.fare}</div>
                        </div>
                        <button class="queue-action" data-id="${ride.id}">Accept</button>
                    `;
                    queueList.appendChild(queueItem);
                });
                
                // Show queue section
                document.getElementById('rideQueue').style.display = 'block';
                
                // Add event listeners to queue actions
                document.querySelectorAll('.queue-action').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const rideId = this.getAttribute('data-id');
                        acceptRideFromQueue(rideId);
                    });
                });
            } else {
                document.getElementById('rideQueue').style.display = 'none';
            }
        }
        
        // Accept ride from queue
        function acceptRideFromQueue(rideId) {
            // In a real app, this would update the ride status in Firebase
            showNotification(`Ride ${rideId} accepted from queue`);
            
            // Remove from queue
            rideQueue = rideQueue.filter(ride => ride.id !== rideId);
            updateRideQueueDisplay();
        }
        
        // Check for ride queue updates
        function checkForRideQueue() {
            if (isOnline && !currentRide) {
                // In a real app, this would check Firebase for new queue items
                // For demo, we'll randomly add items occasionally
                if (Math.random() > 0.7 && rideQueue.length < 3) {
                    const newRide = {
                        id: 'queue' + Date.now(),
                        pickup: '789 New Street',
                        time: '7 min away',
                        fare: 'K' + (12 + Math.floor(Math.random() * 10)).toFixed(2)
                    };
                    rideQueue.push(newRide);
                    updateRideQueueDisplay();
                    showNotification('New ride added to queue');
                }
            }
        }
        
        // Toggle panel collapse
        function togglePanelCollapse() {
            const panel = document.getElementById('driverPanel');
            panel.classList.toggle('collapsed');
        }
        
        // Toggle driver details
        function toggleDriverDetails() {
            const content = document.getElementById('driverDetailsContent');
            const icon = document.getElementById('driverDetailsIcon');
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }
        
        // Toggle map type
        function toggleMapType() {
            // Remove current tile layer
            driverMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    driverMap.removeLayer(layer);
                }
            });
            
            // Add new tile layer based on current map type
            if (mapType === 'standard') {
                // Switch to satellite
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenTopoMap contributors'
                }).addTo(driverMap);
                mapType = 'satellite';
                showNotification('Switched to satellite view');
            } else {
                // Switch back to standard
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(driverMap);
                mapType = 'standard';
                showNotification('Switched to standard view');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeToggle.style.background = '#333';
                darkModeToggle.style.color = '#ffcc00';
                showNotification('Dark mode enabled');
            } else {
                body.style.backgroundColor = '';
                body.style.color = '';
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeToggle.style.background = '';
                darkModeToggle.style.color = '';
                showNotification('Dark mode disabled');
            }
        }
        
        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundControl = document.getElementById('soundControl');
            
            if (soundEnabled) {
                soundControl.innerHTML = '<i class="fas fa-volume-up"></i>';
                soundControl.style.background = '';
                soundControl.style.color = '';
                showNotification('Sound enabled');
            } else {
                soundControl.innerHTML = '<i class="fas fa-volume-mute"></i>';
                soundControl.style.background = '#333';
                soundControl.style.color = '#ffcc00';
                showNotification('Sound disabled');
                
                // Stop any currently playing sound
                if (rideRequestSound && !rideRequestSound.paused) {
                    rideRequestSound.pause();
                    rideRequestSound.currentTime = 0;
                }
                if (rideRequestSoundInterval) {
                    clearInterval(rideRequestSoundInterval);
                    rideRequestSoundInterval = null;
                }
            }
        }
        
        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            // Show/hide floating elements based on screen
            const floatingElements = document.querySelectorAll('.floating-float, .online-toggle, .driver-status-indicator, .map-controls, .quick-actions, .dark-mode-toggle, .sound-control');
            
            if (screenId === 'home') {
                // Show floating elements on home screen
                floatingElements.forEach(el => {
                    el.style.display = 'flex';
                });
            } else {
                // Hide floating elements on other screens
                floatingElements.forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            // Load data for specific screens
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'earnings') {
                loadEarnings();
            } else if (screenId === 'account') {
                loadFloatHistory();
            }
        }
        
        // Toggle online status
        function toggleOnlineStatus() {
            isOnline = !isOnline;
            const onlineToggle = document.getElementById('onlineToggle');
            const onlineStatusText = document.getElementById('onlineStatusText');
            const statusIndicator = document.getElementById('driverStatusIndicator');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                // Check if float balance is sufficient
                if (floatBalance < 10) {
                    showNotification('Cannot go online. Your float balance is below minimum K10.00. Please add float.');
                    isOnline = false;
                    document.getElementById('onlineToggleCheckbox').checked = false;
                    return;
                }
                
                onlineToggle.classList.remove('offline');
                onlineToggle.classList.add('active');
                onlineStatusText.textContent = 'Online';
                
                // Show status indicator
                statusIndicator.style.display = 'flex';
                statusDot.classList.add('online');
                statusText.textContent = 'Online';
                
                // Start location tracking
                startLocationTracking();
                
                // Listen for ride requests
                listenForRideRequests();
                
                showNotification('You are now online and receiving ride requests.');
            } else {
                onlineToggle.classList.remove('active');
                onlineToggle.classList.add('offline');
                onlineStatusText.textContent = 'Offline';
                
                // Hide status indicator
                statusIndicator.style.display = 'none';
                statusDot.classList.remove('online');
                
                // Stop location tracking
                stopLocationTracking();
                
                showNotification('You are now offline.');
            }
            
            // Update driver status in Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    isOnline: isOnline,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Listen for ride requests
        function listenForRideRequests() {
            database.ref('rides').orderByChild('status').equalTo('requested').on('value', snapshot => {
                const rides = snapshot.val();
                if (rides) {
                    // Get the first available ride request that matches the driver's vehicle type
                    for (const rideId in rides) {
                        const ride = rides[rideId];
                        
                        // Check if ride type matches driver's vehicle type
                        if (ride.rideType === selectedVehicleType) {
                            // Show ride request popup
                            showRideRequest(rideId, ride);
                            break;
                        }
                    }
                }
            });
        }
        
        // Show ride request popup
        function showRideRequest(rideId, ride) {
            // Check if driver has accepted a ride already
            if (currentRide) {
                return; // Don't show new requests if driver is already on a ride
            }
            
            currentRideRequest = {
                id: rideId,
                ...ride
            };
            
            // Update popup content
            document.getElementById('customerName').textContent = ride.passengerName || 'Passenger';
            document.getElementById('customerPhone').textContent = ride.passengerPhone || 'N/A';
            document.getElementById('customerRating').textContent = ride.passengerRating || '4.8';
            document.getElementById('pickupLocation').textContent = ride.pickupLocation;
            document.getElementById('destinationLocation').textContent = ride.destination;
            document.getElementById('tripDistance').textContent = ride.distance ? `${ride.distance} km` : '5.2 km';
            document.getElementById('tripTime').textContent = ride.estimatedTime || '15 min';
            document.getElementById('surgeMultiplier').textContent = ride.surgeMultiplier || '1.0x';
            
            // Calculate and display fare details
            const baseFare = 15;
            const distanceFare = Math.max(0, (ride.distance ? parseFloat(ride.distance) * 5 : 5));
            const discount = ride.promoCode ? 2 : 0;
            const totalFare = baseFare + distanceFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('distanceFare').textContent = `K${distanceFare.toFixed(2)}`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
            
            // Update ride request map
            updateRideRequestMap(ride);
            
            // Generate waypoints
            generateWaypoints(ride);
            
            // Show popup
            document.getElementById('rideRequestPopup').style.display = 'flex';
            
            // Play sound continuously until driver responds
            if (soundEnabled) {
                playRideRequestSound();
            }
        }
        
        // Play ride request sound continuously
        function playRideRequestSound() {
            if (rideRequestSoundInterval) {
                clearInterval(rideRequestSoundInterval);
            }
            
            rideRequestSoundInterval = setInterval(() => {
                if (soundEnabled && document.getElementById('rideRequestPopup').style.display === 'flex') {
                    rideRequestSound.play().catch(e => {
                        console.log('Audio play failed:', e);
                    });
                }
            }, 3000); // Play every 3 seconds
        }
        
        // Stop ride request sound
        function stopRideRequestSound() {
            if (rideRequestSound && !rideRequestSound.paused) {
                rideRequestSound.pause();
                rideRequestSound.currentTime = 0;
            }
            if (rideRequestSoundInterval) {
                clearInterval(rideRequestSoundInterval);
                rideRequestSoundInterval = null;
            }
        }
        
        // Update ride request map
        function updateRideRequestMap(ride) {
            // Clear existing map
            rideRequestMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    rideRequestMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;">ðŸ“</div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Pickup</div>',
                    iconSize: [25, 40]
                })
            }).addTo(rideRequestMap).bindPopup('Pickup Location');
            
            // Add destination marker
            L.marker([ride.destLat, ride.destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;">ðŸ</div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Destination</div>',
                    iconSize: [25, 40]
                })
            }).addTo(rideRequestMap).bindPopup('Destination');
            
            // Draw route
            drawRouteOnRequestMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
            
            // Fit map to show both locations with padding
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            rideRequestMap.fitBounds(bounds, { padding: [20, 20] });
        }
        
        // Draw route on ride request map
        function drawRouteOnRequestMap(startLat, startLng, endLat, endLng) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(rideRequestMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(rideRequestMap);
                });
        }
        
        // Generate waypoints between driver and pickup
        function generateWaypoints(ride) {
            waypoints = [];
            const waypointsContainer = document.getElementById('waypointsContainer');
            waypointsContainer.innerHTML = '';
            
            // Simulate generating waypoints along the route
            // In a real app, you would get these from a routing service
            const sampleWaypoints = [
                "Turn left onto Independence Avenue",
                "Continue straight for 1.2 km",
                "Turn right onto Cairo Road",
                "Merge onto Great East Road",
                "Destination on your right"
            ];
            
            sampleWaypoints.forEach((waypoint, index) => {
                waypoints.push(waypoint);
                
                const waypointItem = document.createElement('div');
                waypointItem.className = 'waypoint-item';
                waypointItem.innerHTML = `
                    <div class="waypoint-icon">
                        <i class="fas fa-map-pin"></i>
                    </div>
                    <div class="waypoint-text">
                        ${waypoint}
                    </div>
                `;
                
                waypointsContainer.appendChild(waypointItem);
            });
        }
        
        // Accept a ride
        function acceptRide() {
            if (currentRideRequest && currentUser) {
                // Stop the ride request sound
                stopRideRequestSound();
                
                // Update ride with driver info
                database.ref('rides/' + currentRideRequest.id).update({
                    driverId: currentUser.uid,
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide = {
                        id: currentRideRequest.id,
                        ...currentRideRequest,
                        driverId: currentUser.uid,
                        status: 'accepted'
                    };
                    
                    // Hide ride request popup
                    document.getElementById('rideRequestPopup').style.display = 'none';
                    
                    // Update driver panel for active ride
                    updateDriverPanelForActiveRide();
                    
                    // Update map for active ride
                    updateMapForActiveRide();
                    
                    showNotification('Ride accepted successfully.');
                })
                .catch(error => {
                    console.error('Error accepting ride:', error);
                    showNotification('Error accepting ride. Please try again.');
                });
            }
        }
        
        // Reject a ride
        function rejectRide() {
            if (currentRideRequest) {
                // Stop the ride request sound
                stopRideRequestSound();
                
                // Hide ride request popup
                document.getElementById('rideRequestPopup').style.display = 'none';
                currentRideRequest = null;
                
                showNotification('Ride rejected.');
            }
        }
        
        // Update driver panel for active ride
        function updateDriverPanelForActiveRide() {
            if (currentRide) {
                // Update driver details with customer info
                document.getElementById('driverName').textContent = currentRide.passengerName || 'Passenger';
                document.getElementById('driverPhone').textContent = currentRide.passengerPhone || 'N/A';
                
                // Update vehicle details with trip info
                document.getElementById('vehicleDetails').textContent = `To: ${currentRide.destination}`;
                
                // Show ride action button
                document.getElementById('rideActionBtn').style.display = 'block';
                
                // Show advanced features
                document.getElementById('advancedFeatures').style.display = 'flex';
                
                // Update ride action button
                updateRideActionButton('hold-to-start');
                
                // Hide ride queue
                document.getElementById('rideQueue').style.display = 'none';
            }
        }
        
        // Update map for active ride
        function updateMapForActiveRide() {
            if (currentRide) {
                // Clear existing markers and routes
                if (customerMarker) {
                    driverMap.removeLayer(customerMarker);
                    customerMarker = null;
                }
                if (destinationMarker) {
                    driverMap.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routePolyline) {
                    driverMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
                
                // Add customer pickup marker
                customerMarker = L.marker([currentRide.pickupLat, currentRide.pickupLng], {
                    icon: L.divIcon({
                        className: 'customer-marker',
                        html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;">ðŸ“</div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Customer</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Customer Pickup Location');
                
                // Add destination marker
                destinationMarker = L.marker([currentRide.destLat, currentRide.destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;">ðŸ</div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Destination</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Destination');
                
                // Draw route from driver to customer
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.pickupLat, currentRide.pickupLng);
                }
                
                // Fit map to show driver, customer and destination with appropriate zoom
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    const customerLatLng = customerMarker.getLatLng();
                    
                    const bounds = L.latLngBounds(
                        [driverLatLng.lat, driverLatLng.lng],
                        [customerLatLng.lat, customerLatLng.lng]
                    );
                    
                    driverMap.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // Draw route on main map
        function drawRoute(startLat, startLng, endLat, endLng) {
            // Remove existing route if any
            if (routePolyline) {
                driverMap.removeLayer(routePolyline);
            }
            
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(driverMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(driverMap);
                });
        }
        
        // Update ride action button based on ride status
        function updateRideActionButton(action) {
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            // Reset hold progress
            holdProgress = 0;
            const holdButtonFill = document.getElementById('holdButtonFill');
            if (holdButtonFill) {
                holdButtonFill.style.width = '0%';
            }
            
            switch(action) {
                case 'hold-to-start':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-play-circle"></i>
                        <span>Hold to Start Ride</span>
                    `;
                    break;
                case 'hold-to-arrive':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Hold to Arrive</span>
                    `;
                    break;
                case 'hold-to-pickup':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-user-check"></i>
                        <span>Hold to Pickup</span>
                    `;
                    break;
                case 'hold-to-complete':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-flag-checkered"></i>
                        <span>Hold to Complete</span>
                    `;
                    break;
            }
        }
        
        // Start hold timer for ride actions
        function startHoldTimer() {
            if (holdTimer) return;
            
            // Add active class to change button text color to white
            const holdButtonContent = document.getElementById('holdButtonContent');
            holdButtonContent.classList.add('active');
            
            holdTimer = setInterval(() => {
                holdProgress += 3.33; // 3 seconds total = 100%
                const holdButtonFill = document.getElementById('holdButtonFill');
                
                if (holdButtonFill) {
                    holdButtonFill.style.width = `${holdProgress}%`;
                }
                
                if (holdProgress >= 100) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                    completeHoldAction();
                }
            }, 100);
        }
        
        // Cancel hold timer
        function cancelHoldTimer() {
            if (holdTimer) {
                clearInterval(holdTimer);
                holdTimer = null;
                holdProgress = 0;
                
                // Remove active class to revert button text color
                const holdButtonContent = document.getElementById('holdButtonContent');
                holdButtonContent.classList.remove('active');
                
                const holdButtonFill = document.getElementById('holdButtonFill');
                if (holdButtonFill) {
                    holdButtonFill.style.width = '0%';
                }
            }
        }
        
        // Complete hold action based on current ride state
        function completeHoldAction() {
            if (!currentRide) return;
            
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            if (holdButtonContent.innerHTML.includes('Start Ride')) {
                // Start the ride
                database.ref('rides/' + currentRide.id).update({
                    status: 'started',
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide.status = 'started';
                    updateRideActionButton('hold-to-arrive');
                    showNotification('Ride started. Heading to pickup location.');
                    
                    // Update map to show route from driver to destination
                    if (driverMarker) {
                        const driverLatLng = driverMarker.getLatLng();
                        drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.destLat, currentRide.destLng);
                    }
                });
            } else if (holdButtonContent.innerHTML.includes('Arrive')) {
                // Mark arrived
                database.ref('rides/' + currentRide.id).update({
                    status: 'arrived'
                })
                .then(() => {
                    currentRide.status = 'arrived';
                    updateRideActionButton('hold-to-pickup');
                    showNotification('Arrival marked. Waiting for passenger.');
                });
            } else if (holdButtonContent.innerHTML.includes('Pickup')) {
                // Mark pickup
                database.ref('rides/' + currentRide.id).update({
                    status: 'picked_up'
                })
                .then(() => {
                    currentRide.status = 'picked_up';
                    updateRideActionButton('hold-to-complete');
                    showNotification('Passenger picked up. Starting trip.');
                    
                    // Update driver details back to driver info
                    document.getElementById('driverName').textContent = document.getElementById('driverNameInput').value || 'Driver Name';
                    document.getElementById('driverPhone').textContent = document.getElementById('driverPhoneInput').value || '000-000-0000';
                    document.getElementById('vehicleDetails').textContent = 
                        `${document.getElementById('vehicleTypeInput').value || 'Vehicle'} - ${document.getElementById('licensePlateInput').value || 'ABC123'}`;
                });
            } else if (holdButtonContent.innerHTML.includes('Complete')) {
                // Complete ride
                database.ref('rides/' + currentRide.id).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    // Calculate commission and update balances
                    const totalFare = calculateTotalFare(currentRide);
                    const commission = totalFare * commissionRate;
                    const driverEarnings = totalFare - commission;
                    
                    // Update wallet balance (money earned from trip)
                    const newWalletBalance = walletBalance + driverEarnings;
                    updateWalletBalance(newWalletBalance);
                    
                    // Add to earnings
                    const earningsData = {
                        rideId: currentRide.id,
                        amount: driverEarnings,
                        commission: commission,
                        totalFare: totalFare,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('earnings/' + currentUser.uid).push(earningsData)
                        .then(() => {
                            // Show commission deduction notification
                            showNotification(`Ride completed! K${driverEarnings.toFixed(2)} added to your wallet. New wallet balance: K${newWalletBalance.toFixed(2)}`);
                            
                            // Reset driver panel
                            currentRide = null;
                            document.getElementById('rideActionBtn').style.display = 'none';
                            document.getElementById('advancedFeatures').style.display = 'none';
                            
                            // Clear map markers and routes
                            if (customerMarker) {
                                driverMap.removeLayer(customerMarker);
                                customerMarker = null;
                            }
                            if (destinationMarker) {
                                driverMap.removeLayer(destinationMarker);
                                destinationMarker = null;
                            }
                            if (routePolyline) {
                                driverMap.removeLayer(routePolyline);
                                routePolyline = null;
                            }
                            
                            // Show ride queue again
                            updateRideQueueDisplay();
                        });
                });
            }
        }
        
        // Calculate total fare for a ride
        function calculateTotalFare(ride) {
            const baseFare = 15;
            const distanceFare = Math.max(0, (ride.distance ? parseFloat(ride.distance) * 5 : 5));
            const discount = ride.promoCode ? 2 : 0;
            return baseFare + distanceFare - discount;
        }
        
        // Update float balance
        function updateFloatBalance(newBalance) {
            floatBalance = newBalance;
            
            // Update UI
            document.getElementById('floatBalanceDisplay').textContent = `K${floatBalance.toFixed(2)}`;
            document.getElementById('floatBalance').textContent = `K${floatBalance.toFixed(2)}`;
            
            // Save to Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    floatBalance: floatBalance
                });
            }
            
            // Check if balance is below minimum and show warning if needed
            if (floatBalance < 10) {
                showNoFloatWarning();
                
                // If driver is online, force them offline
                if (isOnline) {
                    document.getElementById('onlineToggleCheckbox').checked = false;
                    toggleOnlineStatus();
                }
            }
        }
        
        // Update wallet balance
        function updateWalletBalance(newBalance) {
            walletBalance = newBalance;
            
            // Update UI
            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
            
            // Save to Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: walletBalance
                });
            }
        }
        
        // Show no float warning
        function showNoFloatWarning() {
            // Check if warning already exists
            if (document.querySelector('.no-float-warning')) {
                return;
            }
            
            const warning = document.createElement('div');
            warning.className = 'no-float-warning';
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Your float balance is below minimum K10.00. You cannot receive ride requests until you add float.
            `;
            
            // Insert warning at the top of the account screen
            const accountScreen = document.getElementById('accountScreen');
            const firstChild = accountScreen.firstChild;
            accountScreen.insertBefore(warning, firstChild);
        }
        
        // Add float to account
        function addFloat() {
            const amount = prompt('Enter amount to add to your float (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = floatBalance + addAmount;
                
                // Update balance
                updateFloatBalance(newBalance);
                
                // Add float history entry
                addFloatHistoryEntry('deposit', addAmount, 'Float deposit');
                
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your float.`);
                
                // Remove warning if balance is now sufficient
                if (newBalance >= 10) {
                    const warning = document.querySelector('.no-float-warning');
                    if (warning) {
                        warning.remove();
                    }
                }
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Adjust float (withdraw)
        function adjustFloat() {
            if (floatBalance <= 0) {
                showNotification('Your float balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw from float (K). Available: K${floatBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > floatBalance) {
                    showNotification('Insufficient float balance for this withdrawal.');
                    return;
                }
                
                const newBalance = floatBalance - withdrawAmount;
                updateFloatBalance(newBalance);
                
                // Add float history entry
                addFloatHistoryEntry('withdrawal', -withdrawAmount, 'Float withdrawal');
                
                showNotification(`Float withdrawal of K${withdrawAmount.toFixed(2)} processed.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Add float history entry
        function addFloatHistoryEntry(type, amount, description) {
            const historyEntry = {
                type: type,
                amount: amount,
                description: description,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                balance: floatBalance
            };
            
            // Add to local array
            floatHistory.unshift(historyEntry);
            
            // Save to Firebase
            if (currentUser) {
                database.ref('floatHistory/' + currentUser.uid).push(historyEntry);
            }
            
            // Update UI
            updateFloatHistoryDisplay();
        }
        
        // Load float history
        function loadFloatHistory() {
            if (currentUser) {
                database.ref('floatHistory/' + currentUser.uid).orderByChild('timestamp').limitToLast(10).once('value')
                    .then(snapshot => {
                        const history = snapshot.val();
                        floatHistory = [];
                        
                        if (history) {
                            // Convert to array and sort by timestamp (newest first)
                            Object.keys(history).forEach(key => {
                                floatHistory.unshift({
                                    id: key,
                                    ...history[key]
                                });
                            });
                        }
                        
                        updateFloatHistoryDisplay();
                    })
                    .catch(error => {
                        console.error('Error loading float history:', error);
                    });
            }
        }
        
        // Update float history display
        function updateFloatHistoryDisplay() {
            const floatHistoryList = document.getElementById('floatHistoryList');
            floatHistoryList.innerHTML = '';
            
            if (floatHistory.length > 0) {
                floatHistory.forEach(entry => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'float-history-item';
                    
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const amountClass = entry.amount > 0 ? 'positive' : 'negative';
                    const amountSign = entry.amount > 0 ? '+' : '';
                    
                    historyItem.innerHTML = `
                        <div>
                            <div>${entry.description}</div>
                            <div style="font-size: 0.6rem; color: var(--medium-gray);">${formattedDate} ${formattedTime}</div>
                        </div>
                        <div class="float-amount ${amountClass}">${amountSign}K${Math.abs(entry.amount).toFixed(2)}</div>
                    `;
                    
                    floatHistoryList.appendChild(historyItem);
                });
            } else {
                floatHistoryList.innerHTML = '<p style="text-align: center; padding: 10px; color: var(--medium-gray);">No float history found.</p>';
            }
        }
        
        // Load driver data
        function loadDriverData() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            // Update form fields (readonly)
                            document.getElementById('driverNameInput').value = userData.name || '';
                            document.getElementById('driverPhoneInput').value = userData.phone || '';
                            document.getElementById('driverEmailInput').value = userData.email || '';
                            
                            // Update vehicle data (readonly)
                            if (userData.vehicle) {
                                selectedVehicleType = userData.vehicle.type;
                                document.getElementById('vehicleTypeInput').value = userData.vehicle.type || '';
                                document.getElementById('vehicleModelInput').value = userData.vehicle.model || '';
                                document.getElementById('licensePlateInput').value = userData.vehicle.licensePlate || '';
                                document.getElementById('vehicleColorInput').value = userData.vehicle.color || '';
                            }
                            
                            // Update display
                            document.getElementById('driverName').textContent = userData.name || 'Driver Name';
                            document.getElementById('driverPhone').textContent = userData.phone || '000-000-0000';
                            document.getElementById('vehicleDetails').textContent = 
                                `${userData.vehicle?.type || 'Vehicle'} - ${userData.vehicle?.licensePlate || 'ABC123'}`;
                            
                            // Update wallet and float balances
                            walletBalance = userData.walletBalance || 0;
                            floatBalance = userData.floatBalance || 0;
                            
                            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            document.getElementById('floatBalanceDisplay').textContent = `K${floatBalance.toFixed(2)}`;
                            document.getElementById('floatBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            
                            // Show warning if float balance is below minimum
                            if (floatBalance < 10) {
                                showNoFloatWarning();
                            }
                            
                            // Update driver avatar
                            updateDriverAvatar();
                            
                            // Set online status if previously online
                            if (userData.isOnline) {
                                document.getElementById('onlineToggleCheckbox').checked = true;
                                toggleOnlineStatus();
                            }
                        }
                    });
                
                // Load driver stats
                loadDriverStats();
                
                // Load float history
                loadFloatHistory();
            }
        }
        
        // Update driver avatar
        function updateDriverAvatar() {
            const driverAvatar = document.getElementById('driverAvatar');
            const driverName = document.getElementById('driverNameInput').value;
            
            if (driverName) {
                driverAvatar.innerHTML = driverName.charAt(0).toUpperCase();
            } else {
                driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // Add funds to wallet
        function addFunds() {
            const amount = prompt('Enter amount to add to your wallet (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = walletBalance + addAmount;
                
                // Update balance
                updateWalletBalance(newBalance);
                
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your wallet.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Withdraw funds from wallet
        function withdrawFunds() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawAmount;
                updateWalletBalance(newBalance);
                
                showNotification(`Withdrawal request submitted. K${withdrawAmount.toFixed(2)} will be processed within 24 hours.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Load driver statistics
        function loadDriverStats() {
            if (!currentUser) return;
            
            // Load completed rides count
            database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    let completed = 0;
                    let cancelled = 0;
                    let totalEarnings = 0;
                    
                    if (rides) {
                        Object.values(rides).forEach(ride => {
                            if (ride.status === 'completed') {
                                completed++;
                                totalEarnings += ride.fare || 0;
                            } else if (ride.status === 'cancelled') {
                                cancelled++;
                            }
                        });
                    }
                    
                    document.getElementById('completedRides').textContent = completed;
                    document.getElementById('cancelledRides').textContent = cancelled;
                    document.getElementById('totalEarnings').textContent = `K${totalEarnings.toFixed(2)}`;
                });
        }
        
        // Load ride history with enhanced details
        function loadRideHistory() {
            if (currentUser) {
                database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                    .then(snapshot => {
                        const historyList = document.getElementById('historyList');
                        historyList.innerHTML = '';
                        
                        const rides = snapshot.val();
                        if (rides) {
                            // Convert to array and sort by timestamp (newest first)
                            const ridesArray = Object.keys(rides).map(rideId => ({
                                id: rideId,
                                ...rides[rideId]
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            
                            ridesArray.forEach(ride => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                
                                const date = new Date(ride.timestamp);
                                const formattedDate = date.toLocaleDateString();
                                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                historyItem.innerHTML = `
                                    <div class="history-locations">
                                        <div>
                                            <strong>From:</strong> ${ride.pickupLocation}
                                        </div>
                                        <div>
                                            <strong>To:</strong> ${ride.destination}
                                        </div>
                                    </div>
                                    <div class="history-details-grid">
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Customer</span>
                                            <span class="history-detail-value">${ride.passengerName || 'N/A'}</span>
                                        </div>
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Phone</span>
                                            <span class="history-detail-value">${ride.passengerPhone || 'N/A'}</span>
                                        </div>
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Date</span>
                                            <span class="history-detail-value">${formattedDate}</span>
                                        </div>
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Time</span>
                                            <span class="history-detail-value">${formattedTime}</span>
                                        </div>
                                    </div>
                                    <div class="history-info">
                                        <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                        <div class="status-badge ${ride.status === 'completed' ? 'status-completed' : 'status-cancelled'}">
                                            ${ride.status === 'completed' ? 'Completed' : 'Cancelled'}
                                        </div>
                                    </div>
                                `;
                                
                                historyList.appendChild(historyItem);
                            });
                        } else {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ride history:', error);
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                    });
            }
        }
        
        // Load earnings
        function loadEarnings() {
            if (currentUser) {
                database.ref('earnings/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const earnings = snapshot.val();
                        let total = 0;
                        let ridesCompleted = 0;
                        let onlineHours = 0;
                        let totalCommission = 0;
                        
                        if (earnings) {
                            const now = new Date();
                            
                            Object.keys(earnings).forEach(earningId => {
                                const earning = earnings[earningId];
                                const earningDate = new Date(earning.timestamp);
                                
                                let include = false;
                                
                                switch(earningsPeriod) {
                                    case 'today':
                                        if (earningDate.toDateString() === now.toDateString()) {
                                            include = true;
                                        }
                                        break;
                                    case 'week':
                                        const startOfWeek = new Date(now);
                                        startOfWeek.setDate(now.getDate() - now.getDay());
                                        startOfWeek.setHours(0, 0, 0, 0);
                                        
                                        if (earningDate >= startOfWeek) {
                                            include = true;
                                        }
                                        break;
                                    case 'month':
                                        if (earningDate.getMonth() === now.getMonth() && 
                                            earningDate.getFullYear() === now.getFullYear()) {
                                            include = true;
                                        }
                                        break;
                                }
                                
                                if (include) {
                                    total += earning.amount || 0;
                                    totalCommission += earning.commission || 0;
                                    ridesCompleted++;
                                }
                            });
                            
                            // Calculate online hours (simplified)
                            onlineHours = Math.round(ridesCompleted * 0.75); // Assuming 45 minutes per ride on average
                        }
                        
                        document.getElementById('earningsTotal').textContent = `K${total.toFixed(2)}`;
                        document.getElementById('ridesCompleted').textContent = ridesCompleted;
                        document.getElementById('avgEarning').textContent = ridesCompleted > 0 ? `K${(total / ridesCompleted).toFixed(2)}` : 'K0.00';
                        document.getElementById('onlineHours').textContent = `${onlineHours}h`;
                        
                        // Update earnings list with commission information
                        updateEarningsList(earnings);
                    })
                    .catch(error => {
                        console.error('Error loading earnings:', error);
                        document.getElementById('earningsTotal').textContent = 'K0.00';
                        document.getElementById('ridesCompleted').textContent = '0';
                        document.getElementById('avgEarning').textContent = 'K0.00';
                        document.getElementById('onlineHours').textContent = '0h';
                    });
            }
        }
        
        // Update earnings list
        function updateEarningsList(earnings) {
            const earningsList = document.getElementById('earningsList');
            earningsList.innerHTML = '';
            
            if (earnings) {
                // Convert to array and sort by timestamp (newest first)
                const earningsArray = Object.keys(earnings).map(earningId => ({
                    id: earningId,
                    ...earnings[earningId]
                })).sort((a, b) => b.timestamp - a.timestamp)
                  .slice(0, 10); // Show only last 10 earnings
                
                earningsArray.forEach(earning => {
                    const earningItem = document.createElement('div');
                    earningItem.className = 'history-item';
                    
                    const date = new Date(earning.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    earningItem.innerHTML = `
                        <div class="history-locations">
                            <div>
                                <strong>Ride Earnings</strong>
                            </div>
                            <div>
                                <strong>K${earning.amount ? earning.amount.toFixed(2) : '0.00'}</strong>
                            </div>
                        </div>
                        <div class="commission-display">
                            <span class="commission-label">Commission (8%):</span>
                            <span class="commission-value commission-deduction">-K${earning.commission ? earning.commission.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="balance-update">
                            <span class="balance-label-update">Total Fare:</span>
                            <span class="balance-value-update">K${earning.totalFare ? earning.totalFare.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="history-info">
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge status-completed">Completed</div>
                        </div>
                    `;
                    
                    earningsList.appendChild(earningItem);
                });
            } else {
                earningsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No earnings found for this period.</p>';
            }
        }
        
        // Withdraw earnings
        function withdrawEarnings() {
            showNotification('Withdrawal request submitted. Funds will be processed within 24 hours.');
        }
        
        // Advanced features
        
        // Navigate to pickup
        function navigateToPickup() {
            if (currentRide && customerMarker) {
                const customerLatLng = customerMarker.getLatLng();
                // In a real app, this would open the device's navigation app
                showNotification(`Opening navigation to pickup location: ${currentRide.pickupLocation}`);
                
                // For demo purposes, we'll just center the map on the pickup location
                driverMap.setView(customerLatLng, 16);
            }
        }
        
        // Contact customer
        function contactCustomer() {
            if (currentRide) {
                const phoneNumber = currentRide.passengerPhone;
                if (phoneNumber) {
                    // In a real app, this would initiate a phone call
                    showNotification(`Calling customer: ${phoneNumber}`);
                } else {
                    showNotification('Customer phone number not available.');
                }
            }
        }
        
        // View route details
        function viewRouteDetails() {
            if (currentRide) {
                // In a real app, this would show detailed route information
                showNotification(`Showing route details for trip to ${currentRide.destination}`);
            }
        }
        
        // Quick actions
        
        // Center map on driver location
        function centerMap() {
            if (driverMarker) {
                const driverLatLng = driverMarker.getLatLng();
                driverMap.setView(driverLatLng, 16);
                showNotification('Map centered on your location');
            }
        }
        
        // Refresh driver position
        function refreshDriverPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 16);
                    
                    // Update driver marker position
                    if (driverMarker) {
                        driverMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                    
                    showNotification('Location refreshed');
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to refresh location. Please enable location services.');
                });
            }
        }
        
        // Toggle traffic layer
        function toggleTraffic() {
            if (trafficEnabled) {
                // Remove traffic layer
                if (trafficLayer) {
                    driverMap.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
                trafficEnabled = false;
                showNotification('Traffic layer disabled');
            } else {
                // Add traffic layer (using OpenStreetMap traffic tiles as an example)
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(driverMap);
                trafficEnabled = true;
                showNotification('Traffic layer enabled');
            }
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                auth.signOut().then(() => {
                    showNotification('Logged out successfully');
                    // Reset app state
                    currentUser = null;
                    currentRide = null;
                    isOnline = false;
                    floatBalance = 0;
                    walletBalance = 0;
                    
                    // Stop location tracking
                    stopLocationTracking();
                    
                    // Stop any playing sounds
                    stopRideRequestSound();
                    
                    // Reset UI
                    document.getElementById('mainApp').style.display = 'none';
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    
                    // Clear any active screens
                    document.querySelectorAll('.screen-content').forEach(screen => {
                        screen.classList.remove('active');
                    });
                    
                    // Reset navigation buttons
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector('.nav-btn[data-screen="home"]').classList.add('active');
                }).catch((error) => {
                    console.error('Logout error:', error);
                    showNotification('Error logging out');
                });
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>) and see how it submits driver registrations details and other details to firebase then use that path to retrieve and populate driver stuff on the admin 
on driver i need to see if the driver is online number of trips canceled trips pending in a ride and completed trips , i need to see driver float and float history driver wallet how many and other driver stuff 

look at passenger html (<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Passenger</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.9rem;
        }
        
        .passenger-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .passenger-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 10px;
            cursor: pointer;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.9rem;
        }
        
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .location-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            position: relative;
        }
        
        .location-input i {
            color: var(--primary-orange);
        }
        
        .location-input input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.9rem;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 10px 5px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .vehicle-price {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .promo-section {
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed var(--border-color);
            border-radius: var(--element-radius);
            display: none;
        }
        
        .promo-section.active {
            display: block;
        }
        
        .promo-input {
            display: flex;
            gap: 8px;
        }
        
        .promo-input input {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
        }
        
        .btn-promo {
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .promo-toggle {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .fare-display {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 10px 0;
            box-shadow: var(--shadow-medium);
        }
        
        .fare-amount {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 5px 0;
        }
        
        .eta-display {
            font-size: 1rem;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .request-ride-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 10px;
            box-shadow: var(--shadow-medium);
        }
        
        .request-ride-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .ride-info-panel {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .trip-details {
            margin-bottom: 12px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            padding-top: 6px;
            margin-top: 6px;
        }
        
        .ride-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-cancel {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-contact {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 50px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .back-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        
        .screen-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .payments-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .balance-label {
            font-size: 0.75rem;
            margin-bottom: 3px;
        }
        
        .balance-amount-large {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 8px;
            font-size: 0.75rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-methods {
            margin-top: 12px;
        }
        
        .payment-method {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-method.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }
        
        .payment-details {
            flex: 1;
        }
        
        .payment-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .payment-info {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .pickup-marker {
            background: var(--primary-orange);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .destination-marker {
            background: var(--primary-red);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .current-location-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .quick-actions {
            position: fixed;
            bottom: 50px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .map-controls {
            position: fixed;
            top: 60px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .dark-mode-toggle {
            position: fixed;
            bottom: 50px;
            left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            z-index: 100;
        }
        
        .ride-status {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.8rem;
            display: none;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.searching {
            background: var(--warning-yellow);
            animation: pulse 2s infinite;
        }
        
        .status-dot.arriving {
            background: var(--info-blue);
            animation: pulse 1.5s infinite;
        }
        
        .status-dot.riding {
            background: var(--success-green);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .estimated-time {
            position: fixed;
            top: 60px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--border-color);
            font-size: 0.8rem;
            display: none;
        }
        
        .saved-locations {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }
        
        .saved-location-btn {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            font-size: 0.7rem;
            transition: all var(--transition-speed) ease;
        }
        
        .saved-location-btn:hover {
            background: var(--light-orange);
            border-color: var(--primary-orange);
        }
        
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 200;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .suggestion-item:hover {
            background: var(--light-orange);
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }
        
        .suggestion-details {
            flex: 1;
        }
        
        .suggestion-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .suggestion-address {
            color: var(--medium-gray);
            font-size: 0.7rem;
        }
        
        .suggestion-distance {
            color: var(--medium-gray);
            font-size: 0.6rem;
            margin-top: 2px;
        }
        
        .loading-text {
            text-align: center;
            padding: 20px;
            color: var(--medium-gray);
        }
        
        .no-places {
            text-align: center;
            padding: 20px;
            color: var(--medium-gray);
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .filter-options select, .filter-options input {
            flex: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--light-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .referral-section {
            background: var(--light-orange);
            padding: 15px;
            border-radius: var(--element-radius);
            margin-bottom: 15px;
        }
        
        .referral-code {
            background: var(--white);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
            margin: 10px 0;
        }
        
        .code {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .description {
            font-size: 0.7rem;
            color: var(--medium-gray);
            margin-top: 5px;
        }
        
        .contact-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .contact-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }
        
        .contact-btn.phone {
            background: var(--info-blue);
            color: white;
        }
        
        .rating-stars {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .star {
            font-size: 1.5rem;
            color: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .star.active {
            color: var(--warning-yellow);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .popup-overlay.hidden {
            display: none;
        }
        
        .popup-form {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .large-popup {
            max-width: 800px;
        }
        
        .popup-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .popup-title {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .popup-content {
            padding: 15px;
        }
        
        .popup-map-container {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .popup-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .detail-value {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .driver-details-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .popup-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        /* Payment Selection Popup Styles */
        .payment-selection-popup {
            max-width: 400px;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .payment-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .payment-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--medium-gray);
        }
        
        .payment-option.selected .payment-option-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .payment-option-details {
            flex: 1;
        }
        
        .payment-option-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .payment-option-description {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .payment-option-balance {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .confirm-payment-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 15px;
        }
        
        .confirm-payment-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .insufficient-balance {
            color: var(--error-red);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .ride-status {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .passenger-panel {
                padding: 10px;
            }
            
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 6px 3px;
                font-size: 0.6rem;
            }
            
            .quick-actions {
                bottom: 50px;
                right: 10px;
            }
            
            .quick-action-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .dark-mode-toggle {
                bottom: 50px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Main App -->
    <div id="mainApp">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance (Only on Home Screen) -->
        <div class="floating-balance home-only">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Ride Status (Only on Home Screen) -->
        <div class="ride-status home-only" id="rideStatus">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Searching for driver</span>
        </div>
        
        <!-- Estimated Time (Only on Home Screen) -->
        <div class="estimated-time home-only" id="estimatedTime">
            <i class="fas fa-clock"></i>
            <span id="timeText">5 min</span>
        </div>
        
        <!-- Map Controls (Only on Home Screen) -->
        <div class="map-controls home-only">
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="mapTypeBtn" title="Change Map Type">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- Quick Actions (Only on Home Screen) -->
        <div class="quick-actions home-only">
            <button class="quick-action-btn" id="centerMapBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="quick-action-btn" id="refreshLocationBtn" title="Refresh Location">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn" id="toggleTrafficBtn" title="Toggle Traffic">
                <i class="fas fa-traffic-light"></i>
            </button>
        </div>
        
        <!-- Dark Mode Toggle (Only on Home Screen) -->
        <button class="dark-mode-toggle home-only" id="darkModeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Passenger Panel -->
        <div class="passenger-panel" id="passengerPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Payments</span>
                </button>
            </div>
            
            <!-- Home Screen Content -->
            <div id="homeScreenContent">
                <!-- Ride Request Form -->
                <div class="ride-request-form" id="rideRequestForm">
                    <div class="location-input">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="pickupLocation" placeholder="Current location" readonly>
                    </div>
                    <div class="location-input">
                        <i class="fas fa-flag"></i>
                        <input type="text" id="destinationLocation" placeholder="Where to?">
                        <div class="suggestion-list" id="destinationSuggestions"></div>
                    </div>
                    
                    <div class="saved-locations">
                        <button class="saved-location-btn" data-address="home">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="saved-location-btn" data-address="work">
                            <i class="fas fa-briefcase"></i>
                            Work
                        </button>
                    </div>
                    
                    <div class="vehicle-selection">
                        <div class="vehicle-option selected" data-type="car">
                            <i class="fas fa-car vehicle-icon"></i>
                            <span class="vehicle-name">Ride</span>
                            <span class="vehicle-price">K15.00</span>
                        </div>
                        <div class="vehicle-option" data-type="bike">
                            <i class="fas fa-motorcycle vehicle-icon"></i>
                            <span class="vehicle-name">Delivery</span>
                            <span class="vehicle-price">K10.00</span>
                        </div>
                        <div class="vehicle-option" data-type="bicycle">
                            <i class="fas fa-bicycle vehicle-icon"></i>
                            <span class="vehicle-name">Short Delivery</span>
                            <span class="vehicle-price">K5.00</span>
                        </div>
                    </div>
                    
                    <button class="promo-toggle" id="promoToggle">
                        <i class="fas fa-tag"></i>
                        Apply Promo Coupon
                    </button>
                    
                    <div class="promo-section" id="promoSection">
                        <div class="promo-input">
                            <input type="text" id="promoCode" placeholder="Promo code">
                            <button class="btn-promo" id="applyPromoBtn">Apply</button>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Estimated Fare</p>
                        <div class="fare-amount" id="estimatedFare">K0.00</div>
                        <p class="eta-display" id="etaDisplay">ETA: -- min</p>
                    </div>
                    
                    <button class="request-ride-btn" id="requestRideBtn">Request Ride</button>
                </div>
                
                <!-- Ride Info Panel (Hidden initially) -->
                <div class="ride-info-panel" id="rideInfoPanel">
                    <div class="driver-info">
                        <div class="driver-avatar" id="driverAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="driver-details">
                            <h2 id="driverName">Driver Name</h2>
                            <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                            <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                            <p><i class="fas fa-star"></i> <span id="driverRating">4.5 â˜…</span></p>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="currentPickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="currentDestinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-actions">
                        <button class="btn btn-cancel" id="cancelRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Cancel Ride
                        </button>
                        <button class="btn btn-contact" id="contactDriverBtn">
                            <i class="fas fa-phone"></i>
                            Contact Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <div class="account-header">
                    <div class="driver-avatar" id="accountAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="driver-details">
                        <h2 id="accountName">Passenger</h2>
                        <p><i class="fas fa-phone"></i> <span id="accountPhone">Not set</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="accountEmail">Not set</span></p>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCompleted">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesCancelled">0</div>
                        <div class="stat-label">Cancelled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ridesPending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <h3 class="section-title">
                        <i class="fas fa-share-alt"></i>
                        Refer & Earn
                    </h3>
                    <p>Share your code and get K50 when friends join</p>
                    <div class="referral-code">
                        <div class="code" id="referralCode">JUBEL-XXXX</div>
                        <div class="description">20% discount for new users</div>
                    </div>
                    <button class="btn btn-primary" id="shareReferralBtn">
                        <i class="fas fa-share"></i>
                        Share Referral Code
                    </button>
                </div>
                
                <div class="wallet-section">
                    <h3 class="section-title">
                        <i class="fas fa-wallet"></i>
                        Jubel Wallet
                    </h3>
                    <div class="wallet-balance">
                        <div class="balance-label">Current Balance</div>
                        <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn-wallet" id="depositBtn">
                            <i class="fas fa-plus"></i>
                            Deposit
                        </button>
                        <button class="btn-wallet" id="withdrawBtn">
                            <i class="fas fa-minus"></i>
                            Withdraw
                        </button>
                    </div>
                </div>
                
                <div class="contact-section">
                    <button class="contact-btn whatsapp" id="whatsappBtn">
                        <i class="fab fa-whatsapp"></i>
                        WhatsApp
                    </button>
                    <button class="contact-btn phone" id="callBtn">
                        <i class="fas fa-phone"></i>
                        Call Us
                    </button>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="filter-options">
                <select id="historyFilter" class="input-field">
                    <option value="all">All Rides</option>
                    <option value="requested">Awaiting Driver</option>
                    <option value="accepted">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" id="historyDate" class="input-field">
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <div class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading ride history...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="paymentsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Payment Methods</h2>
            </div>
            
            <div class="payments-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i>
                    Payment Methods
                </h3>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="airtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Airtel Money</div>
                            <div class="payment-info">Pay with Airtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="mtn">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">MTN Money</div>
                            <div class="payment-info">Pay with MTN Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="zamtel">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Zamtel Money</div>
                            <div class="payment-info">Pay with Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="card">
                        <div class="payment-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-info">Visa, Mastercard</div>
                        </div>
                    </div>
                    
                    <div class="payment-method" data-method="cash">
                        <div class="payment-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-details">
                            <div class="payment-name">Cash</div>
                            <div class="payment-info">Pay with cash</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="addPaymentMethodBtn">
                    <i class="fas fa-plus"></i>
                    Add Payment Method
                </button>
            </div>
        </div>
    </div>
    
    <!-- Payment Selection Popup -->
    <div id="paymentSelectionPopup" class="popup-overlay hidden">
        <div class="popup-form payment-selection-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-credit-card"></i>
                    Select Payment Method
                </h2>
                <button class="close-popup" id="closePaymentPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="payment-options">
                    <div class="payment-option selected" data-payment-type="wallet">
                        <div class="payment-option-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Jubel Wallet</div>
                            <div class="payment-option-description">Pay with your Jubel wallet balance</div>
                            <div class="payment-option-balance" id="paymentWalletBalance">Balance: K0.00</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="mobile">
                        <div class="payment-option-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Mobile Money</div>
                            <div class="payment-option-description">Pay with Airtel, MTN or Zamtel Money</div>
                        </div>
                    </div>
                    
                    <div class="payment-option" data-payment-type="cash">
                        <div class="payment-option-icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <div class="payment-option-details">
                            <div class="payment-option-name">Cash on Delivery</div>
                            <div class="payment-option-description">Pay with cash when you arrive</div>
                        </div>
                    </div>
                </div>
                
                <div class="insufficient-balance" id="insufficientBalance">
                    <i class="fas fa-exclamation-circle"></i>
                    Insufficient balance in your Jubel wallet
                </div>
                
                <button class="confirm-payment-btn" id="confirmPaymentBtn">
                    Confirm Payment & Request Ride
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ride Details Popup -->
    <div id="rideDetailsPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup">
            <div class="popup-header">
                <h2 class="popup-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h2>
                <button class="close-popup" id="closeRidePopupTop">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupRideMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupRidePickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="popupRideDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupRideFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupRideDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="popupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="popupRideStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="popupRideDate">Loading...</span>
                    </div>
                    
                    <!-- Driver Details Section -->
                    <div id="popupDriverDetails" class="driver-details-section hidden">
                        <h3 class="section-title">Driver Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Driver Name:</span>
                            <span class="detail-value" id="popupDriverName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="popupDriverPhone">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value" id="popupDriverVehicle">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Rating:</span>
                            <span class="detail-value" id="popupDriverRating">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Progress:</span>
                            <span class="detail-value" id="popupDriverProgress">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeRidePopup">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let passengerMap;
        let popupRideMap;
        let locationWatchId = null;
        let currentLocationMarker = null;
        let pickupMarker = null;
        let destinationMarker = null;
        let driverMarker = null;
        let routePolyline = null;
        let selectedVehicleType = 'car';
        let walletBalance = 0;
        let isDarkMode = false;
        let trafficLayer = null;
        let trafficEnabled = false;
        let mapType = 'standard';
        let userFullName = "Passenger";
        let driverAssignmentListener = null;
        let rideHistoryListener = null;
        let activeRideListener = null;
        let appliedPromoCode = null;
        let userStats = {
            completed: 0,
            cancelled: 0,
            pending: 0
        };
        let paymentMethod = 'airtel';
        let userRating = 0;
        let userLocation = null;
        let destinationSearchResults = [];
        let selectedDestination = null;
        let driverLocationListener = null;
        let userData = null;
        let selectedPaymentType = 'wallet';
        let rideFare = 0;
        let currentCity = "Lusaka"; // Default city, will be updated based on user location
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
        });
        
        // Authentication functions
        function initializeAuth() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const uid = urlParams.get('uid');
            
            if (email && uid) {
                // User is coming from signup page
                loadUserData(uid);
            } else {
                // Check if user is already logged in
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        loadUserData(user.uid);
                    } else {
                        // Redirect to signup page
                        window.location.href = 'signup.html';
                    }
                });
            }
        }
        
        // Load user data from Firebase
        function loadUserData(uid) {
            database.ref('users/' + uid).once('value')
                .then(snapshot => {
                    userData = snapshot.val();
                    if (userData) {
                        currentUser = {
                            uid: uid,
                            email: userData.email,
                            displayName: userData.name
                        };
                        
                        // Initialize the app with user data
                        initializeMap();
                        setupEventListeners();
                        loadPassengerData();
                        
                        // Update UI with user data
                        document.getElementById('accountName').textContent = userData.name || 'Passenger';
                        document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                        document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                        document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                        
                        // Update wallet balance
                        walletBalance = userData.walletBalance || 0;
                        document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                        document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
                        
                        showNotification('Welcome back to Jubel!');
                    } else {
                        showNotification('User data not found. Please sign up again.');
                        setTimeout(() => {
                            window.location.href = 'signup.html';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error loading user data:', error);
                    showNotification('Error loading user data. Please try again.');
                });
        }
        
        // Map initialization
        function initializeMap() {
            // Main passenger map
            passengerMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            
            // Use a clean map style
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(passengerMap);
            
            // Popup ride details map
            popupRideMap = L.map('popupRideMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(popupRideMap);
            
            // Get passenger's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // Update map with current location
                    passengerMap.setView([lat, lng], 15);
                    popupRideMap.setView([lat, lng], 15);
                    
                    // Add marker for current location
                    currentLocationMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location-marker',
                            html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                            iconSize: [20, 20]
                        })
                    }).addTo(passengerMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Set pickup location to current location
                    updatePickupLocation(lat, lng);
                    
                    // Determine current city based on coordinates
                    determineCurrentCity(lat, lng);
                    
                    // Start location tracking
                    startLocationTracking();
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Determine current city based on coordinates
        function determineCurrentCity(lat, lng) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.address) {
                        // Try to get city, town, or village name
                        currentCity = data.address.city || data.address.town || data.address.village || data.address.county || "Lusaka";
                        console.log("Current city determined as:", currentCity);
                    }
                })
                .catch(error => {
                    console.error('Error determining city:', error);
                });
        }
        
        // Start continuous location tracking
        function startLocationTracking() {
            if (navigator.geolocation && currentUser) {
                navigator.geolocation.watchPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // Update user location in Firebase
                    database.ref('passengerLocations/' + currentUser.uid).set({
                        latitude: lat,
                        longitude: lng,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Update marker if it exists
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update destination marker if it exists and we have a destination
                    if (destinationMarker) {
                        const destination = document.getElementById('destinationLocation').value;
                        if (destination) {
                            updateFareEstimate();
                        }
                    }
                }, error => {
                    console.error('Location tracking error:', error);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 30000
                });
            }
        }
        
        // Update pickup location
        function updatePickupLocation(lat, lng) {
            // Update pickup marker
            if (pickupMarker) {
                passengerMap.removeLayer(pickupMarker);
            }
            
            pickupMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(passengerMap)
                .bindPopup('Pickup Location');
                
            // Update pickup location input with precise address
            reverseGeocode(lat, lng, 'pickupLocation');
        }
        
        // Reverse geocode coordinates to address with high precision
        function reverseGeocode(lat, lng, elementId) {
            // Using OpenStreetMap Nominatim API for reverse geocoding with high precision
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.display_name) {
                        // Extract precise address details
                        let preciseAddress = data.display_name;
                        
                        // Try to get house number or plot number if available
                        if (data.address) {
                            const houseNumber = data.address.house_number || data.address.housenumber;
                            const road = data.address.road;
                            const suburb = data.address.suburb;
                            const city = data.address.city || data.address.town || data.address.village;
                            
                            if (houseNumber && road) {
                                preciseAddress = `${houseNumber} ${road}`;
                                if (suburb) preciseAddress += `, ${suburb}`;
                                if (city) preciseAddress += `, ${city}`;
                            }
                        }
                        
                        document.getElementById(elementId).value = preciseAddress;
                    } else {
                        document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    }
                })
                .catch(error => {
                    console.error('Reverse geocoding error:', error);
                    document.getElementById(elementId).value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                });
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Vehicle selection
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.vehicle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update selected vehicle type
                    selectedVehicleType = this.getAttribute('data-type');
                    updateFareEstimate();
                });
            });
            
            // Payment method selection
            document.querySelectorAll('.payment-method').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    paymentMethod = this.getAttribute('data-method');
                });
            });
            
            // Payment option selection in popup
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectedPaymentType = this.getAttribute('data-payment-type');
                    
                    // Check if wallet balance is sufficient if wallet is selected
                    if (selectedPaymentType === 'wallet') {
                        if (walletBalance < rideFare) {
                            document.getElementById('insufficientBalance').style.display = 'block';
                            document.getElementById('confirmPaymentBtn').disabled = true;
                        } else {
                            document.getElementById('insufficientBalance').style.display = 'none';
                            document.getElementById('confirmPaymentBtn').disabled = false;
                        }
                    } else {
                        document.getElementById('insufficientBalance').style.display = 'none';
                        document.getElementById('confirmPaymentBtn').disabled = false;
                    }
                });
            });
            
            // Request ride button
            document.getElementById('requestRideBtn').addEventListener('click', showPaymentSelection);
            
            // Confirm payment button
            document.getElementById('confirmPaymentBtn').addEventListener('click', requestRide);
            
            // Close payment popup
            document.getElementById('closePaymentPopup').addEventListener('click', closePaymentSelection);
            
            // Cancel ride button
            document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
            
            // Contact driver button
            document.getElementById('contactDriverBtn').addEventListener('click', contactDriver);
            
            // Promo code toggle
            document.getElementById('promoToggle').addEventListener('click', function() {
                document.getElementById('promoSection').classList.toggle('active');
            });
            
            // Apply promo code
            document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);
            
            // Account actions
            document.getElementById('shareReferralBtn').addEventListener('click', shareReferralCode);
            document.getElementById('depositBtn').addEventListener('click', depositToWallet);
            document.getElementById('withdrawBtn').addEventListener('click', withdrawFromWallet);
            document.getElementById('whatsappBtn').addEventListener('click', contactWhatsApp);
            document.getElementById('callBtn').addEventListener('click', contactPhone);
            
            // Add payment method
            document.getElementById('addPaymentMethodBtn').addEventListener('click', addPaymentMethod);
            
            // Quick actions
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshPassengerPosition);
            document.getElementById('toggleTrafficBtn').addEventListener('click', toggleTraffic);
            
            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => passengerMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => passengerMap.zoomOut());
            document.getElementById('mapTypeBtn').addEventListener('click', toggleMapType);
            
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Panel collapse
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            // Destination input
            document.getElementById('destinationLocation').addEventListener('input', function() {
                const query = this.value;
                updateFareEstimate();
                if (query.length >= 2) {
                    searchPlaces(query);
                } else {
                    hideDestinationSuggestions();
                }
            });
            
            // Focus event for destination input
            document.getElementById('destinationLocation').addEventListener('focus', function() {
                const query = this.value;
                if (query.length >= 2) {
                    searchPlaces(query);
                }
            });
            
            // Click outside to hide suggestions
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.location-input') && !e.target.closest('.suggestion-list')) {
                    hideDestinationSuggestions();
                }
            });
            
            // Saved location buttons
            document.querySelectorAll('.saved-location-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressType = this.getAttribute('data-address');
                    useSavedLocation(addressType);
                });
            });
            
            // History filter
            document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
            document.getElementById('historyDate').addEventListener('change', loadRideHistory);
            
            // Ride history item click for popup
            document.addEventListener('click', function(e) {
                if (e.target.closest('.history-item')) {
                    const historyItem = e.target.closest('.history-item');
                    const rideId = historyItem.getAttribute('data-ride-id');
                    if (rideId) {
                        showRideDetailsPopup(rideId);
                    }
                }
            });
            
            // Close popup buttons
            document.getElementById('closeRidePopup').addEventListener('click', closeRideDetailsPopup);
            document.getElementById('closeRidePopupTop').addEventListener('click', closeRideDetailsPopup);
            
            // Star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    setRating(rating);
                });
            });
        }
        
        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            // Show/hide floating elements based on screen
            if (screenId === 'home') {
                document.querySelectorAll('.home-only').forEach(el => {
                    el.style.display = 'flex';
                });
            } else {
                document.querySelectorAll('.home-only').forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            // Load data for specific screens
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'account') {
                loadAccountData();
            }
        }
        
        // Toggle panel collapse
        function togglePanelCollapse() {
            const panel = document.getElementById('passengerPanel');
            panel.classList.toggle('collapsed');
        }
        
        // Toggle map type
        function toggleMapType() {
            // Remove current tile layer
            passengerMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    passengerMap.removeLayer(layer);
                }
            });
            
            // Add new tile layer based on current map type
            if (mapType === 'standard') {
                // Switch to satellite
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenTopoMap contributors'
                }).addTo(passengerMap);
                mapType = 'satellite';
                showNotification('Switched to satellite view');
            } else {
                // Switch back to standard
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(passengerMap);
                mapType = 'standard';
                showNotification('Switched to standard view');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeToggle.style.background = '#333';
                darkModeToggle.style.color = '#ffcc00';
                showNotification('Dark mode enabled');
            } else {
                body.style.backgroundColor = '';
                body.style.color = '';
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeToggle.style.background = '';
                darkModeToggle.style.color = '';
                showNotification('Dark mode disabled');
            }
        }
        
        // Use saved location
        function useSavedLocation(addressType) {
            if (userData) {
                const address = userData[addressType + 'Address'];
                
                if (address) {
                    document.getElementById('destinationLocation').value = address;
                    updateFareEstimate();
                    showNotification(`${addressType.charAt(0).toUpperCase() + addressType.slice(1)} address set as destination.`);
                    
                    // Try to geocode the saved address to show on map
                    forwardGeocode(address).then(results => {
                        if (results.length > 0) {
                            updateDestinationMarker(
                                parseFloat(results[0].lat),
                                parseFloat(results[0].lon),
                                address
                            );
                            
                            // Draw route from user location to destination
                            drawRoute(userLocation.lat, userLocation.lng, parseFloat(results[0].lat), parseFloat(results[0].lon));
                            
                            // Enable request ride button
                            document.getElementById('requestRideBtn').disabled = false;
                        }
                    });
                } else {
                    showNotification(`No ${addressType} address saved. Please add it in settings.`);
                }
            }
        }
        
        // Search places based on user input within the current city
        function searchPlaces(query) {
            if (!userLocation || !currentCity) return;
            
            const suggestionsContainer = document.getElementById('destinationSuggestions');
            suggestionsContainer.innerHTML = '<div class="loading-text">Searching places in ' + currentCity + '...</div>';
            suggestionsContainer.style.display = 'block';
            
            // Using Overpass API for place search within the current city
            const overpassQuery = `
                [out:json][timeout:25];
                (
                  node["name"~"${query}",i]["place"~"city|town|village|suburb",i](${currentCity});
                  node["name"~"${query}",i](area.search);
                  way["name"~"${query}",i](area.search);
                  relation["name"~"${query}",i](area.search);
                );
                out center;
            `;
            
            // First, get the area ID for the current city
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(currentCity)}&featuretype=city&limit=1`)
                .then(response => response.json())
                .then(cityData => {
                    if (cityData.length === 0) {
                        suggestionsContainer.innerHTML = '<div class="no-places">Could not determine current city. Please try again.</div>';
                        return;
                    }
                    
                    const city = cityData[0];
                    const cityBounds = {
                        south: parseFloat(city.boundingbox[0]),
                        north: parseFloat(city.boundingbox[1]),
                        west: parseFloat(city.boundingbox[2]),
                        east: parseFloat(city.boundingbox[3])
                    };
                    
                    // Search for places within the city bounds
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&bounded=1&viewbox=${cityBounds.west},${cityBounds.north},${cityBounds.east},${cityBounds.south}&limit=10`)
                        .then(response => response.json())
                        .then(data => {
                            suggestionsContainer.innerHTML = '';
                            destinationSearchResults = [];
                            
                            if (data && data.length > 0) {
                                // Process search results
                                const results = data
                                    .filter(place => place.display_name && place.lat && place.lon)
                                    .map(place => {
                                        // Calculate distance from user
                                        const distance = calculateDistance(
                                            userLocation.lat, userLocation.lng,
                                            parseFloat(place.lat), parseFloat(place.lon)
                                        );
                                        
                                        return {
                                            ...place,
                                            displayLat: parseFloat(place.lat),
                                            displayLon: parseFloat(place.lon),
                                            distance
                                        };
                                    })
                                    .sort((a, b) => a.distance - b.distance)
                                    .slice(0, 10);
                                
                                if (results.length === 0) {
                                    suggestionsContainer.innerHTML = '<div class="no-places">No places found matching your search in ' + currentCity + '</div>';
                                    return;
                                }
                                
                                destinationSearchResults = results;
                                
                                results.forEach(result => {
                                    const suggestionItem = document.createElement('div');
                                    suggestionItem.className = 'suggestion-item';
                                    
                                    // Determine place type and icon
                                    const placeType = getPlaceType(result);
                                    const placeIcon = getPlaceIcon(placeType);
                                    
                                    suggestionItem.innerHTML = `
                                        <div class="suggestion-icon">${placeIcon}</div>
                                        <div class="suggestion-details">
                                            <div class="suggestion-name">${result.display_name.split(',')[0]}</div>
                                            <div class="suggestion-address">${result.display_name.split(',').slice(1, 3).join(',')}</div>
                                            <div class="suggestion-distance">${(result.distance / 1000).toFixed(1)} km away</div>
                                        </div>
                                    `;
                                    
                                    suggestionItem.addEventListener('click', function() {
                                        document.getElementById('destinationLocation').value = result.display_name;
                                        suggestionsContainer.style.display = 'none';
                                        updateFareEstimate();
                                        
                                        // Update destination marker on map
                                        updateDestinationMarker(
                                            result.displayLat, 
                                            result.displayLon, 
                                            result.display_name
                                        );
                                        
                                        // Draw route from user location to destination
                                        drawRoute(userLocation.lat, userLocation.lng, result.displayLat, result.displayLon);
                                        
                                        selectedDestination = result;
                                        
                                        // Enable request ride button
                                        document.getElementById('requestRideBtn').disabled = false;
                                    });
                                    
                                    suggestionsContainer.appendChild(suggestionItem);
                                });
                            } else {
                                suggestionsContainer.innerHTML = '<div class="no-places">No places found matching your search in ' + currentCity + '</div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error searching places:', error);
                            suggestionsContainer.innerHTML = '<div class="no-places">Error searching places. Please try again.</div>';
                        });
                })
                .catch(error => {
                    console.error('Error getting city data:', error);
                    suggestionsContainer.innerHTML = '<div class="no-places">Error determining city. Please try again.</div>';
                });
        }
        
        // Get place type from search result
        function getPlaceType(place) {
            if (place.type === 'restaurant' || place.class === 'amenity' && place.type === 'restaurant') {
                return 'restaurant';
            } else if (place.type === 'cafe' || place.class === 'amenity' && place.type === 'cafe') {
                return 'cafe';
            } else if (place.type === 'bar' || place.class === 'amenity' && place.type === 'bar') {
                return 'bar';
            } else if (place.type === 'pub' || place.class === 'amenity' && place.type === 'pub') {
                return 'pub';
            } else if (place.type === 'fast_food' || place.class === 'amenity' && place.type === 'fast_food') {
                return 'fast_food';
            } else if (place.type === 'bank' || place.class === 'amenity' && place.type === 'bank') {
                return 'bank';
            } else if (place.type === 'atm' || place.class === 'amenity' && place.type === 'atm') {
                return 'atm';
            } else if (place.type === 'hospital' || place.class === 'amenity' && place.type === 'hospital') {
                return 'hospital';
            } else if (place.type === 'pharmacy' || place.class === 'amenity' && place.type === 'pharmacy') {
                return 'pharmacy';
            } else if (place.type === 'school' || place.class === 'amenity' && place.type === 'school') {
                return 'school';
            } else if (place.type === 'university' || place.class === 'amenity' && place.type === 'university') {
                return 'university';
            } else if (place.type === 'library' || place.class === 'amenity' && place.type === 'library') {
                return 'library';
            } else if (place.type === 'cinema' || place.class === 'amenity' && place.type === 'cinema') {
                return 'cinema';
            } else if (place.type === 'theatre' || place.class === 'amenity' && place.type === 'theatre') {
                return 'theatre';
            } else if (place.type === 'museum' || place.class === 'amenity' && place.type === 'museum') {
                return 'museum';
            } else if (place.type === 'hotel' || place.class === 'tourism' && place.type === 'hotel') {
                return 'hotel';
            } else if (place.type === 'supermarket' || place.class === 'shop' && place.type === 'supermarket') {
                return 'supermarket';
            } else if (place.type === 'mall' || place.class === 'shop' && place.type === 'mall') {
                return 'mall';
            } else if (place.type === 'clothes' || place.class === 'shop' && place.type === 'clothes') {
                return 'clothes';
            } else if (place.type === 'fuel' || place.class === 'amenity' && place.type === 'fuel') {
                return 'fuel';
            } else if (place.type === 'parking' || place.class === 'amenity' && place.type === 'parking') {
                return 'parking';
            } else if (place.type === 'bus_station' || place.class === 'amenity' && place.type === 'bus_station') {
                return 'bus_station';
            } else if (place.type === 'taxi' || place.class === 'amenity' && place.type === 'taxi') {
                return 'taxi';
            } else if (place.type === 'police' || place.class === 'amenity' && place.type === 'police') {
                return 'police';
            } else if (place.type === 'market' || place.class === 'amenity' && place.type === 'marketplace') {
                return 'market';
            } else if (place.type === 'post_office' || place.class === 'amenity' && place.type === 'post_office') {
                return 'post_office';
            } else if (place.type === 'place_of_worship' || place.class === 'amenity' && place.type === 'place_of_worship') {
                return 'place_of_worship';
            } else if (place.type === 'stadium' || place.class === 'leisure' && place.type === 'stadium') {
                return 'stadium';
            } else if (place.type === 'park' || place.class === 'leisure' && place.type === 'park') {
                return 'park';
            } else if (place.type === 'monument' || place.class === 'historic' && place.type === 'monument') {
                return 'monument';
            } else if (place.type === 'castle' || place.class === 'historic' && place.type === 'castle') {
                return 'castle';
            } else {
                return 'place';
            }
        }
        
        // Get icon for place type
        function getPlaceIcon(placeType) {
            const icons = {
                'restaurant': 'ðŸ½ï¸',
                'cafe': 'â˜•',
                'bar': 'ðŸº',
                'pub': 'ðŸ»',
                'fast_food': 'ðŸ”',
                'bank': 'ðŸ¦',
                'atm': 'ðŸ’³',
                'hospital': 'ðŸ¥',
                'pharmacy': 'ðŸ’Š',
                'school': 'ðŸ«',
                'university': 'ðŸŽ“',
                'library': 'ðŸ“š',
                'cinema': 'ðŸŽ¬',
                'theatre': 'ðŸŽ­',
                'museum': 'ðŸ›ï¸',
                'hotel': 'ðŸ¨',
                'supermarket': 'ðŸ›’',
                'mall': 'ðŸª',
                'clothes': 'ðŸ‘•',
                'fuel': 'â›½',
                'parking': 'ðŸ…¿ï¸',
                'bus_station': 'ðŸšŒ',
                'taxi': 'ðŸš•',
                'police': 'ðŸ‘®',
                'market': 'ðŸ›ï¸',
                'post_office': 'ðŸ“®',
                'place_of_worship': 'ðŸ›',
                'stadium': 'ðŸŸï¸',
                'park': 'ðŸžï¸',
                'monument': 'ðŸ—½',
                'castle': 'ðŸ°'
            };
            
            return icons[placeType] || 'ðŸ“';
        }
        
        // Hide destination suggestions
        function hideDestinationSuggestions() {
            const suggestionsContainer = document.getElementById('destinationSuggestions');
            suggestionsContainer.style.display = 'none';
        }
        
        // Forward geocoding function
        function forwardGeocode(query) {
            return new Promise(resolve => {
                if (!userLocation) {
                    resolve([]);
                    return;
                }
                
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10`)
                    .then(response => response.json())
                    .then(data => {
                        // Filter results within 50km radius
                        const filteredResults = data.filter(result => {
                            const distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(result.lat), parseFloat(result.lon)
                            );
                            return distance <= 50000; // 50km in meters
                        });
                        
                        resolve(filteredResults);
                    })
                    .catch(error => {
                        console.error('Forward geocoding error:', error);
                        resolve([]);
                    });
            });
        }
        
        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }
        
        // Fare estimation based on distance (K11 minimum, then K1 per 90 meters)
        function updateFareEstimate() {
            const destination = document.getElementById('destinationLocation').value;
            
            if (destination.length > 3 && userLocation) {
                // Calculate distance using Haversine formula (simplified)
                forwardGeocode(destination).then(results => {
                    if (results.length > 0) {
                        const destLat = parseFloat(results[0].lat);
                        const destLng = parseFloat(results[0].lon);
                        
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            destLat, destLng
                        );
                        
                        // K11 minimum fare for distances below 90 meters, then K1 per 90 meters
                        let baseFare;
                        if (distance < 90) {
                            baseFare = 11;
                        } else {
                            baseFare = Math.max(11, Math.ceil(distance / 90));
                        }
                        
                        // Apply ride type multiplier
                        switch(selectedVehicleType) {
                            case 'car':
                                baseFare = baseFare;
                                break;
                            case 'bike':
                                baseFare = baseFare * 0.7;
                                break;
                            case 'bicycle':
                                baseFare = baseFare * 0.5;
                                break;
                        }
                        
                        // Apply promo code discount if applicable
                        if (appliedPromoCode) {
                            baseFare = baseFare * 0.8; // 20% discount
                        }
                        
                        document.getElementById('estimatedFare').textContent = `K${baseFare.toFixed(2)}`;
                        
                        // Calculate ETA (assuming average speed of 30 km/h)
                        const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                        document.getElementById('etaDisplay').textContent = `ETA: ${etaMinutes} min`;
                        
                        // Enable request ride button
                        document.getElementById('requestRideBtn').disabled = false;
                        
                        // Store fare for later use
                        rideFare = baseFare;
                    }
                });
            } else {
                document.getElementById('estimatedFare').textContent = 'K0.00';
                document.getElementById('etaDisplay').textContent = 'ETA: -- min';
                document.getElementById('requestRideBtn').disabled = true;
            }
        }
        
        // Update destination marker on map
        function updateDestinationMarker(lat, lng, name) {
            // Remove existing destination marker
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
            }
            
            // Add new destination marker
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(passengerMap)
                .bindPopup(`<strong>${name}</strong><br>Your destination`)
                .openPopup();
            
            // Fit map to show both user location and destination
            const bounds = L.latLngBounds(
                [userLocation.lat, userLocation.lng],
                [lat, lng]
            );
            passengerMap.fitBounds(bounds, { padding: [15, 15] });
        }
        
        // Draw route from user location to destination
        function drawRoute(startLat, startLng, endLat, endLng) {
            // Remove existing route if any
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
            }
            
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7,
                            dashArray: '8, 8'
                        }).addTo(passengerMap);
                        
                        // Fit map to show the entire route
                        passengerMap.fitBounds(routePolyline.getBounds(), { padding: [15, 15] });
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    }).addTo(passengerMap);
                });
        }
        
        // Show payment selection popup
        function showPaymentSelection() {
            const pickupLocation = document.getElementById('pickupLocation').value;
            const destinationLocation = document.getElementById('destinationLocation').value;
            
            if (!destinationLocation) {
                showNotification('Please enter a destination');
                return;
            }
            
            if (!currentLocationMarker) {
                showNotification('Unable to determine your location. Please try again.');
                return;
            }
            
            // Update wallet balance in payment popup
            document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
            
            // Check if wallet balance is sufficient
            if (walletBalance < rideFare) {
                document.getElementById('insufficientBalance').style.display = 'block';
                document.getElementById('confirmPaymentBtn').disabled = true;
            } else {
                document.getElementById('insufficientBalance').style.display = 'none';
                document.getElementById('confirmPaymentBtn').disabled = false;
            }
            
            // Show payment selection popup
            document.getElementById('paymentSelectionPopup').classList.remove('hidden');
        }
        
        // Close payment selection popup
        function closePaymentSelection() {
            document.getElementById('paymentSelectionPopup').classList.add('hidden');
        }
        
        // Request a ride
        function requestRide() {
            const pickupLocation = document.getElementById('pickupLocation').value;
            const destinationLocation = document.getElementById('destinationLocation').value;
            
            if (!destinationLocation) {
                showNotification('Please enter a destination');
                return;
            }
            
            if (!currentLocationMarker) {
                showNotification('Unable to determine your location. Please try again.');
                return;
            }
            
            const pickupLatLng = currentLocationMarker.getLatLng();
            
            // Calculate fare based on distance
            forwardGeocode(destinationLocation).then(results => {
                if (results.length === 0) {
                    showNotification('Invalid destination address. Please select a valid destination.');
                    return;
                }
                
                const destLat = parseFloat(results[0].lat);
                const destLng = parseFloat(results[0].lon);
                
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    destLat, destLng
                );
                
                // K11 minimum fare for distances below 90 meters, then K1 per 90 meters
                let fare;
                if (distance < 90) {
                    fare = 11;
                } else {
                    fare = Math.max(11, Math.ceil(distance / 90));
                }
                
                // Apply ride type multiplier
                switch(selectedVehicleType) {
                    case 'car':
                        fare = fare;
                        break;
                    case 'bike':
                        fare = fare * 0.7;
                        break;
                    case 'bicycle':
                        fare = fare * 0.5;
                        break;
                }
                
                // Apply promo code discount if applicable
                if (appliedPromoCode) {
                    fare = fare * 0.8; // 20% discount
                }
                
                // Generate a unique ride ID
                const rideId = database.ref().child('rides').push().key;
                
                // Create ride request
                const rideRequest = {
                    id: rideId,
                    passengerId: currentUser.uid,
                    passengerName: userData.name || 'Passenger',
                    passengerPhone: userData.phone || 'Not provided',
                    pickupLocation: pickupLocation,
                    destination: destinationLocation,
                    pickupLat: pickupLatLng.lat,
                    pickupLng: pickupLatLng.lng,
                    destLat: destLat,
                    destLng: destLng,
                    rideType: selectedVehicleType,
                    fare: fare,
                    distance: (distance / 1000).toFixed(2) + ' km',
                    status: 'requested',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    promoCode: appliedPromoCode,
                    paymentMethod: selectedPaymentType
                };
                
                // If payment is via wallet, deduct fare from wallet
                if (selectedPaymentType === 'wallet') {
                    const newBalance = walletBalance - fare;
                    
                    // Update wallet balance in Firebase
                    database.ref('users/' + currentUser.uid).update({
                        walletBalance: newBalance
                    })
                    .then(() => {
                        // Update local wallet balance
                        walletBalance = newBalance;
                        document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                        document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                        
                        // Save ride request to Firebase
                        return database.ref('rides/' + rideId).set(rideRequest);
                    })
                    .then(() => {
                        currentRide = rideRequest;
                        
                        // Close payment popup
                        closePaymentSelection();
                        
                        // Update UI for active ride
                        updateUIForActiveRide();
                        
                        // Show ride status
                        document.getElementById('rideStatus').style.display = 'flex';
                        document.getElementById('statusDot').className = 'status-dot searching';
                        document.getElementById('statusText').textContent = 'Searching for driver';
                        
                        showNotification('Ride requested. Searching for a driver...');
                        
                        // Listen for driver assignment
                        listenForDriverAssignment(rideId);
                    })
                    .catch(error => {
                        console.error('Error requesting ride:', error);
                        showNotification('Error requesting ride. Please try again.');
                    });
                } else {
                    // For other payment methods, just save the ride request
                    database.ref('rides/' + rideId).set(rideRequest)
                        .then(() => {
                            currentRide = rideRequest;
                            
                            // Close payment popup
                            closePaymentSelection();
                            
                            // Update UI for active ride
                            updateUIForActiveRide();
                            
                            // Show ride status
                            document.getElementById('rideStatus').style.display = 'flex';
                            document.getElementById('statusDot').className = 'status-dot searching';
                            document.getElementById('statusText').textContent = 'Searching for driver';
                            
                            showNotification('Ride requested. Searching for a driver...');
                            
                            // Listen for driver assignment
                            listenForDriverAssignment(rideId);
                        })
                        .catch(error => {
                            console.error('Error requesting ride:', error);
                            showNotification('Error requesting ride. Please try again.');
                        });
                }
            }).catch(error => {
                console.error('Error geocoding destination:', error);
                showNotification('Error calculating route. Please try again.');
            });
        }
        
        // Update UI for active ride
        function updateUIForActiveRide() {
            // Hide ride request form
            document.getElementById('rideRequestForm').style.display = 'none';
            
            // Show ride info panel
            document.getElementById('rideInfoPanel').style.display = 'block';
            
            // Update ride info
            document.getElementById('currentPickupLocation').textContent = currentRide.pickupLocation;
            document.getElementById('currentDestinationLocation').textContent = currentRide.destination;
            
            // Calculate and display fare
            const baseFare = currentRide.fare;
            const discount = appliedPromoCode ? baseFare * 0.2 : 0;
            const totalFare = baseFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
        }
        
        // Listen for driver assignment
        function listenForDriverAssignment(rideId) {
            // Remove any existing listener
            if (driverAssignmentListener) {
                driverAssignmentListener();
            }
            
            // Listen for changes to the ride
            driverAssignmentListener = database.ref('rides/' + rideId).on('value', snapshot => {
                const ride = snapshot.val();
                if (!ride) {
                    showNotification('Ride not found. Please try again.');
                    return;
                }
                
                console.log('Ride status update:', ride.status, ride.driverId);
                
                if (ride.driverId && ride.status === 'accepted') {
                    // Driver assigned and ride accepted
                    handleDriverAssignment(ride);
                } else if (ride.status === 'completed') {
                    // Ride completed
                    showRideCompletion(ride);
                } else if (ride.status === 'cancelled') {
                    // Ride cancelled
                    handleRideCancellation(ride);
                } else if (ride.status === 'arrived') {
                    // Driver arrived
                    showNotification('Your driver has arrived at the pickup location.');
                } else if (ride.status === 'picked_up') {
                    // Passenger picked up
                    showNotification('You have been picked up. Enjoy your ride!');
                } else if (ride.status === 'started') {
                    // Trip started
                    showNotification('Your trip has started.');
                }
            }, error => {
                console.error('Error listening for driver assignment:', error);
                showNotification('Connection error. Please check your internet connection.');
            });
        }
        
        // Handle driver assignment
        function handleDriverAssignment(ride) {
            // Update ride status
            document.getElementById('statusDot').className = 'status-dot arriving';
            document.getElementById('statusText').textContent = 'Driver arriving';
            
            // Show estimated time
            document.getElementById('estimatedTime').style.display = 'flex';
            document.getElementById('timeText').textContent = '5 min';
            
            // Get driver details
            database.ref('users/' + ride.driverId).once('value')
                .then(driverSnapshot => {
                    const driver = driverSnapshot.val();
                    if (driver) {
                        // Update driver info
                        document.getElementById('driverName').textContent = driver.name || 'Driver';
                        document.getElementById('driverPhone').textContent = driver.phone || 'N/A';
                        document.getElementById('driverRating').textContent = driver.rating || '4.5';
                        
                        if (driver.vehicle) {
                            document.getElementById('vehicleDetails').textContent = 
                                `${driver.vehicle.type || 'Vehicle'} - ${driver.vehicle.licensePlate || 'ABC123'}`;
                        }
                        
                        // Update driver avatar
                        const driverAvatar = document.getElementById('driverAvatar');
                        if (driver.name) {
                            driverAvatar.innerHTML = driver.name.charAt(0).toUpperCase();
                        }
                        
                        // Add driver marker to map
                        addDriverMarker(ride.driverLat, ride.driverLng);
                        
                        // Draw route from driver to pickup
                        drawRoute(ride.driverLat, ride.driverLng, ride.pickupLat, ride.pickupLng);
                        
                        // Start tracking driver location
                        trackDriverLocation(ride.driverId);
                        
                        showNotification(`Driver ${driver.name} is on the way!`);
                    }
                });
            
            // Listen for ride status updates
            listenForRideStatusUpdates(ride.id);
        }
        
        // Track driver location in real-time
        function trackDriverLocation(driverId) {
            // Remove any existing listener
            if (driverLocationListener) {
                driverLocationListener();
            }
            
            // Listen for driver location updates
            driverLocationListener = database.ref('driverLocations/' + driverId).on('value', snapshot => {
                const location = snapshot.val();
                if (location && driverMarker) {
                    // Update driver marker position
                    driverMarker.setLatLng([location.latitude, location.longitude]);
                    
                    // Update ETA based on driver's current position
                    updateDriverETA(location.latitude, location.longitude);
                }
            });
        }
        
        // Update ETA based on driver's current position
        function updateDriverETA(driverLat, driverLng) {
            if (userLocation) {
                const distance = calculateDistance(
                    driverLat, driverLng,
                    userLocation.lat, userLocation.lng
                );
                
                // Calculate ETA (assuming average speed of 30 km/h)
                const etaMinutes = Math.ceil((distance / 1000) / 30 * 60);
                document.getElementById('timeText').textContent = `${etaMinutes} min`;
            }
        }
        
        // Listen for ride status updates
        function listenForRideStatusUpdates(rideId) {
            database.ref('rides/' + rideId).on('value', snapshot => {
                const ride = snapshot.val();
                if (ride) {
                    currentRide = ride;
                    
                    switch(ride.status) {
                        case 'accepted':
                            document.getElementById('statusText').textContent = 'Driver on the way';
                            break;
                        case 'arrived':
                            document.getElementById('statusText').textContent = 'Driver arrived';
                            document.getElementById('statusDot').className = 'status-dot riding';
                            showNotification('Your driver has arrived!');
                            break;
                        case 'started':
                            document.getElementById('statusText').textContent = 'Trip in progress';
                            // Update destination marker
                            addDestinationMarker(ride.destLat, ride.destLng);
                            // Draw route to destination
                            drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
                            break;
                        case 'completed':
                            document.getElementById('statusText').textContent = 'Trip completed';
                            document.getElementById('rideStatus').style.display = 'none';
                            document.getElementById('estimatedTime').style.display = 'none';
                            resetUIAfterRide();
                            showNotification('Trip completed. Thank you for using Jubel!');
                            break;
                        case 'cancelled':
                            document.getElementById('rideStatus').style.display = 'none';
                            document.getElementById('estimatedTime').style.display = 'none';
                            resetUIAfterRide();
                            showNotification('Ride cancelled');
                            break;
                    }
                }
            });
        }
        
        // Add driver marker to map
        function addDriverMarker(lat, lng) {
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
            }
            
            driverMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'driver-marker',
                    html: '<div class="driver-marker">ðŸš—</div><div class="driver-marker-label">Driver</div>',
                    iconSize: [35, 50]
                })
            }).addTo(passengerMap)
                .bindPopup('Your driver');
        }
        
        // Add destination marker to map
        function addDestinationMarker(lat, lng) {
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
            }
            
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(passengerMap)
                .bindPopup('Destination');
        }
        
        // Handle ride cancellation
        function handleRideCancellation(ride) {
            showNotification('Ride has been cancelled.');
            resetUIAfterRide();
            currentRide = null;
            
            // Clean up
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove listeners
            if (driverAssignmentListener) {
                driverAssignmentListener();
                driverAssignmentListener = null;
            }
            
            if (driverLocationListener) {
                driverLocationListener();
                driverLocationListener = null;
            }
        }
        
        // Cancel ride
        function cancelRide() {
            if (currentRide) {
                if (confirm('Are you sure you want to cancel this ride?')) {
                    database.ref('rides/' + currentRide.id).update({
                        status: 'cancelled',
                        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        resetUIAfterRide();
                        showNotification('Ride cancelled');
                    })
                    .catch(error => {
                        console.error('Error cancelling ride:', error);
                        showNotification('Error cancelling ride. Please try again.');
                    });
                }
            }
        }
        
        // Contact driver
        function contactDriver() {
            if (currentRide && currentRide.driverId) {
                database.ref('users/' + currentRide.driverId).once('value')
                    .then(snapshot => {
                        const driver = snapshot.val();
                        if (driver && driver.phone) {
                            // In a real app, this would initiate a call
                            showNotification(`Calling driver: ${driver.phone}`);
                            // Simulate calling - in a real app, you would use tel: protocol
                            window.open(`tel:${driver.phone}`, '_self');
                        } else {
                            showNotification('Driver phone number not available.');
                        }
                    });
            }
        }
        
        // Apply promo code
        function applyPromoCode() {
            const promoCode = document.getElementById('promoCode').value.trim();
            
            if (!promoCode) {
                showNotification('Please enter a promo code.');
                return;
            }
            
            // Check if promo code is a referral code
            if (promoCode.startsWith('JUBEL')) {
                // This is a referral code - apply discount and reward referrer
                applyReferralCode(promoCode);
            } else {
                // Regular promo code validation
                // In a real app, this would check against a database of valid promo codes
                if (promoCode.startsWith('JUBEL-')) {
                    appliedPromoCode = promoCode;
                    showNotification('Promo code applied! 20% discount will be applied to your ride.');
                    updateFareEstimate();
                    
                    // Update UI to show applied promo
                    document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                    document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                    document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                    document.getElementById('applyPromoBtn').classList.add('btn-success');
                } else {
                    showNotification('Invalid promo code. Please check and try again.');
                    document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
                }
            }
        }
        
        // Apply referral code
        function applyReferralCode(referralCode) {
            // Find user with this referral code
            database.ref('users').orderByChild('referralCode').equalTo(referralCode).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const referrerData = snapshot.val();
                        const referrerId = Object.keys(referrerData)[0];
                        const referrer = referrerData[referrerId];
                        
                        // Apply discount to current user
                        appliedPromoCode = referralCode;
                        showNotification('Referral code applied! 20% discount will be applied to your ride.');
                        updateFareEstimate();
                        
                        // Update UI to show applied promo
                        document.getElementById('promoCode').style.borderColor = 'var(--success-green)';
                        document.getElementById('applyPromoBtn').innerHTML = '<i class="fas fa-check"></i> Applied';
                        document.getElementById('applyPromoBtn').classList.remove('btn-promo');
                        document.getElementById('applyPromoBtn').classList.add('btn-success');
                        
                        // Reward referrer with K50
                        const newBalance = (referrer.walletBalance || 0) + 50;
                        database.ref('users/' + referrerId).update({
                            walletBalance: newBalance
                        })
                        .then(() => {
                            // Notify referrer (in a real app, this would be a push notification)
                            console.log(`Rewarded ${referrer.name} with K50 for referral`);
                        });
                        
                        // Mark this referral as used
                        database.ref('referrals').push().set({
                            referrerId: referrerId,
                            referredUserId: currentUser.uid,
                            referralCode: referralCode,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            rewardAmount: 50
                        });
                    } else {
                        showNotification('Invalid referral code. Please check and try again.');
                        document.getElementById('promoCode').style.borderColor = 'var(--error-red)';
                    }
                })
                .catch(error => {
                    console.error('Error applying referral code:', error);
                    showNotification('Error applying referral code. Please try again.');
                });
        }
        
        // Reset UI after ride completion or cancellation
        function resetUIAfterRide() {
            // Show ride request form
            document.getElementById('rideRequestForm').style.display = 'flex';
            
            // Hide ride info panel
            document.getElementById('rideInfoPanel').style.display = 'none';
            
            // Clear destination input
            document.getElementById('destinationLocation').value = '';
            
            // Clear promo code
            document.getElementById('promoCode').value = '';
            appliedPromoCode = null;
            document.getElementById('promoCode').style.borderColor = '';
            document.getElementById('applyPromoBtn').innerHTML = 'Apply';
            document.getElementById('applyPromoBtn').classList.remove('btn-success');
            document.getElementById('applyPromoBtn').classList.add('btn-promo');
            document.getElementById('promoSection').classList.remove('active');
            
            // Remove driver marker
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove destination marker
            if (destinationMarker) {
                passengerMap.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            // Remove route
            if (routePolyline) {
                passengerMap.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            // Remove listeners
            if (driverLocationListener) {
                driverLocationListener();
                driverLocationListener = null;
            }
            
            currentRide = null;
        }
        
        // Load passenger data
        function loadPassengerData() {
            if (currentUser) {
                // Update user stats
                updateUserStats();
            }
        }
        
        // Load account data
        function loadAccountData() {
            if (currentUser && userData) {
                // Update account information
                document.getElementById('accountName').textContent = userData.name || 'Passenger';
                document.getElementById('accountPhone').textContent = userData.phone || 'Not set';
                document.getElementById('accountEmail').textContent = userData.email || 'Not set';
                document.getElementById('referralCode').textContent = userData.referralCode || 'JUBEL-XXXX';
                
                // Update wallet balance
                walletBalance = userData.walletBalance || 0;
                document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                
                // Update account avatar
                const accountAvatar = document.getElementById('accountAvatar');
                if (userData.name) {
                    accountAvatar.textContent = userData.name.charAt(0).toUpperCase();
                } else {
                    accountAvatar.innerHTML = '<i class="fas fa-user"></i>';
                }
                
                // Load user stats
                updateUserStats();
            }
        }
        
        // Update user statistics
        function updateUserStats() {
            if (!currentUser) return;
            
            database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    if (rides) {
                        const ridesArray = Object.values(rides);
                        
                        userStats = {
                            completed: ridesArray.filter(ride => ride.status === 'completed' || ride.status === 'paid').length,
                            cancelled: ridesArray.filter(ride => ride.status === 'cancelled').length,
                            pending: ridesArray.filter(ride => ride.status === 'requested' || ride.status === 'accepted').length
                        };
                        
                        // Update UI
                        document.getElementById('ridesCompleted').textContent = userStats.completed;
                        document.getElementById('ridesCancelled').textContent = userStats.cancelled;
                        document.getElementById('ridesPending').textContent = userStats.pending;
                    }
                });
        }
        
        // Share referral code
        function shareReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            const shareText = `Join me on Jubel! Use my referral code ${referralCode} for 20% off your first ride. Download the app now!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Jubel Referral',
                    text: shareText,
                    url: window.location.href
                })
                .then(() => showNotification('Referral code shared successfully!'))
                .catch(error => console.error('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareText)
                    .then(() => showNotification('Referral code copied to clipboard!'));
            }
        }
        
        // Deposit to wallet
        function depositToWallet() {
            const amount = prompt('Enter deposit amount (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const depositAmount = parseFloat(amount);
                const newBalance = walletBalance + depositAmount;
                
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
                    showNotification(`Successfully deposited K${depositAmount.toFixed(2)} to your wallet.`);
                })
                .catch(error => {
                    console.error('Error depositing to wallet:', error);
                    showNotification('Error processing deposit. Please try again.');
                });
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Withdraw from wallet
        function withdrawFromWallet() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter withdrawal amount (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawalAmount = parseFloat(amount);
                
                if (withdrawalAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawalAmount;
                
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: newBalance
                })
                .then(() => {
                    walletBalance = newBalance;
                    document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                    document.getElementById('paymentWalletBalance').textContent = `Balance: K${walletBalance.toFixed(2)}`;
                    showNotification(`Successfully withdrew K${withdrawalAmount.toFixed(2)} from your wallet.`);
                })
                .catch(error => {
                    console.error('Error withdrawing from wallet:', error);
                    showNotification('Error processing withdrawal. Please try again.');
                });
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Contact via WhatsApp
        function contactWhatsApp() {
            const phoneNumber = '0768658484';
            const message = 'Hello, I need assistance with Jubel rides.';
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }
        
        // Contact via phone call
        function contactPhone() {
            const phoneNumber = '0768658484';
            window.open(`tel:${phoneNumber}`, '_self');
        }
        
        // Add payment method
        function addPaymentMethod() {
            showNotification('Payment method feature coming soon!');
        }
        
        // Load ride history with all statuses including pending orders
        function loadRideHistory() {
            if (currentUser) {
                const filter = document.getElementById('historyFilter').value;
                const dateFilter = document.getElementById('historyDate').value;
                
                // Remove existing listener
                if (rideHistoryListener) {
                    rideHistoryListener();
                }
                
                // Set up real-time listener for ride history
                rideHistoryListener = database.ref('rides').orderByChild('passengerId').equalTo(currentUser.uid).on('value', snapshot => {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    
                    const rides = snapshot.val();
                    if (rides) {
                        let ridesArray = Object.keys(rides).map(rideId => ({
                            id: rideId,
                            ...rides[rideId]
                        }));
                        
                        // Apply filters
                        if (filter !== 'all') {
                            ridesArray = ridesArray.filter(ride => ride.status === filter);
                        }
                        
                        if (dateFilter) {
                            const filterDate = new Date(dateFilter);
                            ridesArray = ridesArray.filter(ride => {
                                const rideDate = new Date(ride.timestamp);
                                return rideDate.toDateString() === filterDate.toDateString();
                            });
                        }
                        
                        // Sort by timestamp (newest first)
                        ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                        
                        if (ridesArray.length === 0) {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                            return;
                        }
                        
                        ridesArray.forEach(ride => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.setAttribute('data-ride-id', ride.id);
                            
                            const date = new Date(ride.timestamp);
                            const formattedDate = date.toLocaleDateString();
                            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            // Determine status badge class
                            let statusClass = 'status-requested';
                            let statusText = getStatusText(ride.status);
                            
                            if (ride.status === 'accepted') {
                                statusClass = 'status-accepted';
                            } else if (ride.status === 'completed' || ride.status === 'paid') {
                                statusClass = 'status-completed';
                            } else if (ride.status === 'cancelled') {
                                statusClass = 'status-cancelled';
                            } else if (ride.status === 'requested') {
                                statusClass = 'status-pending';
                                statusText = 'Pending';
                            }
                            
                            historyItem.innerHTML = `
                                <div class="history-locations">
                                    <div>
                                        <strong>From:</strong> ${ride.pickupLocation}
                                    </div>
                                    <div>
                                        <strong>To:</strong> ${ride.destination}
                                    </div>
                                </div>
                                <div class="history-info">
                                    <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                    <div>${formattedDate} ${formattedTime}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                            
                            historyList.appendChild(historyItem);
                        });
                    } else {
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                    }
                }, error => {
                    console.error('Error loading ride history:', error);
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                });
            }
        }
        
        // Get display text for ride status
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Awaiting Driver',
                'accepted': 'In Progress',
                'completed': 'Completed',
                'paid': 'Completed',
                'cancelled': 'Cancelled',
                'arrived': 'Driver Arrived',
                'picked_up': 'Picked Up',
                'started': 'Trip Started'
            };
            
            return statusMap[status] || status;
        }
        
        // Show ride details popup
        function showRideDetailsPopup(rideId) {
            database.ref('rides/' + rideId).once('value')
                .then(snapshot => {
                    const ride = snapshot.val();
                    if (ride) {
                        // Update popup content
                        document.getElementById('popupRidePickup').textContent = ride.pickupLocation;
                        document.getElementById('popupRideDestination').textContent = ride.destination;
                        document.getElementById('popupRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                        document.getElementById('popupRideDistance').textContent = ride.distance || 'Calculating...';
                        document.getElementById('popupRideStatus').textContent = getStatusText(ride.status);
                        document.getElementById('popupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                        
                        // Format date
                        const date = new Date(ride.timestamp);
                        document.getElementById('popupRideDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        // Update map in popup
                        updatePopupRideMap(ride);
                        
                        // Show driver details if available
                        if (ride.driverId) {
                            database.ref('users/' + ride.driverId).once('value')
                                .then(driverSnapshot => {
                                    const driver = driverSnapshot.val();
                                    if (driver) {
                                        document.getElementById('popupDriverName').textContent = driver.name || 'Driver';
                                        document.getElementById('popupDriverPhone').textContent = driver.phone || 'N/A';
                                        document.getElementById('popupDriverVehicle').textContent = `${driver.vehicleType || 'Car'} (${driver.licensePlate || 'N/A'})`;
                                        document.getElementById('popupDriverRating').textContent = driver.rating || '4.5';
                                        
                                        // Show driver progress based on ride status
                                        updateDriverProgress(ride.status);
                                        
                                        document.getElementById('popupDriverDetails').classList.remove('hidden');
                                    }
                                });
                        } else {
                            document.getElementById('popupDriverDetails').classList.add('hidden');
                        }
                        
                        // Show popup
                        document.getElementById('rideDetailsPopup').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading ride details:', error);
                    showNotification('Error loading ride details.');
                });
        }
        
        // Update driver progress in popup
        function updateDriverProgress(status) {
            const progressElement = document.getElementById('popupDriverProgress');
            
            switch(status) {
                case 'requested':
                    progressElement.textContent = 'Waiting for driver to accept';
                    break;
                case 'accepted':
                    progressElement.textContent = 'Driver on the way to pickup';
                    break;
                case 'arrived':
                    progressElement.textContent = 'Driver arrived at pickup location';
                    break;
                case 'picked_up':
                    progressElement.textContent = 'Passenger picked up';
                    break;
                case 'started':
                    progressElement.textContent = 'Trip in progress';
                    break;
                case 'completed':
                    progressElement.textContent = 'Trip completed';
                    break;
                case 'paid':
                    progressElement.textContent = 'Payment completed';
                    break;
                default:
                    progressElement.textContent = 'Status: ' + status;
            }
        }
        
        // Update popup ride map
        function updatePopupRideMap(ride) {
            // Clear existing map
            popupRideMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    popupRideMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(popupRideMap).bindPopup('Pickup Location');
            
            // Add destination marker
            L.marker([ride.destLat, ride.destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                    iconSize: [25, 25]
                })
            }).addTo(popupRideMap).bindPopup('Destination');
            
            // Draw route
            drawRouteOnPopupMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
            
            // Fit map to show both locations
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            popupRideMap.fitBounds(bounds, { padding: [15, 15] });
        }
        
        // Draw route on popup map
        function drawRouteOnPopupMap(startLat, startLng, endLat, endLng) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(popupRideMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(popupRideMap);
                });
        }
        
        // Close ride details popup
        function closeRideDetailsPopup() {
            document.getElementById('rideDetailsPopup').classList.add('hidden');
        }
        
        // Set rating stars
        function setRating(rating) {
            userRating = rating;
            document.querySelectorAll('.star').forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // Show ride completion
        function showRideCompletion(ride) {
            // Update final fare
            document.getElementById('finalFare').textContent = `K${ride.fare.toFixed(2)}`;
            
            // Switch to completion screen
            switchScreen('rideCompletionScreen');
            showNotification('Ride completed. Please complete payment and rating.');
            
            // Clean up
            if (driverMarker) {
                passengerMap.removeLayer(driverMarker);
                driverMarker = null;
            }
            
            // Remove listeners
            if (driverAssignmentListener) {
                driverAssignmentListener();
                driverAssignmentListener = null;
            }
            
            if (driverLocationListener) {
                driverLocationListener();
                driverLocationListener = null;
            }
        }
        
        // Quick actions
        
        // Center map on passenger location
        function centerMap() {
            if (currentLocationMarker) {
                const passengerLatLng = currentLocationMarker.getLatLng();
                passengerMap.setView(passengerLatLng, 16);
                showNotification('Map centered on your location');
            }
        }
        
        // Refresh passenger position
        function refreshPassengerPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    userLocation = { lat, lng };
                    
                    // Update map with current location
                    passengerMap.setView([lat, lng], 16);
                    
                    // Update passenger marker position
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng([lat, lng]);
                    } else {
                        currentLocationMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'current-location-marker',
                                html: '<div class="current-location-marker"><i class="fas fa-user"></i></div>',
                                iconSize: [20, 20]
                            })
                        }).addTo(passengerMap)
                            .bindPopup('Your location');
                    }
                    
                    // Update pickup location
                    updatePickupLocation(lat, lng);
                    
                    // Determine current city based on coordinates
                    determineCurrentCity(lat, lng);
                    
                    showNotification('Location refreshed');
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to refresh location. Please enable location services.');
                });
            }
        }
        
        // Toggle traffic layer
        function toggleTraffic() {
            if (trafficEnabled) {
                // Remove traffic layer
                if (trafficLayer) {
                    passengerMap.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
                trafficEnabled = false;
                showNotification('Traffic layer disabled');
            } else {
                // Add traffic layer (using OpenStreetMap traffic tiles as an example)
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(passengerMap);
                trafficEnabled = true;
                showNotification('Traffic layer enabled');
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
        
        // Handle offline/online status
        window.addEventListener('online', function() {
            showNotification('Connection restored.');
        });

        window.addEventListener('offline', function() {
            showNotification('You are currently offline. Some features may not work.');
        });
    </script>
</body>
</html>
