<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Admin Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Header */
        .header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px var(--app-padding);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-medium);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 700;
        }
        
        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 700;
            cursor: pointer;
        }
        
        /* Main Content */
        .main-content {
            padding: var(--app-padding);
            padding-bottom: 70px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }
        
        /* Dashboard */
        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            position: relative;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .stat-card.primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 8px 12px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .tab.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* List Items */
        .list-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:hover {
            background: var(--light-orange);
        }
        
        .item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        
        .item-details {
            font-size: 0.75rem;
            color: var(--medium-gray);
            display: flex;
            justify-content: space-between;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .status-online {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .status-started {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Map */
        #map {
            height: 300px;
            width: 100%;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
            cursor: pointer;
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--app-padding);
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .modal-content {
            padding: 12px;
        }
        
        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 8px var(--app-padding);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 0;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .nav-item.active {
            color: var(--primary-orange);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            font-weight: 700;
            background: var(--light-gray);
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            margin-bottom: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius) 0 0 var(--element-radius);
            font-size: 0.8rem;
        }
        
        .search-btn {
            padding: 10px 12px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: 0 var(--element-radius) var(--element-radius) 0;
            cursor: pointer;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        /* Filter */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .filter-select {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
        }
        
        /* Charts */
        .chart-container {
            height: 150px;
            background: var(--white);
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
            position: relative;
        }
        
        /* Detail View */
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Map Container */
        .map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        /* Full Screen Map */
        .full-screen-map {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 200;
            display: none;
        }
        
        .full-screen-map.active {
            display: block;
        }
        
        /* Ride Tracking */
        .ride-tracking {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            max-width: 300px;
        }
        
        /* Driver Marker */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Passenger Marker */
        .passenger-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .passenger-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Active Ride Marker */
        .active-ride-marker {
            background: var(--success-green);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .active-ride-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* SOS Alert Marker */
        .sos-marker {
            background: var(--error-red);
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 15px rgba(231, 76, 60, 0.7);
            animation: sos-pulse 1.5s infinite;
        }
        
        @keyframes sos-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        .sos-marker-label {
            background: var(--error-red);
            color: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Referral Code */
        .referral-code {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            font-family: monospace;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
        }
        
        /* Dropdown Stats */
        .stats-dropdown {
            position: absolute;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            padding: 10px;
            z-index: 10;
            width: 200px;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        .stats-dropdown.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-label {
            font-weight: 600;
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .dropdown-value {
            font-weight: 700;
            font-size: 0.8rem;
        }
        
        /* Earnings Header */
        .earnings-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 15px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 15px;
            box-shadow: var(--shadow-medium);
        }
        
        .earnings-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .earnings-amount {
            font-size: 2rem;
            font-weight: 800;
        }
        
        /* Expanded Details */
        .expanded-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expanded-details.active {
            max-height: 500px;
        }
        
        .detail-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        /* Stats Cards Container */
        .stats-cards-container {
            position: relative;
        }
        
        /* Chart Canvas */
        .chart-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Statistics Dropdown Button */
        .stats-dropdown-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--element-radius);
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-speed) ease;
        }
        
        .stats-dropdown-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .stats-dropdown-btn i {
            transition: transform var(--transition-speed) ease;
        }
        
        .stats-dropdown-btn.active i {
            transform: rotate(180deg);
        }
        
        .stats-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .stats-container.active {
            max-height: 500px;
        }
        
        /* NEW STYLES FOR ENHANCED FEATURES */
        .wallet-section {
            margin-bottom: 20px;
        }
        
        .wallet-balance-card {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .float-balance-card {
            background: var(--light-orange);
            color: var(--dark-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
            border: 2px solid var(--primary-orange);
        }
        
        .balance-amount-medium {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .history-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.7rem;
        }
        
        .history-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .history-detail-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .history-detail-value {
            font-weight: 600;
        }
        
        .delivery-info-section {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-top: 10px;
        }
        
        .delivery-info-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .delivery-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .delivery-info-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .delivery-info-value {
            font-weight: 600;
        }
        
        .special-instructions {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-top: 8px;
            font-size: 0.75rem;
            border-left: 3px solid var(--primary-orange);
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .driver-details-header h3 {
            font-size: 0.9rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        .history-item-type {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-bottom: 5px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 8px;
            border-radius: var(--element-radius);
            margin: 8px 0;
            font-size: 0.7rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.6rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .top-performers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .top-performer-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .top-performer-header {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-performer-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .top-performer-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.7rem;
        }
        
        .top-performer-item:last-child {
            border-bottom: none;
        }
        
        .top-performer-name {
            font-weight: 600;
        }
        
        .top-performer-value {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .ride-map-container {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .ride-map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-light);
            z-index: 10;
            display: flex;
            gap: 10px;
            font-size: 0.7rem;
        }
        
        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .map-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-pickup {
            background: var(--primary-orange);
        }
        
        .legend-destination {
            background: var(--primary-red);
        }
        
        .legend-driver {
            background: var(--primary-gradient);
        }
        
        .map-zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .map-zoom-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--primary-orange);
        }
        
        /* Enhanced Ride Details Styles */
        .ride-timeline {
            margin-top: 15px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            position: relative;
        }
        
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--medium-gray);
            margin-right: 10px;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        .timeline-dot.active {
            background: var(--primary-orange);
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
            margin-bottom: 2px;
        }
        
        .timeline-event {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .ride-path {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: var(--light-orange);
            border-radius: var(--element-radius);
        }
        
        .path-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }
        
        .path-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-bottom: 5px;
        }
        
        .path-icon.destination {
            background: var(--primary-red);
        }
        
        .path-label {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .path-arrow {
            flex: 0 0 20px;
            text-align: center;
            color: var(--medium-gray);
        }
        
        .ride-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .metric-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .metric-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .passenger-ride-history {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .passenger-ride-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.7rem;
        }
        
        .passenger-ride-item:last-child {
            border-bottom: none;
        }
        
        .passenger-ride-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .passenger-ride-date {
            color: var(--medium-gray);
        }
        
        .passenger-ride-status {
            font-weight: 600;
        }
        
        .passenger-ride-details {
            display: flex;
            justify-content: space-between;
        }
        
        .passenger-ride-locations {
            flex: 1;
        }
        
        .passenger-ride-fare {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .enhanced-map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .enhanced-map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .enhanced-map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .route-details {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-top: 10px;
        }
        
        .route-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .route-detail-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .route-detail-value {
            font-weight: 600;
        }
        
        .driver-performance {
            margin-top: 15px;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .performance-metric {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .performance-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .performance-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .ride-analytics {
            margin-top: 15px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .analytics-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .analytics-value {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .analytics-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        /* SOS Alert Styles */
        .sos-alert-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--error-red);
            color: var(--white);
            padding: 12px;
            text-align: center;
            font-weight: 700;
            z-index: 400;
            display: none;
            animation: sos-flash 1s infinite;
        }
        
        @keyframes sos-flash {
            0% { background-color: var(--error-red); }
            50% { background-color: #ff5252; }
            100% { background-color: var(--error-red); }
        }
        
        .sos-alert-card {
            background: var(--light-red);
            border: 2px solid var(--error-red);
            border-radius: var(--element-radius);
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .sos-alert-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .sos-alert-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--error-red);
        }
        
        .sos-alert-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .sos-alert-details {
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        
        .sos-alert-actions {
            display: flex;
            gap: 8px;
        }
        
        .sos-alert-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .sos-alert-btn.primary {
            background: var(--error-red);
            color: var(--white);
        }
        
        .sos-alert-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        /* Order for Someone Else Styles */
        .order-for-someone-details {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-top: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .order-for-someone-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-orange);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .order-for-someone-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .order-for-someone-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .order-for-someone-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .order-for-someone-value {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Express Delivery Styles */
        .express-delivery-details {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-top: 10px;
            border: 1px solid var(--primary-orange);
        }
        
        .express-delivery-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-orange);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .express-delivery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .express-delivery-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .express-delivery-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .express-delivery-value {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .express-delivery-instructions {
            background: var(--light-gray);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-top: 8px;
            font-size: 0.7rem;
            border-left: 3px solid var(--primary-orange);
        }
        
        /* Enhanced Driver Details Styles */
        .driver-registration-details {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-registration-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .driver-registration-header h3 {
            font-size: 0.9rem;
            color: var(--primary-orange);
        }
        
        .driver-registration-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .driver-registration-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-registration-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-registration-value {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .driver-documents-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }
        
        .driver-documents-title {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 0.8rem;
            color: var(--primary-orange);
        }
        
        .driver-documents-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .driver-document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px;
            background: var(--white);
            border-radius: var(--element-radius);
            border: 1px solid var(--border-color);
        }
        
        .driver-document-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .driver-document-status {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .driver-document-status.verified {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .driver-document-status.pending {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .driver-document-status.expired {
            background: #ffebee;
            color: #c62828;
        }
        
        .driver-document-actions {
            display: flex;
            gap: 4px;
        }
        
        .driver-document-btn {
            padding: 4px 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .driver-document-btn.primary {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .driver-document-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        /* Enhanced Statistics Styles */
        .enhanced-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .enhanced-stat-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .enhanced-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .enhanced-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .enhanced-stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .enhanced-stat-card.primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .enhanced-stat-card.success {
            background: var(--success-green);
            color: var(--white);
        }
        
        .enhanced-stat-card.warning {
            background: var(--warning-yellow);
            color: var(--white);
        }
        
        .enhanced-stat-card.info {
            background: var(--info-blue);
            color: var(--white);
        }
        
        .enhanced-stat-card.danger {
            background: var(--error-red);
            color: var(--white);
        }
        
        /* Enhanced Filter Styles */
        .enhanced-filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .enhanced-filter-select {
            flex: 1;
            min-width: 120px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
        }
        
        .enhanced-filter-btn {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .enhanced-filter-btn.active {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        /* Enhanced Tab Styles */
        .enhanced-tabs {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        
        .enhanced-tab {
            padding: 8px 12px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .enhanced-tab.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .enhanced-tab-badge {
            background: var(--white);
            color: var(--primary-orange);
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .enhanced-tab.active .enhanced-tab-badge {
            background: rgba(255, 255, 255, 0.3);
            color: var(--white);
        }
        
        /* Enhanced Modal Styles */
        .enhanced-modal {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .enhanced-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-gradient);
            color: var(--white);
            border-radius: var(--element-radius) var(--element-radius) 0 0;
        }
        
        .enhanced-modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .enhanced-close-modal {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--white);
        }
        
        .enhanced-modal-content {
            padding: 15px;
        }
        
        .enhanced-modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        /* SOS Alerts Tab Styles */
        .sos-alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .sos-alert-item {
            background: var(--light-red);
            border: 1px solid var(--error-red);
            border-radius: var(--element-radius);
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .sos-alert-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .sos-alert-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .sos-alert-item-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--error-red);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sos-alert-item-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .sos-alert-item-details {
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        
        .sos-alert-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .sos-alert-item-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .sos-alert-item-btn.primary {
            background: var(--error-red);
            color: var(--white);
        }
        
        .sos-alert-item-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        /* Enhanced Ride Type Badges */
        .ride-type-badge {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .ride-type-badge.standard {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .ride-type-badge.express {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .ride-type-badge.delivery {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .ride-type-badge.order-for-someone {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .modal {
                max-width: 100%;
            }
            
            .ride-tracking {
                max-width: 250px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .top-performers {
                grid-template-columns: 1fr;
            }
            
            .ride-metrics {
                grid-template-columns: 1fr;
            }
            
            .performance-metrics {
                grid-template-columns: 1fr;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
            
            .enhanced-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .order-for-someone-grid {
                grid-template-columns: 1fr;
            }
            
            .express-delivery-grid {
                grid-template-columns: 1fr;
            }
            
            .driver-registration-grid {
                grid-template-columns: 1fr;
            }
            
            .driver-details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- SOS Alert Banner -->
    <div class="sos-alert-banner" id="sosAlertBanner">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="sosAlertText">SOS Alert: Driver needs assistance!</span>
    </div>
    
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">J</div>
                <div class="logo-text">Jubel Admin</div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- App Earnings Header -->
            <div class="earnings-header">
                <div class="earnings-label">App Earnings (8% Commission)</div>
                <div class="earnings-amount" id="appEarnings">K0.00</div>
            </div>
            
            <!-- Statistics Dropdown Button -->
            <button class="stats-dropdown-btn" id="statsDropdownBtn">
                <i class="fas fa-chart-bar"></i>
                View Statistics
                <i class="fas fa-chevron-down"></i>
            </button>
            
            <!-- Statistics Container (Initially Hidden) -->
            <div class="stats-container" id="statsContainer">
                <div class="dashboard-stats">
                    <div class="stat-card primary" id="totalRidesCard">
                        <div class="stat-value" id="totalRides">0</div>
                        <div class="stat-label">Total Rides</div>
                        <div class="stats-dropdown" id="totalRidesDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Completed:</span>
                                <span class="dropdown-value" id="completedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Cancelled:</span>
                                <span class="dropdown-value" id="cancelledRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Active:</span>
                                <span class="dropdown-value" id="activeRidesCount">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Requested:</span>
                                <span class="dropdown-value" id="requestedRides">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="activeRidesCard">
                        <div class="stat-value" id="activeRides">0</div>
                        <div class="stat-label">Active Rides</div>
                        <div class="stats-dropdown" id="activeRidesDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Accepted:</span>
                                <span class="dropdown-value" id="acceptedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Started:</span>
                                <span class="dropdown-value" id="startedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Arrived:</span>
                                <span class="dropdown-value" id="arrivedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Picked Up:</span>
                                <span class="dropdown-value" id="pickedUpRides">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="totalDriversCard">
                        <div class="stat-value" id="totalDrivers">0</div>
                        <div class="stat-label">Total Drivers</div>
                        <div class="stats-dropdown" id="totalDriversDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Online:</span>
                                <span class="dropdown-value" id="onlineDriversCount">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Offline:</span>
                                <span class="dropdown-value" id="offlineDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Suspended:</span>
                                <span class="dropdown-value" id="suspendedDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Cars:</span>
                                <span class="dropdown-value" id="carDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bikes:</span>
                                <span class="dropdown-value" id="bikeDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bicycles:</span>
                                <span class="dropdown-value" id="bicycleDrivers">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="onlineDriversCard">
                        <div class="stat-value" id="onlineDrivers">0</div>
                        <div class="stat-label">Online Drivers</div>
                        <div class="stats-dropdown" id="onlineDriversDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Cars:</span>
                                <span class="dropdown-value" id="onlineCarDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bikes:</span>
                                <span class="dropdown-value" id="onlineBikeDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bicycles:</span>
                                <span class="dropdown-value" id="onlineBicycleDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Rating:</span>
                                <span class="dropdown-value" id="avgDriverRating">0.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="totalPassengersCard">
                        <div class="stat-value" id="totalPassengers">0</div>
                        <div class="stat-label">Total Passengers</div>
                        <div class="stats-dropdown" id="totalPassengersDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Active:</span>
                                <span class="dropdown-value" id="activePassengers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Suspended:</span>
                                <span class="dropdown-value" id="suspendedPassengers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Rating:</span>
                                <span class="dropdown-value" id="avgPassengerRating">0.0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Rides:</span>
                                <span class="dropdown-value" id="avgPassengerRides">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="todayEarningsCard">
                        <div class="stat-value" id="todayEarnings">K0</div>
                        <div class="stat-label">Today's Earnings</div>
                        <div class="stats-dropdown" id="todayEarningsDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Rides Today:</span>
                                <span class="dropdown-value" id="ridesToday">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Commission:</span>
                                <span class="dropdown-value" id="commissionToday">K0.00</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Fare:</span>
                                <span class="dropdown-value" id="avgFareToday">K0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Statistics Grid -->
                <div class="enhanced-stats-grid">
                    <div class="enhanced-stat-card success">
                        <div class="enhanced-stat-value" id="expressDeliveries">0</div>
                        <div class="enhanced-stat-label">Express Deliveries</div>
                    </div>
                    <div class="enhanced-stat-card info">
                        <div class="enhanced-stat-value" id="ordersForSomeone">0</div>
                        <div class="enhanced-stat-label">Orders for Someone</div>
                    </div>
                    <div class="enhanced-stat-card danger">
                        <div class="enhanced-stat-value" id="sosAlertsCount">0</div>
                        <div class="enhanced-stat-label">SOS Alerts</div>
                    </div>
                </div>
            </div>
            
            <!-- Top Performers Section -->
            <div class="top-performers">
                <div class="top-performer-card">
                    <div class="top-performer-header">
                        <i class="fas fa-trophy"></i>
                        Top Drivers (Most Rides)
                    </div>
                    <div class="top-performer-list" id="topDriversList">
                        <!-- Top drivers will be populated by JavaScript -->
                    </div>
                </div>
                <div class="top-performer-card">
                    <div class="top-performer-header">
                        <i class="fas fa-trophy"></i>
                        Top Passengers (Most Rides)
                    </div>
                    <div class="top-performer-list" id="topPassengersList">
                        <!-- Top passengers will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Live Tracking Map
                </h3>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="map-control-btn" id="centerMapBtn" title="Center Map">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-control-btn" id="toggleFullScreenBtn" title="Full Screen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="enhanced-map-controls">
                        <button class="enhanced-map-control-btn" id="refreshMapBtn" title="Refresh Map">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="enhanced-map-control-btn" id="toggleDriversBtn" title="Toggle Drivers">
                            <i class="fas fa-car"></i>
                        </button>
                        <button class="enhanced-map-control-btn" id="toggleRidesBtn" title="Toggle Rides">
                            <i class="fas fa-road"></i>
                        </button>
                        <button class="enhanced-map-control-btn" id="toggleSOSBtn" title="Toggle SOS Alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-list"></i>
                    Recent Activity
                </h3>
                <div id="recentActivityList">
                    <!-- Recent activity will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Drivers Tab -->
        <div id="driversTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="driverSearch" placeholder="Search drivers...">
                <button class="search-btn" id="driverSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="enhanced-filter-bar">
                <select class="enhanced-filter-select" id="driverStatusFilter">
                    <option value="all">All Drivers</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="suspended">Suspended</option>
                </select>
                <select class="enhanced-filter-select" id="driverVehicleFilter">
                    <option value="all">All Vehicles</option>
                    <option value="car">Car</option>
                    <option value="bike">Bike</option>
                    <option value="bicycle">Bicycle</option>
                </select>
                <select class="enhanced-filter-select" id="driverRatingFilter">
                    <option value="all">All Ratings</option>
                    <option value="5">5 Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="1">1+ Stars</option>
                </select>
                <button class="enhanced-filter-btn" id="driverVerifiedFilter">
                    <i class="fas fa-check-circle"></i>
                    Verified Only
                </button>
            </div>
            
            <div id="driversList">
                <!-- Drivers will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Passengers Tab -->
        <div id="passengersTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="passengerSearch" placeholder="Search passengers...">
                <button class="search-btn" id="passengerSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="enhanced-filter-bar">
                <select class="enhanced-filter-select" id="passengerStatusFilter">
                    <option value="all">All Passengers</option>
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                </select>
                <select class="enhanced-filter-select" id="passengerRidesFilter">
                    <option value="all">All Ride Counts</option>
                    <option value="10">10+ Rides</option>
                    <option value="5">5+ Rides</option>
                    <option value="1">1+ Rides</option>
                    <option value="0">0 Rides</option>
                </select>
                <button class="enhanced-filter-btn" id="passengerReferralFilter">
                    <i class="fas fa-user-friends"></i>
                    With Referrals
                </button>
            </div>
            
            <div id="passengersList">
                <!-- Passengers will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Rides Tab -->
        <div id="ridesTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="rideSearch" placeholder="Search rides...">
                <button class="search-btn" id="rideSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="enhanced-filter-bar">
                <select class="enhanced-filter-select" id="rideStatusFilter">
                    <option value="all">All Rides</option>
                    <option value="requested">Requested</option>
                    <option value="accepted">Accepted</option>
                    <option value="started">Started</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <select class="enhanced-filter-select" id="rideTypeFilter">
                    <option value="all">All Types</option>
                    <option value="standard">Standard Ride</option>
                    <option value="express">Express Delivery</option>
                    <option value="order-for-someone">Order for Someone</option>
                </select>
                <input type="date" class="enhanced-filter-select" id="rideDateFilter">
                <button class="enhanced-filter-btn" id="rideHighValueFilter">
                    <i class="fas fa-star"></i>
                    High Value
                </button>
            </div>
            
            <div id="ridesList">
                <!-- Rides will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="enhanced-tabs">
                <div class="enhanced-tab active" data-report="revenue">
                    <i class="fas fa-money-bill-wave"></i>
                    Revenue
                </div>
                <div class="enhanced-tab" data-report="rides">
                    <i class="fas fa-road"></i>
                    Rides
                </div>
                <div class="enhanced-tab" data-report="drivers">
                    <i class="fas fa-car"></i>
                    Drivers
                </div>
                <div class="enhanced-tab" data-report="passengers">
                    <i class="fas fa-users"></i>
                    Passengers
                </div>
                <div class="enhanced-tab" data-report="sos">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Alerts
                    <span class="enhanced-tab-badge" id="sosAlertsBadge">0</span>
                </div>
            </div>
            
            <div class="enhanced-filter-bar">
                <select class="enhanced-filter-select" id="reportPeriod">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
                <select class="enhanced-filter-select" id="reportCity">
                    <option value="all">All Cities</option>
                    <option value="lusaka">Lusaka</option>
                    <option value="kitwe">Kitwe</option>
                    <option value="ndola">Ndola</option>
                    <option value="kabwe">Kabwe</option>
                    <option value="chipata">Chipata</option>
                </select>
                <button class="enhanced-filter-btn" id="exportReportBtn">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>
            
            <div id="revenueReport" class="report-content active">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="revenueChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Rides</th>
                                    <th>Revenue</th>
                                    <th>Commission</th>
                                </tr>
                            </thead>
                            <tbody id="revenueTable">
                                <!-- Revenue data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="ridesReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="ridesChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total Rides</th>
                                    <th>Completed</th>
                                    <th>Cancelled</th>
                                </tr>
                            </thead>
                            <tbody id="ridesReportTable">
                                <!-- Rides report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="driversReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="driversChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Rides</th>
                                    <th>Earnings</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="driversReportTable">
                                <!-- Drivers report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="passengersReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="passengersChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Passenger</th>
                                    <th>Rides</th>
                                    <th>Spent</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="passengersReportTable">
                                <!-- Passengers report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="sosReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="sosChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Driver</th>
                                    <th>Passenger</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="sosReportTable">
                                <!-- SOS report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SOS Alerts Tab -->
        <div id="sosAlertsTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="sosSearch" placeholder="Search SOS alerts...">
                <button class="search-btn" id="sosSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="enhanced-filter-bar">
                <select class="enhanced-filter-select" id="sosStatusFilter">
                    <option value="all">All Alerts</option>
                    <option value="active">Active</option>
                    <option value="resolved">Resolved</option>
                </select>
                <select class="enhanced-filter-select" id="sosTypeFilter">
                    <option value="all">All Types</option>
                    <option value="driver">Driver SOS</option>
                    <option value="passenger">Passenger SOS</option>
                </select>
                <input type="date" class="enhanced-filter-select" id="sosDateFilter">
                <button class="enhanced-filter-btn active" id="sosUrgentFilter">
                    <i class="fas fa-exclamation-circle"></i>
                    Urgent Only
                </button>
            </div>
            
            <div class="sos-alerts-list" id="sosAlertsList">
                <!-- SOS alerts will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="dashboardTab">
            <i class="fas fa-home nav-icon"></i>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" data-tab="driversTab">
            <i class="fas fa-car nav-icon"></i>
            <span>Drivers</span>
        </div>
        <div class="nav-item" data-tab="passengersTab">
            <i class="fas fa-users nav-icon"></i>
            <span>Passengers</span>
        </div>
        <div class="nav-item" data-tab="ridesTab">
            <i class="fas fa-road nav-icon"></i>
            <span>Rides</span>
        </div>
        <div class="nav-item" data-tab="reportsTab">
            <i class="fas fa-chart-bar nav-icon"></i>
            <span>Reports</span>
        </div>
        <div class="nav-item" data-tab="sosAlertsTab">
            <i class="fas fa-exclamation-triangle nav-icon"></i>
            <span>SOS</span>
        </div>
    </div>
    
    <!-- Full Screen Map -->
    <div class="full-screen-map" id="fullScreenMap">
        <div id="fullScreenMapContainer" style="height: 100%; width: 100%;"></div>
        <div class="map-controls">
            <button class="map-control-btn" id="fullScreenZoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="fullScreenZoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="fullScreenCenterBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="exitFullScreenBtn" title="Exit Full Screen">
                <i class="fas fa-compress"></i>
            </button>
        </div>
        <div class="ride-tracking" id="fullScreenRideTracking">
            <!-- Ride tracking info will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Enhanced Driver Detail Modal -->
    <div class="modal-overlay" id="driverDetailModal">
        <div class="enhanced-modal">
            <div class="enhanced-modal-header">
                <h3 class="enhanced-modal-title">
                    <i class="fas fa-id-card"></i>
                    Driver Details
                </h3>
                <button class="enhanced-close-modal" id="closeDriverModal">&times;</button>
            </div>
            <div class="enhanced-modal-content">
                <div id="driverDetailContent">
                    <!-- Driver details will be populated by JavaScript -->
                </div>
                <div class="enhanced-modal-actions">
                    <button class="action-btn btn-secondary" id="editDriverBtn">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn btn-danger" id="suspendDriverBtn">
                        <i class="fas fa-ban"></i>
                        Suspend
                    </button>
                    <button class="action-btn btn-primary" id="trackDriverBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track
                    </button>
                    <button class="action-btn btn-success" id="verifyDriverBtn">
                        <i class="fas fa-check-circle"></i>
                        Verify
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Passenger Detail Modal -->
    <div class="modal-overlay" id="passengerDetailModal">
        <div class="enhanced-modal">
            <div class="enhanced-modal-header">
                <h3 class="enhanced-modal-title">
                    <i class="fas fa-user"></i>
                    Passenger Details
                </h3>
                <button class="enhanced-close-modal" id="closePassengerModal">&times;</button>
            </div>
            <div class="enhanced-modal-content">
                <div id="passengerDetailContent">
                    <!-- Passenger details will be populated by JavaScript -->
                </div>
                <div class="enhanced-modal-actions">
                    <button class="action-btn btn-secondary" id="editPassengerBtn">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn btn-danger" id="suspendPassengerBtn">
                        <i class="fas fa-ban"></i>
                        Suspend
                    </button>
                    <button class="action-btn btn-primary" id="viewRidesBtn">
                        <i class="fas fa-history"></i>
                        View Rides
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Detail Modal -->
    <div class="modal-overlay" id="rideDetailModal">
        <div class="enhanced-modal">
            <div class="enhanced-modal-header">
                <h3 class="enhanced-modal-title">
                    <i class="fas fa-info-circle"></i>
                    Ride Details
                </h3>
                <button class="enhanced-close-modal" id="closeRideModal">&times;</button>
            </div>
            <div class="enhanced-modal-content">
                <div id="rideDetailContent">
                    <!-- Ride details will be populated by JavaScript -->
                </div>
                <div class="expanded-details" id="rideExpandedDetails">
                    <!-- Expanded ride details will be populated by JavaScript -->
                </div>
                <div class="enhanced-modal-actions">
                    <button class="action-btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="action-btn btn-primary" id="reassignRideBtn">
                        <i class="fas fa-sync-alt"></i>
                        Reassign
                    </button>
                    <button class="action-btn btn-success" id="trackRideBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track
                    </button>
                    <button class="action-btn btn-secondary" id="viewRideMapBtn">
                        <i class="fas fa-map"></i>
                        View Map
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Map Modal -->
    <div class="modal-overlay" id="rideMapModal">
        <div class="enhanced-modal">
            <div class="enhanced-modal-header">
                <h3 class="enhanced-modal-title">
                    <i class="fas fa-map"></i>
                    Ride Route Map
                </h3>
                <button class="enhanced-close-modal" id="closeRideMapModal">&times;</button>
            </div>
            <div class="enhanced-modal-content">
                <div class="ride-map-container" id="rideMapContainer"></div>
                <div class="ride-map-legend">
                    <div class="map-legend-item">
                        <div class="map-legend-color legend-pickup"></div>
                        <span>Pickup</span>
                    </div>
                    <div class="map-legend-item">
                        <div class="map-legend-color legend-destination"></div>
                        <span>Destination</span>
                    </div>
                    <div class="map-legend-item">
                        <div class="map-legend-color legend-driver"></div>
                        <span>Driver</span>
                    </div>
                </div>
                <div class="map-zoom-controls">
                    <button class="map-zoom-btn" id="rideMapZoomIn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-zoom-btn" id="rideMapZoomOut">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div class="route-details" id="routeDetails">
                    <!-- Route details will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced SOS Alert Modal -->
    <div class="modal-overlay" id="sosAlertModal">
        <div class="enhanced-modal">
            <div class="enhanced-modal-header">
                <h3 class="enhanced-modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Alert Details
                </h3>
                <button class="enhanced-close-modal" id="closeSOSModal">&times;</button>
            </div>
            <div class="enhanced-modal-content">
                <div id="sosAlertContent">
                    <!-- SOS alert details will be populated by JavaScript -->
                </div>
                <div class="enhanced-modal-actions">
                    <button class="action-btn btn-danger" id="resolveSOSBtn">
                        <i class="fas fa-check"></i>
                        Resolve Alert
                    </button>
                    <button class="action-btn btn-primary" id="contactSOSBtn">
                        <i class="fas fa-phone"></i>
                        Contact
                    </button>
                    <button class="action-btn btn-secondary" id="trackSOSBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track Location
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="enhanced-modal">
            <div class="enhanced-modal-header">
                <h3 class="enhanced-modal-title">
                    <i class="fas fa-cog"></i>
                    System Settings
                </h3>
                <button class="enhanced-close-modal" id="closeSettingsModal">&times;</button>
            </div>
            <div class="enhanced-modal-content">
                <div class="form-group">
                    <label class="form-label">Fare Rate (K per 90 meters)</label>
                    <input type="number" id="fareRate" class="form-input" value="1" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" id="commissionRate" class="form-input" value="8" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Minimum Float (K)</label>
                    <input type="number" id="minFloat" class="form-input" value="10" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">SOS Response Time (minutes)</label>
                    <input type="number" id="sosResponseTime" class="form-input" value="5" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Express Delivery Fee Multiplier</label>
                    <input type="number" id="expressDeliveryMultiplier" class="form-input" value="1.2" step="0.1">
                </div>
                
                <div class="enhanced-modal-actions">
                    <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
                    <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
        authDomain: "jubel-13e1a.firebaseapp.com",
        databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
        projectId: "jubel-13e1a",
        storageBucket: "jubel-13e1a.firebasestorage.app",
        messagingSenderId: "882241095445",
        appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
        measurementId: "G-J5JPKL6B5F"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    // App state
    let currentUser = null;
    let managerMap, fullScreenMap, rideMap;
    let driverMarkers = {};
    let passengerMarkers = {};
    let activeRideMarkers = {};
    let activeRidePolylines = {};
    let sosMarkers = {};
    let selectedDriver = null;
    let selectedPassenger = null;
    let selectedRide = null;
    let selectedSOS = null;
    let driversData = {};
    let passengersData = {};
    let ridesData = {};
    let sosAlertsData = {};
    let activeRides = {};
    let trackedRide = null;
    let appEarnings = 0;
    let statsData = {
        totalRides: 0,
        activeRides: 0,
        totalDrivers: 0,
        onlineDrivers: 0,
        totalPassengers: 0,
        todayEarnings: 0,
        completedRides: 0,
        cancelledRides: 0,
        requestedRides: 0,
        acceptedRides: 0,
        startedRides: 0,
        arrivedRides: 0,
        pickedUpRides: 0,
        offlineDrivers: 0,
        suspendedDrivers: 0,
        carDrivers: 0,
        bikeDrivers: 0,
        bicycleDrivers: 0,
        onlineCarDrivers: 0,
        onlineBikeDrivers: 0,
        onlineBicycleDrivers: 0,
        avgDriverRating: 0,
        activePassengers: 0,
        suspendedPassengers: 0,
        avgPassengerRating: 0,
        avgPassengerRides: 0,
        ridesToday: 0,
        commissionToday: 0,
        avgFareToday: 0,
        expressDeliveries: 0,
        ordersForSomeone: 0,
        sosAlertsCount: 0
    };
    
    // Chart instances
    let revenueChart = null;
    let ridesChart = null;
    let driversChart = null;
    let passengersChart = null;
    let sosChart = null;
    
    // NEW: Enhanced state variables
    let pendingApplications = {};
    let driverApplications = {};
    let applicationDocuments = {};
    let driverChats = {};
    let rideChats = {};
    let driverDocuments = {};
    
    // NEW: Filter and search state
    let currentFilters = {
        drivers: {
            status: 'all',
            vehicle: 'all',
            rating: 'all',
            verified: false,
            registrationStatus: 'all'
        },
        passengers: {
            status: 'all',
            rides: 'all',
            referrals: false
        },
        rides: {
            status: 'all',
            type: 'all',
            date: '',
            highValue: false
        },
        sos: {
            status: 'all',
            type: 'all',
            date: '',
            urgent: false
        }
    };
    
    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        initializeAuth();
        setupEventListeners();
        initializeMap();
        initializeFullScreenMap();
        setupStatsDropdowns();
        // NEW: Load pending applications
        loadPendingApplications();
    });
    
    // Authentication functions
    function initializeAuth() {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('userAvatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'A';
                loadDashboardData();
                loadDriversData();
                loadPassengersData();
                loadRidesData();
                loadSOSAlerts();
                loadSettings();
                // NEW: Load additional data
                loadDriverApplications();
                loadDriverDocuments();
            } else {
                showLoginScreen();
            }
        });
    }
    
    function showLoginScreen() {
        // In a real app, this would show a login form
        // For demo purposes, we'll auto-login with a dummy user
        auth.signInAnonymously()
            .then(() => {
                console.log('Manager signed in anonymously');
            })
            .catch(error => {
                console.error('Authentication error:', error);
            });
    }
    
    // Initialize map
    function initializeMap() {
        // Manager map
        managerMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
        
        // Use a clean map style
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors'
        }).addTo(managerMap);
        
        // Listen for driver location updates
        database.ref('driverLocations').on('value', snapshot => {
            const locations = snapshot.val();
            updateDriverMarkers(locations);
        });
        
        // Listen for active rides
        database.ref('rides').orderByChild('status').equalTo('accepted').on('value', snapshot => {
            const rides = snapshot.val();
            updateActiveRideMarkers(rides);
        });
        
        database.ref('rides').orderByChild('status').equalTo('started').on('value', snapshot => {
            const rides = snapshot.val();
            updateActiveRideMarkers(rides);
        });
        
        // Listen for SOS alerts
        database.ref('sosAlerts').orderByChild('resolved').equalTo(false).on('value', snapshot => {
            const alerts = snapshot.val();
            updateSOSMarkers(alerts);
        });
    }
    
    // Initialize full screen map
    function initializeFullScreenMap() {
        fullScreenMap = L.map('fullScreenMapContainer').setView([-15.4167, 28.2833], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors'
        }).addTo(fullScreenMap);
        
        // Copy markers from main map to full screen map
        database.ref('driverLocations').once('value').then(snapshot => {
            const locations = snapshot.val();
            updateFullScreenDriverMarkers(locations);
        });
        
        database.ref('rides').orderByChild('status').equalTo('accepted').once('value').then(snapshot => {
            const rides = snapshot.val();
            updateFullScreenActiveRideMarkers(rides);
        });
        
        database.ref('rides').orderByChild('status').equalTo('started').once('value').then(snapshot => {
            const rides = snapshot.val();
            updateFullScreenActiveRideMarkers(rides);
        });
        
        database.ref('sosAlerts').orderByChild('resolved').equalTo(false).once('value').then(snapshot => {
            const alerts = snapshot.val();
            updateFullScreenSOSMarkers(alerts);
        });
    }
    
    // Initialize ride map for modal
    function initializeRideMap() {
        rideMap = L.map('rideMapContainer').setView([-15.4167, 28.2833], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ' OpenStreetMap contributors'
        }).addTo(rideMap);
    }
    
    // Update driver markers on map
    function updateDriverMarkers(locations) {
        if (locations) {
            Object.keys(locations).forEach(driverId => {
                const location = locations[driverId];
                const driver = driversData[driverId];
                
                if (driver && location.latitude && location.longitude) {
                    // Remove existing marker if present
                    if (driverMarkers[driverId]) {
                        managerMap.removeLayer(driverMarkers[driverId]);
                    }
                    
                    // Create marker for driver
                    const marker = L.marker([location.latitude, location.longitude], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: `<div class="driver-marker">${getVehicleIcon(driver.vehicle?.type)}</div><div class="driver-marker-label">${driver.name || 'Driver'}</div>`,
                            iconSize: [35, 50]
                        })
                    }).addTo(managerMap)
                        .bindPopup(createDriverPopup(driver, location));
                    
                    driverMarkers[driverId] = marker;
                }
            });
            
            // Fit map to show all drivers if there are any
            if (Object.keys(driverMarkers).length > 0) {
                const group = new L.featureGroup(Object.values(driverMarkers));
                managerMap.fitBounds(group.getBounds(), { padding: [20, 20] });
            }
        }
    }
    
    // Update driver markers on full screen map
    function updateFullScreenDriverMarkers(locations) {
        if (locations) {
            Object.keys(locations).forEach(driverId => {
                const location = locations[driverId];
                const driver = driversData[driverId];
                
                if (driver && location.latitude && location.longitude) {
                    // Create marker for driver
                    const marker = L.marker([location.latitude, location.longitude], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: `<div class="driver-marker">${getVehicleIcon(driver.vehicle?.type)}</div><div class="driver-marker-label">${driver.name || 'Driver'}</div>`,
                            iconSize: [35, 50]
                        })
                    }).addTo(fullScreenMap)
                        .bindPopup(createDriverPopup(driver, location));
                }
            });
        }
    }
    
    // Update active ride markers
    function updateActiveRideMarkers(rides) {
        if (rides) {
            Object.keys(rides).forEach(rideId => {
                const ride = rides[rideId];
                
                // Remove existing markers and polylines if present
                if (activeRideMarkers[rideId]) {
                    managerMap.removeLayer(activeRideMarkers[rideId]);
                    delete activeRideMarkers[rideId];
                }
                
                if (activeRidePolylines[rideId]) {
                    managerMap.removeLayer(activeRidePolylines[rideId]);
                    delete activeRidePolylines[rideId];
                }
                
                // Create marker for active ride
                if (ride.pickupLat && ride.pickupLng) {
                    const marker = L.marker([ride.pickupLat, ride.pickupLng], {
                        icon: L.divIcon({
                            className: 'active-ride-marker',
                            html: `<div class="active-ride-marker"></div><div class="active-ride-marker-label">Active Ride</div>`,
                            iconSize: [40, 55]
                        })
                    }).addTo(managerMap)
                        .bindPopup(createActiveRidePopup(ride));
                    
                    activeRideMarkers[rideId] = marker;
                    
                    // Draw route if destination coordinates are available
                    if (ride.destLat && ride.destLng) {
                        drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng, rideId);
                    }
                }
            });
        }
    }
    
    // Update active ride markers on full screen map
    function updateFullScreenActiveRideMarkers(rides) {
        if (rides) {
            Object.keys(rides).forEach(rideId => {
                const ride = rides[rideId];
                
                // Create marker for active ride
                if (ride.pickupLat && ride.pickupLng) {
                    const marker = L.marker([ride.pickupLat, ride.pickupLng], {
                        icon: L.divIcon({
                            className: 'active-ride-marker',
                            html: `<div class="active-ride-marker"></div><div class="active-ride-marker-label">Active Ride</div>`,
                            iconSize: [40, 55]
                        })
                    }).addTo(fullScreenMap)
                        .bindPopup(createActiveRidePopup(ride));
                    
                    // Draw route if destination coordinates are available
                    if (ride.destLat && ride.destLng) {
                        drawFullScreenRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng, rideId);
                    }
                }
            });
        }
    }
    
    // Update SOS markers on map
    function updateSOSMarkers(alerts) {
        if (alerts) {
            Object.keys(alerts).forEach(alertId => {
                const alert = alerts[alertId];
                
                // Remove existing marker if present
                if (sosMarkers[alertId]) {
                    managerMap.removeLayer(sosMarkers[alertId]);
                    delete sosMarkers[alertId];
                }
                
                // Create marker for SOS alert
                if (alert.location && alert.location.lat && alert.location.lng) {
                    const marker = L.marker([alert.location.lat, alert.location.lng], {
                        icon: L.divIcon({
                            className: 'sos-marker',
                            html: `<div class="sos-marker">SOS</div><div class="sos-marker-label">${alert.passengerName || alert.driverName || 'User'}</div>`,
                            iconSize: [45, 60]
                        })
                    }).addTo(managerMap)
                        .bindPopup(createSOSPopup(alert));
                    
                    sosMarkers[alertId] = marker;
                    
                    // Flash screen red for urgent SOS alerts
                    if (alert.urgent) {
                        flashScreenRed();
                    }
                }
            });
        }
    }
    
    // Update SOS markers on full screen map
    function updateFullScreenSOSMarkers(alerts) {
        if (alerts) {
            Object.keys(alerts).forEach(alertId => {
                const alert = alerts[alertId];
                
                // Create marker for SOS alert
                if (alert.location && alert.location.lat && alert.location.lng) {
                    const marker = L.marker([alert.location.lat, alert.location.lng], {
                        icon: L.divIcon({
                            className: 'sos-marker',
                            html: `<div class="sos-marker">SOS</div><div class="sos-marker-label">${alert.passengerName || alert.driverName || 'User'}</div>`,
                            iconSize: [45, 60]
                        })
                    }).addTo(fullScreenMap)
                        .bindPopup(createSOSPopup(alert));
                }
            });
        }
    }
    
    // Flash screen red for SOS alerts
    function flashScreenRed() {
        const banner = document.getElementById('sosAlertBanner');
        banner.style.display = 'block';
        
        // Flash the screen red
        document.body.style.backgroundColor = 'rgba(231, 76, 60, 0.1)';
        setTimeout(() => {
            document.body.style.backgroundColor = '';
        }, 1000);
        
        // Show notification
        showNotification('URGENT: SOS Alert Received!', 'error');
    }
    
    // Draw route on map
    function drawRoute(startLat, startLng, endLat, endLng, rideId) {
        // Use OSRM API to get route
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    // Draw the route on the map
                    activeRidePolylines[rideId] = L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(managerMap);
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
                // Fallback: draw a straight line
                activeRidePolylines[rideId] = L.polyline([
                    [startLat, startLng],
                    [endLat, endLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7
                }).addTo(managerMap);
            });
    }
    
    // Draw route on full screen map
    function drawFullScreenRoute(startLat, startLng, endLat, endLng, rideId) {
        // Use OSRM API to get route
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    // Draw the route on the map
                    L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(fullScreenMap);
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
                // Fallback: draw a straight line
                L.polyline([
                    [startLat, startLng],
                    [endLat, endLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7
                }).addTo(fullScreenMap);
            });
    }
    
    // Get vehicle icon based on type
    function getVehicleIcon(vehicleType) {
        switch(vehicleType) {
            case 'car': return '';
            case 'bike': return '';
            case 'bicycle': return '';
            default: return '';
        }
    }
    
    // Create driver popup content
    function createDriverPopup(driver, location) {
        return `
            <div>
                <strong>${driver.name || 'Driver'}</strong><br>
                ${driver.vehicle?.type || 'Vehicle'} - ${driver.vehicle?.licensePlate || 'N/A'}<br>
                Status: ${driver.isOnline ? 'Online' : 'Offline'}<br>
                Rating: ${driver.rating || 'N/A'}<br>
                <button onclick="showDriverDetails('${driver.uid}')" style="margin-top: 5px; padding: 5px 10px; background: #FF6B35; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
            </div>
        `;
    }
    
    // Create active ride popup content
    function createActiveRidePopup(ride) {
        return `
            <div>
                <strong>Active Ride</strong><br>
                Passenger: ${ride.passengerName || 'N/A'}<br>
                Driver: ${ride.driverId ? 'Assigned' : 'Not assigned'}<br>
                From: ${ride.pickupLocation || 'N/A'}<br>
                To: ${ride.destination || 'N/A'}<br>
                Fare: K${ride.fare ? ride.fare.toFixed(2) : '0.00'}<br>
                <button onclick="showRideDetails('${ride.id}')" style="margin-top: 5px; padding: 5px 10px; background: #FF6B35; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
            </div>
        `;
    }
    
    // Create SOS popup content
    function createSOSPopup(alert) {
        return `
            <div>
                <strong style="color: #e74c3c;">SOS ALERT</strong><br>
                ${alert.passengerName ? 'Passenger: ' + alert.passengerName : 'Driver: ' + alert.driverName}<br>
                Time: ${new Date(alert.timestamp).toLocaleTimeString()}<br>
                <button onclick="showSOSDetails('${alert.id}')" style="margin-top: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
            </div>
        `;
    }
    
    // Event listeners setup
    function setupEventListeners() {
        // Statistics dropdown button
        document.getElementById('statsDropdownBtn').addEventListener('click', function() {
            this.classList.toggle('active');
            document.getElementById('statsContainer').classList.toggle('active');
        });
        
        // Bottom navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                switchTab(tabId);
            });
        });
        
        // Report tabs
        document.querySelectorAll('.enhanced-tab[data-report]').forEach(tab => {
            tab.addEventListener('click', function() {
                const reportId = this.getAttribute('data-report');
                switchReport(reportId);
            });
        });
        
        // Search buttons
        document.getElementById('driverSearchBtn').addEventListener('click', searchDrivers);
        document.getElementById('passengerSearchBtn').addEventListener('click', searchPassengers);
        document.getElementById('rideSearchBtn').addEventListener('click', searchRides);
        document.getElementById('sosSearchBtn').addEventListener('click', searchSOSAlerts);
        
        // Filter changes
        document.getElementById('driverStatusFilter').addEventListener('change', filterDrivers);
        document.getElementById('driverVehicleFilter').addEventListener('change', filterDrivers);
        document.getElementById('driverRatingFilter').addEventListener('change', filterDrivers);
        document.getElementById('driverVerifiedFilter').addEventListener('click', toggleDriverVerifiedFilter);
        
        document.getElementById('passengerStatusFilter').addEventListener('change', filterPassengers);
        document.getElementById('passengerRidesFilter').addEventListener('change', filterPassengers);
        document.getElementById('passengerReferralFilter').addEventListener('click', togglePassengerReferralFilter);
        
        document.getElementById('rideStatusFilter').addEventListener('change', filterRides);
        document.getElementById('rideTypeFilter').addEventListener('change', filterRides);
        document.getElementById('rideDateFilter').addEventListener('change', filterRides);
        document.getElementById('rideHighValueFilter').addEventListener('click', toggleRideHighValueFilter);
        
        document.getElementById('sosStatusFilter').addEventListener('change', filterSOSAlerts);
        document.getElementById('sosTypeFilter').addEventListener('change', filterSOSAlerts);
        document.getElementById('sosDateFilter').addEventListener('change', filterSOSAlerts);
        document.getElementById('sosUrgentFilter').addEventListener('click', toggleSOSUrgentFilter);
        
        document.getElementById('reportPeriod').addEventListener('change', loadReports);
        document.getElementById('reportCity').addEventListener('change', loadReports);
        document.getElementById('exportReportBtn').addEventListener('click', exportReports);
        
        // Map controls
        document.getElementById('zoomInBtn').addEventListener('click', () => managerMap.zoomIn());
        document.getElementById('zoomOutBtn').addEventListener('click', () => managerMap.zoomOut());
        document.getElementById('centerMapBtn').addEventListener('click', centerMap);
        document.getElementById('toggleFullScreenBtn').addEventListener('click', toggleFullScreenMap);
        document.getElementById('refreshMapBtn').addEventListener('click', refreshMap);
        document.getElementById('toggleDriversBtn').addEventListener('click', toggleDriversVisibility);
        document.getElementById('toggleRidesBtn').addEventListener('click', toggleRidesVisibility);
        document.getElementById('toggleSOSBtn').addEventListener('click', toggleSOSVisibility);
        
        // Full screen map controls
        document.getElementById('fullScreenZoomInBtn').addEventListener('click', () => fullScreenMap.zoomIn());
        document.getElementById('fullScreenZoomOutBtn').addEventListener('click', () => fullScreenMap.zoomOut());
        document.getElementById('fullScreenCenterBtn').addEventListener('click', centerFullScreenMap);
        document.getElementById('exitFullScreenBtn').addEventListener('click', exitFullScreenMap);
        
        // Modal close buttons
        document.getElementById('closeDriverModal').addEventListener('click', closeDriverModal);
        document.getElementById('closePassengerModal').addEventListener('click', closePassengerModal);
        document.getElementById('closeRideModal').addEventListener('click', closeRideModal);
        document.getElementById('closeRideMapModal').addEventListener('click', closeRideMapModal);
        document.getElementById('closeSOSModal').addEventListener('click', closeSOSModal);
        document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
        document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettingsModal);
        
        // Action buttons
        document.getElementById('editDriverBtn').addEventListener('click', editDriver);
        document.getElementById('suspendDriverBtn').addEventListener('click', suspendDriver);
        document.getElementById('trackDriverBtn').addEventListener('click', trackDriver);
        document.getElementById('verifyDriverBtn').addEventListener('click', verifyDriver);
        
        document.getElementById('editPassengerBtn').addEventListener('click', editPassenger);
        document.getElementById('suspendPassengerBtn').addEventListener('click', suspendPassenger);
        document.getElementById('viewRidesBtn').addEventListener('click', viewPassengerRides);
        
        document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
        document.getElementById('reassignRideBtn').addEventListener('click', reassignRide);
        document.getElementById('trackRideBtn').addEventListener('click', trackRide);
        document.getElementById('viewRideMapBtn').addEventListener('click', viewRideMap);
        
        document.getElementById('resolveSOSBtn').addEventListener('click', resolveSOSAlert);
        document.getElementById('contactSOSBtn').addEventListener('click', contactSOSAlert);
        document.getElementById('trackSOSBtn').addEventListener('click', trackSOSAlert);
        
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        
        // Settings button in header
        document.getElementById('userAvatar').addEventListener('click', openSettings);
        
        // View more details for rides
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('view-more-details')) {
                const rideId = e.target.getAttribute('data-ride-id');
                toggleRideDetails(rideId);
            }
        });
        
        // Ride map controls
        document.getElementById('rideMapZoomIn').addEventListener('click', () => rideMap.zoomIn());
        document.getElementById('rideMapZoomOut').addEventListener('click', () => rideMap.zoomOut());
        
        // NEW: Application approval/rejection
        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('approve-application-btn')) {
                const driverId = e.target.getAttribute('data-driver-id');
                approveDriverApplication(driverId);
            }
            if (e.target && e.target.classList.contains('reject-application-btn')) {
                const driverId = e.target.getAttribute('data-driver-id');
                rejectDriverApplication(driverId);
            }
            if (e.target && e.target.classList.contains('view-documents-btn')) {
                const driverId = e.target.getAttribute('data-driver-id');
                viewDriverDocuments(driverId);
            }
        });
    }
    
    // Setup stats dropdowns
    function setupStatsDropdowns() {
        const statCards = document.querySelectorAll('.stat-card');
        
        statCards.forEach(card => {
            card.addEventListener('click', function(e) {
                // Close all other dropdowns
                document.querySelectorAll('.stats-dropdown').forEach(dropdown => {
                    if (dropdown !== this.querySelector('.stats-dropdown')) {
                        dropdown.classList.remove('active');
                    }
                });
                
                // Toggle current dropdown
                const dropdown = this.querySelector('.stats-dropdown');
                if (dropdown) {
                    dropdown.classList.toggle('active');
                    
                    // Position dropdown
                    const rect = this.getBoundingClientRect();
                    dropdown.style.top = `${rect.bottom + 5}px`;
                    dropdown.style.left = `${rect.left}px`;
                }
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.stat-card')) {
                document.querySelectorAll('.stats-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });
    }
    
    // Tab switching
    function switchTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabId).classList.add('active');
        
        // Update active nav item
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');
        
        // Load data for specific tabs
        if (tabId === 'driversTab') {
            loadDriversData();
        } else if (tabId === 'passengersTab') {
            loadPassengersData();
        } else if (tabId === 'ridesTab') {
            loadRidesData();
        } else if (tabId === 'reportsTab') {
            loadReports();
        } else if (tabId === 'sosAlertsTab') {
            loadSOSAlerts();
        } else if (tabId === 'dashboardTab') {
            loadDashboardData();
        }
    }
    
    // Report switching
    function switchReport(reportId) {
        // Hide all report contents
        document.querySelectorAll('.report-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Show selected report content
        document.getElementById(reportId + 'Report').classList.add('active');
        
        // Update active tab
        document.querySelectorAll('.enhanced-tab[data-report]').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.enhanced-tab[data-report="${reportId}"]`).classList.add('active');
    }
    
    // Center map on all markers
    function centerMap() {
        if (Object.keys(driverMarkers).length > 0) {
            const group = new L.featureGroup(Object.values(driverMarkers));
            managerMap.fitBounds(group.getBounds(), { padding: [20, 20] });
        } else {
            // Default to Lusaka if no drivers
            managerMap.setView([-15.4167, 28.2833], 13);
        }
    }
    
    // Center full screen map
    function centerFullScreenMap() {
        if (Object.keys(driverMarkers).length > 0) {
            const group = new L.featureGroup(Object.values(driverMarkers));
            fullScreenMap.fitBounds(group.getBounds(), { padding: [20, 20] });
        } else {
            // Default to Lusaka if no drivers
            fullScreenMap.setView([-15.4167, 28.2833], 13);
        }
    }
    
    // Toggle full screen map
    function toggleFullScreenMap() {
        document.getElementById('fullScreenMap').classList.add('active');
        // Refresh the full screen map to ensure it displays correctly
        setTimeout(() => {
            fullScreenMap.invalidateSize();
        }, 100);
    }
    
    // Exit full screen map
    function exitFullScreenMap() {
        document.getElementById('fullScreenMap').classList.remove('active');
    }
    
    // Refresh map data
    function refreshMap() {
        loadDriversData();
        loadRidesData();
        loadSOSAlerts();
        showNotification('Map data refreshed');
    }
    
    // Toggle drivers visibility
    function toggleDriversVisibility() {
        const isVisible = Object.values(driverMarkers).some(marker => managerMap.hasLayer(marker));
        
        Object.values(driverMarkers).forEach(marker => {
            if (isVisible) {
                managerMap.removeLayer(marker);
            } else {
                marker.addTo(managerMap);
            }
        });
        
        showNotification(isVisible ? 'Drivers hidden' : 'Drivers visible');
    }
    
    // Toggle rides visibility
    function toggleRidesVisibility() {
        const isVisible = Object.values(activeRideMarkers).some(marker => managerMap.hasLayer(marker));
        
        Object.values(activeRideMarkers).forEach(marker => {
            if (isVisible) {
                managerMap.removeLayer(marker);
            } else {
                marker.addTo(managerMap);
            }
        });
        
        Object.values(activeRidePolylines).forEach(polyline => {
            if (isVisible) {
                managerMap.removeLayer(polyline);
            } else {
                polyline.addTo(managerMap);
            }
        });
        
        showNotification(isVisible ? 'Active rides hidden' : 'Active rides visible');
    }
    
    // Toggle SOS alerts visibility
    function toggleSOSVisibility() {
        const isVisible = Object.values(sosMarkers).some(marker => managerMap.hasLayer(marker));
        
        Object.values(sosMarkers).forEach(marker => {
            if (isVisible) {
                managerMap.removeLayer(marker);
            } else {
                marker.addTo(managerMap);
            }
        });
        
        showNotification(isVisible ? 'SOS alerts hidden' : 'SOS alerts visible');
    }
    
    // Load dashboard data
    function loadDashboardData() {
        // Load total rides
        database.ref('rides').once('value')
            .then(snapshot => {
                const rides = snapshot.val();
                const totalRides = rides ? Object.keys(rides).length : 0;
                document.getElementById('totalRides').textContent = totalRides;
                statsData.totalRides = totalRides;
                
                // Calculate active rides and other stats
                let activeRides = 0;
                let totalEarnings = 0;
                let todayEarnings = 0;
                let completedRides = 0;
                let cancelledRides = 0;
                let requestedRides = 0;
                let acceptedRides = 0;
                let startedRides = 0;
                let arrivedRides = 0;
                let pickedUpRides = 0;
                let ridesToday = 0;
                let commissionToday = 0;
                let totalFareToday = 0;
                let expressDeliveries = 0;
                let ordersForSomeone = 0;
                
                const today = new Date();
                
                if (rides) {
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        
                        // Count by status
                        if (ride.status === 'accepted' || ride.status === 'started' || ride.status === 'arrived' || ride.status === 'picked_up') {
                            activeRides++;
                        }
                        
                        if (ride.status === 'completed' && ride.fare) {
                            completedRides++;
                            totalEarnings += ride.fare;
                            
                            // Check if completed today
                            if (ride.completedAt) {
                                const completedDate = new Date(ride.completedAt);
                                if (completedDate.toDateString() === today.toDateString()) {
                                    ridesToday++;
                                    todayEarnings += ride.fare;
                                    totalFareToday += ride.fare;
                                    commissionToday += ride.fare * 0.08; // 8% commission
                                }
                            }
                        } else if (ride.status === 'cancelled') {
                            cancelledRides++;
                        } else if (ride.status === 'requested') {
                            requestedRides++;
                        } else if (ride.status === 'accepted') {
                            acceptedRides++;
                        } else if (ride.status === 'started') {
                            startedRides++;
                        } else if (ride.status === 'arrived') {
                            arrivedRides++;
                        } else if (ride.status === 'picked_up') {
                            pickedUpRides++;
                        }
                        
                        // Count special ride types
                        if (ride.expressDelivery) {
                            expressDeliveries++;
                        }
                        
                        if (ride.orderForSomeone) {
                            ordersForSomeone++;
                        }
                    });
                }
                
                document.getElementById('activeRides').textContent = activeRides;
                document.getElementById('todayEarnings').textContent = `K${todayEarnings.toFixed(2)}`;
                statsData.activeRides = activeRides;
                statsData.todayEarnings = todayEarnings;
                statsData.completedRides = completedRides;
                statsData.cancelledRides = cancelledRides;
                statsData.requestedRides = requestedRides;
                statsData.acceptedRides = acceptedRides;
                statsData.startedRides = startedRides;
                statsData.arrivedRides = arrivedRides;
                statsData.pickedUpRides = pickedUpRides;
                statsData.ridesToday = ridesToday;
                statsData.commissionToday = commissionToday;
                statsData.avgFareToday = ridesToday > 0 ? totalFareToday / ridesToday : 0;
                statsData.expressDeliveries = expressDeliveries;
                statsData.ordersForSomeone = ordersForSomeone;
                
                // Update enhanced stats
                document.getElementById('expressDeliveries').textContent = expressDeliveries;
                document.getElementById('ordersForSomeone').textContent = ordersForSomeone;
                
                // Update dropdown stats
                updateStatsDropdowns();
                
                // Calculate app earnings (8% of all completed rides)
                appEarnings = totalEarnings * 0.08;
                document.getElementById('appEarnings').textContent = `K${appEarnings.toFixed(2)}`;
                
                // Load recent activity
                loadRecentActivity(rides);
                
                // Load top performers
                loadTopPerformers(rides);
            })
            .catch(error => {
                console.error('Error loading rides:', error);
            });
        
        // Load drivers data
        database.ref('users').orderByChild('userType').equalTo('driver').once('value')
            .then(snapshot => {
                const drivers = snapshot.val();
                const totalDrivers = drivers ? Object.keys(drivers).length : 0;
                document.getElementById('totalDrivers').textContent = totalDrivers;
                statsData.totalDrivers = totalDrivers;
                
                // Calculate driver statistics
                let onlineDrivers = 0;
                let offlineDrivers = 0;
                let suspendedDrivers = 0;
                let carDrivers = 0;
                let bikeDrivers = 0;
                let bicycleDrivers = 0;
                let onlineCarDrivers = 0;
                let onlineBikeDrivers = 0;
                let onlineBicycleDrivers = 0;
                let totalRating = 0;
                let ratedDrivers = 0;
                
                if (drivers) {
                    Object.keys(drivers).forEach(driverId => {
                        const driver = drivers[driverId];
                        
                        // Count by status
                        if (driver.isOnline) {
                            onlineDrivers++;
                            
                            // Count by vehicle type for online drivers
                            if (driver.vehicle && driver.vehicle.type === 'car') {
                                onlineCarDrivers++;
                            } else if (driver.vehicle && driver.vehicle.type === 'bike') {
                                onlineBikeDrivers++;
                            } else if (driver.vehicle && driver.vehicle.type === 'bicycle') {
                                onlineBicycleDrivers++;
                            }
                        } else {
                            offlineDrivers++;
                        }
                        
                        if (driver.isSuspended) {
                            suspendedDrivers++;
                        }
                        
                        // Count by vehicle type
                        if (driver.vehicle) {
                            if (driver.vehicle.type === 'car') {
                                carDrivers++;
                            } else if (driver.vehicle.type === 'bike') {
                                bikeDrivers++;
                            } else if (driver.vehicle.type === 'bicycle') {
                                bicycleDrivers++;
                            }
                        }
                        
                        // Calculate average rating
                        if (driver.rating) {
                            totalRating += driver.rating;
                            ratedDrivers++;
                        }
                    });
                }
                
                document.getElementById('onlineDrivers').textContent = onlineDrivers;
                statsData.onlineDrivers = onlineDrivers;
                statsData.offlineDrivers = offlineDrivers;
                statsData.suspendedDrivers = suspendedDrivers;
                statsData.carDrivers = carDrivers;
                statsData.bikeDrivers = bikeDrivers;
                statsData.bicycleDrivers = bicycleDrivers;
                statsData.onlineCarDrivers = onlineCarDrivers;
                statsData.onlineBikeDrivers = onlineBikeDrivers;
                statsData.onlineBicycleDrivers = onlineBicycleDrivers;
                statsData.avgDriverRating = ratedDrivers > 0 ? totalRating / ratedDrivers : 0;
                
                // Update dropdown stats
                updateStatsDropdowns();
            })
            .catch(error => {
                console.error('Error loading drivers:', error);
            });
        
        // Load passengers data
        database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
            .then(snapshot => {
                const passengers = snapshot.val();
                const totalPassengers = passengers ? Object.keys(passengers).length : 0;
                document.getElementById('totalPassengers').textContent = totalPassengers;
                statsData.totalPassengers = totalPassengers;
                
                // Calculate passenger statistics
                let activePassengers = 0;
                let suspendedPassengers = 0;
                let totalRating = 0;
                let ratedPassengers = 0;
                let totalRides = 0;
                
                if (passengers) {
                    Object.keys(passengers).forEach(passengerId => {
                        const passenger = passengers[passengerId];
                        
                        // Count by status
                        if (passenger.isSuspended) {
                            suspendedPassengers++;
                        } else {
                            activePassengers++;
                        }
                        
                        // Calculate average rating
                        if (passenger.rating) {
                            totalRating += passenger.rating;
                            ratedPassengers++;
                        }
                        
                        // Calculate total rides
                        if (passenger.totalRides) {
                            totalRides += passenger.totalRides;
                        }
                    });
                }
                
                statsData.activePassengers = activePassengers;
                statsData.suspendedPassengers = suspendedPassengers;
                statsData.avgPassengerRating = ratedPassengers > 0 ? totalRating / ratedPassengers : 0;
                statsData.avgPassengerRides = totalPassengers > 0 ? totalRides / totalPassengers : 0;
                
                // Update dropdown stats
                updateStatsDropdowns();
            })
            .catch(error => {
                console.error('Error loading passengers:', error);
            });
        
        // Load SOS alerts count
        database.ref('sosAlerts').orderByChild('resolved').equalTo(false).once('value')
            .then(snapshot => {
                const alerts = snapshot.val();
                const sosAlertsCount = alerts ? Object.keys(alerts).length : 0;
                document.getElementById('sosAlertsCount').textContent = sosAlertsCount;
                document.getElementById('sosAlertsBadge').textContent = sosAlertsCount;
                statsData.sosAlertsCount = sosAlertsCount;
            })
            .catch(error => {
                console.error('Error loading SOS alerts:', error);
            });
    }
    
    // Load top performers (drivers and passengers with most rides)
    function loadTopPerformers(rides) {
        // Load top drivers
        database.ref('users').orderByChild('userType').equalTo('driver').once('value')
            .then(snapshot => {
                const drivers = snapshot.val();
                const driverRides = {};
                
                // Count rides for each driver
                if (rides) {
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        if (ride.driverId && ride.status === 'completed') {
                            if (!driverRides[ride.driverId]) {
                                driverRides[ride.driverId] = 0;
                            }
                            driverRides[ride.driverId]++;
                        }
                    });
                }
                
                // Sort drivers by number of rides
                const topDrivers = Object.keys(drivers)
                    .map(driverId => ({
                        id: driverId,
                        name: drivers[driverId].name || 'Driver',
                        rides: driverRides[driverId] || 0,
                        rating: drivers[driverId].rating || 0
                    }))
                    .sort((a, b) => b.rides - a.rides)
                    .slice(0, 5);
                
                // Update top drivers list
                const topDriversList = document.getElementById('topDriversList');
                topDriversList.innerHTML = '';
                
                topDrivers.forEach((driver, index) => {
                    const driverItem = document.createElement('div');
                    driverItem.className = 'top-performer-item';
                    driverItem.innerHTML = `
                        <div>
                            <span class="top-performer-name">${index + 1}. ${driver.name}</span>
                            <div style="font-size: 0.6rem; color: var(--medium-gray);">Rating: ${driver.rating.toFixed(1)} </div>
                        </div>
                        <div class="top-performer-value">${driver.rides} rides</div>
                    `;
                    topDriversList.appendChild(driverItem);
                });
            });
        
        // Load top passengers
        database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
            .then(snapshot => {
                const passengers = snapshot.val();
                const passengerRides = {};
                
                // Count rides for each passenger
                if (rides) {
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        if (ride.passengerId && ride.status === 'completed') {
                            if (!passengerRides[ride.passengerId]) {
                                passengerRides[ride.passengerId] = 0;
                            }
                            passengerRides[ride.passengerId]++;
                        }
                    });
                }
                
                // Sort passengers by number of rides
                const topPassengers = Object.keys(passengers)
                    .map(passengerId => ({
                        id: passengerId,
                        name: passengers[passengerId].name || 'Passenger',
                        rides: passengerRides[passengerId] || 0,
                        rating: passengers[passengerId].rating || 0
                    }))
                    .sort((a, b) => b.rides - a.rides)
                    .slice(0, 5);
                
                // Update top passengers list
                const topPassengersList = document.getElementById('topPassengersList');
                topPassengersList.innerHTML = '';
                
                topPassengers.forEach((passenger, index) => {
                    const passengerItem = document.createElement('div');
                    passengerItem.className = 'top-performer-item';
                    passengerItem.innerHTML = `
                        <div>
                            <span class="top-performer-name">${index + 1}. ${passenger.name}</span>
                            <div style="font-size: 0.6rem; color: var(--medium-gray);">Rating: ${passenger.rating.toFixed(1)} </div>
                        </div>
                        <div class="top-performer-value">${passenger.rides} rides</div>
                    `;
                    topPassengersList.appendChild(passengerItem);
                });
            });
    }
    
    // Update stats dropdowns with current data
    function updateStatsDropdowns() {
        // Total Rides dropdown
        document.getElementById('completedRides').textContent = statsData.completedRides;
        document.getElementById('cancelledRides').textContent = statsData.cancelledRides;
        document.getElementById('activeRidesCount').textContent = statsData.activeRides;
        document.getElementById('requestedRides').textContent = statsData.requestedRides;
        
        // Active Rides dropdown
        document.getElementById('acceptedRides').textContent = statsData.acceptedRides;
        document.getElementById('startedRides').textContent = statsData.startedRides;
        document.getElementById('arrivedRides').textContent = statsData.arrivedRides;
        document.getElementById('pickedUpRides').textContent = statsData.pickedUpRides;
        
        // Total Drivers dropdown
        document.getElementById('onlineDriversCount').textContent = statsData.onlineDrivers;
        document.getElementById('offlineDrivers').textContent = statsData.offlineDrivers;
        document.getElementById('suspendedDrivers').textContent = statsData.suspendedDrivers;
        document.getElementById('carDrivers').textContent = statsData.carDrivers;
        document.getElementById('bikeDrivers').textContent = statsData.bikeDrivers;
        document.getElementById('bicycleDrivers').textContent = statsData.bicycleDrivers;
        
        // Online Drivers dropdown
        document.getElementById('onlineCarDrivers').textContent = statsData.onlineCarDrivers;
        document.getElementById('onlineBikeDrivers').textContent = statsData.onlineBikeDrivers;
        document.getElementById('onlineBicycleDrivers').textContent = statsData.onlineBicycleDrivers;
        document.getElementById('avgDriverRating').textContent = statsData.avgDriverRating.toFixed(1);
        
        // Total Passengers dropdown
        document.getElementById('activePassengers').textContent = statsData.activePassengers;
        document.getElementById('suspendedPassengers').textContent = statsData.suspendedPassengers;
        document.getElementById('avgPassengerRating').textContent = statsData.avgPassengerRating.toFixed(1);
        document.getElementById('avgPassengerRides').textContent = statsData.avgPassengerRides.toFixed(1);
        
        // Today's Earnings dropdown
        document.getElementById('ridesToday').textContent = statsData.ridesToday;
        document.getElementById('commissionToday').textContent = `K${statsData.commissionToday.toFixed(2)}`;
        document.getElementById('avgFareToday').textContent = `K${statsData.avgFareToday.toFixed(2)}`;
    }
    
    // Load recent activity for dashboard
    function loadRecentActivity(rides) {
        const recentActivityList = document.getElementById('recentActivityList');
        recentActivityList.innerHTML = '';
        
        if (rides) {
            // Sort rides by timestamp (newest first) and take the first 5
            const sortedRides = Object.keys(rides)
                .map(rideId => ({ id: rideId, ...rides[rideId] }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                .slice(0, 5);
            
            sortedRides.forEach(ride => {
                const activityItem = document.createElement('div');
                activityItem.className = 'list-item';
                
                const date = new Date(ride.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Determine ride type badge
                let rideTypeBadge = '';
                if (ride.expressDelivery) {
                    rideTypeBadge = '<span class="ride-type-badge express">Express Delivery</span>';
                } else if (ride.orderForSomeone) {
                    rideTypeBadge = '<span class="ride-type-badge order-for-someone">Order for Someone</span>';
                } else {
                    rideTypeBadge = '<span class="ride-type-badge standard">Standard Ride</span>';
                }
                
                activityItem.innerHTML = `
                    ${rideTypeBadge}
                    <div class="item-title">${ride.passengerName || 'Passenger'}  ${ride.destination || 'Destination'}</div>
                    <div class="item-details">
                        <span>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span>  
                        <span>${formattedDate} ${formattedTime}</span>  
                        <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                    </div>
                `;
                
                activityItem.addEventListener('click', function() {
                    showRideDetails(ride.id);
                });
                
                recentActivityList.appendChild(activityItem);
            });
        } else {
            recentActivityList.innerHTML = '<div class="card"><p>No recent activity found.</p></div>';
        }
    }

    // Load drivers data
    function loadDriversData() {
        database.ref('users').orderByChild('userType').equalTo('driver').once('value')
            .then(snapshot => {
                driversData = snapshot.val() || {};
                displayDrivers(driversData);
                
                // Update dashboard stats with driver data
                updateDriverStats(driversData);
            })
            .catch(error => {
                console.error('Error loading drivers:', error);
                showNotification('Error loading drivers data.', 'error');
            });
    }

    // Display drivers in the list
    function displayDrivers(drivers) {
        const driversList = document.getElementById('driversList');
        driversList.innerHTML = '';
        
        if (drivers && Object.keys(drivers).length > 0) {
            Object.keys(drivers).forEach(driverId => {
                const driver = drivers[driverId];
                
                // Skip pending applications in main driver list
                if (driver.registrationStatus === 'pending') {
                    return;
                }
                
                const driverItem = document.createElement('div');
                driverItem.className = 'list-item';
                
                const status = driver.isOnline ? 'online' : 'offline';
                const statusClass = driver.isOnline ? 'status-online' : 'status-offline';
                const verifiedBadge = driver.isVerified ? '<span class="status-badge status-completed" style="margin-left: 5px;">Verified</span>' : '';
                const registrationBadge = driver.registrationStatus === 'pending' ? 
                    '<span class="status-badge status-pending" style="margin-left: 5px;">Pending</span>' : '';
                
                driverItem.innerHTML = `
                    <div class="item-title">
                        ${driver.name || 'Unknown Driver'}
                        ${verifiedBadge}
                        ${registrationBadge}
                    </div>
                    <div class="item-details">
                        <span>${driver.vehicle?.type || 'Vehicle'}  ${driver.phone || 'N/A'}</span>
                        <span class="status-badge ${statusClass}">${status}</span>
                    </div>
                `;
                
                driverItem.addEventListener('click', function() {
                    showDriverDetails(driverId);
                });
                
                driversList.appendChild(driverItem);
            });
        } else {
            driversList.innerHTML = '<div class="card"><p>No drivers found.</p></div>';
        }
    }

    // Load passengers data
    function loadPassengersData() {
        database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
            .then(snapshot => {
                passengersData = snapshot.val() || {};
                displayPassengers(passengersData);
            })
            .catch(error => {
                console.error('Error loading passengers:', error);
                showNotification('Error loading passengers data.', 'error');
            });
    }

    // Display passengers in the list
    function displayPassengers(passengers) {
        const passengersList = document.getElementById('passengersList');
        passengersList.innerHTML = '';
        
        if (passengers && Object.keys(passengers).length > 0) {
            Object.keys(passengers).forEach(passengerId => {
                const passenger = passengers[passengerId];
                const passengerItem = document.createElement('div');
                passengerItem.className = 'list-item';
                
                const referralBadge = passenger.referralsCount ? `<span class="status-badge status-completed" style="margin-left: 5px;">${passenger.referralsCount} referrals</span>` : '';
                
                passengerItem.innerHTML = `
                    <div class="item-title">
                        ${passenger.name || 'Unknown Passenger'}
                        ${referralBadge}
                    </div>
                    <div class="item-details">
                        <span>${passenger.phone || 'N/A'}  ${passenger.email || 'N/A'}</span>
                        <span>Rides: ${passenger.totalRides || 0}</span>
                    </div>
                `;
                
                passengerItem.addEventListener('click', function() {
                    showPassengerDetails(passengerId);
                });
                
                passengersList.appendChild(passengerItem);
            });
        } else {
            passengersList.innerHTML = '<div class="card"><p>No passengers found.</p></div>';
        }
    }

    // Load rides data
    function loadRidesData() {
        database.ref('rides').once('value')
            .then(snapshot => {
                ridesData = snapshot.val() || {};
                displayRides(ridesData);
            })
            .catch(error => {
                console.error('Error loading rides:', error);
                showNotification('Error loading rides data.', 'error');
            });
    }

    // Display rides in the list
    function displayRides(rides) {
        const ridesList = document.getElementById('ridesList');
        ridesList.innerHTML = '';
        
        if (rides && Object.keys(rides).length > 0) {
            // Sort rides by timestamp (newest first)
            const sortedRides = Object.keys(rides)
                .map(rideId => ({ id: rideId, ...rides[rideId] }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            sortedRides.forEach(ride => {
                const rideItem = document.createElement('div');
                rideItem.className = 'list-item';
                
                const date = new Date(ride.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Determine if this is a delivery or a ride
                const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
                const typeClass = isDelivery ? 'delivery' : 'ride';
                const typeText = isDelivery ? 'Delivery' : 'Ride';
                
                // Determine ride type badge
                let rideTypeBadge = '';
                if (ride.expressDelivery) {
                    rideTypeBadge = '<span class="ride-type-badge express">Express Delivery</span>';
                } else if (ride.orderForSomeone) {
                    rideTypeBadge = '<span class="ride-type-badge order-for-someone">Order for Someone</span>';
                } else {
                    rideTypeBadge = `<span class="history-item-type ${typeClass}">${typeText}</span>`;
                }
                
                rideItem.innerHTML = `
                    ${rideTypeBadge}
                    <div class="item-title">${ride.passengerName || 'Passenger'}  ${ride.destination || 'Destination'}</div>
                    <div class="item-details">
                        <span>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}  ${formattedDate} ${formattedTime}</span>
                        <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                    </div>
                `;
                
                rideItem.addEventListener('click', function() {
                    showRideDetails(ride.id);
                });
                
                ridesList.appendChild(rideItem);
            });
        } else {
            ridesList.innerHTML = '<div class="card"><p>No rides found.</p></div>';
        }
    }

    // Load SOS alerts
    function loadSOSAlerts() {
        database.ref('sosAlerts').once('value')
            .then(snapshot => {
                sosAlertsData = snapshot.val() || {};
                displaySOSAlerts(sosAlertsData);
            })
            .catch(error => {
                console.error('Error loading SOS alerts:', error);
                showNotification('Error loading SOS alerts.', 'error');
            });
    }

    // Display SOS alerts in the list
    function displaySOSAlerts(alerts) {
        const sosAlertsList = document.getElementById('sosAlertsList');
        sosAlertsList.innerHTML = '';
        
        if (alerts && Object.keys(alerts).length > 0) {
            // Sort alerts by timestamp (newest first)
            const sortedAlerts = Object.keys(alerts)
                .map(alertId => ({ id: alertId, ...alerts[alertId] }))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            sortedAlerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'sos-alert-item';
                
                const date = new Date(alert.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const isResolved = alert.resolved || false;
                const resolvedClass = isResolved ? 'status-completed' : 'status-cancelled';
                const urgentBadge = alert.urgent ? '<span class="status-badge status-cancelled" style="margin-left: 5px;">URGENT</span>' : '';
                
                alertItem.innerHTML = `
                    <div class="sos-alert-item-header">
                        <div class="sos-alert-item-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${alert.passengerName ? 'Passenger SOS' : 'Driver SOS'}
                            ${urgentBadge}
                        </div>
                        <div class="sos-alert-item-time">${formattedDate} ${formattedTime}</div>
                    </div>
                    <div class="sos-alert-item-details">
                        <strong>${alert.passengerName || alert.driverName || 'User'}</strong> - ${alert.message || 'Emergency assistance needed'}
                    </div>
                    <div class="sos-alert-item-actions">
                        <button class="sos-alert-item-btn primary" data-alert-id="${alert.id}">
                            <i class="fas fa-eye"></i>
                            View Details
                        </button>
                        <button class="sos-alert-item-btn secondary" data-alert-id="${alert.id}">
                            <i class="fas fa-phone"></i>
                            Contact
                        </button>
                        ${!isResolved ? `
                        <button class="sos-alert-item-btn primary" data-alert-id="${alert.id}">
                            <i class="fas fa-check"></i>
                            Resolve
                        </button>
                        ` : ''}
                    </div>
                `;
                
                // Add event listeners to buttons
                alertItem.querySelectorAll('button').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const alertId = this.getAttribute('data-alert-id');
                        if (this.textContent.includes('View Details')) {
                            showSOSDetails(alertId);
                        } else if (this.textContent.includes('Contact')) {
                            contactSOSAlert(alertId);
                        } else if (this.textContent.includes('Resolve')) {
                            resolveSOSAlert(alertId);
                        }
                    });
                });
                
                sosAlertsList.appendChild(alertItem);
            });
        } else {
            sosAlertsList.innerHTML = '<div class="card"><p>No SOS alerts found.</p></div>';
        }
    }

    // NEW: Load pending driver applications
    function loadPendingApplications() {
        database.ref('users').orderByChild('registrationStatus').equalTo('pending').once('value')
            .then(snapshot => {
                pendingApplications = snapshot.val() || {};
                updateApplicationsBadge();
            })
            .catch(error => {
                console.error('Error loading pending applications:', error);
            });
    }

    // NEW: Load driver applications with all details
    function loadDriverApplications() {
        database.ref('users').orderByChild('userType').equalTo('driver').once('value')
            .then(snapshot => {
                const drivers = snapshot.val() || {};
                driverApplications = {};
                
                // Filter only pending applications
                Object.keys(drivers).forEach(driverId => {
                    const driver = drivers[driverId];
                    if (driver.registrationStatus === 'pending') {
                        driverApplications[driverId] = driver;
                    }
                });
                
                // Update applications count badge
                updateApplicationsBadge();
            })
            .catch(error => {
                console.error('Error loading driver applications:', error);
            });
    }

    // NEW: Update applications badge count
    function updateApplicationsBadge() {
        const pendingCount = Object.keys(pendingApplications).length;
        const applicationsBadge = document.getElementById('applicationsBadge');
        if (applicationsBadge) {
            applicationsBadge.textContent = pendingCount;
            applicationsBadge.style.display = pendingCount > 0 ? 'inline-block' : 'none';
        }
    }

    // NEW: Load driver documents
    function loadDriverDocuments() {
        // Listen for all driver documents
        database.ref('users').orderByChild('userType').equalTo('driver').on('value', snapshot => {
            const drivers = snapshot.val() || {};
            driverDocuments = {};
            
            Object.keys(drivers).forEach(driverId => {
                const driver = drivers[driverId];
                if (driver.images) {
                    driverDocuments[driverId] = driver.images;
                }
            });
        });
    }

    // Show driver details in modal - ENHANCED WITH ALL DRIVER INFORMATION
    function showDriverDetails(driverId) {
        const driver = driversData[driverId];
        if (!driver) return;
        
        selectedDriver = driverId;
        
        const driverDetailContent = document.getElementById('driverDetailContent');
        
        // Get vehicle details with proper null checks
        const vehicleType = driver.vehicle?.type || 'N/A';
        const vehicleMake = driver.vehicle?.make || 'N/A';
        const vehicleModel = driver.vehicle?.model || 'N/A';
        const licensePlate = driver.vehicle?.licensePlate || 'N/A';
        const licenseNumber = driver.vehicle?.licenseNumber || 'N/A';
        const vehicleColor = driver.vehicle?.color || 'N/A';
        const vehicleYear = driver.vehicle?.year || 'N/A';
        
        // Get payment details with proper null checks
        const paymentMethod = driver.payment?.method || 'N/A';
        const paymentDetails = driver.payment?.details || 'N/A';
        
        // Get driver statistics
        let totalRides = 0;
        let totalEarnings = 0;
        let completedRides = 0;
        let cancelledRides = 0;
        let acceptanceRate = driver.stats?.acceptanceRate || 0;
        let onlineTime = driver.stats?.totalOnlineTime || 0;
        
        // Calculate driver statistics from rides
        if (ridesData) {
            Object.keys(ridesData).forEach(rideId => {
                const ride = ridesData[rideId];
                if (ride.driverId === driverId) {
                    totalRides++;
                    if (ride.status === 'completed' && ride.fare) {
                        completedRides++;
                        totalEarnings += ride.fare * 0.92; // 92% for driver (8% commission)
                    } else if (ride.status === 'cancelled') {
                        cancelledRides++;
                    }
                }
            });
        }
        
        // Format online time
        const onlineHours = Math.floor(onlineTime / 60);
        const onlineMinutes = onlineTime % 60;
        const formattedOnlineTime = onlineHours > 0 ? `${onlineHours}h ${onlineMinutes}m` : `${onlineMinutes}m`;
        
        // NEW: Get driver documents if available
        const driverDocs = driverDocuments[driverId] || {};
        const hasDocuments = Object.keys(driverDocs).length > 0;
        
        driverDetailContent.innerHTML = `
            <div class="driver-registration-details">
                <div class="driver-registration-header">
                    <i class="fas fa-id-card"></i>
                    <h3>Driver Registration Details</h3>
                    ${driver.registrationStatus === 'pending' ? 
                        '<span class="status-badge status-pending" style="margin-left: 10px;">PENDING APPROVAL</span>' : ''}
                </div>
                <div class="driver-registration-grid">
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Full Name:</span>
                        <span class="driver-registration-value">${driver.name || 'N/A'}</span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Phone:</span>
                        <span class="driver-registration-value">${driver.phone || 'N/A'}</span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Email:</span>
                        <span class="driver-registration-value">${driver.email || 'N/A'}</span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">NRC:</span>
                        <span class="driver-registration-value">${driver.nrc || 'N/A'}</span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Date of Birth:</span>
                        <span class="driver-registration-value">${driver.dob || 'N/A'}</span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Address:</span>
                        <span class="driver-registration-value">${driver.address || 'N/A'}</span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Registration Status:</span>
                        <span class="driver-registration-value">
                            <span class="status-badge ${driver.registrationStatus === 'approved' ? 'status-completed' : 
                                driver.registrationStatus === 'rejected' ? 'status-cancelled' : 'status-pending'}">
                                ${driver.registrationStatus || 'Pending'}
                            </span>
                        </span>
                    </div>
                    <div class="driver-registration-item">
                        <span class="driver-registration-label">Registration Date:</span>
                        <span class="driver-registration-value">${driver.createdAt ? new Date(driver.createdAt).toLocaleDateString() : 'N/A'}</span>
                    </div>
                </div>
            </div>
            
            <div class="driver-details-card">
                <div class="driver-details-header">
                    <i class="fas fa-car"></i>
                    <h3>Vehicle Information</h3>
                </div>
                <div class="driver-details-grid">
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">Vehicle Type:</span>
                        <span class="driver-detail-value">${vehicleType}</span>
                    </div>
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">Make:</span>
                        <span class="driver-detail-value">${vehicleMake}</span>
                    </div>
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">Model:</span>
                        <span class="driver-detail-value">${vehicleModel}</span>
                    </div>
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">Year:</span>
                        <span class="driver-detail-value">${vehicleYear}</span>
                    </div>
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">Color:</span>
                        <span class="driver-detail-value">${vehicleColor}</span>
                    </div>
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">License Plate:</span>
                        <span class="driver-detail-value">${licensePlate}</span>
                    </div>
                    <div class="driver-detail-item">
                        <span class="driver-detail-label">Driver's License:</span>
                        <span class="driver-detail-value">${licenseNumber}</span>
                    </div>
                </div>
            </div>
            
            <div class="driver-documents-section">
                <div class="driver-documents-title">Document Verification</div>
                <div class="driver-documents-list">
                    <div class="driver-document-item">
                        <div class="driver-document-name">Driver's License</div>
                        <div class="driver-document-status ${driver.licenseVerified ? 'verified' : 'pending'}">
                            ${driver.licenseVerified ? 'Verified' : 'Pending'}
                        </div>
                        <div class="driver-document-actions">
                            ${hasDocuments && driverDocs.driversLicense ? `
                            <button class="driver-document-btn primary" data-doc="driversLicense" data-driver-id="${driverId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="driver-document-btn secondary" data-doc="driversLicense" data-driver-id="${driverId}">
                                <i class="fas fa-download"></i>
                            </button>
                            ` : '<span class="no-document">No document</span>'}
                        </div>
                    </div>
                    <div class="driver-document-item">
                        <div class="driver-document-name">Vehicle Registration</div>
                        <div class="driver-document-status ${driver.vehicleVerified ? 'verified' : 'pending'}">
                            ${driver.vehicleVerified ? 'Verified' : 'Pending'}
                        </div>
                        <div class="driver-document-actions">
                            ${hasDocuments && driverDocs.vehicleFront ? `
                            <button class="driver-document-btn primary" data-doc="vehicleFront" data-driver-id="${driverId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="driver-document-btn secondary" data-doc="vehicleFront" data-driver-id="${driverId}">
                                <i class="fas fa-download"></i>
                            </button>
                            ` : '<span class="no-document">No document</span>'}
                        </div>
                    </div>
                    <div class="driver-document-item">
                        <div class="driver-document-name">Insurance Certificate</div>
                        <div class="driver-document-status ${driver.insuranceVerified ? 'verified' : 'pending'}">
                            ${driver.insuranceVerified ? 'Verified' : 'Pending'}
                        </div>
                        <div class="driver-document-actions">
                            ${hasDocuments && driverDocs.insurance ? `
                            <button class="driver-document-btn primary" data-doc="insurance" data-driver-id="${driverId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="driver-document-btn secondary" data-doc="insurance" data-driver-id="${driverId}">
                                <i class="fas fa-download"></i>
                            </button>
                            ` : '<span class="no-document">No document</span>'}
                        </div>
                    </div>
                    <div class="driver-document-item">
                        <div class="driver-document-name">NRC Front</div>
                        <div class="driver-document-status ${driver.nrcVerified ? 'verified' : 'pending'}">
                            ${driver.nrcVerified ? 'Verified' : 'Pending'}
                        </div>
                        <div class="driver-document-actions">
                            ${hasDocuments && driverDocs.nrcFront ? `
                            <button class="driver-document-btn primary" data-doc="nrcFront" data-driver-id="${driverId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="driver-document-btn secondary" data-doc="nrcFront" data-driver-id="${driverId}">
                                <i class="fas fa-download"></i>
                            </button>
                            ` : '<span class="no-document">No document</span>'}
                        </div>
                    </div>
                    <div class="driver-document-item">
                        <div class="driver-document-name">NRC Back</div>
                        <div class="driver-document-status ${driver.nrcVerified ? 'verified' : 'pending'}">
                            ${driver.nrcVerified ? 'Verified' : 'Pending'}
                        </div>
                        <div class="driver-document-actions">
                            ${hasDocuments && driverDocs.nrcBack ? `
                            <button class="driver-document-btn primary" data-doc="nrcBack" data-driver-id="${driverId}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="driver-document-btn secondary" data-doc="nrcBack" data-driver-id="${driverId}">
                                <i class="fas fa-download"></i>
                            </button>
                            ` : '<span class="no-document">No document</span>'}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Account Information</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-badge ${driver.isOnline ? 'status-online' : 'status-offline'}">
                                ${driver.isOnline ? 'Online' : 'Offline'}
                            </span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Rating:</span>
                        <span class="detail-value">${driver.rating ? driver.rating.toFixed(1) + ' ' : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Rides:</span>
                        <span class="detail-value">${totalRides}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Completed Rides:</span>
                        <span class="detail-value">${completedRides}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cancelled Rides:</span>
                        <span class="detail-value">${cancelledRides}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Acceptance Rate:</span>
                        <span class="detail-value">${acceptanceRate}%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Earnings:</span>
                        <span class="detail-value">K${totalEarnings.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Online Time:</span>
                        <span class="detail-value">${formattedOnlineTime}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Float Balance:</span>
                        <span class="detail-value">K${driver.floatBalance || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Wallet Balance:</span>
                        <span class="detail-value">K${driver.walletBalance || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Joined:</span>
                        <span class="detail-value">${driver.createdAt ? new Date(driver.createdAt).toLocaleDateString() : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Online:</span>
                        <span class="detail-value">${driver.lastOnline ? new Date(driver.lastOnline).toLocaleString() : 'N/A'}</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Payment Information</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Method:</span>
                        <span class="detail-value">${paymentMethod}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Details:</span>
                        <span class="detail-value">${paymentDetails}</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Recent Rides</div>
                <div id="driverRecentRides">
                    <!-- Recent rides will be populated by JavaScript -->
                </div>
            </div>
            
            ${driver.registrationStatus === 'pending' ? `
            <div class="application-actions">
                <button class="action-btn btn-success" id="approveApplicationBtn">
                    <i class="fas fa-check-circle"></i>
                    Approve Application
                </button>
                <button class="action-btn btn-danger" id="rejectApplicationBtn">
                    <i class="fas fa-times-circle"></i>
                    Reject Application
                </button>
            </div>
            ` : ''}
        `;
        
        // Load driver's recent rides
        loadDriverRecentRides(driverId);
        
        // Update suspend button text based on current status
        const suspendBtn = document.getElementById('suspendDriverBtn');
        if (driver.isSuspended) {
            suspendBtn.innerHTML = '<i class="fas fa-check"></i> Activate';
            suspendBtn.classList.remove('btn-danger');
            suspendBtn.classList.add('btn-success');
        } else {
            suspendBtn.innerHTML = '<i class="fas fa-ban"></i> Suspend';
            suspendBtn.classList.remove('btn-success');
            suspendBtn.classList.add('btn-danger');
        }
        
        // Update verify button text based on current status
        const verifyBtn = document.getElementById('verifyDriverBtn');
        if (driver.isVerified) {
            verifyBtn.innerHTML = '<i class="fas fa-times"></i> Unverify';
            verifyBtn.classList.remove('btn-success');
            verifyBtn.classList.add('btn-warning');
        } else {
            verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify';
            verifyBtn.classList.remove('btn-warning');
            verifyBtn.classList.add('btn-success');
        }
        
        // Add event listeners to document buttons
        document.querySelectorAll('.driver-document-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const docType = this.getAttribute('data-doc');
                const driverId = this.getAttribute('data-driver-id');
                if (this.classList.contains('primary')) {
                    viewDriverDocument(driverId, docType);
                } else {
                    downloadDriverDocument(driverId, docType);
                }
            });
        });
        
        // NEW: Add event listeners for application approval/rejection
        if (driver.registrationStatus === 'pending') {
            document.getElementById('approveApplicationBtn').addEventListener('click', function() {
                approveDriverApplication(driverId);
            });
            
            document.getElementById('rejectApplicationBtn').addEventListener('click', function() {
                rejectDriverApplication(driverId);
            });
        }
        
        document.getElementById('driverDetailModal').classList.add('active');
    }

    // Show passenger details in modal - ENHANCED WITH ALL PASSENGER INFORMATION
    function showPassengerDetails(passengerId) {
        const passenger = passengersData[passengerId];
        if (!passenger) return;
        
        selectedPassenger = passengerId;
        
        const passengerDetailContent = document.getElementById('passengerDetailContent');
        
        // Calculate passenger statistics
        let totalRides = 0;
        let totalSpent = 0;
        let completedRides = 0;
        let cancelledRides = 0;
        
        // Calculate passenger statistics from rides
        if (ridesData) {
            Object.keys(ridesData).forEach(rideId => {
                const ride = ridesData[rideId];
                if (ride.passengerId === passengerId) {
                    totalRides++;
                    if (ride.status === 'completed' && ride.fare) {
                        completedRides++;
                        totalSpent += ride.fare;
                    } else if (ride.status === 'cancelled') {
                        cancelledRides++;
                    }
                }
            });
        }
        
        passengerDetailContent.innerHTML = `
            <div class="detail-row">
                <span class="detail-label">Name:</span>
                <span class="detail-value">${passenger.name || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Phone:</span>
                <span class="detail-value">${passenger.phone || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Email:</span>
                <span class="detail-value">${passenger.email || 'N/A'}</span>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Account Information</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-badge ${passenger.isSuspended ? 'status-cancelled' : 'status-completed'}">
                                ${passenger.isSuspended ? 'Suspended' : 'Active'}
                            </span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Rating:</span>
                        <span class="detail-value">${passenger.rating ? passenger.rating.toFixed(1) + ' ' : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Rides:</span>
                        <span class="detail-value">${totalRides}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Completed Rides:</span>
                        <span class="detail-value">${completedRides}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cancelled Rides:</span>
                        <span class="detail-value">${cancelledRides}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Total Spent:</span>
                        <span class="detail-value">K${totalSpent.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Wallet Balance:</span>
                        <span class="detail-value">K${passenger.walletBalance || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Login:</span>
                        <span class="detail-value">${passenger.lastLogin ? new Date(passenger.lastLogin).toLocaleDateString() : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Member Since:</span>
                        <span class="detail-value">${passenger.createdAt ? new Date(passenger.createdAt).toLocaleDateString() : 'N/A'}</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Address Information</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Home Address:</span>
                        <span class="detail-value">${passenger.homeAddress || 'Not set'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Work Address:</span>
                        <span class="detail-value">${passenger.workAddress || 'Not set'}</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Referral Information</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Referral Code:</span>
                        <span class="detail-value">${passenger.referralCode || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Referrals Count:</span>
                        <span class="detail-value">${passenger.referralsCount || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Referral Earnings:</span>
                        <span class="detail-value">K${passenger.referralEarnings || 0}</span>
                    </div>
                </div>
            </div>
            
            <div class="referral-code">
                ${passenger.referralCode || 'No referral code'}
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Recent Rides</div>
                <div id="passengerRecentRides">
                    <!-- Recent rides will be populated by JavaScript -->
                </div>
            </div>
        `;
        
        // Load passenger's recent rides
        loadPassengerRecentRides(passengerId);
        
        // Update suspend button text based on current status
        const suspendBtn = document.getElementById('suspendPassengerBtn');
        if (passenger.isSuspended) {
            suspendBtn.innerHTML = '<i class="fas fa-check"></i> Activate';
            suspendBtn.classList.remove('btn-danger');
            suspendBtn.classList.add('btn-success');
        } else {
            suspendBtn.innerHTML = '<i class="fas fa-ban"></i> Suspend';
            suspendBtn.classList.remove('btn-success');
            suspendBtn.classList.add('btn-danger');
        }
        
        document.getElementById('passengerDetailModal').classList.add('active');
    }

    // Show ride details in modal - ENHANCED WITH ALL RIDE INFORMATION
    function showRideDetails(rideId) {
        const ride = ridesData[rideId];
        if (!ride) return;
        
        selectedRide = rideId;
        
        const rideDetailContent = document.getElementById('rideDetailContent');
        const expandedDetails = document.getElementById('rideExpandedDetails');
        
        const date = new Date(ride.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Calculate commission (8%)
        const commission = ride.fare ? ride.fare * 0.08 : 0;
        const driverEarnings = ride.fare ? ride.fare - commission : 0;
        
        // Determine ride type badge
        let rideTypeBadge = '';
        let specialDetails = '';
        
        if (ride.expressDelivery) {
            rideTypeBadge = '<span class="ride-type-badge express">Express Delivery</span>';
            specialDetails = `
                <div class="express-delivery-details">
                    <div class="express-delivery-title">
                        <i class="fas fa-shipping-fast"></i>
                        Express Delivery Details
                    </div>
                    <div class="express-delivery-grid">
                        <div class="express-delivery-item">
                            <span class="express-delivery-label">Shop Name:</span>
                            <span class="express-delivery-value">${ride.expressDelivery.shopName || 'N/A'}</span>
                        </div>
                        <div class="express-delivery-item">
                            <span class="express-delivery-label">Items:</span>
                            <span class="express-delivery-value">${ride.expressDelivery.items || 'N/A'}</span>
                        </div>
                        <div class="express-delivery-item">
                            <span class="express-delivery-label">Amount:</span>
                            <span class="express-delivery-value">K${ride.expressDelivery.amount || '0.00'}</span>
                        </div>
                    </div>
                    ${ride.expressDelivery.instructions ? `
                    <div class="express-delivery-instructions">
                        <strong>Delivery Instructions:</strong><br>
                        ${ride.expressDelivery.instructions}
                    </div>
                    ` : ''}
                </div>
            `;
        } else if (ride.orderForSomeone) {
            rideTypeBadge = '<span class="ride-type-badge order-for-someone">Order for Someone</span>';
            specialDetails = `
                <div class="order-for-someone-details">
                    <div class="order-for-someone-title">
                        <i class="fas fa-user-friends"></i>
                        Order for Someone Details
                    </div>
                    <div class="order-for-someone-grid">
                        <div class="order-for-someone-item">
                            <span class="order-for-someone-label">Recipient Name:</span>
                            <span class="order-for-someone-value">${ride.orderForSomeone.recipientName || 'N/A'}</span>
                        </div>
                        <div class="order-for-someone-item">
                            <span class="order-for-someone-label">Recipient Email:</span>
                            <span class="order-for-someone-value">${ride.orderForSomeone.recipientEmail || 'N/A'}</span>
                        </div>
                        <div class="order-for-someone-item">
                            <span class="order-for-someone-label">Recipient Phone:</span>
                            <span class="order-for-someone-value">${ride.orderForSomeone.recipientPhone || 'N/A'}</span>
                        </div>
                        <div class="order-for-someone-item">
                            <span class="order-for-someone-label">Ordered By:</span>
                            <span class="order-for-someone-value">${ride.orderForSomeone.orderedBy || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            const isDelivery = ride.rideType === 'bike' || ride.rideType === 'bicycle';
            const typeClass = isDelivery ? 'delivery' : 'ride';
            const typeText = isDelivery ? 'Delivery' : 'Ride';
            rideTypeBadge = `<span class="history-item-type ${typeClass}">${typeText}</span>`;
            
            if (isDelivery && ride.packageDetails) {
                specialDetails = `
                    <div class="delivery-info-section">
                        <div class="delivery-info-title">Package Delivery Details</div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Receiver Name:</span>
                            <span class="delivery-info-value">${ride.packageDetails.receiverName || 'N/A'}</span>
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Receiver Phone:</span>
                            <span class="delivery-info-value">${ride.packageDetails.receiverPhone || 'N/A'}</span>
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Package Description:</span>
                            <span class="delivery-info-value">${ride.packageDetails.packageDescription || 'N/A'}</span>
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Package Value:</span>
                            <span class="delivery-info-value">K${ride.packageDetails.packageValue || '0.00'}</span>
                        </div>
                        ${ride.packageDetails.specialInstructions ? `
                        <div class="special-instructions">
                            <strong>Special Instructions:</strong><br>
                            ${ride.packageDetails.specialInstructions}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        rideDetailContent.innerHTML = `
            ${rideTypeBadge}
            <div class="detail-row">
                <span class="detail-label">Ride ID:</span>
                <span class="detail-value">${rideId.substring(0, 8)}...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Passenger:</span>
                <span class="detail-value">${ride.passengerName || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Driver:</span>
                <span class="detail-value">${ride.driverId ? 'Assigned' : 'Not assigned'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Pickup:</span>
                <span class="detail-value">${ride.pickupDisplayLocation || ride.pickupLocation || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Destination:</span>
                <span class="detail-value">${ride.destination || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Fare:</span>
                <span class="detail-value">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value">
                    <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                </span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Date & Time:</span>
                <span class="detail-value">${formattedDate} ${formattedTime}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Distance:</span>
                <span class="detail-value">${ride.distance || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Ride Type:</span>
                <span class="detail-value">${ride.rideType || 'Standard'}</span>
            </div>
            <button class="btn btn-secondary view-more-details" data-ride-id="${rideId}" style="width: 100%; margin-top: 10px;">
                <i class="fas fa-chevron-down"></i> View More Details
            </button>
        `;
        
        // Expanded details (initially hidden)
        expandedDetails.innerHTML = `
            ${specialDetails}
            
            <div class="detail-section">
                <div class="detail-section-title">Financial Breakdown</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Total Fare:</span>
                        <span class="detail-value">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Commission (8%):</span>
                        <span class="detail-value">K${commission.toFixed(2)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Driver Earnings:</span>
                        <span class="detail-value">K${driverEarnings.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Timeline</div>
                <div class="ride-timeline" id="rideTimeline">
                    <!-- Timeline will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Route Information</div>
                <div class="ride-path">
                    <div class="path-point">
                        <div class="path-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="path-label">Pickup</div>
                        <div class="path-address">${ride.pickupDisplayLocation || ride.pickupLocation || 'N/A'}</div>
                    </div>
                    <div class="path-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="path-point">
                        <div class="path-icon destination">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="path-label">Destination</div>
                        <div class="path-address">${ride.destination || 'N/A'}</div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Ride Metrics</div>
                <div class="ride-metrics">
                    <div class="metric-card">
                        <div class="metric-value">${ride.distance || '0 km'}</div>
                        <div class="metric-label">Distance</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${calculateRideDuration(ride) || 'N/A'}</div>
                        <div class="metric-label">Duration</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                        <div class="metric-label">Total Fare</div>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-section-title">Additional Information</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Payment Method:</span>
                        <span class="detail-value">${ride.paymentMethod || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Promo Code:</span>
                        <span class="detail-value">${ride.promoCode || 'None'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Estimated Time:</span>
                        <span class="detail-value">${ride.estimatedTime || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">City:</span>
                        <span class="detail-value">${ride.currentCity || 'N/A'}</span>
                    </div>
                </div>
            </div>
            
            ${ride.driverId ? `
            <div class="detail-section">
                <div class="detail-section-title">Driver Information</div>
                <div id="rideDriverDetails">
                    <!-- Driver details will be populated by JavaScript -->
                </div>
            </div>
            ` : ''}
            
            <div class="detail-section">
                <div class="detail-section-title">Passenger Ride History</div>
                <div id="passengerRideHistory">
                    <!-- Passenger ride history will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- NEW: Chat History Section -->
            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="fas fa-comments"></i>
                    Ride Chat History
                </div>
                <div id="rideChatHistory">
                    <!-- Chat history will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- NEW: SOS History Section -->
            <div class="detail-section">
                <div class="detail-section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS History for this Ride
                </div>
                <div id="rideSOSHistory">
                    <!-- SOS history will be populated by JavaScript -->
                </div>
            </div>
        `;
        
        // Load timeline
        loadRideTimeline(ride);
        
        // Load driver details if available
        if (ride.driverId) {
            loadRideDriverDetails(ride.driverId);
        }
        
        // Load passenger ride history
        loadPassengerRideHistory(ride.passengerId);
        
        // NEW: Load chat history
        loadRideChatHistory(rideId);
        
        // NEW: Load SOS history
        loadRideSOSHistory(rideId);
        
        // Hide expanded details initially
        expandedDetails.classList.remove('active');
        
        document.getElementById('rideDetailModal').classList.add('active');
    }

    // NEW: Load ride chat history
    function loadRideChatHistory(rideId) {
        const rideChatHistory = document.getElementById('rideChatHistory');
        rideChatHistory.innerHTML = '<div class="loading-text">Loading chat history...</div>';
        
        database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
            .then(snapshot => {
                const chats = snapshot.val();
                rideChatHistory.innerHTML = '';
                
                if (chats) {
                    const chatsArray = Object.values(chats).sort((a, b) => a.timestamp - b.timestamp);
                    
                    if (chatsArray.length > 0) {
                        chatsArray.forEach(chat => {
                            const chatItem = document.createElement('div');
                            chatItem.className = 'chat-history-item';
                            
                            const date = new Date(chat.timestamp);
                            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            const sender = chat.senderName || (chat.senderId === ridesData[rideId]?.driverId ? 'Driver' : 'Passenger');
                            
                            chatItem.innerHTML = `
                                <div class="chat-history-header">
                                    <span class="chat-history-sender">${sender}</span>
                                    <span class="chat-history-time">${formattedTime}</span>
                                </div>
                                <div class="chat-history-message">${chat.message}</div>
                            `;
                            
                            rideChatHistory.appendChild(chatItem);
                        });
                    } else {
                        rideChatHistory.innerHTML = '<div class="no-chats">No chat messages for this ride</div>';
                    }
                } else {
                    rideChatHistory.innerHTML = '<div class="no-chats">No chat messages for this ride</div>';
                }
            })
            .catch(error => {
                console.error('Error loading chat history:', error);
                rideChatHistory.innerHTML = '<div class="error-message">Error loading chat history</div>';
            });
    }

    // NEW: Load ride SOS history
    function loadRideSOSHistory(rideId) {
        const rideSOSHistory = document.getElementById('rideSOSHistory');
        rideSOSHistory.innerHTML = '<div class="loading-text">Loading SOS history...</div>';
        
        database.ref('sosAlerts').orderByChild('rideDetails/id').equalTo(rideId).once('value')
            .then(snapshot => {
                const alerts = snapshot.val();
                rideSOSHistory.innerHTML = '';
                
                if (alerts) {
                    const alertsArray = Object.values(alerts).sort((a, b) => b.timestamp - a.timestamp);
                    
                    alertsArray.forEach(alert => {
                        const alertItem = document.createElement('div');
                        alertItem.className = 'sos-history-item';
                        
                        const date = new Date(alert.timestamp);
                        const formattedDate = date.toLocaleDateString();
                        const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const isResolved = alert.resolved || false;
                        
                        alertItem.innerHTML = `
                            <div class="sos-history-header">
                                <span class="sos-history-type">${alert.passengerName ? 'Passenger SOS' : 'Driver SOS'}</span>
                                <span class="sos-history-time">${formattedDate} ${formattedTime}</span>
                            </div>
                            <div class="sos-history-message">${alert.message || 'Emergency assistance needed'}</div>
                            <div class="sos-history-status">
                                Status: <span class="status-badge ${isResolved ? 'status-completed' : 'status-cancelled'}">${isResolved ? 'Resolved' : 'Active'}</span>
                            </div>
                            ${alert.resolvedBy ? `
                            <div class="sos-history-resolved">
                                Resolved by: Admin at ${new Date(alert.resolvedAt).toLocaleString()}
                            </div>
                            ` : ''}
                        `;
                        
                        rideSOSHistory.appendChild(alertItem);
                    });
                } else {
                    rideSOSHistory.innerHTML = '<div class="no-sos">No SOS alerts for this ride</div>';
                }
            })
            .catch(error => {
                console.error('Error loading SOS history:', error);
                rideSOSHistory.innerHTML = '<div class="error-message">Error loading SOS history</div>';
            });
    }

    // Show SOS alert details in modal
    function showSOSDetails(alertId) {
        const alert = sosAlertsData[alertId];
        if (!alert) return;
        
        selectedSOS = alertId;
        
        const sosAlertContent = document.getElementById('sosAlertContent');
        
        const date = new Date(alert.timestamp);
        const formattedDate = date.toLocaleDateString();
        const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        sosAlertContent.innerHTML = `
            <div class="sos-alert-card">
                <div class="sos-alert-header">
                    <div class="sos-alert-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${alert.passengerName ? 'Passenger SOS Alert' : 'Driver SOS Alert'}
                    </div>
                    <div class="sos-alert-time">${formattedDate} ${formattedTime}</div>
                </div>
                <div class="sos-alert-details">
                    <strong>User:</strong> ${alert.passengerName || alert.driverName || 'Unknown'}<br>
                    <strong>Phone:</strong> ${alert.passengerPhone || alert.driverPhone || 'N/A'}<br>
                    <strong>Message:</strong> ${alert.message || 'Emergency assistance needed'}<br>
                    <strong>Location:</strong> ${alert.location ? `${alert.location.lat.toFixed(6)}, ${alert.location.lng.toFixed(6)}` : 'Unknown'}<br>
                    <strong>Urgent:</strong> ${alert.urgent ? 'Yes' : 'No'}<br>
                    <strong>Resolved:</strong> ${alert.resolved ? 'Yes' : 'No'}
                </div>
            </div>
            
            ${alert.rideDetails ? `
            <div class="detail-section">
                <div class="detail-section-title">Ride Details</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Ride ID:</span>
                        <span class="detail-value">${alert.rideDetails.id || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value">${alert.rideDetails.pickupLocation || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value">${alert.rideDetails.destination || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value">K${alert.rideDetails.fare ? alert.rideDetails.fare.toFixed(2) : '0.00'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-badge status-${alert.rideDetails.status || 'requested'}">${alert.rideDetails.status || 'requested'}</span>
                        </span>
                    </div>
                </div>
            </div>
            ` : ''}
            
            ${alert.driverDetails ? `
            <div class="detail-section">
                <div class="detail-section-title">Driver Details</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value">${alert.driverDetails.name || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">${alert.driverDetails.phone || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Vehicle:</span>
                        <span class="detail-value">${alert.driverDetails.vehicle ? `${alert.driverDetails.vehicle.type} - ${alert.driverDetails.vehicle.licensePlate}` : 'N/A'}</span>
                    </div>
                </div>
            </div>
            ` : ''}
            
            <div class="detail-section">
                <div class="detail-section-title">Emergency Contacts</div>
                <div class="detail-grid">
                    <div class="detail-row">
                        <span class="detail-label">Contact 1:</span>
                        <span class="detail-value">${alert.emergencyContact1 || 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Contact 2:</span>
                        <span class="detail-value">${alert.emergencyContact2 || 'N/A'}</span>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('sosAlertModal').classList.add('active');
    }

    // Load driver's recent rides
    function loadDriverRecentRides(driverId) {
        const driverRecentRides = document.getElementById('driverRecentRides');
        driverRecentRides.innerHTML = '';
        
        if (ridesData) {
            // Filter rides by driver and sort by timestamp (newest first)
            const driverRides = Object.keys(ridesData)
                .map(rideId => ({ id: rideId, ...ridesData[rideId] }))
                .filter(ride => ride.driverId === driverId)
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                .slice(0, 5); // Show last 5 rides
            
            if (driverRides.length > 0) {
                driverRides.forEach(ride => {
                    const rideItem = document.createElement('div');
                    rideItem.className = 'list-item';
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    rideItem.innerHTML = `
                        <div class="item-title">${ride.passengerName || 'Passenger'}  ${ride.destination || 'Destination'}</div>
                        <div class="item-details">
                            <span>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}  ${formattedDate} ${formattedTime}</span>
                            <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                        </div>
                    `;
                    
                    rideItem.addEventListener('click', function() {
                        closeDriverModal();
                        showRideDetails(ride.id);
                    });
                    
                    driverRecentRides.appendChild(rideItem);
                });
            } else {
                driverRecentRides.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No rides found for this driver.</p>';
            }
        } else {
            driverRecentRides.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No ride data available.</p>';
        }
    }

    // Load passenger's recent rides
    function loadPassengerRecentRides(passengerId) {
        const passengerRecentRides = document.getElementById('passengerRecentRides');
        passengerRecentRides.innerHTML = '';
        
        if (ridesData) {
            // Filter rides by passenger and sort by timestamp (newest first)
            const passengerRides = Object.keys(ridesData)
                .map(rideId => ({ id: rideId, ...ridesData[rideId] }))
                .filter(ride => ride.passengerId === passengerId)
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                .slice(0, 5); // Show last 5 rides
            
            if (passengerRides.length > 0) {
                passengerRides.forEach(ride => {
                    const rideItem = document.createElement('div');
                    rideItem.className = 'list-item';
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    rideItem.innerHTML = `
                        <div class="item-title">${ride.pickupLocation || 'Pickup'}  ${ride.destination || 'Destination'}</div>
                        <div class="item-details">
                            <span>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}  ${formattedDate} ${formattedTime}</span>
                            <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                        </div>
                    `;
                    
                    rideItem.addEventListener('click', function() {
                        closePassengerModal();
                        showRideDetails(ride.id);
                    });
                    
                    passengerRecentRides.appendChild(rideItem);
                });
            } else {
                passengerRecentRides.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No rides found for this passenger.</p>';
            }
        } else {
            passengerRecentRides.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No ride data available.</p>';
        }
    }

    // Calculate ride duration
    function calculateRideDuration(ride) {
        if (!ride.timestamp || !ride.completedAt) return 'N/A';
        
        const startTime = new Date(ride.timestamp);
        const endTime = new Date(ride.completedAt);
        const durationMs = endTime - startTime;
        
        // Convert to minutes
        const durationMinutes = Math.floor(durationMs / (1000 * 60));
        
        if (durationMinutes < 60) {
            return `${durationMinutes} min`;
        } else {
            const hours = Math.floor(durationMinutes / 60);
            const minutes = durationMinutes % 60;
            return `${hours}h ${minutes}m`;
        }
    }

    // Load ride timeline
    function loadRideTimeline(ride) {
        const timeline = document.getElementById('rideTimeline');
        timeline.innerHTML = '';
        
        const events = [
            { time: ride.timestamp, event: 'Ride Requested', active: true },
            { time: ride.acceptedAt, event: 'Driver Accepted', active: !!ride.acceptedAt },
            { time: ride.arrivedAt, event: 'Driver Arrived', active: !!ride.arrivedAt },
            { time: ride.pickedUpAt, event: 'Passenger Picked Up', active: !!ride.pickedUpAt },
            { time: ride.startedAt, event: 'Trip Started', active: !!ride.startedAt },
            { time: ride.completedAt, event: 'Trip Completed', active: !!ride.completedAt }
        ];
        
        // Filter out events without timestamps and sort by time
        const validEvents = events
            .filter(event => event.time)
            .sort((a, b) => new Date(a.time) - new Date(b.time));
        
        if (validEvents.length === 0) {
            timeline.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No timeline data available</p>';
            return;
        }
        
        validEvents.forEach(event => {
            const timelineItem = document.createElement('div');
            timelineItem.className = 'timeline-item';
            
            const eventTime = new Date(event.time);
            const formattedTime = eventTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const formattedDate = eventTime.toLocaleDateString();
            
            timelineItem.innerHTML = `
                <div class="timeline-dot ${event.active ? 'active' : ''}"></div>
                <div class="timeline-content">
                    <div class="timeline-time">${formattedDate} ${formattedTime}</div>
                    <div class="timeline-event">${event.event}</div>
                </div>
            `;
            
            timeline.appendChild(timelineItem);
        });
    }

    // Load driver details for ride
    function loadRideDriverDetails(driverId) {
        const rideDriverDetails = document.getElementById('rideDriverDetails');
        
        database.ref('users/' + driverId).once('value')
            .then(snapshot => {
                const driver = snapshot.val();
                if (driver) {
                    // Calculate driver performance metrics
                    let totalRides = 0;
                    let completedRides = 0;
                    let totalEarnings = 0;
                    let totalRating = 0;
                    let ratingCount = 0;
                    
                    if (ridesData) {
                        Object.keys(ridesData).forEach(rideId => {
                            const ride = ridesData[rideId];
                            if (ride.driverId === driverId) {
                                totalRides++;
                                if (ride.status === 'completed') {
                                    completedRides++;
                                    totalEarnings += ride.fare * 0.92; // 92% for driver
                                }
                            }
                        });
                    }
                    
                    const completionRate = totalRides > 0 ? (completedRides / totalRides) * 100 : 0;
                    const avgEarnings = completedRides > 0 ? totalEarnings / completedRides : 0;
                    
                    rideDriverDetails.innerHTML = `
                        <div class="driver-details-card">
                            <div class="driver-details-header">
                                <i class="fas fa-id-card"></i>
                                <h3>Driver Details</h3>
                            </div>
                            <div class="driver-details-grid">
                                <div class="driver-detail-item">
                                    <span class="driver-detail-label">Driver Name</span>
                                    <span class="driver-detail-value">${driver.name || 'Driver'}</span>
                                </div>
                                <div class="driver-detail-item">
                                    <span class="driver-detail-label">Phone</span>
                                    <span class="driver-detail-value">${driver.phone || 'Not available'}</span>
                                </div>
                                <div class="driver-detail-item">
                                    <span class="driver-detail-label">Rating</span>
                                    <span class="driver-detail-value">${driver.rating ? driver.rating.toFixed(1) + ' ' : 'N/A'}</span>
                                </div>
                                <div class="driver-detail-item">
                                    <span class="driver-detail-label">Experience</span>
                                    <span class="driver-detail-value">${driver.experience || '2 years'}</span>
                                </div>
                            </div>
                            ${driver.vehicle ? `
                            <div class="driver-vehicle-details">
                                <div class="vehicle-detail-row">
                                    <span class="vehicle-detail-label">Vehicle Type</span>
                                    <span class="vehicle-detail-value">${driver.vehicle.type || 'Car'}</span>
                                </div>
                                <div class="vehicle-detail-row">
                                    <span class="vehicle-detail-label">Vehicle Model</span>
                                    <span class="vehicle-detail-value">${driver.vehicle.model || 'Not specified'}</span>
                                </div>
                                <div class="vehicle-detail-row">
                                    <span class="vehicle-detail-label">License Plate</span>
                                    <span class="vehicle-detail-value">${driver.vehicle.licensePlate || 'Not available'}</span>
                                </div>
                                <div class="vehicle-detail-row">
                                    <span class="vehicle-detail-label">Color</span>
                                    <span class="vehicle-detail-value">${driver.vehicle.color || 'Not specified'}</span>
                                </div>
                            </div>
                            ` : ''}
                            <div class="driver-performance">
                                <h4 class="detail-section-title">Performance Metrics</h4>
                                <div class="performance-metrics">
                                    <div class="performance-metric">
                                        <div class="performance-value">${totalRides}</div>
                                        <div class="performance-label">Total Rides</div>
                                    </div>
                                    <div class="performance-metric">
                                        <div class="performance-value">${completionRate.toFixed(1)}%</div>
                                        <div class="performance-label">Completion Rate</div>
                                    </div>
                                    <div class="performance-metric">
                                        <div class="performance-value">K${avgEarnings.toFixed(2)}</div>
                                        <div class="performance-label">Avg Earnings</div>
                                    </div>
                                    <div class="performance-metric">
                                        <div class="performance-value">${driver.rating ? driver.rating.toFixed(1) : 'N/A'}</div>
                                        <div class="performance-label">Rating</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    rideDriverDetails.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">Driver information not available.</p>';
                }
            })
            .catch(error => {
                console.error('Error loading driver details:', error);
                rideDriverDetails.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">Error loading driver details.</p>';
            });
    }

    // Load passenger ride history
    function loadPassengerRideHistory(passengerId) {
        const passengerRideHistory = document.getElementById('passengerRideHistory');
        passengerRideHistory.innerHTML = '';
        
        if (ridesData) {
            // Filter rides by passenger and sort by timestamp (newest first)
            const passengerRides = Object.keys(ridesData)
                .map(rideId => ({ id: rideId, ...ridesData[rideId] }))
                .filter(ride => ride.passengerId === passengerId)
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                .slice(0, 5); // Show last 5 rides
            
            if (passengerRides.length > 0) {
                passengerRides.forEach(ride => {
                    const rideItem = document.createElement('div');
                    rideItem.className = 'passenger-ride-item';
                    
                    const date = new Date(ride.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    
                    rideItem.innerHTML = `
                        <div class="passenger-ride-header">
                            <div class="passenger-ride-date">${formattedDate}</div>
                            <div class="passenger-ride-status status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</div>
                        </div>
                        <div class="passenger-ride-details">
                            <div class="passenger-ride-locations">
                                ${ride.pickupLocation}  ${ride.destination}
                            </div>
                            <div class="passenger-ride-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                        </div>
                    `;
                    
                    rideItem.addEventListener('click', function() {
                        closeRideModal();
                        showRideDetails(ride.id);
                    });
                    
                    passengerRideHistory.appendChild(rideItem);
                });
            } else {
                passengerRideHistory.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No ride history found for this passenger.</p>';
            }
        } else {
            passengerRideHistory.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">No ride data available.</p>';
        }
    }

    // Toggle ride details expansion
    function toggleRideDetails(rideId) {
        const expandedDetails = document.getElementById('rideExpandedDetails');
        expandedDetails.classList.toggle('active');
        
        const button = document.querySelector(`.view-more-details[data-ride-id="${rideId}"]`);
        if (expandedDetails.classList.contains('active')) {
            button.innerHTML = '<i class="fas fa-chevron-up"></i> View Less Details';
        } else {
            button.innerHTML = '<i class="fas fa-chevron-down"></i> View More Details';
        }
    }

    // View ride map
    function viewRideMap() {
        if (!selectedRide) return;
        
        const ride = ridesData[selectedRide];
        if (!ride) return;
        
        // Initialize ride map if not already initialized
        if (!rideMap) {
            initializeRideMap();
        }
        
        // Clear existing map layers
        rideMap.eachLayer(layer => {
            if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                rideMap.removeLayer(layer);
            }
        });
        
        // Add pickup marker
        L.marker([ride.pickupLat, ride.pickupLng], {
            icon: L.divIcon({
                className: 'pickup-marker',
                html: '<div class="pickup-marker"><i class="fas fa-map-marker-alt"></i></div>',
                iconSize: [25, 25]
            })
        }).addTo(rideMap).bindPopup('Pickup Location');
        
        // Add destination marker
        L.marker([ride.destLat, ride.destLng], {
            icon: L.divIcon({
                className: 'destination-marker',
                html: '<div class="destination-marker"><i class="fas fa-flag"></i></div>',
                iconSize: [25, 25]
            })
        }).addTo(rideMap).bindPopup('Destination');
        
        // Add driver marker if available
        if (ride.driverId && driversData[ride.driverId]) {
            const driver = driversData[ride.driverId];
            L.marker([ride.driverLat || ride.pickupLat, ride.driverLng || ride.pickupLng], {
                icon: L.divIcon({
                    className: 'driver-marker',
                    html: `<div class="driver-marker">${getVehicleIcon(driver.vehicle?.type)}</div><div class="driver-marker-label">${driver.name || 'Driver'}</div>`,
                    iconSize: [35, 50]
                })
            }).addTo(rideMap).bindPopup('Driver Location');
        }
        
        // Draw route
        drawRideMapRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
        
        // Calculate route distance and duration
        calculateRouteDetails(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
        
        // Fit map to show both locations
        const bounds = L.latLngBounds(
            [ride.pickupLat, ride.pickupLng],
            [ride.destLat, ride.destLng]
        );
        rideMap.fitBounds(bounds, { padding: [15, 15] });
        
        // Show ride map modal
        document.getElementById('rideMapModal').classList.add('active');
    }

    // Draw route on ride map
    function drawRideMapRoute(startLat, startLng, endLat, endLng) {
        // Use OSRM API to get route
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    // Draw the route on the map
                    L.polyline(routeCoordinates, {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(rideMap);
                }
            })
            .catch(error => {
                console.error('Error fetching route:', error);
                // Fallback: draw a straight line
                L.polyline([
                    [startLat, startLng],
                    [endLat, endLng]
                ], {
                    color: '#FF6B35',
                    weight: 4,
                    opacity: 0.7
                }).addTo(rideMap);
            });
    }

    // Calculate route details
    function calculateRouteDetails(startLat, startLng, endLat, endLng) {
        fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full`)
            .then(response => response.json())
            .then(data => {
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    const distance = (route.distance / 1000).toFixed(1); // Convert to km
                    const duration = Math.floor(route.duration / 60); // Convert to minutes
                    
                    const routeDetails = document.getElementById('routeDetails');
                    routeDetails.innerHTML = `
                        <div class="route-detail-row">
                            <span class="route-detail-label">Distance:</span>
                            <span class="route-detail-value">${distance} km</span>
                        </div>
                        <div class="route-detail-row">
                            <span class="route-detail-label">Estimated Duration:</span>
                            <span class="route-detail-value">${duration} min</span>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error calculating route details:', error);
                const routeDetails = document.getElementById('routeDetails');
                routeDetails.innerHTML = '<p style="text-align: center; color: var(--medium-gray); font-size: 0.8rem;">Route details not available</p>';
            });
    }

    // Close modals
    function closeDriverModal() {
        document.getElementById('driverDetailModal').classList.remove('active');
        selectedDriver = null;
    }
    
    function closePassengerModal() {
        document.getElementById('passengerDetailModal').classList.remove('active');
        selectedPassenger = null;
    }
    
    function closeRideModal() {
        document.getElementById('rideDetailModal').classList.remove('active');
        selectedRide = null;
    }
    
    function closeRideMapModal() {
        document.getElementById('rideMapModal').classList.remove('active');
    }
    
    function closeSOSModal() {
        document.getElementById('sosAlertModal').classList.remove('active');
        selectedSOS = null;
    }
    
    function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('active');
    }
    
    // Open settings modal
    function openSettings() {
        document.getElementById('settingsModal').classList.add('active');
    }
    
    // Driver actions
    function editDriver() {
        if (!selectedDriver) return;
        showNotification('Edit driver functionality would open here.');
        // In a real app, this would open an edit form
    }
    
    function suspendDriver() {
        if (!selectedDriver) return;
        
        const driver = driversData[selectedDriver];
        const newStatus = !driver.isSuspended;
        
        database.ref('users/' + selectedDriver).update({
            isSuspended: newStatus
        })
        .then(() => {
            showNotification(`Driver ${newStatus ? 'suspended' : 'activated'} successfully.`);
            closeDriverModal();
            loadDriversData();
            loadDashboardData(); // Refresh stats
        })
        .catch(error => {
            console.error('Error updating driver status:', error);
            showNotification('Error updating driver status.', 'error');
        });
    }
    
    function trackDriver() {
        if (!selectedDriver) return;
        
        const driver = driversData[selectedDriver];
        if (driverMarkers[selectedDriver]) {
            managerMap.setView(driverMarkers[selectedDriver].getLatLng(), 15);
            driverMarkers[selectedDriver].openPopup();
        }
        
        closeDriverModal();
        switchTab('dashboardTab');
    }
    
    function verifyDriver() {
        if (!selectedDriver) return;
        
        const driver = driversData[selectedDriver];
        const newStatus = !driver.isVerified;
        
        database.ref('users/' + selectedDriver).update({
            isVerified: newStatus
        })
        .then(() => {
            showNotification(`Driver ${newStatus ? 'verified' : 'unverified'} successfully.`);
            closeDriverModal();
            loadDriversData();
        })
        .catch(error => {
            console.error('Error updating driver verification:', error);
            showNotification('Error updating driver verification.', 'error');
        });
    }
    
    // NEW: View driver document
    function viewDriverDocument(driverId, docType) {
        const driverDocs = driverDocuments[driverId];
        if (!driverDocs || !driverDocs[docType]) {
            showNotification('Document not available for viewing.');
            return;
        }
        
        // Create a modal to view the document
        const viewerModal = document.createElement('div');
        viewerModal.className = 'modal-overlay';
        viewerModal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        viewerModal.innerHTML = `
            <div class="enhanced-modal" style="max-width: 90%; max-height: 90%;">
                <div class="enhanced-modal-header">
                    <h3 class="enhanced-modal-title">
                        <i class="fas fa-file-image"></i>
                        Document Viewer
                    </h3>
                    <button class="enhanced-close-modal" id="closeDocumentViewer">&times;</button>
                </div>
                <div class="enhanced-modal-content" style="text-align: center;">
                    <img src="${driverDocs[docType]}" alt="${docType}" style="max-width: 100%; max-height: 70vh; border-radius: 5px;">
                    <div style="margin-top: 15px;">
                        <button class="action-btn btn-secondary" onclick="downloadDriverDocument('${driverId}', '${docType}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(viewerModal);
        
        // Add close event listener
        document.getElementById('closeDocumentViewer').addEventListener('click', function() {
            document.body.removeChild(viewerModal);
        });
        
        // Close on outside click
        viewerModal.addEventListener('click', function(e) {
            if (e.target === viewerModal) {
                document.body.removeChild(viewerModal);
            }
        });
    }
    
    // NEW: Download driver document
    function downloadDriverDocument(driverId, docType) {
        const driverDocs = driverDocuments[driverId];
        if (!driverDocs || !driverDocs[docType]) {
            showNotification('Document not available for download.');
            return;
        }
        
        // Create a temporary link to download the image
        const link = document.createElement('a');
        link.href = driverDocs[docType];
        link.download = `driver_${driverId}_${docType}.jpg`;
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Document download initiated.');
    }
    
    // NEW: Approve driver application
    function approveDriverApplication(driverId) {
        if (!driverId) return;
        
        if (confirm('Are you sure you want to approve this driver application?')) {
            // Update driver registration status
            database.ref('users/' + driverId).update({
                registrationStatus: 'approved',
                approvedAt: firebase.database.ServerValue.TIMESTAMP,
                approvedBy: currentUser.uid,
                isVerified: true // Auto-verify approved drivers
            })
            .then(() => {
                showNotification('Driver application approved successfully.');
                
                // Remove from pending applications
                delete pendingApplications[driverId];
                updateApplicationsBadge();
                
                // Close modal and refresh data
                closeDriverModal();
                loadDriversData();
                loadDashboardData();
                
                // NEW: Send notification to driver (in real app)
                sendDriverNotification(driverId, 'Your driver application has been approved! You can now log in and start driving.');
            })
            .catch(error => {
                console.error('Error approving driver application:', error);
                showNotification('Error approving driver application.', 'error');
            });
        }
    }
    
    // NEW: Reject driver application
    function rejectDriverApplication(driverId) {
        if (!driverId) return;
        
        const reason = prompt('Please enter the reason for rejection:');
        if (reason === null) return; // User cancelled
        
        if (confirm('Are you sure you want to reject this driver application?')) {
            // Update driver registration status
            database.ref('users/' + driverId).update({
                registrationStatus: 'rejected',
                rejectedAt: firebase.database.ServerValue.TIMESTAMP,
                rejectedBy: currentUser.uid,
                rejectionReason: reason
            })
            .then(() => {
                showNotification('Driver application rejected successfully.');
                
                // Remove from pending applications
                delete pendingApplications[driverId];
                updateApplicationsBadge();
                
                // Close modal and refresh data
                closeDriverModal();
                loadDriversData();
                loadDashboardData();
                
                // NEW: Send notification to driver (in real app)
                sendDriverNotification(driverId, `Your driver application has been rejected. Reason: ${reason}`);
            })
            .catch(error => {
                console.error('Error rejecting driver application:', error);
                showNotification('Error rejecting driver application.', 'error');
            });
        }
    }
    
    // NEW: Send notification to driver
    function sendDriverNotification(driverId, message) {
        // In a real app, this would send push notification or email
        // For now, we'll create a notification in the database
        const notificationData = {
            message: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            read: false,
            type: 'admin_notification'
        };
        
        database.ref('notifications/' + driverId).push(notificationData)
            .catch(error => {
                console.error('Error sending notification:', error);
            });
    }
    
    // Passenger actions
    function editPassenger() {
        if (!selectedPassenger) return;
        showNotification('Edit passenger functionality would open here.');
        // In a real app, this would open an edit form
    }
    
    function suspendPassenger() {
        if (!selectedPassenger) return;
        
        const passenger = passengersData[selectedPassenger];
        const newStatus = !passenger.isSuspended;
        
        database.ref('users/' + selectedPassenger).update({
            isSuspended: newStatus
        })
        .then(() => {
            showNotification(`Passenger ${newStatus ? 'suspended' : 'activated'} successfully.`);
            closePassengerModal();
            loadPassengersData();
            loadDashboardData(); // Refresh stats
        })
        .catch(error => {
            console.error('Error updating passenger status:', error);
            showNotification('Error updating passenger status.', 'error');
        });
    }
    
    function viewPassengerRides() {
        if (!selectedPassenger) return;
        switchTab('ridesTab');
        // Filter rides by this passenger
        document.getElementById('rideSearch').value = passengersData[selectedPassenger].name || '';
        searchRides();
        closePassengerModal();
    }
    
    // Ride actions
    function cancelRide() {
        if (!selectedRide) return;
        
        if (confirm('Are you sure you want to cancel this ride?')) {
            database.ref('rides/' + selectedRide).update({
                status: 'cancelled',
                cancelledBy: 'admin',
                cancelledAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                showNotification('Ride cancelled successfully.');
                closeRideModal();
                loadRidesData();
                loadDashboardData();
            })
            .catch(error => {
                console.error('Error cancelling ride:', error);
                showNotification('Error cancelling ride.', 'error');
            });
        }
    }
    
    function reassignRide() {
        if (!selectedRide) return;
        showNotification('Reassign ride functionality would open here.');
        // In a real app, this would open a driver selection interface
    }
    
    function trackRide() {
        if (!selectedRide) return;
        
        const ride = ridesData[selectedRide];
        if (activeRideMarkers[selectedRide]) {
            toggleFullScreenMap();
            fullScreenMap.setView(activeRideMarkers[selectedRide].getLatLng(), 15);
            activeRideMarkers[selectedRide].openPopup();
            
            // Update ride tracking info
            const trackingInfo = document.getElementById('fullScreenRideTracking');
            trackingInfo.innerHTML = `
                <h4>Tracking Ride</h4>
                <div class="detail-row">
                    <span class="detail-label">Passenger:</span>
                    <span class="detail-value">${ride.passengerName || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Destination:</span>
                    <span class="detail-value">${ride.destination || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge status-${ride.status || 'requested'}">${ride.status || 'requested'}</span>
                    </span>
                </div>
            `;
        }
        
        closeRideModal();
    }

    // SOS Alert actions
    function resolveSOSAlert() {
        if (!selectedSOS) return;
        
        database.ref('sosAlerts/' + selectedSOS).update({
            resolved: true,
            resolvedAt: firebase.database.ServerValue.TIMESTAMP,
            resolvedBy: currentUser.uid
        })
        .then(() => {
            showNotification('SOS alert resolved successfully.');
            closeSOSModal();
            loadSOSAlerts();
            loadDashboardData();
        })
        .catch(error => {
            console.error('Error resolving SOS alert:', error);
            showNotification('Error resolving SOS alert.', 'error');
        });
    }

    function contactSOSAlert() {
        if (!selectedSOS) return;
        
        const alert = sosAlertsData[selectedSOS];
        const phoneNumber = alert.passengerPhone || alert.driverPhone;
        
        if (phoneNumber) {
            window.open(`tel:${phoneNumber}`, '_self');
        } else {
            showNotification('No phone number available for this alert.');
        }
    }

    function trackSOSAlert() {
        if (!selectedSOS) return;
        
        const alert = sosAlertsData[selectedSOS];
        if (alert.location && alert.location.lat && alert.location.lng) {
            toggleFullScreenMap();
            fullScreenMap.setView([alert.location.lat, alert.location.lng], 15);
            
            // Update tracking info
            const trackingInfo = document.getElementById('fullScreenRideTracking');
            trackingInfo.innerHTML = `
                <h4>Tracking SOS Alert</h4>
                <div class="detail-row">
                    <span class="detail-label">User:</span>
                    <span class="detail-value">${alert.passengerName || alert.driverName || 'User'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone:</span>
                    <span class="detail-value">${alert.passengerPhone || alert.driverPhone || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">
                        <span class="status-badge ${alert.resolved ? 'status-completed' : 'status-cancelled'}">
                            ${alert.resolved ? 'Resolved' : 'Active'}
                        </span>
                    </span>
                </div>
            `;
        }
        
        closeSOSModal();
    }

    // Search functions
    function searchDrivers() {
        const query = document.getElementById('driverSearch').value.toLowerCase();
        const filteredDrivers = {};
        
        Object.keys(driversData).forEach(driverId => {
            const driver = driversData[driverId];
            if (
                (driver.name && driver.name.toLowerCase().includes(query)) ||
                (driver.phone && driver.phone.includes(query)) ||
                (driver.email && driver.email.toLowerCase().includes(query)) ||
                (driver.vehicle?.licensePlate && driver.vehicle.licensePlate.toLowerCase().includes(query))
            ) {
                filteredDrivers[driverId] = driver;
            }
        });
        
        displayDrivers(filteredDrivers);
    }

    function searchPassengers() {
        const query = document.getElementById('passengerSearch').value.toLowerCase();
        const filteredPassengers = {};
        
        Object.keys(passengersData).forEach(passengerId => {
            const passenger = passengersData[passengerId];
            if (
                (passenger.name && passenger.name.toLowerCase().includes(query)) ||
                (passenger.phone && passenger.phone.includes(query)) ||
                (passenger.email && passenger.email.toLowerCase().includes(query))
            ) {
                filteredPassengers[passengerId] = passenger;
            }
        });
        
        displayPassengers(filteredPassengers);
    }

    function searchRides() {
        const query = document.getElementById('rideSearch').value.toLowerCase();
        const filteredRides = {};
        
        Object.keys(ridesData).forEach(rideId => {
            const ride = ridesData[rideId];
            if (
                (ride.passengerName && ride.passengerName.toLowerCase().includes(query)) ||
                (ride.pickupLocation && ride.pickupLocation.toLowerCase().includes(query)) ||
                (ride.destination && ride.destination.toLowerCase().includes(query)) ||
                (ride.driverId && driversData[ride.driverId] && driversData[ride.driverId].name && driversData[ride.driverId].name.toLowerCase().includes(query))
            ) {
                filteredRides[rideId] = ride;
            }
        });
        
        displayRides(filteredRides);
    }

    function searchSOSAlerts() {
        const query = document.getElementById('sosSearch').value.toLowerCase();
        const filteredAlerts = {};
        
        Object.keys(sosAlertsData).forEach(alertId => {
            const alert = sosAlertsData[alertId];
            if (
                (alert.passengerName && alert.passengerName.toLowerCase().includes(query)) ||
                (alert.driverName && alert.driverName.toLowerCase().includes(query)) ||
                (alert.message && alert.message.toLowerCase().includes(query))
            ) {
                filteredAlerts[alertId] = alert;
            }
        });
        
        displaySOSAlerts(filteredAlerts);
    }

    // Filter functions
    function filterDrivers() {
        const statusFilter = document.getElementById('driverStatusFilter').value;
        const vehicleFilter = document.getElementById('driverVehicleFilter').value;
        const ratingFilter = document.getElementById('driverRatingFilter').value;
        const verifiedOnly = document.getElementById('driverVerifiedFilter').classList.contains('active');
        const filteredDrivers = {};
        
        Object.keys(driversData).forEach(driverId => {
            const driver = driversData[driverId];
            let statusMatch = true;
            let vehicleMatch = true;
            let ratingMatch = true;
            let verifiedMatch = true;
            
            if (statusFilter === 'online') {
                statusMatch = driver.isOnline === true;
            } else if (statusFilter === 'offline') {
                statusMatch = driver.isOnline === false;
            } else if (statusFilter === 'suspended') {
                statusMatch = driver.isSuspended === true;
            }
            
            if (vehicleFilter !== 'all') {
                vehicleMatch = driver.vehicle?.type === vehicleFilter;
            }
            
            if (ratingFilter !== 'all') {
                const minRating = parseFloat(ratingFilter);
                ratingMatch = driver.rating >= minRating;
            }
            
            if (verifiedOnly) {
                verifiedMatch = driver.isVerified === true;
            }
            
            if (statusMatch && vehicleMatch && ratingMatch && verifiedMatch) {
                filteredDrivers[driverId] = driver;
            }
        });
        
        displayDrivers(filteredDrivers);
    }

    function filterPassengers() {
        const statusFilter = document.getElementById('passengerStatusFilter').value;
        const ridesFilter = document.getElementById('passengerRidesFilter').value;
        const withReferrals = document.getElementById('passengerReferralFilter').classList.contains('active');
        const filteredPassengers = {};
        
        Object.keys(passengersData).forEach(passengerId => {
            const passenger = passengersData[passengerId];
            let statusMatch = true;
            let ridesMatch = true;
            let referralMatch = true;
            
            if (statusFilter === 'active') {
                statusMatch = passenger.isSuspended !== true;
            } else if (statusFilter === 'suspended') {
                statusMatch = passenger.isSuspended === true;
            }
            
            if (ridesFilter !== 'all') {
                const minRides = parseInt(ridesFilter);
                ridesMatch = (passenger.totalRides || 0) >= minRides;
            }
            
            if (withReferrals) {
                referralMatch = (passenger.referralsCount || 0) > 0;
            }
            
            if (statusMatch && ridesMatch && referralMatch) {
                filteredPassengers[passengerId] = passenger;
            }
        });
        
        displayPassengers(filteredPassengers);
    }

    function filterRides() {
        const statusFilter = document.getElementById('rideStatusFilter').value;
        const typeFilter = document.getElementById('rideTypeFilter').value;
        const dateFilter = document.getElementById('rideDateFilter').value;
        const highValue = document.getElementById('rideHighValueFilter').classList.contains('active');
        const filteredRides = {};
        
        Object.keys(ridesData).forEach(rideId => {
            const ride = ridesData[rideId];
            let statusMatch = true;
            let typeMatch = true;
            let dateMatch = true;
            let valueMatch = true;
            
            if (statusFilter !== 'all') {
                statusMatch = ride.status === statusFilter;
            }
            
            if (typeFilter !== 'all') {
                if (typeFilter === 'express') {
                    typeMatch = !!ride.expressDelivery;
                } else if (typeFilter === 'order-for-someone') {
                    typeMatch = !!ride.orderForSomeone;
                } else if (typeFilter === 'standard') {
                    typeMatch = !ride.expressDelivery && !ride.orderForSomeone;
                }
            }
            
            if (dateFilter) {
                const rideDate = new Date(ride.timestamp);
                const filterDate = new Date(dateFilter);
                dateMatch = rideDate.toDateString() === filterDate.toDateString();
            }
            
            if (highValue) {
                valueMatch = (ride.fare || 0) > 50; // High value rides are over K50
            }
            
            if (statusMatch && typeMatch && dateMatch && valueMatch) {
                filteredRides[rideId] = ride;
            }
        });
        
        displayRides(filteredRides);
    }

    function filterSOSAlerts() {
        const statusFilter = document.getElementById('sosStatusFilter').value;
        const typeFilter = document.getElementById('sosTypeFilter').value;
        const dateFilter = document.getElementById('sosDateFilter').value;
        const urgentOnly = document.getElementById('sosUrgentFilter').classList.contains('active');
        const filteredAlerts = {};
        
        Object.keys(sosAlertsData).forEach(alertId => {
            const alert = sosAlertsData[alertId];
            let statusMatch = true;
            let typeMatch = true;
            let dateMatch = true;
            let urgentMatch = true;
            
            if (statusFilter === 'active') {
                statusMatch = !alert.resolved;
            } else if (statusFilter === 'resolved') {
                statusMatch = alert.resolved === true;
            }
            
            if (typeFilter === 'driver') {
                typeMatch = !!alert.driverName;
            } else if (typeFilter === 'passenger') {
                typeMatch = !!alert.passengerName;
            }
            
            if (dateFilter) {
                const alertDate = new Date(alert.timestamp);
                const filterDate = new Date(dateFilter);
                dateMatch = alertDate.toDateString() === filterDate.toDateString();
            }
            
            if (urgentOnly) {
                urgentMatch = alert.urgent === true;
            }
            
            if (statusMatch && typeMatch && dateMatch && urgentMatch) {
                filteredAlerts[alertId] = alert;
            }
        });
        
        displaySOSAlerts(filteredAlerts);
    }

    // Toggle filter buttons
    function toggleDriverVerifiedFilter() {
        const btn = document.getElementById('driverVerifiedFilter');
        btn.classList.toggle('active');
        filterDrivers();
    }

    function togglePassengerReferralFilter() {
        const btn = document.getElementById('passengerReferralFilter');
        btn.classList.toggle('active');
        filterPassengers();
    }

    function toggleRideHighValueFilter() {
        const btn = document.getElementById('rideHighValueFilter');
        btn.classList.toggle('active');
        filterRides();
    }

    function toggleSOSUrgentFilter() {
        const btn = document.getElementById('sosUrgentFilter');
        btn.classList.toggle('active');
        filterSOSAlerts();
    }

    // Load reports with real data
    function loadReports() {
        const period = document.getElementById('reportPeriod').value;
        const city = document.getElementById('reportCity').value;
        
        // Load revenue report
        loadRevenueReport(period, city);
        
        // Load rides report
        loadRidesReport(period, city);
        
        // Load drivers report
        loadDriversReport(period, city);
        
        // Load passengers report
        loadPassengersReport(period, city);
        
        // Load SOS report
        loadSOSReport(period, city);
    }

    // Load revenue report
    function loadRevenueReport(period, city) {
        database.ref('rides').once('value')
            .then(snapshot => {
                const rides = snapshot.val();
                const revenueTable = document.getElementById('revenueTable');
                revenueTable.innerHTML = '';
                
                if (rides) {
                    let periodRides = {};
                    const now = new Date();
                    
                    // Filter rides by period and city
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        const rideDate = new Date(ride.timestamp);
                        let include = false;
                        
                        // Check period
                        switch(period) {
                            case 'today':
                                if (rideDate.toDateString() === now.toDateString()) {
                                    include = true;
                                }
                                break;
                            case 'week':
                                const startOfWeek = new Date(now);
                                startOfWeek.setDate(now.getDate() - now.getDay());
                                startOfWeek.setHours(0, 0, 0, 0);
                                
                                if (rideDate >= startOfWeek) {
                                    include = true;
                                }
                                break;
                            case 'month':
                                if (rideDate.getMonth() === now.getMonth() && 
                                    rideDate.getFullYear() === now.getFullYear()) {
                                    include = true;
                                }
                                break;
                            case 'quarter':
                                const quarterStartMonth = Math.floor(now.getMonth() / 3) * 3;
                                const quarterStart = new Date(now.getFullYear(), quarterStartMonth, 1);
                                
                                if (rideDate >= quarterStart) {
                                    include = true;
                                }
                                break;
                            case 'year':
                                if (rideDate.getFullYear() === now.getFullYear()) {
                                    include = true;
                                }
                                break;
                        }
                        
                        // Check city
                        if (city !== 'all' && ride.currentCity) {
                            include = include && ride.currentCity.toLowerCase().includes(city.toLowerCase());
                        }
                        
                        if (include && ride.status === 'completed' && ride.fare) {
                            const dateKey = rideDate.toDateString();
                            if (!periodRides[dateKey]) {
                                periodRides[dateKey] = {
                                    rides: 0,
                                    revenue: 0,
                                    commission: 0
                                };
                            }
                            
                            periodRides[dateKey].rides++;
                            periodRides[dateKey].revenue += ride.fare;
                            periodRides[dateKey].commission += ride.fare * 0.08; // 8% commission
                        }
                    });
                    
                    // Convert to array and sort by date (newest first)
                    const revenueData = Object.keys(periodRides)
                        .map(date => ({
                            date: date,
                            ...periodRides[date]
                        }))
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Populate table
                    revenueData.forEach(data => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.date}</td>
                            <td>${data.rides}</td>
                            <td>K${data.revenue.toFixed(2)}</td>
                            <td>K${data.commission.toFixed(2)}</td>
                        `;
                        revenueTable.appendChild(row);
                    });
                    
                    // Create chart
                    createRevenueChart(revenueData);
                    
                    // Show message if no data
                    if (revenueData.length === 0) {
                        revenueTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No revenue data for this period</td></tr>';
                    }
                } else {
                    revenueTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No ride data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading revenue report:', error);
                document.getElementById('revenueTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading revenue data</td></tr>';
            });
    }

    // Create revenue chart
    function createRevenueChart(revenueData) {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (revenueChart) {
            revenueChart.destroy();
        }
        
        // Prepare data for chart
        const labels = revenueData.map(item => item.date);
        const revenue = revenueData.map(item => item.revenue);
        const commission = revenueData.map(item => item.commission);
        
        revenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: revenue,
                        backgroundColor: '#FF6B35',
                        borderColor: '#E55A28',
                        borderWidth: 1
                    },
                    {
                        label: 'Commission',
                        data: commission,
                        backgroundColor: '#E74C3C',
                        borderColor: '#C0392B',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'K' + value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Revenue & Commission Over Time'
                    }
                }
            }
        });
    }

    // Load rides report
    function loadRidesReport(period, city) {
        database.ref('rides').once('value')
            .then(snapshot => {
                const rides = snapshot.val();
                const ridesReportTable = document.getElementById('ridesReportTable');
                ridesReportTable.innerHTML = '';
                
                if (rides) {
                    let periodRides = {};
                    const now = new Date();
                    
                    // Filter rides by period and city
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        const rideDate = new Date(ride.timestamp);
                        let include = false;
                        
                        // Check period
                        switch(period) {
                            case 'today':
                                if (rideDate.toDateString() === now.toDateString()) {
                                    include = true;
                                }
                                break;
                            case 'week':
                                const startOfWeek = new Date(now);
                                startOfWeek.setDate(now.getDate() - now.getDay());
                                startOfWeek.setHours(0, 0, 0, 0);
                                
                                if (rideDate >= startOfWeek) {
                                    include = true;
                                }
                                break;
                            case 'month':
                                if (rideDate.getMonth() === now.getMonth() && 
                                    rideDate.getFullYear() === now.getFullYear()) {
                                    include = true;
                                }
                                break;
                            case 'quarter':
                                const quarterStartMonth = Math.floor(now.getMonth() / 3) * 3;
                                const quarterStart = new Date(now.getFullYear(), quarterStartMonth, 1);
                                
                                if (rideDate >= quarterStart) {
                                    include = true;
                                }
                                break;
                            case 'year':
                                if (rideDate.getFullYear() === now.getFullYear()) {
                                    include = true;
                                }
                                break;
                        }
                        
                        // Check city
                        if (city !== 'all' && ride.currentCity) {
                            include = include && ride.currentCity.toLowerCase().includes(city.toLowerCase());
                        }
                        
                        if (include) {
                            const dateKey = rideDate.toDateString();
                            if (!periodRides[dateKey]) {
                                periodRides[dateKey] = {
                                    total: 0,
                                    completed: 0,
                                    cancelled: 0
                                };
                            }
                            
                            periodRides[dateKey].total++;
                            
                            if (ride.status === 'completed') {
                                periodRides[dateKey].completed++;
                            } else if (ride.status === 'cancelled') {
                                periodRides[dateKey].cancelled++;
                            }
                        }
                    });
                    
                    // Convert to array and sort by date (newest first)
                    const ridesData = Object.keys(periodRides)
                        .map(date => ({
                            date: date,
                            ...periodRides[date]
                        }))
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Populate table
                    ridesData.forEach(data => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.date}</td>
                            <td>${data.total}</td>
                            <td>${data.completed}</td>
                            <td>${data.cancelled}</td>
                        `;
                        ridesReportTable.appendChild(row);
                    });
                    
                    // Create chart
                    createRidesChart(ridesData);
                    
                    // Show message if no data
                    if (ridesData.length === 0) {
                        ridesReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No ride data for this period</td></tr>';
                    }
                } else {
                    ridesReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No ride data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading rides report:', error);
                document.getElementById('ridesReportTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading rides data</td></tr>';
            });
    }

    // Create rides chart
    function createRidesChart(ridesData) {
        const ctx = document.getElementById('ridesChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (ridesChart) {
            ridesChart.destroy();
        }
        
        // Prepare data for chart
        const labels = ridesData.map(item => item.date);
        const total = ridesData.map(item => item.total);
        const completed = ridesData.map(item => item.completed);
        const cancelled = ridesData.map(item => item.cancelled);
        
        ridesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Rides',
                        data: total,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        label: 'Completed',
                        data: completed,
                        backgroundColor: '#2ecc71',
                        borderColor: '#27ae60',
                        borderWidth: 2,
                        fill: false
                    },
                    {
                        label: 'Cancelled',
                        data: cancelled,
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 2,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Ride Activity Over Time'
                    }
                }
            }
        });
    }

    // Load drivers report
    function loadDriversReport(period, city) {
        database.ref('users').orderByChild('userType').equalTo('driver').once('value')
            .then(snapshot => {
                const drivers = snapshot.val();
                const driversReportTable = document.getElementById('driversReportTable');
                driversReportTable.innerHTML = '';
                
                if (drivers) {
                    // Get ride data for the period
                    database.ref('rides').once('value')
                        .then(ridesSnapshot => {
                            const rides = ridesSnapshot.val();
                            const now = new Date();
                            
                            // Calculate driver statistics
                            const driverStats = {};
                            
                            Object.keys(drivers).forEach(driverId => {
                                const driver = drivers[driverId];
                                driverStats[driverId] = {
                                    name: driver.name || 'Unknown Driver',
                                    rides: 0,
                                    earnings: 0,
                                    rating: driver.rating || 0
                                };
                                
                                // Count rides for this driver in the selected period
                                if (rides) {
                                    Object.keys(rides).forEach(rideId => {
                                        const ride = rides[rideId];
                                        
                                        if (ride.driverId === driverId && ride.status === 'completed' && ride.fare) {
                                            const rideDate = new Date(ride.timestamp);
                                            let include = false;
                                            
                                            // Check period
                                            switch(period) {
                                                case 'today':
                                                    if (rideDate.toDateString() === now.toDateString()) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'week':
                                                    const startOfWeek = new Date(now);
                                                    startOfWeek.setDate(now.getDate() - now.getDay());
                                                    startOfWeek.setHours(0, 0, 0, 0);
                                                    
                                                    if (rideDate >= startOfWeek) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'month':
                                                    if (rideDate.getMonth() === now.getMonth() && 
                                                        rideDate.getFullYear() === now.getFullYear()) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'quarter':
                                                    const quarterStartMonth = Math.floor(now.getMonth() / 3) * 3;
                                                    const quarterStart = new Date(now.getFullYear(), quarterStartMonth, 1);
                                                    
                                                    if (rideDate >= quarterStart) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'year':
                                                    if (rideDate.getFullYear() === now.getFullYear()) {
                                                        include = true;
                                                    }
                                                    break;
                                            }
                                            
                                            // Check city
                                            if (city !== 'all' && ride.currentCity) {
                                                include = include && ride.currentCity.toLowerCase().includes(city.toLowerCase());
                                            }
                                            
                                            if (include) {
                                                driverStats[driverId].rides++;
                                                driverStats[driverId].earnings += ride.fare * 0.92; // 92% for driver (8% commission)
                                            }
                                        }
                                    });
                                }
                            });
                            
                            // Convert to array and sort by earnings (highest first)
                            const driversData = Object.keys(driverStats)
                                .map(driverId => ({
                                    id: driverId,
                                    ...driverStats[driverId]
                                }))
                                .sort((a, b) => b.earnings - a.earnings);
                            
                            // Populate table
                            driversData.forEach(data => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${data.name}</td>
                                    <td>${data.rides}</td>
                                    <td>K${data.earnings.toFixed(2)}</td>
                                    <td>${data.rating.toFixed(1)}</td>
                                `;
                                driversReportTable.appendChild(row);
                            });
                            
                            // Create chart
                            createDriversChart(driversData);
                            
                            // Show message if no data
                            if (driversData.length === 0) {
                                driversReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No driver data for this period</td></tr>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading rides for drivers report:', error);
                            driversReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading driver data</td></tr>';
                        });
                } else {
                    driversReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No driver data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading drivers report:', error);
                document.getElementById('driversReportTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading driver data</td></tr>';
            });
    }

    // Create drivers chart
    function createDriversChart(driversData) {
        const ctx = document.getElementById('driversChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (driversChart) {
            driversChart.destroy();
        }
        
        // Prepare data for chart (top 10 drivers by earnings)
        const topDrivers = driversData.slice(0, 10);
        const labels = topDrivers.map(driver => driver.name);
        const earnings = topDrivers.map(driver => driver.earnings);
        
        driversChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Earnings (K)',
                    data: earnings,
                    backgroundColor: '#FF6B35',
                    borderColor: '#E55A28',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Top Drivers by Earnings'
                    }
                }
            }
        });
    }

    // Load passengers report
    function loadPassengersReport(period, city) {
        database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
            .then(snapshot => {
                const passengers = snapshot.val();
                const passengersReportTable = document.getElementById('passengersReportTable');
                passengersReportTable.innerHTML = '';
                
                if (passengers) {
                    // Get ride data for the period
                    database.ref('rides').once('value')
                        .then(ridesSnapshot => {
                            const rides = ridesSnapshot.val();
                            const now = new Date();
                            
                            // Calculate passenger statistics
                            const passengerStats = {};
                            
                            Object.keys(passengers).forEach(passengerId => {
                                const passenger = passengers[passengerId];
                                passengerStats[passengerId] = {
                                    name: passenger.name || 'Unknown Passenger',
                                    rides: 0,
                                    spent: 0,
                                    rating: passenger.rating || 0
                                };
                                
                                // Count rides for this passenger in the selected period
                                if (rides) {
                                    Object.keys(rides).forEach(rideId => {
                                        const ride = rides[rideId];
                                        
                                        if (ride.passengerId === passengerId && ride.status === 'completed' && ride.fare) {
                                            const rideDate = new Date(ride.timestamp);
                                            let include = false;
                                            
                                            // Check period
                                            switch(period) {
                                                case 'today':
                                                    if (rideDate.toDateString() === now.toDateString()) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'week':
                                                    const startOfWeek = new Date(now);
                                                    startOfWeek.setDate(now.getDate() - now.getDay());
                                                    startOfWeek.setHours(0, 0, 0, 0);
                                                    
                                                    if (rideDate >= startOfWeek) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'month':
                                                    if (rideDate.getMonth() === now.getMonth() && 
                                                        rideDate.getFullYear() === now.getFullYear()) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'quarter':
                                                    const quarterStartMonth = Math.floor(now.getMonth() / 3) * 3;
                                                    const quarterStart = new Date(now.getFullYear(), quarterStartMonth, 1);
                                                    
                                                    if (rideDate >= quarterStart) {
                                                        include = true;
                                                    }
                                                    break;
                                                case 'year':
                                                    if (rideDate.getFullYear() === now.getFullYear()) {
                                                        include = true;
                                                    }
                                                    break;
                                            }
                                            
                                            // Check city
                                            if (city !== 'all' && ride.currentCity) {
                                                include = include && ride.currentCity.toLowerCase().includes(city.toLowerCase());
                                            }
                                            
                                            if (include) {
                                                passengerStats[passengerId].rides++;
                                                passengerStats[passengerId].spent += ride.fare;
                                            }
                                        }
                                    });
                                }
                            });
                            
                            // Convert to array and sort by spending (highest first)
                            const passengersData = Object.keys(passengerStats)
                                .map(passengerId => ({
                                    id: passengerId,
                                    ...passengerStats[passengerId]
                                }))
                                .sort((a, b) => b.spent - a.spent);
                            
                            // Populate table
                            passengersData.forEach(data => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${data.name}</td>
                                    <td>${data.rides}</td>
                                    <td>K${data.spent.toFixed(2)}</td>
                                    <td>${data.rating.toFixed(1)}</td>
                                `;
                                passengersReportTable.appendChild(row);
                            });
                            
                            // Create chart
                            createPassengersChart(passengersData);
                            
                            // Show message if no data
                            if (passengersData.length === 0) {
                                passengersReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No passenger data for this period</td></tr>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading rides for passengers report:', error);
                            passengersReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading passenger data</td></tr>';
                        });
                } else {
                    passengersReportTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No passenger data available</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading passengers report:', error);
                document.getElementById('passengersReportTable').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading passenger data</td></tr>';
            });
    }

    // Create passengers chart
    function createPassengersChart(passengersData) {
        const ctx = document.getElementById('passengersChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (passengersChart) {
            passengersChart.destroy();
        }
        
        // Prepare data for chart (top 10 passengers by spending)
        const topPassengers = passengersData.slice(0, 10);
        const labels = topPassengers.map(passenger => passenger.name);
        const spent = topPassengers.map(passenger => passenger.spent);
        
        passengersChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Amount Spent (K)',
                    data: spent,
                    backgroundColor: '#9b59b6',
                    borderColor: '#8e44ad',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Top Passengers by Spending'
                    }
                }
            }
        });
    }

    // Load SOS report
    function loadSOSReport(period, city) {
        database.ref('sosAlerts').once('value')
            .then(snapshot => {
                const alerts = snapshot.val();
                const sosReportTable = document.getElementById('sosReportTable');
                sosReportTable.innerHTML = '';
                
                if (alerts) {
                    const now = new Date();
                    let sosData = [];
                    
                    // Filter alerts by period and city
                    Object.keys(alerts).forEach(alertId => {
                        const alert = alerts[alertId];
                        const alertDate = new Date(alert.timestamp);
                        let include = false;
                        
                        // Check period
                        switch(period) {
                            case 'today':
                                if (alertDate.toDateString() === now.toDateString()) {
                                    include = true;
                                }
                                break;
                            case 'week':
                                const startOfWeek = new Date(now);
                                startOfWeek.setDate(now.getDate() - now.getDay());
                                startOfWeek.setHours(0, 0, 0, 0);
                                
                                if (alertDate >= startOfWeek) {
                                    include = true;
                                }
                                break;
                            case 'month':
                                if (alertDate.getMonth() === now.getMonth() && 
                                    alertDate.getFullYear() === now.getFullYear()) {
                                    include = true;
                                }
                                break;
                            case 'quarter':
                                const quarterStartMonth = Math.floor(now.getMonth() / 3) * 3;
                                const quarterStart = new Date(now.getFullYear(), quarterStartMonth, 1);
                                
                                if (alertDate >= quarterStart) {
                                    include = true;
                                }
                                break;
                            case 'year':
                                if (alertDate.getFullYear() === now.getFullYear()) {
                                    include = true;
                                }
                                break;
                        }
                        
                        // Continue from the last line where you ended...

        // Create SOS chart
        function createSOSChart(sosData) {
            const ctx = document.getElementById('sosChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (sosChart) {
                sosChart.destroy();
            }
            
            // Group data by date
            const dateCounts = {};
            sosData.forEach(alert => {
                const date = new Date(alert.timestamp).toDateString();
                if (!dateCounts[date]) {
                    dateCounts[date] = {
                        total: 0,
                        resolved: 0,
                        active: 0
                    };
                }
                dateCounts[date].total++;
                if (alert.resolved) {
                    dateCounts[date].resolved++;
                } else {
                    dateCounts[date].active++;
                }
            });
            
            // Convert to arrays for chart
            const labels = Object.keys(dateCounts);
            const total = labels.map(date => dateCounts[date].total);
            const resolved = labels.map(date => dateCounts[date].resolved);
            const active = labels.map(date => dateCounts[date].active);
            
            sosChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Alerts',
                            data: total,
                            backgroundColor: '#e74c3c',
                            borderColor: '#c0392b',
                            borderWidth: 1
                        },
                        {
                            label: 'Resolved',
                            data: resolved,
                            backgroundColor: '#2ecc71',
                            borderColor: '#27ae60',
                            borderWidth: 1
                        },
                        {
                            label: 'Active',
                            data: active,
                            backgroundColor: '#f39c12',
                            borderColor: '#e67e22',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'SOS Alerts Over Time'
                        }
                    }
                }
            });
        }

        // Export reports
        function exportReports() {
            showNotification('Export functionality would generate CSV/PDF reports here.');
            // In a real app, this would generate and download reports
        }

        // Load settings
        function loadSettings() {
            database.ref('settings').once('value')
                .then(snapshot => {
                    const settings = snapshot.val();
                    if (settings) {
                        if (settings.fareRate) {
                            document.getElementById('fareRate').value = settings.fareRate;
                        }
                        if (settings.commissionRate) {
                            document.getElementById('commissionRate').value = settings.commissionRate;
                        }
                        if (settings.minFloat) {
                            document.getElementById('minFloat').value = settings.minFloat;
                        }
                        if (settings.sosResponseTime) {
                            document.getElementById('sosResponseTime').value = settings.sosResponseTime;
                        }
                        if (settings.expressDeliveryMultiplier) {
                            document.getElementById('expressDeliveryMultiplier').value = settings.expressDeliveryMultiplier;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                });
        }

        // Save settings
        function saveSettings() {
            const fareRate = parseFloat(document.getElementById('fareRate').value);
            const commissionRate = parseFloat(document.getElementById('commissionRate').value);
            const minFloat = parseFloat(document.getElementById('minFloat').value);
            const sosResponseTime = parseInt(document.getElementById('sosResponseTime').value);
            const expressDeliveryMultiplier = parseFloat(document.getElementById('expressDeliveryMultiplier').value);
            
            database.ref('settings').set({
                fareRate: fareRate,
                commissionRate: commissionRate,
                minFloat: minFloat,
                sosResponseTime: sosResponseTime,
                expressDeliveryMultiplier: expressDeliveryMultiplier,
                updatedAt: firebase.database.ServerValue.TIMESTAMP,
                updatedBy: currentUser.uid
            })
            .then(() => {
                showNotification('Settings saved successfully.');
                closeSettingsModal();
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                showNotification('Error saving settings.', 'error');
            });
        }

        // Update driver stats for dashboard
        function updateDriverStats(drivers) {
            let onlineDrivers = 0;
            let offlineDrivers = 0;
            let suspendedDrivers = 0;
            let carDrivers = 0;
            let bikeDrivers = 0;
            let bicycleDrivers = 0;
            let onlineCarDrivers = 0;
            let onlineBikeDrivers = 0;
            let onlineBicycleDrivers = 0;
            let totalRating = 0;
            let ratedDrivers = 0;
            
            if (drivers) {
                Object.keys(drivers).forEach(driverId => {
                    const driver = drivers[driverId];
                    
                    // Count by status
                    if (driver.isOnline) {
                        onlineDrivers++;
                        
                        // Count by vehicle type for online drivers
                        if (driver.vehicle && driver.vehicle.type === 'car') {
                            onlineCarDrivers++;
                        } else if (driver.vehicle && driver.vehicle.type === 'bike') {
                            onlineBikeDrivers++;
                        } else if (driver.vehicle && driver.vehicle.type === 'bicycle') {
                            onlineBicycleDrivers++;
                        }
                    } else {
                        offlineDrivers++;
                    }
                    
                    if (driver.isSuspended) {
                        suspendedDrivers++;
                    }
                    
                    // Count by vehicle type
                    if (driver.vehicle) {
                        if (driver.vehicle.type === 'car') {
                            carDrivers++;
                        } else if (driver.vehicle.type === 'bike') {
                            bikeDrivers++;
                        } else if (driver.vehicle.type === 'bicycle') {
                            bicycleDrivers++;
                        }
                    }
                    
                    // Calculate average rating
                    if (driver.rating) {
                        totalRating += driver.rating;
                        ratedDrivers++;
                    }
                });
            }
            
            // Update dashboard stats
            document.getElementById('totalDrivers').textContent = Object.keys(drivers).length;
            document.getElementById('onlineDrivers').textContent = onlineDrivers;
            
            statsData.totalDrivers = Object.keys(drivers).length;
            statsData.onlineDrivers = onlineDrivers;
            statsData.offlineDrivers = offlineDrivers;
            statsData.suspendedDrivers = suspendedDrivers;
            statsData.carDrivers = carDrivers;
            statsData.bikeDrivers = bikeDrivers;
            statsData.bicycleDrivers = bicycleDrivers;
            statsData.onlineCarDrivers = onlineCarDrivers;
            statsData.onlineBikeDrivers = onlineBikeDrivers;
            statsData.onlineBicycleDrivers = onlineBicycleDrivers;
            statsData.avgDriverRating = ratedDrivers > 0 ? totalRating / ratedDrivers : 0;
            
            // Update dropdown stats
            updateStatsDropdowns();
        }

        // Show notification
        function showNotification(message, type = '') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.style.background = 'var(--error-red)';
            } else if (type === 'success') {
                notification.style.background = 'var(--success-green)';
            } else if (type === 'warning') {
                notification.style.background = 'var(--warning-orange)';
            } else {
                notification.style.background = 'var(--primary-gradient)';
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // NEW: Enhanced function to view driver documents with images
        function viewDriverDocument(driverId, docType) {
            const driver = driversData[driverId];
            if (!driver) return;
            
            // Get document URL from driver data
            const docUrl = driver.images && driver.images[docType];
            if (!docUrl) {
                showNotification('Document not available for viewing.', 'error');
                return;
            }
            
            // Create modal for document viewing
            const modalHTML = `
                <div class="modal-overlay" id="documentViewerModal">
                    <div class="enhanced-modal">
                        <div class="enhanced-modal-header">
                            <h3 class="enhanced-modal-title">
                                <i class="fas fa-file-image"></i>
                                ${getDocumentLabel(docType)} - ${driver.name}
                            </h3>
                            <button class="enhanced-close-modal" id="closeDocumentViewer">&times;</button>
                        </div>
                        <div class="enhanced-modal-content" style="text-align: center;">
                            <img src="${docUrl}" alt="${docType}" 
                                 style="max-width: 100%; max-height: 70vh; border-radius: 5px; border: 2px solid #ddd;">
                            <div class="document-actions" style="margin-top: 15px;">
                                <button class="action-btn btn-secondary" onclick="downloadDocument('${docUrl}', '${driver.name}_${docType}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="action-btn btn-primary" onclick="verifyDocument('${driverId}', '${docType}')">
                                    <i class="fas fa-check-circle"></i> Mark as Verified
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to DOM
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            // Add event listener for close button
            document.getElementById('closeDocumentViewer').addEventListener('click', function() {
                document.body.removeChild(modalContainer);
            });
            
            // Close on outside click
            document.getElementById('documentViewerModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(modalContainer);
                }
            });
        }

        // NEW: Helper function to get document label
        function getDocumentLabel(docType) {
            const labels = {
                'driversLicense': 'Driver\'s License',
                'vehicleFront': 'Vehicle Front View',
                'vehicleBack': 'Vehicle Back View',
                'vehicleSide': 'Vehicle Side View',
                'insurance': 'Insurance Certificate',
                'nrcFront': 'NRC (Front)',
                'nrcBack': 'NRC (Back)',
                'profilePicture': 'Profile Picture'
            };
            return labels[docType] || docType;
        }

        // NEW: Download document function
        function downloadDocument(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = filename || 'document.jpg';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Document download initiated.', 'success');
        }

        // NEW: Verify document function
        function verifyDocument(driverId, docType) {
            if (!confirm(`Are you sure you want to mark this ${getDocumentLabel(docType)} as verified?`)) {
                return;
            }
            
            let verificationField;
            switch(docType) {
                case 'driversLicense':
                    verificationField = 'licenseVerified';
                    break;
                case 'vehicleFront':
                case 'vehicleBack':
                case 'vehicleSide':
                    verificationField = 'vehicleVerified';
                    break;
                case 'insurance':
                    verificationField = 'insuranceVerified';
                    break;
                case 'nrcFront':
                case 'nrcBack':
                    verificationField = 'nrcVerified';
                    break;
                default:
                    verificationField = 'documentsVerified';
            }
            
            database.ref('users/' + driverId).update({
                [verificationField]: true,
                verifiedAt: firebase.database.ServerValue.TIMESTAMP,
                verifiedBy: currentUser.uid
            })
            .then(() => {
                showNotification('Document marked as verified.', 'success');
                // Refresh driver details
                if (selectedDriver === driverId) {
                    showDriverDetails(driverId);
                }
                // Close document viewer if open
                const viewer = document.getElementById('documentViewerModal');
                if (viewer) {
                    viewer.querySelector('.enhanced-close-modal').click();
                }
            })
            .catch(error => {
                console.error('Error verifying document:', error);
                showNotification('Error verifying document.', 'error');
            });
        }

        // NEW: Enhanced ride details with chat history
        function showRideDetailsWithChats(rideId) {
            const ride = ridesData[rideId];
            if (!ride) return;
            
            selectedRide = rideId;
            
            // Load ride details first
            showRideDetails(rideId);
            
            // Then load additional chat and SOS history
            loadRideChatHistory(rideId);
            loadRideSOSHistory(rideId);
        }

        // NEW: Function to load all driver applications
        function loadDriverApplications() {
            database.ref('users').orderByChild('userType').equalTo('driver').once('value')
                .then(snapshot => {
                    const drivers = snapshot.val() || {};
                    driverApplications = {};
                    
                    // Filter only pending applications
                    Object.keys(drivers).forEach(driverId => {
                        const driver = drivers[driverId];
                        if (driver.registrationStatus === 'pending') {
                            driverApplications[driverId] = driver;
                        }
                    });
                    
                    // Display applications if on drivers tab
                    if (document.getElementById('driversTab').classList.contains('active')) {
                        displayDriverApplications();
                    }
                })
                .catch(error => {
                    console.error('Error loading driver applications:', error);
                });
        }

        // NEW: Display driver applications in a separate section
        function displayDriverApplications() {
            const pendingApplicationsSection = document.getElementById('pendingApplicationsSection');
            if (!pendingApplicationsSection) {
                // Create the section if it doesn't exist
                const driversList = document.getElementById('driversList');
                const sectionHTML = `
                    <div class="applications-section" id="pendingApplicationsSection">
                        <h3 class="section-title" style="color: #e74c3c;">
                            <i class="fas fa-clock"></i>
                            Pending Applications (${Object.keys(driverApplications).length})
                        </h3>
                        <div id="pendingApplicationsList"></div>
                    </div>
                `;
                driversList.insertAdjacentHTML('beforebegin', sectionHTML);
            }
            
            const pendingApplicationsList = document.getElementById('pendingApplicationsList');
            pendingApplicationsList.innerHTML = '';
            
            if (Object.keys(driverApplications).length > 0) {
                Object.keys(driverApplications).forEach(driverId => {
                    const driver = driverApplications[driverId];
                    const applicationItem = document.createElement('div');
                    applicationItem.className = 'application-item';
                    
                    const daysAgo = driver.createdAt ? 
                        Math.floor((new Date() - new Date(driver.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
                    
                    applicationItem.innerHTML = `
                        <div class="application-header">
                            <div class="application-title">
                                <strong>${driver.name || 'Applicant'}</strong>
                                <span class="application-badge">Pending ${daysAgo}d ago</span>
                            </div>
                            <div class="application-vehicle">${driver.vehicle?.type || 'Vehicle'} - ${driver.vehicle?.model || 'N/A'}</div>
                        </div>
                        <div class="application-details">
                            <div class="application-info">
                                <span><i class="fas fa-phone"></i> ${driver.phone || 'N/A'}</span>
                                <span><i class="fas fa-envelope"></i> ${driver.email || 'N/A'}</span>
                                <span><i class="fas fa-id-card"></i> ${driver.nrc || 'N/A'}</span>
                            </div>
                            <div class="application-actions">
                                <button class="action-btn btn-success approve-application-btn" data-driver-id="${driverId}">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="action-btn btn-danger reject-application-btn" data-driver-id="${driverId}">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button class="action-btn btn-secondary view-documents-btn" data-driver-id="${driverId}">
                                    <i class="fas fa-eye"></i> View Documents
                                </button>
                            </div>
                        </div>
                    `;
                    
                    pendingApplicationsList.appendChild(applicationItem);
                });
            } else {
                pendingApplicationsList.innerHTML = '<div class="card"><p>No pending applications.</p></div>';
            }
        }

        // NEW: Event listeners for application actions
        document.addEventListener('click', function(e) {
            // Approve application
            if (e.target.closest('.approve-application-btn')) {
                const driverId = e.target.closest('.approve-application-btn').getAttribute('data-driver-id');
                approveDriverApplication(driverId);
            }
            
            // Reject application
            if (e.target.closest('.reject-application-btn')) {
                const driverId = e.target.closest('.reject-application-btn').getAttribute('data-driver-id');
                rejectDriverApplication(driverId);
            }
            
            // View documents
            if (e.target.closest('.view-documents-btn')) {
                const driverId = e.target.closest('.view-documents-btn').getAttribute('data-driver-id');
                viewDriverDocuments(driverId);
            }
        });

        // NEW: Approve driver application
        function approveDriverApplication(driverId) {
            if (!driverId) return;
            
            if (confirm('Are you sure you want to approve this driver application?')) {
                // Update driver registration status and set as verified
                database.ref('users/' + driverId).update({
                    registrationStatus: 'approved',
                    isVerified: true,
                    approvedAt: firebase.database.ServerValue.TIMESTAMP,
                    approvedBy: currentUser.uid,
                    licenseVerified: true,
                    vehicleVerified: true,
                    insuranceVerified: true,
                    nrcVerified: true
                })
                .then(() => {
                    showNotification('Driver application approved successfully!', 'success');
                    
                    // Send notification to driver
                    sendDriverNotification(driverId, 'Congratulations! Your driver application has been approved. You can now log in and start driving.');
                    
                    // Remove from applications list
                    delete driverApplications[driverId];
                    displayDriverApplications();
                    
                    // Refresh drivers list
                    loadDriversData();
                })
                .catch(error => {
                    console.error('Error approving driver application:', error);
                    showNotification('Error approving driver application.', 'error');
                });
            }
        }

        // NEW: Reject driver application
        function rejectDriverApplication(driverId) {
            if (!driverId) return;
            
            const reason = prompt('Please enter the reason for rejection:');
            if (reason === null) return;
            
            if (confirm('Are you sure you want to reject this driver application?')) {
                database.ref('users/' + driverId).update({
                    registrationStatus: 'rejected',
                    rejectedAt: firebase.database.ServerValue.TIMESTAMP,
                    rejectedBy: currentUser.uid,
                    rejectionReason: reason
                })
                .then(() => {
                    showNotification('Driver application rejected.', 'success');
                    
                    // Send notification to driver
                    sendDriverNotification(driverId, `Your driver application has been rejected. Reason: ${reason}`);
                    
                    // Remove from applications list
                    delete driverApplications[driverId];
                    displayDriverApplications();
                })
                .catch(error => {
                    console.error('Error rejecting driver application:', error);
                    showNotification('Error rejecting driver application.', 'error');
                });
            }
        }

        // NEW: Send notification to driver
        function sendDriverNotification(driverId, message) {
            const notificationData = {
                message: message,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                read: false,
                type: 'application_status',
                sender: 'admin'
            };
            
            database.ref('notifications/' + driverId).push(notificationData)
                .catch(error => {
                    console.error('Error sending notification:', error);
                });
        }

        // NEW: View all driver documents
        function viewDriverDocuments(driverId) {
            const driver = driverApplications[driverId] || driversData[driverId];
            if (!driver) return;
            
            // Create modal to view all documents
            const modalHTML = `
                <div class="modal-overlay" id="allDocumentsModal">
                    <div class="enhanced-modal" style="max-width: 800px;">
                        <div class="enhanced-modal-header">
                            <h3 class="enhanced-modal-title">
                                <i class="fas fa-folder-open"></i>
                                Documents - ${driver.name}
                            </h3>
                            <button class="enhanced-close-modal" id="closeAllDocuments">&times;</button>
                        </div>
                        <div class="enhanced-modal-content">
                            <div class="documents-grid" id="documentsGrid">
                                <!-- Documents will be loaded here -->
                            </div>
                            <div class="document-verification-status" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                <h4>Verification Status</h4>
                                <div class="verification-grid">
                                    <div class="verification-item ${driver.licenseVerified ? 'verified' : 'pending'}">
                                        <i class="fas fa-id-card"></i>
                                        <span>Driver's License: ${driver.licenseVerified ? 'Verified' : 'Pending'}</span>
                                    </div>
                                    <div class="verification-item ${driver.vehicleVerified ? 'verified' : 'pending'}">
                                        <i class="fas fa-car"></i>
                                        <span>Vehicle: ${driver.vehicleVerified ? 'Verified' : 'Pending'}</span>
                                    </div>
                                    <div class="verification-item ${driver.insuranceVerified ? 'verified' : 'pending'}">
                                        <i class="fas fa-file-contract"></i>
                                        <span>Insurance: ${driver.insuranceVerified ? 'Verified' : 'Pending'}</span>
                                    </div>
                                    <div class="verification-item ${driver.nrcVerified ? 'verified' : 'pending'}">
                                        <i class="fas fa-address-card"></i>
                                        <span>NRC: ${driver.nrcVerified ? 'Verified' : 'Pending'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            // Load documents into grid
            const documentsGrid = document.getElementById('documentsGrid');
            documentsGrid.innerHTML = '';
            
            if (driver.images) {
                Object.keys(driver.images).forEach(docType => {
                    const docCard = document.createElement('div');
                    docCard.className = 'document-card';
                    docCard.innerHTML = `
                        <div class="document-card-header">
                            <h4>${getDocumentLabel(docType)}</h4>
                            <span class="document-status ${getVerificationStatus(driver, docType)}">
                                ${getVerificationStatus(driver, docType)}
                            </span>
                        </div>
                        <div class="document-card-image">
                            <img src="${driver.images[docType]}" alt="${docType}" 
                                 onclick="viewDocumentInModal('${driver.images[docType]}', '${getDocumentLabel(docType)}')">
                        </div>
                        <div class="document-card-actions">
                            <button class="action-btn btn-secondary" onclick="downloadDocument('${driver.images[docType]}', '${driver.name}_${docType}')">
                                <i class="fas fa-download"></i>
                            </button>
                            ${!isDocumentVerified(driver, docType) ? `
                            <button class="action-btn btn-success" onclick="verifyDocumentFromGrid('${driverId}', '${docType}')">
                                <i class="fas fa-check"></i> Verify
                            </button>
                            ` : ''}
                        </div>
                    `;
                    documentsGrid.appendChild(docCard);
                });
            } else {
                documentsGrid.innerHTML = '<p class="no-documents">No documents uploaded yet.</p>';
            }
            
            // Add event listeners
            document.getElementById('closeAllDocuments').addEventListener('click', function() {
                document.body.removeChild(modalContainer);
            });
            
            document.getElementById('allDocumentsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(modalContainer);
                }
            });
        }

        // NEW: Helper functions for document verification
        function getVerificationStatus(driver, docType) {
            switch(docType) {
                case 'driversLicense': return driver.licenseVerified ? 'Verified' : 'Pending';
                case 'vehicleFront': case 'vehicleBack': case 'vehicleSide': 
                    return driver.vehicleVerified ? 'Verified' : 'Pending';
                case 'insurance': return driver.insuranceVerified ? 'Verified' : 'Pending';
                case 'nrcFront': case 'nrcBack': return driver.nrcVerified ? 'Verified' : 'Pending';
                default: return 'Pending';
            }
        }

        function isDocumentVerified(driver, docType) {
            return getVerificationStatus(driver, docType) === 'Verified';
        }

        // NEW: View document in modal
        function viewDocumentInModal(url, title) {
            const modalHTML = `
                <div class="modal-overlay" id="singleDocumentModal">
                    <div class="enhanced-modal" style="max-width: 90%; max-height: 90%;">
                        <div class="enhanced-modal-header">
                            <h3 class="enhanced-modal-title">
                                <i class="fas fa-file-image"></i>
                                ${title}
                            </h3>
                            <button class="enhanced-close-modal" id="closeSingleDocument">&times;</button>
                        </div>
                        <div class="enhanced-modal-content" style="text-align: center; overflow: auto;">
                            <img src="${url}" alt="${title}" 
                                 style="max-width: 100%; max-height: 70vh; border-radius: 5px;">
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            document.getElementById('closeSingleDocument').addEventListener('click', function() {
                document.body.removeChild(modalContainer);
            });
            
            document.getElementById('singleDocumentModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(modalContainer);
                }
            });
        }

        // NEW: Verify document from grid
        function verifyDocumentFromGrid(driverId, docType) {
            verifyDocument(driverId, docType);
        }

        // NEW: Enhanced driver earnings report
        function showDriverEarningsReport(driverId) {
            const driver = driversData[driverId];
            if (!driver) return;
            
            // Calculate earnings from rides
            let totalEarnings = 0;
            let todayEarnings = 0;
            let weekEarnings = 0;
            let monthEarnings = 0;
            let completedRides = 0;
            let cancelledRides = 0;
            let today = new Date();
            let weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            let monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            
            if (ridesData) {
                Object.keys(ridesData).forEach(rideId => {
                    const ride = ridesData[rideId];
                    if (ride.driverId === driverId && ride.status === 'completed' && ride.fare) {
                        const rideDate = new Date(ride.timestamp);
                        const rideEarnings = ride.fare * 0.92; // 92% for driver
                        
                        totalEarnings += rideEarnings;
                        completedRides++;
                        
                        if (rideDate.toDateString() === today.toDateString()) {
                            todayEarnings += rideEarnings;
                        }
                        
                        if (rideDate >= weekStart) {
                            weekEarnings += rideEarnings;
                        }
                        
                        if (rideDate >= monthStart) {
                            monthEarnings += rideEarnings;
                        }
                    } else if (ride.driverId === driverId && ride.status === 'cancelled') {
                        cancelledRides++;
                    }
                });
            }
            
            // Create earnings report modal
            const modalHTML = `
                <div class="modal-overlay" id="earningsReportModal">
                    <div class="enhanced-modal">
                        <div class="enhanced-modal-header">
                            <h3 class="enhanced-modal-title">
                                <i class="fas fa-chart-line"></i>
                                Earnings Report - ${driver.name}
                            </h3>
                            <button class="enhanced-close-modal" id="closeEarningsReport">&times;</button>
                        </div>
                        <div class="enhanced-modal-content">
                            <div class="earnings-summary">
                                <div class="earnings-card total">
                                    <div class="earnings-value">K${totalEarnings.toFixed(2)}</div>
                                    <div class="earnings-label">Total Earnings</div>
                                </div>
                                <div class="earnings-card today">
                                    <div class="earnings-value">K${todayEarnings.toFixed(2)}</div>
                                    <div class="earnings-label">Today</div>
                                </div>
                                <div class="earnings-card week">
                                    <div class="earnings-value">K${weekEarnings.toFixed(2)}</div>
                                    <div class="earnings-label">This Week</div>
                                </div>
                                <div class="earnings-card month">
                                    <div class="earnings-value">K${monthEarnings.toFixed(2)}</div>
                                    <div class="earnings-label">This Month</div>
                                </div>
                            </div>
                            
                            <div class="earnings-details">
                                <h4>Performance Metrics</h4>
                                <div class="metrics-grid">
                                    <div class="metric-item">
                                        <span class="metric-label">Completed Rides:</span>
                                        <span class="metric-value">${completedRides}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Cancelled Rides:</span>
                                        <span class="metric-value">${cancelledRides}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Average Earnings/Ride:</span>
                                        <span class="metric-value">K${completedRides > 0 ? (totalEarnings / completedRides).toFixed(2) : '0.00'}</span>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-label">Success Rate:</span>
                                        <span class="metric-value">${completedRides + cancelledRides > 0 ? 
                                            Math.round((completedRides / (completedRides + cancelledRides)) * 100) : 0}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="earnings-chart-container">
                                <canvas id="driverEarningsChart" style="height: 300px;"></canvas>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="action-btn btn-primary" onclick="exportDriverEarnings('${driverId}')">
                                    <i class="fas fa-download"></i> Export Report
                                </button>
                                <button class="action-btn btn-secondary" onclick="viewDriverRideHistory('${driverId}')">
                                    <i class="fas fa-history"></i> View Ride History
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHTML;
            document.body.appendChild(modalContainer);
            
            // Create chart
            setTimeout(() => {
                createDriverEarningsChart(driverId);
            }, 100);
            
            document.getElementById('closeEarningsReport').addEventListener('click', function() {
                document.body.removeChild(modalContainer);
            });
            
            document.getElementById('earningsReportModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(modalContainer);
                }
            });
        }

        // NEW: Create driver earnings chart
        function createDriverEarningsChart(driverId) {
            const ctx = document.getElementById('driverEarningsChart').getContext('2d');
            
            // Get last 7 days earnings
            const last7Days = [];
            const earningsData = [];
            const ridesDataPoints = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateString = date.toLocaleDateString('en-US', { weekday: 'short' });
                last7Days.push(dateString);
                
                // Calculate earnings for this day
                let dayEarnings = 0;
                let dayRides = 0;
                
                if (ridesData) {
                    Object.keys(ridesData).forEach(rideId => {
                        const ride = ridesData[rideId];
                        if (ride.driverId === driverId && ride.status === 'completed' && ride.fare) {
                            const rideDate = new Date(ride.timestamp);
                            if (rideDate.toDateString() === date.toDateString()) {
                                dayEarnings += ride.fare * 0.92;
                                dayRides++;
                            }
                        }
                    });
                }
                
                earningsData.push(dayEarnings);
                ridesDataPoints.push(dayRides);
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [
                        {
                            label: 'Earnings (K)',
                            data: earningsData,
                            borderColor: '#FF6B35',
                            backgroundColor: 'rgba(255, 107, 53, 0.1)',
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: 'Rides',
                            data: ridesDataPoints,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Last 7 Days Performance'
                        }
                    }
                }
            });
        }

        // NEW: Export driver earnings
        function exportDriverEarnings(driverId) {
            const driver = driversData[driverId];
            if (!driver) return;
            
            // Generate CSV content
            let csvContent = "Date,Rides,Earnings (K),Commission (K),Status\n";
            
            if (ridesData) {
                Object.keys(ridesData).forEach(rideId => {
                    const ride = ridesData[rideId];
                    if (ride.driverId === driverId) {
                        const date = new Date(ride.timestamp).toLocaleDateString();
                        const earnings = ride.status === 'completed' && ride.fare ? (ride.fare * 0.92).toFixed(2) : '0.00';
                        const commission = ride.status === 'completed' && ride.fare ? (ride.fare * 0.08).toFixed(2) : '0.00';
                        csvContent += `${date},1,${earnings},${commission},${ride.status}\n`;
                    }
                });
            }
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${driver.name}_earnings_report.csv`;
            link.click();
            
            showNotification('Earnings report exported successfully.', 'success');
        }

        // NEW: View driver ride history
        function viewDriverRideHistory(driverId) {
            // Switch to rides tab and filter by driver
            switchTab('ridesTab');
            
            // Set search to driver name
            const driver = driversData[driverId];
            if (driver) {
                document.getElementById('rideSearch').value = driver.name;
                searchRides();
            }
        }

        // NEW: Advanced search functionality
        function advancedSearchDrivers() {
            const searchModalHTML = `
                <div class="modal-overlay" id="advancedSearchModal">
                    <div class="enhanced-modal">
                        <div class="enhanced-modal-header">
                            <h3 class="enhanced-modal-title">
                                <i class="fas fa-search-plus"></i>
                                Advanced Driver Search
                            </h3>
                            <button class="enhanced-close-modal" id="closeAdvancedSearch">&times;</button>
                        </div>
                        <div class="enhanced-modal-content">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" id="searchName" class="form-input" placeholder="Driver name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="text" id="searchPhone" class="form-input" placeholder="Phone number">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vehicle Type</label>
                                <select id="searchVehicleType" class="form-input">
                                    <option value="">All</option>
                                    <option value="car">Car</option>
                                    <option value="bike">Bike</option>
                                    <option value="bicycle">Bicycle</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">License Plate</label>
                                <input type="text" id="searchLicensePlate" class="form-input" placeholder="License plate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input type="text" id="searchCity" class="form-input" placeholder="City">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select id="searchStatus" class="form-input">
                                    <option value="">All</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rating (Min)</label>
                                <select id="searchRating" class="form-input">
                                    <option value="0">Any</option>
                                    <option value="1">1+ Stars</option>
                                    <option value="2">2+ Stars</option>
                                    <option value="3">3+ Stars</option>
                                    <option value="4">4+ Stars</option>
                                    <option value="5">5 Stars</option>
                                </select>
                            </div>
                            <div class="enhanced-modal-actions">
                                <button class="action-btn btn-secondary" id="resetAdvancedSearch">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                                <button class="action-btn btn-primary" id="applyAdvancedSearch">
                                    <i class="fas fa-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = searchModalHTML;
            document.body.appendChild(modalContainer);
            
            // Add event listeners
            document.getElementById('closeAdvancedSearch').addEventListener('click', function() {
                document.body.removeChild(modalContainer);
            });
            
            document.getElementById('advancedSearchModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.body.removeChild(modalContainer);
                }
            });
            
            document.getElementById('resetAdvancedSearch').addEventListener('click', function() {
                document.getElementById('searchName').value = '';
                document.getElementById('searchPhone').value = '';
                document.getElementById('searchVehicleType').value = '';
                document.getElementById('searchLicensePlate').value = '';
                document.getElementById('searchCity').value = '';
                document.getElementById('searchStatus').value = '';
                document.getElementById('searchRating').value = '0';
            });
            
            document.getElementById('applyAdvancedSearch').addEventListener('click', function() {
                performAdvancedSearch();
                document.body.removeChild(modalContainer);
            });
        }

        // NEW: Perform advanced search
        function performAdvancedSearch() {
            const name = document.getElementById('searchName')?.value.toLowerCase() || '';
            const phone = document.getElementById('searchPhone')?.value || '';
            const vehicleType = document.getElementById('searchVehicleType')?.value || '';
            const licensePlate = document.getElementById('searchLicensePlate')?.value.toLowerCase() || '';
            const city = document.getElementById('searchCity')?.value.toLowerCase() || '';
            const status = document.getElementById('searchStatus')?.value || '';
            const minRating = parseFloat(document.getElementById('searchRating')?.value || 0);
            
            const filteredDrivers = {};
            
            Object.keys(driversData).forEach(driverId => {
                const driver = driversData[driverId];
                let matches = true;
                
                // Check name
                if (name && driver.name && !driver.name.toLowerCase().includes(name)) {
                    matches = false;
                }
                
                // Check phone
                if (phone && driver.phone && !driver.phone.includes(phone)) {
                    matches = false;
                }
                
                // Check vehicle type
                if (vehicleType && driver.vehicle?.type !== vehicleType) {
                    matches = false;
                }
                
                // Check license plate
                if (licensePlate && driver.vehicle?.licensePlate && 
                    !driver.vehicle.licensePlate.toLowerCase().includes(licensePlate)) {
                    matches = false;
                }
                
                // Check city (would need to store city in driver data)
                // For now, skip this check
                
                // Check status
                if (status) {
                    if (status === 'online' && !driver.isOnline) {
                        matches = false;
                    } else if (status === 'offline' && driver.isOnline) {
                        matches = false;
                    } else if (status === 'suspended' && !driver.isSuspended) {
                        matches = false;
                    }
                }
                
                // Check rating
                if (minRating > 0 && (!driver.rating || driver.rating < minRating)) {
                    matches = false;
                }
                
                if (matches) {
                    filteredDrivers[driverId] = driver;
                }
            });
            
            displayDrivers(filteredDrivers);
            showNotification(`Found ${Object.keys(filteredDrivers).length} drivers matching your criteria.`, 'success');
        }

        // NEW: Add advanced search button to UI
        function addAdvancedSearchButton() {
            const searchBar = document.querySelector('.search-bar');
            if (searchBar && !document.getElementById('advancedSearchBtn')) {
                const advancedBtn = document.createElement('button');
                advancedBtn.id = 'advancedSearchBtn';
                advancedBtn.className = 'search-btn advanced';
                advancedBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
                advancedBtn.title = 'Advanced Search';
                advancedBtn.addEventListener('click', advancedSearchDrivers);
                searchBar.appendChild(advancedBtn);
            }
        }

        // Initialize advanced features
        function initializeAdvancedFeatures() {
            // Add advanced search button
            addAdvancedSearchButton();
            
            // Load driver applications
            loadDriverApplications();
            
            // Set up periodic refresh
            setInterval(() => {
                if (document.getElementById('dashboardTab').classList.contains('active')) {
                    loadDashboardData();
                }
            }, 30000); // Refresh every 30 seconds
        }

        // Call initialization when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing initialization code ...
            
            // Initialize advanced features
            setTimeout(initializeAdvancedFeatures, 1000);
        });

        // Global functions for external access
        window.showDriverDetails = function(driverId) {
            showDriverDetails(driverId);
        };
        
        window.showRideDetails = function(rideId) {
            showRideDetailsWithChats(rideId);
        };
        
        window.showSOSDetails = function(alertId) {
            showSOSDetails(alertId);
        };
        
        window.showDriverEarningsReport = function(driverId) {
            showDriverEarningsReport(driverId);
        };
        
        window.viewDriverDocuments = function(driverId) {
            viewDriverDocuments(driverId);
        };
        
        window.downloadDocument = function(url, filename) {
            downloadDocument(url, filename);
        };

        // NEW: Add CSS for enhanced features
        const enhancedStyles = `
            <style>
                .applications-section {
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #fff;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                
                .application-item {
                    padding: 15px;
                    margin-bottom: 10px;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    background: #f9f9f9;
                }
                
                .application-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                }
                
                .application-badge {
                    background: #e74c3c;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 12px;
                    font-size: 0.8rem;
                }
                
                .application-info {
                    display: flex;
                    gap: 15px;
                    flex-wrap: wrap;
                    margin-bottom: 10px;
                }
                
                .application-info span {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .application-actions {
                    display: flex;
                    gap: 10px;
                }
                
                .documents-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                    gap: 15px;
                    margin-bottom: 20px;
                }
                
                .document-card {
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    overflow: hidden;
                    background: white;
                }
                
                .document-card-header {
                    padding: 10px;
                    background: #f8f9fa;
                    border-bottom: 1px solid #ddd;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .document-card-image {
                    height: 200px;
                    overflow: hidden;
                }
                
                .document-card-image img {
                    width: 100%;
                    height: 100%;
                    object-fit: cover;
                    cursor: pointer;
                    transition: transform 0.3s;
                }
                
                .document-card-image img:hover {
                    transform: scale(1.05);
                }
                
                .document-card-actions {
                    padding: 10px;
                    display: flex;
                    gap: 10px;
                }
                
                .document-status {
                    padding: 2px 8px;
                    border-radius: 10px;
                    font-size: 0.8rem;
                    font-weight: bold;
                }
                
                .document-status.verified {
                    background: #d4edda;
                    color: #155724;
                }
                
                .document-status.pending {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .verification-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                    margin-top: 10px;
                }
                
                .verification-item {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px;
                    border-radius: 5px;
                }
                
                .verification-item.verified {
                    background: #d4edda;
                    color: #155724;
                }
                
                .verification-item.pending {
                    background: #fff3cd;
                    color: #856404;
                }
                
                .earnings-summary {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 15px;
                    margin-bottom: 20px;
                }
                
                .earnings-card {
                    padding: 15px;
                    border-radius: 8px;
                    text-align: center;
                    color: white;
                }
                
                .earnings-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                .earnings-card.today { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
                .earnings-card.week { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
                .earnings-card.month { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
                
                .earnings-value {
                    font-size: 1.5rem;
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                
                .earnings-label {
                    font-size: 0.9rem;
                    opacity: 0.9;
                }
                
                .metrics-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                    margin: 15px 0;
                }
                
                .metric-item {
                    display: flex;
                    justify-content: space-between;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 5px;
                }
                
                .search-btn.advanced {
                    background: #9b59b6;
                    margin-left: 5px;
                }
                
                .chat-history-item {
                    padding: 10px;
                    margin-bottom: 10px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    background: #f9f9f9;
                }
                
                .chat-history-header {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                    font-size: 0.9rem;
                }
                
                .sos-history-item {
                    padding: 10px;
                    margin-bottom: 10px;
                    border: 1px solid #e74c3c;
                    border-radius: 5px;
                    background: #fff5f5;
                }
                
                .sos-history-header {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                    font-weight: bold;
                }
                
                .no-chats, .no-sos {
                    text-align: center;
                    padding: 20px;
                    color: #666;
                    font-style: italic;
                }
            </style>
        `;
        
        // Add styles to document
        document.head.insertAdjacentHTML('beforeend', enhancedStyles);
    </script>
</body>
</html>


