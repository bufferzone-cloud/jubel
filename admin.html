<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Admin Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS styles would go here - over 1000 lines of CSS */
        /* Due to length, I'll include the most critical styles */
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 6px 20px rgba(0, 0, 0, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Header */
        .header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px var(--app-padding);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-medium);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 700;
        }
        
        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-orange);
            font-weight: 700;
        }
        
        /* Main Content */
        .main-content {
            padding: var(--app-padding);
            padding-bottom: 70px;
            overflow-y: auto;
            height: calc(100vh - 60px);
        }
        
        /* Dashboard */
        .dashboard-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .stat-card.primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        
        .tab {
            padding: 8px 12px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-speed) ease;
        }
        
        .tab.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* List Items */
        .list-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:hover {
            background: var(--light-orange);
        }
        
        .item-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        
        .item-details {
            font-size: 0.75rem;
            color: var(--medium-gray);
            display: flex;
            justify-content: space-between;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
        }
        
        .status-online {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .status-requested {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        .status-accepted {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .status-started {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        /* Map */
        #map {
            height: 300px;
            width: 100%;
            border-radius: var(--element-radius);
            margin-bottom: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
            cursor: pointer;
        }
        
        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-danger {
            background: var(--error-red);
            color: var(--white);
        }
        
        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--app-padding);
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--white);
            border-radius: var(--element-radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--medium-gray);
        }
        
        .modal-content {
            padding: 12px;
        }
        
        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 8px var(--app-padding);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 6px 0;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .nav-item.active {
            color: var(--primary-orange);
        }
        
        .nav-icon {
            font-size: 1.2rem;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            font-weight: 700;
            background: var(--light-gray);
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            margin-bottom: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius) 0 0 var(--element-radius);
            font-size: 0.8rem;
        }
        
        .search-btn {
            padding: 10px 12px;
            background: var(--primary-orange);
            color: var(--white);
            border: none;
            border-radius: 0 var(--element-radius) var(--element-radius) 0;
            cursor: pointer;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        /* Filter */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .filter-select {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            background-color: var(--white);
        }
        
        /* Charts */
        .chart-container {
            height: 150px;
            background: var(--white);
            border-radius: var(--element-radius);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
            position: relative;
        }
        
        /* Detail View */
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .action-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        /* Map Container */
        .map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        /* Full Screen Map */
        .full-screen-map {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 200;
            display: none;
        }
        
        .full-screen-map.active {
            display: block;
        }
        
        /* Ride Tracking */
        .ride-tracking {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            max-width: 300px;
        }
        
        /* Driver Marker */
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Passenger Marker */
        .passenger-marker {
            background: var(--info-blue);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .passenger-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Active Ride Marker */
        .active-ride-marker {
            background: var(--success-green);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .active-ride-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        /* Referral Code */
        .referral-code {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            font-family: monospace;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
        }
        
        /* Dropdown Stats */
        .stats-dropdown {
            position: absolute;
            background: var(--white);
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            padding: 10px;
            z-index: 10;
            width: 200px;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        .stats-dropdown.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-label {
            font-weight: 600;
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .dropdown-value {
            font-weight: 700;
            font-size: 0.8rem;
        }
        
        /* Earnings Header */
        .earnings-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 15px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 15px;
            box-shadow: var(--shadow-medium);
        }
        
        .earnings-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .earnings-amount {
            font-size: 2rem;
            font-weight: 800;
        }
        
        /* Expanded Details */
        .expanded-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expanded-details.active {
            max-height: 500px;
        }
        
        .detail-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        .detail-section-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        /* Stats Cards Container */
        .stats-cards-container {
            position: relative;
        }
        
        /* Chart Canvas */
        .chart-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* Statistics Dropdown Button */
        .stats-dropdown-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--element-radius);
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-light);
            transition: all var(--transition-speed) ease;
        }
        
        .stats-dropdown-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        
        .stats-dropdown-btn i {
            transition: transform var(--transition-speed) ease;
        }
        
        .stats-dropdown-btn.active i {
            transform: rotate(180deg);
        }
        
        .stats-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .stats-container.active {
            max-height: 500px;
        }
        
        /* NEW STYLES FOR ENHANCED FEATURES */
        .wallet-section {
            margin-bottom: 20px;
        }
        
        .wallet-balance-card {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .float-balance-card {
            background: var(--light-orange);
            color: var(--dark-gray);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
            border: 2px solid var(--primary-orange);
        }
        
        .balance-amount-medium {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .history-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.7rem;
        }
        
        .history-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .history-detail-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .history-detail-value {
            font-weight: 600;
        }
        
        .delivery-info-section {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-top: 10px;
        }
        
        .delivery-info-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .delivery-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .delivery-info-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .delivery-info-value {
            font-weight: 600;
        }
        
        .special-instructions {
            background: var(--light-orange);
            padding: 8px;
            border-radius: var(--element-radius);
            margin-top: 8px;
            font-size: 0.75rem;
            border-left: 3px solid var(--primary-orange);
        }
        
        .driver-details-card {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
            border: 1px solid var(--primary-orange);
        }
        
        .driver-details-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .driver-details-header h3 {
            font-size: 0.9rem;
            color: var(--primary-orange);
        }
        
        .driver-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .driver-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .driver-detail-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .driver-detail-value {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .driver-vehicle-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }
        
        .vehicle-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.7rem;
        }
        
        .vehicle-detail-label {
            color: var(--medium-gray);
        }
        
        .vehicle-detail-value {
            font-weight: 600;
        }
        
        .history-item-type {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-bottom: 5px;
            display: inline-block;
        }
        
        .history-item-type.ride {
            background: var(--light-orange);
            color: var(--primary-orange);
        }
        
        .history-item-type.delivery {
            background: var(--light-red);
            color: var(--primary-red);
        }
        
        .history-package-details {
            background: var(--light-gray);
            padding: 8px;
            border-radius: var(--element-radius);
            margin: 8px 0;
            font-size: 0.7rem;
        }
        
        .package-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .package-detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .package-detail-value {
            color: var(--dark-gray);
        }
        
        .history-driver-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }
        
        .history-driver-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .history-driver-details {
            flex: 1;
        }
        
        .history-driver-name {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .history-driver-rating {
            font-size: 0.6rem;
            color: var(--medium-gray);
        }
        
        .history-fare {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .top-performers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .top-performer-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .top-performer-header {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--primary-orange);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-performer-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .top-performer-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.7rem;
        }
        
        .top-performer-item:last-child {
            border-bottom: none;
        }
        
        .top-performer-name {
            font-weight: 600;
        }
        
        .top-performer-value {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .ride-map-container {
            height: 200px;
            border-radius: var(--element-radius);
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .ride-map-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-light);
            z-index: 10;
            display: flex;
            gap: 10px;
            font-size: 0.7rem;
        }
        
        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .map-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .legend-pickup {
            background: var(--primary-orange);
        }
        
        .legend-destination {
            background: var(--primary-red);
        }
        
        .legend-driver {
            background: var(--primary-gradient);
        }
        
        .map-zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .map-zoom-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--primary-orange);
        }
        
        /* Enhanced Ride Details Styles */
        .ride-timeline {
            margin-top: 15px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            position: relative;
        }
        
        .timeline-item:last-child {
            margin-bottom: 0;
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--medium-gray);
            margin-right: 10px;
            flex-shrink: 0;
            margin-top: 3px;
        }
        
        .timeline-dot.active {
            background: var(--primary-orange);
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
            margin-bottom: 2px;
        }
        
        .timeline-event {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .ride-path {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: var(--light-orange);
            border-radius: var(--element-radius);
        }
        
        .path-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }
        
        .path-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-orange);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-bottom: 5px;
        }
        
        .path-icon.destination {
            background: var(--primary-red);
        }
        
        .path-label {
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .path-arrow {
            flex: 0 0 20px;
            text-align: center;
            color: var(--medium-gray);
        }
        
        .ride-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            text-align: center;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        
        .metric-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .metric-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .passenger-ride-history {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .passenger-ride-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.7rem;
        }
        
        .passenger-ride-item:last-child {
            border-bottom: none;
        }
        
        .passenger-ride-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .passenger-ride-date {
            color: var(--medium-gray);
        }
        
        .passenger-ride-status {
            font-weight: 600;
        }
        
        .passenger-ride-details {
            display: flex;
            justify-content: space-between;
        }
        
        .passenger-ride-locations {
            flex: 1;
        }
        
        .passenger-ride-fare {
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .enhanced-map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .enhanced-map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .enhanced-map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .route-details {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-top: 10px;
        }
        
        .route-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .route-detail-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .route-detail-value {
            font-weight: 600;
        }
        
        .driver-performance {
            margin-top: 15px;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .performance-metric {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .performance-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .performance-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        .ride-analytics {
            margin-top: 15px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .analytics-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .analytics-value {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 2px;
        }
        
        .analytics-label {
            font-size: 0.65rem;
            color: var(--medium-gray);
        }
        
        @media (max-width: 480px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .modal {
                max-width: 100%;
            }
            
            .ride-tracking {
                max-width: 250px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .top-performers {
                grid-template-columns: 1fr;
            }
            
            .ride-metrics {
                grid-template-columns: 1fr;
            }
            
            .performance-metrics {
                grid-template-columns: 1fr;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">J</div>
                <div class="logo-text">Jubel Admin</div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <!-- App Earnings Header -->
            <div class="earnings-header">
                <div class="earnings-label">App Earnings (8% Commission)</div>
                <div class="earnings-amount" id="appEarnings">K0.00</div>
            </div>
            
            <!-- Statistics Dropdown Button -->
            <button class="stats-dropdown-btn" id="statsDropdownBtn">
                <i class="fas fa-chart-bar"></i>
                View Statistics
                <i class="fas fa-chevron-down"></i>
            </button>
            
            <!-- Statistics Container (Initially Hidden) -->
            <div class="stats-container" id="statsContainer">
                <div class="dashboard-stats">
                    <div class="stat-card primary" id="totalRidesCard">
                        <div class="stat-value" id="totalRides">0</div>
                        <div class="stat-label">Total Rides</div>
                        <div class="stats-dropdown" id="totalRidesDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Completed:</span>
                                <span class="dropdown-value" id="completedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Cancelled:</span>
                                <span class="dropdown-value" id="cancelledRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Active:</span>
                                <span class="dropdown-value" id="activeRidesCount">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Requested:</span>
                                <span class="dropdown-value" id="requestedRides">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="activeRidesCard">
                        <div class="stat-value" id="activeRides">0</div>
                        <div class="stat-label">Active Rides</div>
                        <div class="stats-dropdown" id="activeRidesDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Accepted:</span>
                                <span class="dropdown-value" id="acceptedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Started:</span>
                                <span class="dropdown-value" id="startedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Arrived:</span>
                                <span class="dropdown-value" id="arrivedRides">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Picked Up:</span>
                                <span class="dropdown-value" id="pickedUpRides">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="totalDriversCard">
                        <div class="stat-value" id="totalDrivers">0</div>
                        <div class="stat-label">Total Drivers</div>
                        <div class="stats-dropdown" id="totalDriversDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Online:</span>
                                <span class="dropdown-value" id="onlineDriversCount">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Offline:</span>
                                <span class="dropdown-value" id="offlineDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Suspended:</span>
                                <span class="dropdown-value" id="suspendedDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Cars:</span>
                                <span class="dropdown-value" id="carDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bikes:</span>
                                <span class="dropdown-value" id="bikeDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bicycles:</span>
                                <span class="dropdown-value" id="bicycleDrivers">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="onlineDriversCard">
                        <div class="stat-value" id="onlineDrivers">0</div>
                        <div class="stat-label">Online Drivers</div>
                        <div class="stats-dropdown" id="onlineDriversDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Cars:</span>
                                <span class="dropdown-value" id="onlineCarDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bikes:</span>
                                <span class="dropdown-value" id="onlineBikeDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Bicycles:</span>
                                <span class="dropdown-value" id="onlineBicycleDrivers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Rating:</span>
                                <span class="dropdown-value" id="avgDriverRating">0.0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="totalPassengersCard">
                        <div class="stat-value" id="totalPassengers">0</div>
                        <div class="stat-label">Total Passengers</div>
                        <div class="stats-dropdown" id="totalPassengersDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Active:</span>
                                <span class="dropdown-value" id="activePassengers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Suspended:</span>
                                <span class="dropdown-value" id="suspendedPassengers">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Rating:</span>
                                <span class="dropdown-value" id="avgPassengerRating">0.0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Rides:</span>
                                <span class="dropdown-value" id="avgPassengerRides">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" id="todayEarningsCard">
                        <div class="stat-value" id="todayEarnings">K0</div>
                        <div class="stat-label">Today's Earnings</div>
                        <div class="stats-dropdown" id="todayEarningsDropdown">
                            <div class="dropdown-item">
                                <span class="dropdown-label">Rides Today:</span>
                                <span class="dropdown-value" id="ridesToday">0</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Commission:</span>
                                <span class="dropdown-value" id="commissionToday">K0.00</span>
                            </div>
                            <div class="dropdown-item">
                                <span class="dropdown-label">Avg Fare:</span>
                                <span class="dropdown-value" id="avgFareToday">K0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top Performers Section -->
            <div class="top-performers">
                <div class="top-performer-card">
                    <div class="top-performer-header">
                        <i class="fas fa-trophy"></i>
                        Top Drivers (Most Rides)
                    </div>
                    <div class="top-performer-list" id="topDriversList">
                        <!-- Top drivers will be populated by JavaScript -->
                    </div>
                </div>
                <div class="top-performer-card">
                    <div class="top-performer-header">
                        <i class="fas fa-trophy"></i>
                        Top Passengers (Most Rides)
                    </div>
                    <div class="top-performer-list" id="topPassengersList">
                        <!-- Top passengers will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Live Tracking Map
                </h3>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="map-control-btn" id="centerMapBtn" title="Center Map">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-control-btn" id="toggleFullScreenBtn" title="Full Screen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="enhanced-map-controls">
                        <button class="enhanced-map-control-btn" id="refreshMapBtn" title="Refresh Map">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="enhanced-map-control-btn" id="toggleDriversBtn" title="Toggle Drivers">
                            <i class="fas fa-car"></i>
                        </button>
                        <button class="enhanced-map-control-btn" id="toggleRidesBtn" title="Toggle Rides">
                            <i class="fas fa-road"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">
                    <i class="fas fa-list"></i>
                    Recent Activity
                </h3>
                <div id="recentActivityList">
                    <!-- Recent activity will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Drivers Tab -->
        <div id="driversTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="driverSearch" placeholder="Search drivers...">
                <button class="search-btn" id="driverSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="driverStatusFilter">
                    <option value="all">All Drivers</option>
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="suspended">Suspended</option>
                </select>
                <select class="filter-select" id="driverVehicleFilter">
                    <option value="all">All Vehicles</option>
                    <option value="car">Car</option>
                    <option value="bike">Bike</option>
                    <option value="bicycle">Bicycle</option>
                </select>
            </div>
            
            <div id="driversList">
                <!-- Drivers will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Passengers Tab -->
        <div id="passengersTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="passengerSearch" placeholder="Search passengers...">
                <button class="search-btn" id="passengerSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="passengerStatusFilter">
                    <option value="all">All Passengers</option>
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>
            
            <div id="passengersList">
                <!-- Passengers will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Rides Tab -->
        <div id="ridesTab" class="tab-content">
            <div class="search-bar">
                <input type="text" class="search-input" id="rideSearch" placeholder="Search rides...">
                <button class="search-btn" id="rideSearchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="rideStatusFilter">
                    <option value="all">All Rides</option>
                    <option value="requested">Requested</option>
                    <option value="accepted">Accepted</option>
                    <option value="started">Started</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <input type="date" class="filter-select" id="rideDateFilter">
            </div>
            
            <div id="ridesList">
                <!-- Rides will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div class="tabs">
                <div class="tab active" data-report="revenue">Revenue</div>
                <div class="tab" data-report="rides">Rides</div>
                <div class="tab" data-report="drivers">Drivers</div>
                <div class="tab" data-report="passengers">Passengers</div>
            </div>
            
            <div class="filter-bar">
                <select class="filter-select" id="reportPeriod">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                </select>
            </div>
            
            <div id="revenueReport" class="report-content active">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="revenueChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Rides</th>
                                    <th>Revenue</th>
                                    <th>Commission</th>
                                </tr>
                            </thead>
                            <tbody id="revenueTable">
                                <!-- Revenue data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="ridesReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="ridesChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total Rides</th>
                                    <th>Completed</th>
                                    <th>Cancelled</th>
                                </tr>
                            </thead>
                            <tbody id="ridesReportTable">
                                <!-- Rides report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="driversReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="driversChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Rides</th>
                                    <th>Earnings</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="driversReportTable">
                                <!-- Drivers report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="passengersReport" class="report-content">
                <div class="card">
                    <div class="chart-container">
                        <canvas id="passengersChart" class="chart-canvas"></canvas>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Passenger</th>
                                    <th>Rides</th>
                                    <th>Spent</th>
                                    <th>Rating</th>
                                </tr>
                            </thead>
                            <tbody id="passengersReportTable">
                                <!-- Passengers report data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="dashboardTab">
            <i class="fas fa-home nav-icon"></i>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" data-tab="driversTab">
            <i class="fas fa-car nav-icon"></i>
            <span>Drivers</span>
        </div>
        <div class="nav-item" data-tab="passengersTab">
            <i class="fas fa-users nav-icon"></i>
            <span>Passengers</span>
        </div>
        <div class="nav-item" data-tab="ridesTab">
            <i class="fas fa-road nav-icon"></i>
            <span>Rides</span>
        </div>
        <div class="nav-item" data-tab="reportsTab">
            <i class="fas fa-chart-bar nav-icon"></i>
            <span>Reports</span>
        </div>
    </div>
    
    <!-- Full Screen Map -->
    <div class="full-screen-map" id="fullScreenMap">
        <div id="fullScreenMapContainer" style="height: 100%; width: 100%;"></div>
        <div class="map-controls">
            <button class="map-control-btn" id="fullScreenZoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="fullScreenZoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="fullScreenCenterBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="map-control-btn" id="exitFullScreenBtn" title="Exit Full Screen">
                <i class="fas fa-compress"></i>
            </button>
        </div>
        <div class="ride-tracking" id="fullScreenRideTracking">
            <!-- Ride tracking info will be populated by JavaScript -->
        </div>
    </div>
    
    <!-- Driver Detail Modal -->
    <div class="modal-overlay" id="driverDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Driver Details</h3>
                <button class="close-modal" id="closeDriverModal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="driverDetailContent">
                    <!-- Driver details will be populated by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-secondary" id="editDriverBtn">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn btn-danger" id="suspendDriverBtn">
                        <i class="fas fa-ban"></i>
                        Suspend
                    </button>
                    <button class="action-btn btn-primary" id="trackDriverBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Passenger Detail Modal -->
    <div class="modal-overlay" id="passengerDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Passenger Details</h3>
                <button class="close-modal" id="closePassengerModal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="passengerDetailContent">
                    <!-- Passenger details will be populated by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-secondary" id="editPassengerBtn">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn btn-danger" id="suspendPassengerBtn">
                        <i class="fas fa-ban"></i>
                        Suspend
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Detail Modal -->
    <div class="modal-overlay" id="rideDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ride Details</h3>
                <button class="close-modal" id="closeRideModal">&times;</button>
            </div>
            <div class="modal-content">
                <div id="rideDetailContent">
                    <!-- Ride details will be populated by JavaScript -->
                </div>
                <div class="expanded-details" id="rideExpandedDetails">
                    <!-- Expanded ride details will be populated by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-danger" id="cancelRideBtn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="action-btn btn-primary" id="reassignRideBtn">
                        <i class="fas fa-sync-alt"></i>
                        Reassign
                    </button>
                    <button class="action-btn btn-success" id="trackRideBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        Track
                    </button>
                    <button class="action-btn btn-secondary" id="viewRideMapBtn">
                        <i class="fas fa-map"></i>
                        View Map
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Ride Map Modal -->
    <div class="modal-overlay" id="rideMapModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ride Route Map</h3>
                <button class="close-modal" id="closeRideMapModal">&times;</button>
            </div>
            <div class="modal-content">
                <div class="ride-map-container" id="rideMapContainer"></div>
                <div class="ride-map-legend">
                    <div class="map-legend-item">
                        <div class="map-legend-color legend-pickup"></div>
                        <span>Pickup</span>
                    </div>
                    <div class="map-legend-item">
                        <div class="map-legend-color legend-destination"></div>
                        <span>Destination</span>
                    </div>
                    <div class="map-legend-item">
                        <div class="map-legend-color legend-driver"></div>
                        <span>Driver</span>
                    </div>
                </div>
                <div class="map-zoom-controls">
                    <button class="map-zoom-btn" id="rideMapZoomIn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="map-zoom-btn" id="rideMapZoomOut">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div class="route-details" id="routeDetails">
                    <!-- Route details will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">System Settings</h3>
                <button class="close-modal" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Fare Rate (K per 90 meters)</label>
                    <input type="number" id="fareRate" class="form-input" value="1" step="0.1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Commission Rate (%)</label>
                    <input type="number" id="commissionRate" class="form-input" value="8" step="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Minimum Float (K)</label>
                    <input type="number" id="minFloat" class="form-input" value="10" step="1">
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelSettingsBtn">Cancel</button>
                    <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
       // Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
    authDomain: "jubel-13e1a.firebaseapp.com",
    databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
    projectId: "jubel-13e1a",
    storageBucket: "jubel-13e1a.firebasestorage.app",
    messagingSenderId: "882241095445",
    appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
    measurementId: "G-J5JPKL6B5F"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

// Enhanced App state with new features
let currentUser = null;
let managerMap, fullScreenMap, rideMap;
let driverMarkers = {};
let passengerMarkers = {};
let activeRideMarkers = {};
let activeRidePolylines = {};
let selectedDriver = null;
let selectedPassenger = null;
let selectedRide = null;
let driversData = {};
let passengersData = {};
let ridesData = {};
let activeRides = {};
let trackedRide = null;
let appEarnings = 0;
let sosAlerts = {};
let isFlashingRed = false;
let flashInterval = null;
let currentSosAlert = null;

// Enhanced statistics with new metrics
let statsData = {
    totalRides: 0,
    activeRides: 0,
    totalDrivers: 0,
    onlineDrivers: 0,
    totalPassengers: 0,
    todayEarnings: 0,
    completedRides: 0,
    cancelledRides: 0,
    requestedRides: 0,
    acceptedRides: 0,
    startedRides: 0,
    arrivedRides: 0,
    pickedUpRides: 0,
    offlineDrivers: 0,
    suspendedDrivers: 0,
    carDrivers: 0,
    bikeDrivers: 0,
    bicycleDrivers: 0,
    onlineCarDrivers: 0,
    onlineBikeDrivers: 0,
    onlineBicycleDrivers: 0,
    avgDriverRating: 0,
    activePassengers: 0,
    suspendedPassengers: 0,
    avgPassengerRating: 0,
    avgPassengerRides: 0,
    ridesToday: 0,
    commissionToday: 0,
    avgFareToday: 0,
    // NEW: Enhanced metrics
    sosAlertsToday: 0,
    avgResponseTime: 0,
    peakHours: [],
    revenueGrowth: 0,
    customerSatisfaction: 0,
    driverRetention: 0,
    cancellationRate: 0,
    surgePricingActive: false
};

// Chart instances
let revenueChart = null;
let ridesChart = null;
let driversChart = null;
let passengersChart = null;
let sosChart = null;
let performanceChart = null;

// NEW: AI-Powered Analytics
let predictiveAnalytics = {
    expectedRides: 0,
    expectedRevenue: 0,
    driverDemand: 0,
    potentialIssues: []
};

// NEW: Real-time monitoring
let realTimeMonitor = {
    activeSessions: 0,
    systemHealth: 'optimal',
    lastIncident: null,
    performanceMetrics: {}
};

// Initialize the app with enhanced features
document.addEventListener('DOMContentLoaded', function() {
    initializeAuth();
    setupEventListeners();
    initializeMap();
    initializeFullScreenMap();
    setupStatsDropdowns();
    initializeRealTimeMonitoring();
    setupSOSAlertSystem();
});

// ENHANCED: Authentication with role-based access
function initializeAuth() {
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('userAvatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'A';
            
            // Check admin privileges
            checkAdminPrivileges(user.uid).then(isAdmin => {
                if (isAdmin) {
                    loadDashboardData();
                    loadDriversData();
                    loadPassengersData();
                    loadRidesData();
                    loadSettings();
                    initializeAIAnalytics();
                } else {
                    showNotification('Access denied. Admin privileges required.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                }
            });
        } else {
            showLoginScreen();
        }
    });
}

// NEW: Check admin privileges
function checkAdminPrivileges(uid) {
    return database.ref('admins/' + uid).once('value')
        .then(snapshot => {
            return snapshot.exists();
        })
        .catch(error => {
            console.error('Error checking admin privileges:', error);
            return false;
        });
}

function showLoginScreen() {
    // In a real app, this would show a login form
    // For demo purposes, we'll auto-login with a dummy user
    auth.signInAnonymously()
        .then(() => {
            console.log('Manager signed in anonymously');
        })
        .catch(error => {
            console.error('Authentication error:', error);
        });
}

// ENHANCED: Initialize map with SOS alert layers
function initializeMap() {
    // Manager map
    managerMap = L.map('map').setView([-15.4167, 28.2833], 13);

    // Use a clean map style
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(managerMap);

    // Listen for driver location updates
    database.ref('driverLocations').on('value', snapshot => {
        const locations = snapshot.val();
        updateDriverMarkers(locations);
    });

    // Listen for active rides
    database.ref('rides').orderByChild('status').equalTo('accepted').on('value', snapshot => {
        const rides = snapshot.val();
        updateActiveRideMarkers(rides);
    });

    database.ref('rides').orderByChild('status').equalTo('started').on('value', snapshot => {
        const rides = snapshot.val();
        updateActiveRideMarkers(rides);
    });

    // NEW: Listen for SOS alerts
    database.ref('sosAlerts').on('value', snapshot => {
        const alerts = snapshot.val();
        handleSOSAlerts(alerts);
    });
}

// NEW: SOS Alert Handling System
function setupSOSAlertSystem() {
    // Create SOS alert panel
    createSOSAlertPanel();
    
    // Listen for new SOS alerts
    database.ref('sosAlerts').orderByChild('timestamp').startAt(Date.now()).on('child_added', snapshot => {
        const alert = snapshot.val();
        if (alert && !alert.resolved) {
            triggerSOSAlert(alert, snapshot.key);
        }
    });
}

// NEW: Create SOS Alert Panel
function createSOSAlertPanel() {
    const sosPanel = document.createElement('div');
    sosPanel.id = 'sosAlertPanel';
    sosPanel.className = 'sos-alert-panel hidden';
    sosPanel.innerHTML = `
        <div class="sos-alert-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>EMERGENCY SOS ALERT</h3>
            <button id="closeSosAlert" class="close-sos-alert">&times;</button>
        </div>
        <div class="sos-alert-content">
            <div id="sosAlertDetails"></div>
            <div class="sos-alert-actions">
                <button class="btn btn-danger" id="acknowledgeSosBtn">
                    <i class="fas fa-check"></i> Acknowledge Alert
                </button>
                <button class="btn btn-primary" id="contactEmergencyBtn">
                    <i class="fas fa-phone"></i> Contact Emergency Services
                </button>
                <button class="btn btn-secondary" id="viewSosLocationBtn">
                    <i class="fas fa-map-marker-alt"></i> View Location
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(sosPanel);

    // Add SOS alert styles
    const style = document.createElement('style');
    style.textContent = `
        .sos-alert-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 3px solid #e74c3c;
            border-radius: 10px;
            z-index: 10000;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.7);
            min-width: 400px;
            max-width: 90vw;
        }
        
        .sos-alert-panel:not(.hidden) {
            display: block;
        }
        
        .sos-alert-panel.hidden {
            display: none;
        }
        
        .sos-alert-header {
            background: #e74c3c;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 7px 7px 0 0;
        }
        
        .sos-alert-header h3 {
            margin: 0;
            flex: 1;
        }
        
        .close-sos-alert {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .sos-alert-content {
            padding: 20px;
        }
        
        .sos-alert-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .flashing-red {
            animation: flashRed 1s infinite;
        }
        
        @keyframes flashRed {
            0%, 100% { background-color: normal; }
            50% { background-color: #ff0000; }
        }
        
        .sos-marker {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
            animation: pulseSOS 1s infinite;
        }
        
        @keyframes pulseSOS {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    `;
    document.head.appendChild(style);
}

// NEW: Handle SOS Alerts
function handleSOSAlerts(alerts) {
    sosAlerts = alerts || {};
    
    // Update SOS stats
    const today = new Date();
    statsData.sosAlertsToday = Object.values(sosAlerts).filter(alert => {
        const alertDate = new Date(alert.timestamp);
        return alertDate.toDateString() === today.toDateString() && !alert.resolved;
    }).length;
    
    updateStatsDropdowns();
    
    // Add SOS markers to map
    updateSOSMarkers();
}

// NEW: Update SOS markers on map
function updateSOSMarkers() {
    // Clear existing SOS markers
    Object.values(sosAlerts).forEach(alert => {
        if (alert.marker) {
            managerMap.removeLayer(alert.marker);
        }
    });
    
    // Add new SOS markers
    Object.entries(sosAlerts).forEach(([alertId, alert]) => {
        if (!alert.resolved && alert.location) {
            const marker = L.marker([alert.location.lat, alert.location.lng], {
                icon: L.divIcon({
                    className: 'sos-marker',
                    html: '<div class="sos-marker"><i class="fas fa-exclamation-triangle"></i></div>',
                    iconSize: [40, 40]
                })
            }).addTo(managerMap)
                .bindPopup(`
                    <div>
                        <strong> EMERGENCY SOS</strong><br>
                        Passenger: ${alert.passengerName || 'Unknown'}<br>
                        Time: ${new Date(alert.timestamp).toLocaleString()}<br>
                        <button onclick="viewSOSDetails('${alertId}')" style="margin-top: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
                    </div>
                `);
            
            alert.marker = marker;
        }
    });
}

// NEW: Trigger SOS Alert with screen flashing
function triggerSOSAlert(alert, alertId) {
    currentSosAlert = { ...alert, id: alertId };
    
    // Start screen flashing
    startScreenFlashing();
    
    // Show SOS alert panel
    showSOSAlertPanel(alert);
    
    // Play emergency sound (if allowed)
    playEmergencySound();
    
    // Send emergency notification to all admins
    notifyAllAdmins(alert);
    
    // Log the emergency
    logEmergencyEvent(alert);
}

// NEW: Start screen flashing effect
function startScreenFlashing() {
    if (isFlashingRed) return;
    
    isFlashingRed = true;
    document.body.classList.add('flashing-red');
    
    // Add flashing styles
    const flashStyle = document.createElement('style');
    flashStyle.id = 'flashStyles';
    flashStyle.textContent = `
        @keyframes flashRed {
            0%, 100% { 
                background-color: normal; 
                box-shadow: none;
            }
            50% { 
                background-color: #ff0000; 
                box-shadow: 0 0 100px rgba(255, 0, 0, 0.8) inset;
            }
        }
        
        .flashing-red {
            animation: flashRed 0.8s infinite !important;
        }
    `;
    document.head.appendChild(flashStyle);
}

// NEW: Stop screen flashing
function stopScreenFlashing() {
    isFlashingRed = false;
    document.body.classList.remove('flashing-red');
    const flashStyle = document.getElementById('flashStyles');
    if (flashStyle) {
        flashStyle.remove();
    }
}

// NEW: Show SOS Alert Panel
function showSOSAlertPanel(alert) {
    const panel = document.getElementById('sosAlertPanel');
    const details = document.getElementById('sosAlertDetails');
    
    details.innerHTML = `
        <div class="sos-alert-info">
            <div class="sos-detail-row">
                <span class="sos-detail-label">Passenger:</span>
                <span class="sos-detail-value">${alert.passengerName || 'Unknown'}</span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Phone:</span>
                <span class="sos-detail-value">${alert.passengerPhone || 'Not provided'}</span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Emergency Contacts:</span>
                <span class="sos-detail-value">
                    ${alert.emergencyContact1 || 'N/A'}${alert.emergencyContact2 ? ', ' + alert.emergencyContact2 : ''}
                </span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Message:</span>
                <span class="sos-detail-value">${alert.message || 'Emergency assistance needed'}</span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Time:</span>
                <span class="sos-detail-value">${new Date(alert.timestamp).toLocaleString()}</span>
            </div>
            ${alert.rideDetails ? `
            <div class="sos-detail-row">
                <span class="sos-detail-label">Ride ID:</span>
                <span class="sos-detail-value">${alert.rideDetails.id || 'N/A'}</span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Pickup:</span>
                <span class="sos-detail-value">${alert.rideDetails.pickupLocation || 'N/A'}</span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Destination:</span>
                <span class="sos-detail-value">${alert.rideDetails.destination || 'N/A'}</span>
            </div>
            ` : ''}
            ${alert.driverDetails ? `
            <div class="sos-detail-row">
                <span class="sos-detail-label">Driver:</span>
                <span class="sos-detail-value">${alert.driverDetails.name || 'N/A'}</span>
            </div>
            <div class="sos-detail-row">
                <span class="sos-detail-label">Driver Phone:</span>
                <span class="sos-detail-value">${alert.driverDetails.phone || 'N/A'}</span>
            </div>
            ` : ''}
        </div>
    `;
    
    panel.classList.remove('hidden');
    
    // Setup event listeners for SOS panel buttons
    document.getElementById('acknowledgeSosBtn').onclick = () => acknowledgeSOSAlert(alert.id);
    document.getElementById('contactEmergencyBtn').onclick = () => contactEmergencyServices(alert);
    document.getElementById('viewSosLocationBtn').onclick = () => viewSOSLocation(alert);
    document.getElementById('closeSosAlert').onclick = () => panel.classList.add('hidden');
}

// NEW: Acknowledge SOS Alert
function acknowledgeSOSAlert(alertId) {
    database.ref('sosAlerts/' + alertId).update({
        acknowledged: true,
        acknowledgedBy: currentUser.uid,
        acknowledgedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        stopScreenFlashing();
        document.getElementById('sosAlertPanel').classList.add('hidden');
        showNotification('SOS alert acknowledged');
    }).catch(error => {
        console.error('Error acknowledging SOS alert:', error);
        showNotification('Error acknowledging alert', 'error');
    });
}

// NEW: Contact Emergency Services
function contactEmergencyServices(alert) {
    const emergencyNumber = '991'; // Zambia emergency number
    const message = `EMERGENCY: SOS alert from Jubel passenger ${alert.passengerName}. Location: ${alert.rideDetails?.pickupLocation || 'Unknown location'}. Passenger phone: ${alert.passengerPhone || 'Not provided'}`;
    
    // In a real implementation, this would integrate with a telephony service
    console.log('Emergency Services Contact:', emergencyNumber, message);
    
    showNotification('Emergency services notified');
    
    // Log the emergency contact
    database.ref('emergencyLogs').push().set({
        alertId: currentSosAlert.id,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        contactedBy: currentUser.uid,
        message: message
    });
}

// NEW: View SOS Location on Map
function viewSOSLocation(alert) {
    if (alert.location) {
        managerMap.setView([alert.location.lat, alert.location.lng], 16);
        
        // Highlight the SOS location
        L.circle([alert.location.lat, alert.location.lng], {
            color: '#e74c3c',
            fillColor: '#e74c3c',
            fillOpacity: 0.3,
            radius: 100
        }).addTo(managerMap).bindPopup('SOS Emergency Location').openPopup();
        
        document.getElementById('sosAlertPanel').classList.add('hidden');
    }
}

// NEW: Play emergency sound
function playEmergencySound() {
    // Create emergency sound using Web Audio API
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sawtooth';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.5);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 1);
    } catch (error) {
        console.log('Audio not supported or blocked');
    }
}

// NEW: Notify all admins about SOS
function notifyAllAdmins(alert) {
    database.ref('admins').once('value').then(snapshot => {
        const admins = snapshot.val();
        if (admins) {
            Object.keys(admins).forEach(adminId => {
                if (adminId !== currentUser.uid) {
                    database.ref('adminNotifications/' + adminId).push().set({
                        type: 'sos_alert',
                        message: `SOS Alert from ${alert.passengerName}`,
                        alertId: currentSosAlert.id,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        read: false
                    });
                }
            });
        }
    });
}

// NEW: Log emergency event
function logEmergencyEvent(alert) {
    database.ref('emergencyAuditLog').push().set({
        alertId: currentSosAlert.id,
        passengerId: alert.passengerId,
        passengerName: alert.passengerName,
        timestamp: alert.timestamp,
        location: alert.location,
        rideDetails: alert.rideDetails,
        driverDetails: alert.driverDetails,
        emergencyContacts: {
            contact1: alert.emergencyContact1,
            contact2: alert.emergencyContact2
        }
    });
}

// ENHANCED: Initialize full screen map with SOS layers
function initializeFullScreenMap() {
    fullScreenMap = L.map('fullScreenMapContainer').setView([-15.4167, 28.2833], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(fullScreenMap);

    // Copy markers from main map to full screen map
    database.ref('driverLocations').once('value').then(snapshot => {
        const locations = snapshot.val();
        updateFullScreenDriverMarkers(locations);
    });

    database.ref('rides').orderByChild('status').equalTo('accepted').once('value').then(snapshot => {
        const rides = snapshot.val();
        updateFullScreenActiveRideMarkers(rides);
    });

    database.ref('rides').orderByChild('status').equalTo('started').once('value').then(snapshot => {
        const rides = snapshot.val();
        updateFullScreenActiveRideMarkers(rides);
    });

    // NEW: Add SOS markers to full screen map
    database.ref('sosAlerts').once('value').then(snapshot => {
        const alerts = snapshot.val();
        updateFullScreenSOSMarkers(alerts);
    });
}

// NEW: Update SOS markers on full screen map
function updateFullScreenSOSMarkers(alerts) {
    if (alerts) {
        Object.entries(alerts).forEach(([alertId, alert]) => {
            if (!alert.resolved && alert.location) {
                L.marker([alert.location.lat, alert.location.lng], {
                    icon: L.divIcon({
                        className: 'sos-marker',
                        html: '<div class="sos-marker"><i class="fas fa-exclamation-triangle"></i></div>',
                        iconSize: [40, 40]
                    })
                }).addTo(fullScreenMap)
                    .bindPopup(`
                        <div>
                            <strong> EMERGENCY SOS</strong><br>
                            Passenger: ${alert.passengerName || 'Unknown'}<br>
                            Time: ${new Date(alert.timestamp).toLocaleString()}<br>
                            <button onclick="viewSOSDetails('${alertId}')" style="margin-top: 5px; padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">View Details</button>
                        </div>
                    `);
            }
        });
    }
}

// ENHANCED: Initialize ride map for modal with SOS support
function initializeRideMap() {
    rideMap = L.map('rideMapContainer').setView([-15.4167, 28.2833], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
    }).addTo(rideMap);
}

// ENHANCED: Update driver markers with performance indicators
function updateDriverMarkers(locations) {
    if (locations) {
        Object.keys(locations).forEach(driverId => {
            const location = locations[driverId];
            const driver = driversData[driverId];
            
            if (driver && location.latitude && location.longitude) {
                // Remove existing marker if present
                if (driverMarkers[driverId]) {
                    managerMap.removeLayer(driverMarkers[driverId]);
                }
                
                // Determine marker color based on performance
                const performance = calculateDriverPerformance(driver);
                const markerColor = getPerformanceColor(performance);
                
                // Create enhanced marker for driver
                const marker = L.marker([location.latitude, location.longitude], {
                    icon: L.divIcon({
                        className: 'driver-marker',
                        html: `
                            <div class="driver-marker" style="background: ${markerColor};">
                                ${getVehicleIcon(driver.vehicle?.type)}
                            </div>
                            <div class="driver-marker-label">${driver.name || 'Driver'}</div>
                            ${performance > 80 ? '<div class="performance-badge"></div>' : ''}
                        `,
                        iconSize: [35, 50]
                    })
                }).addTo(managerMap)
                    .bindPopup(createDriverPopup(driver, location));
                
                driverMarkers[driverId] = marker;
            }
        });
        
        // Fit map to show all drivers if there are any
        if (Object.keys(driverMarkers).length > 0) {
            const group = new L.featureGroup(Object.values(driverMarkers));
            managerMap.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }
}

// NEW: Calculate driver performance score
function calculateDriverPerformance(driver) {
    let score = 50; // Base score
    
    // Rating contribution (0-30 points)
    if (driver.rating) {
        score += (driver.rating - 3) * 10; // 3 = 50, 4 = 60, 5 = 70
    }
    
    // Experience contribution (0-10 points)
    if (driver.experience) {
        const expYears = parseInt(driver.experience) || 0;
        score += Math.min(expYears * 2, 10);
    }
    
    // Completion rate contribution (0-10 points)
    if (driver.completedRides && driver.totalRides) {
        const completionRate = (driver.completedRides / driver.totalRides) * 100;
        score += Math.min(completionRate / 10, 10);
    }
    
    return Math.min(Math.max(score, 0), 100);
}

// NEW: Get performance color
function getPerformanceColor(performance) {
    if (performance >= 80) return '#2ecc71'; // Green
    if (performance >= 60) return '#f39c12'; // Orange
    return '#e74c3c'; // Red
}

// ENHANCED: Create driver popup with performance metrics
function createDriverPopup(driver, location) {
    const performance = calculateDriverPerformance(driver);
    
    return `
        <div style="min-width: 200px;">
            <strong>${driver.name || 'Driver'}</strong>
            <div class="performance-bar" style="background: #ecf0f1; border-radius: 10px; height: 8px; margin: 5px 0;">
                <div style="background: ${getPerformanceColor(performance)}; height: 100%; border-radius: 10px; width: ${performance}%;"></div>
            </div>
            <div style="font-size: 0.8em; color: #7f8c8d;">Performance: ${performance}%</div>
            ${driver.vehicle?.type || 'Vehicle'} - ${driver.vehicle?.licensePlate || 'N/A'}<br>
            Status: ${driver.isOnline ? ' Online' : ' Offline'}<br>
            Rating: ${driver.rating || 'N/A'} <br>
            <div style="margin-top: 8px; display: flex; gap: 5px;">
                <button onclick="showDriverDetails('${driver.uid}')" style="flex: 1; padding: 5px 8px; background: #FF6B35; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">View Details</button>
                <button onclick="trackDriver('${driver.uid}')" style="padding: 5px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;"></button>
            </div>
        </div>
    `;
}

// ENHANCED: Update active ride markers with status indicators
function updateActiveRideMarkers(rides) {
    if (rides) {
        Object.keys(rides).forEach(rideId => {
            const ride = rides[rideId];
            
            // Remove existing markers and polylines if present
            if (activeRideMarkers[rideId]) {
                managerMap.removeLayer(activeRideMarkers[rideId]);
                delete activeRideMarkers[rideId];
            }
            
            if (activeRidePolylines[rideId]) {
                managerMap.removeLayer(activeRidePolylines[rideId]);
                delete activeRidePolylines[rideId];
            }
            
            // Create marker for active ride with status-based styling
            if (ride.pickupLat && ride.pickupLng) {
                const statusColor = getRideStatusColor(ride.status);
                const marker = L.marker([ride.pickupLat, ride.pickupLng], {
                    icon: L.divIcon({
                        className: 'active-ride-marker',
                        html: `
                            <div class="active-ride-marker" style="background: ${statusColor};">
                                
                            </div>
                            <div class="active-ride-marker-label">${getRideStatusText(ride.status)}</div>
                        `,
                        iconSize: [40, 55]
                    })
                }).addTo(managerMap)
                    .bindPopup(createActiveRidePopup(ride));
                
                activeRideMarkers[rideId] = marker;
                
                // Draw route if destination coordinates are available
                if (ride.destLat && ride.destLng) {
                    drawRoute(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng, rideId);
                }
            }
        });
    }
}

// NEW: Get ride status color
function getRideStatusColor(status) {
    const colors = {
        'requested': '#f39c12',
        'accepted': '#3498db',
        'arrived': '#9b59b6',
        'started': '#2ecc71',
        'picked_up': '#27ae60',
        'completed': '#95a5a6',
        'cancelled': '#e74c3c'
    };
    return colors[status] || '#3498db';
}

// NEW: Get ride status text
function getRideStatusText(status) {
    const texts = {
        'requested': 'Requested',
        'accepted': 'Accepted',
        'arrived': 'Arrived',
        'started': 'Started',
        'picked_up': 'Picked Up',
        'completed': 'Completed',
        'cancelled': 'Cancelled'
    };
    return texts[status] || 'Active Ride';
}

// ENHANCED: Create active ride popup with enhanced details
function createActiveRidePopup(ride) {
    const duration = ride.startedAt ? calculateRideDuration(ride) : 'Not started';
    const fare = ride.fare ? `K${ride.fare.toFixed(2)}` : 'Calculating...';
    
    return `
        <div style="min-width: 220px;">
            <strong>${ride.rideType === 'bike' || ride.rideType === 'bicycle' ? ' Delivery' : ' Ride'}</strong>
            <div style="font-size: 0.8em; color: #7f8c8d; margin: 5px 0;">
                Status: <span style="color: ${getRideStatusColor(ride.status)}; font-weight: bold;">${getRideStatusText(ride.status)}</span>
            </div>
            Passenger: ${ride.passengerName || 'N/A'}<br>
            Driver: ${ride.driverId ? 'Assigned' : 'Not assigned'}<br>
            From: ${ride.pickupLocation || 'N/A'}<br>
            To: ${ride.destination || 'N/A'}<br>
            Fare: ${fare}<br>
            Duration: ${duration}<br>
            <div style="margin-top: 8px; display: flex; gap: 5px;">
                <button onclick="showRideDetails('${ride.id}')" style="flex: 1; padding: 5px 8px; background: #FF6B35; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">View Details</button>
                ${ride.driverId ? `<button onclick="trackRide('${ride.id}')" style="padding: 5px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;"></button>` : ''}
            </div>
        </div>
    `;
}

// ENHANCED: Event listeners setup with SOS handlers
function setupEventListeners() {
    // Statistics dropdown button
    document.getElementById('statsDropdownBtn').addEventListener('click', function() {
        this.classList.toggle('active');
        document.getElementById('statsContainer').classList.toggle('active');
    });
    
    // Bottom navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            switchTab(tabId);
        });
    });
    
    // Report tabs
    document.querySelectorAll('.tab[data-report]').forEach(tab => {
        tab.addEventListener('click', function() {
            const reportId = this.getAttribute('data-report');
            switchReport(reportId);
        });
    });
    
    // Search buttons
    document.getElementById('driverSearchBtn').addEventListener('click', searchDrivers);
    document.getElementById('passengerSearchBtn').addEventListener('click', searchPassengers);
    document.getElementById('rideSearchBtn').addEventListener('click', searchRides);
    
    // Filter changes
    document.getElementById('driverStatusFilter').addEventListener('change', filterDrivers);
    document.getElementById('driverVehicleFilter').addEventListener('change', filterDrivers);
    document.getElementById('passengerStatusFilter').addEventListener('change', filterPassengers);
    document.getElementById('rideStatusFilter').addEventListener('change', filterRides);
    document.getElementById('rideDateFilter').addEventListener('change', filterRides);
    document.getElementById('reportPeriod').addEventListener('change', loadReports);
    
    // Map controls
    document.getElementById('zoomInBtn').addEventListener('click', () => managerMap.zoomIn());
    document.getElementById('zoomOutBtn').addEventListener('click', () => managerMap.zoomOut());
    document.getElementById('centerMapBtn').addEventListener('click', centerMap);
    document.getElementById('toggleFullScreenBtn').addEventListener('click', toggleFullScreenMap);
    document.getElementById('refreshMapBtn').addEventListener('click', refreshMap);
    document.getElementById('toggleDriversBtn').addEventListener('click', toggleDriversVisibility);
    document.getElementById('toggleRidesBtn').addEventListener('click', toggleRidesVisibility);
    
    // Full screen map controls
    document.getElementById('fullScreenZoomInBtn').addEventListener('click', () => fullScreenMap.zoomIn());
    document.getElementById('fullScreenZoomOutBtn').addEventListener('click', () => fullScreenMap.zoomOut());
    document.getElementById('fullScreenCenterBtn').addEventListener('click', centerFullScreenMap);
    document.getElementById('exitFullScreenBtn').addEventListener('click', exitFullScreenMap);
    
    // Modal close buttons
    document.getElementById('closeDriverModal').addEventListener('click', closeDriverModal);
    document.getElementById('closePassengerModal').addEventListener('click', closePassengerModal);
    document.getElementById('closeRideModal').addEventListener('click', closeRideModal);
    document.getElementById('closeRideMapModal').addEventListener('click', closeRideMapModal);
    document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
    document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettingsModal);
    
    // Action buttons
    document.getElementById('editDriverBtn').addEventListener('click', editDriver);
    document.getElementById('suspendDriverBtn').addEventListener('click', suspendDriver);
    document.getElementById('trackDriverBtn').addEventListener('click', trackDriver);
    document.getElementById('editPassengerBtn').addEventListener('click', editPassenger);
    document.getElementById('suspendPassengerBtn').addEventListener('click', suspendPassenger);
    document.getElementById('cancelRideBtn').addEventListener('click', cancelRide);
    document.getElementById('reassignRideBtn').addEventListener('click', reassignRide);
    document.getElementById('trackRideBtn').addEventListener('click', trackRide);
    document.getElementById('viewRideMapBtn').addEventListener('click', viewRideMap);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    
    // Settings button in header
    document.getElementById('userAvatar').addEventListener('click', openSettings);
    
    // View more details for rides
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('view-more-details')) {
            const rideId = e.target.getAttribute('data-ride-id');
            toggleRideDetails(rideId);
        }
    });
    
    // Ride map controls
    document.getElementById('rideMapZoomIn').addEventListener('click', () => rideMap.zoomIn());
    document.getElementById('rideMapZoomOut').addEventListener('click', () => rideMap.zoomOut());
    
    // NEW: SOS Alert listeners
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'closeSosAlert') {
            document.getElementById('sosAlertPanel').classList.add('hidden');
        }
    });
    
    // NEW: Emergency broadcast system
    document.addEventListener('keydown', function(e) {
        // Ctrl+E for emergency broadcast (admin feature)
        if (e.ctrlKey && e.key === 'e') {
            e.preventDefault();
            showEmergencyBroadcastModal();
        }
    });
    
    // NEW: Real-time notifications
    setupRealTimeNotifications();
}

// NEW: Setup real-time notifications
function setupRealTimeNotifications() {
    if (currentUser) {
        // Listen for admin notifications
        database.ref('adminNotifications/' + currentUser.uid).orderByChild('read').equalTo(false).on('child_added', snapshot => {
            const notification = snapshot.val();
            showPushNotification(notification);
            
            // Mark as read
            database.ref('adminNotifications/' + currentUser.uid + '/' + snapshot.key).update({
                read: true
            });
        });
    }
}

// NEW: Show push notification
function showPushNotification(notification) {
    // Create notification element
    const notif = document.createElement('div');
    notif.className = 'push-notification';
    notif.innerHTML = `
        <div class="notification-content">
            <div class="notification-title">${notification.type === 'sos_alert' ? ' SOS Alert' : ' Notification'}</div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${new Date(notification.timestamp).toLocaleTimeString()}</div>
        </div>
        <button class="close-notification">&times;</button>
    `;
    
    document.body.appendChild(notif);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notif.parentNode) {
            notif.parentNode.removeChild(notif);
        }
    }, 5000);
    
    // Add styles for push notifications
    if (!document.getElementById('pushNotificationStyles')) {
        const style = document.createElement('style');
        style.id = 'pushNotificationStyles';
        style.textContent = `
            .push-notification {
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                border-left: 4px solid #3498db;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                padding: 15px;
                min-width: 300px;
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.3s ease;
            }
            
            .push-notification.sos-alert {
                border-left-color: #e74c3c;
                background: #ffeaea;
            }
            
            .notification-content {
                flex: 1;
            }
            
            .notification-title {
                font-weight: bold;
                margin-bottom: 5px;
                color: #2c3e50;
            }
            
            .notification-message {
                font-size: 0.9em;
                color: #34495e;
                margin-bottom: 5px;
            }
            
            .notification-time {
                font-size: 0.8em;
                color: #7f8c8d;
            }
            
            .close-notification {
                background: none;
                border: none;
                font-size: 1.2em;
                cursor: pointer;
                color: #95a5a6;
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); }
                to { transform: translateX(0); }
            }
        `;
        document.head.appendChild(style);
    }
}

// ENHANCED: Load dashboard data with AI analytics
function loadDashboardData() {
    // Load total rides
    database.ref('rides').once('value')
        .then(snapshot => {
            const rides = snapshot.val();
            const totalRides = rides ? Object.keys(rides).length : 0;
            document.getElementById('totalRides').textContent = totalRides;
            statsData.totalRides = totalRides;
            
            // Calculate advanced metrics
            calculateAdvancedMetrics(rides);
            
            // Update dashboard stats
            updateDashboardStats(rides);
            
            // Load AI predictions
            generateAIPredictions(rides);
            
            // Load recent activity
            loadRecentActivity(rides);
            
            // Load top performers
            loadTopPerformers(rides);
        })
        .catch(error => {
            console.error('Error loading rides:', error);
        });
    
    // Load drivers data
    database.ref('users').orderByChild('userType').equalTo('driver').once('value')
        .then(snapshot => {
            driversData = snapshot.val() || {};
            updateDriverStats(driversData);
        })
        .catch(error => {
            console.error('Error loading drivers:', error);
        });
    
    // Load passengers data
    database.ref('users').orderByChild('userType').equalTo('passenger').once('value')
        .then(snapshot => {
            passengersData = snapshot.val() || {};
            updatePassengerStats(passengersData);
        })
        .catch(error => {
            console.error('Error loading passengers:', error);
        });
    
    // NEW: Load system health
    loadSystemHealth();
}

// NEW: Calculate advanced metrics
function calculateAdvancedMetrics(rides) {
    if (!rides) return;
    
    let totalFare = 0;
    let totalDuration = 0;
    let completedRides = 0;
    const hourlyDistribution = Array(24).fill(0);
    const cancellationReasons = {};
    
    Object.values(rides).forEach(ride => {
        if (ride.status === 'completed' && ride.fare) {
            completedRides++;
            totalFare += ride.fare;
            
            // Calculate duration
            if (ride.startedAt && ride.completedAt) {
                const duration = (ride.completedAt - ride.startedAt) / (1000 * 60); // minutes
                totalDuration += duration;
            }
            
            // Hourly distribution
            const hour = new Date(ride.timestamp).getHours();
            hourlyDistribution[hour]++;
        }
        
        // Cancellation analysis
        if (ride.status === 'cancelled') {
            const reason = ride.cancelledBy || 'unknown';
            cancellationReasons[reason] = (cancellationReasons[reason] || 0) + 1;
        }
    });
    
    // Update stats
    statsData.avgFareToday = completedRides > 0 ? totalFare / completedRides : 0;
    statsData.avgResponseTime = completedRides > 0 ? totalDuration / completedRides : 0;
    statsData.cancellationRate = statsData.totalRides > 0 ? (statsData.cancelledRides / statsData.totalRides) * 100 : 0;
    statsData.peakHours = findPeakHours(hourlyDistribution);
    statsData.customerSatisfaction = calculateCustomerSatisfaction(rides);
}

// NEW: Find peak hours
function findPeakHours(hourlyDistribution) {
    const peaks = [];
    const max = Math.max(...hourlyDistribution);
    
    hourlyDistribution.forEach((count, hour) => {
        if (count >= max * 0.7) { // 70% of peak or higher
            peaks.push({
                hour: hour,
                count: count,
                percentage: (count / max) * 100
            });
        }
    });
    
    return peaks.sort((a, b) => b.count - a.count).slice(0, 3);
}

// NEW: Calculate customer satisfaction
function calculateCustomerSatisfaction(rides) {
    if (!rides) return 0;
    
    let totalRating = 0;
    let ratedRides = 0;
    
    Object.values(rides).forEach(ride => {
        if (ride.rating) {
            totalRating += ride.rating;
            ratedRides++;
        }
    });
    
    return ratedRides > 0 ? (totalRating / ratedRides) * 20 : 75; // Convert to percentage
}

// NEW: Generate AI predictions
function generateAIPredictions(rides) {
    if (!rides) return;
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentDay = now.getDay();
    
    // Simple prediction algorithm (in real app, this would use ML)
    const historicalData = analyzeHistoricalPatterns(rides);
    
    predictiveAnalytics = {
        expectedRides: Math.round(historicalData.avgDailyRides * getDayMultiplier(currentDay) * getHourMultiplier(currentHour)),
        expectedRevenue: Math.round(historicalData.avgDailyRevenue * getDayMultiplier(currentDay) * getHourMultiplier(currentHour)),
        driverDemand: calculateDriverDemand(historicalData, currentHour, currentDay),
        potentialIssues: identifyPotentialIssues(rides)
    };
    
    // Update AI predictions display
    updateAIPredictionsDisplay();
}

// NEW: Update AI predictions display
function updateAIPredictionsDisplay() {
    const predictionsContainer = document.getElementById('aiPredictions');
    if (!predictionsContainer) {
        // Create AI predictions section
        const statsContainer = document.getElementById('statsContainer');
        const aiSection = document.createElement('div');
        aiSection.className = 'ai-predictions-section';
        aiSection.innerHTML = `
            <h3 class="section-title">
                <i class="fas fa-robot"></i>
                AI Predictions & Analytics
            </h3>
            <div class="ai-predictions-grid">
                <div class="ai-prediction-card">
                    <div class="ai-prediction-value">${predictiveAnalytics.expectedRides}</div>
                    <div class="ai-prediction-label">Expected Rides Today</div>
                </div>
                <div class="ai-prediction-card">
                    <div class="ai-prediction-value">K${predictiveAnalytics.expectedRevenue.toFixed(0)}</div>
                    <div class="ai-prediction-label">Expected Revenue</div>
                </div>
                <div class="ai-prediction-card">
                    <div class="ai-prediction-value">${predictiveAnalytics.driverDemand}</div>
                    <div class="ai-prediction-label">Driver Demand Level</div>
                </div>
            </div>
            ${predictiveAnalytics.potentialIssues.length > 0 ? `
            <div class="potential-issues">
                <h4>Potential Issues</h4>
                <ul>
                    ${predictiveAnalytics.potentialIssues.map(issue => `<li>${issue}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
        `;
        statsContainer.appendChild(aiSection);
        
        // Add AI styles
        const style = document.createElement('style');
        style.textContent = `
            .ai-predictions-section {
                margin-top: 20px;
                padding: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                color: white;
            }
            
            .ai-predictions-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin: 15px 0;
            }
            
            .ai-prediction-card {
                background: rgba(255, 255, 255, 0.2);
                padding: 15px;
                border-radius: 8px;
                text-align: center;
                backdrop-filter: blur(10px);
            }
            
            .ai-prediction-value {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 5px;
            }
            
            .ai-prediction-label {
                font-size: 0.8rem;
                opacity: 0.9;
            }
            
            .potential-issues {
                background: rgba(231, 76, 60, 0.3);
                padding: 10px;
                border-radius: 5px;
                margin-top: 10px;
            }
            
            .potential-issues h4 {
                margin-bottom: 8px;
            }
            
            .potential-issues ul {
                margin: 0;
                padding-left: 20px;
            }
            
            .potential-issues li {
                margin-bottom: 5px;
                font-size: 0.9rem;
            }
        `;
        document.head.appendChild(style);
    }
}

// ENHANCED: Show driver details with expanded registration information
function showDriverDetails(driverId) {
    const driver = driversData[driverId];
    if (!driver) return;

    selectedDriver = driverId;

    const driverDetailContent = document.getElementById('driverDetailContent');
    
    // Get comprehensive driver information
    const driverInfo = getComprehensiveDriverInfo(driver, driverId);
    
    driverDetailContent.innerHTML = `
        <!-- Basic Information Section -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-user"></i>
                Personal Information
            </div>
            <div class="detail-grid">
                <div class="detail-row">
                    <span class="detail-label">Full Name:</span>
                    <span class="detail-value">${driverInfo.personal.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone Number:</span>
                    <span class="detail-value">${driverInfo.personal.phone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email Address:</span>
                    <span class="detail-value">${driverInfo.personal.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">NRC Number:</span>
                    <span class="detail-value">${driverInfo.personal.nrc}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date of Birth:</span>
                    <span class="detail-value">${driverInfo.personal.dob}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Gender:</span>
                    <span class="detail-value">${driverInfo.personal.gender}</span>
                </div>
            </div>
        </div>

        <!-- Vehicle Information Section -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-car"></i>
                Vehicle Information
            </div>
            <div class="detail-grid">
                <div class="detail-row">
                    <span class="detail-label">Vehicle Type:</span>
                    <span class="detail-value">${driverInfo.vehicle.type}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Make & Model:</span>
                    <span class="detail-value">${driverInfo.vehicle.makeModel}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Year:</span>
                    <span class="detail-value">${driverInfo.vehicle.year}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Color:</span>
                    <span class="detail-value">${driverInfo.vehicle.color}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">License Plate:</span>
                    <span class="detail-value">${driverInfo.vehicle.licensePlate}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Vehicle Registration:</span>
                    <span class="detail-value">${driverInfo.vehicle.registration}</span>
                </div>
            </div>
        </div>

        <!-- Driver License Information -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-id-card"></i>
                Driver's License
            </div>
            <div class="detail-grid">
                <div class="detail-row">
                    <span class="detail-label">License Number:</span>
                    <span class="detail-value">${driverInfo.license.number}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">License Class:</span>
                    <span class="detail-value">${driverInfo.license.class}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Expiry Date:</span>
                    <span class="detail-value">${driverInfo.license.expiry}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Issuing Authority:</span>
                    <span class="detail-value">${driverInfo.license.authority}</span>
                </div>
            </div>
        </div>

        <!-- Insurance Information -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-shield-alt"></i>
                Insurance Details
            </div>
            <div class="detail-grid">
                <div class="detail-row">
                    <span class="detail-label">Insurance Provider:</span>
                    <span class="detail-value">${driverInfo.insurance.provider}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Policy Number:</span>
                    <span class="detail-value">${driverInfo.insurance.policyNumber}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Expiry Date:</span>
                    <span class="detail-value">${driverInfo.insurance.expiry}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Coverage Type:</span>
                    <span class="detail-value">${driverInfo.insurance.coverage}</span>
                </div>
            </div>
        </div>

        <!-- Bank Information -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-university"></i>
                Bank Details
            </div>
            <div class="detail-grid">
                <div class="detail-row">
                    <span class="detail-label">Bank Name:</span>
                    <span class="detail-value">${driverInfo.bank.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Account Number:</span>
                    <span class="detail-value">${driverInfo.bank.accountNumber}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Account Holder:</span>
                    <span class="detail-value">${driverInfo.bank.accountHolder}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Branch Code:</span>
                    <span class="detail-value">${driverInfo.bank.branchCode}</span>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-chart-line"></i>
                Performance Analytics
            </div>
            <div class="performance-metrics-grid">
                <div class="performance-metric-card">
                    <div class="performance-value">${driverInfo.performance.rating}</div>
                    <div class="performance-label">Average Rating</div>
                </div>
                <div class="performance-metric-card">
                    <div class="performance-value">${driverInfo.performance.completionRate}%</div>
                    <div class="performance-label">Completion Rate</div>
                </div>
                <div class="performance-metric-card">
                    <div class="performance-value">${driverInfo.performance.responseTime}m</div>
                    <div class="performance-label">Avg Response Time</div>
                </div>
                <div class="performance-metric-card">
                    <div class="performance-value">${driverInfo.performance.earnings}</div>
                    <div class="performance-label">Total Earnings</div>
                </div>
            </div>
        </div>

        <!-- Compliance Status -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-clipboard-check"></i>
                Compliance Status
            </div>
            <div class="compliance-grid">
                <div class="compliance-item ${driverInfo.compliance.licenseValid ? 'compliant' : 'non-compliant'}">
                    <span class="compliance-label">Driver's License</span>
                    <span class="compliance-status">${driverInfo.compliance.licenseValid ? 'Valid' : 'Expired'}</span>
                </div>
                <div class="compliance-item ${driverInfo.compliance.insuranceValid ? 'compliant' : 'non-compliant'}">
                    <span class="compliance-label">Insurance</span>
                    <span class="compliance-status">${driverInfo.compliance.insuranceValid ? 'Valid' : 'Expired'}</span>
                </div>
                <div class="compliance-item ${driverInfo.compliance.vehicleValid ? 'compliant' : 'non-compliant'}">
                    <span class="compliance-label">Vehicle Registration</span>
                    <span class="compliance-status">${driverInfo.compliance.vehicleValid ? 'Valid' : 'Expired'}</span>
                </div>
                <div class="compliance-item ${driverInfo.compliance.backgroundCheck ? 'compliant' : 'non-compliant'}">
                    <span class="compliance-label">Background Check</span>
                    <span class="compliance-status">${driverInfo.compliance.backgroundCheck ? 'Passed' : 'Pending'}</span>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="detail-section">
            <div class="detail-section-title">
                <i class="fas fa-history"></i>
                Recent Activity
            </div>
            <div id="driverRecentActivity">
                <!-- Recent activity will be populated by JavaScript -->
            </div>
        </div>
    `;

    // Load driver's recent activity
    loadDriverRecentActivity(driverId);

    // Update action buttons based on driver status
    updateDriverActionButtons(driver);

    document.getElementById('driverDetailModal').classList.add('active');
}

// NEW: Get comprehensive driver information
function getComprehensiveDriverInfo(driver, driverId) {
    // Calculate performance metrics
    const performance = calculateDriverPerformanceMetrics(driverId);
    
    // Check compliance status
    const compliance = checkDriverCompliance(driver);
    
    return {
        personal: {
            name: driver.name || 'Not provided',
            phone: driver.phone || 'Not provided',
            email: driver.email || 'Not provided',
            nrc: driver.nrc || 'Not provided',
            dob: driver.dateOfBirth || 'Not provided',
            gender: driver.gender || 'Not specified'
        },
        vehicle: {
            type: driver.vehicle?.type || 'Not specified',
            makeModel: `${driver.vehicle?.make || ''} ${driver.vehicle?.model || ''}`.trim() || 'Not specified',
            year: driver.vehicle?.year || 'Not specified',
            color: driver.vehicle?.color || 'Not specified',
            licensePlate: driver.vehicle?.licensePlate || 'Not provided',
            registration: driver.vehicle?.registrationNumber || 'Not provided'
        },
        license: {
            number: driver.license?.number || 'Not provided',
            class: driver.license?.class || 'Not specified',
            expiry: driver.license?.expiryDate || 'Not provided',
            authority: driver.license?.authority || 'Not specified'
        },
        insurance: {
            provider: driver.insurance?.provider || 'Not provided',
            policyNumber: driver.insurance?.policyNumber || 'Not provided',
            expiry: driver.insurance?.expiryDate || 'Not provided',
            coverage: driver.insurance?.coverageType || 'Third Party'
        },
        bank: {
            name: driver.bank?.name || 'Not provided',
            accountNumber: driver.bank?.accountNumber ? '' + driver.bank.accountNumber.slice(-4) : 'Not provided',
            accountHolder: driver.bank?.accountHolder || 'Not provided',
            branchCode: driver.bank?.branchCode || 'Not provided'
        },
        performance: {
            rating: driver.rating ? driver.rating.toFixed(1) + ' ' : 'No ratings',
            completionRate: performance.completionRate,
            responseTime: performance.avgResponseTime,
            earnings: `K${performance.totalEarnings.toFixed(2)}`
        },
        compliance: {
            licenseValid: compliance.licenseValid,
            insuranceValid: compliance.insuranceValid,
            vehicleValid: compliance.vehicleValid,
            backgroundCheck: compliance.backgroundCheck
        }
    };
}

// NEW: Calculate driver performance metrics
function calculateDriverPerformanceMetrics(driverId) {
    let totalRides = 0;
    let completedRides = 0;
    let totalEarnings = 0;
    let totalResponseTime = 0;
    
    if (ridesData) {
        Object.values(ridesData).forEach(ride => {
            if (ride.driverId === driverId) {
                totalRides++;
                if (ride.status === 'completed') {
                    completedRides++;
                    totalEarnings += ride.fare * 0.92; // 92% for driver
                    
                    // Calculate response time
                    if (ride.acceptedAt && ride.requestedAt) {
                        const responseTime = (ride.acceptedAt - ride.requestedAt) / (1000 * 60); // minutes
                        totalResponseTime += responseTime;
                    }
                }
            }
        });
    }
    
    return {
        completionRate: totalRides > 0 ? Math.round((completedRides / totalRides) * 100) : 0,
        totalEarnings: totalEarnings,
        avgResponseTime: completedRides > 0 ? Math.round(totalResponseTime / completedRides) : 0
    };
}

// NEW: Check driver compliance
function checkDriverCompliance(driver) {
    const now = new Date();
    
    // Check license expiry
    const licenseExpiry = driver.license?.expiryDate ? new Date(driver.license.expiryDate) : null;
    const licenseValid = licenseExpiry && licenseExpiry > now;
    
    // Check insurance expiry
    const insuranceExpiry = driver.insurance?.expiryDate ? new Date(driver.insurance.expiryDate) : null;
    const insuranceValid = insuranceExpiry && insuranceExpiry > now;
    
    // Check vehicle registration (assuming 1 year validity)
    const registrationDate = driver.vehicle?.registrationDate ? new Date(driver.vehicle.registrationDate) : null;
    const vehicleValid = registrationDate && (now - registrationDate) < (365 * 24 * 60 * 60 * 1000);
    
    // Background check (simplified)
    const backgroundCheck = driver.backgroundCheck === true;
    
    return {
        licenseValid,
        insuranceValid,
        vehicleValid,
        backgroundCheck
    };
}

// NEW: Update driver action buttons
function updateDriverActionButtons(driver) {
    const suspendBtn = document.getElementById('suspendDriverBtn');
    const compliance = checkDriverCompliance(driver);
    
    if (driver.isSuspended) {
        suspendBtn.innerHTML = '<i class="fas fa-check"></i> Activate Driver';
        suspendBtn.classList.remove('btn-danger');
        suspendBtn.classList.add('btn-success');
    } else {
        suspendBtn.innerHTML = '<i class="fas fa-ban"></i> Suspend Driver';
        suspendBtn.classList.remove('btn-success');
        suspendBtn.classList.add('btn-danger');
    }
    
    // Add compliance warning if needed
    if (!compliance.licenseValid || !compliance.insuranceValid) {
        suspendBtn.innerHTML += ' <i class="fas fa-exclamation-triangle" style="color: orange;"></i>';
    }
}

// NEW: Load driver recent activity with enhanced details
function loadDriverRecentActivity(driverId) {
    const activityContainer = document.getElementById('driverRecentActivity');
    activityContainer.innerHTML = '';
    
    if (ridesData) {
        const driverRides = Object.values(ridesData)
            .filter(ride => ride.driverId === driverId)
            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
            .slice(0, 10);
        
        if (driverRides.length > 0) {
            driverRides.forEach(ride => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                const date = new Date(ride.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                activityItem.innerHTML = `
                    <div class="activity-header">
                        <span class="activity-type ${ride.rideType === 'bike' || ride.rideType === 'bicycle' ? 'delivery' : 'ride'}">
                            ${ride.rideType === 'bike' || ride.rideType === 'bicycle' ? 'Delivery' : 'Ride'}
                        </span>
                        <span class="activity-fare">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</span>
                    </div>
                    <div class="activity-locations">
                        <div class="activity-location">
                            <i class="fas fa-map-marker-alt"></i>
                            ${ride.pickupLocation || 'Pickup location'}
                        </div>
                        <div class="activity-location">
                            <i class="fas fa-flag"></i>
                            ${ride.destination || 'Destination'}
                        </div>
                    </div>
                    <div class="activity-footer">
                        <span class="activity-time">${formattedDate} ${formattedTime}</span>
                        <span class="activity-status status-${ride.status || 'requested'}">
                            ${ride.status || 'requested'}
                        </span>
                    </div>
                `;
                
                activityItem.addEventListener('click', function() {
                    closeDriverModal();
                    showRideDetails(ride.id);
                });
                
                activityContainer.appendChild(activityItem);
            });
        } else {
            activityContainer.innerHTML = '<p class="no-activity">No recent activity found for this driver.</p>';
        }
    } else {
        activityContainer.innerHTML = '<p class="no-activity">No ride data available.</p>';
    }
}

// NEW: Initialize AI Analytics
function initializeAIAnalytics() {
    // Set up real-time analytics monitoring
    setInterval(() => {
        updateRealTimeAnalytics();
    }, 30000); // Update every 30 seconds
    
    // Load historical data for predictions
    loadHistoricalData();
}

// NEW: Update real-time analytics
function updateRealTimeAnalytics() {
    const now = new Date();
    const currentHour = now.getHours();
    
    // Update system health
    realTimeMonitor.systemHealth = calculateSystemHealth();
    realTimeMonitor.activeSessions = Object.keys(driversData).filter(id => driversData[id].isOnline).length;
    realTimeMonitor.lastIncident = getLastIncident();
    
    // Update performance metrics
    realTimeMonitor.performanceMetrics = {
        responseTime: calculateAverageResponseTime(),
        completionRate: statsData.completedRides / Math.max(statsData.totalRides, 1),
        customerSatisfaction: statsData.customerSatisfaction,
        systemUptime: calculateSystemUptime()
    };
    
    // Update dashboard in real-time
    updateRealTimeDashboard();
}

// NEW: Calculate system health
function calculateSystemHealth() {
    const issues = [];
    
    // Check for system issues
    if (statsData.sosAlertsToday > 0) issues.push('sos_alerts');
    if (statsData.cancellationRate > 20) issues.push('high_cancellations');
    if (realTimeMonitor.activeSessions < 5) issues.push('low_driver_availability');
    
    if (issues.length === 0) return 'optimal';
    if (issues.length <= 2) return 'degraded';
    return 'critical';
}

// NEW: Update real-time dashboard
function updateRealTimeDashboard() {
    // Update system health indicator
    const healthIndicator = document.getElementById('systemHealthIndicator');
    if (!healthIndicator) {
        // Create health indicator in header
        const header = document.querySelector('.header-content');
        const healthDiv = document.createElement('div');
        healthDiv.id = 'systemHealthIndicator';
        healthDiv.className = `system-health ${realTimeMonitor.systemHealth}`;
        healthDiv.innerHTML = `
            <i class="fas fa-heartbeat"></i>
            System: ${realTimeMonitor.systemHealth}
        `;
        header.appendChild(healthDiv);
        
        // Add health indicator styles
        const style = document.createElement('style');
        style.textContent = `
            .system-health {
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.8rem;
                font-weight: bold;
            }
            
            .system-health.optimal {
                background: #2ecc71;
                color: white;
            }
            
            .system-health.degraded {
                background: #f39c12;
                color: white;
            }
            
            .system-health.critical {
                background: #e74c3c;
                color: white;
                animation: pulseCritical 2s infinite;
            }
            
            @keyframes pulseCritical {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
        `;
        document.head.appendChild(style);
    } else {
        healthIndicator.className = `system-health ${realTimeMonitor.systemHealth}`;
        healthIndicator.innerHTML = `
            <i class="fas fa-heartbeat"></i>
            System: ${realTimeMonitor.systemHealth}
        `;
    }
}

// NEW: Load system health data
function loadSystemHealth() {
    database.ref('systemHealth').once('value').then(snapshot => {
        const healthData = snapshot.val();
        if (healthData) {
            realTimeMonitor.systemHealth = healthData.currentStatus || 'optimal';
            realTimeMonitor.lastIncident = healthData.lastIncident;
        }
    });
}

// NEW: Show emergency broadcast modal
function showEmergencyBroadcastModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Emergency Broadcast
                </h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">Broadcast Message</label>
                    <textarea id="broadcastMessage" class="form-input" rows="4" placeholder="Enter emergency message for all drivers and passengers..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority Level</label>
                    <select id="broadcastPriority" class="form-select">
                        <option value="high">High Priority</option>
                        <option value="critical">Critical Emergency</option>
                        <option value="info">Information Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target Audience</label>
                    <select id="broadcastAudience" class="form-select">
                        <option value="all">All Users</option>
                        <option value="drivers">Drivers Only</option>
                        <option value="passengers">Passengers Only</option>
                        <option value="specific">Specific Area</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancelBroadcast">Cancel</button>
                    <button class="btn btn-danger" id="sendBroadcast">
                        <i class="fas fa-broadcast-tower"></i>
                        Send Emergency Broadcast
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Event listeners for broadcast modal
    modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
    modal.querySelector('#cancelBroadcast').addEventListener('click', () => modal.remove());
    modal.querySelector('#sendBroadcast').addEventListener('click', sendEmergencyBroadcast);
}

// NEW: Send emergency broadcast
function sendEmergencyBroadcast() {
    const message = document.getElementById('broadcastMessage').value;
    const priority = document.getElementById('broadcastPriority').value;
    const audience = document.getElementById('broadcastAudience').value;
    
    if (!message.trim()) {
        showNotification('Please enter a broadcast message', 'error');
        return;
    }
    
    const broadcast = {
        message: message,
        priority: priority,
        audience: audience,
        sentBy: currentUser.uid,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
    };
    
    database.ref('emergencyBroadcasts').push(broadcast)
        .then(() => {
            showNotification('Emergency broadcast sent successfully');
            document.querySelector('.modal-overlay.active').remove();
            
            // Log the broadcast
            database.ref('broadcastLogs').push().set({
                ...broadcast,
                status: 'sent'
            });
        })
        .catch(error => {
            console.error('Error sending broadcast:', error);
            showNotification('Error sending broadcast', 'error');
        });
}

// NEW: View SOS details
function viewSOSDetails(alertId) {
    const alert = sosAlerts[alertId];
    if (!alert) return;
    
    // Create SOS details modal
    const modal = document.createElement('div');
    modal.className = 'modal-overlay active';
    modal.innerHTML = `
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header" style="background: #e74c3c; color: white;">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    SOS Emergency Details
                </h3>
                <button class="close-modal" style="color: white;">&times;</button>
            </div>
            <div class="modal-content">
                <div class="sos-details-grid">
                    <div class="sos-detail-section">
                        <h4>Passenger Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">${alert.passengerName || 'Unknown'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">${alert.passengerPhone || 'Not provided'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Emergency Contacts:</span>
                            <span class="detail-value">
                                ${alert.emergencyContact1 || 'N/A'}${alert.emergencyContact2 ? ', ' + alert.emergencyContact2 : ''}
                            </span>
                        </div>
                    </div>
                    
                    ${alert.rideDetails ? `
                    <div class="sos-detail-section">
                        <h4>Ride Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Ride ID:</span>
                            <span class="detail-value">${alert.rideDetails.id || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Pickup:</span>
                            <span class="detail-value">${alert.rideDetails.pickupLocation || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Destination:</span>
                            <span class="detail-value">${alert.rideDetails.destination || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Fare:</span>
                            <span class="detail-value">K${alert.rideDetails.fare ? alert.rideDetails.fare.toFixed(2) : '0.00'}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${alert.driverDetails ? `
                    <div class="sos-detail-section">
                        <h4>Driver Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Name:</span>
                            <span class="detail-value">${alert.driverDetails.name || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">${alert.driverDetails.phone || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vehicle:</span>
                            <span class="detail-value">${alert.driverDetails.vehicle ? `${alert.driverDetails.vehicle.type} - ${alert.driverDetails.vehicle.licensePlate}` : 'N/A'}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="sos-detail-section">
                        <h4>Emergency Details</h4>
                        <div class="detail-row">
                            <span class="detail-label">Alert Time:</span>
                            <span class="detail-value">${new Date(alert.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Message:</span>
                            <span class="detail-value">${alert.message || 'Emergency assistance needed'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value">
                                ${alert.acknowledged ? 'Acknowledged' : 'Pending'}
                                ${alert.resolved ? ' - Resolved' : ''}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="sos-actions" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    ${!alert.acknowledged ? `
                    <button class="btn btn-danger" id="acknowledgeSos">
                        <i class="fas fa-check"></i> Acknowledge Alert
                    </button>
                    ` : ''}
                    <button class="btn btn-primary" id="contactEmergency">
                        <i class="fas fa-phone"></i> Contact Emergency Services
                    </button>
                    <button class="btn btn-secondary" id="viewOnMap">
                        <i class="fas fa-map-marker-alt"></i> View on Map
                    </button>
                    ${!alert.resolved ? `
                    <button class="btn btn-success" id="resolveSos">
                        <i class="fas fa-check-double"></i> Mark as Resolved
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Event listeners for SOS details modal
    modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
    modal.querySelector('#acknowledgeSos')?.addEventListener('click', () => {
        acknowledgeSOSAlert(alertId);
        modal.remove();
    });
    modal.querySelector('#contactEmergency')?.addEventListener('click', () => {
        contactEmergencyServices(alert);
        modal.remove();
    });
    modal.querySelector('#viewOnMap')?.addEventListener('click', () => {
        viewSOSLocation(alert);
        modal.remove();
    });
    modal.querySelector('#resolveSos')?.addEventListener('click', () => {
        resolveSOSAlert(alertId);
        modal.remove();
    });
}

// NEW: Resolve SOS Alert
function resolveSOSAlert(alertId) {
    database.ref('sosAlerts/' + alertId).update({
        resolved: true,
        resolvedBy: currentUser.uid,
        resolvedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showNotification('SOS alert marked as resolved');
        stopScreenFlashing();
    }).catch(error => {
        console.error('Error resolving SOS alert:', error);
        showNotification('Error resolving alert', 'error');
    });
}

// ... (Previous functions like updateDriverMarkers, updateActiveRideMarkers, etc. remain the same with enhancements)

// ENHANCED: Load drivers data with performance analytics
function loadDriversData() {
    database.ref('users').orderByChild('userType').equalTo('driver').once('value')
        .then(snapshot => {
            driversData = snapshot.val() || {};
            displayDrivers(driversData);
            updateDriverStats(driversData);
            
            // NEW: Calculate driver performance analytics
            calculateDriverPerformanceAnalytics(driversData);
        })
        .catch(error => {
            console.error('Error loading drivers:', error);
            showNotification('Error loading drivers data.', 'error');
        });
}

// NEW: Calculate driver performance analytics
function calculateDriverPerformanceAnalytics(drivers) {
    const performanceData = {
        topPerformers: [],
        needsAttention: [],
        newDrivers: [],
        atRisk: []
    };
    
    Object.entries(drivers).forEach(([driverId, driver]) => {
        const performance = calculateDriverPerformance(driver);
        const compliance = checkDriverCompliance(driver);
        
        const driverWithMetrics = {
            ...driver,
            performanceScore: performance,
            complianceStatus: compliance,
            driverId: driverId
        };
        
        // Categorize drivers
        if (performance >= 80 && compliance.licenseValid && compliance.insuranceValid) {
            performanceData.topPerformers.push(driverWithMetrics);
        } else if (performance < 50 || !compliance.licenseValid || !compliance.insuranceValid) {
            performanceData.needsAttention.push(driverWithMetrics);
        }
        
        // Check for new drivers (joined in last 30 days)
        const joinDate = driver.createdAt ? new Date(driver.createdAt) : null;
        if (joinDate && (Date.now() - joinDate.getTime()) < (30 * 24 * 60 * 60 * 1000)) {
            performanceData.newDrivers.push(driverWithMetrics);
        }
        
        // Check for at-risk drivers (low rating or high cancellation)
        if ((driver.rating && driver.rating < 3) || driver.cancellationRate > 20) {
            performanceData.atRisk.push(driverWithMetrics);
        }
    });
    
    // Update performance analytics display
    updatePerformanceAnalyticsDisplay(performanceData);
}

// NEW: Update performance analytics display
function updatePerformanceAnalyticsDisplay(performanceData) {
    const analyticsContainer = document.getElementById('performanceAnalytics');
    if (!analyticsContainer) {
        // Create performance analytics section
        const dashboardTab = document.getElementById('dashboardTab');
        const analyticsSection = document.createElement('div');
        analyticsSection.id = 'performanceAnalytics';
        analyticsSection.className = 'performance-analytics-section';
        analyticsSection.innerHTML = `
            <h3 class="section-title">
                <i class="fas fa-chart-bar"></i>
                Driver Performance Analytics
            </h3>
            <div class="analytics-grid">
                <div class="analytics-card">
                    <div class="analytics-value">${performanceData.topPerformers.length}</div>
                    <div class="analytics-label">Top Performers</div>
                    <div class="analytics-subtext">High rating & compliance</div>
                </div>
                <div class="analytics-card warning">
                    <div class="analytics-value">${performanceData.needsAttention.length}</div>
                    <div class="analytics-label">Need Attention</div>
                    <div class="analytics-subtext">Low performance or compliance issues</div>
                </div>
                <div class="analytics-card info">
                    <div class="analytics-value">${performanceData.newDrivers.length}</div>
                    <div class="analytics-label">New Drivers</div>
                    <div class="analytics-subtext">Joined in last 30 days</div>
                </div>
                <div class="analytics-card danger">
                    <div class="analytics-value">${performanceData.atRisk.length}</div>
                    <div class="analytics-label">At Risk</div>
                    <div class="analytics-subtext">Low rating or high cancellations</div>
                </div>
            </div>
        `;
        dashboardTab.appendChild(analyticsSection);
        
        // Add analytics styles
        const style = document.createElement('style');
        style.textContent = `
            .performance-analytics-section {
                margin: 20px 0;
                padding: 20px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .analytics-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                margin-top: 15px;
            }
            
            .analytics-card {
                padding: 15px;
                border-radius: 8px;
                text-align: center;
                background: #f8f9fa;
                border-left: 4px solid #3498db;
            }
            
            .analytics-card.warning {
                border-left-color: #f39c12;
            }
            
            .analytics-card.info {
                border-left-color: #3498db;
            }
            
            .analytics-card.danger {
                border-left-color: #e74c3c;
            }
            
            .analytics-value {
                font-size: 2rem;
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 5px;
            }
            
            .analytics-label {
                font-weight: 600;
                color: #34495e;
                margin-bottom: 5px;
            }
            
            .analytics-subtext {
                font-size: 0.8rem;
                color: #7f8c8d;
            }
        `;
        document.head.appendChild(style);
    }
}

// Global function to show SOS details from map
window.viewSOSDetails = function(alertId) {
    viewSOSDetails(alertId);
};

// Global function to show driver details from map popup
window.showDriverDetails = function(driverId) {
    showDriverDetails(driverId);
};

// Global function to show ride details from map popup
window.showRideDetails = function(rideId) {
    showRideDetails(rideId);
};

// Initialize the enhanced admin dashboard
console.log("Jubel Admin Dashboard Initialized with Enhanced Features");
    </script>
</body>
</html>

