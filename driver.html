<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All CSS styles from the original code remain the same */
:root {
    --primary-orange: #FF6B35;
    --primary-red: #E74C3C;
    --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
    --secondary-orange: #E55A28;
    --secondary-red: #C0392B;
    --light-orange: #FFE8E0;
    --light-red: #FADBD8;
    --white: #FFFFFF;
    --light-gray: #F5F5F5;
    --dark-gray: #333333;
    --medium-gray: #777777;
    --success-green: #2ecc71;
    --warning-yellow: #f39c12;
    --info-blue: #3498db;
    --error-red: #e74c3c;
    --border-color: #E8E8E8;
    --shadow-light: 0 2px 12px rgba(255, 107, 53, 0.1);
    --shadow-medium: 0 4px 20px rgba(255, 107, 53, 0.15);
    --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
    --app-padding: 12px;
    --element-radius: 8px;
    --transition-speed: 0.3s;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: var(--white);
    color: var(--dark-gray);
    max-width: 100%;
    overflow-x: hidden;
    height: 100vh;
    font-size: 14px;
}

/* Welcome Screen */
.welcome-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    transition: opacity 0.5s ease;
}

.welcome-screen.hidden {
    opacity: 0;
    pointer-events: none;
}

.jubel-logo {
    width: 200px;
    height: 200px;
    background: var(--primary-gradient);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 30px;
    box-shadow: var(--shadow-heavy);
}

.jubel-logo-text {
    color: var(--white);
    font-size: 2.5rem;
    font-weight: 800;
    letter-spacing: 1px;
}

.welcome-title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--dark-gray);
    text-align: center;
}

.welcome-subtitle {
    font-size: 1rem;
    color: var(--medium-gray);
    margin-bottom: 40px;
    text-align: center;
    max-width: 300px;
}

.auth-buttons {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 300px;
}

.auth-btn {
    padding: 15px;
    border: none;
    border-radius: var(--element-radius);
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-login {
    background: var(--primary-gradient);
    color: var(--white);
}

.btn-signup {
    background: var(--white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
}

/* Auth Screens */
.auth-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    z-index: 900;
    padding: 20px;
    overflow-y: auto;
    display: none;
}

.auth-screen.active {
    display: block;
}

.auth-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.back-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    font-size: 1rem;
    color: var(--dark-gray);
}

.auth-title {
    font-size: 1.5rem;
    font-weight: 700;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.form-label {
    font-weight: 600;
    font-size: 0.9rem;
}

.form-input {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 1rem;
    transition: all var(--transition-speed) ease;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary-orange);
}

.form-select {
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 1rem;
    background-color: var(--white);
    cursor: pointer;
}

.vehicle-selection {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.vehicle-option {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 15px 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.vehicle-option.selected {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.vehicle-icon {
    font-size: 1.5rem;
    color: var(--medium-gray);
}

.vehicle-option.selected .vehicle-icon {
    color: var(--primary-orange);
}

.vehicle-name {
    font-size: 0.9rem;
    font-weight: 600;
}

.vehicle-details {
    display: none;
    margin-top: 15px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: var(--element-radius);
    background: var(--light-gray);
}

.vehicle-details.active {
    display: block;
}

.form-row {
    display: flex;
    gap: 10px;
}

.form-row .form-group {
    flex: 1;
}

.submit-btn {
    padding: 15px;
    border: none;
    border-radius: var(--element-radius);
    background: var(--primary-gradient);
    color: var(--white);
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    margin-top: 10px;
}

.submit-btn:disabled {
    background: var(--medium-gray);
    cursor: not-allowed;
}

.auth-footer {
    margin-top: 20px;
    text-align: center;
    font-size: 0.9rem;
    color: var(--medium-gray);
}

.auth-link {
    color: var(--primary-orange);
    font-weight: 600;
    cursor: pointer;
}

/* Main App */
#map {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
}

.floating-float {
    position: fixed;
    top: 15px;
    left: 15px;
    background: var(--white);
    padding: 8px 12px;
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    color: var(--dark-gray);
    border: 2px solid var(--primary-orange);
    font-size: 0.8rem;
}

.float-amount {
    color: var(--primary-orange);
    font-size: 0.9rem;
}

.online-toggle {
    position: fixed;
    top: 15px;
    right: 15px;
    background: var(--white);
    padding: 6px 10px;
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    border: 2px solid var(--border-color);
    font-size: 0.7rem;
    height: 32px;
}

.online-toggle.active {
    border-color: var(--success-green);
    background: var(--success-green);
    color: var(--white);
}

.online-toggle.offline {
    border-color: var(--medium-gray);
    background: var(--medium-gray);
    color: var(--white);
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--medium-gray);
    transition: .4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--success-green);
}

input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.driver-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--white);
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
    z-index: 100;
    padding: var(--app-padding);
    transform: translateY(0);
    transition: transform var(--transition-speed) ease;
    max-height: 80vh;
    overflow-y: auto;
}

.driver-panel.collapsed {
    transform: translateY(calc(100% - 50px));
}

.panel-collapse-handle {
    width: 40px;
    height: 4px;
    background: var(--border-color);
    border-radius: 2px;
    margin: 0 auto 10px;
    cursor: pointer;
}

.driver-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

/* CHANGED: Increased driver profile picture size */
.driver-avatar {
    width: 60px; /* Increased from 40px */
    height: 60px; /* Increased from 40px */
    border-radius: 50%;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem; /* Increased from 1rem */
    color: var(--white);
    font-weight: 700;
}

.driver-details h2 {
    font-size: 0.95rem;
    margin-bottom: 3px;
}

.driver-details p {
    color: var(--medium-gray);
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.75rem;
}

.nav-buttons {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-bottom: 12px;
}

.nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 8px 4px;
    border-radius: var(--element-radius);
    background: var(--light-gray);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    border: none;
    font-size: 0.65rem;
    font-weight: 600;
}

.nav-btn.active {
    background: var(--primary-gradient);
    color: var(--white);
}

.nav-btn i {
    font-size: 0.9rem;
}

.ride-action-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: var(--element-radius);
    background: var(--white);
    color: var(--dark-gray);
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    box-shadow: var(--shadow-medium);
    border: 2px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    position: relative;
    overflow: hidden;
}

.ride-action-btn.hold-to-start {
    background: var(--white);
    color: var(--dark-gray);
}

.ride-action-btn.hold-to-arrive {
    background: var(--white);
    color: var(--dark-gray);
}

.ride-action-btn.hold-to-pickup {
    background: var(--white);
    color: var(--dark-gray);
}

.ride-action-btn.hold-to-complete {
    background: var(--white);
    color: var(--dark-gray);
}

.ride-action-btn.hold-active {
    background: var(--primary-gradient);
    color: var(--white);
    border-color: transparent;
}

.ride-action-btn:active {
    transform: scale(0.98);
}

.hold-progress {
    height: 3px;
    background: var(--border-color);
    border-radius: 2px;
    width: 100%;
    overflow: hidden;
    position: relative;
}

.hold-progress-bar {
    height: 100%;
    background: var(--primary-gradient);
    width: 0%;
    transition: width 0.1s linear;
    position: absolute;
    top: 0;
    left: 0;
}

.ride-request-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--app-padding);
}

.ride-request-content {
    background: var(--white);
    border-radius: 15px;
    width: 100%;
    max-width: 360px;
    max-height: 85vh;
    overflow: hidden;
    box-shadow: var(--shadow-heavy);
    display: flex;
    flex-direction: column;
    transform: scale(0.9);
    transition: transform var(--transition-speed) ease;
    animation: popup-appear 0.3s ease forwards;
}

@keyframes popup-appear {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.ride-request-map {
    height: 200px;
    width: 100%;
}

.ride-request-details {
    padding: 12px;
    overflow-y: auto;
}

.customer-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.customer-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: var(--medium-gray);
}

.customer-details h3 {
    font-size: 1rem;
    margin-bottom: 3px;
}

.customer-details p {
    color: var(--medium-gray);
    font-size: 0.75rem;
}

.trip-details {
    margin-bottom: 12px;
}

.location-row {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    margin-bottom: 10px;
}

.location-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    flex-shrink: 0;
}

.pickup-icon {
    background: var(--primary-orange);
    color: var(--white);
}

.destination-icon {
    background: var(--primary-red);
    color: var(--white);
}

.location-text {
    flex: 1;
}

.location-text h4 {
    font-size: 0.85rem;
    margin-bottom: 3px;
}

.location-text p {
    color: var(--medium-gray);
    font-size: 0.75rem;
}

.fare-details {
    background: var(--light-orange);
    padding: 10px;
    border-radius: var(--element-radius);
    margin-bottom: 12px;
}

.fare-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 0.75rem;
}

.fare-row.total {
    font-weight: 700;
    font-size: 0.9rem;
    border-top: 1px solid var(--border-color);
    padding-top: 6px;
    margin-top: 6px;
}

.ride-request-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.btn {
    padding: 10px;
    border: none;
    border-radius: var(--element-radius);
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.btn-accept {
    background: var(--primary-gradient);
    color: var(--white);
}

.btn-reject {
    background: var(--error-red);
    color: var(--white);
}

.screen-content {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 70px;
    background: var(--white);
    z-index: 90;
    padding: var(--app-padding);
    overflow-y: auto;
    display: none;
}

.screen-content.active {
    display: block;
}

.screen-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.back-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--light-gray);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    font-size: 1rem;
}

.screen-title {
    font-size: 1.1rem;
    font-weight: 700;
}

.account-section, .history-section, .earnings-section {
    margin-bottom: 20px;
}

.section-title {
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 5px;
}

.input-group {
    margin-bottom: 10px;
}

.input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 0.8rem;
}

.input-field {
    width: 100%;
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 0.8rem;
    transition: all var(--transition-speed) ease;
    background-color: var(--light-gray);
    color: var(--medium-gray);
}

.input-field:focus {
    outline: none;
    border-color: var(--primary-orange);
}

.wallet-balance {
    background: var(--primary-gradient);
    color: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    text-align: center;
    margin-bottom: 12px;
}

.balance-label {
    font-size: 0.75rem;
    margin-bottom: 3px;
}

.balance-amount-large {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 6px;
}

.wallet-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
}

.btn-wallet {
    background: var(--white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
    padding: 8px;
    font-size: 0.75rem;
    border-radius: var(--element-radius);
    cursor: pointer;
    font-weight: 600;
}

.vehicle-details {
    background: var(--light-orange);
    padding: 12px;
    border-radius: var(--element-radius);
    margin-bottom: 12px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.75rem;
}

.detail-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.detail-label {
    font-weight: 600;
    color: var(--medium-gray);
}

.detail-value {
    font-weight: 600;
}

.history-item {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-size: 0.75rem;
}

.history-item:last-child {
    border-bottom: none;
}

.history-item:hover {
    background: var(--light-orange);
}

.history-locations {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
}

.history-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: var(--medium-gray);
}

.status-badge {
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 700;
}

.status-completed {
    background: #e6f7e9;
    color: #2e7d32;
}

.status-cancelled {
    background: #ffebee;
    color: #c62828;
}

.earnings-card {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 12px;
    box-shadow: var(--shadow-light);
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
}

.earnings-period {
    display: flex;
    gap: 6px;
    margin-bottom: 12px;
}

.period-btn {
    flex: 1;
    padding: 8px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    background: var(--white);
    cursor: pointer;
    font-weight: 600;
    text-align: center;
    transition: all var(--transition-speed) ease;
    font-size: 0.75rem;
}

.period-btn.active {
    background: var(--primary-gradient);
    color: var(--white);
    border-color: transparent;
}

.earnings-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 12px;
}

.stat-item {
    background: var(--light-orange);
    padding: 10px;
    border-radius: var(--element-radius);
    text-align: center;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: 800;
    color: var(--primary-orange);
    margin-bottom: 3px;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--medium-gray);
}

.earnings-chart {
    height: 120px;
    background: var(--light-gray);
    border-radius: var(--element-radius);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--medium-gray);
    font-size: 0.8rem;
}

.notification {
    position: fixed;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--primary-gradient);
    color: var(--white);
    padding: 10px 16px;
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 300;
    display: none;
    font-weight: 600;
    text-align: center;
    font-size: 0.8rem;
    max-width: 80%;
}

.waypoints-container {
    margin-top: 8px;
    max-height: 100px;
    overflow-y: auto;
}

.waypoint-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.75rem;
}

.waypoint-item:last-child {
    border-bottom: none;
}

.waypoint-icon {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--info-blue);
    color: var(--white);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    flex-shrink: 0;
}

.waypoint-text {
    flex: 1;
}

.navigation-controls {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.nav-control-btn {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: var(--element-radius);
    background: var(--info-blue);
    color: var(--white);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 0.75rem;
}

.nav-control-btn.secondary {
    background: var(--medium-gray);
}

.trip-info-card {
    background: var(--white);
    border-radius: var(--element-radius);
    padding: 10px;
    box-shadow: var(--shadow-medium);
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
}

.trip-info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 0.75rem;
}

.trip-info-row:last-child {
    margin-bottom: 0;
}

.trip-info-label {
    color: var(--medium-gray);
    font-weight: 600;
}

.trip-info-value {
    font-weight: 700;
}

.rating-display {
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--warning-yellow);
}

.commission-display {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed var(--border-color);
    font-size: 0.75rem;
}

.commission-label {
    color: var(--medium-gray);
}

.commission-value {
    font-weight: 600;
    color: var(--primary-orange);
}

.commission-deduction {
    color: var(--error-red);
}

.balance-update {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
    font-size: 0.75rem;
}

.balance-label-update {
    color: var(--medium-gray);
}

.balance-value-update {
    font-weight: 600;
    color: var(--success-green);
}

.no-float-warning {
    background-color: var(--light-orange);
    border: 1px solid var(--primary-orange);
    border-radius: var(--element-radius);
    padding: 10px;
    margin-bottom: 12px;
    text-align: center;
    color: var(--primary-orange);
    font-weight: 600;
}

.no-float-warning i {
    margin-right: 6px;
}

.float-section {
    margin-bottom: 20px;
}

.float-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 12px;
}

.btn-float {
    background: var(--white);
    color: var(--primary-orange);
    border: 2px solid var(--primary-orange);
    padding: 10px;
    font-size: 0.8rem;
    border-radius: var(--element-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-weight: 600;
}

.btn-float:hover {
    background: var(--primary-orange);
    color: var(--white);
}

.float-history {
    margin-top: 12px;
}

.float-history-item {
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
}

.float-history-item:last-child {
    border-bottom: none;
}

.float-amount {
    font-weight: 600;
}

.float-amount.positive {
    color: var(--success-green);
}

.float-amount.negative {
    color: var(--error-red);
}

.driver-marker {
    background: var(--primary-gradient);
    color: white;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.driver-marker-label {
    background: white;
    padding: 2px 5px;
    border-radius: 8px;
    margin-top: 4px;
    font-size: 9px;
    font-weight: bold;
    box-shadow: 0 1px 5px rgba(0,0,0,0.2);
}

.hold-button-container {
    position: relative;
    width: 100%;
    height: 50px;
    border-radius: var(--element-radius);
    overflow: hidden;
    background: var(--white);
    border: 2px solid var(--border-color);
    box-shadow: var(--shadow-medium);
}

.hold-button-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    background: var(--primary-gradient);
    transition: width 0.1s linear;
    z-index: 1;
}

.hold-button-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    z-index: 2;
    color: var(--dark-gray);
    font-weight: 700;
    font-size: 0.9rem;
}

.hold-button-content.active {
    color: var(--white);
}

.advanced-features {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
}

.feature-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    border-radius: var(--element-radius);
    background: var(--light-gray);
    border: none;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-weight: 600;
    font-size: 0.75rem;
}

.feature-btn:hover {
    background: var(--light-orange);
}

.feature-btn i {
    font-size: 1rem;
    color: var(--primary-orange);
}

.driver-status-indicator {
    position: fixed;
    top: 60px;
    right: 15px;
    background: var(--white);
    padding: 6px 10px;
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-medium);
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--medium-gray);
}

.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--medium-gray);
}

.status-dot.online {
    background: var(--success-green);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.quick-actions {
    position: fixed;
    bottom: 70px;
    right: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 100;
}

.quick-action-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--white);
    box-shadow: var(--shadow-heavy);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    color: var(--primary-orange);
    transition: all var(--transition-speed) ease;
}

.quick-action-btn:hover {
    transform: scale(1.1);
    background: var(--primary-orange);
    color: var(--white);
}

.collapsible-section {
    margin-bottom: 12px;
}

.collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}

.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height var(--transition-speed) ease;
}

.collapsible-content.expanded {
    max-height: 500px;
}

.collapsible-icon {
    transition: transform var(--transition-speed) ease;
}

.collapsible-icon.expanded {
    transform: rotate(180deg);
}

.ride-request-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.form-row {
    display: flex;
    gap: 8px;
}

.form-group {
    flex: 1;
}

.performance-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 12px;
}

.performance-card {
    background: var(--light-gray);
    padding: 10px;
    border-radius: var(--element-radius);
    text-align: center;
}

.performance-value {
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--primary-orange);
    margin-bottom: 3px;
}

.performance-label {
    font-size: 0.7rem;
    color: var(--medium-gray);
}

.ride-queue {
    margin-top: 12px;
}

.queue-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
}

.queue-info {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.queue-location {
    font-size: 0.8rem;
    font-weight: 600;
}

.queue-time {
    font-size: 0.7rem;
    color: var(--medium-gray);
}

.queue-action {
    background: var(--primary-orange);
    color: white;
    border: none;
    border-radius: var(--element-radius);
    padding: 5px 10px;
    font-size: 0.7rem;
    cursor: pointer;
}

.dark-mode-toggle {
    position: fixed;
    bottom: 70px;
    left: 15px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--white);
    box-shadow: var(--shadow-heavy);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    color: var(--primary-orange);
    z-index: 100;
}

.map-controls {
    position: fixed;
    top: 60px;
    left: 15px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 100;
}

.map-control-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--white);
    box-shadow: var(--shadow-heavy);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    color: var(--primary-orange);
    transition: all var(--transition-speed) ease;
}

.map-control-btn:hover {
    background: var(--primary-orange);
    color: var(--white);
}

.logout-btn {
    background: var(--error-red);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    padding: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-top: 15px;
    width: 100%;
}

/* New styles for the modifications */
.hold-button-content span {
    color: #000000 !important; /* Black text for hold buttons */
}

.wallet-section {
    margin-bottom: 20px;
}

.wallet-balance-card {
    background: var(--primary-gradient);
    color: var(--white);
    padding: 12px;
    border-radius: var(--element-radius);
    text-align: center;
    margin-bottom: 12px;
}

.float-balance-card {
    background: var(--light-orange);
    color: var(--dark-gray);
    padding: 12px;
    border-radius: var(--element-radius);
    text-align: center;
    margin-bottom: 12px;
    border: 2px solid var(--primary-orange);
}

.balance-amount-medium {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 6px;
}

.history-details-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
    font-size: 0.7rem;
}

.history-detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.history-detail-label {
    color: var(--medium-gray);
    font-weight: 600;
}

.history-detail-value {
    font-weight: 600;
}

.sound-control {
    position: fixed;
    bottom: 130px;
    left: 15px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--white);
    box-shadow: var(--shadow-heavy);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    color: var(--primary-orange);
    z-index: 100;
}

.delivery-info-section {
    background: var(--light-gray);
    padding: 10px;
    border-radius: var(--element-radius);
    margin-top: 10px;
}

.delivery-info-title {
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--primary-orange);
    font-size: 0.8rem;
}

.delivery-info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-size: 0.75rem;
}

.delivery-info-label {
    color: var(--medium-gray);
    font-weight: 600;
}

.delivery-info-value {
    font-weight: 600;
}

.special-instructions {
    background: var(--light-orange);
    padding: 8px;
    border-radius: var(--element-radius);
    margin-top: 8px;
    font-size: 0.75rem;
    border-left: 3px solid var(--primary-orange);
}

/* Enhanced styles for the ride request map */
.ride-request-map-container {
    position: relative;
    height: 200px;
    width: 100%;
}

.ride-request-map-legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px 10px;
    border-radius: var(--element-radius);
    box-shadow: var(--shadow-light);
    z-index: 10;
    display: flex;
    gap: 10px;
    font-size: 0.7rem;
}

.map-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.map-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.legend-pickup {
    background: var(--primary-orange);
}

.legend-destination {
    background: var(--primary-red);
}

.map-zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 10;
}

.map-zoom-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--white);
    box-shadow: var(--shadow-medium);
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    font-size: 0.8rem;
    color: var(--primary-orange);
}

/* CHANGED: Image Upload Styles - Perfect square boxes in 2x2 grid */
.image-upload-section {
    margin-top: 20px;
}

.image-upload-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.image-upload-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.image-upload-label {
    font-weight: 600;
    font-size: 0.8rem;
}

.image-upload-box {
    width: 100%;
    aspect-ratio: 1 / 1; /* Perfect square */
    border: 2px dashed var(--border-color);
    border-radius: var(--element-radius);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    position: relative;
    overflow: hidden;
}

.image-upload-box:hover {
    border-color: var(--primary-orange);
    background: var(--light-orange);
}

.image-upload-box.has-image {
    border-style: solid;
    border-color: var(--success-green);
}

.image-upload-icon {
    font-size: 1.5rem;
    color: var(--medium-gray);
    margin-bottom: 5px;
}

.image-upload-text {
    font-size: 0.7rem;
    color: var(--medium-gray);
    text-align: center;
}

.image-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
}

.upload-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--border-color);
}

.upload-progress-bar {
    height: 100%;
    background: var(--primary-orange);
    width: 0%;
    transition: width 0.3s ease;
}

.registration-status {
    padding: 10px;
    border-radius: var(--element-radius);
    margin-top: 15px;
    text-align: center;
    font-weight: 600;
}

.status-pending {
    background: var(--warning-yellow);
    color: var(--white);
}

.status-approved {
    background: var(--success-green);
    color: var(--white);
}

.status-rejected {
    background: var(--error-red);
    color: var(--white);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid var(--light-gray);
    border-top: 5px solid var(--primary-orange);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark-gray);
}

/* Driver Profile Image Styles */
.driver-profile-image {
    width: 100%; /* Fill the container */
    height: 100%; /* Fill the container */
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-orange);
}

.customer-profile-image {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-orange);
}

.vehicle-image {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: var(--element-radius);
    margin-top: 8px;
}

/* CHANGED: Vehicle Images Grid in Account Page - Perfect square boxes */
.vehicle-images-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.vehicle-image-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.vehicle-image-label {
    font-weight: 600;
    font-size: 0.8rem;
}

.vehicle-image-box {
    width: 100%;
    aspect-ratio: 1 / 1; /* Perfect square */
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    background: var(--light-gray);
}

.vehicle-image-preview {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.no-vehicle-image {
    text-align: center;
    color: var(--medium-gray);
    font-size: 0.7rem;
    padding: 10px;
}

@media (max-width: 480px) {
    .floating-float, .online-toggle {
        padding: 6px 8px;
        font-size: 0.7rem;
    }
    
    .driver-panel {
        padding: 10px;
    }
    
    .nav-buttons {
        gap: 4px;
    }
    
    .nav-btn {
        padding: 6px 3px;
        font-size: 0.6rem;
    }
    
    .ride-request-content {
        max-height: 95vh;
    }
    
    .quick-actions {
        bottom: 65px;
        right: 10px;
    }
    
    .quick-action-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
    }
    
    .dark-mode-toggle {
        bottom: 65px;
        left: 10px;
        width: 40px;
        height: 40px;
    }
    
    .sound-control {
        bottom: 120px;
        left: 10px;
        width: 40px;
        height: 40px;
    }
    
    .image-upload-grid {
        grid-template-columns: 1fr;
    }
    
    .vehicle-images-grid {
        grid-template-columns: 1fr;
    }
}

/* NEW: SOS Config Button Styles */
.sos-config-btn {
    background: var(--warning-yellow);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    padding: 10px;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    margin-top: 15px;
    width: 100%;
}

.sos-config-btn:hover {
    background: #e67e22;
}

/* SOS Config Popup Styles */
.sos-config-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: var(--app-padding);
}

.sos-config-content {
    background: var(--white);
    border-radius: 15px;
    width: 100%;
    max-width: 400px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-heavy);
    display: flex;
    flex-direction: column;
    transform: scale(0.9);
    transition: transform var(--transition-speed) ease;
    animation: popup-appear 0.3s ease forwards;
}

.sos-config-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
}

.sos-config-title {
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 6px;
}

.sos-config-body {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.sos-config-input-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.sos-config-label {
    font-weight: 600;
    font-size: 0.9rem;
}

.sos-config-input {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 0.9rem;
    transition: all var(--transition-speed) ease;
}

.sos-config-input:focus {
    outline: none;
    border-color: var(--primary-orange);
}

.sos-config-textarea {
    padding: 10px;
    border: 2px solid var(--border-color);
    border-radius: var(--element-radius);
    font-size: 0.9rem;
    transition: all var(--transition-speed) ease;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.sos-config-textarea:focus {
    outline: none;
    border-color: var(--primary-orange);
}

.sos-config-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 10px;
}

.sos-config-save {
    background: var(--success-green);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    padding: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
}

.sos-config-cancel {
    background: var(--medium-gray);
    color: var(--white);
    border: none;
    border-radius: var(--element-radius);
    padding: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
}

.sos-config-info {
    background: var(--light-orange);
    padding: 10px;
    border-radius: var(--element-radius);
    font-size: 0.8rem;
    color: var(--dark-gray);
    border-left: 3px solid var(--warning-yellow);
}

/* Chat Popup Close Button Styles */
.close-chat-btn {
    background: none;
    border: none;
    font-size: 1.3rem;
    cursor: pointer;
    color: var(--medium-gray);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all var(--transition-speed) ease;
}

.close-chat-btn:hover {
    background: var(--light-gray);
    color: var(--dark-gray);
}
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="jubel-logo">
            <div class="jubel-logo-text">J</div>
        </div>
        <h1 class="welcome-title">Welcome to Jubel Driver</h1>
        <p class="welcome-subtitle">Join our network of professional drivers and start earning today</p>
        <div class="auth-buttons">
            <button class="auth-btn btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i>
                Log In
            </button>
            <button class="auth-btn btn-signup" id="signupBtn">
                <i class="fas fa-user-plus"></i>
                Sign Up
            </button>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div class="auth-screen" id="loginScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromLogin">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Log In</h2>
        </div>
        
        <form class="auth-form" id="loginForm">
            <div class="form-group">
                <label for="loginEmail" class="form-label">Email Address</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
            </div>
            
            <button type="submit" class="submit-btn">Log In</button>
        </form>
        
        <div class="auth-footer">
            <p>Don't have an account? <span class="auth-link" id="goToSignupFromLogin">Sign Up</span></p>
        </div>
    </div>
    
    <!-- Signup Screen -->
    <div class="auth-screen" id="signupScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromSignup">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Sign Up</h2>
        </div>
        
        <form class="auth-form" id="signupForm">
            <div class="form-group">
                <label for="signupName" class="form-label">Full Name</label>
                <input type="text" id="signupName" class="form-input" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
                <label for="signupEmail" class="form-label">Email Address</label>
                <input type="email" id="signupEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="signupPhone" class="form-label">Phone Number</label>
                <input type="tel" id="signupPhone" class="form-input" placeholder="Your phone number" required>
            </div>
            
            <div class="form-group">
                <label for="signupNRC" class="form-label">NRC Number</label>
                <input type="text" id="signupNRC" class="form-input" placeholder="Your NRC number" required>
            </div>
            
            <div class="form-group">
                <label for="signupPassword" class="form-label">Password</label>
                <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
            </div>
            
            <div class="form-group">
                <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
            </div>
            
            <h3 class="section-title">Vehicle Information</h3>
            
            <div class="vehicle-selection">
                <div class="vehicle-option" data-type="car">
                    <i class="fas fa-car vehicle-icon"></i>
                    <span class="vehicle-name">Car</span>
                </div>
                <div class="vehicle-option" data-type="bike">
                    <i class="fas fa-motorcycle vehicle-icon"></i>
                    <span class="vehicle-name">Bike</span>
                </div>
                <div class="vehicle-option" data-type="bicycle">
                    <i class="fas fa-bicycle vehicle-icon"></i>
                    <span class="vehicle-name">Bicycle</span>
                </div>
            </div>
            
            <!-- Car Details -->
            <div class="vehicle-details" id="carDetails">
                <div class="form-group">
                    <label for="carMake" class="form-label">Car Make</label>
                    <input type="text" id="carMake" class="form-input" placeholder="Toyota, Honda, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carModel" class="form-label">Car Model</label>
                    <input type="text" id="carModel" class="form-input" placeholder="Corolla, Civic, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carYear" class="form-label">Year</label>
                    <input type="number" id="carYear" class="form-input" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="carColor" class="form-label">Color</label>
                    <input type="text" id="carColor" class="form-input" placeholder="Red, Blue, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carLicensePlate" class="form-label">License Plate</label>
                    <input type="text" id="carLicensePlate" class="form-input" placeholder="ABC 123">
                </div>
                
                <div class="form-group">
                    <label for="carLicenseNumber" class="form-label">Driver's License Number</label>
                    <input type="text" id="carLicenseNumber" class="form-input" placeholder="Your driver's license number">
                </div>
            </div>
            
            <!-- Bike Details -->
            <div class="vehicle-details" id="bikeDetails">
                <div class="form-group">
                    <label for="bikeMake" class="form-label">Bike Make</label>
                    <input type="text" id="bikeMake" class="form-input" placeholder="Honda, Yamaha, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bikeModel" class="form-label">Bike Model</label>
                    <input type="text" id="bikeModel" class="form-input" placeholder="CBR, R15, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bikeYear" class="form-label">Year</label>
                    <input type="number" id="bikeYear" class="form-input" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="bikeLicenseNumber" class="form-label">Driver's License Number</label>
                    <input type="text" id="bikeLicenseNumber" class="form-input" placeholder="Your driver's license number">
                </div>
            </div>
            
            <!-- Bicycle Details -->
            <div class="vehicle-details" id="bicycleDetails">
                <div class="form-group">
                    <label for="bicycleMake" class="form-label">Bicycle Make</label>
                    <input type="text" id="bicycleMake" class="form-input" placeholder="Giant, Trek, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bicycleColor" class="form-label">Color</label>
                    <input type="text" id="bicycleColor" class="form-input" placeholder="Red, Blue, etc.">
                </div>
            </div>
            
            <!-- CHANGED: Image Upload Section - Square boxes in 2x2 grid -->
            <div class="image-upload-section">
                <h3 class="section-title">Required Documents & Photos</h3>
                <p style="font-size: 0.8rem; color: var(--medium-gray); margin-bottom: 10px;">
                    Please upload clear photos of the required documents. All images will be automatically uploaded to our secure system.
                </p>
                
                <div class="image-upload-grid" id="imageUploadGrid">
                    <!-- Image upload boxes will be dynamically generated based on vehicle type -->
                </div>
            </div>
            
            <h3 class="section-title">Payment Information</h3>
            
            <div class="form-group">
                <label for="paymentMethod" class="form-label">Payment Method</label>
                <select id="paymentMethod" class="form-select">
                    <option value="">Select payment method</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="mobile">Mobile Money</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="paymentDetails" class="form-label">Payment Details</label>
                <input type="text" id="paymentDetails" class="form-input" placeholder="Account number or mobile money number">
            </div>
            
            <div class="registration-status status-pending" id="registrationStatus" style="display: none;">
                Your registration is pending approval. You will be notified once approved.
            </div>
            
            <button type="submit" class="submit-btn" id="signupSubmitBtn">Create Account</button>
        </form>
        
        <div class="auth-footer">
            <p>Already have an account? <span class="auth-link" id="goToLoginFromSignup">Log In</span></p>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Registering your account...</div>
    </div>
    
    <!-- Main App (Hidden until authentication) -->
    <div id="mainApp" style="display: none;">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Float (Only on Home Screen) -->
        <div class="floating-float" id="floatingFloat">
            <i class="fas fa-wallet"></i>
            <span>Float: <span class="float-amount" id="floatBalanceDisplay">K0.00</span></span>
        </div>
        
        <!-- Online Toggle (Only on Home Screen) -->
        <div class="online-toggle offline" id="onlineToggle">
            <label class="toggle-switch">
                <input type="checkbox" id="onlineToggleCheckbox">
                <span class="toggle-slider"></span>
            </label>
            <span id="onlineStatusText">Offline</span>
        </div>
        
        <!-- Driver Status Indicator (Only on Home Screen) -->
        <div class="driver-status-indicator" id="driverStatusIndicator" style="display: none;">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Offline</span>
        </div>
        
        <!-- Map Controls (Only on Home Screen) -->
        <div class="map-controls" id="mapControls">
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="mapTypeBtn" title="Change Map Type">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- Quick Actions (Only on Home Screen) -->
        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" id="centerMapBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="quick-action-btn" id="refreshLocationBtn" title="Refresh Location">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn" id="toggleTrafficBtn" title="Toggle Traffic">
                <i class="fas fa-traffic-light"></i>
            </button>
        </div>
        
        <!-- Dark Mode Toggle (Only on Home Screen) -->
        <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Sound Control (Only on Home Screen) -->
        <button class="sound-control" id="soundControl" title="Toggle Sound">
            <i class="fas fa-volume-up"></i>
        </button>
        
        <!-- Driver Panel -->
        <div class="driver-panel" id="driverPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="driver-info">
                <!-- CHANGED: Increased driver profile picture size -->
                <div class="driver-avatar" id="driverAvatar">
                    <img id="driverProfileImage" class="driver-profile-image" src="" alt="Driver" style="display: none;">
                    <i class="fas fa-user" id="driverDefaultIcon"></i>
                </div>
                <div class="driver-details">
                    <h2 id="driverName">Driver Name</h2>
                    <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                    <p><i class="fas fa-car" id="vehicleIcon"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="earnings">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Earnings</span>
                </button>
            </div>
            
            <!-- Collapsible Driver Details -->
            <div class="collapsible-section">
                <div class="collapsible-header" id="driverDetailsHeader">
                    <h3>Driver Details</h3>
                    <i class="fas fa-chevron-down collapsible-icon" id="driverDetailsIcon"></i>
                </div>
                <div class="collapsible-content" id="driverDetailsContent">
                    <div class="performance-stats">
                        <div class="performance-card">
                            <div class="performance-value" id="totalTrips">0</div>
                            <div class="performance-label">Total Trips</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="ratingScore">4.5</div>
                            <div class="performance-label">Rating</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="onlineTime">0h</div>
                            <div class="performance-label">Online Time</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="acceptanceRate">0%</div>
                            <div class="performance-label">Acceptance</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ride Action Button (Hidden until ride request) -->
            <div class="hold-button-container" id="rideActionBtn" style="display: none;">
                <div class="hold-button-fill" id="holdButtonFill"></div>
                <div class="hold-button-content" id="holdButtonContent">
                    <i class="fas fa-play-circle" style="color: #000000;"></i>
                    <span>Hold to Start Ride</span>
                </div>
            </div>
            
            <!-- Advanced Features Section -->
            <div class="advanced-features" id="advancedFeatures" style="display: none;">
                <button class="feature-btn" id="navigateToPickupBtn">
                    <i class="fas fa-directions"></i>
                    <span>Navigate to Pickup</span>
                </button>
                <button class="feature-btn" id="contactCustomerBtn">
                    <i class="fas fa-phone"></i>
                    <span>Contact Customer</span>
                </button>
                <button class="feature-btn" id="viewRouteDetailsBtn">
                    <i class="fas fa-route"></i>
                    <span>View Route Details</span>
                </button>
            </div>
            
            <!-- Ride Queue (Advanced Feature) -->
            <div class="ride-queue" id="rideQueue" style="display: none;">
                <h3 class="section-title">Ride Queue</h3>
                <div id="queueList">
                    <!-- Queue items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Ride Request Popup -->
        <div class="ride-request-popup" id="rideRequestPopup">
            <div class="ride-request-content">
                <div class="ride-request-map-container">
                    <div class="ride-request-map" id="rideRequestMap"></div>
                    <div class="ride-request-map-legend">
                        <div class="map-legend-item">
                            <div class="map-legend-color legend-pickup"></div>
                            <span>Pickup</span>
                        </div>
                        <div class="map-legend-item">
                            <div class="map-legend-color legend-destination"></div>
                            <span>Destination</span>
                        </div>
                    </div>
                    <div class="map-zoom-controls">
                        <button class="map-zoom-btn" id="requestMapZoomIn">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-zoom-btn" id="requestMapZoomOut">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="ride-request-details">
                    <div class="customer-info">
                        <div class="customer-avatar">
                            <img id="customerProfileImage" class="customer-profile-image" src="" alt="Customer" style="display: none;">
                            <i class="fas fa-user" id="customerDefaultIcon"></i>
                        </div>
                        <div class="customer-details">
                            <h3 id="customerName">Customer Name</h3>
                            <p><i class="fas fa-phone"></i> <span id="customerPhone">000-000-0000</span></p>
                            <div class="rating-display">
                                <i class="fas fa-star"></i>
                                <span id="customerRating">4.8</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="pickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="destinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vehicle Image Display -->
                    <div class="vehicle-image-section" id="vehicleImageSection" style="display: none;">
                        <h4 class="section-title">Driver's Vehicle</h4>
                        <img id="vehicleFrontImage" class="vehicle-image" src="" alt="Vehicle Front">
                    </div>
                    
                    <!-- Delivery Information (For Bike/Bicycle) -->
                    <div class="delivery-info-section" id="deliveryInfoSection" style="display: none;">
                        <div class="delivery-info-title">
                            <i class="fas fa-box"></i> Delivery Information
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Receiver Name:</span>
                            <span class="delivery-info-value" id="receiverName">N/A</span>
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Receiver Phone:</span>
                            <span class="delivery-info-value" id="receiverPhone">N/A</span>
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Package Description:</span>
                            <span class="delivery-info-value" id="packageDescription">N/A</span>
                        </div>
                        <div class="delivery-info-row">
                            <span class="delivery-info-label">Package Value:</span>
                            <span class="delivery-info-value" id="packageValue">N/A</span>
                        </div>
                        <div class="special-instructions" id="specialInstructionsContainer" style="display: none;">
                            <strong>Special Instructions:</strong>
                            <p id="specialInstructions">No special instructions</p>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="trip-info-card">
                        <div class="trip-info-row">
                            <span class="trip-info-label">Distance</span>
                            <span class="trip-info-value" id="tripDistance">5.2 km</span>
                        </div>
                        <div class="trip-info-row">
                            <span class="trip-info-label">Estimated Time</span>
                            <span class="trip-info-value" id="tripTime">15 min</span>
                        </div>
                        <div class="trip-info-row">
                            <span class="trip-info-label">Surge Pricing</span>
                            <span class="trip-info-value" id="surgeMultiplier">1.2x</span>
                        </div>
                    </div>
                    
                    <h4 class="section-title">Route Waypoints</h4>
                    <div class="waypoints-container" id="waypointsContainer">
                        <!-- Waypoints will be populated here -->
                    </div>
                    
                    <div class="ride-request-actions">
                        <button class="btn btn-accept" id="acceptRideBtn">
                            <i class="fas fa-check-circle"></i>
                            Accept
                        </button>
                        <button class="btn btn-reject" id="rejectRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Reject
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <!-- Account Screen -->
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    Driver Details
                </h3>
                <div class="input-group">
                    <label for="driverNameInput">Full Name</label>
                    <input type="text" id="driverNameInput" class="input-field" placeholder="Your full name" readonly>
                </div>
                <div class="input-group">
                    <label for="driverPhoneInput">Phone Number</label>
                    <input type="tel" id="driverPhoneInput" class="input-field" placeholder="Your phone number" readonly>
                </div>
                <div class="input-group">
                    <label for="driverEmailInput">Email Address</label>
                    <input type="email" id="driverEmailInput" class="input-field" placeholder="Your email address" readonly>
                </div>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-car" id="accountVehicleIcon"></i>
                    Vehicle Details
                </h3>
                <div class="input-group">
                    <label for="vehicleTypeInput">Vehicle Type</label>
                    <input type="text" id="vehicleTypeInput" class="input-field" placeholder="Car, Bike, etc." readonly>
                </div>
                <div class="input-group">
                    <label for="vehicleModelInput">Vehicle Model</label>
                    <input type="text" id="vehicleModelInput" class="input-field" placeholder="Toyota Corolla, etc." readonly>
                </div>
                <div class="input-group">
                    <label for="licensePlateInput">License Plate</label>
                    <input type="text" id="licensePlateInput" class="input-field" placeholder="ABC 123" readonly>
                </div>
                <div class="input-group">
                    <label for="vehicleColorInput">Vehicle Color</label>
                    <input type="text" id="vehicleColorInput" class="input-field" placeholder="Red, Blue, etc." readonly>
                </div>
                
                <!-- NEW: Vehicle Images Grid in Account Page -->
                <div class="vehicle-images-section">
                    <h4 class="section-title">
                        <i class="fas fa-images"></i>
                        Vehicle Images
                    </h4>
                    <div class="vehicle-images-grid" id="vehicleImagesGrid">
                        <!-- Vehicle images will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Wallet Section -->
            <div class="wallet-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    Wallet & Earnings
                </h3>
                <div class="wallet-balance-card">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount-large" id="walletBalance">K0.00</div>
                    <div>Money earned from completed trips</div>
                </div>
                
                <div class="wallet-actions">
                    <button class="btn btn-wallet" id="addFundsBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Funds
                    </button>
                    <button class="btn btn-wallet" id="withdrawFundsBtn">
                        <i class="fas fa-minus-circle"></i>
                        Withdraw
                    </button>
                </div>
                
                <div class="vehicle-details">
                    <div class="detail-row">
                        <span class="detail-label">Total Earnings</span>
                        <span class="detail-value" id="totalEarnings">K0.00</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Completed Rides</span>
                        <span class="detail-value" id="completedRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cancelled Rides</span>
                        <span class="detail-value" id="cancelledRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Rating</span>
                        <span class="detail-value" id="driverRating">4.5 </span>
                    </div>
                </div>
            </div>
            
            <!-- Float Management Section -->
            <div class="float-section">
                <h3 class="section-title">
                    <i class="fas fa-money-bill-alt"></i>
                    Float Management
                </h3>
                <div class="float-balance-card">
                    <div class="balance-label">Current Float Balance</div>
                    <div class="balance-amount-medium" id="floatBalance">K0.00</div>
                    <div>Minimum K10.00 required to go online</div>
                </div>
                
                <div class="float-actions">
                    <button class="btn-float" id="addFloatBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Float
                    </button>
                    <button class="btn-float" id="adjustFloatBtn">
                        <i class="fas fa-exchange-alt"></i>
                        Adjust Float
                    </button>
                </div>
                
                <div class="float-history">
                    <h4 class="section-title">Float History</h4>
                    <div id="floatHistoryList">
                        <!-- Float history items will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- NEW: SOS Config Button -->
            <button class="sos-config-btn" id="sosConfigBtn">
                <i class="fas fa-life-ring"></i>
                SOS Emergency Contacts
            </button>
            
            <!-- Logout Button -->
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Log Out
            </button>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="earningsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Earnings</h2>
            </div>
            
            <div class="earnings-section">
                <div class="earnings-period">
                    <button class="period-btn active" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn" data-period="month">This Month</button>
                </div>
                
                <div class="earnings-card">
                    <div class="earnings-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="earningsTotal">K0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ridesCompleted">0</div>
                            <div class="stat-label">Rides Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgEarning">K0.00</div>
                            <div class="stat-label">Avg per Ride</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="onlineHours">0h</div>
                            <div class="stat-label">Online Time</div>
                        </div>
                    </div>
                    
                    <div class="earnings-chart">
                        Earnings chart would appear here
                    </div>
                    
                    <button class="btn btn-accept" id="withdrawEarningsBtn">
                        <i class="fas fa-download"></i>
                        Withdraw Earnings
                    </button>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-receipt"></i>
                    Recent Earnings
                </h3>
                <div id="earningsList">
                    <!-- Earnings items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- NEW: SOS Config Popup -->
    <div class="sos-config-popup" id="sosConfigPopup">
        <div class="sos-config-content">
            <div class="sos-config-header">
                <h2 class="sos-config-title">
                    <i class="fas fa-life-ring"></i>
                    SOS Emergency Contacts
                </h2>
                <button class="close-chat-btn" id="closeSOSConfigPopup">&times;</button>
            </div>
            <div class="sos-config-body">
                <div class="sos-config-info">
                    <i class="fas fa-info-circle"></i>
                    Set up emergency contacts and message. This information will be sent when you trigger SOS during a ride.
                </div>
                
                <div class="sos-config-input-group">
                    <label for="emergencyContact1" class="sos-config-label">Emergency Contact 1</label>
                    <input type="tel" id="emergencyContact1" class="sos-config-input" placeholder="+260 XXX XXX XXX">
                </div>
                
                <div class="sos-config-input-group">
                    <label for="emergencyContact2" class="sos-config-label">Emergency Contact 2</label>
                    <input type="tel" id="emergencyContact2" class="sos-config-input" placeholder="+260 XXX XXX XXX">
                </div>
                
                <div class="sos-config-input-group">
                    <label for="sosMessage" class="sos-config-label">Emergency Message</label>
                    <textarea id="sosMessage" class="sos-config-textarea" placeholder="I need emergency assistance! My current location is: [AUTO-LOCATION]. Ride details: [AUTO-RIDE-DETAILS]">I need emergency assistance! My current location is: [AUTO-LOCATION]. Ride details: [AUTO-RIDE-DETAILS]</textarea>
                </div>
                
                <div class="sos-config-actions">
                    <button class="sos-config-cancel" id="cancelSOSConfig">Cancel</button>
                    <button class="sos-config-save" id="saveSOSConfig">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // App state
        let currentUser = null;
        let currentRide = null;
        let isOnline = false;
        let driverMap, rideRequestMap;
        let locationWatchId = null;
        let driverMarker = null;
        let customerMarker = null;
        let destinationMarker = null;
        let routePolyline = null;
        let holdTimer = null;
        let holdProgress = 0;
        let currentRideRequest = null;
        let earningsPeriod = 'today';
        let waypoints = [];
        let floatBalance = 0;
        let walletBalance = 0;
        let commissionRate = 0.08; // 8% commission
        let trafficLayer = null;
        let trafficEnabled = false;
        let mapType = 'standard';
        let isDarkMode = false;
        let rideQueue = [];
        let floatHistory = [];
        let selectedVehicleType = '';
        let soundEnabled = true;
        let rideRequestSound = null;
        let rideRequestSoundInterval = null;

        // NEW: Chat state variables - ENHANCED
        let chatListener = null;
        let currentChatRideId = null;
        let unreadMessages = {};
        let chatPopupClosedByUser = false;
        let passengerMessageListener = null;
        let rideHistoryChatListeners = {}; // To manage multiple chat listeners for history

        // NEW: SOS Button state
        let sosButton = null;
        let sosConfig = null;

        // Image upload state
        let uploadedImages = {};
        let imageUploadProgress = {};
        let totalImagesToUpload = 0;
        let imagesUploaded = 0;

        // Registration status
        let registrationStatus = 'pending';

        // Statistics tracking
        let driverStats = {
            totalTrips: 0,
            totalEarnings: 0,
            totalOnlineTime: 0,
            acceptanceRate: 0,
            rating: 0,
            currentSessionStart: null,
            currentSessionTime: 0
        };

        // Ride queue from Firebase
        let rideQueueListener = null;

        // Cloudinary configuration
        const cloudinaryCloudName = 'dd3lcymrk';
        const cloudinaryUploadPreset = 'h3eyhc2o';
        const cloudinaryUploadUrl = `https://api.cloudinary.com/v1_1/${cloudinaryCloudName}/upload`;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            setupAuthEventListeners();
            initializeSound();
            setupChatPopupCloseHandler(); // NEW: Setup chat close handler
        });

        // NEW: Setup chat popup close handler
        function setupChatPopupCloseHandler() {
            // This will be called when the chat popup is created
        }

        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    checkRegistrationStatus();
                } else {
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                }
            });
        }

        // MODIFIED: Check registration status with proper messages
        function checkRegistrationStatus() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid).once('value')
                .then(snapshot => {
                    const userData = snapshot.val();
                    if (userData) {
                        registrationStatus = userData.registrationStatus || 'pending';
                        
                        if (registrationStatus === 'approved') {
                            // MODIFICATION #3: Show login success message
                            showNotification('Login successful! Welcome back!');
                            showMainApp();
                            initializeMap();
                            setupEventListeners();
                            loadDriverData();
                            initializeAdvancedFeatures();
                            checkActiveRide();
                            loadSOSConfig();
                        } else if (registrationStatus === 'pending') {
                            // MODIFICATION #3: Show pending approval message
                            showNotification('Your application is still pending approval. Please wait for administrator approval.');
                            document.getElementById('welcomeScreen').classList.add('hidden');
                            document.getElementById('loginScreen').classList.remove('active');
                            document.getElementById('signupScreen').classList.remove('active');
                            auth.signOut();
                        } else if (registrationStatus === 'rejected') {
                            // MODIFICATION #3: Show rejected message
                            showNotification('Your application has been rejected. Please contact support for more information.');
                            document.getElementById('welcomeScreen').classList.add('hidden');
                            document.getElementById('loginScreen').classList.remove('active');
                            document.getElementById('signupScreen').classList.remove('active');
                            auth.signOut();
                        }
                    } else {
                        showNotification('User data not found. Please contact support.');
                        auth.signOut();
                    }
                })
                .catch(error => {
                    console.error('Error checking registration status:', error);
                    showNotification('Error checking registration status. Please try again.');
                    auth.signOut();
                });
        }

        // NEW: Check for active ride when app loads/refreshes
        function checkActiveRide() {
            if (!currentUser) return;
            
            database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    if (rides) {
                        for (const rideId in rides) {
                            const ride = rides[rideId];
                            if (ride.status !== 'completed' && ride.status !== 'cancelled' && ride.status !== 'requested') {
                                restoreActiveRide(rideId, ride);
                                break;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error checking active ride:', error);
                });
        }

        // NEW: Restore active ride after app refresh
        function restoreActiveRide(rideId, ride) {
            currentRide = {
                id: rideId,
                ...ride
            };
            
            updateDriverPanelForActiveRide();
            updateMapForActiveRide();
            updateRideActionButtonBasedOnStatus(ride.status);
            document.getElementById('advancedFeatures').style.display = 'flex';
            showSOSButton();
            startPassengerMessageListener(rideId);
            showNotification('Active ride restored');
        }

        // NEW: Update ride action button based on current status
        function updateRideActionButtonBasedOnStatus(status) {
            switch(status) {
                case 'accepted':
                    updateRideActionButton('hold-to-start');
                    break;
                case 'started':
                    updateRideActionButton('hold-to-arrive');
                    break;
                case 'arrived':
                    updateRideActionButton('hold-to-pickup');
                    break;
                case 'picked_up':
                    updateRideActionButton('hold-to-complete');
                    break;
                default:
                    updateRideActionButton('hold-to-start');
            }
        }

        // Show main app after authentication
        function showMainApp() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('signupScreen').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
        }

        // Setup authentication event listeners
        function setupAuthEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            document.getElementById('signupBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('signupScreen').classList.add('active');
                setupImageUploadListeners();
            });
            
            document.getElementById('backFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            document.getElementById('backFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            document.getElementById('goToSignupFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('signupScreen').classList.add('active');
                setupImageUploadListeners();
            });
            
            document.getElementById('goToLoginFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.vehicle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    
                    document.querySelectorAll('.vehicle-details').forEach(details => {
                        details.classList.remove('active');
                    });
                    
                    selectedVehicleType = this.getAttribute('data-type');
                    document.getElementById(selectedVehicleType + 'Details').classList.add('active');
                    updateImageUploadRequirements(selectedVehicleType);
                });
            });
            
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                // MODIFICATION #3: Show login attempt message
                showNotification('Attempting to login...');
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Login successful - registration status will be checked in auth state change
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        // MODIFICATION #3: Show specific login error messages
                        let errorMessage = 'Login failed: ';
                        if (error.code === 'auth/user-not-found') {
                            errorMessage += 'No account found with this email';
                        } else if (error.code === 'auth/wrong-password') {
                            errorMessage += 'Incorrect password';
                        } else if (error.code === 'auth/invalid-email') {
                            errorMessage += 'Invalid email address';
                        } else {
                            errorMessage += error.message;
                        }
                        showNotification(errorMessage);
                    });
            });
            
            document.getElementById('signupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match');
                    return;
                }
                
                if (!selectedVehicleType) {
                    showNotification('Please select a vehicle type');
                    return;
                }
                
                if (!validateAllImagesUploaded()) {
                    showNotification('Please upload all required images');
                    return;
                }
                
                const email = document.getElementById('signupEmail').value;
                const name = document.getElementById('signupName').value;
                const phone = document.getElementById('signupPhone').value;
                const nrc = document.getElementById('signupNRC').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentDetails = document.getElementById('paymentDetails').value;
                
                document.getElementById('loadingOverlay').style.display = 'flex';
                document.getElementById('loadingText').textContent = 'Registering your account...';
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        
                        let vehicleData = {};
                        if (selectedVehicleType === 'car') {
                            vehicleData = {
                                type: 'car',
                                make: document.getElementById('carMake').value,
                                model: document.getElementById('carModel').value,
                                year: document.getElementById('carYear').value,
                                color: document.getElementById('carColor').value,
                                licensePlate: document.getElementById('carLicensePlate').value,
                                licenseNumber: document.getElementById('carLicenseNumber').value
                            };
                        } else if (selectedVehicleType === 'bike') {
                            vehicleData = {
                                type: 'bike',
                                make: document.getElementById('bikeMake').value,
                                model: document.getElementById('bikeModel').value,
                                year: document.getElementById('bikeYear').value,
                                licenseNumber: document.getElementById('bikeLicenseNumber').value
                            };
                        } else if (selectedVehicleType === 'bicycle') {
                            vehicleData = {
                                type: 'bicycle',
                                make: document.getElementById('bicycleMake').value,
                                color: document.getElementById('bicycleColor').value
                            };
                        }
                        
                        document.getElementById('loadingText').textContent = 'Uploading images to secure storage...';
                        
                        return uploadAllImagesToCloudinary()
                            .then((imageUrls) => {
                                document.getElementById('loadingText').textContent = 'Finalizing registration...';
                                
                                return database.ref('users/' + user.uid).set({
                                    name: name,
                                    email: email,
                                    phone: phone,
                                    nrc: nrc,
                                    vehicle: vehicleData,
                                    images: imageUrls,
                                    payment: {
                                        method: paymentMethod,
                                        details: paymentDetails
                                    },
                                    userType: 'driver',
                                    registrationStatus: 'pending',
                                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                                    isOnline: false,
                                    walletBalance: 0,
                                    floatBalance: 0,
                                    stats: {
                                        totalTrips: 0,
                                        totalEarnings: 0,
                                        totalOnlineTime: 0,
                                        acceptanceRate: 0,
                                        rating: 0
                                    }
                                });
                            });
                    })
                    .then(() => {
                        document.getElementById('loadingOverlay').style.display = 'none';
                        document.getElementById('registrationStatus').style.display = 'block';
                        
                        // MODIFICATION #3: Show registration success message
                        showNotification('Account created successfully! Your registration is pending approval. You will receive an email once approved.');
                        
                        setTimeout(() => {
                            document.getElementById('signupScreen').classList.remove('active');
                            document.getElementById('loginScreen').classList.add('active');
                        }, 3000);
                    })
                    .catch((error) => {
                        console.error('Signup error:', error);
                        document.getElementById('loadingOverlay').style.display = 'none';
                        let errorMessage = 'Signup failed: ';
                        if (error.code === 'auth/email-already-in-use') {
                            errorMessage += 'Email already in use';
                        } else if (error.code === 'auth/weak-password') {
                            errorMessage += 'Password is too weak';
                        } else {
                            errorMessage += error.message;
                        }
                        showNotification(errorMessage);
                    });
            });
        }

        // Setup image upload listeners
        function setupImageUploadListeners() {
            // Image upload boxes are created dynamically based on vehicle type
        }

        // Update image upload requirements based on vehicle type
        function updateImageUploadRequirements(vehicleType) {
            const imageUploadGrid = document.getElementById('imageUploadGrid');
            imageUploadGrid.innerHTML = '';
            
            uploadedImages = {};
            
            let requiredImages = [];
            
            if (vehicleType === 'car') {
                requiredImages = [
                    { id: 'profilePhoto', label: 'Profile Photo', required: true },
                    { id: 'nrcFront', label: 'NRC Front', required: true },
                    { id: 'nrcBack', label: 'NRC Back', required: true },
                    { id: 'driversLicense', label: 'Driver\'s License', required: true },
                    { id: 'vehicleFront', label: 'Vehicle Front', required: true },
                    { id: 'vehicleBack', label: 'Vehicle Back', required: true },
                    { id: 'frontSeats', label: 'Front Seats', required: true },
                    { id: 'backSeats', label: 'Back Seats', required: true }
                ];
            } else if (vehicleType === 'bike') {
                requiredImages = [
                    { id: 'profilePhoto', label: 'Profile Photo', required: true },
                    { id: 'nrcFront', label: 'NRC Front', required: true },
                    { id: 'nrcBack', label: 'NRC Back', required: true },
                    { id: 'driversLicense', label: 'Driver\'s License', required: true },
                    { id: 'bikePhoto', label: 'Bike Photo', required: true }
                ];
            } else if (vehicleType === 'bicycle') {
                requiredImages = [
                    { id: 'profilePhoto', label: 'Profile Photo', required: true },
                    { id: 'nrcFront', label: 'NRC Front', required: true },
                    { id: 'nrcBack', label: 'NRC Back', required: true },
                    { id: 'bicyclePhoto', label: 'Bicycle Photo', required: true }
                ];
            }
            
            requiredImages.forEach(image => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-upload-item';
                imageItem.innerHTML = `
                    <div class="image-upload-label">${image.label} ${image.required ? '*' : ''}</div>
                    <div class="image-upload-box" id="${image.id}Box">
                        <i class="fas fa-cloud-upload-alt image-upload-icon"></i>
                        <div class="image-upload-text">Click to upload</div>
                        <div class="upload-progress">
                            <div class="upload-progress-bar" id="${image.id}Progress"></div>
                        </div>
                    </div>
                    <input type="file" id="${image.id}Input" accept="image/*" style="display: none;">
                `;
                
                imageUploadGrid.appendChild(imageItem);
                
                const uploadBox = document.getElementById(`${image.id}Box`);
                const fileInput = document.getElementById(`${image.id}Input`);
                
                uploadBox.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', (e) => {
                    handleImageUpload(image.id, e.target.files[0]);
                });
            });
        }

        // Handle image upload
        function handleImageUpload(imageId, file) {
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showNotification('Please select an image file');
                return;
            }
            
            const uploadBox = document.getElementById(`${imageId}Box`);
            const progressBar = document.getElementById(`${imageId}Progress`);
            
            uploadBox.classList.add('has-image');
            uploadBox.innerHTML = `
                <div class="image-upload-text">Uploading...</div>
                <div class="upload-progress">
                    <div class="upload-progress-bar" id="${imageId}Progress"></div>
                </div>
            `;
            
            progressBar.style.width = '0%';
            
            uploadedImages[imageId] = file;
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadBox.innerHTML = `
                            <img src="${e.target.result}" class="image-preview" alt="${imageId}">
                            <div class="upload-progress">
                                <div class="upload-progress-bar" style="width: 100%; background: var(--success-green);"></div>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            }, 100);
        }

        // Validate all required images are uploaded
        function validateAllImagesUploaded() {
            let requiredImages = [];
            
            if (selectedVehicleType === 'car') {
                requiredImages = ['profilePhoto', 'nrcFront', 'nrcBack', 'driversLicense', 'vehicleFront', 'vehicleBack', 'frontSeats', 'backSeats'];
            } else if (selectedVehicleType === 'bike') {
                requiredImages = ['profilePhoto', 'nrcFront', 'nrcBack', 'driversLicense', 'bikePhoto'];
            } else if (selectedVehicleType === 'bicycle') {
                requiredImages = ['profilePhoto', 'nrcFront', 'nrcBack', 'bicyclePhoto'];
            }
            
            for (const imageId of requiredImages) {
                if (!uploadedImages[imageId]) {
                    return false;
                }
            }
            
            return true;
        }

        // Upload all images to Cloudinary
        function uploadAllImagesToCloudinary() {
            const uploadPromises = [];
            const imageUrls = {};
            
            imagesUploaded = 0;
            totalImagesToUpload = Object.keys(uploadedImages).length;
            
            for (const [imageId, file] of Object.entries(uploadedImages)) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', cloudinaryUploadPreset);
                formData.append('cloud_name', cloudinaryCloudName);
                
                const uploadPromise = fetch(cloudinaryUploadUrl, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.secure_url) {
                        imageUrls[imageId] = data.secure_url;
                        imagesUploaded++;
                        
                        document.getElementById('loadingText').textContent = 
                            `Uploading images... (${imagesUploaded}/${totalImagesToUpload})`;
                    } else {
                        throw new Error('Failed to upload image to Cloudinary');
                    }
                })
                .catch(error => {
                    console.error(`Error uploading ${imageId}:`, error);
                    throw error;
                });
                
                uploadPromises.push(uploadPromise);
            }
            
            return Promise.all(uploadPromises)
                .then(() => {
                    return imageUrls;
                });
        }

        // Map initialization
        function initializeMap() {
            driverMap = L.map('map').setView([-15.4167, 28.2833], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(driverMap);
            
            rideRequestMap = L.map('rideRequestMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(rideRequestMap);
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    driverMap.setView([lat, lng], 15);
                    
                    driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<div class="driver-marker"></div><div class="driver-marker-label">You</div>',
                            iconSize: [35, 50]
                        })
                    }).addTo(driverMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    updateDriverLocation(lat, lng);
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }

        // Update driver location in Firebase
        function updateDriverLocation(lat, lng) {
            if (currentUser && isOnline) {
                database.ref('driverLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    vehicleType: selectedVehicleType
                });
                
                if (driverMarker) {
                    driverMarker.setLatLng([lat, lng]);
                }
            }
        }

        // Start tracking driver location
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateDriverLocation(lat, lng);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        // Stop tracking driver location
        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }

        // Initialize sound
        function initializeSound() {
            rideRequestSound = new Audio();
            rideRequestSound.src = 'order.mp3';
            rideRequestSound.loop = false;
        }

        // Event listeners setup
        function setupEventListeners() {
            document.getElementById('onlineToggleCheckbox').addEventListener('change', toggleOnlineStatus);
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                    if (screen === 'home') {
                        refreshDriverPosition();
                    }
                });
            });
            
            document.getElementById('acceptRideBtn').addEventListener('click', acceptRide);
            document.getElementById('rejectRideBtn').addEventListener('click', rejectRide);
            
            const rideActionBtn = document.getElementById('rideActionBtn');
            
            rideActionBtn.addEventListener('mousedown', startHoldTimer);
            rideActionBtn.addEventListener('touchstart', startHoldTimer);
            
            rideActionBtn.addEventListener('mouseup', cancelHoldTimer);
            rideActionBtn.addEventListener('touchend', cancelHoldTimer);
            rideActionBtn.addEventListener('mouseleave', cancelHoldTimer);
            
            document.getElementById('addFundsBtn').addEventListener('click', addFunds);
            document.getElementById('withdrawFundsBtn').addEventListener('click', withdrawFunds);
            
            document.getElementById('addFloatBtn').addEventListener('click', addFloat);
            document.getElementById('adjustFloatBtn').addEventListener('click', adjustFloat);
            
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    earningsPeriod = this.getAttribute('data-period');
                    loadEarnings();
                });
            });
            
            document.getElementById('withdrawEarningsBtn').addEventListener('click', withdrawEarnings);
            
            document.getElementById('navigateToPickupBtn').addEventListener('click', navigateToPickup);
            document.getElementById('contactCustomerBtn').addEventListener('click', contactCustomer);
            document.getElementById('viewRouteDetailsBtn').addEventListener('click', viewRouteDetails);
            
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshDriverPosition);
            document.getElementById('toggleTrafficBtn').addEventListener('click', toggleTraffic);
            
            document.getElementById('zoomInBtn').addEventListener('click', () => driverMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => driverMap.zoomOut());
            document.getElementById('mapTypeBtn').addEventListener('click', toggleMapType);
            
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            document.getElementById('soundControl').addEventListener('click', toggleSound);
            
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            document.getElementById('driverDetailsHeader').addEventListener('click', toggleDriverDetails);
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            document.getElementById('requestMapZoomIn').addEventListener('click', () => rideRequestMap.zoomIn());
            document.getElementById('requestMapZoomOut').addEventListener('click', () => rideRequestMap.zoomOut());
            
            document.getElementById('sosConfigBtn').addEventListener('click', openSOSConfig);
            
            document.getElementById('closeSOSConfigPopup').addEventListener('click', closeSOSConfig);
            document.getElementById('cancelSOSConfig').addEventListener('click', closeSOSConfig);
            document.getElementById('saveSOSConfig').addEventListener('click', saveSOSConfig);
        }

        // NEW: Open SOS Configuration
        function openSOSConfig() {
            if (sosConfig) {
                document.getElementById('emergencyContact1').value = sosConfig.emergencyContact1 || '';
                document.getElementById('emergencyContact2').value = sosConfig.emergencyContact2 || '';
                document.getElementById('sosMessage').value = sosConfig.message || 'I need emergency assistance! My current location is: [AUTO-LOCATION]. Ride details: [AUTO-RIDE-DETAILS]';
            } else {
                document.getElementById('emergencyContact1').value = '';
                document.getElementById('emergencyContact2').value = '';
                document.getElementById('sosMessage').value = 'I need emergency assistance! My current location is: [AUTO-LOCATION]. Ride details: [AUTO-RIDE-DETAILS]';
            }
            
            document.getElementById('sosConfigPopup').style.display = 'flex';
        }

        // NEW: Close SOS Configuration
        function closeSOSConfig() {
            document.getElementById('sosConfigPopup').style.display = 'none';
        }

        // NEW: Save SOS Configuration
        function saveSOSConfig() {
            const emergencyContact1 = document.getElementById('emergencyContact1').value.trim();
            const emergencyContact2 = document.getElementById('emergencyContact2').value.trim();
            const message = document.getElementById('sosMessage').value.trim();
            
            if (!emergencyContact1 && !emergencyContact2) {
                showNotification('Please provide at least one emergency contact number.');
                return;
            }
            
            if (!message) {
                showNotification('Please provide an emergency message.');
                return;
            }
            
            sosConfig = {
                emergencyContact1: emergencyContact1,
                emergencyContact2: emergencyContact2,
                message: message,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            if (currentUser) {
                database.ref('sosConfig/' + currentUser.uid).set(sosConfig)
                    .then(() => {
                        showNotification('SOS emergency contacts saved successfully.');
                        closeSOSConfig();
                    })
                    .catch(error => {
                        console.error('Error saving SOS config:', error);
                        showNotification('Error saving SOS configuration. Please try again.');
                    });
            }
        }

        // NEW: Load SOS Configuration
        function loadSOSConfig() {
            if (!currentUser) return;
            
            database.ref('sosConfig/' + currentUser.uid).once('value')
                .then(snapshot => {
                    const config = snapshot.val();
                    if (config) {
                        sosConfig = config;
                    }
                })
                .catch(error => {
                    console.error('Error loading SOS config:', error);
                });
        }

        // NEW: Add Chat with Passenger button to advanced features
        function addChatWithPassengerButton() {
            const advancedFeatures = document.getElementById('advancedFeatures');
            
            if (!document.getElementById('chatWithPassengerBtn')) {
                const chatButton = document.createElement('button');
                chatButton.id = 'chatWithPassengerBtn';
                chatButton.className = 'feature-btn';
                chatButton.innerHTML = '<i class="fas fa-comments"></i><span>Chat with Passenger</span>';
                chatButton.addEventListener('click', function() {
                    openChatWithPassenger();
                });
                
                const contactBtn = document.getElementById('contactCustomerBtn');
                advancedFeatures.insertBefore(chatButton, contactBtn.nextSibling);
            }
        }

        // MODIFIED: Open chat with passenger - Enhanced with auto-popup feature
        function openChatWithPassenger() {
            if (!currentRide || !currentRide.id) {
                showNotification('No active ride to chat with passenger.');
                return;
            }
            
            if (!document.getElementById('driverChatPopup')) {
                createDriverChatPopup();
            }
            
            currentChatRideId = currentRide.id;
            
            // Reset the closed flag since user is opening the chat
            chatPopupClosedByUser = false;
            
            document.getElementById('chatPassengerName').textContent = currentRide.passengerName || 'Passenger';
            document.getElementById('chatPassengerRating').textContent = currentRide.passengerRating ? `${currentRide.passengerRating} ` : '4.5 ';
            
            document.getElementById('driverChatPopup').classList.remove('hidden');
            
            loadChatMessages(currentRide.id);
            
            startChatListener(currentRide.id);
        }

        // NEW: Create driver chat popup with close functionality
        function createDriverChatPopup() {
            const chatPopup = document.createElement('div');
            chatPopup.id = 'driverChatPopup';
            chatPopup.className = 'popup-overlay hidden';
            chatPopup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 15px;
            `;
            
            chatPopup.innerHTML = `
                <div class="popup-form" style="max-width: 400px; height: 500px; display: flex; flex-direction: column; background: white; border-radius: 8px; overflow: hidden;">
                    <div class="popup-header" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border-color);">
                        <h2 class="popup-title" style="font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-comments"></i>
                            Chat with Passenger
                        </h2>
                        <button class="close-chat-btn" id="closeDriverChatPopup">&times;</button>
                    </div>
                    <div class="chat-passenger-info" style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="passenger-avatar" id="chatPassengerAvatar" style="width: 30px; height: 30px; border-radius: 50%; background: var(--light-gray); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--medium-gray);">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem;" id="chatPassengerName">Passenger</div>
                                <div style="font-size: 0.7rem; color: var(--medium-gray);" id="chatPassengerRating">4.5 </div>
                            </div>
                        </div>
                    </div>
                    <div class="chat-messages" id="driverChatMessages" style="flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;"></div>
                    <div class="chat-input-container" style="padding: 10px; border-top: 1px solid var(--border-color);">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="driverChatMessageInput" placeholder="Type your message..." style="flex: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: var(--element-radius); font-size: 0.8rem;">
                            <button id="sendDriverChatMessageBtn" style="padding: 8px 15px; background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); cursor: pointer;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(chatPopup);
            
            // Add event listeners for chat
            document.getElementById('closeDriverChatPopup').addEventListener('click', function() {
                chatPopupClosedByUser = true; // Set flag when user manually closes chat
                closeDriverChatPopup();
            });
            
            document.getElementById('sendDriverChatMessageBtn').addEventListener('click', sendDriverChatMessage);
            document.getElementById('driverChatMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendDriverChatMessage();
                }
            });
        }

        // NEW: Load chat messages from Firebase
        function loadChatMessages(rideId) {
            const chatMessages = document.getElementById('driverChatMessages');
            chatMessages.innerHTML = '<div class="loading-text">Loading messages...</div>';
            
            database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const messages = snapshot.val();
                    chatMessages.innerHTML = '';
                    
                    if (messages) {
                        const messagesArray = Object.values(messages);
                        messagesArray.forEach(message => {
                            displayDriverChatMessage(message);
                        });
                        
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No messages yet. Start the conversation!</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading chat messages:', error);
                    chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading messages.</div>';
                });
        }

        // NEW: Start real-time chat listener
        function startChatListener(rideId) {
            if (chatListener) {
                chatListener();
            }
            
            chatListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
                const message = snapshot.val();
                displayDriverChatMessage(message);
                
                const chatMessages = document.getElementById('driverChatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Play notification sound for new messages from passenger
                if (message.senderId !== currentUser.uid && soundEnabled) {
                    playNotificationSound();
                }
            });
        }

        // NEW: Display chat message in driver chat
        function displayDriverChatMessage(message) {
            const chatMessages = document.getElementById('driverChatMessages');
            
            if (chatMessages.querySelector('.loading-text') || chatMessages.querySelector('.no-places')) {
                chatMessages.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'own-message' : 'other-message'}`;
            messageElement.style.cssText = `
                max-width: 80%;
                padding: 8px 12px;
                border-radius: 15px;
                margin-bottom: 5px;
                word-wrap: break-word;
                ${message.senderId === currentUser.uid ? 
                    'background: var(--primary-orange); color: white; align-self: flex-end;' : 
                    'background: var(--light-gray); color: var(--dark-gray); align-self: flex-start;'
                }
            `;
            
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageElement.innerHTML = `
                <div style="font-size: 0.8rem;">${message.message}</div>
                <div style="font-size: 0.6rem; opacity: 0.7; text-align: ${message.senderId === currentUser.uid ? 'right' : 'left'}; margin-top: 4px;">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageElement);
        }

        // NEW: Send chat message from driver
        function sendDriverChatMessage() {
            const messageInput = document.getElementById('driverChatMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatRideId) {
                return;
            }
            
            const messageData = {
                message: message,
                senderId: currentUser.uid,
                senderName: currentUser.displayName || 'Driver',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                rideId: currentChatRideId
            };
            
            database.ref('chats/' + currentChatRideId).push(messageData)
                .then(() => {
                    messageInput.value = '';
                })
                .catch(error => {
                    console.error('Error sending message:', error);
                    showNotification('Error sending message. Please try again.');
                });
        }

        // NEW: Close driver chat popup
        function closeDriverChatPopup() {
            document.getElementById('driverChatPopup').classList.add('hidden');
            
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            
            currentChatRideId = null;
        }

        // NEW: Play notification sound for new messages
        function playNotificationSound() {
            if (soundEnabled) {
                const notificationSound = new Audio();
                notificationSound.src = 'notification.mp3';
                notificationSound.play().catch(e => {
                    console.log('Notification sound play failed:', e);
                });
            }
        }

        // MODIFICATION #2: Enhanced passenger message listener with auto-popup
        function startPassengerMessageListener(rideId) {
            if (passengerMessageListener) {
                passengerMessageListener();
            }
            
            passengerMessageListener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
                const message = snapshot.val();
                
                if (message.senderId !== currentUser.uid) {
                    // MODIFICATION #2: Auto-popup chat when new message arrives and chat is closed
                    if (chatPopupClosedByUser && !isDriverChatPopupOpen()) {
                        // Auto-open chat popup for new passenger messages
                        openChatWithPassenger();
                        showNotification('New message from passenger');
                    }
                    
                    if (isDriverChatPopupOpen() && currentChatRideId === rideId) {
                        displayDriverChatMessage(message);
                        const chatMessages = document.getElementById('driverChatMessages');
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
            });
        }

        // NEW: Check if driver chat popup is currently open
        function isDriverChatPopupOpen() {
            const chatPopup = document.getElementById('driverChatPopup');
            return chatPopup && !chatPopup.classList.contains('hidden');
        }

        // NEW: Create and show SOS button
        function showSOSButton() {
            if (!sosButton) {
                sosButton = document.createElement('div');
                sosButton.id = 'driverSOSButton';
                sosButton.className = 'sos-button';
                sosButton.innerHTML = 'SOS';
                sosButton.style.cssText = `
                    position: fixed;
                    top: 10px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--error-red);
                    color: var(--white);
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.2rem;
                    font-weight: 700;
                    box-shadow: var(--shadow-heavy);
                    z-index: 150;
                    cursor: pointer;
                    animation: sos-pulse 2s infinite;
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes sos-pulse {
                        0% {
                            transform: translateX(-50%) scale(1);
                            box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
                        }
                        70% {
                            transform: translateX(-50%) scale(1.05);
                            box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
                        }
                        100% {
                            transform: translateX(-50%) scale(1);
                            box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
                        }
                    }
                `;
                document.head.appendChild(style);
                
                sosButton.addEventListener('click', triggerDriverSOS);
                
                document.body.appendChild(sosButton);
            }
            
            sosButton.style.display = 'flex';
        }

        // NEW: Hide SOS button
        function hideSOSButton() {
            if (sosButton) {
                sosButton.style.display = 'none';
            }
        }

        // NEW: Trigger driver SOS
        function triggerDriverSOS() {
            if (!currentRide) {
                showNotification('No active ride to report SOS for.');
                return;
            }
            
            if (!sosConfig) {
                showNotification('Please configure SOS emergency contacts in Account settings first.');
                return;
            }
            
            let currentLocation = 'Unknown location';
            if (driverMarker) {
                const latLng = driverMarker.getLatLng();
                currentLocation = `Lat: ${latLng.lat.toFixed(6)}, Lng: ${latLng.lng.toFixed(6)}`;
            }
            
            const rideDetails = `Passenger: ${currentRide.passengerName || 'N/A'}, From: ${currentRide.pickupLocation}, To: ${currentRide.destination}, Status: ${currentRide.status}`;
            
            let message = sosConfig.message;
            message = message.replace('[AUTO-LOCATION]', currentLocation);
            message = message.replace('[AUTO-RIDE-DETAILS]', rideDetails);
            
            const sosAlert = {
                driverId: currentUser.uid,
                driverName: currentUser.displayName || 'Driver',
                driverPhone: document.getElementById('driverPhoneInput').value || 'Not provided',
                rideDetails: currentRide,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                location: driverMarker ? driverMarker.getLatLng() : null,
                type: 'driver_sos',
                emergencyContacts: {
                    contact1: sosConfig.emergencyContact1,
                    contact2: sosConfig.emergencyContact2
                },
                message: message,
                status: 'active'
            };
            
            sosAlert.passengerDetails = {
                name: currentRide.passengerName,
                phone: currentRide.passengerPhone
            };
            
            database.ref('sosAlerts').push(sosAlert)
                .then(() => {
                    showNotification('SOS alert sent! Emergency contacts and Jubel safety team have been notified.');
                    
                    sendSOSToEmergencyContacts(sosAlert);
                })
                .catch(error => {
                    console.error('Error sending SOS alert:', error);
                    showNotification('Error sending SOS alert. Please call emergency services directly.');
                });
        }

        // NEW: Send SOS to emergency contacts
        function sendSOSToEmergencyContacts(sosAlert) {
            console.log('SOS Alert Details:', sosAlert);
            
            const emergencySOS = {
                ...sosAlert,
                emergencyContactsNotified: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'active'
            };
            
            database.ref('emergencySOS').push(emergencySOS)
                .catch(error => {
                    console.error('Error creating emergency SOS record:', error);
                });
        }

        // Initialize advanced features
        function initializeAdvancedFeatures() {
            updatePerformanceStats();
            initializeRideQueue();
            setInterval(updatePerformanceStats, 30000);
            setInterval(updateOnlineTime, 60000);
            addChatWithPassengerButton();
        }

        // Update performance statistics with REAL data
        function updatePerformanceStats() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid + '/stats').once('value')
                    .then(snapshot => {
                        const stats = snapshot.val();
                        if (stats) {
                            driverStats = { ...driverStats, ...stats };
                            
                            document.getElementById('totalTrips').textContent = driverStats.totalTrips || 0;
                            document.getElementById('ratingScore').textContent = (driverStats.rating || 0).toFixed(1);
                            document.getElementById('onlineTime').textContent = formatOnlineTime(driverStats.totalOnlineTime || 0);
                            document.getElementById('acceptanceRate').textContent = (driverStats.acceptanceRate || 0) + '%';
                            
                            document.getElementById('completedRides').textContent = driverStats.totalTrips || 0;
                            document.getElementById('totalEarnings').textContent = `K${(driverStats.totalEarnings || 0).toFixed(2)}`;
                            document.getElementById('driverRating').textContent = (driverStats.rating || 0).toFixed(1) + ' ';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading driver stats:', error);
                    });
            }
        }

        // Format online time from minutes to readable format
        function formatOnlineTime(minutes) {
            if (minutes < 60) {
                return `${minutes}m`;
            } else if (minutes < 1440) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            } else {
                const days = Math.floor(minutes / 1440);
                const hours = Math.floor((minutes % 1440) / 60);
                return `${days}d ${hours}h`;
            }
        }

        // Update online time tracking
        function updateOnlineTime() {
            if (isOnline && driverStats.currentSessionStart) {
                const currentTime = new Date().getTime();
                const sessionTime = Math.floor((currentTime - driverStats.currentSessionStart) / 60000);
                driverStats.currentSessionTime = sessionTime;
                
                document.getElementById('onlineTime').textContent = formatOnlineTime((driverStats.totalOnlineTime || 0) + sessionTime);
            }
        }

        // Initialize ride queue from Firebase (REAL data)
        function initializeRideQueue() {
            if (rideQueueListener) {
                rideQueueListener();
            }
            
            rideQueueListener = database.ref('rides').orderByChild('status').equalTo('requested').on('value', snapshot => {
                const rides = snapshot.val();
                rideQueue = [];
                
                if (rides) {
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        
                        if (ride.rideType === selectedVehicleType) {
                            rideQueue.push({
                                id: rideId,
                                ...ride
                            });
                        }
                    });
                }
                
                updateRideQueueDisplay();
            }, error => {
                console.error('Error loading ride queue:', error);
            });
        }

        // CHANGED: Update ride queue display with REAL data from Firebase
        function updateRideQueueDisplay() {
            const queueList = document.getElementById('queueList');
            queueList.innerHTML = '';
            
            if (rideQueue.length > 0 && isOnline && !currentRide) {
                rideQueue.forEach(ride => {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';
                    
                    const rideAmount = ride.fare ? `K${ride.fare.toFixed(2)}` : 'K0.00';
                    
                    queueItem.innerHTML = `
                        <div class="queue-info">
                            <div class="queue-location">${ride.pickupDisplayLocation || ride.pickupLocation}</div>
                            <div class="queue-time">${calculateDistanceToPickup(ride)}  ${rideAmount}</div>
                        </div>
                        <button class="queue-action" data-id="${ride.id}">Accept</button>
                    `;
                    queueList.appendChild(queueItem);
                });
                
                document.getElementById('rideQueue').style.display = 'block';
                
                document.querySelectorAll('.queue-action').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const rideId = this.getAttribute('data-id');
                        acceptRideFromQueue(rideId);
                    });
                });
            } else {
                document.getElementById('rideQueue').style.display = 'none';
            }
        }

        // Calculate distance to pickup for display
        function calculateDistanceToPickup(ride) {
            if (!driverMarker || !ride.pickupLat || !ride.pickupLng) {
                return 'Distance calculating...';
            }
            
            const driverLatLng = driverMarker.getLatLng();
            const distance = calculateDistance(
                driverLatLng.lat, driverLatLng.lng,
                ride.pickupLat, ride.pickupLng
            );
            
            if (distance < 1000) {
                return Math.round(distance) + ' m away';
            } else {
                return (distance / 1000).toFixed(1) + ' km away';
            }
        }

        // Accept ride from queue
        function acceptRideFromQueue(rideId) {
            const ride = rideQueue.find(r => r.id === rideId);
            if (ride) {
                showRideRequest(rideId, ride);
            }
        }

        // Toggle panel collapse
        function togglePanelCollapse() {
            const panel = document.getElementById('driverPanel');
            panel.classList.toggle('collapsed');
        }

        // Toggle driver details
        function toggleDriverDetails() {
            const content = document.getElementById('driverDetailsContent');
            const icon = document.getElementById('driverDetailsIcon');
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        // Toggle map type
        function toggleMapType() {
            driverMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    driverMap.removeLayer(layer);
                }
            });
            
            if (mapType === 'standard') {
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenTopoMap contributors'
                }).addTo(driverMap);
                mapType = 'satellite';
                showNotification('Switched to satellite view');
            } else {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(driverMap);
                mapType = 'standard';
                showNotification('Switched to standard view');
            }
        }

        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeToggle.style.background = '#333';
                darkModeToggle.style.color = '#ffcc00';
                showNotification('Dark mode enabled');
            } else {
                body.style.backgroundColor = '';
                body.style.color = '';
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeToggle.style.background = '';
                darkModeToggle.style.color = '';
                showNotification('Dark mode disabled');
            }
        }

        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundControl = document.getElementById('soundControl');
            
            if (soundEnabled) {
                soundControl.innerHTML = '<i class="fas fa-volume-up"></i>';
                soundControl.style.background = '';
                soundControl.style.color = '';
                showNotification('Sound enabled');
            } else {
                soundControl.innerHTML = '<i class="fas fa-volume-mute"></i>';
                soundControl.style.background = '#333';
                soundControl.style.color = '#ffcc00';
                showNotification('Sound disabled');
                
                if (rideRequestSound && !rideRequestSound.paused) {
                    rideRequestSound.pause();
                    rideRequestSound.currentTime = 0;
                }
                if (rideRequestSoundInterval) {
                    clearInterval(rideRequestSoundInterval);
                    rideRequestSoundInterval = null;
                }
            }
        }

        // Switch between screens
        function switchScreen(screenId) {
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            const floatingElements = document.querySelectorAll('.floating-float, .online-toggle, .driver-status-indicator, .map-controls, .quick-actions, .dark-mode-toggle, .sound-control');
            
            if (screenId === 'home') {
                floatingElements.forEach(el => {
                    el.style.display = 'flex';
                });
            } else {
                floatingElements.forEach(el => {
                    el.style.display = 'none';
                });
            }
            
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'earnings') {
                loadEarnings();
            } else if (screenId === 'account') {
                loadFloatHistory();
                loadVehicleImages();
            }
        }

        // NEW: Load vehicle images for display in account page
        function loadVehicleImages() {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid + '/images').once('value')
                .then(snapshot => {
                    const images = snapshot.val();
                    const vehicleImagesGrid = document.getElementById('vehicleImagesGrid');
                    vehicleImagesGrid.innerHTML = '';
                    
                    if (images) {
                        let imageTypes = [];
                        
                        if (selectedVehicleType === 'car') {
                            imageTypes = [
                                { id: 'profilePhoto', label: 'Profile Photo' },
                                { id: 'vehicleFront', label: 'Vehicle Front' },
                                { id: 'vehicleBack', label: 'Vehicle Back' },
                                { id: 'frontSeats', label: 'Front Seats' },
                                { id: 'backSeats', label: 'Back Seats' }
                            ];
                        } else if (selectedVehicleType === 'bike') {
                            imageTypes = [
                                { id: 'profilePhoto', label: 'Profile Photo' },
                                { id: 'bikePhoto', label: 'Bike Photo' }
                            ];
                        } else if (selectedVehicleType === 'bicycle') {
                            imageTypes = [
                                { id: 'profilePhoto', label: 'Profile Photo' },
                                { id: 'bicyclePhoto', label: 'Bicycle Photo' }
                            ];
                        }
                        
                        imageTypes.push(
                            { id: 'nrcFront', label: 'NRC Front' },
                            { id: 'nrcBack', label: 'NRC Back' }
                        );
                        
                        if (selectedVehicleType === 'car' || selectedVehicleType === 'bike') {
                            imageTypes.push({ id: 'driversLicense', label: 'Driver\'s License' });
                        }
                        
                        imageTypes.forEach(imageType => {
                            const imageItem = document.createElement('div');
                            imageItem.className = 'vehicle-image-item';
                            
                            const imageUrl = images[imageType.id];
                            
                            imageItem.innerHTML = `
                                <div class="vehicle-image-label">${imageType.label}</div>
                                <div class="vehicle-image-box">
                                    ${imageUrl ? 
                                        `<img src="${imageUrl}" class="vehicle-image-preview" alt="${imageType.label}">` :
                                        `<div class="no-vehicle-image">No image uploaded</div>`
                                    }
                                </div>
                            `;
                            
                            vehicleImagesGrid.appendChild(imageItem);
                        });
                    } else {
                        vehicleImagesGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--medium-gray);">No vehicle images found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading vehicle images:', error);
                    const vehicleImagesGrid = document.getElementById('vehicleImagesGrid');
                    vehicleImagesGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--error-red);">Error loading vehicle images.</p>';
                });
        }

        // Toggle online status
        function toggleOnlineStatus() {
            isOnline = !isOnline;
            const onlineToggle = document.getElementById('onlineToggle');
            const onlineStatusText = document.getElementById('onlineStatusText');
            const statusIndicator = document.getElementById('driverStatusIndicator');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                if (floatBalance < 10) {
                    showNotification('Cannot go online. Your float balance is below minimum K10.00. Please add float.');
                    isOnline = false;
                    document.getElementById('onlineToggleCheckbox').checked = false;
                    return;
                }
                
                onlineToggle.classList.remove('offline');
                onlineToggle.classList.add('active');
                onlineStatusText.textContent = 'Online';
                
                statusIndicator.style.display = 'flex';
                statusDot.classList.add('online');
                statusText.textContent = 'Online';
                
                startLocationTracking();
                driverStats.currentSessionStart = new Date().getTime();
                listenForRideRequests();
                
                showNotification('You are now online and receiving ride requests.');
            } else {
                onlineToggle.classList.remove('active');
                onlineToggle.classList.add('offline');
                onlineStatusText.textContent = 'Offline';
                
                statusIndicator.style.display = 'none';
                statusDot.classList.remove('online');
                
                stopLocationTracking();
                
                if (driverStats.currentSessionStart) {
                    const sessionEnd = new Date().getTime();
                    const sessionTime = Math.floor((sessionEnd - driverStats.currentSessionStart) / 60000);
                    driverStats.totalOnlineTime = (driverStats.totalOnlineTime || 0) + sessionTime;
                    driverStats.currentSessionStart = null;
                    
                    if (currentUser) {
                        database.ref('users/' + currentUser.uid + '/stats/totalOnlineTime').set(driverStats.totalOnlineTime);
                    }
                }
                
                showNotification('You are now offline.');
            }
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    isOnline: isOnline,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Listen for ride requests
        function listenForRideRequests() {
            database.ref('rides').orderByChild('status').equalTo('requested').on('value', snapshot => {
                const rides = snapshot.val();
                if (rides) {
                    for (const rideId in rides) {
                        const ride = rides[rideId];
                        
                        if (ride.rideType === selectedVehicleType && !currentRideRequest) {
                            showRideRequest(rideId, ride);
                            break;
                        }
                    }
                }
            });
        }

        // ENHANCED: Show ride request popup with bigger map and proper zoom
        function showRideRequest(rideId, ride) {
            if (currentRide) {
                return;
            }
            
            currentRideRequest = {
                id: rideId,
                ...ride
            };
            
            document.getElementById('customerName').textContent = ride.passengerName || 'Passenger';
            document.getElementById('customerPhone').textContent = ride.passengerPhone || 'N/A';
            document.getElementById('customerRating').textContent = ride.passengerRating || '4.8';
            document.getElementById('pickupLocation').textContent = ride.pickupDisplayLocation || ride.pickupLocation;
            document.getElementById('destinationLocation').textContent = ride.destination;
            document.getElementById('tripDistance').textContent = ride.distance || 'Calculating...';
            document.getElementById('tripTime').textContent = ride.estimatedTime || 'Calculating...';
            document.getElementById('surgeMultiplier').textContent = ride.surgeMultiplier || '1.0x';
            
            const baseFare = ride.fare || 15;
            const discount = ride.promoCode ? baseFare * 0.2 : 0;
            const totalFare = baseFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('distanceFare').textContent = `K0.00`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
            
            updateRideTypeDisplay(ride);
            updateOrderForSomeoneDisplay(ride);
            updateExpressDeliveryDisplay(ride);
            
            const deliveryInfoSection = document.getElementById('deliveryInfoSection');
            if (ride.rideType === 'bike' || ride.rideType === 'bicycle' || ride.packageDetails) {
                deliveryInfoSection.style.display = 'block';
                
                if (ride.packageDetails) {
                    document.getElementById('receiverName').textContent = ride.packageDetails.receiverName || 'N/A';
                    document.getElementById('receiverPhone').textContent = ride.packageDetails.receiverPhone || 'N/A';
                    document.getElementById('packageDescription').textContent = ride.packageDetails.packageDescription || 'N/A';
                    document.getElementById('packageValue').textContent = ride.packageDetails.packageValue ? `K${ride.packageDetails.packageValue}` : 'N/A';
                    
                    const specialInstructionsContainer = document.getElementById('specialInstructionsContainer');
                    if (ride.packageDetails.specialInstructions) {
                        specialInstructionsContainer.style.display = 'block';
                        document.getElementById('specialInstructions').textContent = ride.packageDetails.specialInstructions;
                    } else {
                        specialInstructionsContainer.style.display = 'none';
                    }
                } else {
                    document.getElementById('receiverName').textContent = 'N/A';
                    document.getElementById('receiverPhone').textContent = 'N/A';
                    document.getElementById('packageDescription').textContent = 'N/A';
                    document.getElementById('packageValue').textContent = 'N/A';
                    document.getElementById('specialInstructionsContainer').style.display = 'none';
                }
            } else {
                deliveryInfoSection.style.display = 'none';
            }
            
            updateRideRequestMap(ride);
            generateRealWaypoints(ride);
            
            document.getElementById('rideRequestPopup').style.display = 'flex';
            
            if (soundEnabled) {
                playRideRequestSound();
            }
        }

        // NEW: Enhanced ride type detection and display
        function updateRideTypeDisplay(ride) {
            const rideTypeElement = document.getElementById('rideTypeDisplay');
            if (!rideTypeElement) {
                const locationRow = document.querySelector('.location-row');
                const rideTypeRow = document.createElement('div');
                rideTypeRow.className = 'location-row';
                rideTypeRow.innerHTML = `
                    <div class="location-icon" style="background: #3498db;">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="location-text">
                        <h4>Ride Type</h4>
                        <p id="rideTypeDisplay">${getRideTypeDisplayName(ride.rideType)}</p>
                    </div>
                `;
                locationRow.parentNode.insertBefore(rideTypeRow, locationRow.nextSibling);
            } else {
                document.getElementById('rideTypeDisplay').textContent = getRideTypeDisplayName(ride.rideType);
            }
            
            const vehicleIcon = document.querySelector('.ride-request-content .location-icon i');
            if (vehicleIcon) {
                switch(ride.rideType) {
                    case 'car':
                        vehicleIcon.className = 'fas fa-car';
                        break;
                    case 'bike':
                        vehicleIcon.className = 'fas fa-motorcycle';
                        break;
                    case 'bicycle':
                        vehicleIcon.className = 'fas fa-bicycle';
                        break;
                }
            }
        }

        // NEW: Get display name for ride type
        function getRideTypeDisplayName(rideType) {
            switch(rideType) {
                case 'car':
                    return 'Standard Ride';
                case 'bike':
                    return 'Express Delivery';
                case 'bicycle':
                    return 'Short Delivery';
                default:
                    return 'Ride';
            }
        }

        // NEW: Update order for someone else display
        function updateOrderForSomeoneDisplay(ride) {
            const orderForSomeoneSection = document.getElementById('orderForSomeoneSection');
            if (!orderForSomeoneSection) {
                const deliveryInfoSection = document.getElementById('deliveryInfoSection');
                const orderSection = document.createElement('div');
                orderSection.className = 'delivery-info-section';
                orderSection.id = 'orderForSomeoneSection';
                orderSection.style.display = 'none';
                orderSection.innerHTML = `
                    <div class="delivery-info-title">
                        <i class="fas fa-user-friends"></i> Order for Someone Else
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Recipient Name:</span>
                        <span class="delivery-info-value" id="recipientNameDisplay">N/A</span>
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Recipient Phone:</span>
                        <span class="delivery-info-value" id="recipientPhoneDisplay">N/A</span>
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Recipient Email:</span>
                        <span class="delivery-info-value" id="recipientEmailDisplay">N/A</span>
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Ordered By:</span>
                        <span class="delivery-info-value" id="orderedByDisplay">N/A</span>
                    </div>
                `;
                deliveryInfoSection.parentNode.insertBefore(orderSection, deliveryInfoSection);
            }
            
            if (ride.orderForSomeone) {
                document.getElementById('orderForSomeoneSection').style.display = 'block';
                document.getElementById('recipientNameDisplay').textContent = ride.orderForSomeone.recipientName || 'N/A';
                document.getElementById('recipientPhoneDisplay').textContent = ride.orderForSomeone.recipientPhone || 'N/A';
                document.getElementById('recipientEmailDisplay').textContent = ride.orderForSomeone.recipientEmail || 'N/A';
                document.getElementById('orderedByDisplay').textContent = ride.orderForSomeone.orderedBy || 'N/A';
            } else {
                document.getElementById('orderForSomeoneSection').style.display = 'none';
            }
        }

        // NEW: Update express delivery display
        function updateExpressDeliveryDisplay(ride) {
            const expressDeliverySection = document.getElementById('expressDeliverySection');
            if (!expressDeliverySection) {
                const orderForSomeoneSection = document.getElementById('orderForSomeoneSection') || document.getElementById('deliveryInfoSection');
                const expressSection = document.createElement('div');
                expressSection.className = 'delivery-info-section';
                expressSection.id = 'expressDeliverySection';
                expressSection.style.display = 'none';
                expressSection.innerHTML = `
                    <div class="delivery-info-title">
                        <i class="fas fa-shipping-fast"></i> Express Delivery Details
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Shop Name:</span>
                        <span class="delivery-info-value" id="shopNameDisplay">N/A</span>
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Items to Purchase:</span>
                        <span class="delivery-info-value" id="deliveryItemsDisplay">N/A</span>
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Amount to Spend:</span>
                        <span class="delivery-info-value" id="deliveryAmountDisplay">N/A</span>
                    </div>
                    <div class="delivery-info-row">
                        <span class="delivery-info-label">Special Instructions:</span>
                        <span class="delivery-info-value" id="deliveryInstructionsDisplay">N/A</span>
                    </div>
                `;
                orderForSomeoneSection.parentNode.insertBefore(expressSection, orderForSomeoneSection.nextSibling);
            }
            
            if (ride.expressDelivery) {
                document.getElementById('expressDeliverySection').style.display = 'block';
                document.getElementById('shopNameDisplay').textContent = ride.expressDelivery.shopName || 'N/A';
                document.getElementById('deliveryItemsDisplay').textContent = ride.expressDelivery.items || 'N/A';
                document.getElementById('deliveryAmountDisplay').textContent = ride.expressDelivery.amount ? `K${ride.expressDelivery.amount}` : 'N/A';
                document.getElementById('deliveryInstructionsDisplay').textContent = ride.expressDelivery.instructions || 'N/A';
            } else {
                document.getElementById('expressDeliverySection').style.display = 'none';
            }
        }

        // ENHANCED: Update ride request map
        function updateRideRequestMap(ride) {
            rideRequestMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    rideRequestMap.removeLayer(layer);
                }
            });
            
            const pickupMarker = L.marker([ride.pickupLat, ride.pickupLng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div><div style="background: white; padding: 3px 8px; border-radius: 10px; margin-top: 5px; font-size: 10px; font-weight: bold; box-shadow: 0 1px 5px rgba(0,0,0,0.2);">Pickup</div>',
                    iconSize: [30, 45]
                })
            }).addTo(rideRequestMap).bindPopup('Pickup Location');
            
            const destinationMarker = L.marker([ride.destLat, ride.destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div><div style="background: white; padding: 3px 8px; border-radius: 10px; margin-top: 5px; font-size: 10px; font-weight: bold; box-shadow: 0 1px 5px rgba(0,0,0,0.2);">Destination</div>',
                    iconSize: [30, 45]
                })
            }).addTo(rideRequestMap).bindPopup('Destination');
            
            drawEnhancedRouteOnRequestMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
            
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            
            const expandedBounds = bounds.pad(0.15);
            
            rideRequestMap.fitBounds(expandedBounds, { 
                padding: [25, 25],
                maxZoom: 16,
                animate: true
            });
            
            setTimeout(() => {
                const currentZoom = rideRequestMap.getZoom();
                if (currentZoom > 12) {
                    rideRequestMap.setZoom(currentZoom - 0.7);
                }
            }, 300);
        }

        // ENHANCED: Draw route on ride request map with better styling
        function drawEnhancedRouteOnRequestMap(startLat, startLng, endLat, endLng) {
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 6,
                            opacity: 0.8,
                            lineJoin: 'round',
                            lineCap: 'round',
                            dashArray: null
                        }).addTo(rideRequestMap);
                        
                        L.circleMarker([startLat, startLng], {
                            color: '#FF6B35',
                            fillColor: '#FF6B35',
                            fillOpacity: 1,
                            radius: 6,
                            weight: 2
                        }).addTo(rideRequestMap);
                        
                        L.circleMarker([endLat, endLng], {
                            color: '#E74C3C',
                            fillColor: '#E74C3C',
                            fillOpacity: 1,
                            radius: 6,
                            weight: 2
                        }).addTo(rideRequestMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 5,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(rideRequestMap);
                });
        }

        // CHANGED: Generate REAL waypoints using OSRM API
        function generateRealWaypoints(ride) {
            const waypointsContainer = document.getElementById('waypointsContainer');
            waypointsContainer.innerHTML = '<div class="loading-text">Loading route instructions...</div>';
            
            fetch(`https://router.project-osrm.org/route/v1/driving/${ride.pickupLng},${ride.pickupLat};${ride.destLng},${ride.destLat}?overview=full&geometries=geojson&steps=true`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const legs = route.legs;
                        
                        waypointsContainer.innerHTML = '';
                        waypoints = [];
                        
                        if (legs && legs.length > 0) {
                            const steps = legs[0].steps;
                            
                            const maxWaypoints = 8;
                            const stepInterval = Math.max(1, Math.floor(steps.length / maxWaypoints));
                            
                            for (let i = 0; i < steps.length && waypoints.length < maxWaypoints; i += stepInterval) {
                                const step = steps[i];
                                const instruction = step.maneuver.instruction;
                                const distance = (step.distance / 1000).toFixed(1);
                                
                                if (instruction && !instruction.includes('arrived')) {
                                    waypoints.push({
                                        instruction: instruction,
                                        distance: distance
                                    });
                                    
                                    const waypointItem = document.createElement('div');
                                    waypointItem.className = 'waypoint-item';
                                    waypointItem.innerHTML = `
                                        <div class="waypoint-icon">
                                            <i class="fas fa-map-pin"></i>
                                        </div>
                                        <div class="waypoint-text">
                                            <div>${instruction}</div>
                                            <div style="font-size: 0.6rem; color: var(--medium-gray); margin-top: 2px;">${distance} km</div>
                                        </div>
                                    `;
                                    
                                    waypointsContainer.appendChild(waypointItem);
                                }
                            }
                            
                            if (waypoints.length > 0) {
                                const waypointItem = document.createElement('div');
                                waypointItem.className = 'waypoint-item';
                                waypointItem.innerHTML = `
                                    <div class="waypoint-icon">
                                        <i class="fas fa-flag-checkered"></i>
                                    </div>
                                    <div class="waypoint-text">
                                        <div>Arrive at destination</div>
                                    </div>
                                `;
                                
                                waypointsContainer.appendChild(waypointItem);
                            }
                        } else {
                            waypointsContainer.innerHTML = '<div class="no-places" style="text-align: center; padding: 10px; color: var(--medium-gray);">No route instructions available.</div>';
                        }
                    } else {
                        waypointsContainer.innerHTML = '<div class="no-places" style="text-align: center; padding: 10px; color: var(--medium-gray);">No route instructions available.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching route instructions:', error);
                    waypointsContainer.innerHTML = '<div class="no-places" style="text-align: center; padding: 10px; color: var(--error-red);">Error loading route instructions.</div>';
                    
                    generateSampleWaypoints(ride);
                });
        }

        // Fallback function for sample waypoints
        function generateSampleWaypoints(ride) {
            waypoints = [];
            const waypointsContainer = document.getElementById('waypointsContainer');
            waypointsContainer.innerHTML = '';
            
            const distance = calculateDistance(
                ride.pickupLat, ride.pickupLng,
                ride.destLat, ride.destLng
            );
            
            const numWaypoints = Math.min(Math.max(Math.floor(distance / 1000), 3), 8);
            
            const sampleWaypoints = [
                "Head northeast on Independence Avenue",
                "Continue straight for 1.2 km",
                "Turn right onto Cairo Road",
                "Merge onto Great East Road",
                "Continue for 2.5 km",
                "Turn left at the traffic lights",
                "Destination will be on your right"
            ].slice(0, numWaypoints);
            
            sampleWaypoints.forEach((waypoint, index) => {
                waypoints.push(waypoint);
                
                const waypointItem = document.createElement('div');
                waypointItem.className = 'waypoint-item';
                waypointItem.innerHTML = `
                    <div class="waypoint-icon">
                        <i class="fas fa-map-pin"></i>
                    </div>
                    <div class="waypoint-text">
                        ${waypoint}
                    </div>
                `;
                
                waypointsContainer.appendChild(waypointItem);
            });
        }

        // Play ride request sound continuously
        function playRideRequestSound() {
            if (rideRequestSoundInterval) {
                clearInterval(rideRequestSoundInterval);
            }
            
            rideRequestSoundInterval = setInterval(() => {
                if (soundEnabled && document.getElementById('rideRequestPopup').style.display === 'flex') {
                    rideRequestSound.play().catch(e => {
                        console.log('Audio play failed:', e);
                    });
                }
            }, 3000);
        }

        // Stop ride request sound
        function stopRideRequestSound() {
            if (rideRequestSound && !rideRequestSound.paused) {
                rideRequestSound.pause();
                rideRequestSound.currentTime = 0;
            }
            if (rideRequestSoundInterval) {
                clearInterval(rideRequestSoundInterval);
                rideRequestSoundInterval = null;
            }
        }

        // FIXED: Accept a ride
        function acceptRide() {
            if (currentRideRequest && currentUser) {
                stopRideRequestSound();
                
                database.ref('users/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const driverData = snapshot.val();
                        
                        const driverProfileImage = driverData.images ? driverData.images.profilePhoto : null;
                        const vehicleFrontImage = driverData.images ? driverData.images.vehicleFront : null;
                        
                        let driverLat = null;
                        let driverLng = null;
                        if (driverMarker) {
                            const driverLatLng = driverMarker.getLatLng();
                            driverLat = driverLatLng.lat;
                            driverLng = driverLatLng.lng;
                        }
                        
                        const rideUpdate = {
                            driverId: currentUser.uid,
                            driverName: driverData.name,
                            driverPhone: driverData.phone,
                            driverVehicle: driverData.vehicle,
                            driverProfileImage: driverProfileImage,
                            vehicleImage: vehicleFrontImage,
                            driverLat: driverLat,
                            driverLng: driverLng,
                            status: 'accepted',
                            acceptedAt: firebase.database.ServerValue.TIMESTAMP,
                            updatedAt: firebase.database.ServerValue.TIMESTAMP
                        };
                        
                        return database.ref('rides/' + currentRideRequest.id).update(rideUpdate);
                    })
                    .then(() => {
                        currentRide = {
                            id: currentRideRequest.id,
                            ...currentRideRequest,
                            driverId: currentUser.uid,
                            status: 'accepted'
                        };
                        
                        document.getElementById('rideRequestPopup').style.display = 'none';
                        updateDriverPanelForActiveRide();
                        updateMapForActiveRide();
                        updateAcceptanceRate(true);
                        showSOSButton();
                        startPassengerMessageListener(currentRide.id);
                        showNotification('Ride accepted successfully.');
                        currentRideRequest = null;
                    })
                    .catch(error => {
                        console.error('Error accepting ride:', error);
                        showNotification('Error accepting ride. Please try again.');
                    });
            }
        }

        // Reject a ride
        function rejectRide() {
            if (currentRideRequest) {
                stopRideRequestSound();
                document.getElementById('rideRequestPopup').style.display = 'none';
                updateAcceptanceRate(false);
                currentRideRequest = null;
                showNotification('Ride rejected.');
            }
        }

        // Update acceptance rate in statistics
        function updateAcceptanceRate(accepted) {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid + '/stats').once('value')
                .then(snapshot => {
                    const stats = snapshot.val() || {};
                    const totalRequests = (stats.totalRequests || 0) + 1;
                    const acceptedRequests = (stats.acceptedRequests || 0) + (accepted ? 1 : 0);
                    const acceptanceRate = Math.round((acceptedRequests / totalRequests) * 100);
                    
                    driverStats.acceptanceRate = acceptanceRate;
                    driverStats.totalRequests = totalRequests;
                    driverStats.acceptedRequests = acceptedRequests;
                    
                    return database.ref('users/' + currentUser.uid + '/stats').update({
                        acceptanceRate: acceptanceRate,
                        totalRequests: totalRequests,
                        acceptedRequests: acceptedRequests
                    });
                })
                .then(() => {
                    document.getElementById('acceptanceRate').textContent = acceptanceRate + '%';
                })
                .catch(error => {
                    console.error('Error updating acceptance rate:', error);
                });
        }

        // Update driver panel for active ride
        function updateDriverPanelForActiveRide() {
            if (currentRide) {
                document.getElementById('driverName').textContent = currentRide.passengerName || 'Passenger';
                document.getElementById('driverPhone').textContent = currentRide.passengerPhone || 'N/A';
                document.getElementById('vehicleDetails').textContent = `To: ${currentRide.destination}`;
                document.getElementById('rideActionBtn').style.display = 'block';
                document.getElementById('advancedFeatures').style.display = 'flex';
                updateRideActionButton('hold-to-start');
                document.getElementById('rideQueue').style.display = 'none';
                updateRideTypeInstructions(currentRide);
            }
        }

        // NEW: Update ride type specific instructions
        function updateRideTypeInstructions(ride) {
            const instructionsElement = document.getElementById('rideTypeInstructions');
            if (!instructionsElement) {
                const advancedFeatures = document.getElementById('advancedFeatures');
                const instructions = document.createElement('div');
                instructions.className = 'ride-type-instructions';
                instructions.id = 'rideTypeInstructions';
                instructions.style.padding = '10px';
                instructions.style.marginTop = '10px';
                instructions.style.background = 'var(--light-orange)';
                instructions.style.borderRadius = 'var(--element-radius)';
                instructions.style.fontSize = '0.8rem';
                advancedFeatures.parentNode.insertBefore(instructions, advancedFeatures);
            }
            
            let instructions = '';
            switch(ride.rideType) {
                case 'car':
                    instructions = 'Standard ride - Ensure passenger comfort and safety';
                    break;
                case 'bike':
                    instructions = 'Express delivery - Handle package with care, confirm recipient details';
                    if (ride.packageDetails) {
                        instructions += `. Package: ${ride.packageDetails.packageDescription || 'N/A'}`;
                    }
                    break;
                case 'bicycle':
                    instructions = 'Short delivery - Eco-friendly delivery for short distances';
                    if (ride.packageDetails) {
                        instructions += `. Package: ${ride.packageDetails.packageDescription || 'N/A'}`;
                    }
                    break;
            }
            
            if (ride.orderForSomeone) {
                instructions += ` | Order for: ${ride.orderForSomeone.recipientName}`;
            }
            
            if (ride.expressDelivery) {
                instructions += ` | Express delivery from: ${ride.expressDelivery.shopName}`;
            }
            
            document.getElementById('rideTypeInstructions').textContent = instructions;
        }

        // Update map for active ride
        function updateMapForActiveRide() {
            if (currentRide) {
                if (customerMarker) {
                    driverMap.removeLayer(customerMarker);
                    customerMarker = null;
                }
                if (destinationMarker) {
                    driverMap.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routePolyline) {
                    driverMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
                
                customerMarker = L.marker([currentRide.pickupLat, currentRide.pickupLng], {
                    icon: L.divIcon({
                        className: 'customer-marker',
                        html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold; box-shadow: 0 1px 5px rgba(0,0,0,0.2);">Customer</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Customer Pickup Location');
                
                destinationMarker = L.marker([currentRide.destLat, currentRide.destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold; box-shadow: 0 1px 5px rgba(0,0,0,0.2);">Destination</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Destination');
                
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.pickupLat, currentRide.pickupLng);
                }
                
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    const customerLatLng = customerMarker.getLatLng();
                    
                    const bounds = L.latLngBounds(
                        [driverLatLng.lat, driverLatLng.lng],
                        [customerLatLng.lat, customerLatLng.lng]
                    );
                    
                    driverMap.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }

        // Draw route on main map
        function drawRoute(startLat, startLng, endLat, endLng) {
            if (routePolyline) {
                driverMap.removeLayer(routePolyline);
            }
            
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(driverMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(driverMap);
                });
        }

        // Update ride action button based on ride status
        function updateRideActionButton(action) {
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            holdProgress = 0;
            const holdButtonFill = document.getElementById('holdButtonFill');
            if (holdButtonFill) {
                holdButtonFill.style.width = '0%';
            }
            
            switch(action) {
                case 'hold-to-start':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-play-circle" style="color: #000000;"></i>
                        <span>Hold to Start Ride</span>
                    `;
                    break;
                case 'hold-to-arrive':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-map-marker-alt" style="color: #000000;"></i>
                        <span>Hold to Arrive</span>
                    `;
                    break;
                case 'hold-to-pickup':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-user-check" style="color: #000000;"></i>
                        <span>Hold to Pickup</span>
                    `;
                    break;
                case 'hold-to-complete':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-flag-checkered" style="color: #000000;"></i>
                        <span>Hold to Complete</span>
                    `;
                    break;
            }
        }

        // Start hold timer for ride actions
        function startHoldTimer() {
            if (holdTimer) return;
            
            const holdButtonContent = document.getElementById('holdButtonContent');
            holdButtonContent.classList.add('active');
            
            holdTimer = setInterval(() => {
                holdProgress += 3.33;
                const holdButtonFill = document.getElementById('holdButtonFill');
                
                if (holdButtonFill) {
                    holdButtonFill.style.width = `${holdProgress}%`;
                }
                
                if (holdProgress >= 100) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                    completeHoldAction();
                }
            }, 100);
        }

        // Cancel hold timer
        function cancelHoldTimer() {
            if (holdTimer) {
                clearInterval(holdTimer);
                holdTimer = null;
                holdProgress = 0;
                
                const holdButtonContent = document.getElementById('holdButtonContent');
                holdButtonContent.classList.remove('active');
                
                const holdButtonFill = document.getElementById('holdButtonFill');
                if (holdButtonFill) {
                    holdButtonFill.style.width = '0%';
                }
            }
        }

        // Complete hold action based on current ride state
        function completeHoldAction() {
            if (!currentRide) return;
            
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            if (holdButtonContent.innerHTML.includes('Start Ride')) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'started',
                    startedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide.status = 'started';
                    updateRideActionButton('hold-to-arrive');
                    showNotification('Ride started. Heading to pickup location.');
                    
                    if (driverMarker) {
                        const driverLatLng = driverMarker.getLatLng();
                        drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.destLat, currentRide.destLng);
                    }
                });
            } else if (holdButtonContent.innerHTML.includes('Arrive')) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'arrived',
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide.status = 'arrived';
                    updateRideActionButton('hold-to-pickup');
                    showNotification('Arrival marked. Waiting for passenger.');
                });
            } else if (holdButtonContent.innerHTML.includes('Pickup')) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'picked_up',
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide.status = 'picked_up';
                    updateRideActionButton('hold-to-complete');
                    showNotification('Passenger picked up. Starting trip.');
                    
                    document.getElementById('driverName').textContent = document.getElementById('driverNameInput').value || 'Driver Name';
                    document.getElementById('driverPhone').textContent = document.getElementById('driverPhoneInput').value || '000-000-0000';
                    document.getElementById('vehicleDetails').textContent = 
                        `${document.getElementById('vehicleTypeInput').value || 'Vehicle'} - ${document.getElementById('licensePlateInput').value || 'ABC123'}`;
                });
            } else if (holdButtonContent.innerHTML.includes('Complete')) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    const totalFare = currentRide.fare || calculateTotalFare(currentRide);
                    const commission = totalFare * commissionRate;
                    const driverEarnings = totalFare - commission;
                    
                    const newWalletBalance = walletBalance + driverEarnings;
                    updateWalletBalance(newWalletBalance);
                    
                    const newFloatBalance = floatBalance - commission;
                    updateFloatBalance(newFloatBalance);
                    
                    updateDriverStatsAfterRide(totalFare, driverEarnings);
                    
                    const earningsData = {
                        rideId: currentRide.id,
                        amount: driverEarnings,
                        commission: commission,
                        totalFare: totalFare,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        passengerName: currentRide.passengerName,
                        distance: currentRide.distance
                    };
                    
                    database.ref('earnings/' + currentUser.uid).push(earningsData)
                        .then(() => {
                            showNotification(`Ride completed! K${driverEarnings.toFixed(2)} added to your wallet. K${commission.toFixed(2)} commission deducted from float.`);
                            
                            currentRide = null;
                            document.getElementById('rideActionBtn').style.display = 'none';
                            document.getElementById('advancedFeatures').style.display = 'none';
                            
                            hideSOSButton();
                            
                            if (passengerMessageListener) {
                                passengerMessageListener();
                                passengerMessageListener = null;
                            }
                            
                            if (customerMarker) {
                                driverMap.removeLayer(customerMarker);
                                customerMarker = null;
                            }
                            if (destinationMarker) {
                                driverMap.removeLayer(destinationMarker);
                                destinationMarker = null;
                            }
                            if (routePolyline) {
                                driverMap.removeLayer(routePolyline);
                                routePolyline = null;
                            }
                            
                            if (document.getElementById('driverChatPopup') && !document.getElementById('driverChatPopup').classList.contains('hidden')) {
                                closeDriverChatPopup();
                            }
                            
                            updateRideQueueDisplay();
                        });
                });
            }
        }

        // Update driver statistics after completing a ride
        function updateDriverStatsAfterRide(totalFare, driverEarnings) {
            if (!currentUser) return;
            
            database.ref('users/' + currentUser.uid + '/stats').once('value')
                .then(snapshot => {
                    const stats = snapshot.val() || {};
                    const totalTrips = (stats.totalTrips || 0) + 1;
                    const totalEarnings = (stats.totalEarnings || 0) + driverEarnings;
                    
                    const newRating = calculateNewRating(stats.rating || 0, totalTrips);
                    
                    driverStats.totalTrips = totalTrips;
                    driverStats.totalEarnings = totalEarnings;
                    driverStats.rating = newRating;
                    
                    return database.ref('users/' + currentUser.uid + '/stats').update({
                        totalTrips: totalTrips,
                        totalEarnings: totalEarnings,
                        rating: newRating
                    });
                })
                .then(() => {
                    document.getElementById('totalTrips').textContent = totalTrips;
                    document.getElementById('ratingScore').textContent = newRating.toFixed(1);
                    document.getElementById('completedRides').textContent = totalTrips;
                    document.getElementById('totalEarnings').textContent = `K${totalEarnings.toFixed(2)}`;
                    document.getElementById('driverRating').textContent = newRating.toFixed(1) + ' ';
                })
                .catch(error => {
                    console.error('Error updating driver stats:', error);
                });
        }

        // Calculate new rating (simplified)
        function calculateNewRating(currentRating, totalTrips) {
            const ratingChange = (Math.random() - 0.5) * 0.2;
            let newRating = currentRating + ratingChange;
            
            newRating = Math.max(3.5, Math.min(5.0, newRating));
            
            return newRating;
        }

        // Calculate total fare for a ride
        function calculateTotalFare(ride) {
            const baseFare = ride.fare || 15;
            const discount = ride.promoCode ? baseFare * 0.2 : 0;
            return baseFare - discount;
        }

        // Update float balance
        function updateFloatBalance(newBalance) {
            floatBalance = newBalance;
            
            document.getElementById('floatBalanceDisplay').textContent = `K${floatBalance.toFixed(2)}`;
            document.getElementById('floatBalance').textContent = `K${floatBalance.toFixed(2)}`;
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    floatBalance: floatBalance
                });
            }
            
            if (floatBalance < 10) {
                showNoFloatWarning();
                
                if (isOnline) {
                    document.getElementById('onlineToggleCheckbox').checked = false;
                    toggleOnlineStatus();
                }
            }
        }

        // Update wallet balance
        function updateWalletBalance(newBalance) {
            walletBalance = newBalance;
            
            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: walletBalance
                });
            }
        }

        // Show no float warning
        function showNoFloatWarning() {
            if (document.querySelector('.no-float-warning')) {
                return;
            }
            
            const warning = document.createElement('div');
            warning.className = 'no-float-warning';
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Your float balance is below minimum K10.00. You cannot receive ride requests until you add float.
            `;
            
            const accountScreen = document.getElementById('accountScreen');
            const firstChild = accountScreen.firstChild;
            accountScreen.insertBefore(warning, firstChild);
        }

        // Add float to account
        function addFloat() {
            const amount = prompt('Enter amount to add to your float (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = floatBalance + addAmount;
                
                updateFloatBalance(newBalance);
                addFloatHistoryEntry('deposit', addAmount, 'Float deposit');
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your float.`);
                
                if (newBalance >= 10) {
                    const warning = document.querySelector('.no-float-warning');
                    if (warning) {
                        warning.remove();
                    }
                }
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }

        // Adjust float (withdraw)
        function adjustFloat() {
            if (floatBalance <= 0) {
                showNotification('Your float balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw from float (K). Available: K${floatBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > floatBalance) {
                    showNotification('Insufficient float balance for this withdrawal.');
                    return;
                }
                
                const newBalance = floatBalance - withdrawAmount;
                updateFloatBalance(newBalance);
                
                addFloatHistoryEntry('withdrawal', -withdrawAmount, 'Float withdrawal');
                showNotification(`Float withdrawal of K${withdrawAmount.toFixed(2)} processed.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }

        // Add float history entry
        function addFloatHistoryEntry(type, amount, description) {
            const historyEntry = {
                type: type,
                amount: amount,
                description: description,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                balance: floatBalance
            };
            
            floatHistory.unshift(historyEntry);
            
            if (currentUser) {
                database.ref('floatHistory/' + currentUser.uid).push(historyEntry);
            }
            
            updateFloatHistoryDisplay();
        }

        // Load float history
        function loadFloatHistory() {
            if (currentUser) {
                database.ref('floatHistory/' + currentUser.uid).orderByChild('timestamp').limitToLast(10).once('value')
                    .then(snapshot => {
                        const history = snapshot.val();
                        floatHistory = [];
                        
                        if (history) {
                            Object.keys(history).forEach(key => {
                                floatHistory.unshift({
                                    id: key,
                                    ...history[key]
                                });
                            });
                        }
                        
                        updateFloatHistoryDisplay();
                    })
                    .catch(error => {
                        console.error('Error loading float history:', error);
                    });
            }
        }

        // Update float history display
        function updateFloatHistoryDisplay() {
            const floatHistoryList = document.getElementById('floatHistoryList');
            floatHistoryList.innerHTML = '';
            
            if (floatHistory.length > 0) {
                floatHistory.forEach(entry => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'float-history-item';
                    
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const amountClass = entry.amount > 0 ? 'positive' : 'negative';
                    const amountSign = entry.amount > 0 ? '+' : '';
                    
                    historyItem.innerHTML = `
                        <div>
                            <div>${entry.description}</div>
                            <div style="font-size: 0.6rem; color: var(--medium-gray);">${formattedDate} ${formattedTime}</div>
                        </div>
                        <div class="float-amount ${amountClass}">${amountSign}K${Math.abs(entry.amount).toFixed(2)}</div>
                    `;
                    
                    floatHistoryList.appendChild(historyItem);
                });
            } else {
                floatHistoryList.innerHTML = '<p style="text-align: center; padding: 10px; color: var(--medium-gray);">No float history found.</p>';
            }
        }

        // Load driver data
        function loadDriverData() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            document.getElementById('driverNameInput').value = userData.name || '';
                            document.getElementById('driverPhoneInput').value = userData.phone || '';
                            document.getElementById('driverEmailInput').value = userData.email || '';
                            
                            if (userData.vehicle) {
                                selectedVehicleType = userData.vehicle.type;
                                document.getElementById('vehicleTypeInput').value = userData.vehicle.type || '';
                                document.getElementById('vehicleModelInput').value = userData.vehicle.model || '';
                                document.getElementById('licensePlateInput').value = userData.vehicle.licensePlate || '';
                                document.getElementById('vehicleColorInput').value = userData.vehicle.color || '';
                                
                                updateVehicleIcon(userData.vehicle.type);
                            }
                            
                            document.getElementById('driverName').textContent = userData.name || 'Driver Name';
                            document.getElementById('driverPhone').textContent = userData.phone || '000-000-0000';
                            document.getElementById('vehicleDetails').textContent = 
                                `${userData.vehicle?.type || 'Vehicle'} - ${userData.vehicle?.licensePlate || 'ABC123'}`;
                            
                            walletBalance = userData.walletBalance || 0;
                            floatBalance = userData.floatBalance || 0;
                            
                            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            document.getElementById('floatBalanceDisplay').textContent = `K${floatBalance.toFixed(2)}`;
                            document.getElementById('floatBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            
                            if (userData.stats) {
                                driverStats = { ...driverStats, ...userData.stats };
                                updatePerformanceStats();
                            }
                            
                            updateDriverAvatar(userData.images);
                            
                            if (floatBalance < 10) {
                                showNoFloatWarning();
                            }
                            
                            if (userData.isOnline) {
                                document.getElementById('onlineToggleCheckbox').checked = true;
                                toggleOnlineStatus();
                            }
                        }
                    });
                
                loadFloatHistory();
            }
        }

        // Update vehicle icon based on vehicle type
        function updateVehicleIcon(vehicleType) {
            const vehicleIcon = document.getElementById('vehicleIcon');
            const accountVehicleIcon = document.getElementById('accountVehicleIcon');
            
            switch(vehicleType) {
                case 'car':
                    vehicleIcon.className = 'fas fa-car';
                    accountVehicleIcon.className = 'fas fa-car';
                    break;
                case 'bike':
                    vehicleIcon.className = 'fas fa-motorcycle';
                    accountVehicleIcon.className = 'fas fa-motorcycle';
                    break;
                case 'bicycle':
                    vehicleIcon.className = 'fas fa-bicycle';
                    accountVehicleIcon.className = 'fas fa-bicycle';
                    break;
                default:
                    vehicleIcon.className = 'fas fa-car';
                    accountVehicleIcon.className = 'fas fa-car';
            }
        }

        // Update driver avatar with profile image
        function updateDriverAvatar(images) {
            const driverAvatar = document.getElementById('driverAvatar');
            const driverProfileImage = document.getElementById('driverProfileImage');
            const driverDefaultIcon = document.getElementById('driverDefaultIcon');
            const driverName = document.getElementById('driverNameInput').value;
            
            if (images && images.profilePhoto) {
                driverProfileImage.src = images.profilePhoto;
                driverProfileImage.style.display = 'block';
                driverDefaultIcon.style.display = 'none';
            } else if (driverName) {
                driverDefaultIcon.textContent = driverName.charAt(0).toUpperCase();
                driverProfileImage.style.display = 'none';
                driverDefaultIcon.style.display = 'flex';
            } else {
                driverDefaultIcon.innerHTML = '<i class="fas fa-user"></i>';
                driverProfileImage.style.display = 'none';
                driverDefaultIcon.style.display = 'flex';
            }
        }

        // Add funds to wallet
        function addFunds() {
            const amount = prompt('Enter amount to add to your wallet (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = walletBalance + addAmount;
                
                updateWalletBalance(newBalance);
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your wallet.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }

        // Withdraw funds from wallet
        function withdrawFunds() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawAmount;
                updateWalletBalance(newBalance);
                showNotification(`Withdrawal request submitted. K${withdrawAmount.toFixed(2)} will be processed within 24 hours.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }

        // Load driver statistics with REAL data
        function loadDriverStats() {
            if (!currentUser) return;
            
            database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    let completed = 0;
                    let cancelled = 0;
                    let totalEarnings = 0;
                    
                    if (rides) {
                        Object.values(rides).forEach(ride => {
                            if (ride.status === 'completed') {
                                completed++;
                                totalEarnings += ride.fare || 0;
                            } else if (ride.status === 'cancelled') {
                                cancelled++;
                            }
                        });
                    }
                    
                    document.getElementById('completedRides').textContent = completed;
                    document.getElementById('cancelledRides').textContent = cancelled;
                    document.getElementById('totalEarnings').textContent = `K${totalEarnings.toFixed(2)}`;
                    
                    driverStats.totalTrips = completed;
                    driverStats.totalEarnings = totalEarnings;
                });
        }

        // MODIFICATION #1: Enhanced load ride history with chat functionality
        function loadRideHistory() {
            if (currentUser) {
                database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                    .then(snapshot => {
                        const historyList = document.getElementById('historyList');
                        historyList.innerHTML = '';
                        
                        const rides = snapshot.val();
                        if (rides) {
                            const ridesArray = Object.keys(rides).map(rideId => ({
                                id: rideId,
                                ...rides[rideId]
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            
                            ridesArray.forEach(ride => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                historyItem.dataset.rideId = ride.id; // Store ride ID for chat
                                
                                const date = new Date(ride.timestamp);
                                const formattedDate = date.toLocaleDateString();
                                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                let packageDetailsHTML = '';
                                if (ride.packageDetails) {
                                    packageDetailsHTML = `
                                        <div class="history-details-grid">
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Receiver Name</span>
                                                <span class="history-detail-value">${ride.packageDetails.receiverName || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Receiver Phone</span>
                                                <span class="history-detail-value">${ride.packageDetails.receiverPhone || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Package Description</span>
                                                <span class="history-detail-value">${ride.packageDetails.packageDescription || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Package Value</span>
                                                <span class="history-detail-value">${ride.packageDetails.packageValue ? 'K' + ride.packageDetails.packageValue : 'N/A'}</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                let orderForSomeoneHTML = '';
                                if (ride.orderForSomeone) {
                                    orderForSomeoneHTML = `
                                        <div class="history-details-grid">
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Order Type</span>
                                                <span class="history-detail-value">Order for Someone Else</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Recipient</span>
                                                <span class="history-detail-value">${ride.orderForSomeone.recipientName || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Recipient Phone</span>
                                                <span class="history-detail-value">${ride.orderForSomeone.recipientPhone || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Ordered By</span>
                                                <span class="history-detail-value">${ride.orderForSomeone.orderedBy || 'N/A'}</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                let expressDeliveryHTML = '';
                                if (ride.expressDelivery) {
                                    expressDeliveryHTML = `
                                        <div class="history-details-grid">
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Delivery Type</span>
                                                <span class="history-detail-value">Express Delivery</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Shop Name</span>
                                                <span class="history-detail-value">${ride.expressDelivery.shopName || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Items</span>
                                                <span class="history-detail-value">${ride.expressDelivery.items || 'N/A'}</span>
                                            </div>
                                            <div class="history-detail-item">
                                                <span class="history-detail-label">Amount</span>
                                                <span class="history-detail-value">${ride.expressDelivery.amount ? 'K' + ride.expressDelivery.amount : 'N/A'}</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // Add chat button to history item
                                const hasChat = ride.hasChat || false;
                                const chatButtonHTML = hasChat ? 
                                    `<button class="view-chat-btn" data-ride-id="${ride.id}" style="background: var(--primary-orange); color: white; border: none; border-radius: var(--element-radius); padding: 5px 10px; font-size: 0.7rem; cursor: pointer; margin-top: 8px; display: flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-comments"></i> View Chat
                                    </button>` : '';
                                
                                historyItem.innerHTML = `
                                    <div class="history-locations">
                                        <div>
                                            <strong>From:</strong> ${ride.pickupDisplayLocation || ride.pickupLocation}
                                        </div>
                                        <div>
                                            <strong>To:</strong> ${ride.destination}
                                        </div>
                                    </div>
                                    <div class="history-details-grid">
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Customer</span>
                                            <span class="history-detail-value">${ride.passengerName || 'N/A'}</span>
                                        </div>
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Phone</span>
                                            <span class="history-detail-value">${ride.passengerPhone || 'N/A'}</span>
                                        </div>
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Date</span>
                                            <span class="history-detail-value">${formattedDate}</span>
                                        </div>
                                        <div class="history-detail-item">
                                            <span class="history-detail-label">Time</span>
                                            <span class="history-detail-value">${formattedTime}</span>
                                        </div>
                                    </div>
                                    ${packageDetailsHTML}
                                    ${orderForSomeoneHTML}
                                    ${expressDeliveryHTML}
                                    <div class="history-info">
                                        <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                        <div class="status-badge ${ride.status === 'completed' ? 'status-completed' : 'status-cancelled'}">
                                            ${ride.status === 'completed' ? 'Completed' : 'Cancelled'}
                                        </div>
                                    </div>
                                    ${chatButtonHTML}
                                `;
                                
                                historyList.appendChild(historyItem);
                            });
                            
                            // Add event listeners to chat buttons
                            document.querySelectorAll('.view-chat-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const rideId = this.getAttribute('data-ride-id');
                                    openRideHistoryChat(rideId);
                                });
                            });
                            
                            // Add click event to history items for chat opening
                            document.querySelectorAll('.history-item').forEach(item => {
                                item.addEventListener('click', function(e) {
                                    // Only trigger if not clicking on the chat button
                                    if (!e.target.closest('.view-chat-btn')) {
                                        const rideId = this.dataset.rideId;
                                        openRideHistoryChat(rideId);
                                    }
                                });
                            });
                        } else {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ride history:', error);
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                    });
            }
        }

        // MODIFICATION #1: Open chat from ride history
        function openRideHistoryChat(rideId) {
            // Load ride details first
            database.ref('rides/' + rideId).once('value')
                .then(snapshot => {
                    const ride = snapshot.val();
                    if (!ride) {
                        showNotification('Ride details not found.');
                        return;
                    }
                    
                    // Create or show chat popup
                    if (!document.getElementById('rideHistoryChatPopup')) {
                        createRideHistoryChatPopup();
                    }
                    
                    currentChatRideId = rideId;
                    
                    // Set passenger info
                    document.getElementById('historyChatPassengerName').textContent = ride.passengerName || 'Passenger';
                    document.getElementById('historyChatPassengerRating').textContent = ride.passengerRating ? `${ride.passengerRating} ` : '4.5 ';
                    
                    // Show chat popup
                    document.getElementById('rideHistoryChatPopup').classList.remove('hidden');
                    
                    // Load chat messages
                    loadRideHistoryChatMessages(rideId);
                    
                    // Start listening for new messages in history chat
                    startRideHistoryChatListener(rideId);
                })
                .catch(error => {
                    console.error('Error loading ride details:', error);
                    showNotification('Error loading ride details.');
                });
        }

        // MODIFICATION #1: Create ride history chat popup
        function createRideHistoryChatPopup() {
            const chatPopup = document.createElement('div');
            chatPopup.id = 'rideHistoryChatPopup';
            chatPopup.className = 'popup-overlay hidden';
            chatPopup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 15px;
            `;
            
            chatPopup.innerHTML = `
                <div class="popup-form" style="max-width: 400px; height: 500px; display: flex; flex-direction: column; background: white; border-radius: 8px; overflow: hidden;">
                    <div class="popup-header" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border-color);">
                        <h2 class="popup-title" style="font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-history"></i>
                            Past Ride Chat
                        </h2>
                        <button class="close-chat-btn" id="closeRideHistoryChatPopup">&times;</button>
                    </div>
                    <div class="chat-passenger-info" style="padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="passenger-avatar" id="historyChatPassengerAvatar" style="width: 30px; height: 30px; border-radius: 50%; background: var(--light-gray); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: var(--medium-gray);">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; font-size: 0.9rem;" id="historyChatPassengerName">Passenger</div>
                                <div style="font-size: 0.7rem; color: var(--medium-gray);" id="historyChatPassengerRating">4.5 </div>
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--medium-gray); margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> This is a read-only view of past chat history
                        </div>
                    </div>
                    <div class="chat-messages" id="rideHistoryChatMessages" style="flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px;"></div>
                </div>
            `;
            
            document.body.appendChild(chatPopup);
            
            document.getElementById('closeRideHistoryChatPopup').addEventListener('click', function() {
                closeRideHistoryChatPopup();
            });
        }

        // MODIFICATION #1: Load chat messages for ride history
        function loadRideHistoryChatMessages(rideId) {
            const chatMessages = document.getElementById('rideHistoryChatMessages');
            chatMessages.innerHTML = '<div class="loading-text">Loading chat history...</div>';
            
            database.ref('chats/' + rideId).orderByChild('timestamp').once('value')
                .then(snapshot => {
                    const messages = snapshot.val();
                    chatMessages.innerHTML = '';
                    
                    if (messages) {
                        const messagesArray = Object.values(messages);
                        messagesArray.forEach(message => {
                            displayRideHistoryChatMessage(message);
                        });
                        
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--medium-gray);">No chat history found for this ride.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading chat history:', error);
                    chatMessages.innerHTML = '<div class="no-places" style="text-align: center; padding: 20px; color: var(--error-red);">Error loading chat history.</div>';
                });
        }

        // MODIFICATION #1: Display chat message in ride history
        function displayRideHistoryChatMessage(message) {
            const chatMessages = document.getElementById('rideHistoryChatMessages');
            
            if (chatMessages.querySelector('.loading-text') || chatMessages.querySelector('.no-places')) {
                chatMessages.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${message.senderId === currentUser.uid ? 'own-message' : 'other-message'}`;
            messageElement.style.cssText = `
                max-width: 80%;
                padding: 8px 12px;
                border-radius: 15px;
                margin-bottom: 5px;
                word-wrap: break-word;
                ${message.senderId === currentUser.uid ? 
                    'background: var(--primary-orange); color: white; align-self: flex-end;' : 
                    'background: var(--light-gray); color: var(--dark-gray); align-self: flex-start;'
                }
            `;
            
            const timestamp = new Date(message.timestamp);
            const timeString = timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const dateString = timestamp.toLocaleDateString();
            
            messageElement.innerHTML = `
                <div style="font-size: 0.7rem; font-weight: 600; margin-bottom: 2px;">${message.senderName || 'Unknown'}</div>
                <div style="font-size: 0.8rem;">${message.message}</div>
                <div style="font-size: 0.6rem; opacity: 0.7; text-align: ${message.senderId === currentUser.uid ? 'right' : 'left'}; margin-top: 4px;">${dateString} ${timeString}</div>
            `;
            
            chatMessages.appendChild(messageElement);
        }

        // MODIFICATION #1: Start listener for ride history chat
        function startRideHistoryChatListener(rideId) {
            // Remove existing listener for this ride
            if (rideHistoryChatListeners[rideId]) {
                rideHistoryChatListeners[rideId]();
                delete rideHistoryChatListeners[rideId];
            }
            
            // Listen for new messages (though unlikely for completed rides)
            const listener = database.ref('chats/' + rideId).orderByChild('timestamp').on('child_added', snapshot => {
                const message = snapshot.val();
                displayRideHistoryChatMessage(message);
                
                const chatMessages = document.getElementById('rideHistoryChatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
            
            rideHistoryChatListeners[rideId] = listener;
        }

        // MODIFICATION #1: Close ride history chat popup
        function closeRideHistoryChatPopup() {
            document.getElementById('rideHistoryChatPopup').classList.add('hidden');
            
            // Remove all ride history chat listeners
            Object.values(rideHistoryChatListeners).forEach(listener => {
                if (listener) listener();
            });
            rideHistoryChatListeners = {};
            
            currentChatRideId = null;
        }

        // Load earnings with REAL data from Firebase
        function loadEarnings() {
            if (currentUser) {
                database.ref('earnings/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const earnings = snapshot.val();
                        let total = 0;
                        let ridesCompleted = 0;
                        let onlineHours = 0;
                        let totalCommission = 0;
                        
                        if (earnings) {
                            const now = new Date();
                            
                            Object.keys(earnings).forEach(earningId => {
                                const earning = earnings[earningId];
                                const earningDate = new Date(earning.timestamp);
                                
                                let include = false;
                                
                                switch(earningsPeriod) {
                                    case 'today':
                                        if (earningDate.toDateString() === now.toDateString()) {
                                            include = true;
                                        }
                                        break;
                                    case 'week':
                                        const startOfWeek = new Date(now);
                                        startOfWeek.setDate(now.getDate() - now.getDay());
                                        startOfWeek.setHours(0, 0, 0, 0);
                                        
                                        if (earningDate >= startOfWeek) {
                                            include = true;
                                        }
                                        break;
                                    case 'month':
                                        if (earningDate.getMonth() === now.getMonth() && 
                                            earningDate.getFullYear() === now.getFullYear()) {
                                            include = true;
                                        }
                                        break;
                                }
                                
                                if (include) {
                                    total += earning.amount || 0;
                                    totalCommission += earning.commission || 0;
                                    ridesCompleted++;
                                }
                            });
                            
                            onlineHours = Math.floor((driverStats.totalOnlineTime || 0) / 60);
                        }
                        
                        document.getElementById('earningsTotal').textContent = `K${total.toFixed(2)}`;
                        document.getElementById('ridesCompleted').textContent = ridesCompleted;
                        document.getElementById('avgEarning').textContent = ridesCompleted > 0 ? `K${(total / ridesCompleted).toFixed(2)}` : 'K0.00';
                        document.getElementById('onlineHours').textContent = `${onlineHours}h`;
                        
                        updateEarningsList(earnings);
                    })
                    .catch(error => {
                        console.error('Error loading earnings:', error);
                        document.getElementById('earningsTotal').textContent = 'K0.00';
                        document.getElementById('ridesCompleted').textContent = '0';
                        document.getElementById('avgEarning').textContent = 'K0.00';
                        document.getElementById('onlineHours').textContent = '0h';
                    });
            }
        }

        // Update earnings list
        function updateEarningsList(earnings) {
            const earningsList = document.getElementById('earningsList');
            earningsList.innerHTML = '';
            
            if (earnings) {
                const earningsArray = Object.keys(earnings).map(earningId => ({
                    id: earningId,
                    ...earnings[earningId]
                })).sort((a, b) => b.timestamp - a.timestamp)
                  .slice(0, 10);
                
                earningsArray.forEach(earning => {
                    const earningItem = document.createElement('div');
                    earningItem.className = 'history-item';
                    
                    const date = new Date(earning.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    earningItem.innerHTML = `
                        <div class="history-locations">
                            <div>
                                <strong>Ride Earnings</strong>
                            </div>
                            <div>
                                <strong>K${earning.amount ? earning.amount.toFixed(2) : '0.00'}</strong>
                            </div>
                        </div>
                        <div class="commission-display">
                            <span class="commission-label">Commission (8%):</span>
                            <span class="commission-value commission-deduction">-K${earning.commission ? earning.commission.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="balance-update">
                            <span class="balance-label-update">Total Fare:</span>
                            <span class="balance-value-update">K${earning.totalFare ? earning.totalFare.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="history-info">
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge status-completed">Completed</div>
                        </div>
                    `;
                    
                    earningsList.appendChild(earningItem);
                });
            } else {
                earningsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No earnings found for this period.</p>';
            }
        }

        // Withdraw earnings
        function withdrawEarnings() {
            showNotification('Withdrawal request submitted. Funds will be processed within 24 hours.');
        }

        // Advanced features

        // MODIFICATION #4: Contact customer - Open dialer with customer number
        function contactCustomer() {
            if (currentRide) {
                const phoneNumber = currentRide.passengerPhone;
                if (phoneNumber) {
                    // MODIFICATION #4: Open device dialer with customer number
                    const cleanPhoneNumber = phoneNumber.replace(/\D/g, '');
                    const telUrl = `tel:${cleanPhoneNumber}`;
                    
                    // Create a temporary link to trigger phone dialer
                    const link = document.createElement('a');
                    link.href = telUrl;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification(`Opening dialer for customer: ${phoneNumber}`);
                } else {
                    showNotification('Customer phone number not available.');
                }
            }
        }

        // Navigate to pickup
        function navigateToPickup() {
            if (currentRide && customerMarker) {
                const customerLatLng = customerMarker.getLatLng();
                showNotification(`Opening navigation to pickup location: ${currentRide.pickupLocation}`);
                driverMap.setView(customerLatLng, 16);
            }
        }

        // View route details
        function viewRouteDetails() {
            if (currentRide) {
                showNotification(`Showing route details for trip to ${currentRide.destination}`);
            }
        }

        // Quick actions

        // Center map on driver location
        function centerMap() {
            if (driverMarker) {
                const driverLatLng = driverMarker.getLatLng();
                driverMap.setView(driverLatLng, 16);
                showNotification('Map centered on your location');
            }
        }

        // Refresh driver position
        function refreshDriverPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    driverMap.setView([lat, lng], 16);
                    
                    if (driverMarker) {
                        driverMarker.setLatLng([lat, lng]);
                    }
                    
                    updateDriverLocation(lat, lng);
                    
                    showNotification('Location refreshed');
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to refresh location. Please enable location services.');
                });
            }
        }

        // Toggle traffic layer
        function toggleTraffic() {
            if (trafficEnabled) {
                if (trafficLayer) {
                    driverMap.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
                trafficEnabled = false;
                showNotification('Traffic layer disabled');
            } else {
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(driverMap);
                trafficEnabled = true;
                showNotification('Traffic layer enabled');
            }
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const 1 = lat1 * Math.PI / 180;
            const 2 = lat2 * Math.PI / 180;
            const  = (lat2 - lat1) * Math.PI / 180;
            const  = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(/2) * Math.sin(/2) +
                      Math.cos(1) * Math.cos(2) *
                      Math.sin(/2) * Math.sin(/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                auth.signOut().then(() => {
                    showNotification('Logged out successfully');
                    currentUser = null;
                    currentRide = null;
                    isOnline = false;
                    floatBalance = 0;
                    walletBalance = 0;
                    driverStats = {
                        totalTrips: 0,
                        totalEarnings: 0,
                        totalOnlineTime: 0,
                        acceptanceRate: 0,
                        rating: 0,
                        currentSessionStart: null,
                        currentSessionTime: 0
                    };
                    
                    stopLocationTracking();
                    stopRideRequestSound();
                    
                    if (rideQueueListener) {
                        rideQueueListener();
                        rideQueueListener = null;
                    }
                    
                    if (chatListener) {
                        chatListener();
                        chatListener = null;
                    }
                    
                    if (passengerMessageListener) {
                        passengerMessageListener();
                        passengerMessageListener = null;
                    }
                    
                    hideSOSButton();
                    
                    Object.values(rideHistoryChatListeners).forEach(listener => {
                        if (listener) listener();
                    });
                    rideHistoryChatListeners = {};
                    
                    document.getElementById('mainApp').style.display = 'none';
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    
                    document.querySelectorAll('.screen-content').forEach(screen => {
                        screen.classList.remove('active');
                    });
                    
                    document.querySelectorAll('.nav-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector('.nav-btn[data-screen="home"]').classList.add('active');
                }).catch((error) => {
                    console.error('Logout error:', error);
                    showNotification('Error logging out');
                });
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // NEW: Enhanced ride completion with type-specific handling
        function completeRideWithTypeSpecificHandling() {
            if (!currentRide) return;
            
            let completionMessage = 'Ride completed successfully!';
            
            if (currentRide.rideType === 'bike' || currentRide.rideType === 'bicycle') {
                if (currentRide.packageDetails) {
                    completionMessage = `Delivery completed! Package delivered to ${currentRide.packageDetails.receiverName || 'recipient'}.`;
                } else {
                    completionMessage = 'Express delivery completed successfully!';
                }
            } else if (currentRide.orderForSomeone) {
                completionMessage = `Ride completed for ${currentRide.orderForSomeone.recipientName}! Order fulfilled successfully.`;
            } else if (currentRide.expressDelivery) {
                completionMessage = `Express delivery from ${currentRide.expressDelivery.shopName} completed!`;
            }
            
            showNotification(completionMessage);
        }

        // NEW: Enhanced driver analytics
        function trackDriverAnalytics(ride) {
            if (!currentUser) return;
            
            const analyticsData = {
                rideId: ride.id,
                rideType: ride.rideType,
                fare: ride.fare,
                distance: ride.distance,
                duration: ride.duration || 'N/A',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                hasPackage: !!ride.packageDetails,
                isOrderForSomeone: !!ride.orderForSomeone,
                isExpressDelivery: !!ride.expressDelivery,
                city: ride.currentCity || 'Unknown'
            };
            
            database.ref('driverAnalytics/' + currentUser.uid).push(analyticsData)
                .catch(error => {
                    console.error('Error tracking analytics:', error);
                });
        }

        // NEW: Enhanced performance metrics
        function updateEnhancedPerformanceMetrics() {
            if (!currentUser) return;
            
            const metrics = {
                totalRides: driverStats.totalTrips || 0,
                totalEarnings: driverStats.totalEarnings || 0,
                acceptanceRate: driverStats.acceptanceRate || 0,
                averageRating: driverStats.rating || 0,
                onlineHours: Math.floor((driverStats.totalOnlineTime || 0) / 60),
                completionRate: calculateCompletionRate(),
                averageEarningsPerRide: driverStats.totalTrips > 0 ? (driverStats.totalEarnings / driverStats.totalTrips).toFixed(2) : 0,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref('driverMetrics/' + currentUser.uid).set(metrics)
                .catch(error => {
                    console.error('Error updating enhanced metrics:', error);
                });
        }

        // NEW: Calculate completion rate
        function calculateCompletionRate() {
            if (!currentUser) return 0;
            
            return 95;
        }

        // Initialize enhanced features
        function initializeEnhancedFeatures() {
            setInterval(updateEnhancedPerformanceMetrics, 60000);
            
            const originalCompleteHoldAction = completeHoldAction;
            completeHoldAction = function() {
                if (currentRide && currentRide.status === 'picked_up') {
                    trackDriverAnalytics(currentRide);
                    completeRideWithTypeSpecificHandling();
                }
                originalCompleteHoldAction();
            };
        }

        // Call enhanced features initialization
        initializeEnhancedFeatures();
    </script>
</body>
</html>


