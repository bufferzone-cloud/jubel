<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Driver Registration & Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 12px rgba(255, 107, 53, 0.1);
            --shadow-medium: 0 4px 20px rgba(255, 107, 53, 0.15);
            --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* Registration Screen Styles */
        .registration-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 1000;
            overflow-y: auto;
            padding: var(--app-padding);
            display: flex;
            flex-direction: column;
        }
        
        .registration-header {
            text-align: center;
            margin-bottom: 20px;
            padding-top: 20px;
        }
        
        .registration-logo {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 10px;
        }
        
        .registration-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }
        
        .registration-subtitle {
            color: var(--medium-gray);
            font-size: 0.9rem;
        }
        
        .registration-form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .form-step {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-step.active {
            display: flex;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }
        
        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            background-color: var(--white);
            cursor: pointer;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-hint {
            font-size: 0.75rem;
            color: var(--medium-gray);
            margin-top: 3px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--medium-gray);
            position: relative;
        }
        
        .step.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .step.completed {
            background: var(--success-green);
            color: var(--white);
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 100%;
            width: 40px;
            height: 2px;
            background: var(--border-color);
            transform: translateY(-50%);
        }
        
        .step.completed:not(:last-child)::after {
            background: var(--success-green);
        }
        
        .phone-verification {
            text-align: center;
            padding: 20px 0;
        }
        
        .verification-code {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .code-input {
            width: 40px;
            height: 50px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .code-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .verification-timer {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }
        
        .verification-timer.error {
            color: var(--error-red);
        }
        
        .resend-code {
            margin-top: 15px;
            color: var(--primary-orange);
            cursor: pointer;
            font-weight: 600;
        }
        
        .registration-success {
            text-align: center;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--success-green);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 2rem;
        }
        
        .success-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-gray);
        }
        
        .success-message {
            color: var(--medium-gray);
            max-width: 400px;
            line-height: 1.5;
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            height: 100vh;
            overflow: hidden;
        }
        
        .floating-balance {
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.9rem;
        }
        
        .online-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: 2px solid var(--border-color);
            font-size: 0.8rem;
        }
        
        .online-toggle.active {
            border-color: var(--success-green);
            background: var(--success-green);
            color: var(--white);
        }
        
        .online-toggle.offline {
            border-color: var(--medium-gray);
            background: var(--medium-gray);
            color: var(--white);
        }
        
        .driver-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .driver-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 10px;
            cursor: pointer;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.9rem;
        }
        
        .hold-button-container {
            position: relative;
            width: 100%;
            height: 50px;
            border-radius: var(--element-radius);
            overflow: hidden;
            background: var(--white);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-medium);
            margin-top: 10px;
        }
        
        .hold-button-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: var(--primary-gradient);
            transition: width 0.1s linear;
            z-index: 1;
        }
        
        .hold-button-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            z-index: 2;
            color: var(--dark-gray);
            font-weight: 800;
            font-size: 0.9rem;
        }
        
        .hold-button-content.active {
            color: var(--white);
        }
        
        .ride-request-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--app-padding);
        }
        
        .ride-request-content {
            background: var(--white);
            border-radius: 15px;
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform var(--transition-speed) ease;
            animation: popup-appear 0.3s ease forwards;
        }
        
        @keyframes popup-appear {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .ride-request-map {
            height: 180px;
            width: 100%;
        }
        
        .ride-request-details {
            padding: 12px;
            overflow-y: auto;
        }
        
        .customer-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--medium-gray);
        }
        
        .customer-details h3 {
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .customer-details p {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .trip-details {
            margin-bottom: 12px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .location-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--primary-red);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.75rem;
        }
        
        .fare-details {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            padding-top: 6px;
            margin-top: 6px;
        }
        
        .ride-request-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .btn-accept {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-reject {
            background: var(--error-red);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .back-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        
        .screen-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .earnings-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .balance-label {
            font-size: 0.75rem;
            margin-bottom: 3px;
        }
        
        .balance-amount-large {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 8px;
            font-size: 0.75rem;
        }
        
        .vehicle-details {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .earnings-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .earnings-period {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .period-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .period-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
            border-color: transparent;
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .stat-item {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .earnings-chart {
            height: 120px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        .driver-status-indicator {
            position: fixed;
            top: 60px;
            right: 15px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.online {
            background: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .quick-actions {
            position: fixed;
            bottom: 70px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .collapsible-section {
            margin-bottom: 12px;
        }
        
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-speed) ease;
        }
        
        .collapsible-content.expanded {
            max-height: 500px;
        }
        
        .collapsible-icon {
            transition: transform var(--transition-speed) ease;
        }
        
        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }
        
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .performance-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .performance-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .performance-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .ride-queue {
            margin-top: 12px;
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .queue-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .queue-location {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .queue-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .queue-action {
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--element-radius);
            padding: 5px 10px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .dark-mode-toggle {
            position: fixed;
            bottom: 70px;
            left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            z-index: 100;
        }
        
        .map-controls {
            position: fixed;
            top: 60px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .advanced-features {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .feature-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .feature-btn:hover {
            background: var(--light-orange);
        }
        
        .feature-btn i {
            font-size: 1rem;
            color: var(--primary-orange);
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 480px) {
            .floating-balance, .online-toggle {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .driver-panel {
                padding: 10px;
            }
            
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 6px 3px;
                font-size: 0.6rem;
            }
            
            .ride-request-content {
                max-height: 95vh;
            }
            
            .quick-actions {
                bottom: 65px;
                right: 10px;
            }
            
            .quick-action-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .dark-mode-toggle {
                bottom: 65px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Registration Screen -->
    <div class="registration-container" id="registrationContainer">
        <div class="registration-header">
            <div class="registration-logo">JUBEL</div>
            <h1 class="registration-title">Driver Registration</h1>
            <p class="registration-subtitle">Complete your profile to start driving</p>
        </div>
        
        <div class="step-indicator">
            <div class="step active" id="step1">1</div>
            <div class="step" id="step2">2</div>
            <div class="step" id="step3">3</div>
            <div class="step" id="step4">4</div>
        </div>
        
        <div class="registration-form">
            <!-- Step 1: Personal Information -->
            <div class="form-step active" id="step1Form">
                <h2 class="section-title">Personal Information</h2>
                
                <div class="form-group">
                    <label for="fullName" class="form-label">Full Name</label>
                    <input type="text" id="fullName" class="form-input" placeholder="Enter your full name">
                </div>
                
                <div class="form-group">
                    <label for="phoneNumber" class="form-label">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="form-input" placeholder="Enter your phone number">
                    <div class="form-hint">This will be used for authentication</div>
                </div>
                
                <div class="form-group">
                    <label for="nrcNumber" class="form-label">NRC Number</label>
                    <input type="text" id="nrcNumber" class="form-input" placeholder="Enter your NRC number">
                    <div class="form-hint">Format: 123456/78/9</div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" disabled>Previous</button>
                    <button class="btn btn-primary" id="step1Next">Next</button>
                </div>
            </div>
            
            <!-- Step 2: Vehicle Information -->
            <div class="form-step" id="step2Form">
                <h2 class="section-title">Vehicle Information</h2>
                
                <div class="form-group">
                    <label for="vehicleType" class="form-label">Vehicle Type</label>
                    <select id="vehicleType" class="form-select">
                        <option value="">Select vehicle type</option>
                        <option value="car">Car</option>
                        <option value="suv">SUV</option>
                        <option value="van">Van</option>
                        <option value="motorcycle">Motorcycle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="vehicleMake" class="form-label">Vehicle Make</label>
                    <input type="text" id="vehicleMake" class="form-input" placeholder="e.g. Toyota, Honda">
                </div>
                
                <div class="form-group">
                    <label for="vehicleModel" class="form-label">Vehicle Model</label>
                    <input type="text" id="vehicleModel" class="form-input" placeholder="e.g. Corolla, Civic">
                </div>
                
                <div class="form-group">
                    <label for="vehicleYear" class="form-label">Vehicle Year</label>
                    <input type="number" id="vehicleYear" class="form-input" placeholder="e.g. 2020" min="2000" max="2023">
                </div>
                
                <div class="form-group">
                    <label for="licensePlate" class="form-label">License Plate</label>
                    <input type="text" id="licensePlate" class="form-input" placeholder="e.g. ABC 123">
                </div>
                
                <div class="form-group">
                    <label for="vehicleColor" class="form-label">Vehicle Color</label>
                    <input type="text" id="vehicleColor" class="form-input" placeholder="e.g. Red, Blue">
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="step2Back">Previous</button>
                    <button class="btn btn-primary" id="step2Next">Next</button>
                </div>
            </div>
            
            <!-- Step 3: Payment Information -->
            <div class="form-step" id="step3Form">
                <h2 class="section-title">Payment Information</h2>
                
                <div class="form-group">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select id="paymentMethod" class="form-select">
                        <option value="">Select payment method</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="mobile">Mobile Money</option>
                    </select>
                </div>
                
                <div class="form-group" id="bankDetails" style="display: none;">
                    <label for="bankName" class="form-label">Bank Name</label>
                    <input type="text" id="bankName" class="form-input" placeholder="Enter bank name">
                    
                    <label for="accountNumber" class="form-label">Account Number</label>
                    <input type="text" id="accountNumber" class="form-input" placeholder="Enter account number">
                    
                    <label for="accountName" class="form-label">Account Name</label>
                    <input type="text" id="accountName" class="form-input" placeholder="Enter account holder name">
                </div>
                
                <div class="form-group" id="mobileMoneyDetails" style="display: none;">
                    <label for="mobileProvider" class="form-label">Mobile Provider</label>
                    <select id="mobileProvider" class="form-select">
                        <option value="">Select provider</option>
                        <option value="mtn">MTN</option>
                        <option value="airtel">Airtel</option>
                        <option value="zamtel">Zamtel</option>
                    </select>
                    
                    <label for="mobileNumber" class="form-label">Mobile Number</label>
                    <input type="tel" id="mobileNumber" class="form-input" placeholder="Enter mobile number">
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="step3Back">Previous</button>
                    <button class="btn btn-primary" id="step3Next">Next</button>
                </div>
            </div>
            
            <!-- Step 4: Phone Verification -->
            <div class="form-step" id="step4Form">
                <h2 class="section-title">Phone Verification</h2>
                
                <div class="phone-verification">
                    <p>We've sent a verification code to your phone number</p>
                    <p id="verificationPhoneNumber" class="form-hint"></p>
                    
                    <div class="verification-code">
                        <input type="text" class="code-input" maxlength="1" id="code1">
                        <input type="text" class="code-input" maxlength="1" id="code2">
                        <input type="text" class="code-input" maxlength="1" id="code3">
                        <input type="text" class="code-input" maxlength="1" id="code4">
                        <input type="text" class="code-input" maxlength="1" id="code5">
                        <input type="text" class="code-input" maxlength="1" id="code6">
                    </div>
                    
                    <div class="verification-timer" id="verificationTimer">Resend code in 2:00</div>
                    <div class="resend-code" id="resendCode" style="display: none;">Resend code</div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" id="step4Back">Previous</button>
                    <button class="btn btn-primary" id="step4Verify" disabled>Verify</button>
                </div>
            </div>
            
            <!-- Registration Success -->
            <div class="form-step" id="successStep">
                <div class="registration-success">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <h2 class="success-title">Registration Successful!</h2>
                    <p class="success-message">Your driver account has been created successfully. You can now start accepting ride requests.</p>
                    <button class="btn btn-primary btn-full" id="goToDashboard">Go to Dashboard</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard -->
    <div class="dashboard-container" id="dashboardContainer">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance -->
        <div class="floating-balance">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Online Toggle -->
        <div class="online-toggle offline" id="onlineToggle">
            <label class="toggle-switch">
                <input type="checkbox" id="onlineToggleCheckbox">
                <span class="toggle-slider"></span>
            </label>
            <span id="onlineStatusText">Offline</span>
        </div>
        
        <!-- Driver Status Indicator -->
        <div class="driver-status-indicator" id="driverStatusIndicator" style="display: none;">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Offline</span>
        </div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="mapTypeBtn" title="Change Map Type">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-action-btn" id="centerMapBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="quick-action-btn" id="refreshLocationBtn" title="Refresh Location">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn" id="toggleTrafficBtn" title="Toggle Traffic">
                <i class="fas fa-traffic-light"></i>
            </button>
        </div>
        
        <!-- Dark Mode Toggle -->
        <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Driver Panel -->
        <div class="driver-panel" id="driverPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="driver-info">
                <div class="driver-avatar" id="driverAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="driver-details">
                    <h2 id="driverName">Driver Name</h2>
                    <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                    <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="earnings">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Earnings</span>
                </button>
            </div>
            
            <!-- Collapsible Driver Details -->
            <div class="collapsible-section">
                <div class="collapsible-header" id="driverDetailsHeader">
                    <h3>Driver Details</h3>
                    <i class="fas fa-chevron-down collapsible-icon" id="driverDetailsIcon"></i>
                </div>
                <div class="collapsible-content" id="driverDetailsContent">
                    <div class="performance-stats">
                        <div class="performance-card">
                            <div class="performance-value" id="totalTrips">0</div>
                            <div class="performance-label">Total Trips</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="ratingScore">4.5</div>
                            <div class="performance-label">Rating</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="onlineTime">0h</div>
                            <div class="performance-label">Online Time</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="acceptanceRate">0%</div>
                            <div class="performance-label">Acceptance</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ride Action Button (Hidden until ride request) -->
            <div class="hold-button-container" id="rideActionBtn" style="display: none;">
                <div class="hold-button-fill" id="holdButtonFill"></div>
                <div class="hold-button-content" id="holdButtonContent">
                    <i class="fas fa-play-circle"></i>
                    <span>Hold to Start Ride</span>
                </div>
            </div>
            
            <!-- Advanced Features Section -->
            <div class="advanced-features" id="advancedFeatures" style="display: none;">
                <button class="feature-btn" id="navigateToPickupBtn">
                    <i class="fas fa-directions"></i>
                    <span>Navigate to Pickup</span>
                </button>
                <button class="feature-btn" id="contactCustomerBtn">
                    <i class="fas fa-phone"></i>
                    <span>Contact Customer</span>
                </button>
                <button class="feature-btn" id="viewRouteDetailsBtn">
                    <i class="fas fa-route"></i>
                    <span>View Route Details</span>
                </button>
            </div>
            
            <!-- Ride Queue (Advanced Feature) -->
            <div class="ride-queue" id="rideQueue" style="display: none;">
                <h3 class="section-title">Ride Queue</h3>
                <div id="queueList">
                    <!-- Queue items will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Ride Request Popup -->
        <div class="ride-request-popup" id="rideRequestPopup">
            <div class="ride-request-content">
                <div class="ride-request-map" id="rideRequestMap"></div>
                <div class="ride-request-details">
                    <div class="customer-info">
                        <div class="customer-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="customer-details">
                            <h3 id="customerName">Customer Name</h3>
                            <p><i class="fas fa-phone"></i> <span id="customerPhone">000-000-0000</span></p>
                            <div class="rating-display">
                                <i class="fas fa-star"></i>
                                <span id="customerRating">4.8</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trip-details">
                        <div class="location-row">
                            <div class="location-icon pickup-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="location-text">
                                <h4>Pickup Location</h4>
                                <p id="pickupLocation">123 Main Street, City</p>
                            </div>
                        </div>
                        <div class="location-row">
                            <div class="location-icon destination-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="location-text">
                                <h4>Destination</h4>
                                <p id="destinationLocation">456 Oak Avenue, City</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="fare-details">
                        <div class="fare-row">
                            <span>Base Fare</span>
                            <span id="baseFare">K15.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Distance</span>
                            <span id="distanceFare">K5.00</span>
                        </div>
                        <div class="fare-row">
                            <span>Discount</span>
                            <span id="discountFare">-K2.00</span>
                        </div>
                        <div class="fare-row total">
                            <span>Total Fare</span>
                            <span id="totalFare">K18.00</span>
                        </div>
                    </div>
                    
                    <div class="ride-request-actions">
                        <button class="btn btn-accept" id="acceptRideBtn">
                            <i class="fas fa-check-circle"></i>
                            Accept
                        </button>
                        <button class="btn btn-reject" id="rejectRideBtn">
                            <i class="fas fa-times-circle"></i>
                            Reject
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    Driver Details
                </h3>
                <div class="input-group">
                    <label for="driverNameInput">Full Name</label>
                    <input type="text" id="driverNameInput" class="input-field" placeholder="Your full name">
                </div>
                <div class="input-group">
                    <label for="driverPhoneInput">Phone Number</label>
                    <input type="tel" id="driverPhoneInput" class="input-field" placeholder="Your phone number">
                </div>
                <div class="input-group">
                    <label for="driverNRCInput">NRC Number</label>
                    <input type="text" id="driverNRCInput" class="input-field" placeholder="Your NRC number">
                </div>
                <button class="btn btn-accept" id="saveDriverDetailsBtn">
                    <i class="fas fa-save"></i>
                    Save Details
                </button>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-car"></i>
                    Vehicle Details
                </h3>
                <div class="input-group">
                    <label for="vehicleTypeInput">Vehicle Type</label>
                    <input type="text" id="vehicleTypeInput" class="input-field" placeholder="Car, Bike, etc.">
                </div>
                <div class="input-group">
                    <label for="vehicleModelInput">Vehicle Model</label>
                    <input type="text" id="vehicleModelInput" class="input-field" placeholder="Toyota Corolla, etc.">
                </div>
                <div class="input-group">
                    <label for="licensePlateInput">License Plate</label>
                    <input type="text" id="licensePlateInput" class="input-field" placeholder="ABC 123">
                </div>
                <div class="input-group">
                    <label for="vehicleColorInput">Vehicle Color</label>
                    <input type="text" id="vehicleColorInput" class="input-field" placeholder="Red, Blue, etc.">
                </div>
                <button class="btn btn-accept" id="saveVehicleDetailsBtn">
                    <i class="fas fa-save"></i>
                    Save Vehicle Details
                </button>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    Wallet & Balance
                </h3>
                <div class="wallet-balance">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    <div>Add funds to receive ride requests</div>
                </div>
                
                <div class="wallet-actions">
                    <button class="btn btn-wallet" id="addFundsBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Funds
                    </button>
                    <button class="btn btn-wallet" id="withdrawFundsBtn">
                        <i class="fas fa-minus-circle"></i>
                        Withdraw
                    </button>
                </div>
                
                <div class="vehicle-details">
                    <div class="detail-row">
                        <span class="detail-label">Total Earnings</span>
                        <span class="detail-value" id="totalEarnings">K0.00</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Completed Rides</span>
                        <span class="detail-value" id="completedRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cancelled Rides</span>
                        <span class="detail-value" id="cancelledRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Rating</span>
                        <span class="detail-value" id="driverRating">4.5 </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="earningsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Earnings</h2>
            </div>
            
            <div class="earnings-section">
                <div class="earnings-period">
                    <button class="period-btn active" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn" data-period="month">This Month</button>
                </div>
                
                <div class="earnings-card">
                    <div class="earnings-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="earningsTotal">K0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ridesCompleted">0</div>
                            <div class="stat-label">Rides Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgEarning">K0.00</div>
                            <div class="stat-label">Avg per Ride</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="onlineHours">0h</div>
                            <div class="stat-label">Online Time</div>
                        </div>
                    </div>
                    
                    <div class="earnings-chart">
                        Earnings chart would appear here
                    </div>
                    
                    <button class="btn btn-accept" id="withdrawEarningsBtn">
                        <i class="fas fa-download"></i>
                        Withdraw Earnings
                    </button>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-receipt"></i>
                    Recent Earnings
                </h3>
                <div id="earningsList">
                    <!-- Earnings items will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Notification -->
        <div class="notification" id="notification"></div>
    </div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let isOnline = false;
        let driverMap, rideRequestMap;
        let locationWatchId = null;
        let driverMarker = null;
        let customerMarker = null;
        let destinationMarker = null;
        let routePolyline = null;
        let holdTimer = null;
        let holdProgress = 0;
        let currentRideRequest = null;
        let earningsPeriod = 'today';
        let waypoints = [];
        let walletBalance = 0;
        let commissionRate = 0.08; // 8% commission
        let trafficLayer = null;
        let trafficEnabled = false;
        let mapType = 'standard';
        let isDarkMode = false;
        let rideQueue = [];
        let verificationTimer = null;
        let verificationTimeLeft = 120; // 2 minutes in seconds
        
        // Registration form state
        let currentStep = 1;
        let registrationData = {
            personal: {},
            vehicle: {},
            payment: {}
        };
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            checkDriverRegistration();
            setupRegistrationEventListeners();
        });
        
        // Check if driver is already registered
        function checkDriverRegistration() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    // Check if driver has completed registration
                    database.ref('drivers/' + currentUser.uid).once('value')
                        .then(snapshot => {
                            const driverData = snapshot.val();
                            if (driverData && driverData.registrationComplete) {
                                // Driver is registered, show dashboard
                                showDashboard();
                                initializeMap();
                                setupDashboardEventListeners();
                                loadDriverData();
                            } else {
                                // Driver needs to complete registration
                                showRegistration();
                            }
                        })
                        .catch(error => {
                            console.error('Error checking driver registration:', error);
                            showRegistration();
                        });
                } else {
                    // No user logged in, show registration
                    showRegistration();
                }
            });
        }
        
        // Show registration screen
        function showRegistration() {
            document.getElementById('registrationContainer').style.display = 'flex';
            document.getElementById('dashboardContainer').style.display = 'none';
        }
        
        // Show dashboard
        function showDashboard() {
            document.getElementById('registrationContainer').style.display = 'none';
            document.getElementById('dashboardContainer').style.display = 'block';
        }
        
        // Setup registration event listeners
        function setupRegistrationEventListeners() {
            // Step navigation
            document.getElementById('step1Next').addEventListener('click', goToStep2);
            document.getElementById('step2Back').addEventListener('click', goToStep1);
            document.getElementById('step2Next').addEventListener('click', goToStep3);
            document.getElementById('step3Back').addEventListener('click', goToStep2);
            document.getElementById('step3Next').addEventListener('click', goToStep4);
            document.getElementById('step4Back').addEventListener('click', goToStep3);
            document.getElementById('step4Verify').addEventListener('click', verifyPhoneNumber);
            
            // Payment method change
            document.getElementById('paymentMethod').addEventListener('change', togglePaymentDetails);
            
            // Code input handling
            setupCodeInputs();
            
            // Resend code
            document.getElementById('resendCode').addEventListener('click', resendVerificationCode);
            
            // Go to dashboard
            document.getElementById('goToDashboard').addEventListener('click', completeRegistration);
        }
        
        // Go to step 2
        function goToStep2() {
            // Validate step 1
            const fullName = document.getElementById('fullName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const nrcNumber = document.getElementById('nrcNumber').value.trim();
            
            if (!fullName) {
                showNotification('Please enter your full name');
                return;
            }
            
            if (!phoneNumber) {
                showNotification('Please enter your phone number');
                return;
            }
            
            if (!nrcNumber) {
                showNotification('Please enter your NRC number');
                return;
            }
            
            // Save step 1 data
            registrationData.personal = {
                fullName: fullName,
                phoneNumber: phoneNumber,
                nrcNumber: nrcNumber
            };
            
            // Update step indicator
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            
            // Show step 2 form
            document.getElementById('step1Form').classList.remove('active');
            document.getElementById('step2Form').classList.add('active');
            
            currentStep = 2;
        }
        
        // Go to step 1
        function goToStep1() {
            // Update step indicator
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            
            // Show step 1 form
            document.getElementById('step2Form').classList.remove('active');
            document.getElementById('step1Form').classList.add('active');
            
            currentStep = 1;
        }
        
        // Go to step 3
        function goToStep3() {
            // Validate step 2
            const vehicleType = document.getElementById('vehicleType').value;
            const vehicleMake = document.getElementById('vehicleMake').value.trim();
            const vehicleModel = document.getElementById('vehicleModel').value.trim();
            const vehicleYear = document.getElementById('vehicleYear').value.trim();
            const licensePlate = document.getElementById('licensePlate').value.trim();
            const vehicleColor = document.getElementById('vehicleColor').value.trim();
            
            if (!vehicleType) {
                showNotification('Please select vehicle type');
                return;
            }
            
            if (!vehicleMake) {
                showNotification('Please enter vehicle make');
                return;
            }
            
            if (!vehicleModel) {
                showNotification('Please enter vehicle model');
                return;
            }
            
            if (!vehicleYear) {
                showNotification('Please enter vehicle year');
                return;
            }
            
            if (!licensePlate) {
                showNotification('Please enter license plate');
                return;
            }
            
            if (!vehicleColor) {
                showNotification('Please enter vehicle color');
                return;
            }
            
            // Save step 2 data
            registrationData.vehicle = {
                vehicleType: vehicleType,
                vehicleMake: vehicleMake,
                vehicleModel: vehicleModel,
                vehicleYear: vehicleYear,
                licensePlate: licensePlate,
                vehicleColor: vehicleColor
            };
            
            // Update step indicator
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            
            // Show step 3 form
            document.getElementById('step2Form').classList.remove('active');
            document.getElementById('step3Form').classList.add('active');
            
            currentStep = 3;
        }
        
        // Go to step 2
        function goToStep2() {
            // Update step indicator
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            
            // Show step 2 form
            document.getElementById('step3Form').classList.remove('active');
            document.getElementById('step2Form').classList.add('active');
            
            currentStep = 2;
        }
        
        // Go to step 4
        function goToStep4() {
            // Validate step 3
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (!paymentMethod) {
                showNotification('Please select payment method');
                return;
            }
            
            if (paymentMethod === 'bank') {
                const bankName = document.getElementById('bankName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const accountName = document.getElementById('accountName').value.trim();
                
                if (!bankName || !accountNumber || !accountName) {
                    showNotification('Please complete bank details');
                    return;
                }
                
                registrationData.payment = {
                    method: 'bank',
                    bankName: bankName,
                    accountNumber: accountNumber,
                    accountName: accountName
                };
            } else if (paymentMethod === 'mobile') {
                const mobileProvider = document.getElementById('mobileProvider').value;
                const mobileNumber = document.getElementById('mobileNumber').value.trim();
                
                if (!mobileProvider || !mobileNumber) {
                    showNotification('Please complete mobile money details');
                    return;
                }
                
                registrationData.payment = {
                    method: 'mobile',
                    provider: mobileProvider,
                    mobileNumber: mobileNumber
                };
            }
            
            // Update step indicator
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step4').classList.add('active');
            
            // Show step 4 form
            document.getElementById('step3Form').classList.remove('active');
            document.getElementById('step4Form').classList.add('active');
            
            // Set phone number for verification
            document.getElementById('verificationPhoneNumber').textContent = registrationData.personal.phoneNumber;
            
            // Start verification process
            startPhoneVerification();
            
            currentStep = 4;
        }
        
        // Go to step 3
        function goToStep3() {
            // Update step indicator
            document.getElementById('step4').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            
            // Show step 3 form
            document.getElementById('step4Form').classList.remove('active');
            document.getElementById('step3Form').classList.add('active');
            
            // Clear verification timer
            if (verificationTimer) {
                clearInterval(verificationTimer);
                verificationTimer = null;
            }
            
            currentStep = 3;
        }
        
        // Toggle payment details based on selected method
        function togglePaymentDetails() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const bankDetails = document.getElementById('bankDetails');
            const mobileMoneyDetails = document.getElementById('mobileMoneyDetails');
            
            if (paymentMethod === 'bank') {
                bankDetails.style.display = 'block';
                mobileMoneyDetails.style.display = 'none';
            } else if (paymentMethod === 'mobile') {
                bankDetails.style.display = 'none';
                mobileMoneyDetails.style.display = 'block';
            } else {
                bankDetails.style.display = 'none';
                mobileMoneyDetails.style.display = 'none';
            }
        }
        
        // Setup code inputs for verification
        function setupCodeInputs() {
            const codeInputs = document.querySelectorAll('.code-input');
            
            codeInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1) {
                        if (index < codeInputs.length - 1) {
                            codeInputs[index + 1].focus();
                        } else {
                            // All inputs filled, enable verify button
                            document.getElementById('step4Verify').disabled = false;
                        }
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                        codeInputs[index - 1].focus();
                    }
                });
            });
        }
        
        // Start phone verification process
        function startPhoneVerification() {
            // In a real app, this would send a verification code to the phone
            // For demo purposes, we'll simulate this process
            
            // Show notification
            showNotification('Verification code sent to ' + registrationData.personal.phoneNumber);
            
            // Start countdown timer
            verificationTimeLeft = 120;
            updateVerificationTimer();
            
            verificationTimer = setInterval(() => {
                verificationTimeLeft--;
                updateVerificationTimer();
                
                if (verificationTimeLeft <= 0) {
                    clearInterval(verificationTimer);
                    document.getElementById('verificationTimer').style.display = 'none';
                    document.getElementById('resendCode').style.display = 'block';
                }
            }, 1000);
            
            // For demo, auto-fill the code after a short delay
            setTimeout(() => {
                document.getElementById('code1').value = '1';
                document.getElementById('code2').value = '2';
                document.getElementById('code3').value = '3';
                document.getElementById('code4').value = '4';
                document.getElementById('code5').value = '5';
                document.getElementById('code6').value = '6';
                document.getElementById('step4Verify').disabled = false;
            }, 2000);
        }
        
        // Update verification timer display
        function updateVerificationTimer() {
            const minutes = Math.floor(verificationTimeLeft / 60);
            const seconds = verificationTimeLeft % 60;
            document.getElementById('verificationTimer').textContent = 
                `Resend code in ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // Resend verification code
        function resendVerificationCode() {
            document.getElementById('resendCode').style.display = 'none';
            document.getElementById('verificationTimer').style.display = 'block';
            
            // Clear code inputs
            const codeInputs = document.querySelectorAll('.code-input');
            codeInputs.forEach(input => {
                input.value = '';
            });
            
            document.getElementById('step4Verify').disabled = true;
            
            // Restart verification process
            startPhoneVerification();
        }
        
        // Verify phone number
        function verifyPhoneNumber() {
            // In a real app, this would verify the code with Firebase Auth
            // For demo purposes, we'll assume it's always successful
            
            // Clear verification timer
            if (verificationTimer) {
                clearInterval(verificationTimer);
                verificationTimer = null;
            }
            
            // Show success step
            document.getElementById('step4').classList.remove('active');
            document.getElementById('step4').classList.add('completed');
            
            document.getElementById('step4Form').classList.remove('active');
            document.getElementById('successStep').classList.add('active');
        }
        
        // Complete registration
        function completeRegistration() {
            // Create user with phone authentication
            // In a real app, this would use Firebase phone authentication
            // For demo, we'll use anonymous authentication
            
            auth.signInAnonymously()
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    
                    // Save driver data to Firebase
                    return database.ref('drivers/' + currentUser.uid).set({
                        ...registrationData.personal,
                        ...registrationData.vehicle,
                        ...registrationData.payment,
                        registrationComplete: true,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        isOnline: false,
                        walletBalance: 0
                    });
                })
                .then(() => {
                    // Show dashboard
                    showDashboard();
                    initializeMap();
                    setupDashboardEventListeners();
                    loadDriverData();
                    
                    showNotification('Registration completed successfully!');
                })
                .catch((error) => {
                    console.error('Error completing registration:', error);
                    showNotification('Error completing registration. Please try again.');
                });
        }
        
        // Map initialization
        function initializeMap() {
            // Main driver map
            driverMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(driverMap);
            
            // Ride request map
            rideRequestMap = L.map('rideRequestMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(rideRequestMap);
            
            // Get driver's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 15);
                    
                    // Add marker for driver location
                    driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<div class="driver-marker"></div><div class="driver-marker-label">You</div>',
                            iconSize: [35, 50]
                        })
                    }).addTo(driverMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Update driver location in Firebase
        function updateDriverLocation(lat, lng) {
            if (currentUser && isOnline) {
                database.ref('driverLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    isOnline: true
                });
                
                // Update marker position
                if (driverMarker) {
                    driverMarker.setLatLng([lat, lng]);
                }
            }
        }
        
        // Start tracking driver location
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateDriverLocation(lat, lng);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking driver location
        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }
        
        // Setup dashboard event listeners
        function setupDashboardEventListeners() {
            // Online toggle
            document.getElementById('onlineToggleCheckbox').addEventListener('change', toggleOnlineStatus);
            
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                    // Refresh driver position when returning to home
                    if (screen === 'home') {
                        refreshDriverPosition();
                    }
                });
            });
            
            // Ride request actions
            document.getElementById('acceptRideBtn').addEventListener('click', acceptRide);
            document.getElementById('rejectRideBtn').addEventListener('click', rejectRide);
            
            // Ride action button (hold functionality)
            const rideActionBtn = document.getElementById('rideActionBtn');
            
            rideActionBtn.addEventListener('mousedown', startHoldTimer);
            rideActionBtn.addEventListener('touchstart', startHoldTimer);
            
            rideActionBtn.addEventListener('mouseup', cancelHoldTimer);
            rideActionBtn.addEventListener('touchend', cancelHoldTimer);
            rideActionBtn.addEventListener('mouseleave', cancelHoldTimer);
            
            // Account actions
            document.getElementById('saveDriverDetailsBtn').addEventListener('click', saveDriverDetails);
            document.getElementById('saveVehicleDetailsBtn').addEventListener('click', saveVehicleDetails);
            document.getElementById('addFundsBtn').addEventListener('click', addFunds);
            document.getElementById('withdrawFundsBtn').addEventListener('click', withdrawFunds);
            
            // Earnings period selection
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    earningsPeriod = this.getAttribute('data-period');
                    loadEarnings();
                });
            });
            
            // Withdraw earnings
            document.getElementById('withdrawEarningsBtn').addEventListener('click', withdrawEarnings);
            
            // Advanced features
            document.getElementById('navigateToPickupBtn').addEventListener('click', navigateToPickup);
            document.getElementById('contactCustomerBtn').addEventListener('click', contactCustomer);
            document.getElementById('viewRouteDetailsBtn').addEventListener('click', viewRouteDetails);
            
            // Quick actions
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshDriverPosition);
            document.getElementById('toggleTrafficBtn').addEventListener('click', toggleTraffic);
            
            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => driverMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => driverMap.zoomOut());
            document.getElementById('mapTypeBtn').addEventListener('click', toggleMapType);
            
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Panel collapse
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            // Collapsible sections
            document.getElementById('driverDetailsHeader').addEventListener('click', toggleDriverDetails);
        }
        
        // Toggle panel collapse
        function togglePanelCollapse() {
            const panel = document.getElementById('driverPanel');
            panel.classList.toggle('collapsed');
        }
        
        // Toggle driver details
        function toggleDriverDetails() {
            const content = document.getElementById('driverDetailsContent');
            const icon = document.getElementById('driverDetailsIcon');
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }
        
        // Toggle map type
        function toggleMapType() {
            // Remove current tile layer
            driverMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    driverMap.removeLayer(layer);
                }
            });
            
            // Add new tile layer based on current map type
            if (mapType === 'standard') {
                // Switch to satellite
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenTopoMap contributors'
                }).addTo(driverMap);
                mapType = 'satellite';
                showNotification('Switched to satellite view');
            } else {
                // Switch back to standard
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(driverMap);
                mapType = 'standard';
                showNotification('Switched to standard view');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeToggle.style.background = '#333';
                darkModeToggle.style.color = '#ffcc00';
                showNotification('Dark mode enabled');
            } else {
                body.style.backgroundColor = '';
                body.style.color = '';
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeToggle.style.background = '';
                darkModeToggle.style.color = '';
                showNotification('Dark mode disabled');
            }
        }
        
        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            // Load data for specific screens
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'earnings') {
                loadEarnings();
            }
        }
        
        // Toggle online status
        function toggleOnlineStatus() {
            isOnline = !isOnline;
            const onlineToggle = document.getElementById('onlineToggle');
            const onlineStatusText = document.getElementById('onlineStatusText');
            const statusIndicator = document.getElementById('driverStatusIndicator');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                onlineToggle.classList.remove('offline');
                onlineToggle.classList.add('active');
                onlineStatusText.textContent = 'Online';
                
                // Show status indicator
                statusIndicator.style.display = 'flex';
                statusDot.classList.add('online');
                statusText.textContent = 'Online';
                
                // Start location tracking
                startLocationTracking();
                
                // Listen for ride requests
                listenForRideRequests();
                
                showNotification('You are now online and receiving ride requests.');
            } else {
                onlineToggle.classList.remove('active');
                onlineToggle.classList.add('offline');
                onlineStatusText.textContent = 'Offline';
                
                // Hide status indicator
                statusIndicator.style.display = 'none';
                statusDot.classList.remove('online');
                
                // Stop location tracking
                stopLocationTracking();
                
                // Stop listening for ride requests
                stopListeningForRideRequests();
                
                showNotification('You are now offline.');
            }
            
            // Update driver status in Firebase
            if (currentUser) {
                database.ref('drivers/' + currentUser.uid).update({
                    isOnline: isOnline,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Update driver location status
                if (isOnline) {
                    // Get current position to update location
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            updateDriverLocation(lat, lng);
                        });
                    }
                } else {
                    // Remove from online drivers
                    database.ref('driverLocations/' + currentUser.uid).remove();
                }
            }
        }
        
        // Listen for ride requests
        function listenForRideRequests() {
            // Listen for new ride requests that are not yet assigned
            database.ref('rides').orderByChild('status').equalTo('requested').on('child_added', snapshot => {
                const ride = snapshot.val();
                const rideId = snapshot.key;
                
                // Check if this ride is already assigned to another driver
                if (!ride.driverId) {
                    // Show ride request popup
                    showRideRequest(rideId, ride);
                }
            });
        }
        
        // Stop listening for ride requests
        function stopListeningForRideRequests() {
            database.ref('rides').off('child_added');
        }
        
        // Show ride request popup
        function showRideRequest(rideId, ride) {
            // Check if driver has accepted a ride already
            if (currentRide) {
                return; // Don't show new requests if driver is already on a ride
            }
            
            currentRideRequest = {
                id: rideId,
                ...ride
            };
            
            // Update popup content
            document.getElementById('customerName').textContent = ride.passengerName || 'Passenger';
            document.getElementById('customerPhone').textContent = ride.passengerPhone || 'N/A';
            document.getElementById('customerRating').textContent = ride.passengerRating || '4.8';
            document.getElementById('pickupLocation').textContent = ride.pickupLocation;
            document.getElementById('destinationLocation').textContent = ride.destination;
            
            // Calculate and display fare details
            const baseFare = 15;
            const distanceFare = Math.max(0, (ride.distance ? parseFloat(ride.distance) * 5 : 5));
            const discount = ride.promoCode ? 2 : 0;
            const totalFare = baseFare + distanceFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('distanceFare').textContent = `K${distanceFare.toFixed(2)}`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
            
            // Update ride request map
            updateRideRequestMap(ride);
            
            // Show popup
            document.getElementById('rideRequestPopup').style.display = 'flex';
        }
        
        // Update ride request map
        function updateRideRequestMap(ride) {
            // Clear existing map
            rideRequestMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    rideRequestMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Pickup</div>',
                    iconSize: [25, 40]
                })
            }).addTo(rideRequestMap).bindPopup('Pickup Location');
            
            // Add destination marker
            L.marker([ride.destLat, ride.destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Destination</div>',
                    iconSize: [25, 40]
                })
            }).addTo(rideRequestMap).bindPopup('Destination');
            
            // Draw route
            drawRouteOnRequestMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
            
            // Fit map to show both locations with padding
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            rideRequestMap.fitBounds(bounds, { padding: [20, 20] });
        }
        
        // Draw route on ride request map
        function drawRouteOnRequestMap(startLat, startLng, endLat, endLng) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(rideRequestMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(rideRequestMap);
                });
        }
        
        // Accept a ride
        function acceptRide() {
            if (currentRideRequest && currentUser) {
                // Update ride with driver info
                database.ref('rides/' + currentRideRequest.id).update({
                    driverId: currentUser.uid,
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide = {
                        id: currentRideRequest.id,
                        ...currentRideRequest,
                        driverId: currentUser.uid,
                        status: 'accepted'
                    };
                    
                    // Hide ride request popup
                    document.getElementById('rideRequestPopup').style.display = 'none';
                    
                    // Update driver panel for active ride
                    updateDriverPanelForActiveRide();
                    
                    // Update map for active ride
                    updateMapForActiveRide();
                    
                    // Notify passenger that driver has accepted
                    notifyPassenger('accepted');
                    
                    showNotification('Ride accepted successfully.');
                })
                .catch(error => {
                    console.error('Error accepting ride:', error);
                    showNotification('Error accepting ride. Please try again.');
                });
            }
        }
        
        // Reject a ride
        function rejectRide() {
            if (currentRideRequest) {
                // Hide ride request popup
                document.getElementById('rideRequestPopup').style.display = 'none';
                currentRideRequest = null;
                
                showNotification('Ride rejected.');
            }
        }
        
        // Notify passenger about ride status
        function notifyPassenger(status) {
            if (currentRide && currentRide.passengerId) {
                // In a real app, this would send a push notification to the passenger
                // For demo, we'll just update the ride status in Firebase
                database.ref('rides/' + currentRide.id).update({
                    status: status,
                    driverName: registrationData.personal.fullName,
                    driverPhone: registrationData.personal.phoneNumber,
                    vehicleDetails: `${registrationData.vehicle.vehicleMake} ${registrationData.vehicle.vehicleModel} - ${registrationData.vehicle.licensePlate}`
                });
            }
        }
        
        // Update driver panel for active ride
        function updateDriverPanelForActiveRide() {
            if (currentRide) {
                // Update driver details with customer info
                document.getElementById('driverName').textContent = currentRide.passengerName || 'Passenger';
                document.getElementById('driverPhone').textContent = currentRide.passengerPhone || 'N/A';
                
                // Update vehicle details with trip info
                document.getElementById('vehicleDetails').textContent = `To: ${currentRide.destination}`;
                
                // Show ride action button
                document.getElementById('rideActionBtn').style.display = 'block';
                
                // Show advanced features
                document.getElementById('advancedFeatures').style.display = 'flex';
                
                // Update ride action button
                updateRideActionButton('hold-to-start');
            }
        }
        
        // Update map for active ride
        function updateMapForActiveRide() {
            if (currentRide) {
                // Clear existing markers and routes
                if (customerMarker) {
                    driverMap.removeLayer(customerMarker);
                    customerMarker = null;
                }
                if (destinationMarker) {
                    driverMap.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routePolyline) {
                    driverMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
                
                // Add customer pickup marker
                customerMarker = L.marker([currentRide.pickupLat, currentRide.pickupLng], {
                    icon: L.divIcon({
                        className: 'customer-marker',
                        html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Customer</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Customer Pickup Location');
                
                // Add destination marker
                destinationMarker = L.marker([currentRide.destLat, currentRide.destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Destination</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Destination');
                
                // Draw route from driver to customer
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.pickupLat, currentRide.pickupLng);
                }
                
                // Fit map to show driver, customer and destination with appropriate zoom
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    const bounds = L.latLngBounds(
                        [driverLatLng.lat, driverLatLng.lng],
                        [currentRide.pickupLat, currentRide.pickupLng],
                        [currentRide.destLat, currentRide.destLng]
                    );
                    driverMap.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }
        
        // Draw route on main map
        function drawRoute(startLat, startLng, endLat, endLng) {
            // Remove existing route if any
            if (routePolyline) {
                driverMap.removeLayer(routePolyline);
            }
            
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 4,
                            opacity: 0.7
                        }).addTo(driverMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(driverMap);
                });
        }
        
        // Update ride action button based on ride status
        function updateRideActionButton(action) {
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            // Reset hold progress
            holdProgress = 0;
            const holdButtonFill = document.getElementById('holdButtonFill');
            if (holdButtonFill) {
                holdButtonFill.style.width = '0%';
            }
            
            switch(action) {
                case 'hold-to-start':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-play-circle"></i>
                        <span>Hold to Start Ride</span>
                    `;
                    break;
                case 'hold-to-arrive':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Hold to Arrive</span>
                    `;
                    break;
                case 'hold-to-pickup':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-user-check"></i>
                        <span>Hold to Pickup</span>
                    `;
                    break;
                case 'hold-to-complete':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-flag-checkered"></i>
                        <span>Hold to Complete</span>
                    `;
                    break;
            }
        }
        
        // Start hold timer for ride actions
        function startHoldTimer() {
            if (holdTimer) return;
            
            // Add active class to change button text color to white
            const holdButtonContent = document.getElementById('holdButtonContent');
            holdButtonContent.classList.add('active');
            
            holdTimer = setInterval(() => {
                holdProgress += 3.33; // 3 seconds total = 100%
                const holdButtonFill = document.getElementById('holdButtonFill');
                
                if (holdButtonFill) {
                    holdButtonFill.style.width = `${holdProgress}%`;
                }
                
                if (holdProgress >= 100) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                    completeHoldAction();
                }
            }, 100);
        }
        
        // Cancel hold timer
        function cancelHoldTimer() {
            if (holdTimer) {
                clearInterval(holdTimer);
                holdTimer = null;
                holdProgress = 0;
                
                // Remove active class to revert button text color
                const holdButtonContent = document.getElementById('holdButtonContent');
                holdButtonContent.classList.remove('active');
                
                const holdButtonFill = document.getElementById('holdButtonFill');
                if (holdButtonFill) {
                    holdButtonFill.style.width = '0%';
                }
            }
        }
        
        // Complete hold action based on current ride state
        function completeHoldAction() {
            if (!currentRide) return;
            
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            if (holdButtonContent.innerHTML.includes('Start Ride')) {
                // Start the ride
                database.ref('rides/' + currentRide.id).update({
                    status: 'started',
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide.status = 'started';
                    updateRideActionButton('hold-to-arrive');
                    showNotification('Ride started. Heading to pickup location.');
                    
                    // Update map to show route from driver to destination
                    if (driverMarker) {
                        const driverLatLng = driverMarker.getLatLng();
                        drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.destLat, currentRide.destLng);
                    }
                    
                    // Notify passenger
                    notifyPassenger('started');
                });
            } else if (holdButtonContent.innerHTML.includes('Arrive')) {
                // Mark arrived
                database.ref('rides/' + currentRide.id).update({
                    status: 'arrived'
                })
                .then(() => {
                    currentRide.status = 'arrived';
                    updateRideActionButton('hold-to-pickup');
                    showNotification('Arrival marked. Waiting for passenger.');
                    
                    // Notify passenger
                    notifyPassenger('arrived');
                });
            } else if (holdButtonContent.innerHTML.includes('Pickup')) {
                // Mark pickup
                database.ref('rides/' + currentRide.id).update({
                    status: 'picked_up'
                })
                .then(() => {
                    currentRide.status = 'picked_up';
                    updateRideActionButton('hold-to-complete');
                    showNotification('Passenger picked up. Starting trip.');
                    
                    // Update driver details back to driver info
                    document.getElementById('driverName').textContent = registrationData.personal.fullName;
                    document.getElementById('driverPhone').textContent = registrationData.personal.phoneNumber;
                    document.getElementById('vehicleDetails').textContent = 
                        `${registrationData.vehicle.vehicleMake} ${registrationData.vehicle.vehicleModel} - ${registrationData.vehicle.licensePlate}`;
                    
                    // Notify passenger
                    notifyPassenger('picked_up');
                });
            } else if (holdButtonContent.innerHTML.includes('Complete')) {
                // Complete ride
                database.ref('rides/' + currentRide.id).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    // Calculate commission and update wallet balance
                    const totalFare = calculateTotalFare(currentRide);
                    const commission = totalFare * commissionRate;
                    const driverEarnings = totalFare - commission;
                    
                    // Update wallet balance
                    const newWalletBalance = walletBalance + driverEarnings;
                    updateWalletBalance(newWalletBalance);
                    
                    // Add to earnings
                    const earningsData = {
                        rideId: currentRide.id,
                        amount: driverEarnings,
                        commission: commission,
                        totalFare: totalFare,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('earnings/' + currentUser.uid).push(earningsData)
                        .then(() => {
                            // Show earnings notification
                            showNotification(`Ride completed! You earned K${driverEarnings.toFixed(2)}. Commission: K${commission.toFixed(2)}`);
                            
                            // Reset driver panel
                            currentRide = null;
                            document.getElementById('rideActionBtn').style.display = 'none';
                            document.getElementById('advancedFeatures').style.display = 'none';
                            
                            // Clear map markers and routes
                            if (customerMarker) {
                                driverMap.removeLayer(customerMarker);
                                customerMarker = null;
                            }
                            if (destinationMarker) {
                                driverMap.removeLayer(destinationMarker);
                                destinationMarker = null;
                            }
                            if (routePolyline) {
                                driverMap.removeLayer(routePolyline);
                                routePolyline = null;
                            }
                            
                            // Notify passenger
                            notifyPassenger('completed');
                        });
                });
            }
        }
        
        // Calculate total fare for a ride
        function calculateTotalFare(ride) {
            const baseFare = 15;
            const distanceFare = Math.max(0, (ride.distance ? parseFloat(ride.distance) * 5 : 5));
            const discount = ride.promoCode ? 2 : 0;
            return baseFare + distanceFare - discount;
        }
        
        // Update wallet balance
        function updateWalletBalance(newBalance) {
            walletBalance = newBalance;
            
            // Update UI
            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
            document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
            
            // Save to Firebase
            if (currentUser) {
                database.ref('drivers/' + currentUser.uid).update({
                    walletBalance: walletBalance
                });
            }
        }
        
        // Load driver data
        function loadDriverData() {
            if (currentUser) {
                database.ref('drivers/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const driverData = snapshot.val();
                        if (driverData) {
                            // Update form fields
                            document.getElementById('driverNameInput').value = driverData.fullName || '';
                            document.getElementById('driverPhoneInput').value = driverData.phoneNumber || '';
                            document.getElementById('driverNRCInput').value = driverData.nrcNumber || '';
                            document.getElementById('vehicleTypeInput').value = driverData.vehicleType || '';
                            document.getElementById('vehicleModelInput').value = driverData.vehicleModel || '';
                            document.getElementById('licensePlateInput').value = driverData.licensePlate || '';
                            document.getElementById('vehicleColorInput').value = driverData.vehicleColor || '';
                            
                            // Update display
                            document.getElementById('driverName').textContent = driverData.fullName || 'Driver Name';
                            document.getElementById('driverPhone').textContent = driverData.phoneNumber || '000-000-0000';
                            document.getElementById('vehicleDetails').textContent = 
                                `${driverData.vehicleMake || 'Vehicle'} ${driverData.vehicleModel || ''} - ${driverData.licensePlate || 'ABC123'}`;
                            
                            // Update wallet balance
                            walletBalance = driverData.walletBalance || 0;
                            document.getElementById('walletBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                            
                            // Update driver avatar
                            updateDriverAvatar();
                            
                            // Set online status if previously online
                            if (driverData.isOnline) {
                                document.getElementById('onlineToggleCheckbox').checked = true;
                                toggleOnlineStatus();
                            }
                            
                            // Store registration data for use in the app
                            registrationData.personal = {
                                fullName: driverData.fullName,
                                phoneNumber: driverData.phoneNumber,
                                nrcNumber: driverData.nrcNumber
                            };
                            
                            registrationData.vehicle = {
                                vehicleType: driverData.vehicleType,
                                vehicleMake: driverData.vehicleMake,
                                vehicleModel: driverData.vehicleModel,
                                vehicleYear: driverData.vehicleYear,
                                licensePlate: driverData.licensePlate,
                                vehicleColor: driverData.vehicleColor
                            };
                        }
                    });
                
                // Load driver stats
                loadDriverStats();
            }
        }
        
        // Update driver avatar
        function updateDriverAvatar() {
            const driverAvatar = document.getElementById('driverAvatar');
            const driverName = document.getElementById('driverNameInput').value;
            
            if (driverName) {
                driverAvatar.innerHTML = driverName.charAt(0).toUpperCase();
            } else {
                driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // Save driver details
        function saveDriverDetails() {
            const name = document.getElementById('driverNameInput').value;
            const phone = document.getElementById('driverPhoneInput').value;
            const nrc = document.getElementById('driverNRCInput').value;
            
            if (currentUser) {
                database.ref('drivers/' + currentUser.uid).update({
                    fullName: name,
                    phoneNumber: phone,
                    nrcNumber: nrc
                })
                .then(() => {
                    showNotification('Driver details saved successfully.');
                    
                    // Update display
                    document.getElementById('driverName').textContent = name || 'Driver Name';
                    document.getElementById('driverPhone').textContent = phone || '000-000-0000';
                    
                    // Update avatar
                    updateDriverAvatar();
                    
                    // Update registration data
                    registrationData.personal.fullName = name;
                    registrationData.personal.phoneNumber = phone;
                    registrationData.personal.nrcNumber = nrc;
                })
                .catch(error => {
                    console.error('Error saving driver details:', error);
                    showNotification('Error saving driver details. Please try again.');
                });
            }
        }
        
        // Save vehicle details
        function saveVehicleDetails() {
            const vehicleType = document.getElementById('vehicleTypeInput').value;
            const vehicleModel = document.getElementById('vehicleModelInput').value;
            const licensePlate = document.getElementById('licensePlateInput').value;
            const vehicleColor = document.getElementById('vehicleColorInput').value;
            
            if (currentUser) {
                database.ref('drivers/' + currentUser.uid).update({
                    vehicleType: vehicleType,
                    vehicleModel: vehicleModel,
                    licensePlate: licensePlate,
                    vehicleColor: vehicleColor
                })
                .then(() => {
                    showNotification('Vehicle details saved successfully.');
                    
                    // Update display
                    document.getElementById('vehicleDetails').textContent = 
                        `${registrationData.vehicle.vehicleMake || 'Vehicle'} ${vehicleModel || ''} - ${licensePlate || 'ABC123'}`;
                    
                    // Update registration data
                    registrationData.vehicle.vehicleType = vehicleType;
                    registrationData.vehicle.vehicleModel = vehicleModel;
                    registrationData.vehicle.licensePlate = licensePlate;
                    registrationData.vehicle.vehicleColor = vehicleColor;
                })
                .catch(error => {
                    console.error('Error saving vehicle details:', error);
                    showNotification('Error saving vehicle details. Please try again.');
                });
            }
        }
        
        // Add funds to wallet
        function addFunds() {
            const amount = prompt('Enter amount to add to your wallet (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = walletBalance + addAmount;
                
                // Update balance
                updateWalletBalance(newBalance);
                
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your wallet.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Withdraw funds from wallet
        function withdrawFunds() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawAmount;
                updateWalletBalance(newBalance);
                
                showNotification(`Withdrawal request submitted. K${withdrawAmount.toFixed(2)} will be processed within 24 hours.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Load driver statistics
        function loadDriverStats() {
            if (!currentUser) return;
            
            // Load completed rides count
            database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    let completed = 0;
                    let cancelled = 0;
                    let totalEarnings = 0;
                    
                    if (rides) {
                        Object.values(rides).forEach(ride => {
                            if (ride.status === 'completed') {
                                completed++;
                                totalEarnings += ride.fare || 0;
                            } else if (ride.status === 'cancelled') {
                                cancelled++;
                            }
                        });
                    }
                    
                    document.getElementById('completedRides').textContent = completed;
                    document.getElementById('cancelledRides').textContent = cancelled;
                    document.getElementById('totalEarnings').textContent = `K${totalEarnings.toFixed(2)}`;
                });
        }
        
        // Load ride history
        function loadRideHistory() {
            if (currentUser) {
                database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                    .then(snapshot => {
                        const historyList = document.getElementById('historyList');
                        historyList.innerHTML = '';
                        
                        const rides = snapshot.val();
                        if (rides) {
                            // Convert to array and sort by timestamp (newest first)
                            const ridesArray = Object.keys(rides).map(rideId => ({
                                id: rideId,
                                ...rides[rideId]
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            
                            ridesArray.forEach(ride => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                
                                const date = new Date(ride.timestamp);
                                const formattedDate = date.toLocaleDateString();
                                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                historyItem.innerHTML = `
                                    <div class="history-locations">
                                        <div>
                                            <strong>From:</strong> ${ride.pickupLocation}
                                        </div>
                                        <div>
                                            <strong>To:</strong> ${ride.destination}
                                        </div>
                                    </div>
                                    <div class="history-info">
                                        <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                        <div>${formattedDate} ${formattedTime}</div>
                                        <div class="status-badge ${ride.status === 'completed' ? 'status-completed' : 'status-cancelled'}">
                                            ${ride.status === 'completed' ? 'Completed' : 'Cancelled'}
                                        </div>
                                    </div>
                                `;
                                
                                historyList.appendChild(historyItem);
                            });
                        } else {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ride history:', error);
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                    });
            }
        }
        
        // Load earnings
        function loadEarnings() {
            if (currentUser) {
                database.ref('earnings/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const earnings = snapshot.val();
                        let total = 0;
                        let ridesCompleted = 0;
                        let onlineHours = 0;
                        let totalCommission = 0;
                        
                        if (earnings) {
                            const now = new Date();
                            
                            Object.keys(earnings).forEach(earningId => {
                                const earning = earnings[earningId];
                                const earningDate = new Date(earning.timestamp);
                                
                                let include = false;
                                
                                switch(earningsPeriod) {
                                    case 'today':
                                        if (earningDate.toDateString() === now.toDateString()) {
                                            include = true;
                                        }
                                        break;
                                    case 'week':
                                        const startOfWeek = new Date(now);
                                        startOfWeek.setDate(now.getDate() - now.getDay());
                                        startOfWeek.setHours(0, 0, 0, 0);
                                        
                                        if (earningDate >= startOfWeek) {
                                            include = true;
                                        }
                                        break;
                                    case 'month':
                                        if (earningDate.getMonth() === now.getMonth() && 
                                            earningDate.getFullYear() === now.getFullYear()) {
                                            include = true;
                                        }
                                        break;
                                }
                                
                                if (include) {
                                    total += earning.amount || 0;
                                    totalCommission += earning.commission || 0;
                                    ridesCompleted++;
                                }
                            });
                            
                            // Calculate online hours (simplified)
                            onlineHours = Math.round(ridesCompleted * 0.75); // Assuming 45 minutes per ride on average
                        }
                        
                        document.getElementById('earningsTotal').textContent = `K${total.toFixed(2)}`;
                        document.getElementById('ridesCompleted').textContent = ridesCompleted;
                        document.getElementById('avgEarning').textContent = ridesCompleted > 0 ? `K${(total / ridesCompleted).toFixed(2)}` : 'K0.00';
                        document.getElementById('onlineHours').textContent = `${onlineHours}h`;
                        
                        // Update earnings list with commission information
                        updateEarningsList(earnings);
                    })
                    .catch(error => {
                        console.error('Error loading earnings:', error);
                        document.getElementById('earningsTotal').textContent = 'K0.00';
                        document.getElementById('ridesCompleted').textContent = '0';
                        document.getElementById('avgEarning').textContent = 'K0.00';
                        document.getElementById('onlineHours').textContent = '0h';
                    });
            }
        }
        
        // Update earnings list
        function updateEarningsList(earnings) {
            const earningsList = document.getElementById('earningsList');
            earningsList.innerHTML = '';
            
            if (earnings) {
                // Convert to array and sort by timestamp (newest first)
                const earningsArray = Object.keys(earnings).map(earningId => ({
                    id: earningId,
                    ...earnings[earningId]
                })).sort((a, b) => b.timestamp - a.timestamp)
                  .slice(0, 10); // Show only last 10 earnings
                
                earningsArray.forEach(earning => {
                    const earningItem = document.createElement('div');
                    earningItem.className = 'history-item';
                    
                    const date = new Date(earning.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    earningItem.innerHTML = `
                        <div class="history-locations">
                            <div>
                                <strong>Ride Earnings</strong>
                            </div>
                            <div>
                                <strong>K${earning.amount ? earning.amount.toFixed(2) : '0.00'}</strong>
                            </div>
                        </div>
                        <div class="commission-display">
                            <span class="commission-label">Commission (8%):</span>
                            <span class="commission-value commission-deduction">-K${earning.commission ? earning.commission.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="balance-update">
                            <span class="balance-label-update">Total Fare:</span>
                            <span class="balance-value-update">K${earning.totalFare ? earning.totalFare.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="history-info">
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge status-completed">Completed</div>
                        </div>
                    `;
                    
                    earningsList.appendChild(earningItem);
                });
            } else {
                earningsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No earnings found for this period.</p>';
            }
        }
        
        // Withdraw earnings
        function withdrawEarnings() {
            showNotification('Withdrawal request submitted. Funds will be processed within 24 hours.');
        }
        
        // Advanced features
        
        // Navigate to pickup
        function navigateToPickup() {
            if (currentRide && customerMarker) {
                const customerLatLng = customerMarker.getLatLng();
                // In a real app, this would open the device's navigation app
                showNotification(`Opening navigation to pickup location: ${currentRide.pickupLocation}`);
                
                // For demo purposes, we'll just center the map on the pickup location
                driverMap.setView(customerLatLng, 16);
            }
        }
        
        // Contact customer
        function contactCustomer() {
            if (currentRide) {
                const phoneNumber = currentRide.passengerPhone;
                if (phoneNumber) {
                    // In a real app, this would initiate a phone call
                    showNotification(`Calling customer: ${phoneNumber}`);
                } else {
                    showNotification('Customer phone number not available.');
                }
            }
        }
        
        // View route details
        function viewRouteDetails() {
            if (currentRide) {
                // In a real app, this would show detailed route information
                showNotification(`Showing route details for trip to ${currentRide.destination}`);
            }
        }
        
        // Quick actions
        
        // Center map on driver location
        function centerMap() {
            if (driverMarker) {
                const driverLatLng = driverMarker.getLatLng();
                driverMap.setView(driverLatLng, 16);
                showNotification('Map centered on your location');
            }
        }
        
        // Refresh driver position
        function refreshDriverPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 16);
                    
                    // Update driver marker position
                    if (driverMarker) {
                        driverMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                    
                    showNotification('Location refreshed');
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to refresh location. Please enable location services.');
                });
            }
        }
        
        // Toggle traffic layer
        function toggleTraffic() {
            if (trafficEnabled) {
                // Remove traffic layer
                if (trafficLayer) {
                    driverMap.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
                trafficEnabled = false;
                showNotification('Traffic layer disabled');
            } else {
                // Add traffic layer (using OpenStreetMap traffic tiles as an example)
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(driverMap);
                trafficEnabled = true;
                showNotification('Traffic layer enabled');
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
