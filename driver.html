<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --primary-red: #E74C3C;
            --primary-gradient: linear-gradient(135deg, #FF6B35, #E74C3C);
            --secondary-orange: #E55A28;
            --secondary-red: #C0392B;
            --light-orange: #FFE8E0;
            --light-red: #FADBD8;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --error-red: #e74c3c;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 12px rgba(255, 107, 53, 0.1);
            --shadow-medium: 0 4px 20px rgba(255, 107, 53, 0.15);
            --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
            --app-padding: 12px;
            --element-radius: 8px;
            --transition-speed: 0.3s;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
            font-size: 14px;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.5s ease;
        }
        
        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .jubel-logo {
            width: 200px;
            height: 200px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            box-shadow: var(--shadow-heavy);
        }
        
        .jubel-logo-text {
            color: var(--white);
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .welcome-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark-gray);
            text-align: center;
        }
        
        .welcome-subtitle {
            font-size: 1rem;
            color: var(--medium-gray);
            margin-bottom: 40px;
            text-align: center;
            max-width: 300px;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .auth-btn {
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-login {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .btn-signup {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
        }
        
        /* Auth Screens */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--white);
            z-index: 900;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }
        
        .auth-screen.active {
            display: block;
        }
        
        .auth-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .back-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            color: var(--dark-gray);
        }
        
        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .form-select {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 1rem;
            background-color: var(--white);
            cursor: pointer;
        }
        
        .vehicle-selection {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .vehicle-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        
        .vehicle-option.selected {
            border-color: var(--primary-orange);
            background: var(--light-orange);
        }
        
        .vehicle-icon {
            font-size: 1.5rem;
            color: var(--medium-gray);
        }
        
        .vehicle-option.selected .vehicle-icon {
            color: var(--primary-orange);
        }
        
        .vehicle-name {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .vehicle-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--light-gray);
        }
        
        .vehicle-details.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .submit-btn {
            padding: 15px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--primary-gradient);
            color: var(--white);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            margin-top: 10px;
        }
        
        .submit-btn:disabled {
            background: var(--medium-gray);
            cursor: not-allowed;
        }
        
        .auth-footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--medium-gray);
        }
        
        .auth-link {
            color: var(--primary-orange);
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Main App */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.8rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 0.9rem;
        }
        
        .online-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 8px 12px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: 2px solid var(--border-color);
            font-size: 0.8rem;
        }
        
        .online-toggle.active {
            border-color: var(--success-green);
            background: var(--success-green);
            color: var(--white);
        }
        
        .online-toggle.offline {
            border-color: var(--medium-gray);
            background: var(--medium-gray);
            color: var(--white);
        }
        
        .driver-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: var(--app-padding);
            transform: translateY(0);
            transition: transform var(--transition-speed) ease;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .driver-panel.collapsed {
            transform: translateY(calc(100% - 50px));
        }
        
        .panel-collapse-handle {
            width: 40px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 0 auto 10px;
            cursor: pointer;
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 0.95rem;
            margin-bottom: 3px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 4px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border: none;
            font-size: 0.65rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 0.9rem;
        }
        
        .ride-action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--white);
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .ride-action-btn.hold-to-start {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-arrive {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-pickup {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-complete {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-active {
            background: var(--primary-gradient);
            color: var(--white);
            border-color: transparent;
        }
        
        .ride-action-btn:active {
            transform: scale(0.98);
        }
        
        .hold-progress {
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .hold-progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.1s linear;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .commission-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--app-padding);
        }
        
        .commission-content {
            background: var(--white);
            border-radius: 15px;
            width: 100%;
            max-width: 360px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform var(--transition-speed) ease;
            animation: popup-appear 0.3s ease forwards;
        }
        
        @keyframes popup-appear {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .commission-header {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 15px;
            text-align: center;
        }
        
        .commission-body {
            padding: 15px;
        }
        
        .commission-details {
            margin-bottom: 15px;
        }
        
        .commission-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .commission-row.total {
            font-weight: 700;
            font-size: 1.1rem;
            border-bottom: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--border-color);
        }
        
        .commission-label {
            color: var(--medium-gray);
        }
        
        .commission-value {
            font-weight: 600;
        }
        
        .commission-value.deduction {
            color: var(--error-red);
        }
        
        .commission-value.earning {
            color: var(--success-green);
        }
        
        .commission-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px;
            background: var(--white);
            z-index: 90;
            padding: var(--app-padding);
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .back-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1rem;
        }
        
        .screen-title {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .earnings-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .input-field {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            font-size: 0.8rem;
            transition: all var(--transition-speed) ease;
            background-color: var(--light-gray);
            color: var(--medium-gray);
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: var(--primary-gradient);
            color: var(--white);
            padding: 12px;
            border-radius: var(--element-radius);
            text-align: center;
            margin-bottom: 12px;
        }
        
        .balance-label {
            font-size: 0.75rem;
            margin-bottom: 3px;
        }
        
        .balance-amount-large {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 8px;
            font-size: 0.75rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
        }
        
        .btn-wallet:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .vehicle-details {
            background: var(--light-orange);
            padding: 12px;
            border-radius: var(--element-radius);
            margin-bottom: 12px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--light-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .earnings-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 12px;
            box-shadow: var(--shadow-light);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .earnings-period {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .period-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: var(--element-radius);
            background: var(--white);
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all var(--transition-speed) ease;
            font-size: 0.75rem;
        }
        
        .period-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
            border-color: transparent;
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .stat-item {
            background: var(--light-orange);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--medium-gray);
        }
        
        .earnings-chart {
            height: 120px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-gradient);
            color: var(--white);
            padding: 10px 16px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.8rem;
            max-width: 80%;
        }
        
        .waypoints-container {
            margin-top: 8px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .waypoint-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
        }
        
        .waypoint-item:last-child {
            border-bottom: none;
        }
        
        .waypoint-icon {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--info-blue);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .waypoint-text {
            flex: 1;
        }
        
        .navigation-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .nav-control-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--element-radius);
            background: var(--info-blue);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.75rem;
        }
        
        .nav-control-btn.secondary {
            background: var(--medium-gray);
        }
        
        .trip-info-card {
            background: var(--white);
            border-radius: var(--element-radius);
            padding: 10px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        
        .trip-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.75rem;
        }
        
        .trip-info-row:last-child {
            margin-bottom: 0;
        }
        
        .trip-info-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .trip-info-value {
            font-weight: 700;
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--warning-yellow);
        }
        
        .commission-display {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.75rem;
        }
        
        .commission-label {
            color: var(--medium-gray);
        }
        
        .commission-value {
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .commission-deduction {
            color: var(--error-red);
        }
        
        .balance-update {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75rem;
        }
        
        .balance-label-update {
            color: var(--medium-gray);
        }
        
        .balance-value-update {
            font-weight: 600;
            color: var(--success-green);
        }
        
        .no-float-warning {
            background-color: var(--light-orange);
            border: 1px solid var(--primary-orange);
            border-radius: var(--element-radius);
            padding: 10px;
            margin-bottom: 12px;
            text-align: center;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        .no-float-warning i {
            margin-right: 6px;
        }
        
        .float-section {
            margin-bottom: 20px;
        }
        
        .float-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        
        .btn-float {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 10px;
            font-size: 0.8rem;
            border-radius: var(--element-radius);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
        }
        
        .btn-float:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .float-history {
            margin-top: 12px;
        }
        
        .float-history-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
        }
        
        .float-history-item:last-child {
            border-bottom: none;
        }
        
        .float-amount {
            font-weight: 600;
        }
        
        .float-amount.positive {
            color: var(--success-green);
        }
        
        .float-amount.negative {
            color: var(--error-red);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--medium-gray);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success-green);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(25px);
        }
        
        .driver-marker {
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .driver-marker-label {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            margin-top: 4px;
            font-size: 9px;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        
        .hold-button-container {
            position: relative;
            width: 100%;
            height: 50px;
            border-radius: var(--element-radius);
            overflow: hidden;
            background: var(--white);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-medium);
        }
        
        .hold-button-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: var(--primary-gradient);
            transition: width 0.1s linear;
            z-index: 1;
        }
        
        .hold-button-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            z-index: 2;
            color: var(--dark-gray);
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .hold-button-content.active {
            color: var(--white);
        }
        
        .advanced-features {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        
        .feature-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: var(--element-radius);
            background: var(--light-gray);
            border: none;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .feature-btn:hover {
            background: var(--light-orange);
        }
        
        .feature-btn i {
            font-size: 1rem;
            color: var(--primary-orange);
        }
        
        .driver-status-indicator {
            position: fixed;
            top: 60px;
            right: 15px;
            background: var(--white);
            padding: 6px 10px;
            border-radius: var(--element-radius);
            box-shadow: var(--shadow-medium);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--medium-gray);
        }
        
        .status-dot.online {
            background: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .quick-actions {
            position: fixed;
            bottom: 70px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .quick-action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .quick-action-btn:hover {
            transform: scale(1.1);
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .collapsible-section {
            margin-bottom: 12px;
        }
        
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-speed) ease;
        }
        
        .collapsible-content.expanded {
            max-height: 500px;
        }
        
        .collapsible-icon {
            transition: transform var(--transition-speed) ease;
        }
        
        .collapsible-icon.expanded {
            transform: rotate(180deg);
        }
        
        .ride-request-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            gap: 8px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .performance-card {
            background: var(--light-gray);
            padding: 10px;
            border-radius: var(--element-radius);
            text-align: center;
        }
        
        .performance-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 3px;
        }
        
        .performance-label {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .ride-queue {
            margin-top: 12px;
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .queue-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .queue-location {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .queue-time {
            font-size: 0.7rem;
            color: var(--medium-gray);
        }
        
        .queue-action {
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--element-radius);
            padding: 5px 10px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .dark-mode-toggle {
            position: fixed;
            bottom: 70px;
            left: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--primary-orange);
            z-index: 100;
        }
        
        .map-controls {
            position: fixed;
            top: 60px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .map-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            box-shadow: var(--shadow-heavy);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--primary-orange);
            transition: all var(--transition-speed) ease;
        }
        
        .map-control-btn:hover {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .logout-btn {
            background: var(--error-red);
            color: var(--white);
            border: none;
            border-radius: var(--element-radius);
            padding: 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            font-weight: 600;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .logout-btn:hover {
            background: var(--secondary-red);
        }
        
        .commission-notification {
            background: var(--light-orange);
            border: 1px solid var(--primary-orange);
            border-radius: var(--element-radius);
            padding: 10px;
            margin-bottom: 12px;
            text-align: center;
            color: var(--primary-orange);
            font-weight: 600;
        }
        
        .commission-notification i {
            margin-right: 6px;
        }
        
        .commission-breakdown {
            margin-top: 15px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: var(--element-radius);
        }
        
        .commission-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-size: 0.8rem;
        }
        
        .commission-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
        }
        
        .commission-item.total {
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
            margin-top: 8px;
            font-weight: 700;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .online-toggle {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            
            .driver-panel {
                padding: 10px;
            }
            
            .nav-buttons {
                gap: 4px;
            }
            
            .nav-btn {
                padding: 6px 3px;
                font-size: 0.6rem;
            }
            
            .commission-content {
                max-height: 95vh;
            }
            
            .quick-actions {
                bottom: 65px;
                right: 10px;
            }
            
            .quick-action-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .dark-mode-toggle {
                bottom: 65px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="jubel-logo">
            <div class="jubel-logo-text">J</div>
        </div>
        <h1 class="welcome-title">Welcome to Jubel Driver</h1>
        <p class="welcome-subtitle">Join our network of professional drivers and start earning today</p>
        <div class="auth-buttons">
            <button class="auth-btn btn-login" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i>
                Log In
            </button>
            <button class="auth-btn btn-signup" id="signupBtn">
                <i class="fas fa-user-plus"></i>
                Sign Up
            </button>
        </div>
    </div>
    
    <!-- Login Screen -->
    <div class="auth-screen" id="loginScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromLogin">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Log In</h2>
        </div>
        
        <form class="auth-form" id="loginForm">
            <div class="form-group">
                <label for="loginEmail" class="form-label">Email Address</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="loginPassword" class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
            </div>
            
            <button type="submit" class="submit-btn">Log In</button>
        </form>
        
        <div class="auth-footer">
            <p>Don't have an account? <span class="auth-link" id="goToSignupFromLogin">Sign Up</span></p>
        </div>
    </div>
    
    <!-- Signup Screen -->
    <div class="auth-screen" id="signupScreen">
        <div class="auth-header">
            <button class="back-button" id="backFromSignup">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="auth-title">Sign Up</h2>
        </div>
        
        <form class="auth-form" id="signupForm">
            <div class="form-group">
                <label for="signupName" class="form-label">Full Name</label>
                <input type="text" id="signupName" class="form-input" placeholder="Your full name" required>
            </div>
            
            <div class="form-group">
                <label for="signupEmail" class="form-label">Email Address</label>
                <input type="email" id="signupEmail" class="form-input" placeholder="your.email@example.com" required>
            </div>
            
            <div class="form-group">
                <label for="signupPhone" class="form-label">Phone Number</label>
                <input type="tel" id="signupPhone" class="form-input" placeholder="Your phone number" required>
            </div>
            
            <div class="form-group">
                <label for="signupNRC" class="form-label">NRC Number</label>
                <input type="text" id="signupNRC" class="form-input" placeholder="Your NRC number" required>
            </div>
            
            <div class="form-group">
                <label for="signupPassword" class="form-label">Password</label>
                <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
            </div>
            
            <div class="form-group">
                <label for="signupConfirmPassword" class="form-label">Confirm Password</label>
                <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required>
            </div>
            
            <h3 class="section-title">Vehicle Information</h3>
            
            <div class="vehicle-selection">
                <div class="vehicle-option" data-type="car">
                    <i class="fas fa-car vehicle-icon"></i>
                    <span class="vehicle-name">Car</span>
                </div>
                <div class="vehicle-option" data-type="bike">
                    <i class="fas fa-motorcycle vehicle-icon"></i>
                    <span class="vehicle-name">Bike</span>
                </div>
                <div class="vehicle-option" data-type="bicycle">
                    <i class="fas fa-bicycle vehicle-icon"></i>
                    <span class="vehicle-name">Bicycle</span>
                </div>
            </div>
            
            <!-- Car Details -->
            <div class="vehicle-details" id="carDetails">
                <div class="form-group">
                    <label for="carMake" class="form-label">Car Make</label>
                    <input type="text" id="carMake" class="form-input" placeholder="Toyota, Honda, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carModel" class="form-label">Car Model</label>
                    <input type="text" id="carModel" class="form-input" placeholder="Corolla, Civic, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carYear" class="form-label">Year</label>
                    <input type="number" id="carYear" class="form-input" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="carColor" class="form-label">Color</label>
                    <input type="text" id="carColor" class="form-input" placeholder="Red, Blue, etc.">
                </div>
                
                <div class="form-group">
                    <label for="carLicensePlate" class="form-label">License Plate</label>
                    <input type="text" id="carLicensePlate" class="form-input" placeholder="ABC 123">
                </div>
                
                <div class="form-group">
                    <label for="carLicenseNumber" class="form-label">Driver's License Number</label>
                    <input type="text" id="carLicenseNumber" class="form-input" placeholder="Your driver's license number">
                </div>
            </div>
            
            <!-- Bike Details -->
            <div class="vehicle-details" id="bikeDetails">
                <div class="form-group">
                    <label for="bikeMake" class="form-label">Bike Make</label>
                    <input type="text" id="bikeMake" class="form-input" placeholder="Honda, Yamaha, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bikeModel" class="form-label">Bike Model</label>
                    <input type="text" id="bikeModel" class="form-input" placeholder="CBR, R15, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bikeYear" class="form-label">Year</label>
                    <input type="number" id="bikeYear" class="form-input" placeholder="2020">
                </div>
                
                <div class="form-group">
                    <label for="bikeLicenseNumber" class="form-label">Driver's License Number</label>
                    <input type="text" id="bikeLicenseNumber" class="form-input" placeholder="Your driver's license number">
                </div>
            </div>
            
            <!-- Bicycle Details -->
            <div class="vehicle-details" id="bicycleDetails">
                <div class="form-group">
                    <label for="bicycleMake" class="form-label">Bicycle Make</label>
                    <input type="text" id="bicycleMake" class="form-input" placeholder="Giant, Trek, etc.">
                </div>
                
                <div class="form-group">
                    <label for="bicycleColor" class="form-label">Color</label>
                    <input type="text" id="bicycleColor" class="form-input" placeholder="Red, Blue, etc.">
                </div>
            </div>
            
            <h3 class="section-title">Payment Information</h3>
            
            <div class="form-group">
                <label for="paymentMethod" class="form-label">Payment Method</label>
                <select id="paymentMethod" class="form-select">
                    <option value="">Select payment method</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="mobile">Mobile Money</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="paymentDetails" class="form-label">Payment Details</label>
                <input type="text" id="paymentDetails" class="form-input" placeholder="Account number or mobile money number">
            </div>
            
            <button type="submit" class="submit-btn" id="signupSubmitBtn">Create Account</button>
        </form>
        
        <div class="auth-footer">
            <p>Already have an account? <span class="auth-link" id="goToLoginFromSignup">Log In</span></p>
        </div>
    </div>
    
    <!-- Main App (Hidden until authentication) -->
    <div id="mainApp" style="display: none;">
        <!-- Main Map -->
        <div id="map"></div>
        
        <!-- Floating Balance -->
        <div class="floating-balance">
            <i class="fas fa-wallet"></i>
            <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
        </div>
        
        <!-- Online Toggle -->
        <div class="online-toggle offline" id="onlineToggle">
            <label class="toggle-switch">
                <input type="checkbox" id="onlineToggleCheckbox">
                <span class="toggle-slider"></span>
            </label>
            <span id="onlineStatusText">Offline</span>
        </div>
        
        <!-- Driver Status Indicator -->
        <div class="driver-status-indicator" id="driverStatusIndicator" style="display: none;">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Offline</span>
        </div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" id="zoomInBtn" title="Zoom In">
                <i class="fas fa-plus"></i>
            </button>
            <button class="map-control-btn" id="zoomOutBtn" title="Zoom Out">
                <i class="fas fa-minus"></i>
            </button>
            <button class="map-control-btn" id="mapTypeBtn" title="Change Map Type">
                <i class="fas fa-layer-group"></i>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-action-btn" id="centerMapBtn" title="Center Map">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="quick-action-btn" id="refreshLocationBtn" title="Refresh Location">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="quick-action-btn" id="toggleTrafficBtn" title="Toggle Traffic">
                <i class="fas fa-traffic-light"></i>
            </button>
        </div>
        
        <!-- Dark Mode Toggle -->
        <button class="dark-mode-toggle" id="darkModeToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Driver Panel -->
        <div class="driver-panel" id="driverPanel">
            <div class="panel-collapse-handle" id="panelCollapseHandle"></div>
            
            <div class="driver-info">
                <div class="driver-avatar" id="driverAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="driver-details">
                    <h2 id="driverName">Driver Name</h2>
                    <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                    <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
                </div>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn active" data-screen="home">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" data-screen="account">
                    <i class="fas fa-user"></i>
                    <span>Account</span>
                </button>
                <button class="nav-btn" data-screen="history">
                    <i class="fas fa-history"></i>
                    <span>History</span>
                </button>
                <button class="nav-btn" data-screen="earnings">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Earnings</span>
                </button>
            </div>
            
            <!-- Collapsible Driver Details -->
            <div class="collapsible-section">
                <div class="collapsible-header" id="driverDetailsHeader">
                    <h3>Driver Details</h3>
                    <i class="fas fa-chevron-down collapsible-icon" id="driverDetailsIcon"></i>
                </div>
                <div class="collapsible-content" id="driverDetailsContent">
                    <div class="performance-stats">
                        <div class="performance-card">
                            <div class="performance-value" id="totalTrips">0</div>
                            <div class="performance-label">Total Trips</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="ratingScore">4.5</div>
                            <div class="performance-label">Rating</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="onlineTime">0h</div>
                            <div class="performance-label">Online Time</div>
                        </div>
                        <div class="performance-card">
                            <div class="performance-value" id="acceptanceRate">0%</div>
                            <div class="performance-label">Acceptance</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Commission Notification -->
            <div class="commission-notification" id="commissionNotification" style="display: none;">
                <i class="fas fa-info-circle"></i>
                <span id="commissionNotificationText">Commission will be deducted from your earnings</span>
            </div>
            
            <!-- Ride Action Button (Hidden until ride request) -->
            <div class="hold-button-container" id="rideActionBtn" style="display: none;">
                <div class="hold-button-fill" id="holdButtonFill"></div>
                <div class="hold-button-content" id="holdButtonContent">
                    <i class="fas fa-play-circle"></i>
                    <span>Hold to Start Ride</span>
                </div>
            </div>
            
            <!-- Advanced Features Section -->
            <div class="advanced-features" id="advancedFeatures" style="display: none;">
                <button class="feature-btn" id="navigateToPickupBtn">
                    <i class="fas fa-directions"></i>
                    <span>Navigate to Pickup</span>
                </button>
                <button class="feature-btn" id="contactCustomerBtn">
                    <i class="fas fa-phone"></i>
                    <span>Contact Customer</span>
                </button>
                <button class="feature-btn" id="viewRouteDetailsBtn">
                    <i class="fas fa-route"></i>
                    <span>View Route Details</span>
                </button>
            </div>
        </div>
        
        <!-- Commission Popup -->
        <div class="commission-popup" id="commissionPopup">
            <div class="commission-content">
                <div class="commission-header">
                    <h3>Commission Deduction</h3>
                </div>
                <div class="commission-body">
                    <div class="commission-details">
                        <div class="commission-row">
                            <span class="commission-label">Total Fare</span>
                            <span class="commission-value" id="commissionTotalFare">K0.00</span>
                        </div>
                        <div class="commission-row">
                            <span class="commission-label">Commission (8%)</span>
                            <span class="commission-value deduction" id="commissionAmount">-K0.00</span>
                        </div>
                        <div class="commission-row total">
                            <span class="commission-label">Your Earnings</span>
                            <span class="commission-value earning" id="commissionEarnings">K0.00</span>
                        </div>
                    </div>
                    <div class="commission-breakdown">
                        <div class="commission-title">Commission Breakdown:</div>
                        <div class="commission-item">
                            <span>Platform Fee</span>
                            <span>5%</span>
                        </div>
                        <div class="commission-item">
                            <span>Service Fee</span>
                            <span>3%</span>
                        </div>
                        <div class="commission-item total">
                            <span>Total Commission</span>
                            <span>8%</span>
                        </div>
                    </div>
                </div>
                <div class="commission-footer">
                    <button class="btn btn-accept" id="commissionCloseBtn">
                        <i class="fas fa-check"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Screen Contents -->
        <div class="screen-content" id="homeScreen">
            <!-- Home screen is the map, so this is empty -->
        </div>
        
        <div class="screen-content" id="accountScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Account</h2>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    Driver Details
                </h3>
                <div class="input-group">
                    <label for="driverNameInput">Full Name</label>
                    <input type="text" id="driverNameInput" class="input-field" placeholder="Your full name" readonly>
                </div>
                <div class="input-group">
                    <label for="driverPhoneInput">Phone Number</label>
                    <input type="tel" id="driverPhoneInput" class="input-field" placeholder="Your phone number" readonly>
                </div>
                <div class="input-group">
                    <label for="driverEmailInput">Email Address</label>
                    <input type="email" id="driverEmailInput" class="input-field" placeholder="Your email address" readonly>
                </div>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-car"></i>
                    Vehicle Details
                </h3>
                <div class="input-group">
                    <label for="vehicleTypeInput">Vehicle Type</label>
                    <input type="text" id="vehicleTypeInput" class="input-field" placeholder="Car, Bike, etc." readonly>
                </div>
                <div class="input-group">
                    <label for="vehicleModelInput">Vehicle Model</label>
                    <input type="text" id="vehicleModelInput" class="input-field" placeholder="Toyota Corolla, etc." readonly>
                </div>
                <div class="input-group">
                    <label for="licensePlateInput">License Plate</label>
                    <input type="text" id="licensePlateInput" class="input-field" placeholder="ABC 123" readonly>
                </div>
                <div class="input-group">
                    <label for="vehicleColorInput">Vehicle Color</label>
                    <input type="text" id="vehicleColorInput" class="input-field" placeholder="Red, Blue, etc." readonly>
                </div>
            </div>
            
            <div class="account-section">
                <h3 class="section-title">
                    <i class="fas fa-wallet"></i>
                    Wallet & Balance
                </h3>
                <div class="wallet-balance">
                    <div class="balance-label">Available Balance</div>
                    <div class="balance-amount-large" id="accountBalance">K0.00</div>
                    <div>Add funds to receive ride requests</div>
                </div>
                
                <div class="wallet-actions">
                    <button class="btn-wallet" id="addFundsBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Funds
                    </button>
                    <button class="btn-wallet" id="withdrawFundsBtn">
                        <i class="fas fa-minus-circle"></i>
                        Withdraw
                    </button>
                </div>
                
                <div class="vehicle-details">
                    <div class="detail-row">
                        <span class="detail-label">Total Earnings</span>
                        <span class="detail-value" id="totalEarnings">K0.00</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Completed Rides</span>
                        <span class="detail-value" id="completedRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Cancelled Rides</span>
                        <span class="detail-value" id="cancelledRides">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Rating</span>
                        <span class="detail-value" id="driverRating">4.5 </span>
                    </div>
                </div>
            </div>
            
            <!-- Float Management Section -->
            <div class="float-section">
                <h3 class="section-title">
                    <i class="fas fa-money-bill-alt"></i>
                    Float Management
                </h3>
                <div class="wallet-balance">
                    <div class="balance-label">Current Float Balance</div>
                    <div class="balance-amount-large" id="floatBalance">K0.00</div>
                    <div>Minimum K10.00 required to go online</div>
                </div>
                
                <div class="float-actions">
                    <button class="btn-float" id="addFloatBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Float
                    </button>
                    <button class="btn-float" id="adjustFloatBtn">
                        <i class="fas fa-exchange-alt"></i>
                        Adjust Float
                    </button>
                </div>
                
                <div class="float-history">
                    <h4 class="section-title">Float History</h4>
                    <div id="floatHistoryList">
                        <!-- Float history items will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Logout Button -->
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                Log Out
            </button>
        </div>
        
        <div class="screen-content" id="historyScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Ride History</h2>
            </div>
            
            <div class="history-section">
                <div id="historyList">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="screen-content" id="earningsScreen">
            <div class="screen-header">
                <button class="back-button" data-screen="home">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 class="screen-title">Earnings</h2>
            </div>
            
            <div class="earnings-section">
                <div class="earnings-period">
                    <button class="period-btn active" data-period="today">Today</button>
                    <button class="period-btn" data-period="week">This Week</button>
                    <button class="period-btn" data-period="month">This Month</button>
                </div>
                
                <div class="earnings-card">
                    <div class="earnings-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="earningsTotal">K0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="ridesCompleted">0</div>
                            <div class="stat-label">Rides Completed</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgEarning">K0.00</div>
                            <div class="stat-label">Avg per Ride</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="onlineHours">0h</div>
                            <div class="stat-label">Online Time</div>
                        </div>
                    </div>
                    
                    <div class="earnings-chart">
                        Earnings chart would appear here
                    </div>
                    
                    <button class="btn-wallet" id="withdrawEarningsBtn">
                        <i class="fas fa-download"></i>
                        Withdraw Earnings
                    </button>
                </div>
                
                <h3 class="section-title">
                    <i class="fas fa-receipt"></i>
                    Recent Earnings
                </h3>
                <div id="earningsList">
                    <!-- Earnings items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let isOnline = false;
        let driverMap;
        let locationWatchId = null;
        let driverMarker = null;
        let customerMarker = null;
        let destinationMarker = null;
        let routePolyline = null;
        let holdTimer = null;
        let holdProgress = 0;
        let currentRideRequest = null;
        let earningsPeriod = 'today';
        let waypoints = [];
        let floatBalance = 0;
        let walletBalance = 0;
        let commissionRate = 0.08; // 8% commission
        let trafficLayer = null;
        let trafficEnabled = false;
        let mapType = 'standard';
        let isDarkMode = false;
        let floatHistory = [];
        let selectedVehicleType = '';
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            setupAuthEventListeners();
        });
        
        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showMainApp();
                    initializeMap();
                    setupEventListeners();
                    loadDriverData();
                    initializeAdvancedFeatures();
                } else {
                    // Show welcome screen
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                }
            });
        }
        
        // Show main app after authentication
        function showMainApp() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('signupScreen').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';
        }
        
        // Setup authentication event listeners
        function setupAuthEventListeners() {
            // Welcome screen buttons
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            document.getElementById('signupBtn').addEventListener('click', () => {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('signupScreen').classList.add('active');
            });
            
            // Back buttons
            document.getElementById('backFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            document.getElementById('backFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('welcomeScreen').classList.remove('hidden');
            });
            
            // Navigation between auth screens
            document.getElementById('goToSignupFromLogin').addEventListener('click', () => {
                document.getElementById('loginScreen').classList.remove('active');
                document.getElementById('signupScreen').classList.add('active');
            });
            
            document.getElementById('goToLoginFromSignup').addEventListener('click', () => {
                document.getElementById('signupScreen').classList.remove('active');
                document.getElementById('loginScreen').classList.add('active');
            });
            
            // Vehicle selection
            document.querySelectorAll('.vehicle-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.vehicle-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Hide all vehicle details
                    document.querySelectorAll('.vehicle-details').forEach(details => {
                        details.classList.remove('active');
                    });
                    
                    // Show selected vehicle details
                    selectedVehicleType = this.getAttribute('data-type');
                    document.getElementById(selectedVehicleType + 'Details').classList.add('active');
                });
            });
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        // Signed in successfully
                        showNotification('Login successful!');
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        showNotification('Login failed: ' + error.message);
                    });
            });
            
            // Signup form submission
            document.getElementById('signupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate passwords match
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match');
                    return;
                }
                
                // Validate vehicle type is selected
                if (!selectedVehicleType) {
                    showNotification('Please select a vehicle type');
                    return;
                }
                
                const email = document.getElementById('signupEmail').value;
                const name = document.getElementById('signupName').value;
                const phone = document.getElementById('signupPhone').value;
                const nrc = document.getElementById('signupNRC').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentDetails = document.getElementById('paymentDetails').value;
                
                // Create user with email and password
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        
                        // Prepare vehicle data based on selected type
                        let vehicleData = {};
                        if (selectedVehicleType === 'car') {
                            vehicleData = {
                                type: 'car',
                                make: document.getElementById('carMake').value,
                                model: document.getElementById('carModel').value,
                                year: document.getElementById('carYear').value,
                                color: document.getElementById('carColor').value,
                                licensePlate: document.getElementById('carLicensePlate').value,
                                licenseNumber: document.getElementById('carLicenseNumber').value
                            };
                        } else if (selectedVehicleType === 'bike') {
                            vehicleData = {
                                type: 'bike',
                                make: document.getElementById('bikeMake').value,
                                model: document.getElementById('bikeModel').value,
                                year: document.getElementById('bikeYear').value,
                                licenseNumber: document.getElementById('bikeLicenseNumber').value
                            };
                        } else if (selectedVehicleType === 'bicycle') {
                            vehicleData = {
                                type: 'bicycle',
                                make: document.getElementById('bicycleMake').value,
                                color: document.getElementById('bicycleColor').value
                            };
                        }
                        
                        // Save user data to Firebase
                        return database.ref('users/' + user.uid).set({
                            name: name,
                            email: email,
                            phone: phone,
                            nrc: nrc,
                            vehicle: vehicleData,
                            payment: {
                                method: paymentMethod,
                                details: paymentDetails
                            },
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            isOnline: false,
                            walletBalance: 0,
                            floatBalance: 0
                        });
                    })
                    .then(() => {
                        showNotification('Account created successfully!');
                    })
                    .catch((error) => {
                        console.error('Signup error:', error);
                        showNotification('Signup failed: ' + error.message);
                    });
            });
        }
        
        // Map initialization
        function initializeMap() {
            // Main driver map
            driverMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            
            // Use a clean map style without colors around the car
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            }).addTo(driverMap);
            
            // Get driver's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 15);
                    
                    // Add marker for driver location (without orange border)
                    driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<div class="driver-marker"></div><div class="driver-marker-label">You</div>',
                            iconSize: [35, 50]
                        })
                    }).addTo(driverMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Update driver location in Firebase
        function updateDriverLocation(lat, lng) {
            if (currentUser && isOnline) {
                database.ref('driverLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    vehicleType: selectedVehicleType
                });
                
                // Update marker position
                if (driverMarker) {
                    driverMarker.setLatLng([lat, lng]);
                }
            }
        }
        
        // Start tracking driver location
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateDriverLocation(lat, lng);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking driver location
        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Online toggle
            document.getElementById('onlineToggleCheckbox').addEventListener('change', toggleOnlineStatus);
            
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                    
                    // Reload map when home is clicked
                    if (screen === 'home') {
                        refreshDriverPosition();
                    }
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                    // Refresh driver position when returning to home
                    if (screen === 'home') {
                        refreshDriverPosition();
                    }
                });
            });
            
            // Ride action button (hold functionality)
            const rideActionBtn = document.getElementById('rideActionBtn');
            
            rideActionBtn.addEventListener('mousedown', startHoldTimer);
            rideActionBtn.addEventListener('touchstart', startHoldTimer);
            
            rideActionBtn.addEventListener('mouseup', cancelHoldTimer);
            rideActionBtn.addEventListener('touchend', cancelHoldTimer);
            rideActionBtn.addEventListener('mouseleave', cancelHoldTimer);
            
            // Account actions
            document.getElementById('addFundsBtn').addEventListener('click', addFunds);
            document.getElementById('withdrawFundsBtn').addEventListener('click', withdrawFunds);
            
            // Float actions
            document.getElementById('addFloatBtn').addEventListener('click', addFloat);
            document.getElementById('adjustFloatBtn').addEventListener('click', adjustFloat);
            
            // Earnings period selection
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    earningsPeriod = this.getAttribute('data-period');
                    loadEarnings();
                });
            });
            
            // Withdraw earnings
            document.getElementById('withdrawEarningsBtn').addEventListener('click', withdrawEarnings);
            
            // Advanced features
            document.getElementById('navigateToPickupBtn').addEventListener('click', navigateToPickup);
            document.getElementById('contactCustomerBtn').addEventListener('click', contactCustomer);
            document.getElementById('viewRouteDetailsBtn').addEventListener('click', viewRouteDetails);
            
            // Quick actions
            document.getElementById('centerMapBtn').addEventListener('click', centerMap);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshDriverPosition);
            document.getElementById('toggleTrafficBtn').addEventListener('click', toggleTraffic);
            
            // Map controls
            document.getElementById('zoomInBtn').addEventListener('click', () => driverMap.zoomIn());
            document.getElementById('zoomOutBtn').addEventListener('click', () => driverMap.zoomOut());
            document.getElementById('mapTypeBtn').addEventListener('click', toggleMapType);
            
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
            
            // Panel collapse
            document.getElementById('panelCollapseHandle').addEventListener('click', togglePanelCollapse);
            
            // Collapsible sections
            document.getElementById('driverDetailsHeader').addEventListener('click', toggleDriverDetails);
            
            // Commission popup
            document.getElementById('commissionCloseBtn').addEventListener('click', closeCommissionPopup);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logout);
        }
        
        // Initialize advanced features
        function initializeAdvancedFeatures() {
            // Initialize performance stats
            updatePerformanceStats();
            
            // Set up periodic updates
            setInterval(updatePerformanceStats, 30000); // Update every 30 seconds
        }
        
        // Update performance statistics
        function updatePerformanceStats() {
            if (currentUser) {
                // In a real app, this would fetch actual data from Firebase
                // For demo purposes, we'll use simulated data
                document.getElementById('totalTrips').textContent = Math.floor(Math.random() * 100) + 50;
                document.getElementById('ratingScore').textContent = (4 + Math.random()).toFixed(1);
                document.getElementById('onlineTime').textContent = Math.floor(Math.random() * 10) + 1 + 'h';
                document.getElementById('acceptanceRate').textContent = Math.floor(Math.random() * 30) + 70 + '%';
            }
        }
        
        // Toggle panel collapse
        function togglePanelCollapse() {
            const panel = document.getElementById('driverPanel');
            panel.classList.toggle('collapsed');
        }
        
        // Toggle driver details
        function toggleDriverDetails() {
            const content = document.getElementById('driverDetailsContent');
            const icon = document.getElementById('driverDetailsIcon');
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }
        
        // Toggle map type
        function toggleMapType() {
            // Remove current tile layer
            driverMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    driverMap.removeLayer(layer);
                }
            });
            
            // Add new tile layer based on current map type
            if (mapType === 'standard') {
                // Switch to satellite
                L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenTopoMap contributors'
                }).addTo(driverMap);
                mapType = 'satellite';
                showNotification('Switched to satellite view');
            } else {
                // Switch back to standard
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(driverMap);
                mapType = 'standard';
                showNotification('Switched to standard view');
            }
        }
        
        // Toggle dark mode
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const body = document.body;
            const darkModeToggle = document.getElementById('darkModeToggle');
            
            if (isDarkMode) {
                body.style.backgroundColor = '#1a1a1a';
                body.style.color = '#ffffff';
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeToggle.style.background = '#333';
                darkModeToggle.style.color = '#ffcc00';
                showNotification('Dark mode enabled');
            } else {
                body.style.backgroundColor = '';
                body.style.color = '';
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeToggle.style.background = '';
                darkModeToggle.style.color = '';
                showNotification('Dark mode disabled');
            }
        }
        
        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            // Load data for specific screens
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'earnings') {
                loadEarnings();
            } else if (screenId === 'account') {
                loadFloatHistory();
            }
        }
        
        // Toggle online status
        function toggleOnlineStatus() {
            isOnline = !isOnline;
            const onlineToggle = document.getElementById('onlineToggle');
            const onlineStatusText = document.getElementById('onlineStatusText');
            const statusIndicator = document.getElementById('driverStatusIndicator');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                // Check if float balance is sufficient
                if (floatBalance < 10) {
                    showNotification('Cannot go online. Your float balance is below minimum K10.00. Please add float.');
                    isOnline = false;
                    document.getElementById('onlineToggleCheckbox').checked = false;
                    return;
                }
                
                onlineToggle.classList.remove('offline');
                onlineToggle.classList.add('active');
                onlineStatusText.textContent = 'Online';
                
                // Show status indicator
                statusIndicator.style.display = 'flex';
                statusDot.classList.add('online');
                statusText.textContent = 'Online';
                
                // Show commission notification
                document.getElementById('commissionNotification').style.display = 'block';
                
                // Start location tracking
                startLocationTracking();
                
                // Listen for ride requests
                listenForRideRequests();
                
                showNotification('You are now online and receiving ride requests.');
            } else {
                onlineToggle.classList.remove('active');
                onlineToggle.classList.add('offline');
                onlineStatusText.textContent = 'Offline';
                
                // Hide status indicator
                statusIndicator.style.display = 'none';
                statusDot.classList.remove('online');
                
                // Hide commission notification
                document.getElementById('commissionNotification').style.display = 'none';
                
                // Stop location tracking
                stopLocationTracking();
                
                showNotification('You are now offline.');
            }
            
            // Update driver status in Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    isOnline: isOnline,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Listen for ride requests
        function listenForRideRequests() {
            // Simulate receiving a ride request after a delay
            setTimeout(() => {
                if (isOnline && !currentRide) {
                    // Create a simulated ride request
                    const rideRequest = {
                        id: 'ride_' + Date.now(),
                        passengerName: 'John Smith',
                        passengerPhone: '+260 97 123 4567',
                        passengerRating: '4.8',
                        pickupLocation: '123 Main Street, Lusaka',
                        destination: '456 Oak Avenue, Lusaka',
                        distance: '5.2 km',
                        estimatedTime: '15 min',
                        surgeMultiplier: '1.0x',
                        fare: 18.00
                    };
                    
                    // Show commission notification
                    showCommissionNotification(rideRequest);
                }
            }, 5000); // Show after 5 seconds for demo
        }
        
        // Show commission notification for a ride
        function showCommissionNotification(rideRequest) {
            currentRideRequest = rideRequest;
            
            // Calculate commission
            const commission = rideRequest.fare * commissionRate;
            const driverEarnings = rideRequest.fare - commission;
            
            // Update notification text
            document.getElementById('commissionNotificationText').textContent = 
                `New ride available! You'll earn K${driverEarnings.toFixed(2)} after commission`;
            
            // Show ride action button
            document.getElementById('rideActionBtn').style.display = 'block';
            
            // Update ride action button
            updateRideActionButton('hold-to-start');
            
            // Update driver panel for active ride
            updateDriverPanelForActiveRide();
            
            // Update map for active ride
            updateMapForActiveRide();
            
            showNotification('New ride request received!');
        }
        
        // Update driver panel for active ride
        function updateDriverPanelForActiveRide() {
            if (currentRideRequest) {
                // Update driver details with customer info
                document.getElementById('driverName').textContent = currentRideRequest.passengerName || 'Passenger';
                document.getElementById('driverPhone').textContent = currentRideRequest.passengerPhone || 'N/A';
                
                // Update vehicle details with trip info
                document.getElementById('vehicleDetails').textContent = `To: ${currentRideRequest.destination}`;
                
                // Show advanced features
                document.getElementById('advancedFeatures').style.display = 'flex';
            }
        }
        
        // Update map for active ride
        function updateMapForActiveRide() {
            if (currentRideRequest) {
                // Clear existing markers and routes
                if (customerMarker) {
                    driverMap.removeLayer(customerMarker);
                    customerMarker = null;
                }
                if (destinationMarker) {
                    driverMap.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routePolyline) {
                    driverMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
                
                // Get driver's current position
                const driverLatLng = driverMarker.getLatLng();
                
                // Generate pickup location (slightly offset from driver)
                const pickupLat = driverLatLng.lat + 0.01;
                const pickupLng = driverLatLng.lng + 0.01;
                
                // Generate destination (further away)
                const destLat = driverLatLng.lat + 0.03;
                const destLng = driverLatLng.lng + 0.03;
                
                // Add customer pickup marker
                customerMarker = L.marker([pickupLat, pickupLng], {
                    icon: L.divIcon({
                        className: 'customer-marker',
                        html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Customer</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Customer Pickup Location');
                
                // Add destination marker
                destinationMarker = L.marker([destLat, destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div style="background: #E74C3C; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div><div style="background: white; padding: 2px 5px; border-radius: 8px; margin-top: 4px; font-size: 8px; font-weight: bold;">Destination</div>',
                        iconSize: [25, 40]
                    })
                }).addTo(driverMap).bindPopup('Destination');
                
                // Draw route from driver to customer
                drawRoute(driverLatLng.lat, driverLatLng.lng, pickupLat, pickupLng);
                
                // Fit map to show driver, customer and destination with appropriate zoom
                const bounds = L.latLngBounds(
                    [driverLatLng.lat, driverLatLng.lng],
                    [pickupLat, pickupLng]
                );
                
                driverMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        // Draw route on main map
        function drawRoute(startLat, startLng, endLat, endLng) {
            // Remove existing route if any
            if (routePolyline) {
                driverMap.removeLayer(routePolyline);
            }
            
            // Draw a straight line for demo purposes
            // In a real app, you would use a routing service
            routePolyline = L.polyline([
                [startLat, startLng],
                [endLat, endLng]
            ], {
                color: '#FF6B35',
                weight: 4,
                opacity: 0.7
            }).addTo(driverMap);
        }
        
        // Update ride action button based on ride status
        function updateRideActionButton(action) {
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            // Reset hold progress
            holdProgress = 0;
            const holdButtonFill = document.getElementById('holdButtonFill');
            if (holdButtonFill) {
                holdButtonFill.style.width = '0%';
            }
            
            switch(action) {
                case 'hold-to-start':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-play-circle"></i>
                        <span>Hold to Start Ride</span>
                    `;
                    break;
                case 'hold-to-arrive':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Hold to Arrive</span>
                    `;
                    break;
                case 'hold-to-pickup':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-user-check"></i>
                        <span>Hold to Pickup</span>
                    `;
                    break;
                case 'hold-to-complete':
                    holdButtonContent.innerHTML = `
                        <i class="fas fa-flag-checkered"></i>
                        <span>Hold to Complete</span>
                    `;
                    break;
            }
        }
        
        // Start hold timer for ride actions
        function startHoldTimer() {
            if (holdTimer) return;
            
            // Add active class to change button text color to white
            const holdButtonContent = document.getElementById('holdButtonContent');
            holdButtonContent.classList.add('active');
            
            holdTimer = setInterval(() => {
                holdProgress += 3.33; // 3 seconds total = 100%
                const holdButtonFill = document.getElementById('holdButtonFill');
                
                if (holdButtonFill) {
                    holdButtonFill.style.width = `${holdProgress}%`;
                }
                
                if (holdProgress >= 100) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                    completeHoldAction();
                }
            }, 100);
        }
        
        // Cancel hold timer
        function cancelHoldTimer() {
            if (holdTimer) {
                clearInterval(holdTimer);
                holdTimer = null;
                holdProgress = 0;
                
                // Remove active class to revert button text color
                const holdButtonContent = document.getElementById('holdButtonContent');
                holdButtonContent.classList.remove('active');
                
                const holdButtonFill = document.getElementById('holdButtonFill');
                if (holdButtonFill) {
                    holdButtonFill.style.width = '0%';
                }
            }
        }
        
        // Complete hold action based on current ride state
        function completeHoldAction() {
            if (!currentRideRequest) return;
            
            const holdButtonContent = document.getElementById('holdButtonContent');
            
            if (holdButtonContent.innerHTML.includes('Start Ride')) {
                // Start the ride
                currentRide = {
                    id: currentRideRequest.id,
                    ...currentRideRequest,
                    status: 'started'
                };
                
                updateRideActionButton('hold-to-arrive');
                showNotification('Ride started. Heading to pickup location.');
                
                // Update map to show route from driver to destination
                if (driverMarker && destinationMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    const destLatLng = destinationMarker.getLatLng();
                    drawRoute(driverLatLng.lat, driverLatLng.lng, destLatLng.lat, destLatLng.lng);
                }
            } else if (holdButtonContent.innerHTML.includes('Arrive')) {
                // Mark arrived
                currentRide.status = 'arrived';
                updateRideActionButton('hold-to-pickup');
                showNotification('Arrival marked. Waiting for passenger.');
            } else if (holdButtonContent.innerHTML.includes('Pickup')) {
                // Mark pickup
                currentRide.status = 'picked_up';
                updateRideActionButton('hold-to-complete');
                showNotification('Passenger picked up. Starting trip.');
                
                // Update driver details back to driver info
                document.getElementById('driverName').textContent = document.getElementById('driverNameInput').value || 'Driver Name';
                document.getElementById('driverPhone').textContent = document.getElementById('driverPhoneInput').value || '000-000-0000';
                document.getElementById('vehicleDetails').textContent = 
                    `${document.getElementById('vehicleTypeInput').value || 'Vehicle'} - ${document.getElementById('licensePlateInput').value || 'ABC123'}`;
            } else if (holdButtonContent.innerHTML.includes('Complete')) {
                // Complete ride
                currentRide.status = 'completed';
                
                // Calculate commission and earnings
                const totalFare = currentRideRequest.fare;
                const commission = totalFare * commissionRate;
                const driverEarnings = totalFare - commission;
                
                // Show commission popup
                showCommissionPopup(totalFare, commission, driverEarnings);
                
                // Update float balance
                const newFloatBalance = floatBalance + driverEarnings;
                updateFloatBalance(newFloatBalance);
                
                // Add float history entry
                addFloatHistoryEntry('earnings', driverEarnings, `Earnings from ride ${currentRide.id}`);
                
                // Reset ride state
                currentRide = null;
                currentRideRequest = null;
                
                // Hide ride action button and advanced features
                document.getElementById('rideActionBtn').style.display = 'none';
                document.getElementById('advancedFeatures').style.display = 'none';
                
                // Clear map markers and routes
                if (customerMarker) {
                    driverMap.removeLayer(customerMarker);
                    customerMarker = null;
                }
                if (destinationMarker) {
                    driverMap.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routePolyline) {
                    driverMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
            }
        }
        
        // Show commission popup
        function showCommissionPopup(totalFare, commission, earnings) {
            document.getElementById('commissionTotalFare').textContent = `K${totalFare.toFixed(2)}`;
            document.getElementById('commissionAmount').textContent = `-K${commission.toFixed(2)}`;
            document.getElementById('commissionEarnings').textContent = `K${earnings.toFixed(2)}`;
            
            document.getElementById('commissionPopup').style.display = 'flex';
        }
        
        // Close commission popup
        function closeCommissionPopup() {
            document.getElementById('commissionPopup').style.display = 'none';
            showNotification(`Ride completed! K${earnings.toFixed(2)} added to your balance. New balance: K${floatBalance.toFixed(2)}`);
        }
        
        // Update float balance
        function updateFloatBalance(newBalance) {
            floatBalance = newBalance;
            
            // Update UI
            document.getElementById('walletBalance').textContent = `K${floatBalance.toFixed(2)}`;
            document.getElementById('accountBalance').textContent = `K${floatBalance.toFixed(2)}`;
            document.getElementById('floatBalance').textContent = `K${floatBalance.toFixed(2)}`;
            
            // Save to Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    floatBalance: floatBalance
                });
            }
            
            // Check if balance is below minimum and show warning if needed
            if (floatBalance < 10) {
                showNoFloatWarning();
                
                // If driver is online, force them offline
                if (isOnline) {
                    document.getElementById('onlineToggleCheckbox').checked = false;
                    toggleOnlineStatus();
                }
            }
        }
        
        // Show no float warning
        function showNoFloatWarning() {
            // Check if warning already exists
            if (document.querySelector('.no-float-warning')) {
                return;
            }
            
            const warning = document.createElement('div');
            warning.className = 'no-float-warning';
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Your float balance is below minimum K10.00. You cannot receive ride requests until you add float.
            `;
            
            // Insert warning at the top of the account screen
            const accountScreen = document.getElementById('accountScreen');
            const firstChild = accountScreen.firstChild;
            accountScreen.insertBefore(warning, firstChild);
        }
        
        // Add float to account
        function addFloat() {
            const amount = prompt('Enter amount to add to your float (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = floatBalance + addAmount;
                
                // Update balance
                updateFloatBalance(newBalance);
                
                // Add float history entry
                addFloatHistoryEntry('deposit', addAmount, 'Float deposit');
                
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your float.`);
                
                // Remove warning if balance is now sufficient
                if (newBalance >= 10) {
                    const warning = document.querySelector('.no-float-warning');
                    if (warning) {
                        warning.remove();
                    }
                }
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Adjust float (withdraw)
        function adjustFloat() {
            if (floatBalance <= 0) {
                showNotification('Your float balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw from float (K). Available: K${floatBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > floatBalance) {
                    showNotification('Insufficient float balance for this withdrawal.');
                    return;
                }
                
                const newBalance = floatBalance - withdrawAmount;
                updateFloatBalance(newBalance);
                
                // Add float history entry
                addFloatHistoryEntry('withdrawal', -withdrawAmount, 'Float withdrawal');
                
                showNotification(`Float withdrawal of K${withdrawAmount.toFixed(2)} processed.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Add float history entry
        function addFloatHistoryEntry(type, amount, description) {
            const historyEntry = {
                type: type,
                amount: amount,
                description: description,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                balance: floatBalance
            };
            
            // Add to local array
            floatHistory.unshift(historyEntry);
            
            // Save to Firebase
            if (currentUser) {
                database.ref('floatHistory/' + currentUser.uid).push(historyEntry);
            }
            
            // Update UI
            updateFloatHistoryDisplay();
        }
        
        // Load float history
        function loadFloatHistory() {
            if (currentUser) {
                database.ref('floatHistory/' + currentUser.uid).orderByChild('timestamp').limitToLast(10).once('value')
                    .then(snapshot => {
                        const history = snapshot.val();
                        floatHistory = [];
                        
                        if (history) {
                            // Convert to array and sort by timestamp (newest first)
                            Object.keys(history).forEach(key => {
                                floatHistory.unshift({
                                    id: key,
                                    ...history[key]
                                });
                            });
                        }
                        
                        updateFloatHistoryDisplay();
                    })
                    .catch(error => {
                        console.error('Error loading float history:', error);
                    });
            }
        }
        
        // Update float history display
        function updateFloatHistoryDisplay() {
            const floatHistoryList = document.getElementById('floatHistoryList');
            floatHistoryList.innerHTML = '';
            
            if (floatHistory.length > 0) {
                floatHistory.forEach(entry => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'float-history-item';
                    
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const amountClass = entry.amount > 0 ? 'positive' : 'negative';
                    const amountSign = entry.amount > 0 ? '+' : '';
                    
                    historyItem.innerHTML = `
                        <div>
                            <div>${entry.description}</div>
                            <div style="font-size: 0.6rem; color: var(--medium-gray);">${formattedDate} ${formattedTime}</div>
                        </div>
                        <div class="float-amount ${amountClass}">${amountSign}K${Math.abs(entry.amount).toFixed(2)}</div>
                    `;
                    
                    floatHistoryList.appendChild(historyItem);
                });
            } else {
                floatHistoryList.innerHTML = '<p style="text-align: center; padding: 10px; color: var(--medium-gray);">No float history found.</p>';
            }
        }
        
        // Load driver data
        function loadDriverData() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            // Update form fields
                            document.getElementById('driverNameInput').value = userData.name || '';
                            document.getElementById('driverPhoneInput').value = userData.phone || '';
                            document.getElementById('driverEmailInput').value = userData.email || '';
                            
                            // Update vehicle data
                            if (userData.vehicle) {
                                selectedVehicleType = userData.vehicle.type;
                                document.getElementById('vehicleTypeInput').value = userData.vehicle.type || '';
                                document.getElementById('vehicleModelInput').value = userData.vehicle.model || '';
                                document.getElementById('licensePlateInput').value = userData.vehicle.licensePlate || '';
                                document.getElementById('vehicleColorInput').value = userData.vehicle.color || '';
                            }
                            
                            // Update display
                            document.getElementById('driverName').textContent = userData.name || 'Driver Name';
                            document.getElementById('driverPhone').textContent = userData.phone || '000-000-0000';
                            document.getElementById('vehicleDetails').textContent = 
                                `${userData.vehicle?.type || 'Vehicle'} - ${userData.vehicle?.licensePlate || 'ABC123'}`;
                            
                            // Update wallet balance
                            floatBalance = userData.floatBalance || 0;
                            document.getElementById('walletBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            document.getElementById('accountBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            document.getElementById('floatBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            
                            // Show warning if balance is below minimum
                            if (floatBalance < 10) {
                                showNoFloatWarning();
                            }
                            
                            // Update driver avatar
                            updateDriverAvatar();
                            
                            // Set online status if previously online
                            if (userData.isOnline) {
                                document.getElementById('onlineToggleCheckbox').checked = true;
                                toggleOnlineStatus();
                            }
                        }
                    });
                
                // Load driver stats
                loadDriverStats();
                
                // Load float history
                loadFloatHistory();
            }
        }
        
        // Update driver avatar
        function updateDriverAvatar() {
            const driverAvatar = document.getElementById('driverAvatar');
            const driverName = document.getElementById('driverNameInput').value;
            
            if (driverName) {
                driverAvatar.innerHTML = driverName.charAt(0).toUpperCase();
            } else {
                driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // Add funds to wallet
        function addFunds() {
            const amount = prompt('Enter amount to add to your wallet (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = walletBalance + addAmount;
                
                // Update wallet balance
                walletBalance = newBalance;
                document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                
                // Save to Firebase
                if (currentUser) {
                    database.ref('users/' + currentUser.uid).update({
                        walletBalance: walletBalance
                    });
                }
                
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your wallet.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Withdraw funds from wallet
        function withdrawFunds() {
            if (walletBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw (K). Available: K${walletBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > walletBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = walletBalance - withdrawAmount;
                walletBalance = newBalance;
                document.getElementById('accountBalance').textContent = `K${walletBalance.toFixed(2)}`;
                
                // Save to Firebase
                if (currentUser) {
                    database.ref('users/' + currentUser.uid).update({
                        walletBalance: walletBalance
                    });
                }
                
                showNotification(`Withdrawal request submitted. K${withdrawAmount.toFixed(2)} will be processed within 24 hours.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Load driver statistics
        function loadDriverStats() {
            if (!currentUser) return;
            
            // Load completed rides count
            database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    let completed = 0;
                    let cancelled = 0;
                    let totalEarnings = 0;
                    
                    if (rides) {
                        Object.values(rides).forEach(ride => {
                            if (ride.status === 'completed') {
                                completed++;
                                totalEarnings += ride.fare || 0;
                            } else if (ride.status === 'cancelled') {
                                cancelled++;
                            }
                        });
                    }
                    
                    document.getElementById('completedRides').textContent = completed;
                    document.getElementById('cancelledRides').textContent = cancelled;
                    document.getElementById('totalEarnings').textContent = `K${totalEarnings.toFixed(2)}`;
                });
        }
        
        // Load ride history
        function loadRideHistory() {
            if (currentUser) {
                database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                    .then(snapshot => {
                        const historyList = document.getElementById('historyList');
                        historyList.innerHTML = '';
                        
                        const rides = snapshot.val();
                        if (rides) {
                            // Convert to array and sort by timestamp (newest first)
                            const ridesArray = Object.keys(rides).map(rideId => ({
                                id: rideId,
                                ...rides[rideId]
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            
                            ridesArray.forEach(ride => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                
                                const date = new Date(ride.timestamp);
                                const formattedDate = date.toLocaleDateString();
                                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                historyItem.innerHTML = `
                                    <div class="history-locations">
                                        <div>
                                            <strong>From:</strong> ${ride.pickupLocation}
                                        </div>
                                        <div>
                                            <strong>To:</strong> ${ride.destination}
                                        </div>
                                    </div>
                                    <div class="history-info">
                                        <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                        <div>${formattedDate} ${formattedTime}</div>
                                        <div class="status-badge ${ride.status === 'completed' ? 'status-completed' : 'status-cancelled'}">
                                            ${ride.status === 'completed' ? 'Completed' : 'Cancelled'}
                                        </div>
                                    </div>
                                `;
                                
                                historyList.appendChild(historyItem);
                            });
                        } else {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ride history:', error);
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--error-red);">Error loading ride history.</p>';
                    });
            }
        }
        
        // Load earnings
        function loadEarnings() {
            if (currentUser) {
                database.ref('earnings/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const earnings = snapshot.val();
                        let total = 0;
                        let ridesCompleted = 0;
                        let onlineHours = 0;
                        let totalCommission = 0;
                        
                        if (earnings) {
                            const now = new Date();
                            
                            Object.keys(earnings).forEach(earningId => {
                                const earning = earnings[earningId];
                                const earningDate = new Date(earning.timestamp);
                                
                                let include = false;
                                
                                switch(earningsPeriod) {
                                    case 'today':
                                        if (earningDate.toDateString() === now.toDateString()) {
                                            include = true;
                                        }
                                        break;
                                    case 'week':
                                        const startOfWeek = new Date(now);
                                        startOfWeek.setDate(now.getDate() - now.getDay());
                                        startOfWeek.setHours(0, 0, 0, 0);
                                        
                                        if (earningDate >= startOfWeek) {
                                            include = true;
                                        }
                                        break;
                                    case 'month':
                                        if (earningDate.getMonth() === now.getMonth() && 
                                            earningDate.getFullYear() === now.getFullYear()) {
                                            include = true;
                                        }
                                        break;
                                }
                                
                                if (include) {
                                    total += earning.amount || 0;
                                    totalCommission += earning.commission || 0;
                                    ridesCompleted++;
                                }
                            });
                            
                            // Calculate online hours (simplified)
                            onlineHours = Math.round(ridesCompleted * 0.75); // Assuming 45 minutes per ride on average
                        }
                        
                        document.getElementById('earningsTotal').textContent = `K${total.toFixed(2)}`;
                        document.getElementById('ridesCompleted').textContent = ridesCompleted;
                        document.getElementById('avgEarning').textContent = ridesCompleted > 0 ? `K${(total / ridesCompleted).toFixed(2)}` : 'K0.00';
                        document.getElementById('onlineHours').textContent = `${onlineHours}h`;
                        
                        // Update earnings list with commission information
                        updateEarningsList(earnings);
                    })
                    .catch(error => {
                        console.error('Error loading earnings:', error);
                        document.getElementById('earningsTotal').textContent = 'K0.00';
                        document.getElementById('ridesCompleted').textContent = '0';
                        document.getElementById('avgEarning').textContent = 'K0.00';
                        document.getElementById('onlineHours').textContent = '0h';
                    });
            }
        }
        
        // Update earnings list
        function updateEarningsList(earnings) {
            const earningsList = document.getElementById('earningsList');
            earningsList.innerHTML = '';
            
            if (earnings) {
                // Convert to array and sort by timestamp (newest first)
                const earningsArray = Object.keys(earnings).map(earningId => ({
                    id: earningId,
                    ...earnings[earningId]
                })).sort((a, b) => b.timestamp - a.timestamp)
                  .slice(0, 10); // Show only last 10 earnings
                
                earningsArray.forEach(earning => {
                    const earningItem = document.createElement('div');
                    earningItem.className = 'history-item';
                    
                    const date = new Date(earning.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    earningItem.innerHTML = `
                        <div class="history-locations">
                            <div>
                                <strong>Ride Earnings</strong>
                            </div>
                            <div>
                                <strong>K${earning.amount ? earning.amount.toFixed(2) : '0.00'}</strong>
                            </div>
                        </div>
                        <div class="commission-display">
                            <span class="commission-label">Commission (8%):</span>
                            <span class="commission-value commission-deduction">-K${earning.commission ? earning.commission.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="balance-update">
                            <span class="balance-label-update">Total Fare:</span>
                            <span class="balance-value-update">K${earning.totalFare ? earning.totalFare.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="history-info">
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge status-completed">Completed</div>
                        </div>
                    `;
                    
                    earningsList.appendChild(earningItem);
                });
            } else {
                earningsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No earnings found for this period.</p>';
            }
        }
        
        // Withdraw earnings
        function withdrawEarnings() {
            showNotification('Withdrawal request submitted. Funds will be processed within 24 hours.');
        }
        
        // Advanced features
        
        // Navigate to pickup
        function navigateToPickup() {
            if (currentRide && customerMarker) {
                const customerLatLng = customerMarker.getLatLng();
                // In a real app, this would open the device's navigation app
                showNotification(`Opening navigation to pickup location: ${currentRide.pickupLocation}`);
                
                // For demo purposes, we'll just center the map on the pickup location
                driverMap.setView(customerLatLng, 16);
            }
        }
        
        // Contact customer
        function contactCustomer() {
            if (currentRide) {
                const phoneNumber = currentRide.passengerPhone;
                if (phoneNumber) {
                    // In a real app, this would initiate a phone call
                    showNotification(`Calling customer: ${phoneNumber}`);
                } else {
                    showNotification('Customer phone number not available.');
                }
            }
        }
        
        // View route details
        function viewRouteDetails() {
            if (currentRide) {
                // In a real app, this would show detailed route information
                showNotification(`Showing route details for trip to ${currentRide.destination}`);
            }
        }
        
        // Quick actions
        
        // Center map on driver location
        function centerMap() {
            if (driverMarker) {
                const driverLatLng = driverMarker.getLatLng();
                driverMap.setView(driverLatLng, 16);
                showNotification('Map centered on your location');
            }
        }
        
        // Refresh driver position
        function refreshDriverPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 16);
                    
                    // Update driver marker position
                    if (driverMarker) {
                        driverMarker.setLatLng([lat, lng]);
                    }
                    
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                    
                    showNotification('Location refreshed');
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to refresh location. Please enable location services.');
                });
            }
        }
        
        // Toggle traffic layer
        function toggleTraffic() {
            if (trafficEnabled) {
                // Remove traffic layer
                if (trafficLayer) {
                    driverMap.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
                trafficEnabled = false;
                showNotification('Traffic layer disabled');
            } else {
                // Add traffic layer (using OpenStreetMap traffic tiles as an example)
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                }).addTo(driverMap);
                trafficEnabled = true;
                showNotification('Traffic layer enabled');
            }
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                showNotification('Logged out successfully');
                // Reset app state
                currentUser = null;
                currentRide = null;
                isOnline = false;
                
                // Stop location tracking
                stopLocationTracking();
                
                // Show welcome screen
                document.getElementById('welcomeScreen').classList.remove('hidden');
                document.getElementById('mainApp').style.display = 'none';
            }).catch((error) => {
                console.error('Logout error:', error);
                showNotification('Error logging out');
            });
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
