<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary-orange: #FF6B35;
            --secondary-red: #F94144;
            --light-orange: #FFB88C;
            --light-red: #FFA5A5;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --danger-red: #e74c3c;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            color: var(--white);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .main-content {
            padding: 20px 0;
        }
        
        .card {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--dark-gray);
            font-weight: 600;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background-color: var(--primary-orange);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-red);
        }
        
        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }
        
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        
        .btn-success {
            background-color: #4CAF50;
            color: var(--white);
        }
        
        .btn-success:hover {
            background-color: #45a049;
        }
        
        .btn-danger {
            background-color: #f44336;
            color: var(--white);
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .map-container {
            height: 250px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .online-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .toggle-label {
            font-weight: 600;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-orange);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .ride-request {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ride-request:hover {
            border-color: var(--primary-orange);
            background-color: var(--light-orange);
        }
        
        .ride-request h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .ride-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .ride-location {
            flex: 1;
        }
        
        .ride-location h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .ride-location p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .ride-fare {
            text-align: right;
        }
        
        .fare-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .passenger-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .passenger-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--light-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .passenger-details h3 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .passenger-details p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .trip-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .trip-location {
            flex: 1;
        }
        
        .trip-location h4 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .trip-location p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .earnings-display {
            text-align: center;
            margin: 20px 0;
        }
        
        .earnings-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-orange);
        }
        
        .earnings-period {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .period-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .period-option.active {
            border-color: var(--primary-orange);
            background-color: var(--light-orange);
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-completed {
            background-color: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-pending {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-accepted {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-arrived {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        
        .status-picked-up {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-started {
            background-color: #e1f5fe;
            color: #0277bd;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: var(--primary-orange);
            border-bottom: 3px solid var(--primary-orange);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .hidden {
            display: none;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-orange);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        /* New styles for popup form */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .popup-form {
            background-color: var(--white);
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .popup-form.large-popup {
            max-width: 800px;
        }
        
        .popup-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .popup-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-gray);
        }
        
        .close-popup {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .popup-content {
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .popup-content {
                flex-direction: row;
            }
        }
        
        .popup-map-container {
            height: 300px;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .popup-map-container {
                height: 400px;
                width: 50%;
            }
        }
        
        .popup-details {
            padding: 20px;
            width: 100%;
        }
        
        @media (min-width: 768px) {
            .popup-details {
                width: 50%;
            }
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: 600;
            color: #666;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        .popup-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .popup-actions .btn {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* New styles for hold buttons */
        .hold-btn-container {
            margin: 20px 0;
        }
        
        .hold-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .hold-btn.active {
            background-color: var(--primary-orange);
            color: var(--white);
        }
        
        .hold-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .hold-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background-color: var(--secondary-red);
            width: 0%;
            transition: width 3s linear;
        }
        
        .hold-btn.holding .hold-progress {
            width: 100%;
        }
        
        .driver-info-card {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
        }
        
        .driver-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .driver-details-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .driver-details-section .section-title {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--primary-orange);
        }
        
        /* Ride history popup styles */
        .ride-history-popup .popup-content {
            flex-direction: column;
        }
        
        .ride-history-popup .popup-map-container {
            width: 100%;
            height: 300px;
        }
        
        .ride-history-popup .popup-details {
            width: 100%;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .logo h1 {
                font-size: 1.3rem;
            }
            
            .popup-form.large-popup {
                max-width: 95%;
            }
            
            .popup-content {
                flex-direction: column;
            }
            
            .popup-map-container {
                width: 100%;
                height: 250px;
            }
            
            .popup-details {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="jubel.png" alt="Jubel Logo">
                    <h1>Jubel Driver</h1>
                </div>
                <div class="user-icon" id="userIcon">D</div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="main-content">
            <!-- Home Screen -->
            <div id="homeScreen" class="tab-content active">
                <div class="card">
                    <div class="online-toggle">
                        <span class="toggle-label">Go Online</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="onlineToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div id="onlineContent" class="hidden">
                        <h2 class="section-title">Available Rides</h2>
                        <div id="rideRequestsList">
                            <!-- Ride requests will be populated by JavaScript -->
                            <div class="no-rides">No ride requests available at the moment.</div>
                        </div>
                    </div>
                    
                    <div id="offlineContent">
                        <p>Go online to receive ride requests</p>
                    </div>
                </div>
                
                <div class="map-container" id="homeMap"></div>
            </div>
            
            <!-- Active Ride Screen -->
            <div id="activeRideScreen" class="tab-content hidden">
                <div class="card">
                    <h2 class="section-title">Active Ride</h2>
                    <div class="passenger-info">
                        <div class="passenger-avatar" id="activePassengerAvatar">P</div>
                        <div class="passenger-details">
                            <h3 id="passengerName">Passenger Name</h3>
                            <p id="passengerPhone">Phone: 000-000-0000</p>
                        </div>
                    </div>
                    
                    <div class="trip-info">
                        <div class="trip-location">
                            <h4>Pickup</h4>
                            <p id="activePickupAddress">123 Main St</p>
                        </div>
                        <div class="trip-location">
                            <h4>Destination</h4>
                            <p id="activeDestinationAddress">456 Oak Ave</p>
                        </div>
                    </div>
                    
                    <div class="fare-display">
                        <p>Fare</p>
                        <div class="fare-amount" id="activeRideFare">K0.00</div>
                    </div>
                    
                    <!-- New hold buttons -->
                    <div class="hold-btn-container">
                        <button class="hold-btn" id="holdToStartBtn">
                            <span class="btn-text">Hold to Start</span>
                            <div class="hold-progress"></div>
                        </button>
                    </div>
                    
                    <div class="hold-btn-container">
                        <button class="hold-btn" id="holdToArriveBtn" disabled>
                            <span class="btn-text">Hold to Arrive</span>
                            <div class="hold-progress"></div>
                        </button>
                    </div>
                    
                    <div class="hold-btn-container">
                        <button class="hold-btn" id="holdToPickBtn" disabled>
                            <span class="btn-text">Hold to Pick</span>
                            <div class="hold-progress"></div>
                        </button>
                    </div>
                    
                    <div class="hold-btn-container">
                        <button class="hold-btn" id="holdToCompleteBtn" disabled>
                            <span class="btn-text">Hold to Complete</span>
                            <div class="hold-progress"></div>
                        </button>
                    </div>
                    
                    <button class="btn btn-danger" id="cancelActiveRideBtn">Cancel Ride</button>
                </div>
                
                <div class="map-container" id="activeRideMap"></div>
            </div>
            
            <!-- Earnings Screen -->
            <div id="earningsScreen" class="tab-content hidden">
                <div class="card">
                    <h2 class="section-title">Earnings</h2>
                    
                    <div class="earnings-period">
                        <div class="period-option active" data-period="today">Today</div>
                        <div class="period-option" data-period="week">This Week</div>
                        <div class="period-option" data-period="month">This Month</div>
                    </div>
                    
                    <div class="earnings-display">
                        <div class="earnings-amount" id="earningsAmount">K0.00</div>
                        <p id="earningsPeriod">Today's Earnings</p>
                    </div>
                    
                    <button class="btn btn-primary" id="withdrawEarningsBtn">Withdraw Earnings</button>
                </div>
                
                <div class="card">
                    <h2 class="section-title">Payment Methods</h2>
                    <div class="input-group">
                        <label for="payoutMethod">Payout Method</label>
                        <select id="payoutMethod" class="input-field">
                            <option value="airtel">Airtel Money</option>
                            <option value="mtn">MTN Money</option>
                            <option value="zamtel">Zamtel Money</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="card">Visa/Mastercard</option>
                            <option value="plush">Plush</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="payoutAccount">Account Number</label>
                        <input type="text" id="payoutAccount" class="input-field" placeholder="Your account number">
                    </div>
                    
                    <button class="btn btn-primary" id="savePayoutInfoBtn">Save Payout Info</button>
                </div>
            </div>
            
            <!-- Ride History Screen -->
            <div id="historyScreen" class="tab-content hidden">
                <div class="card">
                    <h2 class="section-title">Ride History</h2>
                    <div class="filter-options">
                        <select id="historyFilter" class="input-field">
                            <option value="all">All Rides</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="accepted">Accepted</option>
                        </select>
                        <input type="date" id="historyDate" class="input-field">
                    </div>
                    <div id="historyList">
                        <!-- History items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Settings Screen -->
            <div id="settingsScreen" class="tab-content hidden">
                <div class="card">
                    <h2 class="section-title">Profile</h2>
                    <div class="input-group">
                        <label for="driverName">Name</label>
                        <input type="text" id="driverName" class="input-field" placeholder="Your name">
                    </div>
                    <div class="input-group">
                        <label for="driverPhone">Phone</label>
                        <input type="tel" id="driverPhone" class="input-field" placeholder="Your phone number">
                    </div>
                    <div class="input-group">
                        <label for="driverEmail">Email</label>
                        <input type="email" id="driverEmail" class="input-field" placeholder="Your email">
                    </div>
                    <div class="input-group">
                        <label for="vehicleType">Vehicle Type</label>
                        <input type="text" id="vehicleType" class="input-field" placeholder="Car, Bike, etc.">
                    </div>
                    <div class="input-group">
                        <label for="licensePlate">License Plate</label>
                        <input type="text" id="licensePlate" class="input-field" placeholder="Vehicle license plate">
                    </div>
                    <div class="input-group">
                        <label for="driverId">Driver ID</label>
                        <input type="text" id="driverId" class="input-field" placeholder="Your driver ID">
                    </div>
                    <button class="btn btn-primary" id="saveDriverProfileBtn">Save Profile</button>
                </div>
                
                <div class="card">
                    <h2 class="section-title">Notifications</h2>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="rideRequestNotifications" checked> Ride Requests
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="earningNotifications"> Earnings Updates
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-secondary" id="logoutBtn">Logout</button>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="tab-container">
            <div class="tab active" data-tab="homeScreen">Home</div>
            <div class="tab" data-tab="earningsScreen">Earnings</div>
            <div class="tab" data-tab="historyScreen">History</div>
            <div class="tab" data-tab="settingsScreen">Settings</div>
        </div>
    </div>
    
    <!-- New Popup Form for Ride Requests -->
    <div id="rideRequestPopup" class="popup-overlay hidden">
        <div class="popup-form">
            <div class="popup-header">
                <h2 class="popup-title">New Ride Request</h2>
                <button class="close-popup" id="closePopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="popupMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="popupPickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Drop Off:</span>
                        <span class="detail-value" id="popupDropoff">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="popupDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="popupFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Customer Name:</span>
                        <span class="detail-value" id="popupCustomerName">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Customer Phone:</span>
                        <span class="detail-value" id="popupCustomerPhone">Loading...</span>
                    </div>
                    <div class="popup-actions">
                        <button class="btn btn-danger" id="rejectRideBtn">Reject</button>
                        <button class="btn btn-success" id="acceptRideBtn">Accept</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ride History Details Popup -->
    <div id="rideHistoryPopup" class="popup-overlay hidden">
        <div class="popup-form large-popup ride-history-popup">
            <div class="popup-header">
                <h2 class="popup-title">Ride Details</h2>
                <button class="close-popup" id="closeHistoryPopup">&times;</button>
            </div>
            <div class="popup-content">
                <div class="popup-map-container" id="historyPopupMap"></div>
                <div class="popup-details">
                    <div class="detail-row">
                        <span class="detail-label">Pickup:</span>
                        <span class="detail-value" id="historyPopupPickup">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Destination:</span>
                        <span class="detail-value" id="historyPopupDestination">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fare:</span>
                        <span class="detail-value" id="historyPopupFare">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value" id="historyPopupDistance">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Ride Type:</span>
                        <span class="detail-value" id="historyPopupRideType">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" id="historyPopupStatus">Loading...</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Date & Time:</span>
                        <span class="detail-value" id="historyPopupDate">Loading...</span>
                    </div>
                    
                    <!-- Passenger Details Section -->
                    <div class="driver-details-section">
                        <h3 class="section-title">Passenger Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Passenger Name:</span>
                            <span class="detail-value" id="historyPopupPassengerName">Loading...</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value" id="historyPopupPassengerPhone">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="popup-actions">
                        <button class="btn btn-primary" id="closeHistoryDetailsBtn">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Driver Info Card (shown after accepting ride) -->
    <div id="driverInfoCard" class="driver-info-card hidden">
        <h3>Driver Information</h3>
        <div class="driver-info-row">
            <span class="detail-label">Driver Name:</span>
            <span class="detail-value" id="driverInfoName">John Doe</span>
        </div>
        <div class="driver-info-row">
            <span class="detail-label">Vehicle:</span>
            <span class="detail-value" id="driverInfoVehicle">Toyota Corolla (ABC 123)</span>
        </div>
        <div class="driver-info-row">
            <span class="detail-label">Location:</span>
            <span class="detail-value" id="driverInfoLocation">2.5 km away</span>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let isOnline = false;
        let homeMap, activeRideMap, popupMap, historyPopupMap;
        let locationWatchId = null;
        let earningsPeriod = 'today';
        let currentPopupRide = null;
        let holdTimers = {};
        let rideRequestsListener = null;
        let currentRideListener = null;
        let rideHistoryListener = null;
        let driverLocationListener = null;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            initializeMaps();
            setupEventListeners();
            loadDriverData();
        });
        
        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('userIcon').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : 'D';
                    loadDriverData();
                    
                    // Check for any active rides
                    checkActiveRides();
                } else {
                    // Redirect to login if not authenticated
                    showLoginScreen();
                }
            });
        }
        
        function showLoginScreen() {
            // In a real app, this would show a login form
            // For demo purposes, we'll auto-login with a dummy user
            auth.signInAnonymously()
                .then(() => {
                    console.log('Driver signed in anonymously');
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    showNotification('Authentication error. Please refresh the page.');
                });
        }
        
        // Map initialization
        function initializeMaps() {
            // Home map
            homeMap = L.map('homeMap').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(homeMap);
            
            // Active ride map
            activeRideMap = L.map('activeRideMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(activeRideMap);
            
            // Popup map
            popupMap = L.map('popupMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(popupMap);
            
            // History popup map
            historyPopupMap = L.map('historyPopupMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(historyPopupMap);
            
            // Get driver's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update maps with current location
                    homeMap.setView([lat, lng], 15);
                    activeRideMap.setView([lat, lng], 15);
                    popupMap.setView([lat, lng], 15);
                    historyPopupMap.setView([lat, lng], 15);
                    
                    // Add marker for current location
                    L.marker([lat, lng]).addTo(homeMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Update driver location in Firebase
        function updateDriverLocation(lat, lng) {
            if (currentUser && isOnline) {
                database.ref('driverLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Start tracking driver location
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateDriverLocation(lat, lng);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking driver location
        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Online toggle
            document.getElementById('onlineToggle').addEventListener('change', function() {
                isOnline = this.checked;
                toggleOnlineStatus(isOnline);
            });
            
            // Earnings period selection
            document.querySelectorAll('.period-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.period-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    earningsPeriod = this.getAttribute('data-period');
                    loadEarnings();
                });
            });
            
            // Ride action buttons
            document.getElementById('cancelActiveRideBtn').addEventListener('click', cancelActiveRide);
            
            // Withdraw earnings button
            document.getElementById('withdrawEarningsBtn').addEventListener('click', withdrawEarnings);
            
            // Save payout info button
            document.getElementById('savePayoutInfoBtn').addEventListener('click', savePayoutInfo);
            
            // Save profile button
            document.getElementById('saveDriverProfileBtn').addEventListener('click', saveDriverProfile);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Popup buttons
            document.getElementById('closePopup').addEventListener('click', closePopup);
            document.getElementById('rejectRideBtn').addEventListener('click', rejectRide);
            document.getElementById('acceptRideBtn').addEventListener('click', acceptRideFromPopup);
            
            // History popup buttons
            document.getElementById('closeHistoryPopup').addEventListener('click', closeHistoryPopup);
            document.getElementById('closeHistoryDetailsBtn').addEventListener('click', closeHistoryPopup);
            
            // History filter
            document.getElementById('historyFilter').addEventListener('change', loadRideHistory);
            document.getElementById('historyDate').addEventListener('change', loadRideHistory);
            
            // History item clicks
            document.addEventListener('click', function(e) {
                if (e.target.closest('.history-item')) {
                    const historyItem = e.target.closest('.history-item');
                    const rideId = historyItem.getAttribute('data-ride-id');
                    if (rideId) {
                        showRideHistoryDetails(rideId);
                    }
                }
                
                if (e.target.closest('.ride-request')) {
                    const rideRequest = e.target.closest('.ride-request');
                    const rideId = rideRequest.getAttribute('data-ride-id');
                    if (rideId) {
                        showRidePopup(rideId);
                    }
                }
            });
            
            // Hold buttons setup
            setupHoldButtons();
        }
        
        // Setup hold buttons functionality
        function setupHoldButtons() {
            const holdButtons = [
                { id: 'holdToStartBtn', action: startTrip, nextButton: 'holdToArriveBtn' },
                { id: 'holdToArriveBtn', action: markArrived, nextButton: 'holdToPickBtn' },
                { id: 'holdToPickBtn', action: markPickedUp, nextButton: 'holdToCompleteBtn' },
                { id: 'holdToCompleteBtn', action: completeTrip, nextButton: null }
            ];
            
            holdButtons.forEach(buttonConfig => {
                const button = document.getElementById(buttonConfig.id);
                
                button.addEventListener('mousedown', function() {
                    if (button.disabled) return;
                    
                    // Start holding
                    button.classList.add('holding');
                    holdTimers[buttonConfig.id] = setTimeout(() => {
                        // Execute the action after 3 seconds
                        buttonConfig.action();
                        
                        // Enable the next button if exists
                        if (buttonConfig.nextButton) {
                            const nextButton = document.getElementById(buttonConfig.nextButton);
                            nextButton.disabled = false;
                        }
                        
                        // Reset button state
                        button.classList.remove('holding');
                        button.disabled = true;
                        button.classList.add('active');
                    }, 3000);
                });
                
                button.addEventListener('mouseup', function() {
                    clearHoldTimer(buttonConfig.id);
                });
                
                button.addEventListener('mouseleave', function() {
                    clearHoldTimer(buttonConfig.id);
                });
                
                // For touch devices
                button.addEventListener('touchstart', function(e) {
                    if (button.disabled) return;
                    
                    e.preventDefault();
                    button.classList.add('holding');
                    holdTimers[buttonConfig.id] = setTimeout(() => {
                        buttonConfig.action();
                        
                        if (buttonConfig.nextButton) {
                            const nextButton = document.getElementById(buttonConfig.nextButton);
                            nextButton.disabled = false;
                        }
                        
                        button.classList.remove('holding');
                        button.disabled = true;
                        button.classList.add('active');
                    }, 3000);
                });
                
                button.addEventListener('touchend', function() {
                    clearHoldTimer(buttonConfig.id);
                });
            });
        }
        
        // Clear hold timer
        function clearHoldTimer(buttonId) {
            if (holdTimers[buttonId]) {
                clearTimeout(holdTimers[buttonId]);
                delete holdTimers[buttonId];
                
                const button = document.getElementById(buttonId);
                button.classList.remove('holding');
            }
        }
        
        // Tab switching
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Load data for specific tabs
            if (tabId === 'earningsScreen') {
                loadEarnings();
            } else if (tabId === 'historyScreen') {
                loadRideHistory();
            } else if (tabId === 'homeScreen') {
                // Refresh home map
                if (homeMap && currentUser) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        homeMap.setView([lat, lng], 15);
                    });
                }
            }
        }
        
        // Toggle online status
        function toggleOnlineStatus(online) {
            if (online) {
                document.getElementById('onlineContent').classList.remove('hidden');
                document.getElementById('offlineContent').classList.add('hidden');
                
                // Start location tracking
                startLocationTracking();
                
                // Listen for ride requests
                listenForRideRequests();
                
                showNotification('You are now online and receiving ride requests.');
            } else {
                document.getElementById('onlineContent').classList.add('hidden');
                document.getElementById('offlineContent').classList.remove('hidden');
                
                // Stop location tracking
                stopLocationTracking();
                
                // Stop listening for ride requests
                if (rideRequestsListener) {
                    rideRequestsListener();
                    rideRequestsListener = null;
                }
                
                showNotification('You are now offline.');
            }
            
            // Update driver status in Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    isOnline: online,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Listen for ride requests
        function listenForRideRequests() {
            // Remove existing listener if any
            if (rideRequestsListener) {
                rideRequestsListener();
            }
            
            // Listen for new ride requests
            rideRequestsListener = database.ref('rides').orderByChild('status').equalTo('requested').on('value', snapshot => {
                const rideRequestsList = document.getElementById('rideRequestsList');
                rideRequestsList.innerHTML = '';
                
                const rides = snapshot.val();
                if (rides) {
                    Object.keys(rides).forEach(rideId => {
                        const ride = rides[rideId];
                        
                        // Only show rides within reasonable distance (in a real app, calculate distance)
                        const rideItem = document.createElement('div');
                        rideItem.className = 'ride-request';
                        rideItem.setAttribute('data-ride-id', rideId);
                        
                        rideItem.innerHTML = `
                            <h3>${ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard'} Ride</h3>
                            <div class="ride-details">
                                <div class="ride-location">
                                    <h4>Pickup</h4>
                                    <p>${ride.pickupLocation}</p>
                                </div>
                                <div class="ride-location">
                                    <h4>Destination</h4>
                                    <p>${ride.destination}</p>
                                </div>
                            </div>
                            <div class="ride-fare">
                                <div class="fare-amount">K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                            </div>
                            <button class="btn btn-primary view-ride-btn">View Details</button>
                        `;
                        
                        rideRequestsList.appendChild(rideItem);
                    });
                } else {
                    rideRequestsList.innerHTML = '<div class="no-rides">No ride requests available at the moment.</div>';
                }
            });
        }
        
        // Show ride popup with map and details
        function showRidePopup(rideId) {
            database.ref('rides/' + rideId).once('value')
                .then(snapshot => {
                    const ride = snapshot.val();
                    if (ride) {
                        currentPopupRide = { id: rideId, ...ride };
                        
                        // Update popup details
                        document.getElementById('popupPickup').textContent = ride.pickupLocation;
                        document.getElementById('popupDropoff').textContent = ride.destination;
                        document.getElementById('popupDistance').textContent = ride.distance || 'Calculating...';
                        document.getElementById('popupFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                        document.getElementById('popupCustomerName').textContent = ride.passengerName || 'Passenger';
                        document.getElementById('popupCustomerPhone').textContent = ride.passengerPhone || 'N/A';
                        
                        // Update popup map
                        updatePopupMap(ride);
                        
                        // Show popup
                        document.getElementById('rideRequestPopup').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading ride details:', error);
                    showNotification('Error loading ride details.');
                });
        }
        
        // Update popup map with pickup and dropoff locations
        function updatePopupMap(ride) {
            // Clear existing markers
            popupMap.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    popupMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng]).addTo(popupMap)
                .bindPopup('Pickup Location')
                .openPopup();
                
            // Add destination marker
            L.marker([ride.destLat, ride.destLng]).addTo(popupMap)
                .bindPopup('Dropoff Location');
            
            // Fit map to show both markers
            const group = new L.featureGroup([
                L.marker([ride.pickupLat, ride.pickupLng]),
                L.marker([ride.destLat, ride.destLng])
            ]);
            popupMap.fitBounds(group.getBounds().pad(0.1));
            
            // Draw a line between pickup and dropoff
            L.polyline([
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            ], {color: 'red'}).addTo(popupMap);
        }
        
        // Close popup
        function closePopup() {
            document.getElementById('rideRequestPopup').classList.add('hidden');
            currentPopupRide = null;
        }
        
        // Close history popup
        function closeHistoryPopup() {
            document.getElementById('rideHistoryPopup').classList.add('hidden');
        }
        
        // Reject ride from popup
        function rejectRide() {
            if (currentPopupRide) {
                database.ref('rides/' + currentPopupRide.id).update({
                    status: 'rejected',
                    rejectedBy: currentUser.uid,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Ride rejected.');
                    closePopup();
                })
                .catch(error => {
                    console.error('Error rejecting ride:', error);
                    showNotification('Error rejecting ride. Please try again.');
                });
            }
        }
        
        // Accept ride from popup
        function acceptRideFromPopup() {
            if (currentPopupRide && currentUser) {
                // Update ride with driver info
                database.ref('rides/' + currentPopupRide.id).update({
                    driverId: currentUser.uid,
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide = {
                        id: currentPopupRide.id,
                        ...currentPopupRide,
                        driverId: currentUser.uid,
                        status: 'accepted'
                    };
                    
                    // Update UI
                    document.getElementById('passengerName').textContent = currentPopupRide.passengerName || 'Passenger';
                    document.getElementById('passengerPhone').textContent = 'Phone: ' + (currentPopupRide.passengerPhone || 'N/A');
                    document.getElementById('activePickupAddress').textContent = currentPopupRide.pickupLocation;
                    document.getElementById('activeDestinationAddress').textContent = currentPopupRide.destination;
                    document.getElementById('activeRideFare').textContent = `K${currentPopupRide.fare ? currentPopupRide.fare.toFixed(2) : '0.00'}`;
                    document.getElementById('activePassengerAvatar').textContent = currentPopupRide.passengerName ? currentPopupRide.passengerName.charAt(0).toUpperCase() : 'P';
                    
                    // Reset hold buttons
                    resetHoldButtons();
                    
                    // Enable first hold button
                    document.getElementById('holdToStartBtn').disabled = false;
                    
                    // Update active ride map
                    updateActiveRideMap(currentRide);
                    
                    // Switch to active ride screen
                    switchTab('activeRideScreen');
                    
                    showNotification('Ride accepted successfully.');
                    closePopup();
                    
                    // Set up listener for ride updates
                    setupCurrentRideListener();
                })
                .catch(error => {
                    console.error('Error accepting ride:', error);
                    showNotification('Error accepting ride. Please try again.');
                });
            }
        }
        
        // Reset all hold buttons to initial state
        function resetHoldButtons() {
            const holdButtons = [
                'holdToStartBtn',
                'holdToArriveBtn',
                'holdToPickBtn',
                'holdToCompleteBtn'
            ];
            
            holdButtons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                button.disabled = true;
                button.classList.remove('active', 'holding');
            });
        }
        
        // Update active ride map
        function updateActiveRideMap(ride) {
            // Clear existing map
            activeRideMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    activeRideMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng]).addTo(activeRideMap)
                .bindPopup('Pickup Location');
                
            // Add destination marker
            L.marker([ride.destLat, ride.destLng]).addTo(activeRideMap)
                .bindPopup('Destination');
            
            // Draw route
            L.polyline([
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            ], {color: 'blue'}).addTo(activeRideMap);
            
            // Fit map to show both locations
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            activeRideMap.fitBounds(bounds, { padding: [20, 20] });
        }
        
        // Set up current ride listener
        function setupCurrentRideListener() {
            if (currentRideListener) {
                currentRideListener();
            }
            
            currentRideListener = database.ref('rides/' + currentRide.id).on('value', snapshot => {
                const ride = snapshot.val();
                if (ride) {
                    currentRide = { id: currentRide.id, ...ride };
                    
                    // Update UI if needed
                    if (ride.status === 'cancelled') {
                        showNotification('Ride has been cancelled by passenger.');
                        switchTab('homeScreen');
                        currentRide = null;
                    }
                }
            });
        }
        
        // Mark arrived at pickup
        function markArrived() {
            if (currentRide) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'arrived',
                    arrivedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Arrival marked. Waiting for passenger.');
                })
                .catch(error => {
                    console.error('Error marking arrival:', error);
                    showNotification('Error updating status. Please try again.');
                });
            }
        }
        
        // Mark passenger picked up
        function markPickedUp() {
            if (currentRide) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'picked_up',
                    pickedUpAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Passenger picked up. Proceed to destination.');
                })
                .catch(error => {
                    console.error('Error marking pickup:', error);
                    showNotification('Error updating status. Please try again.');
                });
            }
        }
        
        // Start trip
        function startTrip() {
            if (currentRide) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'started',
                    startedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Trip started. Safe driving!');
                })
                .catch(error => {
                    console.error('Error starting trip:', error);
                    showNotification('Error starting trip. Please try again.');
                });
            }
        }
        
        // Complete trip
        function completeTrip() {
            if (currentRide) {
                database.ref('rides/' + currentRide.id).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    // Add to earnings
                    const earningsData = {
                        rideId: currentRide.id,
                        amount: currentRide.fare,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('earnings/' + currentUser.uid).push(earningsData)
                        .then(() => {
                            showNotification('Trip completed successfully. Earnings recorded.');
                            switchTab('homeScreen');
                            currentRide = null;
                            
                            // Remove current ride listener
                            if (currentRideListener) {
                                currentRideListener();
                                currentRideListener = null;
                            }
                        });
                })
                .catch(error => {
                    console.error('Error completing trip:', error);
                    showNotification('Error completing trip. Please try again.');
                });
            }
        }
        
        // Cancel active ride
        function cancelActiveRide() {
            if (currentRide) {
                if (confirm('Are you sure you want to cancel this ride?')) {
                    database.ref('rides/' + currentRide.id).update({
                        status: 'cancelled',
                        cancelledBy: 'driver',
                        cancelledAt: firebase.database.ServerValue.TIMESTAMP,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        showNotification('Ride cancelled.');
                        switchTab('homeScreen');
                        currentRide = null;
                        
                        // Remove current ride listener
                        if (currentRideListener) {
                            currentRideListener();
                            currentRideListener = null;
                        }
                    })
                    .catch(error => {
                        console.error('Error cancelling ride:', error);
                        showNotification('Error cancelling ride. Please try again.');
                    });
                }
            }
        }
        
        // Check for active rides
        function checkActiveRides() {
            if (currentUser) {
                database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                    .then(snapshot => {
                        const rides = snapshot.val();
                        if (rides) {
                            // Find any active rides
                            const activeRides = Object.keys(rides).filter(rideId => {
                                const ride = rides[rideId];
                                return ride.status === 'accepted' || ride.status === 'arrived' || 
                                       ride.status === 'picked_up' || ride.status === 'started';
                            });
                            
                            if (activeRides.length > 0) {
                                // Switch to active ride screen
                                const activeRideId = activeRides[0];
                                const activeRide = rides[activeRideId];
                                currentRide = { id: activeRideId, ...activeRide };
                                
                                // Set up active ride
                                setupActiveRide(activeRide);
                            }
                        }
                    });
            }
        }
        
        // Set up active ride
        function setupActiveRide(ride) {
            // Update UI
            document.getElementById('passengerName').textContent = ride.passengerName || 'Passenger';
            document.getElementById('passengerPhone').textContent = 'Phone: ' + (ride.passengerPhone || 'N/A');
            document.getElementById('activePickupAddress').textContent = ride.pickupLocation;
            document.getElementById('activeDestinationAddress').textContent = ride.destination;
            document.getElementById('activeRideFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
            document.getElementById('activePassengerAvatar').textContent = ride.passengerName ? ride.passengerName.charAt(0).toUpperCase() : 'P';
            
            // Update active ride map
            updateActiveRideMap(ride);
            
            // Set up hold buttons based on current status
            setupHoldButtonsByStatus(ride.status);
            
            // Switch to active ride screen
            switchTab('activeRideScreen');
            
            // Set up listener for ride updates
            setupCurrentRideListener();
        }
        
        // Set up hold buttons based on ride status
        function setupHoldButtonsByStatus(status) {
            resetHoldButtons();
            
            switch(status) {
                case 'accepted':
                    document.getElementById('holdToStartBtn').disabled = false;
                    break;
                case 'arrived':
                    document.getElementById('holdToStartBtn').disabled = true;
                    document.getElementById('holdToStartBtn').classList.add('active');
                    document.getElementById('holdToArriveBtn').disabled = false;
                    break;
                case 'picked_up':
                    document.getElementById('holdToStartBtn').disabled = true;
                    document.getElementById('holdToStartBtn').classList.add('active');
                    document.getElementById('holdToArriveBtn').disabled = true;
                    document.getElementById('holdToArriveBtn').classList.add('active');
                    document.getElementById('holdToPickBtn').disabled = false;
                    break;
                case 'started':
                    document.getElementById('holdToStartBtn').disabled = true;
                    document.getElementById('holdToStartBtn').classList.add('active');
                    document.getElementById('holdToArriveBtn').disabled = true;
                    document.getElementById('holdToArriveBtn').classList.add('active');
                    document.getElementById('holdToPickBtn').disabled = true;
                    document.getElementById('holdToPickBtn').classList.add('active');
                    document.getElementById('holdToCompleteBtn').disabled = false;
                    break;
            }
        }
        
        // Load driver data
        function loadDriverData() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            document.getElementById('driverName').value = userData.name || '';
                            document.getElementById('driverPhone').value = userData.phone || '';
                            document.getElementById('driverEmail').value = userData.email || '';
                            document.getElementById('vehicleType').value = userData.vehicleType || '';
                            document.getElementById('licensePlate').value = userData.licensePlate || '';
                            document.getElementById('driverId').value = userData.driverId || '';
                            
                            if (userData.payoutMethod) {
                                document.getElementById('payoutMethod').value = userData.payoutMethod;
                            }
                            
                            if (userData.payoutAccount) {
                                document.getElementById('payoutAccount').value = userData.payoutAccount;
                            }
                            
                            // Set online status if previously online
                            if (userData.isOnline) {
                                document.getElementById('onlineToggle').checked = true;
                                toggleOnlineStatus(true);
                            }
                            
                            // Update user icon
                            document.getElementById('userIcon').textContent = userData.name ? userData.name.charAt(0).toUpperCase() : 'D';
                        }
                    });
            }
        }
        
        // Save driver profile
        function saveDriverProfile() {
            const name = document.getElementById('driverName').value;
            const phone = document.getElementById('driverPhone').value;
            const email = document.getElementById('driverEmail').value;
            const vehicleType = document.getElementById('vehicleType').value;
            const licensePlate = document.getElementById('licensePlate').value;
            const driverId = document.getElementById('driverId').value;
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    name: name,
                    phone: phone,
                    email: email,
                    vehicleType: vehicleType,
                    licensePlate: licensePlate,
                    driverId: driverId,
                    userType: 'driver',
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Profile saved successfully.');
                    
                    // Update user icon
                    document.getElementById('userIcon').textContent = name ? name.charAt(0).toUpperCase() : 'D';
                })
                .catch(error => {
                    console.error('Error saving profile:', error);
                    showNotification('Error saving profile. Please try again.');
                });
            }
        }
        
        // Save payout info
        function savePayoutInfo() {
            const payoutMethod = document.getElementById('payoutMethod').value;
            const payoutAccount = document.getElementById('payoutAccount').value;
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    payoutMethod: payoutMethod,
                    payoutAccount: payoutAccount,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    showNotification('Payout information saved successfully.');
                })
                .catch(error => {
                    console.error('Error saving payout info:', error);
                    showNotification('Error saving payout info. Please try again.');
                });
            }
        }
        
        // Load earnings
        function loadEarnings() {
            if (currentUser) {
                database.ref('earnings/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const earnings = snapshot.val();
                        let total = 0;
                        let periodText = '';
                        
                        if (earnings) {
                            const now = new Date();
                            
                            Object.keys(earnings).forEach(earningId => {
                                const earning = earnings[earningId];
                                const earningDate = new Date(earning.timestamp);
                                
                                let include = false;
                                
                                switch(earningsPeriod) {
                                    case 'today':
                                        if (earningDate.toDateString() === now.toDateString()) {
                                            include = true;
                                            periodText = "Today's Earnings";
                                        }
                                        break;
                                    case 'week':
                                        const startOfWeek = new Date(now);
                                        startOfWeek.setDate(now.getDate() - now.getDay());
                                        startOfWeek.setHours(0, 0, 0, 0);
                                        
                                        if (earningDate >= startOfWeek) {
                                            include = true;
                                            periodText = "This Week's Earnings";
                                        }
                                        break;
                                    case 'month':
                                        if (earningDate.getMonth() === now.getMonth() && 
                                            earningDate.getFullYear() === now.getFullYear()) {
                                            include = true;
                                            periodText = "This Month's Earnings";
                                        }
                                        break;
                                }
                                
                                if (include) {
                                    total += earning.amount || 0;
                                }
                            });
                        }
                        
                        document.getElementById('earningsAmount').textContent = `K${total.toFixed(2)}`;
                        document.getElementById('earningsPeriod').textContent = periodText || "No earnings for this period";
                    })
                    .catch(error => {
                        console.error('Error loading earnings:', error);
                        document.getElementById('earningsAmount').textContent = 'K0.00';
                        document.getElementById('earningsPeriod').textContent = 'Error loading earnings';
                    });
            }
        }
        
        // Withdraw earnings
        function withdrawEarnings() {
            // In a real app, this would initiate a withdrawal process
            showNotification('Withdrawal request submitted. Funds will be processed within 24 hours.');
        }
        
        // Load ride history
        function loadRideHistory() {
            if (currentUser) {
                const filter = document.getElementById('historyFilter').value;
                const dateFilter = document.getElementById('historyDate').value;
                
                // Remove existing listener
                if (rideHistoryListener) {
                    rideHistoryListener();
                }
                
                // Set up real-time listener for ride history
                rideHistoryListener = database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).on('value', snapshot => {
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    
                    const rides = snapshot.val();
                    if (rides) {
                        let ridesArray = Object.keys(rides).map(rideId => ({
                            id: rideId,
                            ...rides[rideId]
                        }));
                        
                        // Apply filters
                        if (filter !== 'all') {
                            ridesArray = ridesArray.filter(ride => ride.status === filter);
                        }
                        
                        if (dateFilter) {
                            const filterDate = new Date(dateFilter);
                            ridesArray = ridesArray.filter(ride => {
                                const rideDate = new Date(ride.timestamp);
                                return rideDate.toDateString() === filterDate.toDateString();
                            });
                        }
                        
                        // Sort by timestamp (newest first)
                        ridesArray.sort((a, b) => b.timestamp - a.timestamp);
                        
                        if (ridesArray.length === 0) {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No rides found matching your criteria.</p>';
                            return;
                        }
                        
                        ridesArray.forEach(ride => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.setAttribute('data-ride-id', ride.id);
                            
                            const date = new Date(ride.timestamp);
                            const formattedDate = date.toLocaleDateString();
                            const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            
                            // Determine status badge class
                            let statusClass = 'status-pending';
                            let statusText = getStatusText(ride.status);
                            
                            if (ride.status === 'completed') {
                                statusClass = 'status-completed';
                            } else if (ride.status === 'cancelled') {
                                statusClass = 'status-cancelled';
                            } else if (ride.status === 'accepted') {
                                statusClass = 'status-accepted';
                            } else if (ride.status === 'arrived') {
                                statusClass = 'status-arrived';
                            } else if (ride.status === 'picked_up') {
                                statusClass = 'status-picked-up';
                            } else if (ride.status === 'started') {
                                statusClass = 'status-started';
                            }
                            
                            historyItem.innerHTML = `
                                <div class="history-locations">
                                    <div>
                                        <strong>From:</strong> ${ride.pickupLocation}
                                    </div>
                                    <div>
                                        <strong>To:</strong> ${ride.destination}
                                    </div>
                                </div>
                                <div class="history-info">
                                    <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                    <div>${formattedDate} ${formattedTime}</div>
                                    <div class="status-badge ${statusClass}">
                                        ${statusText}
                                    </div>
                                </div>
                            `;
                            
                            historyList.appendChild(historyItem);
                        });
                    } else {
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                    }
                }, error => {
                    console.error('Error loading ride history:', error);
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--danger-red);">Error loading ride history.</p>';
                });
            }
        }
        
        // Get display text for ride status
        function getStatusText(status) {
            const statusMap = {
                'requested': 'Requested',
                'accepted': 'Accepted',
                'arrived': 'Arrived',
                'picked_up': 'Picked Up',
                'started': 'Started',
                'completed': 'Completed',
                'cancelled': 'Cancelled',
                'rejected': 'Rejected'
            };
            
            return statusMap[status] || status;
        }
        
        // Show ride history details
        function showRideHistoryDetails(rideId) {
            database.ref('rides/' + rideId).once('value')
                .then(snapshot => {
                    const ride = snapshot.val();
                    if (ride) {
                        // Update popup content
                        document.getElementById('historyPopupPickup').textContent = ride.pickupLocation;
                        document.getElementById('historyPopupDestination').textContent = ride.destination;
                        document.getElementById('historyPopupFare').textContent = `K${ride.fare ? ride.fare.toFixed(2) : '0.00'}`;
                        document.getElementById('historyPopupDistance').textContent = ride.distance || 'Calculating...';
                        document.getElementById('historyPopupStatus').textContent = getStatusText(ride.status);
                        document.getElementById('historyPopupRideType').textContent = ride.rideType ? ride.rideType.charAt(0).toUpperCase() + ride.rideType.slice(1) : 'Standard';
                        document.getElementById('historyPopupPassengerName').textContent = ride.passengerName || 'Passenger';
                        document.getElementById('historyPopupPassengerPhone').textContent = ride.passengerPhone || 'N/A';
                        
                        // Format date
                        const date = new Date(ride.timestamp);
                        document.getElementById('historyPopupDate').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        // Update map in popup
                        updateHistoryPopupMap(ride);
                        
                        // Show popup
                        document.getElementById('rideHistoryPopup').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading ride details:', error);
                    showNotification('Error loading ride details.');
                });
        }
        
        // Update history popup map
        function updateHistoryPopupMap(ride) {
            // Clear existing map
            historyPopupMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    historyPopupMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng]).addTo(historyPopupMap)
                .bindPopup('Pickup Location');
            
            // Add destination marker
            L.marker([ride.destLat, ride.destLng]).addTo(historyPopupMap)
                .bindPopup('Destination');
            
            // Draw route
            L.polyline([
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            ], {color: '#FF6B35'}).addTo(historyPopupMap);
            
            // Fit map to show both locations
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            historyPopupMap.fitBounds(bounds, { padding: [20, 20] });
        }
        
        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Go offline before logging out
                if (isOnline) {
                    toggleOnlineStatus(false);
                }
                
                // Clean up any active listeners
                if (rideRequestsListener) {
                    rideRequestsListener();
                    rideRequestsListener = null;
                }
                
                if (currentRideListener) {
                    currentRideListener();
                    currentRideListener = null;
                }
                
                if (rideHistoryListener) {
                    rideHistoryListener();
                    rideHistoryListener = null;
                }
                
                auth.signOut()
                    .then(() => {
                        currentUser = null;
                        showNotification('Logged out successfully.');
                    })
                    .catch(error => {
                        console.error('Error signing out:', error);
                        showNotification('Error logging out. Please try again.');
                    });
            }
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
