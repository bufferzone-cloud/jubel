<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jubel - Driver</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-orange: #FF6B35;
            --secondary-red: #F94144;
            --light-orange: #FFB88C;
            --light-red: #FFA5A5;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --dark-gray: #333333;
            --medium-gray: #777777;
            --success-green: #2ecc71;
            --warning-yellow: #f39c12;
            --info-blue: #3498db;
            --dark-orange: #E55A2B;
            --pale-orange: #FFF5F0;
            --border-color: #E8E8E8;
            --shadow-light: 0 2px 12px rgba(255, 107, 53, 0.1);
            --shadow-medium: 0 4px 20px rgba(255, 107, 53, 0.15);
            --shadow-heavy: 0 8px 30px rgba(255, 107, 53, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--white);
            color: var(--dark-gray);
            max-width: 100%;
            overflow-x: hidden;
            height: 100vh;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .floating-balance {
            position: fixed;
            top: 15px;
            left: 15px;
            background: var(--white);
            padding: 10px 14px;
            border-radius: 10px;
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--dark-gray);
            border: 2px solid var(--primary-orange);
            font-size: 0.9rem;
        }
        
        .balance-amount {
            color: var(--primary-orange);
            font-size: 1rem;
        }
        
        .online-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--white);
            padding: 10px 14px;
            border-radius: 10px;
            box-shadow: var(--shadow-heavy);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .online-toggle.active {
            border-color: var(--success-green);
            background: var(--success-green);
            color: var(--white);
        }
        
        .online-toggle.offline {
            border-color: var(--medium-gray);
            background: var(--medium-gray);
            color: var(--white);
        }
        
        .driver-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
            padding: 15px;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .driver-panel.collapsed {
            transform: translateY(calc(100% - 60px));
        }
        
        .driver-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--light-orange), var(--primary-orange));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--white);
            font-weight: 700;
        }
        
        .driver-details h2 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .driver-details p {
            color: var(--medium-gray);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px 6px;
            border-radius: 8px;
            background: var(--light-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .nav-btn.active {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .nav-btn i {
            font-size: 1rem;
        }
        
        .ride-action-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--white);
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-medium);
            border: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .ride-action-btn.hold-to-start {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-arrive {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-pickup {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-to-complete {
            background: var(--white);
            color: var(--dark-gray);
        }
        
        .ride-action-btn.hold-active {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        .ride-action-btn:active {
            transform: scale(0.98);
        }
        
        .hold-progress {
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .hold-progress-bar {
            height: 100%;
            background: var(--primary-orange);
            width: 0%;
            transition: width 0.1s linear;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .ride-request-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }
        
        .ride-request-content {
            background: var(--white);
            border-radius: 15px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-heavy);
            display: flex;
            flex-direction: column;
        }
        
        .ride-request-map {
            height: 180px;
            width: 100%;
        }
        
        .ride-request-details {
            padding: 15px;
            overflow-y: auto;
        }
        
        .customer-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .customer-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--medium-gray);
        }
        
        .customer-details h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .customer-details p {
            color: var(--medium-gray);
            font-size: 0.85rem;
        }
        
        .trip-details {
            margin-bottom: 15px;
        }
        
        .location-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .location-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }
        
        .pickup-icon {
            background: var(--primary-orange);
            color: var(--white);
        }
        
        .destination-icon {
            background: var(--success-green);
            color: var(--white);
        }
        
        .location-text {
            flex: 1;
        }
        
        .location-text h4 {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .location-text p {
            color: var(--medium-gray);
            font-size: 0.8rem;
        }
        
        .fare-details {
            background: var(--pale-orange);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .fare-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        
        .fare-row.total {
            font-weight: 700;
            font-size: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 8px;
            margin-top: 8px;
        }
        
        .ride-request-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-accept {
            background: var(--success-green);
            color: var(--white);
        }
        
        .btn-reject {
            background: var(--secondary-red);
            color: var(--white);
        }
        
        .screen-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px;
            background: var(--white);
            z-index: 90;
            padding: 15px;
            overflow-y: auto;
            display: none;
        }
        
        .screen-content.active {
            display: block;
        }
        
        .screen-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .back-button {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            font-size: 1.1rem;
        }
        
        .screen-title {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .account-section, .history-section, .earnings-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1rem;
            margin-bottom: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary-orange);
        }
        
        .wallet-balance {
            background: linear-gradient(135deg, var(--primary-orange), var(--secondary-red));
            color: var(--white);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .balance-label {
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        
        .balance-amount-large {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-wallet {
            background: var(--white);
            color: var(--primary-orange);
            border: 2px solid var(--primary-orange);
            padding: 10px;
            font-size: 0.85rem;
        }
        
        .vehicle-details {
            background: var(--pale-orange);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--medium-gray);
        }
        
        .detail-value {
            font-weight: 600;
        }
        
        .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background: var(--pale-orange);
        }
        
        .history-locations {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .history-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .status-completed {
            background: #e6f7e9;
            color: #2e7d32;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .earnings-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        .earnings-period {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .period-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--white);
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        
        .period-btn.active {
            background: var(--primary-orange);
            color: var(--white);
            border-color: var(--primary-orange);
        }
        
        .earnings-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            background: var(--pale-orange);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary-orange);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--medium-gray);
        }
        
        .earnings-chart {
            height: 150px;
            background: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--medium-gray);
            font-size: 0.9rem;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-orange);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-heavy);
            z-index: 300;
            display: none;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
            max-width: 80%;
        }
        
        .waypoints-container {
            margin-top: 10px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .waypoint-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }
        
        .waypoint-item:last-child {
            border-bottom: none;
        }
        
        .waypoint-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--info-blue);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }
        
        .waypoint-text {
            flex: 1;
        }
        
        .navigation-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .nav-control-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: var(--info-blue);
            color: var(--white);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.85rem;
        }
        
        .nav-control-btn.secondary {
            background: var(--medium-gray);
        }
        
        .trip-info-card {
            background: var(--white);
            border-radius: 10px;
            padding: 12px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        .trip-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }
        
        .trip-info-row:last-child {
            margin-bottom: 0;
        }
        
        .trip-info-label {
            color: var(--medium-gray);
            font-weight: 600;
        }
        
        .trip-info-value {
            font-weight: 700;
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--warning-yellow);
        }
        
        .commission-display {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            font-size: 0.85rem;
        }
        
        .commission-label {
            color: var(--medium-gray);
        }
        
        .commission-value {
            font-weight: 600;
            color: var(--primary-orange);
        }
        
        .commission-deduction {
            color: var(--secondary-red);
        }
        
        .balance-update {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .balance-label-update {
            color: var(--medium-gray);
        }
        
        .balance-value-update {
            font-weight: 600;
            color: var(--success-green);
        }
        
        .no-float-warning {
            background-color: var(--pale-orange);
            border: 1px solid var(--light-orange);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
            color: var(--dark-orange);
            font-weight: 600;
        }
        
        .no-float-warning i {
            margin-right: 8px;
        }
        
        @media (max-width: 480px) {
            .floating-balance, .online-toggle {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .driver-panel {
                padding: 12px;
            }
            
            .nav-buttons {
                gap: 6px;
            }
            
            .nav-btn {
                padding: 8px 4px;
                font-size: 0.65rem;
            }
            
            .ride-request-content {
                max-height: 95vh;
            }
        }
    </style>
</head>
<body>
    <!-- Main Map -->
    <div id="map"></div>
    
    <!-- Floating Balance -->
    <div class="floating-balance">
        <i class="fas fa-wallet"></i>
        <span>Balance: <span class="balance-amount" id="walletBalance">K0.00</span></span>
    </div>
    
    <!-- Online Toggle -->
    <div class="online-toggle offline" id="onlineToggle">
        <i class="fas fa-circle"></i>
        <span>Offline</span>
    </div>
    
    <!-- Driver Panel -->
    <div class="driver-panel" id="driverPanel">
        <div class="driver-info">
            <div class="driver-avatar" id="driverAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="driver-details">
                <h2 id="driverName">Driver Name</h2>
                <p><i class="fas fa-phone"></i> <span id="driverPhone">000-000-0000</span></p>
                <p><i class="fas fa-car"></i> <span id="vehicleDetails">Toyota Corolla - ABC123</span></p>
            </div>
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn active" data-screen="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-btn" data-screen="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </button>
            <button class="nav-btn" data-screen="history">
                <i class="fas fa-history"></i>
                <span>History</span>
            </button>
            <button class="nav-btn" data-screen="earnings">
                <i class="fas fa-money-bill-wave"></i>
                <span>Earnings</span>
            </button>
        </div>
        
        <!-- Ride Action Button (Changes based on ride status) -->
        <button class="ride-action-btn hold-to-start" id="rideActionBtn">
            <i class="fas fa-play-circle"></i>
            Hold to Start Ride
            <div class="hold-progress">
                <div class="hold-progress-bar" id="holdProgressBar"></div>
            </div>
        </button>
    </div>
    
    <!-- Ride Request Popup -->
    <div class="ride-request-popup" id="rideRequestPopup">
        <div class="ride-request-content">
            <div class="ride-request-map" id="rideRequestMap"></div>
            <div class="ride-request-details">
                <div class="customer-info">
                    <div class="customer-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="customer-details">
                        <h3 id="customerName">Customer Name</h3>
                        <p><i class="fas fa-phone"></i> <span id="customerPhone">000-000-0000</span></p>
                        <div class="rating-display">
                            <i class="fas fa-star"></i>
                            <span id="customerRating">4.8</span>
                        </div>
                    </div>
                </div>
                
                <div class="trip-details">
                    <div class="location-row">
                        <div class="location-icon pickup-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-text">
                            <h4>Pickup Location</h4>
                            <p id="pickupLocation">123 Main Street, City</p>
                        </div>
                    </div>
                    <div class="location-row">
                        <div class="location-icon destination-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="location-text">
                            <h4>Destination</h4>
                            <p id="destinationLocation">456 Oak Avenue, City</p>
                        </div>
                    </div>
                </div>
                
                <div class="fare-details">
                    <div class="fare-row">
                        <span>Base Fare</span>
                        <span id="baseFare">K15.00</span>
                    </div>
                    <div class="fare-row">
                        <span>Distance</span>
                        <span id="distanceFare">K5.00</span>
                    </div>
                    <div class="fare-row">
                        <span>Discount</span>
                        <span id="discountFare">-K2.00</span>
                    </div>
                    <div class="fare-row total">
                        <span>Total Fare</span>
                        <span id="totalFare">K18.00</span>
                    </div>
                </div>
                
                <div class="trip-info-card">
                    <div class="trip-info-row">
                        <span class="trip-info-label">Distance</span>
                        <span class="trip-info-value" id="tripDistance">5.2 km</span>
                    </div>
                    <div class="trip-info-row">
                        <span class="trip-info-label">Estimated Time</span>
                        <span class="trip-info-value" id="tripTime">15 min</span>
                    </div>
                    <div class="trip-info-row">
                        <span class="trip-info-label">Surge Pricing</span>
                        <span class="trip-info-value" id="surgeMultiplier">1.2x</span>
                    </div>
                </div>
                
                <h4 class="section-title">Route Waypoints</h4>
                <div class="waypoints-container" id="waypointsContainer">
                    <!-- Waypoints will be populated here -->
                </div>
                
                <div class="ride-request-actions">
                    <button class="btn btn-accept" id="acceptRideBtn">
                        <i class="fas fa-check-circle"></i>
                        Accept
                    </button>
                    <button class="btn btn-reject" id="rejectRideBtn">
                        <i class="fas fa-times-circle"></i>
                        Reject
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Screen Contents -->
    <div class="screen-content" id="homeScreen">
        <!-- Home screen is the map, so this is empty -->
    </div>
    
    <div class="screen-content" id="accountScreen">
        <div class="screen-header">
            <button class="back-button" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="screen-title">Account</h2>
        </div>
        
        <div class="account-section">
            <h3 class="section-title">
                <i class="fas fa-user"></i>
                Driver Details
            </h3>
            <div class="input-group">
                <label for="driverNameInput">Full Name</label>
                <input type="text" id="driverNameInput" class="input-field" placeholder="Your full name">
            </div>
            <div class="input-group">
                <label for="driverPhoneInput">Phone Number</label>
                <input type="tel" id="driverPhoneInput" class="input-field" placeholder="Your phone number">
            </div>
            <div class="input-group">
                <label for="driverEmailInput">Email Address</label>
                <input type="email" id="driverEmailInput" class="input-field" placeholder="Your email address">
            </div>
            <button class="btn btn-primary" id="saveDriverDetailsBtn">
                <i class="fas fa-save"></i>
                Save Details
            </button>
        </div>
        
        <div class="account-section">
            <h3 class="section-title">
                <i class="fas fa-car"></i>
                Vehicle Details
            </h3>
            <div class="input-group">
                <label for="vehicleTypeInput">Vehicle Type</label>
                <input type="text" id="vehicleTypeInput" class="input-field" placeholder="Car, Bike, etc.">
            </div>
            <div class="input-group">
                <label for="vehicleModelInput">Vehicle Model</label>
                <input type="text" id="vehicleModelInput" class="input-field" placeholder="Toyota Corolla, etc.">
            </div>
            <div class="input-group">
                <label for="licensePlateInput">License Plate</label>
                <input type="text" id="licensePlateInput" class="input-field" placeholder="ABC 123">
            </div>
            <div class="input-group">
                <label for="vehicleColorInput">Vehicle Color</label>
                <input type="text" id="vehicleColorInput" class="input-field" placeholder="Red, Blue, etc.">
            </div>
            <button class="btn btn-primary" id="saveVehicleDetailsBtn">
                <i class="fas fa-save"></i>
                Save Vehicle Details
            </button>
        </div>
        
        <div class="account-section">
            <h3 class="section-title">
                <i class="fas fa-wallet"></i>
                Wallet & Balance
            </h3>
            <div class="wallet-balance">
                <div class="balance-label">Available Balance</div>
                <div class="balance-amount-large" id="accountBalance">K0.00</div>
                <div>Add funds to receive ride requests</div>
            </div>
            
            <div class="wallet-actions">
                <button class="btn btn-wallet" id="addFundsBtn">
                    <i class="fas fa-plus-circle"></i>
                    Add Funds
                </button>
                <button class="btn btn-wallet" id="withdrawFundsBtn">
                    <i class="fas fa-minus-circle"></i>
                    Withdraw
                </button>
            </div>
            
            <div class="vehicle-details">
                <div class="detail-row">
                    <span class="detail-label">Total Earnings</span>
                    <span class="detail-value" id="totalEarnings">K0.00</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Completed Rides</span>
                    <span class="detail-value" id="completedRides">0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Cancelled Rides</span>
                    <span class="detail-value" id="cancelledRides">0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Rating</span>
                    <span class="detail-value" id="driverRating">4.5 â˜…</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="screen-content" id="historyScreen">
        <div class="screen-header">
            <button class="back-button" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="screen-title">Ride History</h2>
        </div>
        
        <div class="history-section">
            <div id="historyList">
                <!-- History items will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <div class="screen-content" id="earningsScreen">
        <div class="screen-header">
            <button class="back-button" data-screen="home">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="screen-title">Earnings</h2>
        </div>
        
        <div class="earnings-section">
            <div class="earnings-period">
                <button class="period-btn active" data-period="today">Today</button>
                <button class="period-btn" data-period="week">This Week</button>
                <button class="period-btn" data-period="month">This Month</button>
            </div>
            
            <div class="earnings-card">
                <div class="earnings-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="earningsTotal">K0.00</div>
                        <div class="stat-label">Total Earnings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="ridesCompleted">0</div>
                        <div class="stat-label">Rides Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgEarning">K0.00</div>
                        <div class="stat-label">Avg per Ride</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="onlineHours">0h</div>
                        <div class="stat-label">Online Time</div>
                    </div>
                </div>
                
                <div class="earnings-chart">
                    Earnings chart would appear here
                </div>
                
                <button class="btn btn-primary" id="withdrawEarningsBtn">
                    <i class="fas fa-download"></i>
                    Withdraw Earnings
                </button>
            </div>
            
            <h3 class="section-title">
                <i class="fas fa-receipt"></i>
                Recent Earnings
            </h3>
            <div id="earningsList">
                <!-- Earnings items will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Firebase and Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDEACX_P4c5q7djJAcA0I7Lk7leO2TlQ74",
            authDomain: "jubel-13e1a.firebaseapp.com",
            databaseURL: "https://jubel-13e1a-default-rtdb.firebaseio.com",
            projectId: "jubel-13e1a",
            storageBucket: "jubel-13e1a.firebasestorage.app",
            messagingSenderId: "882241095445",
            appId: "1:882241095445:web:ee9ca40fddd008ca910b1c",
            measurementId: "G-J5JPKL6B5F"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // App state
        let currentUser = null;
        let currentRide = null;
        let isOnline = false;
        let driverMap, rideRequestMap;
        let locationWatchId = null;
        let driverMarker = null;
        let customerMarker = null;
        let destinationMarker = null;
        let routePolyline = null;
        let holdTimer = null;
        let holdProgress = 0;
        let currentRideRequest = null;
        let earningsPeriod = 'today';
        let waypoints = [];
        let floatBalance = 0;
        let commissionRate = 0.08; // 8% commission
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            initializeMap();
            setupEventListeners();
            loadDriverData();
        });
        
        // Authentication functions
        function initializeAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    updateDriverAvatar();
                    loadDriverData();
                } else {
                    // Auto-login for demo
                    auth.signInAnonymously()
                        .then(() => {
                            console.log('Driver signed in anonymously');
                        })
                        .catch(error => {
                            console.error('Authentication error:', error);
                        });
                }
            });
        }
        
        // Map initialization
        function initializeMap() {
            // Main driver map
            driverMap = L.map('map').setView([-15.4167, 28.2833], 13); // Default to Lusaka
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(driverMap);
            
            // Ride request map
            rideRequestMap = L.map('rideRequestMap').setView([-15.4167, 28.2833], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(rideRequestMap);
            
            // Get driver's current location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update map with current location
                    driverMap.setView([lat, lng], 15);
                    
                    // Add marker for driver location
                    driverMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'driver-marker',
                            html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ðŸš—</div><div style="background: white; padding: 2px 6px; border-radius: 10px; margin-top: 5px; font-size: 10px; font-weight: bold;">You</div>',
                            iconSize: [40, 55]
                        })
                    }).addTo(driverMap)
                        .bindPopup('Your location')
                        .openPopup();
                        
                    // Update driver location in Firebase
                    updateDriverLocation(lat, lng);
                }, error => {
                    console.error('Geolocation error:', error);
                    showNotification('Unable to get your location. Please enable location services.');
                });
            }
        }
        
        // Update driver location in Firebase
        function updateDriverLocation(lat, lng) {
            if (currentUser && isOnline) {
                database.ref('driverLocations/' + currentUser.uid).set({
                    latitude: lat,
                    longitude: lng,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Update marker position
                if (driverMarker) {
                    driverMarker.setLatLng([lat, lng]);
                }
            }
        }
        
        // Start tracking driver location
        function startLocationTracking() {
            if (navigator.geolocation) {
                locationWatchId = navigator.geolocation.watchPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        updateDriverLocation(lat, lng);
                    },
                    error => {
                        console.error('Geolocation error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // Stop tracking driver location
        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }
        
        // Event listeners setup
        function setupEventListeners() {
            // Online toggle
            document.getElementById('onlineToggle').addEventListener('click', toggleOnlineStatus);
            
            // Navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Back buttons
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    switchScreen(screen);
                });
            });
            
            // Ride request actions
            document.getElementById('acceptRideBtn').addEventListener('click', acceptRide);
            document.getElementById('rejectRideBtn').addEventListener('click', rejectRide);
            
            // Ride action button (hold functionality)
            const rideActionBtn = document.getElementById('rideActionBtn');
            
            rideActionBtn.addEventListener('mousedown', startHoldTimer);
            rideActionBtn.addEventListener('touchstart', startHoldTimer);
            
            rideActionBtn.addEventListener('mouseup', cancelHoldTimer);
            rideActionBtn.addEventListener('touchend', cancelHoldTimer);
            rideActionBtn.addEventListener('mouseleave', cancelHoldTimer);
            
            // Account actions
            document.getElementById('saveDriverDetailsBtn').addEventListener('click', saveDriverDetails);
            document.getElementById('saveVehicleDetailsBtn').addEventListener('click', saveVehicleDetails);
            document.getElementById('addFundsBtn').addEventListener('click', addFunds);
            document.getElementById('withdrawFundsBtn').addEventListener('click', withdrawFunds);
            
            // Earnings period selection
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    earningsPeriod = this.getAttribute('data-period');
                    loadEarnings();
                });
            });
            
            // Withdraw earnings
            document.getElementById('withdrawEarningsBtn').addEventListener('click', withdrawEarnings);
        }
        
        // Switch between screens
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen-content').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId + 'Screen').classList.add('active');
            
            // Update active nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            
            // Load data for specific screens
            if (screenId === 'history') {
                loadRideHistory();
            } else if (screenId === 'earnings') {
                loadEarnings();
            }
        }
        
        // Toggle online status
        function toggleOnlineStatus() {
            isOnline = !isOnline;
            const onlineToggle = document.getElementById('onlineToggle');
            
            if (isOnline) {
                // Check if float balance is sufficient
                if (floatBalance <= 0) {
                    showNotification('Cannot go online. Your float balance is zero. Please add funds.');
                    isOnline = false;
                    return;
                }
                
                onlineToggle.classList.remove('offline');
                onlineToggle.classList.add('active');
                onlineToggle.innerHTML = '<i class="fas fa-circle"></i><span>Online</span>';
                
                // Start location tracking
                startLocationTracking();
                
                // Listen for ride requests
                listenForRideRequests();
                
                showNotification('You are now online and receiving ride requests.');
            } else {
                onlineToggle.classList.remove('active');
                onlineToggle.classList.add('offline');
                onlineToggle.innerHTML = '<i class="fas fa-circle"></i><span>Offline</span>';
                
                // Stop location tracking
                stopLocationTracking();
                
                showNotification('You are now offline.');
            }
            
            // Update driver status in Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    isOnline: isOnline,
                    lastOnline: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // Listen for ride requests
        function listenForRideRequests() {
            database.ref('rides').orderByChild('status').equalTo('requested').on('value', snapshot => {
                const rides = snapshot.val();
                if (rides) {
                    // Get the first available ride request
                    const rideId = Object.keys(rides)[0];
                    const ride = rides[rideId];
                    
                    // Show ride request popup
                    showRideRequest(rideId, ride);
                }
            });
        }
        
        // Show ride request popup
        function showRideRequest(rideId, ride) {
            // Check if driver has accepted a ride already
            if (currentRide) {
                return; // Don't show new requests if driver is already on a ride
            }
            
            currentRideRequest = {
                id: rideId,
                ...ride
            };
            
            // Update popup content
            document.getElementById('customerName').textContent = ride.passengerName || 'Passenger';
            document.getElementById('customerPhone').textContent = ride.passengerPhone || 'N/A';
            document.getElementById('customerRating').textContent = ride.passengerRating || '4.8';
            document.getElementById('pickupLocation').textContent = ride.pickupLocation;
            document.getElementById('destinationLocation').textContent = ride.destination;
            document.getElementById('tripDistance').textContent = ride.distance ? `${ride.distance} km` : '5.2 km';
            document.getElementById('tripTime').textContent = ride.estimatedTime || '15 min';
            document.getElementById('surgeMultiplier').textContent = ride.surgeMultiplier || '1.0x';
            
            // Calculate and display fare details
            const baseFare = 15;
            const distanceFare = Math.max(0, (ride.distance ? parseFloat(ride.distance) * 5 : 5));
            const discount = ride.promoCode ? 2 : 0;
            const totalFare = baseFare + distanceFare - discount;
            
            document.getElementById('baseFare').textContent = `K${baseFare.toFixed(2)}`;
            document.getElementById('distanceFare').textContent = `K${distanceFare.toFixed(2)}`;
            document.getElementById('discountFare').textContent = `-K${discount.toFixed(2)}`;
            document.getElementById('totalFare').textContent = `K${totalFare.toFixed(2)}`;
            
            // Update ride request map
            updateRideRequestMap(ride);
            
            // Generate waypoints
            generateWaypoints(ride);
            
            // Show popup
            document.getElementById('rideRequestPopup').style.display = 'flex';
        }
        
        // Update ride request map
        function updateRideRequestMap(ride) {
            // Clear existing map
            rideRequestMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    rideRequestMap.removeLayer(layer);
                }
            });
            
            // Add pickup marker
            L.marker([ride.pickupLat, ride.pickupLng], {
                icon: L.divIcon({
                    className: 'pickup-marker',
                    html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px;">ðŸ“</div><div style="background: white; padding: 2px 6px; border-radius: 10px; margin-top: 5px; font-size: 9px; font-weight: bold;">Pickup</div>',
                    iconSize: [30, 45]
                })
            }).addTo(rideRequestMap).bindPopup('Pickup Location');
            
            // Add destination marker
            L.marker([ride.destLat, ride.destLng], {
                icon: L.divIcon({
                    className: 'destination-marker',
                    html: '<div style="background: #2ecc71; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px;">ðŸ</div><div style="background: white; padding: 2px 6px; border-radius: 10px; margin-top: 5px; font-size: 9px; font-weight: bold;">Destination</div>',
                    iconSize: [30, 45]
                })
            }).addTo(rideRequestMap).bindPopup('Destination');
            
            // Draw route
            drawRouteOnRequestMap(ride.pickupLat, ride.pickupLng, ride.destLat, ride.destLng);
            
            // Fit map to show both locations with padding
            const bounds = L.latLngBounds(
                [ride.pickupLat, ride.pickupLng],
                [ride.destLat, ride.destLng]
            );
            rideRequestMap.fitBounds(bounds, { padding: [30, 30] });
        }
        
        // Draw route on ride request map
        function drawRouteOnRequestMap(startLat, startLng, endLat, endLng) {
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 5,
                            opacity: 0.7
                        }).addTo(rideRequestMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 5,
                        opacity: 0.7
                    }).addTo(rideRequestMap);
                });
        }
        
        // Generate waypoints between driver and pickup
        function generateWaypoints(ride) {
            waypoints = [];
            const waypointsContainer = document.getElementById('waypointsContainer');
            waypointsContainer.innerHTML = '';
            
            // Simulate generating waypoints along the route
            // In a real app, you would get these from a routing service
            const sampleWaypoints = [
                "Turn left onto Independence Avenue",
                "Continue straight for 1.2 km",
                "Turn right onto Cairo Road",
                "Merge onto Great East Road",
                "Destination on your right"
            ];
            
            sampleWaypoints.forEach((waypoint, index) => {
                waypoints.push(waypoint);
                
                const waypointItem = document.createElement('div');
                waypointItem.className = 'waypoint-item';
                waypointItem.innerHTML = `
                    <div class="waypoint-icon">
                        <i class="fas fa-map-pin"></i>
                    </div>
                    <div class="waypoint-text">
                        ${waypoint}
                    </div>
                `;
                
                waypointsContainer.appendChild(waypointItem);
            });
        }
        
        // Accept a ride
        function acceptRide() {
            if (currentRideRequest && currentUser) {
                // Update ride with driver info
                database.ref('rides/' + currentRideRequest.id).update({
                    driverId: currentUser.uid,
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide = {
                        id: currentRideRequest.id,
                        ...currentRideRequest,
                        driverId: currentUser.uid,
                        status: 'accepted'
                    };
                    
                    // Hide ride request popup
                    document.getElementById('rideRequestPopup').style.display = 'none';
                    
                    // Update driver panel for active ride
                    updateDriverPanelForActiveRide();
                    
                    // Update map for active ride
                    updateMapForActiveRide();
                    
                    showNotification('Ride accepted successfully.');
                })
                .catch(error => {
                    console.error('Error accepting ride:', error);
                    showNotification('Error accepting ride. Please try again.');
                });
            }
        }
        
        // Reject a ride
        function rejectRide() {
            if (currentRideRequest) {
                // Hide ride request popup
                document.getElementById('rideRequestPopup').style.display = 'none';
                currentRideRequest = null;
                
                showNotification('Ride rejected.');
            }
        }
        
        // Update driver panel for active ride
        function updateDriverPanelForActiveRide() {
            if (currentRide) {
                // Update driver details with customer info
                document.getElementById('driverName').textContent = currentRide.passengerName || 'Passenger';
                document.getElementById('driverPhone').textContent = currentRide.passengerPhone || 'N/A';
                
                // Update vehicle details with trip info
                document.getElementById('vehicleDetails').textContent = `To: ${currentRide.destination}`;
                
                // Update ride action button
                updateRideActionButton('hold-to-start');
            }
        }
        
        // Update map for active ride
        function updateMapForActiveRide() {
            if (currentRide) {
                // Clear existing markers and routes
                if (customerMarker) {
                    driverMap.removeLayer(customerMarker);
                    customerMarker = null;
                }
                if (destinationMarker) {
                    driverMap.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                if (routePolyline) {
                    driverMap.removeLayer(routePolyline);
                    routePolyline = null;
                }
                
                // Add customer pickup marker
                customerMarker = L.marker([currentRide.pickupLat, currentRide.pickupLng], {
                    icon: L.divIcon({
                        className: 'customer-marker',
                        html: '<div style="background: #FF6B35; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px;">ðŸ“</div><div style="background: white; padding: 2px 6px; border-radius: 10px; margin-top: 5px; font-size: 9px; font-weight: bold;">Customer</div>',
                        iconSize: [30, 45]
                    })
                }).addTo(driverMap).bindPopup('Customer Pickup Location');
                
                // Add destination marker
                destinationMarker = L.marker([currentRide.destLat, currentRide.destLng], {
                    icon: L.divIcon({
                        className: 'destination-marker',
                        html: '<div style="background: #2ecc71; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px;">ðŸ</div><div style="background: white; padding: 2px 6px; border-radius: 10px; margin-top: 5px; font-size: 9px; font-weight: bold;">Destination</div>',
                        iconSize: [30, 45]
                    })
                }).addTo(driverMap).bindPopup('Destination');
                
                // Draw route from driver to customer
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.pickupLat, currentRide.pickupLng);
                }
                
                // Fit map to show driver, customer and destination with appropriate zoom
                if (driverMarker) {
                    const driverLatLng = driverMarker.getLatLng();
                    const bounds = L.latLngBounds(
                        [driverLatLng.lat, driverLatLng.lng],
                        [currentRide.pickupLat, currentRide.pickupLng],
                        [currentRide.destLat, currentRide.destLng]
                    );
                    driverMap.fitBounds(bounds, { padding: [70, 70] });
                }
            }
        }
        
        // Draw route on main map
        function drawRoute(startLat, startLng, endLat, endLng) {
            // Remove existing route if any
            if (routePolyline) {
                driverMap.removeLayer(routePolyline);
            }
            
            // Use OSRM API to get route
            fetch(`https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const routeCoordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        // Draw the route on the map
                        routePolyline = L.polyline(routeCoordinates, {
                            color: '#FF6B35',
                            weight: 5,
                            opacity: 0.7
                        }).addTo(driverMap);
                    }
                })
                .catch(error => {
                    console.error('Error fetching route:', error);
                    // Fallback: draw a straight line
                    routePolyline = L.polyline([
                        [startLat, startLng],
                        [endLat, endLng]
                    ], {
                        color: '#FF6B35',
                        weight: 5,
                        opacity: 0.7
                    }).addTo(driverMap);
                });
        }
        
        // Update ride action button based on ride status
        function updateRideActionButton(action) {
            const rideActionBtn = document.getElementById('rideActionBtn');
            const holdProgressBar = document.getElementById('holdProgressBar');
            
            // Reset hold progress
            holdProgress = 0;
            if (holdProgressBar) {
                holdProgressBar.style.width = '0%';
            }
            
            switch(action) {
                case 'hold-to-start':
                    rideActionBtn.className = 'ride-action-btn hold-to-start';
                    rideActionBtn.innerHTML = `
                        <i class="fas fa-play-circle"></i>
                        Hold to Start Ride
                        <div class="hold-progress">
                            <div class="hold-progress-bar" id="holdProgressBar"></div>
                        </div>
                    `;
                    break;
                case 'hold-to-arrive':
                    rideActionBtn.className = 'ride-action-btn hold-to-arrive';
                    rideActionBtn.innerHTML = `
                        <i class="fas fa-map-marker-alt"></i>
                        Hold to Arrive
                        <div class="hold-progress">
                            <div class="hold-progress-bar" id="holdProgressBar"></div>
                        </div>
                    `;
                    break;
                case 'hold-to-pickup':
                    rideActionBtn.className = 'ride-action-btn hold-to-pickup';
                    rideActionBtn.innerHTML = `
                        <i class="fas fa-user-check"></i>
                        Hold to Pickup
                        <div class="hold-progress">
                            <div class="hold-progress-bar" id="holdProgressBar"></div>
                        </div>
                    `;
                    break;
                case 'hold-to-complete':
                    rideActionBtn.className = 'ride-action-btn hold-to-complete';
                    rideActionBtn.innerHTML = `
                        <i class="fas fa-flag-checkered"></i>
                        Hold to Complete
                        <div class="hold-progress">
                            <div class="hold-progress-bar" id="holdProgressBar"></div>
                        </div>
                    `;
                    break;
            }
            
            // Reattach event listeners
            const newRideActionBtn = document.getElementById('rideActionBtn');
            newRideActionBtn.addEventListener('mousedown', startHoldTimer);
            newRideActionBtn.addEventListener('touchstart', startHoldTimer);
            newRideActionBtn.addEventListener('mouseup', cancelHoldTimer);
            newRideActionBtn.addEventListener('touchend', cancelHoldTimer);
            newRideActionBtn.addEventListener('mouseleave', cancelHoldTimer);
        }
        
        // Start hold timer for ride actions
        function startHoldTimer() {
            if (holdTimer) return;
            
            // Add active class to change button color to orange
            const rideActionBtn = document.getElementById('rideActionBtn');
            rideActionBtn.classList.add('hold-active');
            
            holdTimer = setInterval(() => {
                holdProgress += 3.33; // 3 seconds total = 100%
                const holdProgressBar = document.getElementById('holdProgressBar');
                
                if (holdProgressBar) {
                    holdProgressBar.style.width = `${holdProgress}%`;
                }
                
                if (holdProgress >= 100) {
                    clearInterval(holdTimer);
                    holdTimer = null;
                    completeHoldAction();
                }
            }, 100);
        }
        
        // Cancel hold timer
        function cancelHoldTimer() {
            if (holdTimer) {
                clearInterval(holdTimer);
                holdTimer = null;
                holdProgress = 0;
                
                // Remove active class to revert button color
                const rideActionBtn = document.getElementById('rideActionBtn');
                rideActionBtn.classList.remove('hold-active');
                
                const holdProgressBar = document.getElementById('holdProgressBar');
                if (holdProgressBar) {
                    holdProgressBar.style.width = '0%';
                }
            }
        }
        
        // Complete hold action based on current ride state
        function completeHoldAction() {
            if (!currentRide) return;
            
            const rideActionBtn = document.getElementById('rideActionBtn');
            
            if (rideActionBtn.classList.contains('hold-to-start')) {
                // Start the ride
                database.ref('rides/' + currentRide.id).update({
                    status: 'started',
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    currentRide.status = 'started';
                    updateRideActionButton('hold-to-arrive');
                    showNotification('Ride started. Heading to pickup location.');
                    
                    // Update map to show route from driver to destination
                    if (driverMarker) {
                        const driverLatLng = driverMarker.getLatLng();
                        drawRoute(driverLatLng.lat, driverLatLng.lng, currentRide.destLat, currentRide.destLng);
                    }
                });
            } else if (rideActionBtn.classList.contains('hold-to-arrive')) {
                // Mark arrived
                database.ref('rides/' + currentRide.id).update({
                    status: 'arrived'
                })
                .then(() => {
                    currentRide.status = 'arrived';
                    updateRideActionButton('hold-to-pickup');
                    showNotification('Arrival marked. Waiting for passenger.');
                });
            } else if (rideActionBtn.classList.contains('hold-to-pickup')) {
                // Mark pickup
                database.ref('rides/' + currentRide.id).update({
                    status: 'picked_up'
                })
                .then(() => {
                    currentRide.status = 'picked_up';
                    updateRideActionButton('hold-to-complete');
                    showNotification('Passenger picked up. Starting trip.');
                    
                    // Update driver details back to driver info
                    document.getElementById('driverName').textContent = document.getElementById('driverNameInput').value || 'Driver Name';
                    document.getElementById('driverPhone').textContent = document.getElementById('driverPhoneInput').value || '000-000-0000';
                    document.getElementById('vehicleDetails').textContent = 
                        `${document.getElementById('vehicleTypeInput').value || 'Vehicle'} - ${document.getElementById('licensePlateInput').value || 'ABC123'}`;
                });
            } else if (rideActionBtn.classList.contains('hold-to-complete')) {
                // Complete ride
                database.ref('rides/' + currentRide.id).update({
                    status: 'completed',
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                })
                .then(() => {
                    // Calculate commission and update float balance
                    const totalFare = calculateTotalFare(currentRide);
                    const commission = totalFare * commissionRate;
                    const driverEarnings = totalFare - commission;
                    
                    // Update float balance
                    const newFloatBalance = floatBalance - commission;
                    updateFloatBalance(newFloatBalance);
                    
                    // Add to earnings
                    const earningsData = {
                        rideId: currentRide.id,
                        amount: driverEarnings,
                        commission: commission,
                        totalFare: totalFare,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    database.ref('earnings/' + currentUser.uid).push(earningsData)
                        .then(() => {
                            // Show commission deduction notification
                            showNotification(`Ride completed! K${commission.toFixed(2)} commission deducted. New balance: K${newFloatBalance.toFixed(2)}`);
                            
                            // Reset driver panel
                            currentRide = null;
                            updateRideActionButton('hold-to-start');
                            
                            // Clear map markers and routes
                            if (customerMarker) {
                                driverMap.removeLayer(customerMarker);
                                customerMarker = null;
                            }
                            if (destinationMarker) {
                                driverMap.removeLayer(destinationMarker);
                                destinationMarker = null;
                            }
                            if (routePolyline) {
                                driverMap.removeLayer(routePolyline);
                                routePolyline = null;
                            }
                        });
                });
            }
        }
        
        // Calculate total fare for a ride
        function calculateTotalFare(ride) {
            const baseFare = 15;
            const distanceFare = Math.max(0, (ride.distance ? parseFloat(ride.distance) * 5 : 5));
            const discount = ride.promoCode ? 2 : 0;
            return baseFare + distanceFare - discount;
        }
        
        // Update float balance
        function updateFloatBalance(newBalance) {
            floatBalance = newBalance;
            
            // Update UI
            document.getElementById('walletBalance').textContent = `K${floatBalance.toFixed(2)}`;
            document.getElementById('accountBalance').textContent = `K${floatBalance.toFixed(2)}`;
            
            // Save to Firebase
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    walletBalance: floatBalance
                });
            }
            
            // Check if balance is zero and show warning if needed
            if (floatBalance <= 0) {
                showNoFloatWarning();
            }
        }
        
        // Show no float warning
        function showNoFloatWarning() {
            // Check if warning already exists
            if (document.querySelector('.no-float-warning')) {
                return;
            }
            
            const warning = document.createElement('div');
            warning.className = 'no-float-warning';
            warning.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                Your float balance is zero. You cannot receive ride requests until you add funds.
            `;
            
            // Insert warning at the top of the account screen
            const accountScreen = document.getElementById('accountScreen');
            const firstChild = accountScreen.firstChild;
            accountScreen.insertBefore(warning, firstChild);
        }
        
        // Load driver data
        function loadDriverData() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            // Update form fields
                            document.getElementById('driverNameInput').value = userData.name || '';
                            document.getElementById('driverPhoneInput').value = userData.phone || '';
                            document.getElementById('driverEmailInput').value = userData.email || '';
                            document.getElementById('vehicleTypeInput').value = userData.vehicleType || '';
                            document.getElementById('vehicleModelInput').value = userData.vehicleModel || '';
                            document.getElementById('licensePlateInput').value = userData.licensePlate || '';
                            document.getElementById('vehicleColorInput').value = userData.vehicleColor || '';
                            
                            // Update display
                            document.getElementById('driverName').textContent = userData.name || 'Driver Name';
                            document.getElementById('driverPhone').textContent = userData.phone || '000-000-0000';
                            document.getElementById('vehicleDetails').textContent = 
                                `${userData.vehicleType || 'Vehicle'} - ${userData.licensePlate || 'ABC123'}`;
                            
                            // Update wallet balance
                            floatBalance = userData.walletBalance || 0;
                            document.getElementById('walletBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            document.getElementById('accountBalance').textContent = `K${floatBalance.toFixed(2)}`;
                            
                            // Show warning if balance is zero
                            if (floatBalance <= 0) {
                                showNoFloatWarning();
                            }
                            
                            // Update driver avatar
                            updateDriverAvatar();
                            
                            // Set online status if previously online
                            if (userData.isOnline) {
                                toggleOnlineStatus();
                            }
                        }
                    });
                
                // Load driver stats
                loadDriverStats();
            }
        }
        
        // Update driver avatar
        function updateDriverAvatar() {
            const driverAvatar = document.getElementById('driverAvatar');
            const driverName = document.getElementById('driverNameInput').value;
            
            if (driverName) {
                driverAvatar.innerHTML = driverName.charAt(0).toUpperCase();
            } else {
                driverAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }
        
        // Save driver details
        function saveDriverDetails() {
            const name = document.getElementById('driverNameInput').value;
            const phone = document.getElementById('driverPhoneInput').value;
            const email = document.getElementById('driverEmailInput').value;
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    name: name,
                    phone: phone,
                    email: email
                })
                .then(() => {
                    showNotification('Driver details saved successfully.');
                    
                    // Update display
                    document.getElementById('driverName').textContent = name || 'Driver Name';
                    document.getElementById('driverPhone').textContent = phone || '000-000-0000';
                    
                    // Update avatar
                    updateDriverAvatar();
                })
                .catch(error => {
                    console.error('Error saving driver details:', error);
                    showNotification('Error saving driver details. Please try again.');
                });
            }
        }
        
        // Save vehicle details
        function saveVehicleDetails() {
            const vehicleType = document.getElementById('vehicleTypeInput').value;
            const vehicleModel = document.getElementById('vehicleModelInput').value;
            const licensePlate = document.getElementById('licensePlateInput').value;
            const vehicleColor = document.getElementById('vehicleColorInput').value;
            
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    vehicleType: vehicleType,
                    vehicleModel: vehicleModel,
                    licensePlate: licensePlate,
                    vehicleColor: vehicleColor
                })
                .then(() => {
                    showNotification('Vehicle details saved successfully.');
                    
                    // Update display
                    document.getElementById('vehicleDetails').textContent = 
                        `${vehicleType || 'Vehicle'} - ${licensePlate || 'ABC123'}`;
                })
                .catch(error => {
                    console.error('Error saving vehicle details:', error);
                    showNotification('Error saving vehicle details. Please try again.');
                });
            }
        }
        
        // Add funds to wallet
        function addFunds() {
            const amount = prompt('Enter amount to add to your wallet (K):');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const addAmount = parseFloat(amount);
                const newBalance = floatBalance + addAmount;
                
                // Update balance
                updateFloatBalance(newBalance);
                showNotification(`Successfully added K${addAmount.toFixed(2)} to your wallet.`);
                
                // Remove warning if balance is now positive
                if (newBalance > 0) {
                    const warning = document.querySelector('.no-float-warning');
                    if (warning) {
                        warning.remove();
                    }
                }
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Withdraw funds from wallet
        function withdrawFunds() {
            if (floatBalance <= 0) {
                showNotification('Your wallet balance is zero.');
                return;
            }
            
            const amount = prompt(`Enter amount to withdraw (K). Available: K${floatBalance.toFixed(2)}:`);
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                const withdrawAmount = parseFloat(amount);
                
                if (withdrawAmount > floatBalance) {
                    showNotification('Insufficient balance for this withdrawal.');
                    return;
                }
                
                const newBalance = floatBalance - withdrawAmount;
                updateFloatBalance(newBalance);
                showNotification(`Withdrawal request submitted. K${withdrawAmount.toFixed(2)} will be processed within 24 hours.`);
            } else if (amount) {
                showNotification('Please enter a valid amount.');
            }
        }
        
        // Load driver statistics
        function loadDriverStats() {
            if (!currentUser) return;
            
            // Load completed rides count
            database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const rides = snapshot.val();
                    let completed = 0;
                    let cancelled = 0;
                    let totalEarnings = 0;
                    
                    if (rides) {
                        Object.values(rides).forEach(ride => {
                            if (ride.status === 'completed') {
                                completed++;
                                totalEarnings += ride.fare || 0;
                            } else if (ride.status === 'cancelled') {
                                cancelled++;
                            }
                        });
                    }
                    
                    document.getElementById('completedRides').textContent = completed;
                    document.getElementById('cancelledRides').textContent = cancelled;
                    document.getElementById('totalEarnings').textContent = `K${totalEarnings.toFixed(2)}`;
                });
        }
        
        // Load ride history
        function loadRideHistory() {
            if (currentUser) {
                database.ref('rides').orderByChild('driverId').equalTo(currentUser.uid).once('value')
                    .then(snapshot => {
                        const historyList = document.getElementById('historyList');
                        historyList.innerHTML = '';
                        
                        const rides = snapshot.val();
                        if (rides) {
                            // Convert to array and sort by timestamp (newest first)
                            const ridesArray = Object.keys(rides).map(rideId => ({
                                id: rideId,
                                ...rides[rideId]
                            })).sort((a, b) => b.timestamp - a.timestamp);
                            
                            ridesArray.forEach(ride => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                
                                const date = new Date(ride.timestamp);
                                const formattedDate = date.toLocaleDateString();
                                const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                
                                historyItem.innerHTML = `
                                    <div class="history-locations">
                                        <div>
                                            <strong>From:</strong> ${ride.pickupLocation}
                                        </div>
                                        <div>
                                            <strong>To:</strong> ${ride.destination}
                                        </div>
                                    </div>
                                    <div class="history-info">
                                        <div>K${ride.fare ? ride.fare.toFixed(2) : '0.00'}</div>
                                        <div>${formattedDate} ${formattedTime}</div>
                                        <div class="status-badge ${ride.status === 'completed' ? 'status-completed' : 'status-cancelled'}">
                                            ${ride.status === 'completed' ? 'Completed' : 'Cancelled'}
                                        </div>
                                    </div>
                                `;
                                
                                historyList.appendChild(historyItem);
                            });
                        } else {
                            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No ride history found.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading ride history:', error);
                        historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--secondary-red);">Error loading ride history.</p>';
                    });
            }
        }
        
        // Load earnings
        function loadEarnings() {
            if (currentUser) {
                database.ref('earnings/' + currentUser.uid).once('value')
                    .then(snapshot => {
                        const earnings = snapshot.val();
                        let total = 0;
                        let ridesCompleted = 0;
                        let onlineHours = 0;
                        let totalCommission = 0;
                        
                        if (earnings) {
                            const now = new Date();
                            
                            Object.keys(earnings).forEach(earningId => {
                                const earning = earnings[earningId];
                                const earningDate = new Date(earning.timestamp);
                                
                                let include = false;
                                
                                switch(earningsPeriod) {
                                    case 'today':
                                        if (earningDate.toDateString() === now.toDateString()) {
                                            include = true;
                                        }
                                        break;
                                    case 'week':
                                        const startOfWeek = new Date(now);
                                        startOfWeek.setDate(now.getDate() - now.getDay());
                                        startOfWeek.setHours(0, 0, 0, 0);
                                        
                                        if (earningDate >= startOfWeek) {
                                            include = true;
                                        }
                                        break;
                                    case 'month':
                                        if (earningDate.getMonth() === now.getMonth() && 
                                            earningDate.getFullYear() === now.getFullYear()) {
                                            include = true;
                                        }
                                        break;
                                }
                                
                                if (include) {
                                    total += earning.amount || 0;
                                    totalCommission += earning.commission || 0;
                                    ridesCompleted++;
                                }
                            });
                            
                            // Calculate online hours (simplified)
                            onlineHours = Math.round(ridesCompleted * 0.75); // Assuming 45 minutes per ride on average
                        }
                        
                        document.getElementById('earningsTotal').textContent = `K${total.toFixed(2)}`;
                        document.getElementById('ridesCompleted').textContent = ridesCompleted;
                        document.getElementById('avgEarning').textContent = ridesCompleted > 0 ? `K${(total / ridesCompleted).toFixed(2)}` : 'K0.00';
                        document.getElementById('onlineHours').textContent = `${onlineHours}h`;
                        
                        // Update earnings list with commission information
                        updateEarningsList(earnings);
                    })
                    .catch(error => {
                        console.error('Error loading earnings:', error);
                        document.getElementById('earningsTotal').textContent = 'K0.00';
                        document.getElementById('ridesCompleted').textContent = '0';
                        document.getElementById('avgEarning').textContent = 'K0.00';
                        document.getElementById('onlineHours').textContent = '0h';
                    });
            }
        }
        
        // Update earnings list
        function updateEarningsList(earnings) {
            const earningsList = document.getElementById('earningsList');
            earningsList.innerHTML = '';
            
            if (earnings) {
                // Convert to array and sort by timestamp (newest first)
                const earningsArray = Object.keys(earnings).map(earningId => ({
                    id: earningId,
                    ...earnings[earningId]
                })).sort((a, b) => b.timestamp - a.timestamp)
                  .slice(0, 10); // Show only last 10 earnings
                
                earningsArray.forEach(earning => {
                    const earningItem = document.createElement('div');
                    earningItem.className = 'history-item';
                    
                    const date = new Date(earning.timestamp);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    earningItem.innerHTML = `
                        <div class="history-locations">
                            <div>
                                <strong>Ride Earnings</strong>
                            </div>
                            <div>
                                <strong>K${earning.amount ? earning.amount.toFixed(2) : '0.00'}</strong>
                            </div>
                        </div>
                        <div class="commission-display">
                            <span class="commission-label">Commission (8%):</span>
                            <span class="commission-value commission-deduction">-K${earning.commission ? earning.commission.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="balance-update">
                            <span class="balance-label-update">Total Fare:</span>
                            <span class="balance-value-update">K${earning.totalFare ? earning.totalFare.toFixed(2) : '0.00'}</span>
                        </div>
                        <div class="history-info">
                            <div>${formattedDate} ${formattedTime}</div>
                            <div class="status-badge status-completed">Completed</div>
                        </div>
                    `;
                    
                    earningsList.appendChild(earningItem);
                });
            } else {
                earningsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--medium-gray);">No earnings found for this period.</p>';
            }
        }
        
        // Withdraw earnings
        function withdrawEarnings() {
            showNotification('Withdrawal request submitted. Funds will be processed within 24 hours.');
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
